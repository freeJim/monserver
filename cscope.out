cscope 15 $HOME/GIT/mongrel2 -q 0000006081 0002836183
	@examples/kegogi/lemon.c

9 
	~<¡dio.h
>

10 
	~<¡d¬g.h
>

11 
	~<¡ršg.h
>

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<as£¹.h
>

16 #iâdeà
__WIN32__


17 #ià
defšed
(
_WIN32
è|| defšed(
WIN32
)

18 
	#__WIN32__


	)

22 #ifdeà
__WIN32__


23 
acûss
();

25 
	~<uni¡d.h
>

29 
	#PRIVATE


	)

31 #ifdeà
TEST


32 
	#MAXRHS
 5

	)

34 
	#MAXRHS
 1000

	)

37 *
msÜt
(*,**,(*)(const *,const *));

44 
	#ËmÚSŒËn
(
X
è(()
	`¡¾’
(X))

	)

46 
aùiÚ
 *
	`AùiÚ_Ãw
();

47 
aùiÚ
 *
	`AùiÚ_sÜt
(action *);

50 
	`FšdRuËP»ûd’ûs
();

51 
	`FšdFœ¡S‘s
();

52 
	`FšdS‹s
();

53 
	`FšdLšks
();

54 
	`FšdFŞlowS‘s
();

55 
	`FšdAùiÚs
();

58 
	`CÚfigli¡_š™
( );

59 
cÚfig
 *
	`CÚfigli¡_add
( );

60 
cÚfig
 *
	`CÚfigli¡_addbasis
( );

61 
	`CÚfigli¡_şosu»
( );

62 
	`CÚfigli¡_sÜt
( );

63 
	`CÚfigli¡_sÜtbasis
( );

64 
cÚfig
 *
	`CÚfigli¡_»tuº
( );

65 
cÚfig
 *
	`CÚfigli¡_basis
( );

66 
	`CÚfigli¡_—t
( );

67 
	`CÚfigli¡_»£t
( );

70 
	`E¼ÜMsg
(const *, ,const *, ...);

73 
	ss_İtiÚs
 {

74 ’um { 
OPT_FLAG
=1, 
OPT_INT
, 
OPT_DBL
, 
OPT_STR
,

75 
OPT_FFLAG
, 
OPT_FINT
, 
OPT_FDBL
, 
OPT_FSTR
} 
ty³
;

76 *
Ïb–
;

77 *
¬g
;

78 *
mes§ge
;

80 
	`O±In™
( );

81 
	`O±NArgs
( );

82 *
	`O±Arg
( );

83 
	`O±E¼
( );

84 
	`O±Pršt
( );

87 
	`P¬£
( );

90 
¶šk
 *
	`Plšk_Ãw
( );

91 
	`Plšk_add
( );

92 
	`Plšk_cİy
( );

93 
	`Plšk_d–‘e
( );

96 
	`R•ršt
( );

97 
	`R•ÜtOuut
( );

98 
	`R•ÜtTabË
( );

99 
	`R•ÜtH—d”
( );

100 
	`Com´essTabËs
( );

101 
	`ResÜtS‹s
( );

104 
	`S‘Size
( );

105 *
	`S‘New
( );

106 
	`S‘F»e
( );

108 
	`S‘Add
( );

109 
	`S‘UniÚ
( );

111 
	#S‘Fšd
(
X
,
Y
è(X[Y]è

	)

118 ’um {
LEMON_FALSE
=0, 
LEMON_TRUE
} 
	tBoŞ—n
;

122 
	ssymbŞ
 {

123 *
Çme
;

124 
šdex
;

126 
TERMINAL
,

127 
NONTERMINAL
,

128 
MULTITERMINAL


129 } 
ty³
;

130 
ruË
 *rule;

131 
symbŞ
 *
çÎback
;

132 
´ec
;

133 
	ee_assoc
 {

134 
LEFT
,

135 
RIGHT
,

136 
NONE
,

137 
UNK


138 } 
assoc
;

139 *
fœ¡£t
;

140 
BoŞ—n
 
Ïmbda
;

141 
u£CÁ
;

142 *
de¡ruùÜ
;

144 
de¡Lš’o
;

145 *
d©©y³
;

147 
dŠum
;

151 
nsubsym
;

152 
symbŞ
 **
subsym
;

157 
	sruË
 {

158 
symbŞ
 *
lhs
;

159 *
lh§lŸs
;

160 
lhsS¹
;

161 
ruËlše
;

162 
Ähs
;

163 
symbŞ
 **
rhs
;

164 **
rh§lŸs
;

165 
lše
;

166 *
code
;

167 
symbŞ
 *
´ecsym
;

168 
šdex
;

169 
BoŞ—n
 
ÿnReduû
;

170 
ruË
 *
Ãxhs
;

171 
ruË
 *
Ãxt
;

179 
	scÚfig
 {

180 
ruË
 *
½
;

181 
dÙ
;

182 *
fws
;

183 
¶šk
 *
åÍ
;

184 
¶šk
 *
b¶p
;

185 
¡©e
 *
¡p
;

187 
COMPLETE
,

188 
INCOMPLETE


189 } 
¡©us
;

190 
cÚfig
 *
Ãxt
;

191 
cÚfig
 *
bp
;

195 
	saùiÚ
 {

196 
symbŞ
 *
¥
;

197 
	ee_aùiÚ
 {

198 
SHIFT
,

199 
ACCEPT
,

200 
REDUCE
,

201 
ERROR
,

202 
SSCONFLICT
,

203 
SRCONFLICT
,

204 
RRCONFLICT
,

205 
SH_RESOLVED
,

206 
RD_RESOLVED
,

207 
NOT_USED


208 } 
ty³
;

210 
¡©e
 *
¡p
;

211 
ruË
 *
½
;

212 } 
x
;

213 
aùiÚ
 *
Ãxt
;

214 
aùiÚ
 *
cŞlide
;

219 
	s¡©e
 {

220 
cÚfig
 *
bp
;

221 
cÚfig
 *
cå
;

222 
¡©’um
;

223 
aùiÚ
 *
­
;

224 
nTknAù
, 
nNtAù
;

225 
iTknOf¡
, 
iNtOf¡
;

226 
iDæt
;

228 
	#NO_OFFSET
 (-2147483647)

	)

233 
	s¶šk
 {

234 
cÚfig
 *
cå
;

235 
¶šk
 *
Ãxt
;

242 
	sËmÚ
 {

243 
¡©e
 **
sÜ‹d
;

244 
ruË
 *rule;

245 
n¡©e
;

246 
ÄuË
;

247 
nsymbŞ
;

248 
Á”mš®
;

249 
symbŞ
 **
symbŞs
;

250 
”rÜút
;

251 
symbŞ
 *
”rsym
;

252 
symbŞ
 *
wdÿrd
;

253 *
Çme
;

254 *
¬g
;

255 *
tok’ty³
;

256 *
v¬ty³
;

257 *
¡¬t
;

258 *
¡acksize
;

259 *
šşude
;

260 *
”rÜ
;

261 *
ov”æow
;

262 *
çu»
;

263 *
acû±
;

264 *
exŒacode
;

265 *
tok’de¡
;

266 *
v¬de¡
;

267 *
f’ame
;

268 *
ouŠame
;

269 *
tok’´efix
;

270 
ncÚæiù
;

271 
bËsize
;

272 
basisæag
;

273 
has_çÎback
;

274 
nŞš’osæag
;

275 *
¬gv0
;

278 
	#MemÜyCheck
(
X
) if((X)==0){ \

279 
	`memÜy_”rÜ
(); \

280 
	`memÜy_”rÜ
(); \

281 
	}

	)
}

298 *
SŒ§ã
();

300 
SŒ§ã_š™
( );

301 
SŒ§ã_š£¹
( );

302 *
SŒ§ã_fšd
( );

306 
symbŞ
 *
SymbŞ_Ãw
();

307 
SymbŞcmµ
( );

308 
SymbŞ_š™
( );

309 
SymbŞ_š£¹
( );

310 
symbŞ
 *
SymbŞ_fšd
( );

311 
symbŞ
 *
SymbŞ_Nth
( );

312 
SymbŞ_couÁ
( );

313 
symbŞ
 **
SymbŞ_¬¿yof
( );

317 
CÚfigcmp
( );

318 
¡©e
 *
S‹_Ãw
();

319 
S‹_š™
( );

320 
S‹_š£¹
( );

321 
¡©e
 *
S‹_fšd
( );

322 
¡©e
 **
S‹_¬¿yof
( );

326 
CÚfigbË_š™
( );

327 
CÚfigbË_š£¹
( );

328 
cÚfig
 *
CÚfigbË_fšd
( );

329 
CÚfigbË_ş—r
( );

336 
aùiÚ
 *
	$AùiÚ_Ãw
(){

337 
aùiÚ
 *
ä“li¡
 = 0;

338 
aùiÚ
 *
Ãw
;

340 ifĞ
ä“li¡
==0 ){

341 
i
;

342 
amt
 = 100;

343 
ä“li¡
 = (
aùiÚ
 *)
	`ÿÎoc
(
amt
, (action));

344 ifĞ
ä“li¡
==0 ){

345 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew…arser‡ction.");

346 
	`ex™
(1);

348 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

349 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

351 
Ãw
 = 
ä“li¡
;

352 
ä“li¡
 = f»–i¡->
Ãxt
;

353  
Ãw
;

354 
	}
}

360 
	$aùiÚcmp
(

361 
aùiÚ
 *
­1
,

362 
aùiÚ
 *
­2


364 
rc
;

365 
rc
 = 
­1
->
¥
->
šdex
 - 
­2
->sp->index;

366 ifĞ
rc
==0 ){

367 
rc
 = ()
­1
->
ty³
 - ()
­2
->type;

369 ifĞ
rc
==0 && 
­1
->
ty³
==
REDUCE
 ){

370 
rc
 = 
­1
->
x
.
½
->
šdex
 - 
­2
->x.rp->index;

372  
rc
;

373 
	}
}

376 
aùiÚ
 *
	$AùiÚ_sÜt
(

377 
aùiÚ
 *
­


379 
­
 = (
aùiÚ
 *)
	`msÜt
((*ïp,(**)&­->
Ãxt
,

380 ((*)(cÚ¡ *,cÚ¡ *))
aùiÚcmp
);

381  
­
;

382 
	}
}

384 
	$AùiÚ_add
(
­p
,
ty³
,
¥
,
¬g
)

385 
aùiÚ
 **
­p
;

386 
e_aùiÚ
 
ty³
;

387 
symbŞ
 *
¥
;

388 *
¬g
;

390 
aùiÚ
 *
Ãw
;

391 
Ãw
 = 
	`AùiÚ_Ãw
();

392 
Ãw
->
Ãxt
 = *
­p
;

393 *
­p
 = 
Ãw
;

394 
Ãw
->
ty³
 =ype;

395 
Ãw
->
¥
 = sp;

396 ifĞ
ty³
==
SHIFT
 ){

397 
Ãw
->
x
.
¡p
 = (
¡©e
 *)
¬g
;

399 
Ãw
->
x
.
½
 = (
ruË
 *)
¬g
;

401 
	}
}

411 
aùb
 
	taùb
;

412 
	saùb
 {

413 
	mnAùiÚ
;

414 
	mnAùiÚAÎoc
;

416 
	mlookah—d
;

417 
	maùiÚ
;

418 } *
	maAùiÚ
,

419 *
	maLookah—d
;

420 
	mmnLookah—d
;

421 
	mmnAùiÚ
;

422 
	mmxLookah—d
;

423 
	mnLookah—d
;

424 
	mnLookah—dAÎoc
;

428 
	#aùb_size
(
X
è((X)->
nAùiÚ
)

	)

431 
	#aùb_yyaùiÚ
(
X
,
N
è((X)->
aAùiÚ
[N].
aùiÚ
)

	)

434 
	#aùb_yylookah—d
(
X
,
N
è((X)->
aAùiÚ
[N].
lookah—d
)

	)

437 
	$aùb_ä“
(
aùb
 *
p
){

438 
	`ä“
Ğ
p
->
aAùiÚ
 );

439 
	`ä“
Ğ
p
->
aLookah—d
 );

440 
	`ä“
Ğ
p
 );

441 
	}
}

444 
aùb
 *
	$aùb_®loc
(){

445 
aùb
 *
p
 = 
	`ÿÎoc
( 1, (*p) );

446 ifĞ
p
==0 ){

447 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew‡cttab.");

448 
	`ex™
(1);

450 
	`mem£t
(
p
, 0, (*p));

451  
p
;

452 
	}
}

456 
	$aùb_aùiÚ
(
aùb
 *
p
, 
lookah—d
, 
aùiÚ
){

457 ifĞ
p
->
nLookah—d
>õ->
nLookah—dAÎoc
 ){

458 
p
->
nLookah—dAÎoc
 += 25;

459 
p
->
aLookah—d
 = 
	`»®loc
(…->aLookahead,

460 (
p
->
aLookah—d
[0])*p->
nLookah—dAÎoc
 );

461 ifĞ
p
->
aLookah—d
==0 ){

462 
	`årštf
(
¡d”r
,"malloc failed\n");

463 
	`ex™
(1);

466 ifĞ
p
->
nLookah—d
==0 ){

467 
p
->
mxLookah—d
 = 
lookah—d
;

468 
p
->
mnLookah—d
 = 
lookah—d
;

469 
p
->
mnAùiÚ
 = 
aùiÚ
;

471 ifĞ
p
->
mxLookah—d
<
lookah—d
 )…->mxLookahead =†ookahead;

472 ifĞ
p
->
mnLookah—d
>
lookah—d
 ){

473 
p
->
mnLookah—d
 = 
lookah—d
;

474 
p
->
mnAùiÚ
 = 
aùiÚ
;

477 
p
->
aLookah—d
[p->
nLookah—d
].
lookah—d
 =†ookahead;

478 
p
->
aLookah—d
[p->
nLookah—d
].
aùiÚ
 =‡ction;

479 
p
->
nLookah—d
++;

480 
	}
}

489 
	$aùb_š£¹
(
aùb
 *
p
){

490 
i
, 
j
, 
k
, 
n
;

491 
	`as£¹
Ğ
p
->
nLookah—d
>0 );

497 
n
 = 
p
->
mxLookah—d
 + 1;

498 ifĞ
p
->
nAùiÚ
 + 
n
 >ğp->
nAùiÚAÎoc
 ){

499 
ŞdAÎoc
 = 
p
->
nAùiÚAÎoc
;

500 
p
->
nAùiÚAÎoc
 =…->
nAùiÚ
 + 
n
 +…->nActionAlloc + 20;

501 
p
->
aAùiÚ
 = 
	`»®loc
(…->aAction,

502 (
p
->
aAùiÚ
[0])*p->
nAùiÚAÎoc
);

503 ifĞ
p
->
aAùiÚ
==0 ){

504 
	`årštf
(
¡d”r
,"malloc failed\n");

505 
	`ex™
(1);

507 
i
=
ŞdAÎoc
; i<
p
->
nAùiÚAÎoc
; i++){

508 
p
->
aAùiÚ
[
i
].
lookah—d
 = -1;

509 
p
->
aAùiÚ
[
i
].
aùiÚ
 = -1;

520 
i
=0; i<
p
->
nAùiÚ
+p->
mnLookah—d
; i++){

521 ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
<0 ){

522 
j
=0; j<
p
->
nLookah—d
; j++){

523 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

524 ifĞ
k
<0 ) ;

525 ifĞ
p
->
aAùiÚ
[
k
].
lookah—d
>=0 ) ;

527 ifĞ
j
<
p
->
nLookah—d
 ) ;

528 
j
=0; j<
p
->
nAùiÚ
; j++){

529 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) ;

531 ifĞ
j
==
p
->
nAùiÚ
 ){

534 }ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
=õ->
mnLookah—d
 ){

535 ifĞ
p
->
aAùiÚ
[
i
].
aùiÚ
!õ->
mnAùiÚ
 ) ;

536 
j
=0; j<
p
->
nLookah—d
; j++){

537 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

538 ifĞ
k
<0 || k>=
p
->
nAùiÚ
 ) ;

539 ifĞ
p
->
aLookah—d
[
j
].
lookah—d
!õ->
aAùiÚ
[
k
].lookahead ) ;

540 ifĞ
p
->
aLookah—d
[
j
].
aùiÚ
!õ->
aAùiÚ
[
k
].action ) ;

542 ifĞ
j
<
p
->
nLookah—d
 ) ;

543 
n
 = 0;

544 
j
=0; j<
p
->
nAùiÚ
; j++){

545 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
<0 ) ;

546 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) 
n
++;

548 ifĞ
n
==
p
->
nLookah—d
 ){

554 
j
=0; j<
p
->
nLookah—d
; j++){

555 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

556 
p
->
aAùiÚ
[
k
] =…->
aLookah—d
[
j
];

557 ifĞ
k
>=
p
->
nAùiÚ
 )…->nAction = k+1;

559 
p
->
nLookah—d
 = 0;

563  
i
 - 
p
->
mnLookah—d
;

564 
	}
}

581 
	$FšdRuËP»ûd’ûs
(
xp
)

582 
ËmÚ
 *
xp
;

584 
ruË
 *
½
;

585 
½
=
xp
->
ruË
;„p;„pôp->
Ãxt
){

586 ifĞ
½
->
´ecsym
==0 ){

587 
i
, 
j
;

588 
i
=0; i<
½
->
Ähs
 &&„p->
´ecsym
==0; i++){

589 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

590 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

591 
j
=0; j<
¥
->
nsubsym
; j++){

592 ifĞ
¥
->
subsym
[
j
]->
´ec
>=0 ){

593 
½
->
´ecsym
 = 
¥
->
subsym
[
j
];

597 }ifĞ
¥
->
´ec
>=0 ){

598 
½
->
´ecsym
 =„p->
rhs
[
i
];

604 
	}
}

611 
	$FšdFœ¡S‘s
(
Ëmp
)

612 
ËmÚ
 *
Ëmp
;

614 
i
, 
j
;

615 
ruË
 *
½
;

616 
´og»ss
;

618 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

619 
Ëmp
->
symbŞs
[
i
]->
Ïmbda
 = 
LEMON_FALSE
;

621 
i
=
Ëmp
->
Á”mš®
; i<Ëmp->
nsymbŞ
; i++){

622 
Ëmp
->
symbŞs
[
i
]->
fœ¡£t
 = 
	`S‘New
();

627 
´og»ss
 = 0;

628 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

629 ifĞ
½
->
lhs
->
Ïmbda
 ) ;

630 
i
=0; i<
½
->
Ähs
; i++){

631 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

632 ifĞ
¥
->
ty³
!=
TERMINAL
 || sp->
Ïmbda
==
LEMON_FALSE
 ) ;

634 ifĞ
i
==
½
->
Ähs
 ){

635 
½
->
lhs
->
Ïmbda
 = 
LEMON_TRUE
;

636 
´og»ss
 = 1;

639 } 
´og»ss
 );

643 
symbŞ
 *
s1
, *
s2
;

644 
´og»ss
 = 0;

645 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

646 
s1
 = 
½
->
lhs
;

647 
i
=0; i<
½
->
Ähs
; i++){

648 
s2
 = 
½
->
rhs
[
i
];

649 ifĞ
s2
->
ty³
==
TERMINAL
 ){

650 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
šdex
);

652 }ifĞ
s2
->
ty³
==
MULTITERMINAL
 ){

653 
j
=0; j<
s2
->
nsubsym
; j++){

654 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
subsym
[
j
]->
šdex
);

657 }ifĞ
s1
==
s2
 ){

658 ifĞ
s1
->
Ïmbda
==
LEMON_FALSE
 ) ;

660 
´og»ss
 +ğ
	`S‘UniÚ
(
s1
->
fœ¡£t
,
s2
->firstset);

661 ifĞ
s2
->
Ïmbda
==
LEMON_FALSE
 ) ;

665 } 
´og»ss
 );

667 
	}
}

673 
PRIVATE
 
¡©e
 *
g‘¡©e
( );

674 
	$FšdS‹s
(
Ëmp
)

675 
ËmÚ
 *
Ëmp
;

677 
symbŞ
 *
¥
;

678 
ruË
 *
½
;

680 
	`CÚfigli¡_š™
();

683 ifĞ
Ëmp
->
¡¬t
 ){

684 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

685 ifĞ
¥
==0 ){

686 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

687 "Th¥ecif›d s¹ symbŞ \"%s\" i nÙ \
‡‚Ú‹rmš® oàthg¿mm¬. \"%s\" wÈbu£d‡ th¡¬ˆ\
 in¡—d.",
Ëmp
->
¡¬t
,Ëmp->
ruË
->
lhs
->
Çme
);

690 
Ëmp
->
”rÜút
++;

691 
¥
 = 
Ëmp
->
ruË
->
lhs
;

694 
¥
 = 
Ëmp
->
ruË
->
lhs
;

700 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

701 
i
;

702 
i
=0; i<
½
->
Ähs
; i++){

703 ifĞ
½
->
rhs
[
i
]==
¥
 ){

704 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

705 "Th¡¬ˆsymbŞ \"%s\" occur Úh\
-hªd sidoà¨ruË. Thi wÈ»suÉ iÀ¨·r£¸which \
‚Ù wÜk…rİ”ly.",
¥
->
Çme
);

708 
Ëmp
->
”rÜút
++;

716 
½
=
¥
->
ruË
;„p;„pôp->
Ãxhs
){

717 
cÚfig
 *
Ãwcå
;

718 
½
->
lhsS¹
 = 1;

719 
Ãwcå
 = 
	`CÚfigli¡_addbasis
(
½
,0);

720 
	`S‘Add
(
Ãwcå
->
fws
,0);

726 ()
	`g‘¡©e
(
Ëmp
);

728 
	}
}

733 
PRIVATE
 
budshiás
( );

734 
PRIVATE
 
¡©e
 *
	$g‘¡©e
(
Ëmp
)

735 
ËmÚ
 *
Ëmp
;

737 
cÚfig
 *
cå
, *
bp
;

738 
¡©e
 *
¡p
;

742 
	`CÚfigli¡_sÜtbasis
();

743 
bp
 = 
	`CÚfigli¡_basis
();

746 
¡p
 = 
	`S‹_fšd
(
bp
);

747 ifĞ
¡p
 ){

751 
cÚfig
 *
x
, *
y
;

752 
x
=
bp
, 
y
=
¡p
->bp; x && y; x=x->bp, y=y->bp){

753 
	`Plšk_cİy
(&
y
->
b¶p
,
x
->bplp);

754 
	`Plšk_d–‘e
(
x
->
åÍ
);

755 
x
->
åÍ
 = x->
b¶p
 = 0;

757 
cå
 = 
	`CÚfigli¡_»tuº
();

758 
	`CÚfigli¡_—t
(
cå
);

761 
	`CÚfigli¡_şosu»
(
Ëmp
);

762 
	`CÚfigli¡_sÜt
();

763 
cå
 = 
	`CÚfigli¡_»tuº
();

764 
¡p
 = 
	`S‹_Ãw
();

765 
	`MemÜyCheck
(
¡p
);

766 
¡p
->
bp
 = bp;

767 
¡p
->
cå
 = cfp;

768 
¡p
->
¡©’um
 = 
Ëmp
->
n¡©e
++;

769 
¡p
->
­
 = 0;

770 
	`S‹_š£¹
(
¡p
,¡p->
bp
);

771 
	`budshiás
(
Ëmp
,
¡p
);

773  
¡p
;

774 
	}
}

779 
	$§me_symbŞ
(
a
,
b
)

780 
symbŞ
 *
a
;

781 
symbŞ
 *
b
;

783 
i
;

784 ifĞ
a
==
b
 )  1;

785 ifĞ
a
->
ty³
!=
MULTITERMINAL
 )  0;

786 ifĞ
b
->
ty³
!=
MULTITERMINAL
 )  0;

787 ifĞ
a
->
nsubsym
!=
b
->nsubsym )  0;

788 
i
=0; i<
a
->
nsubsym
; i++){

789 ifĞ
a
->
subsym
[
i
]!=
b
->subsym[i] )  0;

792 
	}
}

797 
PRIVATE
 
	$budshiás
(
Ëmp
,
¡p
)

798 
ËmÚ
 *
Ëmp
;

799 
¡©e
 *
¡p
;

801 
cÚfig
 *
cå
;

802 
cÚfig
 *
bcå
;

803 
cÚfig
 *
Ãw
;

804 
symbŞ
 *
¥
;

805 
symbŞ
 *
b¥
;

806 
¡©e
 *
Ãw¡p
;

810 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
ècå->
¡©us
 = 
INCOMPLETE
;

813 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

814 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

815 ifĞ
cå
->
dÙ
>=cå->
½
->
Ähs
 ) ;

816 
	`CÚfigli¡_»£t
();

817 
¥
 = 
cå
->
½
->
rhs
[cå->
dÙ
];

822 
bcå
=
cå
; bcå; bcå=bcå->
Ãxt
){

823 ifĞ
bcå
->
¡©us
==
COMPLETE
 ) ;

824 ifĞ
bcå
->
dÙ
>=bcå->
½
->
Ähs
 ) ;

825 
b¥
 = 
bcå
->
½
->
rhs
[bcå->
dÙ
];

826 ifĞ!
	`§me_symbŞ
(
b¥
,
¥
) ) ;

827 
bcå
->
¡©us
 = 
COMPLETE
;

828 
Ãw
 = 
	`CÚfigli¡_addbasis
(
bcå
->
½
,bcå->
dÙ
+1);

829 
	`Plšk_add
(&
Ãw
->
b¶p
,
bcå
);

834 
Ãw¡p
 = 
	`g‘¡©e
(
Ëmp
);

838 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

839 
i
;

840 
i
=0; i<
¥
->
nsubsym
; i++){

841 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
->
subsym
[
i
],(*)
Ãw¡p
);

844 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
,(*)
Ãw¡p
);

847 
	}
}

852 
	$FšdLšks
(
Ëmp
)

853 
ËmÚ
 *
Ëmp
;

855 
i
;

856 
cÚfig
 *
cå
, *
Ùh”
;

857 
¡©e
 *
¡p
;

858 
¶šk
 *
¶p
;

863 
i
=0; i<
Ëmp
->
n¡©e
; i++){

864 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

865 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

866 
cå
->
¡p
 = stp;

872 
i
=0; i<
Ëmp
->
n¡©e
; i++){

873 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

874 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

875 
¶p
=
cå
->
b¶p
;…Í;…ÍõÍ->
Ãxt
){

876 
Ùh”
 = 
¶p
->
cå
;

877 
	`Plšk_add
(&
Ùh”
->
åÍ
,
cå
);

881 
	}
}

888 
	$FšdFŞlowS‘s
(
Ëmp
)

889 
ËmÚ
 *
Ëmp
;

891 
i
;

892 
cÚfig
 *
cå
;

893 
¶šk
 *
¶p
;

894 
´og»ss
;

895 
chªge
;

897 
i
=0; i<
Ëmp
->
n¡©e
; i++){

898 
cå
=
Ëmp
->
sÜ‹d
[
i
]->cå; cå; cå=cå->
Ãxt
){

899 
cå
->
¡©us
 = 
INCOMPLETE
;

904 
´og»ss
 = 0;

905 
i
=0; i<
Ëmp
->
n¡©e
; i++){

906 
cå
=
Ëmp
->
sÜ‹d
[
i
]->cå; cå; cå=cå->
Ãxt
){

907 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

908 
¶p
=
cå
->
åÍ
;…Í;…ÍõÍ->
Ãxt
){

909 
chªge
 = 
	`S‘UniÚ
(
¶p
->
cå
->
fws
,cfp->fws);

910 ifĞ
chªge
 ){

911 
¶p
->
cå
->
¡©us
 = 
INCOMPLETE
;

912 
´og»ss
 = 1;

915 
cå
->
¡©us
 = 
COMPLETE
;

918 } 
´og»ss
 );

919 
	}
}

921 
»sŞve_cÚæiù
();

925 
	$FšdAùiÚs
(
Ëmp
)

926 
ËmÚ
 *
Ëmp
;

928 
i
,
j
;

929 
cÚfig
 *
cå
;

930 
¡©e
 *
¡p
;

931 
symbŞ
 *
¥
;

932 
ruË
 *
½
;

938 
i
=0; i<
Ëmp
->
n¡©e
; i++){

939 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

940 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

941 ifĞ
cå
->
½
->
Ähs
==cå->
dÙ
 ){

942 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

943 ifĞ
	`S‘Fšd
(
cå
->
fws
,
j
) ){

946 
	`AùiÚ_add
(&
¡p
->
­
,
REDUCE
,
Ëmp
->
symbŞs
[
j
],(*)
cå
->
½
);

954 ifĞ
Ëmp
->
¡¬t
 ){

955 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

956 ifĞ
¥
==0 ) s°ğ
Ëmp
->
ruË
->
lhs
;

958 
¥
 = 
Ëmp
->
ruË
->
lhs
;

963 
	`AùiÚ_add
(&
Ëmp
->
sÜ‹d
[0]->
­
,
ACCEPT
,
¥
,0);

966 
i
=0; i<
Ëmp
->
n¡©e
; i++){

967 
aùiÚ
 *
­
, *
Çp
;

968 
¡©e
 *
¡p
;

969 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

971 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

972 
­
=
¡p
->­;‡°&&‡p->
Ãxt
;‡p=ap->next){

973 
Çp
=
­
->
Ãxt
;‚­ &&‚­->
¥
==ap->sp;‚ap=nap->next){

976 
Ëmp
->
ncÚæiù
 +ğ
	`»sŞve_cÚæiù
(
­
,
Çp
,Ëmp->
”rsym
);

982 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
è½->
ÿnReduû
 = 
LEMON_FALSE
;

983 
i
=0; i<
Ëmp
->
n¡©e
; i++){

984 
aùiÚ
 *
­
;

985 
­
=
Ëmp
->
sÜ‹d
[
i
]->­;‡p;‡p÷p->
Ãxt
){

986 ifĞ
­
->
ty³
==
REDUCE
 )‡p->
x
.
½
->
ÿnReduû
 = 
LEMON_TRUE
;

989 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

990 ifĞ
½
->
ÿnReduû
 ) ;

991 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,"This„ule can‚ot be„educed.\n");

992 
Ëmp
->
”rÜút
++;

994 
	}
}

1009 
	$»sŞve_cÚæiù
(
­x
,
­y
,
”rsym
)

1010 
aùiÚ
 *
­x
;

1011 
aùiÚ
 *
­y
;

1012 
symbŞ
 *
”rsym
;

1014 
symbŞ
 *
¥x
, *
¥y
;

1015 
”rút
 = 0;

1016 
	`as£¹
Ğ
­x
->
¥
==
­y
->sp );

1017 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->type==SHIFT ){

1018 
­y
->
ty³
 = 
SSCONFLICT
;

1019 
”rút
++;

1021 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->ty³==
REDUCE
 ){

1022 
¥x
 = 
­x
->
¥
;

1023 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1024 ifĞ
¥y
==0 || 
¥x
->
´ec
<0 || spy->prec<0 ){

1026 
­y
->
ty³
 = 
SRCONFLICT
;

1027 
”rút
++;

1028 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1029 
­y
->
ty³
 = 
RD_RESOLVED
;

1030 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1031 
­x
->
ty³
 = 
SH_RESOLVED
;

1032 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
RIGHT
 ){

1033 
­y
->
ty³
 = 
RD_RESOLVED
;

1034 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
LEFT
 ){

1035 
­x
->
ty³
 = 
SH_RESOLVED
;

1037 
	`as£¹
Ğ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
NONE
 );

1038 
­y
->
ty³
 = 
SRCONFLICT
;

1039 
”rút
++;

1041 }ifĞ
­x
->
ty³
==
REDUCE
 && 
­y
->type==REDUCE ){

1042 
¥x
 = 
­x
->
x
.
½
->
´ecsym
;

1043 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1044 ifĞ
¥x
==0 || 
¥y
==0 || spx->
´ec
<0 ||

1045 
¥y
->
´ec
<0 || 
¥x
->prec==spy->prec ){

1046 
­y
->
ty³
 = 
RRCONFLICT
;

1047 
”rút
++;

1048 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1049 
­y
->
ty³
 = 
RD_RESOLVED
;

1050 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1051 
­x
->
ty³
 = 
RD_RESOLVED
;

1054 
	`as£¹
(

1055 
­x
->
ty³
==
SH_RESOLVED
 ||

1056 
­x
->
ty³
==
RD_RESOLVED
 ||

1057 
­x
->
ty³
==
SSCONFLICT
 ||

1058 
­x
->
ty³
==
SRCONFLICT
 ||

1059 
­x
->
ty³
==
RRCONFLICT
 ||

1060 
­y
->
ty³
==
SH_RESOLVED
 ||

1061 
­y
->
ty³
==
RD_RESOLVED
 ||

1062 
­y
->
ty³
==
SSCONFLICT
 ||

1063 
­y
->
ty³
==
SRCONFLICT
 ||

1064 
­y
->
ty³
==
RRCONFLICT


1070  
”rút
;

1071 
	}
}

1078 
cÚfig
 *
	gä“li¡
 = 0;

1079 
cÚfig
 *
	gcu¼’t
 = 0;

1080 
cÚfig
 **
	gcu¼’‹nd
 = 0;

1081 
cÚfig
 *
	gbasis
 = 0;

1082 
cÚfig
 **
	gbasi£nd
 = 0;

1085 
PRIVATE
 
cÚfig
 *
	$ÃwcÚfig
(){

1086 
cÚfig
 *
Ãw
;

1087 ifĞ
ä“li¡
==0 ){

1088 
i
;

1089 
amt
 = 3;

1090 
ä“li¡
 = (
cÚfig
 *)
	`ÿÎoc
Ğ
amt
, (config) );

1091 ifĞ
ä“li¡
==0 ){

1092 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew configuration.");

1093 
	`ex™
(1);

1095 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

1096 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

1098 
Ãw
 = 
ä“li¡
;

1099 
ä“li¡
 = f»–i¡->
Ãxt
;

1100  
Ãw
;

1101 
	}
}

1104 
PRIVATE
 
	$d–‘ecÚfig
(
Şd
)

1105 
cÚfig
 *
Şd
;

1107 
Şd
->
Ãxt
 = 
ä“li¡
;

1108 
ä“li¡
 = 
Şd
;

1109 
	}
}

1112 
	$CÚfigli¡_š™
(){

1113 
cu¼’t
 = 0;

1114 
cu¼’‹nd
 = &
cu¼’t
;

1115 
basis
 = 0;

1116 
basi£nd
 = &
basis
;

1117 
	`CÚfigbË_š™
();

1119 
	}
}

1122 
	$CÚfigli¡_»£t
(){

1123 
cu¼’t
 = 0;

1124 
cu¼’‹nd
 = &
cu¼’t
;

1125 
basis
 = 0;

1126 
basi£nd
 = &
basis
;

1127 
	`CÚfigbË_ş—r
(0);

1129 
	}
}

1132 
cÚfig
 *
	$CÚfigli¡_add
(
½
,
dÙ
)

1133 
ruË
 *
½
;

1134 
dÙ
;

1136 
cÚfig
 *
cå
, 
mod–
;

1138 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1139 
mod–
.
½
 =„p;

1140 
mod–
.
dÙ
 = dot;

1141 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1142 ifĞ
cå
==0 ){

1143 
cå
 = 
	`ÃwcÚfig
();

1144 
cå
->
½
 =„p;

1145 
cå
->
dÙ
 = dot;

1146 
cå
->
fws
 = 
	`S‘New
();

1147 
cå
->
¡p
 = 0;

1148 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1149 
cå
->
Ãxt
 = 0;

1150 
cå
->
bp
 = 0;

1151 *
cu¼’‹nd
 = 
cå
;

1152 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1153 
	`CÚfigbË_š£¹
(
cå
);

1155  
cå
;

1156 
	}
}

1159 
cÚfig
 *
	$CÚfigli¡_addbasis
(
½
,
dÙ
)

1160 
ruË
 *
½
;

1161 
dÙ
;

1163 
cÚfig
 *
cå
, 
mod–
;

1165 
	`as£¹
Ğ
basi£nd
!=0 );

1166 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1167 
mod–
.
½
 =„p;

1168 
mod–
.
dÙ
 = dot;

1169 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1170 ifĞ
cå
==0 ){

1171 
cå
 = 
	`ÃwcÚfig
();

1172 
cå
->
½
 =„p;

1173 
cå
->
dÙ
 = dot;

1174 
cå
->
fws
 = 
	`S‘New
();

1175 
cå
->
¡p
 = 0;

1176 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1177 
cå
->
Ãxt
 = 0;

1178 
cå
->
bp
 = 0;

1179 *
cu¼’‹nd
 = 
cå
;

1180 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1181 *
basi£nd
 = 
cå
;

1182 
basi£nd
 = &
cå
->
bp
;

1183 
	`CÚfigbË_š£¹
(
cå
);

1185  
cå
;

1186 
	}
}

1189 
	$CÚfigli¡_şosu»
(
Ëmp
)

1190 
ËmÚ
 *
Ëmp
;

1192 
cÚfig
 *
cå
, *
Ãwcå
;

1193 
ruË
 *
½
, *
Ãw½
;

1194 
symbŞ
 *
¥
, *
x¥
;

1195 
i
, 
dÙ
;

1197 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1198 
cå
=
cu¼’t
; cå; cå=cå->
Ãxt
){

1199 
½
 = 
cå
->rp;

1200 
dÙ
 = 
cå
->dot;

1201 ifĞ
dÙ
>=
½
->
Ähs
 ) ;

1202 
¥
 = 
½
->
rhs
[
dÙ
];

1203 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

1204 ifĞ
¥
->
ruË
==0 && sp!=
Ëmp
->
”rsym
 ){

1205 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
lše
,"Nonterminal \"%s\" has‚o„ules.",

1206 
¥
->
Çme
);

1207 
Ëmp
->
”rÜút
++;

1209 
Ãw½
=
¥
->
ruË
;‚ew½;‚ew½òew½->
Ãxhs
){

1210 
Ãwcå
 = 
	`CÚfigli¡_add
(
Ãw½
,0);

1211 
i
=
dÙ
+1; i<
½
->
Ähs
; i++){

1212 
x¥
 = 
½
->
rhs
[
i
];

1213 ifĞ
x¥
->
ty³
==
TERMINAL
 ){

1214 
	`S‘Add
(
Ãwcå
->
fws
,
x¥
->
šdex
);

1216 }ifĞ
x¥
->
ty³
==
MULTITERMINAL
 ){

1217 
k
;

1218 
k
=0; k<
x¥
->
nsubsym
; k++){

1219 
	`S‘Add
(
Ãwcå
->
fws
, 
x¥
->
subsym
[
k
]->
šdex
);

1223 
	`S‘UniÚ
(
Ãwcå
->
fws
,
x¥
->
fœ¡£t
);

1224 ifĞ
x¥
->
Ïmbda
==
LEMON_FALSE
 ) ;

1227 ifĞ
i
==
½
->
Ähs
 ) 
	`Plšk_add
(&
cå
->
åÍ
,
Ãwcå
);

1232 
	}
}

1235 
	$CÚfigli¡_sÜt
(){

1236 
cu¼’t
 = (
cÚfig
 *)
	`msÜt
((*)cu¼’t,(**)&(cu¼’t->
Ãxt
),
CÚfigcmp
);

1237 
cu¼’‹nd
 = 0;

1239 
	}
}

1242 
	$CÚfigli¡_sÜtbasis
(){

1243 
basis
 = (
cÚfig
 *)
	`msÜt
((*)
cu¼’t
,(**)&(cu¼’t->
bp
),
CÚfigcmp
);

1244 
basi£nd
 = 0;

1246 
	}
}

1250 
cÚfig
 *
	$CÚfigli¡_»tuº
(){

1251 
cÚfig
 *
Şd
;

1252 
Şd
 = 
cu¼’t
;

1253 
cu¼’t
 = 0;

1254 
cu¼’‹nd
 = 0;

1255  
Şd
;

1256 
	}
}

1260 
cÚfig
 *
	$CÚfigli¡_basis
(){

1261 
cÚfig
 *
Şd
;

1262 
Şd
 = 
basis
;

1263 
basis
 = 0;

1264 
basi£nd
 = 0;

1265  
Şd
;

1266 
	}
}

1269 
	$CÚfigli¡_—t
(
cå
)

1270 
cÚfig
 *
cå
;

1272 
cÚfig
 *
Ãxtcå
;

1273 ; 
cå
; cå=
Ãxtcå
){

1274 
Ãxtcå
 = 
cå
->
Ãxt
;

1275 
	`as£¹
Ğ
cå
->
åÍ
==0 );

1276 
	`as£¹
Ğ
cå
->
b¶p
==0 );

1277 ifĞ
cå
->
fws
 ) 
	`S‘F»e
(cfp->fws);

1278 
	`d–‘ecÚfig
(
cå
);

1281 
	}
}

1290 
	$fšdb»ak
(
msg
,
mš
,
max
)

1291 *
msg
;

1292 
mš
;

1293 
max
;

1295 
i
,
¥Ù
;

1296 
c
;

1297 
i
=
¥Ù
=
mš
; i<=
max
; i++){

1298 
c
 = 
msg
[
i
];

1299 ifĞ
c
=='\t' ) 
msg
[
i
] = ' ';

1300 ifĞ
c
=='\n' ){ 
msg
[
i
] = ' '; 
¥Ù
 = i; ; }

1301 ifĞ
c
==0 ){ 
¥Ù
 = 
i
; ; }

1302 ifĞ
c
=='-' && 
i
<
max
-1 ) 
¥Ù
 = i+1;

1303 ifĞ
c
==' ' ) 
¥Ù
 = 
i
;

1305  
¥Ù
;

1306 
	}
}

1313 
	#ERRMSGSIZE
 10000

	)

1314 
	#LINEWIDTH
 79

	)

1315 
	#PREFIXLIMIT
 30

	)

1316 
	$E¼ÜMsg
(cÚ¡ *
f’ame
, 
lš’o
, cÚ¡ *
fÜm©
, ...){

1317 
”rmsg
[
ERRMSGSIZE
];

1318 
´efix
[
PREFIXLIMIT
+10];

1319 
”rmsgsize
;

1320 
´efixsize
;

1321 
avaabËwidth
;

1322 
va_li¡
 
­
;

1323 
’d
, 
»¡¬t
, 
ba£
;

1325 
	`va_¡¬t
(
­
, 
fÜm©
);

1327 ifĞ
lš’o
>0 ){

1328 
	`¥rštf
(
´efix
,"%.*s:%d: ",
PREFIXLIMIT
-10,
f’ame
,
lš’o
);

1330 
	`¥rštf
(
´efix
,"%.*s: ",
PREFIXLIMIT
-10,
f’ame
);

1332 
´efixsize
 = 
	`ËmÚSŒËn
(
´efix
);

1333 
avaabËwidth
 = 
LINEWIDTH
 - 
´efixsize
;

1336 
	`v¥rštf
(
”rmsg
,
fÜm©
,
­
);

1337 
	`va_’d
(
­
);

1338 
”rmsgsize
 = 
	`ËmÚSŒËn
(
”rmsg
);

1340  
”rmsgsize
>0 && 
”rmsg
[errmsgsize-1]=='\n' ){

1341 
”rmsg
[--
”rmsgsize
] = 0;

1345 
ba£
 = 0;

1346  
”rmsg
[
ba£
]!=0 ){

1347 
’d
 = 
»¡¬t
 = 
	`fšdb»ak
(&
”rmsg
[
ba£
],0,
avaabËwidth
);

1348 
»¡¬t
 +ğ
ba£
;

1349  
”rmsg
[
»¡¬t
]==' ' )„estart++;

1350 
	`årštf
(
¡dout
,"%s%.*s\n",
´efix
,
’d
,&
”rmsg
[
ba£
]);

1351 
ba£
 = 
»¡¬t
;

1353 
	}
}

1362 
	$memÜy_”rÜ
(){

1363 
	`årštf
(
¡d”r
,"Out of memory. Aborting...\n");

1364 
	`ex™
(1);

1365 
	}
}

1367 
	gnDefše
 = 0;

1368 **
	gazDefše
 = 0;

1373 
	$hªdË_D_İtiÚ
(*
z
){

1374 **
·z
;

1375 
nDefše
++;

1376 
azDefše
 = 
	`»®loc
×zDefše, ×zDefše[0])*
nDefše
);

1377 ifĞ
azDefše
==0 ){

1378 
	`årštf
(
¡d”r
,"out of memory\n");

1379 
	`ex™
(1);

1381 
·z
 = &
azDefše
[
nDefše
-1];

1382 *
·z
 = 
	`m®loc
Ğ
	`ËmÚSŒËn
(
z
)+1 );

1383 ifĞ*
·z
==0 ){

1384 
	`årštf
(
¡d”r
,"out of memory\n");

1385 
	`ex™
(1);

1387 
	`¡rıy
(*
·z
, 
z
);

1388 
z
=*
·z
; *z && *z!='='; z++){}

1389 *
z
 = 0;

1390 
	}
}

1394 
	$maš
(
¬gc
,
¬gv
)

1395 
¬gc
;

1396 **
¬gv
;

1398 
v”siÚ
 = 0;

1399 
½æag
 = 0;

1400 
basisæag
 = 0;

1401 
com´ess
 = 0;

1402 
qu›t
 = 0;

1403 
¡©i¡ics
 = 0;

1404 
mhæag
 = 0;

1405 
nŞš’osæag
 = 0;

1406 
s_İtiÚs
 
İtiÚs
[] = {

1407 {
OPT_FLAG
, "b", (*)&
basisæag
, "Print onlyhe basis in„eport."},

1408 {
OPT_FLAG
, "c", (*)&
com´ess
, "Don't compresshe‡ctionable."},

1409 {
OPT_FSTR
, "D", (*)
hªdË_D_İtiÚ
, "Define‡n %ifdef macro."},

1410 {
OPT_FLAG
, "g", (*)&
½æag
, "Print grammar without‡ctions."},

1411 {
OPT_FLAG
, "m", (*)&
mhæag
, "Output‡ makeheaders compatible file."},

1412 {
OPT_FLAG
, "l", (*)&
nŞš’osæag
, "Do‚ot…rint #line statements."},

1413 {
OPT_FLAG
, "q", (*)&
qu›t
, "(Quiet) Don't…rinthe„eport file."},

1414 {
OPT_FLAG
, "s", (*)&
¡©i¡ics
,

1416 {
OPT_FLAG
, "x", (*)&
v”siÚ
, "Printhe version‚umber."},

1417 {
OPT_FLAG
,0,0,0}

1419 
i
;

1420 
ËmÚ
 
Ëm
;

1422 
	`O±In™
(
¬gv
,
İtiÚs
,
¡d”r
);

1423 ifĞ
v”siÚ
 ){

1424 
	`´štf
("Lemon version 1.0\n");

1425 
	`ex™
(0);

1427 ifĞ
	`O±NArgs
()!=1 ){

1428 
	`årštf
(
¡d”r
,"Exactly one filename‡rgument is„equired.\n");

1429 
	`ex™
(1);

1431 
	`mem£t
(&
Ëm
, 0, (lem));

1432 
Ëm
.
”rÜút
 = 0;

1435 
	`SŒ§ã_š™
();

1436 
	`SymbŞ_š™
();

1437 
	`S‹_š™
();

1438 
Ëm
.
¬gv0
 = 
¬gv
[0];

1439 
Ëm
.
f’ame
 = 
	`O±Arg
(0);

1440 
Ëm
.
basisæag
 = basisflag;

1441 
Ëm
.
nŞš’osæag
 =‚olinenosflag;

1442 
	`SymbŞ_Ãw
("$");

1443 
Ëm
.
”rsym
 = 
	`SymbŞ_Ãw
("error");

1444 
Ëm
.
”rsym
->
u£CÁ
 = 0;

1447 
	`P¬£
(&
Ëm
);

1448 ifĞ
Ëm
.
”rÜút
 ) 
	`ex™
(lem.errorcnt);

1449 ifĞ
Ëm
.
ÄuË
==0 ){

1450 
	`årštf
(
¡d”r
,"Empty grammar.\n");

1451 
	`ex™
(1);

1455 
Ëm
.
nsymbŞ
 = 
	`SymbŞ_couÁ
();

1456 
	`SymbŞ_Ãw
("{default}");

1457 
Ëm
.
symbŞs
 = 
	`SymbŞ_¬¿yof
();

1458 
i
=0; i<=
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1459 
	`qsÜt
(
Ëm
.
symbŞs
,Ëm.
nsymbŞ
+1,(
symbŞ
*),

1460 ((*)())
SymbŞcmµ
);

1461 
i
=0; i<=
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1462 
i
=1; 
	`isuµ”
(
Ëm
.
symbŞs
[i]->
Çme
[0]); i++);

1463 
Ëm
.
Á”mš®
 = 
i
;

1466 ifĞ
½æag
 ){

1467 
	`R•ršt
(&
Ëm
);

1470 
	`S‘Size
(
Ëm
.
Á”mš®
+1);

1473 
	`FšdRuËP»ûd’ûs
(&
Ëm
);

1477 
	`FšdFœ¡S‘s
(&
Ëm
);

1481 
Ëm
.
n¡©e
 = 0;

1482 
	`FšdS‹s
(&
Ëm
);

1483 
Ëm
.
sÜ‹d
 = 
	`S‹_¬¿yof
();

1486 
	`FšdLšks
(&
Ëm
);

1489 
	`FšdFŞlowS‘s
(&
Ëm
);

1492 
	`FšdAùiÚs
(&
Ëm
);

1495 ifĞ
com´ess
==0 ) 
	`Com´essTabËs
(&
Ëm
);

1499 
	`ResÜtS‹s
(&
Ëm
);

1502 ifĞ!
qu›t
 ) 
	`R•ÜtOuut
(&
Ëm
);

1505 
	`R•ÜtTabË
(&
Ëm
, 
mhæag
);

1510 ifĞ!
mhæag
 ) 
	`R•ÜtH—d”
(&
Ëm
);

1512 ifĞ
¡©i¡ics
 ){

1513 
	`´štf
("Parser statistics: %derminals, %d‚onterminals, %d„ules\n",

1514 
Ëm
.
Á”mš®
,†em.
nsymbŞ
 -†em.Á”mš®,†em.
ÄuË
);

1515 
	`´štf
(" %d states, %d…arserableƒntries, %d conflicts\n",

1516 
Ëm
.
n¡©e
,†em.
bËsize
,†em.
ncÚæiù
);

1518 ifĞ
Ëm
.
ncÚæiù
 ){

1519 
	`årštf
(
¡d”r
,"%d…¬sšg cÚæiùs.\n",
Ëm
.
ncÚæiù
);

1521 
	`ex™
(
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1522  (
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1523 
	}
}

1551 
	#NEXT
(
A
è(*(**)((()A)+
off£t
))

	)

1568 *
m”ge
(

1569 *
a
,

1570 *
b
,

1571 (*
cmp
)(const *,const *),

1572 
off£t


1574 *
±r
, *
h—d
;

1576 ifĞ
a
==0 ){

1577 
h—d
 = 
b
;

1578 }ifĞ
b
==0 ){

1579 
h—d
 = 
a
;

1581 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1582 
±r
 = 
a
;

1583 
a
 = 
	`NEXT
(a);

1585 
±r
 = 
b
;

1586 
b
 = 
	`NEXT
(b);

1588 
h—d
 = 
±r
;

1589  
a
 && 
b
 ){

1590 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1591 
	`NEXT
(
±r
èğ
a
;

1592 
±r
 = 
a
;

1593 
a
 = 
	`NEXT
(a);

1595 
	`NEXT
(
±r
èğ
b
;

1596 
±r
 = 
b
;

1597 
b
 = 
	`NEXT
(b);

1600 ifĞ
a
 ) 
	`NEXT
(
±r
) =‡;

1601 
	`NEXT
(
±r
èğ
b
;

1603  
h—d
;

1604 
	}
}

1619 
	#LISTSIZE
 30

	)

1620 *
msÜt
(

1621 *
li¡
,

1622 **
Ãxt
,

1623 (*
cmp
)(const *,const *)

1625 
off£t
;

1626 *
•
;

1627 *
£t
[
LISTSIZE
];

1628 
i
;

1629 
off£t
 = ()
Ãxt
 - ()
li¡
;

1630 
i
=0; i<
LISTSIZE
; i++è
£t
[i] = 0;

1631  
li¡
 ){

1632 
•
 = 
li¡
;

1633 
li¡
 = 
	`NEXT
(list);

1634 
	`NEXT
(
•
) = 0;

1635 
i
=0; i<
LISTSIZE
-1 && 
£t
[i]!=0; i++){

1636 
•
 = 
	`m”ge
Óp,
£t
[
i
],
cmp
,
off£t
);

1637 
£t
[
i
] = 0;

1639 
£t
[
i
] = 
•
;

1641 
•
 = 0;

1642 
i
=0; i<
LISTSIZE
; i++èifĞ
£t
[i] ) 
•
 = 
	`m”ge
Óp,£t[i],
cmp
,
off£t
);

1643  
•
;

1644 
	}
}

1646 **
	g¬gv
;

1647 
s_İtiÚs
 *
	gİ
;

1648 
FILE
 *
	g”r¡»am
;

1650 
	#ISOPT
(
X
è((X)[0]=='-'||(X)[0]=='+'||
	`¡rchr
((X),'=')!=0)

	)

1656 
	$”¾še
(
n
,
k
,
”r
)

1657 
n
;

1658 
k
;

1659 
FILE
 *
”r
;

1661 
¥út
, 
i
;

1662 ifĞ
¬gv
[0] ) 
	`årštf
(
”r
,"%s",argv[0]);

1663 
¥út
 = 
	`ËmÚSŒËn
(
¬gv
[0]) + 1;

1664 
i
=1; i<
n
 && 
¬gv
[i]; i++){

1665 
	`årštf
(
”r
," %s",
¬gv
[
i
]);

1666 
¥út
 +ğ
	`ËmÚSŒËn
(
¬gv
[
i
])+1;

1668 
¥út
 +ğ
k
;

1669 ; 
¬gv
[
i
]; i++è
	`årštf
(
”r
," %s",argv[i]);

1670 ifĞ
¥út
<20 ){

1671 
	`årštf
(
”r
,"\n%*s^-- h”e\n",
¥út
,"");

1673 
	`årštf
(
”r
,"\n%*sh”--^\n",
¥út
-7,"");

1675 
	}
}

1681 
	$¬gšdex
(
n
)

1682 
n
;

1684 
i
;

1685 
dashdash
 = 0;

1686 ifĞ
¬gv
!=0 && *argv!=0 ){

1687 
i
=1; 
¬gv
[i]; i++){

1688 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]) ){

1689 ifĞ
n
==0 )  
i
;

1690 
n
--;

1692 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1696 
	}
}

1698 
	gemsg
[] = "Command†ine syntaxƒrror: ";

1703 
	$hªdËæags
(
i
,
”r
)

1704 
i
;

1705 
FILE
 *
”r
;

1707 
v
;

1708 
”rút
 = 0;

1709 
j
;

1710 
j
=0; 
İ
[j].
Ïb–
; j++){

1711 ifĞ
	`¡ºcmp
(&
¬gv
[
i
][1],
İ
[
j
].
Ïb–
,
	`ËmÚSŒËn
(op[j].label))==0 ) ;

1713 
v
 = 
¬gv
[
i
][0]=='-' ? 1 : 0;

1714 ifĞ
İ
[
j
].
Ïb–
==0 ){

1715 ifĞ
”r
 ){

1716 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1717 
	`”¾še
(
i
,1,
”r
);

1719 
”rút
++;

1720 }ifĞ
İ
[
j
].
ty³
==
OPT_FLAG
 ){

1721 *((*)
İ
[
j
].
¬g
èğ
v
;

1722 }ifĞ
İ
[
j
].
ty³
==
OPT_FFLAG
 ){

1723 (*((*)())(
İ
[
j
].
¬g
))(
v
);

1724 }ifĞ
İ
[
j
].
ty³
==
OPT_FSTR
 ){

1725 (*((*)())(
İ
[
j
].
¬g
))(&
¬gv
[
i
][2]);

1727 ifĞ
”r
 ){

1728 
	`årštf
(
”r
,"%smissšg‡rgum’ˆÚ sw™ch.\n",
emsg
);

1729 
	`”¾še
(
i
,1,
”r
);

1731 
”rút
++;

1733  
”rút
;

1734 
	}
}

1739 
	$hªdËsw™ch
(
i
,
”r
)

1740 
i
;

1741 
FILE
 *
”r
;

1743 
lv
 = 0;

1744 
dv
 = 0.0;

1745 *
sv
 = 0, *
’d
;

1746 *
ı
;

1747 
j
;

1748 
”rút
 = 0;

1749 
ı
 = 
	`¡rchr
(
¬gv
[
i
],'=');

1750 
	`as£¹
Ğ
ı
!=0 );

1751 *
ı
 = 0;

1752 
j
=0; 
İ
[j].
Ïb–
; j++){

1753 ifĞ
	`¡rcmp
(
¬gv
[
i
],
İ
[
j
].
Ïb–
)==0 ) ;

1755 *
ı
 = '=';

1756 ifĞ
İ
[
j
].
Ïb–
==0 ){

1757 ifĞ
”r
 ){

1758 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1759 
	`”¾še
(
i
,0,
”r
);

1761 
”rút
++;

1763 
ı
++;

1764  
İ
[
j
].
ty³
 ){

1765 
OPT_FLAG
:

1766 
OPT_FFLAG
:

1767 ifĞ
”r
 ){

1768 
	`årštf
(
”r
,"%sİtiÚ„equœe ª‡rgum’t.\n",
emsg
);

1769 
	`”¾še
(
i
,0,
”r
);

1771 
”rút
++;

1773 
OPT_DBL
:

1774 
OPT_FDBL
:

1775 
dv
 = 
	`¡¹od
(
ı
,&
’d
);

1776 ifĞ*
’d
 ){

1777 ifĞ
”r
 ){

1778 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀæßtšg-pošˆ¬gum’t.\n",
emsg
);

1779 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1781 
”rút
++;

1784 
OPT_INT
:

1785 
OPT_FINT
:

1786 
lv
 = 
	`¡¹Ş
(
ı
,&
’d
,0);

1787 ifĞ*
’d
 ){

1788 ifĞ
”r
 ){

1789 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀš‹g”‡rgum’t.\n",
emsg
);

1790 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1792 
”rút
++;

1795 
OPT_STR
:

1796 
OPT_FSTR
:

1797 
sv
 = 
ı
;

1800  
İ
[
j
].
ty³
 ){

1801 
OPT_FLAG
:

1802 
OPT_FFLAG
:

1804 
OPT_DBL
:

1805 *(*)(
İ
[
j
].
¬g
èğ
dv
;

1807 
OPT_FDBL
:

1808 (*((*)())(
İ
[
j
].
¬g
))(
dv
);

1810 
OPT_INT
:

1811 *(*)(
İ
[
j
].
¬g
èğ
lv
;

1813 
OPT_FINT
:

1814 (*((*)())(
İ
[
j
].
¬g
))(()
lv
);

1816 
OPT_STR
:

1817 *(**)(
İ
[
j
].
¬g
èğ
sv
;

1819 
OPT_FSTR
:

1820 (*((*)())(
İ
[
j
].
¬g
))(
sv
);

1824  
”rút
;

1825 
	}
}

1827 
	$O±In™
(
a
,
o
,
”r
)

1828 **
a
;

1829 
s_İtiÚs
 *
o
;

1830 
FILE
 *
”r
;

1832 
”rút
 = 0;

1833 
¬gv
 = 
a
;

1834 
İ
 = 
o
;

1835 
”r¡»am
 = 
”r
;

1836 ifĞ
¬gv
 && *¬gv && 
İ
 ){

1837 
i
;

1838 
i
=1; 
¬gv
[i]; i++){

1839 ifĞ
¬gv
[
i
][0]=='+' ||‡rgv[i][0]=='-' ){

1840 
”rút
 +ğ
	`hªdËæags
(
i
,
”r
);

1841 }ifĞ
	`¡rchr
(
¬gv
[
i
],'=') ){

1842 
”rút
 +ğ
	`hªdËsw™ch
(
i
,
”r
);

1846 ifĞ
”rút
>0 ){

1847 
	`årštf
(
”r
,"V®id commªd†šİtiÚ fÜ \"%s\"‡»:\n",*
a
);

1848 
	`O±Pršt
();

1849 
	`ex™
(1);

1852 
	}
}

1854 
	$O±NArgs
(){

1855 
út
 = 0;

1856 
dashdash
 = 0;

1857 
i
;

1858 ifĞ
¬gv
!=0 &&‡rgv[0]!=0 ){

1859 
i
=1; 
¬gv
[i]; i++){

1860 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]èè
út
++;

1861 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1864  
út
;

1865 
	}
}

1867 *
	$O±Arg
(
n
)

1868 
n
;

1870 
i
;

1871 
i
 = 
	`¬gšdex
(
n
);

1872  
i
>=0 ? 
¬gv
[i] : 0;

1873 
	}
}

1875 
	$O±E¼
(
n
)

1876 
n
;

1878 
i
;

1879 
i
 = 
	`¬gšdex
(
n
);

1880 ifĞ
i
>=0 ) 
	`”¾še
(i,0,
”r¡»am
);

1881 
	}
}

1883 
	$O±Pršt
(){

1884 
i
;

1885 
max
, 
Ën
;

1886 
max
 = 0;

1887 
i
=0; 
İ
[i].
Ïb–
; i++){

1888 
Ën
 = 
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
) + 1;

1889  
İ
[
i
].
ty³
 ){

1890 
OPT_FLAG
:

1891 
OPT_FFLAG
:

1893 
OPT_INT
:

1894 
OPT_FINT
:

1895 
Ën
 += 9;

1897 
OPT_DBL
:

1898 
OPT_FDBL
:

1899 
Ën
 += 6;

1901 
OPT_STR
:

1902 
OPT_FSTR
:

1903 
Ën
 += 8;

1906 ifĞ
Ën
>
max
 ) max =†en;

1908 
i
=0; 
İ
[i].
Ïb–
; i++){

1909  
İ
[
i
].
ty³
 ){

1910 
OPT_FLAG
:

1911 
OPT_FFLAG
:

1912 
	`årštf
(
”r¡»am
," -%-*  %s\n",
max
,
İ
[
i
].
Ïb–
,İ[i].
mes§ge
);

1914 
OPT_INT
:

1915 
OPT_FINT
:

1916 
	`årštf
(
”r¡»am
," %s=<š‹g”>%*  %s\n",
İ
[
i
].
Ïb–
,

1917 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-9),"",İ[i].
mes§ge
);

1919 
OPT_DBL
:

1920 
OPT_FDBL
:

1921 
	`årštf
(
”r¡»am
," %s=<»®>%*  %s\n",
İ
[
i
].
Ïb–
,

1922 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-6),"",İ[i].
mes§ge
);

1924 
OPT_STR
:

1925 
OPT_FSTR
:

1926 
	`årštf
(
”r¡»am
," %s=<¡ršg>%*  %s\n",
İ
[
i
].
Ïb–
,

1927 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-8),"",İ[i].
mes§ge
);

1931 
	}
}

1938 
	sp¡©e
 {

1939 *
	mf’ame
;

1940 
	mtok’lš’o
;

1941 
	m”rÜút
;

1942 *
	mtok’¡¬t
;

1943 
ËmÚ
 *
	mgp
;

1944 
	ee_¡©e
 {

1945 
	mINITIALIZE
,

1946 
	mWAITING_FOR_DECL_OR_RULE
,

1947 
	mWAITING_FOR_DECL_KEYWORD
,

1948 
	mWAITING_FOR_DECL_ARG
,

1949 
	mWAITING_FOR_PRECEDENCE_SYMBOL
,

1950 
	mWAITING_FOR_ARROW
,

1951 
	mIN_RHS
,

1952 
	mLHS_ALIAS_1
,

1953 
	mLHS_ALIAS_2
,

1954 
	mLHS_ALIAS_3
,

1955 
	mRHS_ALIAS_1
,

1956 
	mRHS_ALIAS_2
,

1957 
	mPRECEDENCE_MARK_1
,

1958 
	mPRECEDENCE_MARK_2
,

1959 
	mRESYNC_AFTER_RULE_ERROR
,

1960 
	mRESYNC_AFTER_DECL_ERROR
,

1961 
	mWAITING_FOR_DESTRUCTOR_SYMBOL
,

1962 
	mWAITING_FOR_DATATYPE_SYMBOL
,

1963 
	mWAITING_FOR_FALLBACK_ID
,

1964 
	mWAITING_FOR_WILDCARD_ID


1965 } 
	m¡©e
;

1966 
symbŞ
 *
	mçÎback
;

1967 
symbŞ
 *
	mlhs
;

1968 *
	mlh§lŸs
;

1969 
	mÄhs
;

1970 
symbŞ
 *
	mrhs
[
MAXRHS
];

1971 *
	m®Ÿs
[
MAXRHS
];

1972 
ruË
 *
	m´evruË
;

1973 *
	mdeşkeywÜd
;

1974 **
	mdeş¬g¦Ù
;

1975 
	mš£¹LšeMaüo
;

1976 *
	mdeşlš’o¦Ù
;

1977 
e_assoc
 
	mdeşassoc
;

1978 
	m´eccouÁ”
;

1979 
ruË
 *
	mfœ¡ruË
;

1980 
ruË
 *
	mÏ¡ruË
;

1984 
	$·r£Ú‘ok’
(
p¥
)

1985 
p¡©e
 *
p¥
;

1987 *
x
;

1988 
x
 = 
	`SŒ§ã
(
p¥
->
tok’¡¬t
);

1990 
	`´štf
("%s:%d: Tok’=[%s] s‹=%d\n",
p¥
->
f’ame
,p¥->
tok’lš’o
,

1991 
x
,
p¥
->
¡©e
);

1993  
p¥
->
¡©e
 ){

1994 
INITIALIZE
:

1995 
p¥
->
´evruË
 = 0;

1996 
p¥
->
´eccouÁ”
 = 0;

1997 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 0;

1998 
p¥
->
gp
->
ÄuË
 = 0;

2000 
WAITING_FOR_DECL_OR_RULE
:

2001 ifĞ
x
[0]=='%' ){

2002 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2003 }ifĞ
	`i¦ow”
(
x
[0]) ){

2004 
p¥
->
lhs
 = 
	`SymbŞ_Ãw
(
x
);

2005 
p¥
->
Ähs
 = 0;

2006 
p¥
->
lh§lŸs
 = 0;

2007 
p¥
->
¡©e
 = 
WAITING_FOR_ARROW
;

2008 }ifĞ
x
[0]=='{' ){

2009 ifĞ
p¥
->
´evruË
==0 ){

2010 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2013 
p¥
->
”rÜút
++;

2014 }ifĞ
p¥
->
´evruË
->
code
!=0 ){

2015 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2018 
p¥
->
”rÜút
++;

2020 
p¥
->
´evruË
->
lše
 =…¥->
tok’lš’o
;

2021 
p¥
->
´evruË
->
code
 = &
x
[1];

2023 }ifĞ
x
[0]=='[' ){

2024 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_1
;

2026 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2028 
x
);

2029 
p¥
->
”rÜút
++;

2032 
PRECEDENCE_MARK_1
:

2033 ifĞ!
	`isuµ”
(
x
[0]) ){

2034 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2036 
p¥
->
”rÜút
++;

2037 }ifĞ
p¥
->
´evruË
==0 ){

2038 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2039 "Th”i nØ´iÜ„uËØassigÀ´eûd’û \"[%s]\".",
x
);

2040 
p¥
->
”rÜút
++;

2041 }ifĞ
p¥
->
´evruË
->
´ecsym
!=0 ){

2042 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2045 
p¥
->
”rÜút
++;

2047 
p¥
->
´evruË
->
´ecsym
 = 
	`SymbŞ_Ãw
(
x
);

2049 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_2
;

2051 
PRECEDENCE_MARK_2
:

2052 ifĞ
x
[0]!=']' ){

2053 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2055 
p¥
->
”rÜút
++;

2057 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2059 
WAITING_FOR_ARROW
:

2060 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2061 
p¥
->
¡©e
 = 
IN_RHS
;

2062 }ifĞ
x
[0]=='(' ){

2063 
p¥
->
¡©e
 = 
LHS_ALIAS_1
;

2065 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2067 
p¥
->
lhs
->
Çme
);

2068 
p¥
->
”rÜút
++;

2069 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2072 
LHS_ALIAS_1
:

2073 ifĞ
	`i§Íha
(
x
[0]) ){

2074 
p¥
->
lh§lŸs
 = 
x
;

2075 
p¥
->
¡©e
 = 
LHS_ALIAS_2
;

2077 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2079 
x
,
p¥
->
lhs
->
Çme
);

2080 
p¥
->
”rÜút
++;

2081 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2084 
LHS_ALIAS_2
:

2085 ifĞ
x
[0]==')' ){

2086 
p¥
->
¡©e
 = 
LHS_ALIAS_3
;

2088 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2089 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2090 
p¥
->
”rÜút
++;

2091 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2094 
LHS_ALIAS_3
:

2095 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2096 
p¥
->
¡©e
 = 
IN_RHS
;

2098 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2100 
p¥
->
lhs
->
Çme
,p¥->
lh§lŸs
);

2101 
p¥
->
”rÜút
++;

2102 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2105 
IN_RHS
:

2106 ifĞ
x
[0]=='.' ){

2107 
ruË
 *
½
;

2108 
½
 = (
ruË
 *)
	`ÿÎoc
( (rule) +

2109 (
symbŞ
*)*
p¥
->
Ähs
 + (*)*psp->nrhs, 1);

2110 ifĞ
½
==0 ){

2111 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2113 
p¥
->
”rÜút
++;

2114 
p¥
->
´evruË
 = 0;

2116 
i
;

2117 
½
->
ruËlše
 = 
p¥
->
tok’lš’o
;

2118 
½
->
rhs
 = (
symbŞ
**)&rp[1];

2119 
½
->
rh§lŸs
 = (**)&Ôp->
rhs
[
p¥
->
Ähs
]);

2120 
i
=0; i<
p¥
->
Ähs
; i++){

2121 
½
->
rhs
[
i
] = 
p¥
->rhs[i];

2122 
½
->
rh§lŸs
[
i
] = 
p¥
->
®Ÿs
[i];

2124 
½
->
lhs
 = 
p¥
->lhs;

2125 
½
->
lh§lŸs
 = 
p¥
->lhsalias;

2126 
½
->
Ähs
 = 
p¥
->nrhs;

2127 
½
->
code
 = 0;

2128 
½
->
´ecsym
 = 0;

2129 
½
->
šdex
 = 
p¥
->
gp
->
ÄuË
++;

2130 
½
->
Ãxhs
 =„p->
lhs
->
ruË
;

2131 
½
->
lhs
->
ruË
 =„p;

2132 
½
->
Ãxt
 = 0;

2133 ifĞ
p¥
->
fœ¡ruË
==0 ){

2134 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 
½
;

2136 
p¥
->
Ï¡ruË
->
Ãxt
 = 
½
;

2137 
p¥
->
Ï¡ruË
 = 
½
;

2139 
p¥
->
´evruË
 = 
½
;

2141 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2142 }ifĞ
	`i§Íha
(
x
[0]) ){

2143 ifĞ
p¥
->
Ähs
>=
MAXRHS
 ){

2144 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2146 
x
);

2147 
p¥
->
”rÜút
++;

2148 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2150 
p¥
->
rhs
[p¥->
Ähs
] = 
	`SymbŞ_Ãw
(
x
);

2151 
p¥
->
®Ÿs
[p¥->
Ähs
] = 0;

2152 
p¥
->
Ähs
++;

2154 }ifĞ(
x
[0]=='|' || x[0]=='/'è&& 
p¥
->
Ähs
>0 ){

2155 
symbŞ
 *
m¥
 = 
p¥
->
rhs
[p¥->
Ähs
-1];

2156 ifĞ
m¥
->
ty³
!=
MULTITERMINAL
 ){

2157 
symbŞ
 *
Üig¥
 = 
m¥
;

2158 
m¥
 = 
	`ÿÎoc
(1,(*msp));

2159 
	`mem£t
(
m¥
, 0, (*msp));

2160 
m¥
->
ty³
 = 
MULTITERMINAL
;

2161 
m¥
->
nsubsym
 = 1;

2162 
m¥
->
subsym
 = 
	`ÿÎoc
(1,(
symbŞ
*));

2163 
m¥
->
subsym
[0] = 
Üig¥
;

2164 
m¥
->
Çme
 = 
Üig¥
->name;

2165 
p¥
->
rhs
[p¥->
Ähs
-1] = 
m¥
;

2167 
m¥
->
nsubsym
++;

2168 
m¥
->
subsym
 = 
	`»®loc
(m¥->subsym, (
symbŞ
*)*m¥->
nsubsym
);

2169 
m¥
->
subsym
[m¥->
nsubsym
-1] = 
	`SymbŞ_Ãw
(&
x
[1]);

2170 ifĞ
	`i¦ow”
(
x
[1]è|| i¦ow”(
m¥
->
subsym
[0]->
Çme
[0]) ){

2171 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2173 
p¥
->
”rÜút
++;

2175 }ifĞ
x
[0]=='(' && 
p¥
->
Ähs
>0 ){

2176 
p¥
->
¡©e
 = 
RHS_ALIAS_1
;

2178 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2179 "IÎeg® ch¬aù” oÀRHS oàruË: \"%s\".",
x
);

2180 
p¥
->
”rÜút
++;

2181 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2184 
RHS_ALIAS_1
:

2185 ifĞ
	`i§Íha
(
x
[0]) ){

2186 
p¥
->
®Ÿs
[p¥->
Ähs
-1] = 
x
;

2187 
p¥
->
¡©e
 = 
RHS_ALIAS_2
;

2189 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2191 
x
,
p¥
->
rhs
[p¥->
Ähs
-1]->
Çme
);

2192 
p¥
->
”rÜút
++;

2193 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2196 
RHS_ALIAS_2
:

2197 ifĞ
x
[0]==')' ){

2198 
p¥
->
¡©e
 = 
IN_RHS
;

2200 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2201 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2202 
p¥
->
”rÜút
++;

2203 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2206 
WAITING_FOR_DECL_KEYWORD
:

2207 ifĞ
	`i§Íha
(
x
[0]) ){

2208 
p¥
->
deşkeywÜd
 = 
x
;

2209 
p¥
->
deş¬g¦Ù
 = 0;

2210 
p¥
->
deşlš’o¦Ù
 = 0;

2211 
p¥
->
š£¹LšeMaüo
 = 1;

2212 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2213 ifĞ
	`¡rcmp
(
x
,"name")==0 ){

2214 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
Çme
);

2215 
p¥
->
š£¹LšeMaüo
 = 0;

2216 }ifĞ
	`¡rcmp
(
x
,"include")==0 ){

2217 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
šşude
);

2218 }ifĞ
	`¡rcmp
(
x
,"code")==0 ){

2219 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
exŒacode
);

2220 }ifĞ
	`¡rcmp
(
x
,"token_destructor")==0 ){

2221 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’de¡
;

2222 }ifĞ
	`¡rcmp
(
x
,"default_destructor")==0 ){

2223 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
v¬de¡
;

2224 }ifĞ
	`¡rcmp
(
x
,"token_prefix")==0 ){

2225 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’´efix
;

2226 
p¥
->
š£¹LšeMaüo
 = 0;

2227 }ifĞ
	`¡rcmp
(
x
,"syntax_error")==0 ){

2228 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
”rÜ
);

2229 }ifĞ
	`¡rcmp
(
x
,"parse_accept")==0 ){

2230 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
acû±
);

2231 }ifĞ
	`¡rcmp
(
x
,"parse_failure")==0 ){

2232 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
çu»
);

2233 }ifĞ
	`¡rcmp
(
x
,"stack_overflow")==0 ){

2234 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
ov”æow
);

2235 }ifĞ
	`¡rcmp
(
x
,"extra_argument")==0 ){

2236 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¬g
);

2237 
p¥
->
š£¹LšeMaüo
 = 0;

2238 }ifĞ
	`¡rcmp
(
x
,"token_type")==0 ){

2239 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
tok’ty³
);

2240 
p¥
->
š£¹LšeMaüo
 = 0;

2241 }ifĞ
	`¡rcmp
(
x
,"default_type")==0 ){

2242 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
v¬ty³
);

2243 
p¥
->
š£¹LšeMaüo
 = 0;

2244 }ifĞ
	`¡rcmp
(
x
,"stack_size")==0 ){

2245 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡acksize
);

2246 
p¥
->
š£¹LšeMaüo
 = 0;

2247 }ifĞ
	`¡rcmp
(
x
,"start_symbol")==0 ){

2248 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡¬t
);

2249 
p¥
->
š£¹LšeMaüo
 = 0;

2250 }ifĞ
	`¡rcmp
(
x
,"left")==0 ){

2251 
p¥
->
´eccouÁ”
++;

2252 
p¥
->
deşassoc
 = 
LEFT
;

2253 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2254 }ifĞ
	`¡rcmp
(
x
,"right")==0 ){

2255 
p¥
->
´eccouÁ”
++;

2256 
p¥
->
deşassoc
 = 
RIGHT
;

2257 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2258 }ifĞ
	`¡rcmp
(
x
,"nonassoc")==0 ){

2259 
p¥
->
´eccouÁ”
++;

2260 
p¥
->
deşassoc
 = 
NONE
;

2261 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2262 }ifĞ
	`¡rcmp
(
x
,"destructor")==0 ){

2263 
p¥
->
¡©e
 = 
WAITING_FOR_DESTRUCTOR_SYMBOL
;

2264 }ifĞ
	`¡rcmp
(
x
,"type")==0 ){

2265 
p¥
->
¡©e
 = 
WAITING_FOR_DATATYPE_SYMBOL
;

2266 }ifĞ
	`¡rcmp
(
x
,"fallback")==0 ){

2267 
p¥
->
çÎback
 = 0;

2268 
p¥
->
¡©e
 = 
WAITING_FOR_FALLBACK_ID
;

2269 }ifĞ
	`¡rcmp
(
x
,"wildcard")==0 ){

2270 
p¥
->
¡©e
 = 
WAITING_FOR_WILDCARD_ID
;

2272 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2273 "UnknowÀdeş¬©iÚ keywÜd: \"%%%s\".",
x
);

2274 
p¥
->
”rÜút
++;

2275 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2278 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2279 "IÎeg® deş¬©iÚ keywÜd: \"%s\".",
x
);

2280 
p¥
->
”rÜút
++;

2281 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2284 
WAITING_FOR_DESTRUCTOR_SYMBOL
:

2285 ifĞ!
	`i§Íha
(
x
[0]) ){

2286 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2288 
p¥
->
”rÜút
++;

2289 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2291 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2292 
p¥
->
deş¬g¦Ù
 = &
¥
->
de¡ruùÜ
;

2293 
p¥
->
deşlš’o¦Ù
 = &
¥
->
de¡Lš’o
;

2294 
p¥
->
š£¹LšeMaüo
 = 1;

2295 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2298 
WAITING_FOR_DATATYPE_SYMBOL
:

2299 ifĞ!
	`i§Íha
(
x
[0]) ){

2300 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2302 
p¥
->
”rÜút
++;

2303 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2305 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2306 
p¥
->
deş¬g¦Ù
 = &
¥
->
d©©y³
;

2307 
p¥
->
š£¹LšeMaüo
 = 0;

2308 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2311 
WAITING_FOR_PRECEDENCE_SYMBOL
:

2312 ifĞ
x
[0]=='.' ){

2313 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2314 }ifĞ
	`isuµ”
(
x
[0]) ){

2315 
symbŞ
 *
¥
;

2316 
¥
 = 
	`SymbŞ_Ãw
(
x
);

2317 ifĞ
¥
->
´ec
>=0 ){

2318 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2319 "SymbŞ \"%s\" ha ®»ady bgiv’‡…»ûd’û.",
x
);

2320 
p¥
->
”rÜút
++;

2322 
¥
->
´ec
 = 
p¥
->
´eccouÁ”
;

2323 
¥
->
assoc
 = 
p¥
->
deşassoc
;

2326 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2327 "Cª'ˆassigÀ¨´eûd’ûØ\"%s\".",
x
);

2328 
p¥
->
”rÜút
++;

2331 
WAITING_FOR_DECL_ARG
:

2332 ifĞ
x
[0]=='{' || x[0]=='\"' || 
	`i§Êum
(x[0]) ){

2333 *
zOld
, *
zNew
, *
zBuf
, *
z
;

2334 
nOld
, 
n
, 
nLše
, 
nNew
, 
nBack
;

2335 
addLšeMaüo
;

2336 
zLše
[50];

2337 
zNew
 = 
x
;

2338 ifĞ
zNew
[0]=='"' || zNew[0]=='{' ) zNew++;

2339 
nNew
 = 
	`ËmÚSŒËn
(
zNew
);

2340 ifĞ*
p¥
->
deş¬g¦Ù
 ){

2341 
zOld
 = *
p¥
->
deş¬g¦Ù
;

2343 
zOld
 = "";

2345 
nOld
 = 
	`ËmÚSŒËn
(
zOld
);

2346 
n
 = 
nOld
 + 
nNew
 + 20;

2347 
addLšeMaüo
 = !
p¥
->
gp
->
nŞš’osæag
 &&…¥->
š£¹LšeMaüo
 &&

2348 (
p¥
->
deşlš’o¦Ù
==0 ||…sp->decllinenoslot[0]!=0);

2349 ifĞ
addLšeMaüo
 ){

2350 
z
=
p¥
->
f’ame
, 
nBack
=0; *z; z++){

2351 ifĞ*
z
=='\\' ) 
nBack
++;

2353 
	`¥rštf
(
zLše
, "#lš%d ", 
p¥
->
tok’lš’o
);

2354 
nLše
 = 
	`ËmÚSŒËn
(
zLše
);

2355 
n
 +ğ
nLše
 + 
	`ËmÚSŒËn
(
p¥
->
f’ame
è+ 
nBack
;

2357 *
p¥
->
deş¬g¦Ù
 = 
zBuf
 = 
	`»®loc
(*p¥->deş¬g¦Ù, 
n
);

2358 
zBuf
 +ğ
nOld
;

2359 ifĞ
addLšeMaüo
 ){

2360 ifĞ
nOld
 && 
zBuf
[-1]!='\n' ){

2361 *(
zBuf
++) = '\n';

2363 
	`memıy
(
zBuf
, 
zLše
, 
nLše
);

2364 
zBuf
 +ğ
nLše
;

2365 *(
zBuf
++) = '"';

2366 
z
=
p¥
->
f’ame
; *z; z++){

2367 ifĞ*
z
=='\\' ){

2368 *(
zBuf
++) = '\\';

2370 *(
zBuf
++èğ*
z
;

2372 *(
zBuf
++) = '"';

2373 *(
zBuf
++) = '\n';

2375 ifĞ
p¥
->
deşlš’o¦Ù
 &&…sp->decllinenoslot[0]==0 ){

2376 
p¥
->
deşlš’o¦Ù
[0] =…¥->
tok’lš’o
;

2378 
	`memıy
(
zBuf
, 
zNew
, 
nNew
);

2379 
zBuf
 +ğ
nNew
;

2380 *
zBuf
 = 0;

2381 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2383 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2384 "IÎeg®‡rgum’ˆtØ%%%s: %s",
p¥
->
deşkeywÜd
,
x
);

2385 
p¥
->
”rÜút
++;

2386 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2389 
WAITING_FOR_FALLBACK_ID
:

2390 ifĞ
x
[0]=='.' ){

2391 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2392 }ifĞ!
	`isuµ”
(
x
[0]) ){

2393 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2394 "%%çÎback‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2395 
p¥
->
”rÜút
++;

2397 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2398 ifĞ
p¥
->
çÎback
==0 ){

2399 
p¥
->
çÎback
 = 
¥
;

2400 }ifĞ
¥
->
çÎback
 ){

2401 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2402 "MÜthª oÃ f®lback‡ssigÃdØtok’ %s", 
x
);

2403 
p¥
->
”rÜút
++;

2405 
¥
->
çÎback
 = 
p¥
->fallback;

2406 
p¥
->
gp
->
has_çÎback
 = 1;

2410 
WAITING_FOR_WILDCARD_ID
:

2411 ifĞ
x
[0]=='.' ){

2412 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2413 }ifĞ!
	`isuµ”
(
x
[0]) ){

2414 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2415 "%%wdÿrd‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2416 
p¥
->
”rÜút
++;

2418 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2419 ifĞ
p¥
->
gp
->
wdÿrd
==0 ){

2420 
p¥
->
gp
->
wdÿrd
 = 
¥
;

2422 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2423 "ExŒ¨wdÿrdØtok’: %s", 
x
);

2424 
p¥
->
”rÜút
++;

2428 
RESYNC_AFTER_RULE_ERROR
:

2431 
RESYNC_AFTER_DECL_ERROR
:

2432 ifĞ
x
[0]=='.' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2433 ifĞ
x
[0]=='%' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2436 
	}
}

2443 
	$´•roûss_šput
(*
z
){

2444 
i
, 
j
, 
k
, 
n
;

2445 
exşude
 = 0;

2446 
¡¬t
 = 0;

2447 
lš’o
 = 1;

2448 
¡¬t_lš’o
 = 1;

2449 
i
=0; 
z
[i]; i++){

2450 ifĞ
z
[
i
]=='\n' ) 
lš’o
++;

2451 ifĞ
z
[
i
]!='%' || (i>0 && z[i-1]!='\n') ) ;

2452 ifĞ
	`¡ºcmp
(&
z
[
i
],"%’dif",6)==0 && 
	`is¥aû
(z[i+6]) ){

2453 ifĞ
exşude
 ){

2454 
exşude
--;

2455 ifĞ
exşude
==0 ){

2456 
j
=
¡¬t
; j<
i
; j++èifĞ
z
[j]!='\n' ) z[j] = ' ';

2459 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2460 }ifĞ(
	`¡ºcmp
(&
z
[
i
],"%ifdef",6)==0 && 
	`is¥aû
(z[i+6]))

2461 || (
	`¡ºcmp
(&
z
[
i
],"%iâdef",7)==0 && 
	`is¥aû
(z[i+7])) ){

2462 ifĞ
exşude
 ){

2463 
exşude
++;

2465 
j
=
i
+7; 
	`is¥aû
(
z
[j]); j++){}

2466 
n
=0; 
z
[
j
+n] && !
	`is¥aû
(z[j+n]);‚++){}

2467 
exşude
 = 1;

2468 
k
=0; k<
nDefše
; k++){

2469 ifĞ
	`¡ºcmp
(
azDefše
[
k
],&
z
[
j
],
n
)==0 && 
	`ËmÚSŒËn
(azDefine[k])==n ){

2470 
exşude
 = 0;

2474 ifĞ
z
[
i
+3]=='n' ) 
exşude
 = !exclude;

2475 ifĞ
exşude
 ){

2476 
¡¬t
 = 
i
;

2477 
¡¬t_lš’o
 = 
lš’o
;

2480 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2483 ifĞ
exşude
 ){

2484 
	`årštf
(
¡d”r
,"uÁ”mš©ed %%ifdeà¡¬tšg oÀlš%d\n", 
¡¬t_lš’o
);

2485 
	`ex™
(1);

2487 
	}
}

2494 
	$P¬£
(
gp
)

2495 
ËmÚ
 *
gp
;

2497 
p¡©e
 
ps
;

2498 
FILE
 *
å
;

2499 *
febuf
;

2500 
fesize
;

2501 
lš’o
;

2502 
c
;

2503 *
ı
, *
Ãxtı
;

2504 
¡¬še
 = 0;

2506 
	`mem£t
(&
ps
, '\0', (ps));

2507 
ps
.
gp
 = gp;

2508 
ps
.
f’ame
 = 
gp
->filename;

2509 
ps
.
”rÜút
 = 0;

2510 
ps
.
¡©e
 = 
INITIALIZE
;

2513 
å
 = 
	`fİ’
(
ps
.
f’ame
,"rb");

2514 ifĞ
å
==0 ){

2515 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't openhis file for„eading.");

2516 
gp
->
”rÜút
++;

2519 
	`f£ek
(
å
,0,2);

2520 
fesize
 = 
	`á–l
(
å
);

2521 
	`»wšd
(
å
);

2522 
febuf
 = (*)
	`m®loc
Ğ
fesize
+1 );

2523 ifĞ
febuf
==0 ){

2524 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't‡llocate %d of memoryo holdhis file.",

2525 
fesize
+1);

2526 
gp
->
”rÜút
++;

2529 ifĞ
	`ä—d
(
febuf
,1,
fesize
,
å
)!=filesize ){

2530 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't„ead in‡ll %d bytes ofhis file.",

2531 
fesize
);

2532 
	`ä“
(
febuf
);

2533 
gp
->
”rÜút
++;

2536 
	`fşo£
(
å
);

2537 
febuf
[
fesize
] = 0;

2540 
	`´•roûss_šput
(
febuf
);

2543 
lš’o
 = 1;

2544 
ı
=
febuf
; (
c
= *cp)!=0; ){

2545 ifĞ
c
=='\n' ) 
lš’o
++;

2546 ifĞ
	`is¥aû
(
c
è){ 
ı
++; ; }

2547 ifĞ
c
=='/' && 
ı
[1]=='/' ){

2548 
ı
+=2;

2549  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2552 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2553 
ı
+=2;

2554  (
c
ğ*
ı
)!=0 && (c!='/' || cp[-1]!='*') ){

2555 ifĞ
c
=='\n' ) 
lš’o
++;

2556 
ı
++;

2558 ifĞ
c
 ) 
ı
++;

2561 
ps
.
tok’¡¬t
 = 
ı
;

2562 
ps
.
tok’lš’o
 = 
lš’o
;

2563 ifĞ
c
=='\"' ){

2564 
ı
++;

2565  (
c
ğ*
ı
)!=0 && c!='\"' ){

2566 ifĞ
c
=='\n' ) 
lš’o
++;

2567 
ı
++;

2569 ifĞ
c
==0 ){

2570 
	`E¼ÜMsg
(
ps
.
f’ame
,
¡¬še
,

2572 
ps
.
”rÜút
++;

2573 
Ãxtı
 = 
ı
;

2575 
Ãxtı
 = 
ı
+1;

2577 }ifĞ
c
=='{' ){

2578 
Ëv–
;

2579 
ı
++;

2580 
Ëv–
=1; (
c
ğ*
ı
)!=0 && (level>1 || c!='}'); cp++){

2581 ifĞ
c
=='\n' ) 
lš’o
++;

2582 ifĞ
c
=='{' ) 
Ëv–
++;

2583 ifĞ
c
=='}' ) 
Ëv–
--;

2584 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2585 
´evc
;

2586 
ı
 = &cp[2];

2587 
´evc
 = 0;

2588  (
c
ğ*
ı
)!=0 && (c!='/' || 
´evc
!='*') ){

2589 ifĞ
c
=='\n' ) 
lš’o
++;

2590 
´evc
 = 
c
;

2591 
ı
++;

2593 }ifĞ
c
=='/' && 
ı
[1]=='/' ){

2594 
ı
 = &cp[2];

2595  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2596 ifĞ
c
 ) 
lš’o
++;

2597 }ifĞ
c
=='\'' || c=='\"' ){

2598 
¡¬tch¬
, 
´evc
;

2599 
¡¬tch¬
 = 
c
;

2600 
´evc
 = 0;

2601 
ı
++; (
c
ğ*ı)!=0 && (c!=
¡¬tch¬
 || 
´evc
=='\\'); cp++){

2602 ifĞ
c
=='\n' ) 
lš’o
++;

2603 ifĞ
´evc
=='\\' )…revc = 0;

2604 
´evc
 = 
c
;

2608 ifĞ
c
==0 ){

2609 
	`E¼ÜMsg
(
ps
.
f’ame
,ps.
tok’lš’o
,

2611 
ps
.
”rÜút
++;

2612 
Ãxtı
 = 
ı
;

2614 
Ãxtı
 = 
ı
+1;

2616 }ifĞ
	`i§Êum
(
c
) ){

2617  (
c
ğ*
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2618 
Ãxtı
 = 
ı
;

2619 }ifĞ
c
==':' && 
ı
[1]==':' && cp[2]=='=' ){

2620 
ı
 += 3;

2621 
Ãxtı
 = 
ı
;

2622 }ifĞ(
c
=='/' || c=='|'è&& 
	`i§Íha
(
ı
[1]) ){

2623 
ı
 += 2;

2624  (
c
 = *
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2625 
Ãxtı
 = 
ı
;

2627 
ı
++;

2628 
Ãxtı
 = 
ı
;

2630 
c
 = *
ı
;

2631 *
ı
 = 0;

2632 
	`·r£Ú‘ok’
(&
ps
);

2633 *
ı
 = 
c
;

2634 
ı
 = 
Ãxtı
;

2636 
	`ä“
(
febuf
);

2637 
gp
->
ruË
 = 
ps
.
fœ¡ruË
;

2638 
gp
->
”rÜút
 = 
ps
.errorcnt;

2639 
	}
}

2645 
¶šk
 *
	g¶šk_ä“li¡
 = 0;

2648 
¶šk
 *
	$Plšk_Ãw
(){

2649 
¶šk
 *
Ãw
;

2651 ifĞ
¶šk_ä“li¡
==0 ){

2652 
i
;

2653 
amt
 = 100;

2654 
¶šk_ä“li¡
 = (
¶šk
 *)
	`ÿÎoc
Ğ
amt
, (plink) );

2655 ifĞ
¶šk_ä“li¡
==0 ){

2656 
	`årštf
(
¡d”r
,

2658 
	`ex™
(1);

2660 
i
=0; i<
amt
-1; i++è
¶šk_ä“li¡
[i].
Ãxt
 = &plink_freelist[i+1];

2661 
¶šk_ä“li¡
[
amt
-1].
Ãxt
 = 0;

2663 
Ãw
 = 
¶šk_ä“li¡
;

2664 
¶šk_ä“li¡
 =…lšk_ä“li¡->
Ãxt
;

2665  
Ãw
;

2666 
	}
}

2669 
	$Plšk_add
(
¶µ
,
cå
)

2670 
¶šk
 **
¶µ
;

2671 
cÚfig
 *
cå
;

2673 
¶šk
 *
Ãw
;

2674 
Ãw
 = 
	`Plšk_Ãw
();

2675 
Ãw
->
Ãxt
 = *
¶µ
;

2676 *
¶µ
 = 
Ãw
;

2677 
Ãw
->
cå
 = cfp;

2678 
	}
}

2681 
	$Plšk_cİy
(
to
,
äom
)

2682 
¶šk
 **
to
;

2683 
¶šk
 *
äom
;

2685 
¶šk
 *
Ãxl
;

2686  
äom
 ){

2687 
Ãxl
 = 
äom
->
Ãxt
;

2688 
äom
->
Ãxt
 = *
to
;

2689 *
to
 = 
äom
;

2690 
äom
 = 
Ãxl
;

2692 
	}
}

2695 
	$Plšk_d–‘e
(
¶p
)

2696 
¶šk
 *
¶p
;

2698 
¶šk
 *
Ãxl
;

2700  
¶p
 ){

2701 
Ãxl
 = 
¶p
->
Ãxt
;

2702 
¶p
->
Ãxt
 = 
¶šk_ä“li¡
;

2703 
¶šk_ä“li¡
 = 
¶p
;

2704 
¶p
 = 
Ãxl
;

2706 
	}
}

2716 
PRIVATE
 *
	$fe_mak’ame
(
Ëmp
,
suffix
)

2717 
ËmÚ
 *
Ëmp
;

2718 *
suffix
;

2720 *
Çme
;

2721 *
ı
;

2723 
Çme
 = 
	`m®loc
Ğ
	`ËmÚSŒËn
(
Ëmp
->
f’ame
è+†emÚSŒËn(
suffix
) + 5 );

2724 ifĞ
Çme
==0 ){

2725 
	`årštf
(
¡d”r
,"Can't‡llocate space for‡ filename.\n");

2726 
	`ex™
(1);

2728 
	`¡rıy
(
Çme
,
Ëmp
->
f’ame
);

2729 
ı
 = 
	`¡¼chr
(
Çme
,'.');

2730 ifĞ
ı
 ) *cp = 0;

2731 
	`¡rÿt
(
Çme
,
suffix
);

2732  
Çme
;

2733 
	}
}

2738 
PRIVATE
 
FILE
 *
	$fe_İ’
(
Ëmp
,
suffix
,
mode
)

2739 
ËmÚ
 *
Ëmp
;

2740 *
suffix
;

2741 *
mode
;

2743 
FILE
 *
å
;

2745 ifĞ
Ëmp
->
ouŠame
 ) 
	`ä“
(lemp->outname);

2746 
Ëmp
->
ouŠame
 = 
	`fe_mak’ame
Öemp, 
suffix
);

2747 
å
 = 
	`fİ’
(
Ëmp
->
ouŠame
,
mode
);

2748 ifĞ
å
==0 && *
mode
=='w' ){

2749 
	`årštf
(
¡d”r
,"Cª'ˆİ’ f\"%s\".\n",
Ëmp
->
ouŠame
);

2750 
Ëmp
->
”rÜút
++;

2753  
å
;

2754 
	}
}

2758 
	$R•ršt
(
Ëmp
)

2759 
ËmÚ
 *
Ëmp
;

2761 
ruË
 *
½
;

2762 
symbŞ
 *
¥
;

2763 
i
, 
j
, 
maxËn
, 
Ën
, 
ncŞumns
, 
sk
;

2764 
	`´štf
("// R•ršˆoàšpuˆf\"%s\".\n// SymbŞs:\n",
Ëmp
->
f’ame
);

2765 
maxËn
 = 10;

2766 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2767 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2768 
Ën
 = 
	`ËmÚSŒËn
(
¥
->
Çme
);

2769 ifĞ
Ën
>
maxËn
 ) maxlen =†en;

2771 
ncŞumns
 = 76/(
maxËn
+5);

2772 ifĞ
ncŞumns
<1 )‚columns = 1;

2773 
sk
 = (
Ëmp
->
nsymbŞ
 + 
ncŞumns
 - 1)/ncolumns;

2774 
i
=0; i<
sk
; i++){

2775 
	`´štf
("//");

2776 
j
=
i
; j<
Ëmp
->
nsymbŞ
; j+=
sk
){

2777 
¥
 = 
Ëmp
->
symbŞs
[
j
];

2778 
	`as£¹
Ğ
¥
->
šdex
==
j
 );

2779 
	`´štf
(" %3d %-*.*s",
j
,
maxËn
,maxËn,
¥
->
Çme
);

2781 
	`´štf
("\n");

2783 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

2784 
	`´štf
("%s",
½
->
lhs
->
Çme
);

2786 
	`´štf
(" ::=");

2787 
i
=0; i<
½
->
Ähs
; i++){

2788 
¥
 = 
½
->
rhs
[
i
];

2789 
	`´štf
(" %s", 
¥
->
Çme
);

2790 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

2791 
j
=1; j<
¥
->
nsubsym
; j++){

2792 
	`´štf
("|%s", 
¥
->
subsym
[
j
]->
Çme
);

2797 
	`´štf
(".");

2798 ifĞ
½
->
´ecsym
 ) 
	`´štf
(" [%s]",½->´ecsym->
Çme
);

2800 
	`´štf
("\n");

2802 
	}
}

2804 
	$CÚfigPršt
(
å
,
cå
)

2805 
FILE
 *
å
;

2806 
cÚfig
 *
cå
;

2808 
ruË
 *
½
;

2809 
symbŞ
 *
¥
;

2810 
i
, 
j
;

2811 
½
 = 
cå
->rp;

2812 
	`årštf
(
å
,"% ::=",
½
->
lhs
->
Çme
);

2813 
i
=0; i<=
½
->
Ähs
; i++){

2814 ifĞ
i
==
cå
->
dÙ
 ) 
	`årštf
(
å
," *");

2815 ifĞ
i
==
½
->
Ähs
 ) ;

2816 
¥
 = 
½
->
rhs
[
i
];

2817 
	`årštf
(
å
," %s", 
¥
->
Çme
);

2818 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

2819 
j
=1; j<
¥
->
nsubsym
; j++){

2820 
	`årštf
(
å
,"|%s",
¥
->
subsym
[
j
]->
Çme
);

2824 
	}
}

2829 
PRIVATE
 
	$S‘Pršt
(
out
,
£t
,
Ëmp
)

2830 
FILE
 *
out
;

2831 *
£t
;

2832 
ËmÚ
 *
Ëmp
;

2834 
i
;

2835 *
¥aûr
;

2836 
¥aûr
 = "";

2837 
	`årštf
(
out
,"%12s[","");

2838 
i
=0; i<
Ëmp
->
Á”mš®
; i++){

2839 ifĞ
	`S‘Fšd
(
£t
,
i
) ){

2840 
	`årštf
(
out
,"%s%s",
¥aûr
,
Ëmp
->
symbŞs
[
i
]->
Çme
);

2841 
¥aûr
 = " ";

2844 
	`årštf
(
out
,"]\n");

2845 
	}
}

2848 
PRIVATE
 
	$PlškPršt
(
out
,
¶p
,
g
)

2849 
FILE
 *
out
;

2850 
¶šk
 *
¶p
;

2851 *
g
;

2853  
¶p
 ){

2854 
	`årštf
(
out
,"%12s% (¡©%2dè","",
g
,
¶p
->
cå
->
¡p
->
¡©’um
);

2855 
	`CÚfigPršt
(
out
,
¶p
->
cå
);

2856 
	`årštf
(
out
,"\n");

2857 
¶p
 =…Í->
Ãxt
;

2859 
	}
}

2865 
	$PrštAùiÚ
(
aùiÚ
 *
­
, 
FILE
 *
å
, 
šd’t
){

2866 
»suÉ
 = 1;

2867  
­
->
ty³
 ){

2868 
SHIFT
:

2869 
	`årštf
(
å
,"%* shiá %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
¡©’um
);

2871 
REDUCE
:

2872 
	`årštf
(
å
,"%* »duû %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2874 
ACCEPT
:

2875 
	`årštf
(
å
,"%* acû±",
šd’t
,
­
->
¥
->
Çme
);

2877 
ERROR
:

2878 
	`årštf
(
å
,"%* ”rÜ",
šd’t
,
­
->
¥
->
Çme
);

2880 
SRCONFLICT
:

2881 
RRCONFLICT
:

2882 
	`årštf
(
å
,"%*s„educe %-3d ** Parsing conflict **",

2883 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2885 
SSCONFLICT
:

2886 
	`årštf
(
å
,"%*s shift %d ** Parsing conflict **",

2887 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
¡©’um
);

2889 
SH_RESOLVED
:

2890 
RD_RESOLVED
:

2891 
NOT_USED
:

2892 
»suÉ
 = 0;

2895  
»suÉ
;

2896 
	}
}

2899 
	$R•ÜtOuut
(
Ëmp
)

2900 
ËmÚ
 *
Ëmp
;

2902 
i
;

2903 
¡©e
 *
¡p
;

2904 
cÚfig
 *
cå
;

2905 
aùiÚ
 *
­
;

2906 
FILE
 *
å
;

2908 
å
 = 
	`fe_İ’
(
Ëmp
,".out","wb");

2909 ifĞ
å
==0 ) ;

2910 
i
=0; i<
Ëmp
->
n¡©e
; i++){

2911 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

2912 
	`årštf
(
å
,"S‹ %d:\n",
¡p
->
¡©’um
);

2913 ifĞ
Ëmp
->
basisæag
 ) 
cå
=
¡p
->
bp
;

2914 
cå
=
¡p
->cfp;

2915  
cå
 ){

2916 
buf
[20];

2917 ifĞ
cå
->
dÙ
==cå->
½
->
Ähs
 ){

2918 
	`¥rštf
(
buf
,"(%d)",
cå
->
½
->
šdex
);

2919 
	`årštf
(
å
," %5 ",
buf
);

2921 
	`årštf
(
å
," ");

2923 
	`CÚfigPršt
(
å
,
cå
);

2924 
	`årštf
(
å
,"\n");

2926 
	`S‘Pršt
(
å
,
cå
->
fws
,
Ëmp
);

2927 
	`PlškPršt
(
å
,
cå
->
åÍ
,"To ");

2928 
	`PlškPršt
(
å
,
cå
->
b¶p
,"From");

2930 ifĞ
Ëmp
->
basisæag
 ) 
cå
=cå->
bp
;

2931 
cå
=cå->
Ãxt
;

2933 
	`årštf
(
å
,"\n");

2934 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

2935 ifĞ
	`PrštAùiÚ
(
­
,
å
,30èè
	`årštf
(fp,"\n");

2937 
	`årštf
(
å
,"\n");

2939 
	`årštf
(
å
, "----------------------------------------------------\n");

2940 
	`årštf
(
å
, "Symbols:\n");

2941 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2942 
j
;

2943 
symbŞ
 *
¥
;

2945 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2946 
	`årštf
(
å
, " %3d: %s", 
i
, 
¥
->
Çme
);

2947 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

2948 
	`årštf
(
å
, ":");

2949 ifĞ
¥
->
Ïmbda
 ){

2950 
	`årštf
(
å
, " <lambda>");

2952 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

2953 ifĞ
¥
->
fœ¡£t
 && 
	`S‘Fšd
(¥->fœ¡£t, 
j
) ){

2954 
	`årštf
(
å
, " %s", 
Ëmp
->
symbŞs
[
j
]->
Çme
);

2958 
	`årštf
(
å
, "\n");

2960 
	`fşo£
(
å
);

2962 
	}
}

2966 
PRIVATE
 *
	$·th£¬ch
(
¬gv0
,
Çme
,
modemask
)

2967 *
¬gv0
;

2968 *
Çme
;

2969 
modemask
;

2971 *
·thli¡
;

2972 *
·th
,*
ı
;

2973 
c
;

2975 #ifdeà
__WIN32__


2976 
ı
 = 
	`¡¼chr
(
¬gv0
,'\\');

2978 
ı
 = 
	`¡¼chr
(
¬gv0
,'/');

2980 ifĞ
ı
 ){

2981 
c
 = *
ı
;

2982 *
ı
 = 0;

2983 
·th
 = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
¬gv0
è+†emÚSŒËn(
Çme
) + 2 );

2984 ifĞ
·th
 ) 
	`¥rštf
Õ©h,"%s/%s",
¬gv0
,
Çme
);

2985 *
ı
 = 
c
;

2987 *
	`g‘’v
();

2988 
·thli¡
 = 
	`g‘’v
("PATH");

2989 ifĞ
·thli¡
==0 )…athlist = ".:/bin:/usr/bin";

2990 
·th
 = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
·thli¡
)+ËmÚSŒËn(
Çme
)+2 );

2991 ifĞ
·th
!=0 ){

2992  *
·thli¡
 ){

2993 
ı
 = 
	`¡rchr
(
·thli¡
,':');

2994 ifĞ
ı
==0 ) c°ğ&
·thli¡
[
	`ËmÚSŒËn
(pathlist)];

2995 
c
 = *
ı
;

2996 *
ı
 = 0;

2997 
	`¥rštf
(
·th
,"%s/%s",
·thli¡
,
Çme
);

2998 *
ı
 = 
c
;

2999 ifĞ
c
==0 ) 
·thli¡
 = "";

3000 
·thli¡
 = &
ı
[1];

3001 ifĞ
	`acûss
(
·th
,
modemask
)==0 ) ;

3005  
·th
;

3006 
	}
}

3012 
PRIVATE
 
	$compu‹_aùiÚ
(
Ëmp
,
­
)

3013 
ËmÚ
 *
Ëmp
;

3014 
aùiÚ
 *
­
;

3016 
aù
;

3017  
­
->
ty³
 ){

3018 
SHIFT
: 
aù
 = 
­
->
x
.
¡p
->
¡©’um
; ;

3019 
REDUCE
: 
aù
 = 
­
->
x
.
½
->
šdex
 + 
Ëmp
->
n¡©e
; ;

3020 
ERROR
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
; ;

3021 
ACCEPT
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 1; ;

3022 : 
aù
 = -1; ;

3024  
aù
;

3025 
	}
}

3027 
	#LINESIZE
 1000

	)

3037 
PRIVATE
 
	$É_xãr
(
Çme
,
š
,
out
,
lš’o
)

3038 *
Çme
;

3039 
FILE
 *
š
;

3040 
FILE
 *
out
;

3041 *
lš’o
;

3043 
i
, 
iS¹
;

3044 
lše
[
LINESIZE
];

3045  
	`fg‘s
(
lše
,
LINESIZE
,
š
) && (line[0]!='%' ||†ine[1]!='%') ){

3046 (*
lš’o
)++;

3047 
iS¹
 = 0;

3048 ifĞ
Çme
 ){

3049 
i
=0; 
lše
[i]; i++){

3050 ifĞ
lše
[
i
]=='P' && 
	`¡ºcmp
(&line[i],"Parse",5)==0

3051 && (
i
==0 || !
	`i§Íha
(
lše
[i-1]))

3053 ifĞ
i
>
iS¹
 ) 
	`årštf
(
out
,"%.*s",i-iS¹,&
lše
[iStart]);

3054 
	`årštf
(
out
,"%s",
Çme
);

3055 
i
 += 4;

3056 
iS¹
 = 
i
+1;

3060 
	`årštf
(
out
,"%s",&
lše
[
iS¹
]);

3062 
	}
}

3066 
PRIVATE
 
FILE
 *
	$É_İ’
(
Ëmp
)

3067 
ËmÚ
 *
Ëmp
;

3069 
‹m¶©’ame
[] = "lempar.c";

3070 
buf
[1000];

3071 
FILE
 *
š
;

3072 *
ÉÇme
;

3073 *
ı
;

3075 
ı
 = 
	`¡¼chr
(
Ëmp
->
f’ame
,'.');

3076 ifĞ
ı
 ){

3077 
	`¥rštf
(
buf
,"%.*s.É",()(
ı
-
Ëmp
->
f’ame
),lemp->filename);

3079 
	`¥rštf
(
buf
,"%s.É",
Ëmp
->
f’ame
);

3081 ifĞ
	`acûss
(
buf
,004)==0 ){

3082 
ÉÇme
 = 
buf
;

3083 }ifĞ
	`acûss
(
‹m¶©’ame
,004)==0 ){

3084 
ÉÇme
 = 
‹m¶©’ame
;

3086 
ÉÇme
 = 
	`·th£¬ch
(
Ëmp
->
¬gv0
,
‹m¶©’ame
,0);

3088 ifĞ
ÉÇme
==0 ){

3089 
	`årštf
(
¡d”r
,"Can't findhe…arser driveremplate file \"%s\".\n",

3090 
‹m¶©’ame
);

3091 
Ëmp
->
”rÜút
++;

3094 
š
 = 
	`fİ’
(
ÉÇme
,"rb");

3095 ifĞ
š
==0 ){

3096 
	`årštf
(
¡d”r
,"Cª'ˆİ’h‹m¶©f\"%s\".\n",
‹m¶©’ame
);

3097 
Ëmp
->
”rÜút
++;

3100  
š
;

3101 
	}
}

3104 
PRIVATE
 
	$É_lšedœ
(
out
,
lš’o
,
f’ame
)

3105 
FILE
 *
out
;

3106 
lš’o
;

3107 *
f’ame
;

3109 
	`årštf
(
out
,"#lš%d \"",
lš’o
);

3110  *
f’ame
 ){

3111 ifĞ*
f’ame
 =ğ'\\' ) 
	`putc
('\\',
out
);

3112 
	`putc
(*
f’ame
,
out
);

3113 
f’ame
++;

3115 
	`årštf
(
out
,"\"\n");

3116 
	}
}

3119 
PRIVATE
 
	$É_´št
(
out
,
Ëmp
,
¡r
,
lš’o
)

3120 
FILE
 *
out
;

3121 
ËmÚ
 *
Ëmp
;

3122 *
¡r
;

3123 *
lš’o
;

3125 ifĞ
¡r
==0 ) ;

3126  *
¡r
 ){

3127 
	`putc
(*
¡r
,
out
);

3128 ifĞ*
¡r
=='\n' ) (*
lš’o
)++;

3129 
¡r
++;

3131 ifĞ
¡r
[-1]!='\n' ){

3132 
	`putc
('\n',
out
);

3133 (*
lš’o
)++;

3135 ià(!
Ëmp
->
nŞš’osæag
) {

3136 (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,
Ëmp
->
ouŠame
);

3139 
	}
}

3145 
	$em™_de¡ruùÜ_code
(
out
,
¥
,
Ëmp
,
lš’o
)

3146 
FILE
 *
out
;

3147 
symbŞ
 *
¥
;

3148 
ËmÚ
 *
Ëmp
;

3149 *
lš’o
;

3151 *
ı
 = 0;

3153 ifĞ
¥
->
ty³
==
TERMINAL
 ){

3154 
ı
 = 
Ëmp
->
tok’de¡
;

3155 ifĞ
ı
==0 ) ;

3156 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3157 }ifĞ
¥
->
de¡ruùÜ
 ){

3158 
ı
 = 
¥
->
de¡ruùÜ
;

3159 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3160 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,
¥
->
de¡Lš’o
,Ëmp->
f’ame
); }

3161 }ifĞ
Ëmp
->
v¬de¡
 ){

3162 
ı
 = 
Ëmp
->
v¬de¡
;

3163 ifĞ
ı
==0 ) ;

3164 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3166 
	`as£¹
( 0 );

3168 ; *
ı
; cp++){

3169 ifĞ*
ı
=='$' && cp[1]=='$' ){

3170 
	`årštf
(
out
,"(yypmšÜ->yy%d)",
¥
->
dŠum
);

3171 
ı
++;

3174 ifĞ*
ı
=='\n' ) (*
lš’o
)++;

3175 
	`åutc
(*
ı
,
out
);

3177 
	`årštf
(
out
,"\n"); (*
lš’o
)++;

3178 ià(!
Ëmp
->
nŞš’osæag
) {

3179 (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,
Ëmp
->
ouŠame
);

3181 
	`årštf
(
out
,"}\n"); (*
lš’o
)++;

3183 
	}
}

3188 
	$has_de¡ruùÜ
(
¥
, 
Ëmp
)

3189 
symbŞ
 *
¥
;

3190 
ËmÚ
 *
Ëmp
;

3192 
»t
;

3193 ifĞ
¥
->
ty³
==
TERMINAL
 ){

3194 
»t
 = 
Ëmp
->
tok’de¡
!=0;

3196 
»t
 = 
Ëmp
->
v¬de¡
!=0 || 
¥
->
de¡ruùÜ
!=0;

3198  
»t
;

3199 
	}
}

3213 
PRIVATE
 *
	$­³nd_¡r
(*
zText
, 
n
, 
p1
, 
p2
){

3214 *
z
 = 0;

3215 
®loûd
 = 0;

3216 
u£d
 = 0;

3217 
c
;

3218 
zIÁ
[40];

3220 ifĞ
zText
==0 ){

3221 
u£d
 = 0;

3222  
z
;

3224 ifĞ
n
<=0 ){

3225 ifĞ
n
<0 ){

3226 
u£d
 +ğ
n
;

3227 
	`as£¹
Ğ
u£d
>=0 );

3229 
n
 = 
	`ËmÚSŒËn
(
zText
);

3231 ifĞ
n
+(
zIÁ
)*2+
u£d
 >ğ
®loûd
 ){

3232 
®loûd
 = 
n
 + (
zIÁ
)*2 + 
u£d
 + 200;

3233 
z
 = 
	`»®loc
(z, 
®loûd
);

3235 ifĞ
z
==0 )  "";

3236  
n
-- > 0 ){

3237 
c
 = *(
zText
++);

3238 ifĞ
c
=='%' && 
n
>0 && 
zText
[0]=='d' ){

3239 
	`¥rštf
(
zIÁ
, "%d", 
p1
);

3240 
p1
 = 
p2
;

3241 
	`¡rıy
(&
z
[
u£d
], 
zIÁ
);

3242 
u£d
 +ğ
	`ËmÚSŒËn
(&
z
[used]);

3243 
zText
++;

3244 
n
--;

3246 
z
[
u£d
++] = 
c
;

3249 
z
[
u£d
] = 0;

3250  
z
;

3251 
	}
}

3258 
PRIVATE
 
	$Œª¦©e_code
(
ËmÚ
 *
Ëmp
, 
ruË
 *
½
){

3259 *
ı
, *
xp
;

3260 
i
;

3261 
lhsu£d
 = 0;

3262 
u£d
[
MAXRHS
];

3264 
i
=0; i<
½
->
Ähs
; i++è
u£d
[i] = 0;

3265 
lhsu£d
 = 0;

3267 ifĞ
½
->
code
==0 ){

3268 
½
->
code
 = "\n";

3269 
½
->
lše
 =„p->
ruËlše
;

3272 
	`­³nd_¡r
(0,0,0,0);

3273 
ı
=
½
->
code
; *cp; cp++){

3274 ifĞ
	`i§Íha
(*
ı
è&& (ı==
½
->
code
 || (!
	`i§Êum
(cp[-1]) && cp[-1]!='_')) ){

3275 
§ved
;

3276 
xp
ğ&
ı
[1]; 
	`i§Êum
(*xp) || *xp=='_'; xp++);

3277 
§ved
 = *
xp
;

3278 *
xp
 = 0;

3279 ifĞ
½
->
lh§lŸs
 && 
	`¡rcmp
(
ı
,rp->lhsalias)==0 ){

3280 
	`­³nd_¡r
("yygÙomšÜ.yy%d",0,
½
->
lhs
->
dŠum
,0);

3281 
ı
 = 
xp
;

3282 
lhsu£d
 = 1;

3284 
i
=0; i<
½
->
Ähs
; i++){

3285 ifĞ
½
->
rh§lŸs
[
i
] && 
	`¡rcmp
(
ı
,rp->rhsalias[i])==0 ){

3286 ifĞ
ı
!=
½
->
code
 && cp[-1]=='@' ){

3289 
	`­³nd_¡r
("yym¥[%d].majÜ",-1,
i
-
½
->
Ähs
+1,0);

3291 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

3292 
dŠum
;

3293 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

3294 
dŠum
 = 
¥
->
subsym
[0]->dtnum;

3296 
dŠum
 = 
¥
->dtnum;

3298 
	`­³nd_¡r
("yym¥[%d].mšÜ.yy%d",0,
i
-
½
->
Ähs
+1, 
dŠum
);

3300 
ı
 = 
xp
;

3301 
u£d
[
i
] = 1;

3306 *
xp
 = 
§ved
;

3308 
	`­³nd_¡r
(
ı
, 1, 0, 0);

3312 ifĞ
½
->
lh§lŸs
 && !
lhsu£d
 ){

3313 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3315 
½
->
lh§lŸs
,½->
lhs
->
Çme
,rp->lhsalias);

3316 
Ëmp
->
”rÜút
++;

3321 
i
=0; i<
½
->
Ähs
; i++){

3322 ifĞ
½
->
rh§lŸs
[
i
] && !
u£d
[i] ){

3323 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3325 
½
->
rh§lŸs
[
i
],½->
rhs
[i]->
Çme
,rp->rhsalias[i]);

3326 
Ëmp
->
”rÜút
++;

3327 }ifĞ
½
->
rh§lŸs
[
i
]==0 ){

3328 ifĞ
	`has_de¡ruùÜ
(
½
->
rhs
[
i
],
Ëmp
) ){

3329 
	`­³nd_¡r
(" yy_destructor(yypParser,%d,&yymsp[%d].minor);\n", 0,

3330 
½
->
rhs
[
i
]->
šdex
,i-½->
Ähs
+1);

3336 ifĞ
½
->
code
 ){

3337 
ı
 = 
	`­³nd_¡r
(0,0,0,0);

3338 
½
->
code
 = 
	`SŒ§ã
(
ı
?cp:"");

3340 
	}
}

3346 
PRIVATE
 
	$em™_code
(
out
,
½
,
Ëmp
,
lš’o
)

3347 
FILE
 *
out
;

3348 
ruË
 *
½
;

3349 
ËmÚ
 *
Ëmp
;

3350 *
lš’o
;

3352 *
ı
;

3355 ifĞ
½
->
code
 ){

3356 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,
½
->
lše
,Ëmp->
f’ame
); }

3357 
	`årštf
(
out
,"{%s",
½
->
code
);

3358 
ı
=
½
->
code
; *cp; cp++){

3359 ifĞ*
ı
=='\n' ) (*
lš’o
)++;

3361 
	`årštf
(
out
,"}\n"); (*
lš’o
)++;

3362 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,Ëmp->
ouŠame
); }

3366 
	}
}

3375 
	$´št_¡ack_uniÚ
(
out
,
Ëmp
,
¶š’o
,
mhæag
)

3376 
FILE
 *
out
;

3377 
ËmÚ
 *
Ëmp
;

3378 *
¶š’o
;

3379 
mhæag
;

3381 
lš’o
 = *
¶š’o
;

3382 **
ty³s
;

3383 
¬¿ysize
;

3384 
maxd’gth
;

3385 *
¡ddt
;

3386 
i
,
j
;

3387 
hash
;

3388 *
Çme
;

3391 
¬¿ysize
 = 
Ëmp
->
nsymbŞ
 * 2;

3392 
ty³s
 = (**)
	`ÿÎoc
Ğ
¬¿ysize
, (*) );

3393 
i
=0; i<
¬¿ysize
; i++è
ty³s
[i] = 0;

3394 
maxd’gth
 = 0;

3395 ifĞ
Ëmp
->
v¬ty³
 ){

3396 
maxd’gth
 = 
	`ËmÚSŒËn
(
Ëmp
->
v¬ty³
);

3398 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3399 
Ën
;

3400 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3401 ifĞ
¥
->
d©©y³
==0 ) ;

3402 
Ën
 = 
	`ËmÚSŒËn
(
¥
->
d©©y³
);

3403 ifĞ
Ën
>
maxd’gth
 ) maxdtlength =†en;

3405 
¡ddt
 = (*)
	`m®loc
Ğ
maxd’gth
*2 + 1 );

3406 ifĞ
ty³s
==0 || 
¡ddt
==0 ){

3407 
	`årštf
(
¡d”r
,"Out of memory.\n");

3408 
	`ex™
(1);

3417 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3418 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3419 *
ı
;

3420 ifĞ
¥
==
Ëmp
->
”rsym
 ){

3421 
¥
->
dŠum
 = 
¬¿ysize
+1;

3424 ifĞ
¥
->
ty³
!=
NONTERMINAL
 || (¥->
d©©y³
==0 && 
Ëmp
->
v¬ty³
==0) ){

3425 
¥
->
dŠum
 = 0;

3428 
ı
 = 
¥
->
d©©y³
;

3429 ifĞ
ı
==0 ) c°ğ
Ëmp
->
v¬ty³
;

3430 
j
 = 0;

3431  
	`is¥aû
(*
ı
) ) cp++;

3432  *
ı
 ) 
¡ddt
[
j
++] = *cp++;

3433  
j
>0 && 
	`is¥aû
(
¡ddt
[j-1]) ) j--;

3434 
¡ddt
[
j
] = 0;

3435 ifĞ
Ëmp
->
tok’ty³
 && 
	`¡rcmp
(
¡ddt
,†emp->tokentype)==0 ){

3436 
¥
->
dŠum
 = 0;

3439 
hash
 = 0;

3440 
j
=0; 
¡ddt
[j]; j++){

3441 
hash
 = hash*53 + 
¡ddt
[
j
];

3443 
hash
 = (hash & 0x7fffffff)%
¬¿ysize
;

3444  
ty³s
[
hash
] ){

3445 ifĞ
	`¡rcmp
(
ty³s
[
hash
],
¡ddt
)==0 ){

3446 
¥
->
dŠum
 = 
hash
 + 1;

3449 
hash
++;

3450 ifĞ
hash
>=
¬¿ysize
 ) hash = 0;

3452 ifĞ
ty³s
[
hash
]==0 ){

3453 
¥
->
dŠum
 = 
hash
 + 1;

3454 
ty³s
[
hash
] = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
¡ddt
)+1 );

3455 ifĞ
ty³s
[
hash
]==0 ){

3456 
	`årštf
(
¡d”r
,"Out of memory.\n");

3457 
	`ex™
(1);

3459 
	`¡rıy
(
ty³s
[
hash
],
¡ddt
);

3464 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3465 
lš’o
 = *
¶š’o
;

3466 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++; }

3467 
	`årštf
(
out
,"#defš%sTOKENTYPE %s\n",
Çme
,

3468 
Ëmp
->
tok’ty³
?Ëmp->tok’ty³:"void*"); 
lš’o
++;

3469 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++; }

3470 
	`årštf
(
out
,"ty³deàuniÚ {\n"); 
lš’o
++;

3471 
	`årštf
(
out
," iÁ yyš™;\n"); 
lš’o
++;

3472 
	`årštf
(
out
," %sTOKENTYPE yy0;\n",
Çme
); 
lš’o
++;

3473 
i
=0; i<
¬¿ysize
; i++){

3474 ifĞ
ty³s
[
i
]==0 ) ;

3475 
	`årštf
(
out
," % yy%d;\n",
ty³s
[
i
],i+1); 
lš’o
++;

3476 
	`ä“
(
ty³s
[
i
]);

3478 ifĞ
Ëmp
->
”rsym
->
u£CÁ
 ){

3479 
	`årštf
(
out
," iÁ yy%d;\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3481 
	`ä“
(
¡ddt
);

3482 
	`ä“
(
ty³s
);

3483 
	`årštf
(
out
,"} YYMINORTYPE;\n"); 
lš’o
++;

3484 *
¶š’o
 = 
lš’o
;

3485 
	}
}

3491 cÚ¡ *
	$mšimum_size_ty³
(
lwr
, 
u´
){

3492 ifĞ
lwr
>=0 ){

3493 ifĞ
u´
<=255 ){

3495 }ifĞ
u´
<65535 ){

3500 }ifĞ
lwr
>=-127 && 
u´
<=127 ){

3502 }ifĞ
lwr
>=-32767 && 
u´
<32767 ){

3507 
	}
}

3515 
	sax£t
 {

3516 
¡©e
 *
	m¡p
;

3517 
	misTkn
;

3518 
	mnAùiÚ
;

3524 
	$ax£t_com·»
(cÚ¡ *
a
, cÚ¡ *
b
){

3525 
ax£t
 *
p1
 = (ax£t*)
a
;

3526 
ax£t
 *
p2
 = (ax£t*)
b
;

3527  
p2
->
nAùiÚ
 - 
p1
->nAction;

3528 
	}
}

3533 
	$wr™eRuËText
(
FILE
 *
out
, 
ruË
 *
½
){

3534 
j
;

3535 
	`årštf
(
out
,"% ::=", 
½
->
lhs
->
Çme
);

3536 
j
=0; j<
½
->
Ähs
; j++){

3537 
symbŞ
 *
¥
 = 
½
->
rhs
[
j
];

3538 
	`årštf
(
out
," %s", 
¥
->
Çme
);

3539 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

3540 
k
;

3541 
k
=1; k<
¥
->
nsubsym
; k++){

3542 
	`årštf
(
out
,"|%s",
¥
->
subsym
[
k
]->
Çme
);

3546 
	}
}

3550 
	$R•ÜtTabË
(
Ëmp
, 
mhæag
)

3551 
ËmÚ
 *
Ëmp
;

3552 
mhæag
;

3554 
FILE
 *
out
, *
š
;

3555 
lše
[
LINESIZE
];

3556 
lš’o
;

3557 
¡©e
 *
¡p
;

3558 
aùiÚ
 *
­
;

3559 
ruË
 *
½
;

3560 
aùb
 *
pAùb
;

3561 
i
, 
j
, 
n
;

3562 *
Çme
;

3563 
mnTknOf¡
, 
mxTknOf¡
;

3564 
mnNtOf¡
, 
mxNtOf¡
;

3565 
ax£t
 *
ax
;

3567 
š
 = 
	`É_İ’
(
Ëmp
);

3568 ifĞ
š
==0 ) ;

3569 
out
 = 
	`fe_İ’
(
Ëmp
,".c","wb");

3570 ifĞ
out
==0 ){

3571 
	`fşo£
(
š
);

3574 
lš’o
 = 1;

3575 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3578 
	`É_´št
(
out
,
Ëmp
,Ëmp->
šşude
,&
lš’o
);

3579 ifĞ
mhæag
 ){

3580 *
Çme
 = 
	`fe_mak’ame
(
Ëmp
, ".h");

3581 
	`årštf
(
out
,"#šşud\"%s\"\n", 
Çme
); 
lš’o
++;

3582 
	`ä“
(
Çme
);

3584 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3587 ifĞ
mhæag
 ){

3588 *
´efix
;

3589 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3590 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3591 
´efix
 = "";

3592 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

3593 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

3594 
lš’o
++;

3596 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3598 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3601 
	`årštf
(
out
,"#define YYCODETYPE %s\n",

3602 
	`mšimum_size_ty³
(0, 
Ëmp
->
nsymbŞ
+1)); 
lš’o
++;

3603 
	`årštf
(
out
,"#defšYYNOCODE %d\n",
Ëmp
->
nsymbŞ
+1); 
lš’o
++;

3604 
	`årštf
(
out
,"#define YYACTIONTYPE %s\n",

3605 
	`mšimum_size_ty³
(0, 
Ëmp
->
n¡©e
+Ëmp->
ÄuË
+5)); 
lš’o
++;

3606 ifĞ
Ëmp
->
wdÿrd
 ){

3607 
	`årštf
(
out
,"#define YYWILDCARD %d\n",

3608 
Ëmp
->
wdÿrd
->
šdex
); 
lš’o
++;

3610 
	`´št_¡ack_uniÚ
(
out
,
Ëmp
,&
lš’o
,
mhæag
);

3611 
	`årštf
(
out
, "#iâdeàYYSTACKDEPTH\n"); 
lš’o
++;

3612 ifĞ
Ëmp
->
¡acksize
 ){

3613 
	`årštf
(
out
,"#defšYYSTACKDEPTH %s\n",
Ëmp
->
¡acksize
); 
lš’o
++;

3615 
	`årštf
(
out
,"#defšYYSTACKDEPTH 100\n"); 
lš’o
++;

3617 
	`årštf
(
out
, "#’dif\n"); 
lš’o
++;

3618 ifĞ
mhæag
 ){

3619 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3621 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3622 ifĞ
Ëmp
->
¬g
 &&†emp->arg[0] ){

3623 
i
;

3624 
i
 = 
	`ËmÚSŒËn
(
Ëmp
->
¬g
);

3625  
i
>=1 && 
	`is¥aû
(
Ëmp
->
¬g
[i-1]) ) i--;

3626  
i
>=1 && (
	`i§Êum
(
Ëmp
->
¬g
[i-1]) ||†emp->arg[i-1]=='_') ) i--;

3627 
	`årštf
(
out
,"#defš%sARG_SDECL %s;\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3628 
	`årštf
(
out
,"#defš%sARG_PDECL ,%s\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3629 
	`årštf
(
out
,"#define %sARG_FETCH %s = yypParser->%s\n",

3630 
Çme
,
Ëmp
->
¬g
,&Ëmp->¬g[
i
]); 
lš’o
++;

3631 
	`årštf
(
out
,"#define %sARG_STORE yypParser->%s = %s\n",

3632 
Çme
,&
Ëmp
->
¬g
[
i
],&Ëmp->¬g[i]); 
lš’o
++;

3634 
	`årštf
(
out
,"#defš%sARG_SDECL\n",
Çme
); 
lš’o
++;

3635 
	`årštf
(
out
,"#defš%sARG_PDECL\n",
Çme
); 
lš’o
++;

3636 
	`årštf
(
out
,"#defš%sARG_FETCH\n",
Çme
); 
lš’o
++;

3637 
	`årštf
(
out
,"#defš%sARG_STORE\n",
Çme
); 
lš’o
++;

3639 ifĞ
mhæag
 ){

3640 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3642 
	`årštf
(
out
,"#defšYYNSTATE %d\n",
Ëmp
->
n¡©e
); 
lš’o
++;

3643 
	`årštf
(
out
,"#defšYYNRULE %d\n",
Ëmp
->
ÄuË
); 
lš’o
++;

3644 ifĞ
Ëmp
->
”rsym
->
u£CÁ
 ){

3645 
	`årštf
(
out
,"#defšYYERRORSYMBOL %d\n",
Ëmp
->
”rsym
->
šdex
); 
lš’o
++;

3646 
	`årštf
(
out
,"#defšYYERRSYMDT yy%d\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3648 ifĞ
Ëmp
->
has_çÎback
 ){

3649 
	`årštf
(
out
,"#defšYYFALLBACK 1\n"); 
lš’o
++;

3651 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3666 
ax
 = 
	`ÿÎoc
(
Ëmp
->
n¡©e
*2, (ax[0]));

3667 ifĞ
ax
==0 ){

3668 
	`årštf
(
¡d”r
,"malloc failed\n");

3669 
	`ex™
(1);

3671 
i
=0; i<
Ëmp
->
n¡©e
; i++){

3672 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3673 
ax
[
i
*2].
¡p
 = stp;

3674 
ax
[
i
*2].
isTkn
 = 1;

3675 
ax
[
i
*2].
nAùiÚ
 = 
¡p
->
nTknAù
;

3676 
ax
[
i
*2+1].
¡p
 = stp;

3677 
ax
[
i
*2+1].
isTkn
 = 0;

3678 
ax
[
i
*2+1].
nAùiÚ
 = 
¡p
->
nNtAù
;

3680 
mxTknOf¡
 = 
mnTknOf¡
 = 0;

3681 
mxNtOf¡
 = 
mnNtOf¡
 = 0;

3687 
	`qsÜt
(
ax
, 
Ëmp
->
n¡©e
*2, ×x[0]), 
ax£t_com·»
);

3688 
pAùb
 = 
	`aùb_®loc
();

3689 
i
=0; i<
Ëmp
->
n¡©e
*2 && 
ax
[i].
nAùiÚ
>0; i++){

3690 
¡p
 = 
ax
[
i
].stp;

3691 ifĞ
ax
[
i
].
isTkn
 ){

3692 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3693 
aùiÚ
;

3694 ifĞ
­
->
¥
->
šdex
>=
Ëmp
->
Á”mš®
 ) ;

3695 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3696 ifĞ
aùiÚ
<0 ) ;

3697 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3699 
¡p
->
iTknOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3700 ifĞ
¡p
->
iTknOf¡
<
mnTknOf¡
 ) mnTknOfst = stp->iTknOfst;

3701 ifĞ
¡p
->
iTknOf¡
>
mxTknOf¡
 ) mxTknOfst = stp->iTknOfst;

3703 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3704 
aùiÚ
;

3705 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ) ;

3706 ifĞ
­
->
¥
->
šdex
==
Ëmp
->
nsymbŞ
 ) ;

3707 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3708 ifĞ
aùiÚ
<0 ) ;

3709 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3711 
¡p
->
iNtOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3712 ifĞ
¡p
->
iNtOf¡
<
mnNtOf¡
 ) mnNtOfst = stp->iNtOfst;

3713 ifĞ
¡p
->
iNtOf¡
>
mxNtOf¡
 ) mxNtOfst = stp->iNtOfst;

3716 
	`ä“
(
ax
);

3719 
	`årštf
(
out
,"¡©iøcÚ¡ YYACTIONTYPE yy_aùiÚ[] = {\n"); 
lš’o
++;

3720 
n
 = 
	`aùb_size
(
pAùb
);

3721 
i
=
j
=0; i<
n
; i++){

3722 
aùiÚ
 = 
	`aùb_yyaùiÚ
(
pAùb
, 
i
);

3723 ifĞ
aùiÚ
<0 )‡ùiÚ = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 2;

3724 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3725 
	`årštf
(
out
, " %4d,", 
aùiÚ
);

3726 ifĞ
j
==9 || 
i
==
n
-1 ){

3727 
	`årštf
(
out
, "\n"); 
lš’o
++;

3728 
j
 = 0;

3730 
j
++;

3733 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3736 
	`årštf
(
out
,"¡©iøcÚ¡ YYCODETYPE yy_lookah—d[] = {\n"); 
lš’o
++;

3737 
i
=
j
=0; i<
n
; i++){

3738 
Ï
 = 
	`aùb_yylookah—d
(
pAùb
, 
i
);

3739 ifĞ
Ï
<0 )†¨ğ
Ëmp
->
nsymbŞ
;

3740 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3741 
	`årštf
(
out
, " %4d,", 
Ï
);

3742 ifĞ
j
==9 || 
i
==
n
-1 ){

3743 
	`årštf
(
out
, "\n"); 
lš’o
++;

3744 
j
 = 0;

3746 
j
++;

3749 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3752 
	`årštf
(
out
, "#defšYY_SHIFT_USE_DFLT (%d)\n", 
mnTknOf¡
-1); 
lš’o
++;

3753 
n
 = 
Ëmp
->
n¡©e
;

3754  
n
>0 && 
Ëmp
->
sÜ‹d
[n-1]->
iTknOf¡
==
NO_OFFSET
 )‚--;

3755 
	`årštf
(
out
, "#defšYY_SHIFT_MAX %d\n", 
n
-1); 
lš’o
++;

3756 
	`årštf
(
out
, "static const %s yy_shift_ofst[] = {\n",

3757 
	`mšimum_size_ty³
(
mnTknOf¡
-1, 
mxTknOf¡
)); 
lš’o
++;

3758 
i
=
j
=0; i<
n
; i++){

3759 
of¡
;

3760 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3761 
of¡
 = 
¡p
->
iTknOf¡
;

3762 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnTknOf¡
 - 1;

3763 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3764 
	`årštf
(
out
, " %4d,", 
of¡
);

3765 ifĞ
j
==9 || 
i
==
n
-1 ){

3766 
	`årštf
(
out
, "\n"); 
lš’o
++;

3767 
j
 = 0;

3769 
j
++;

3772 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3775 
	`årštf
(
out
, "#defšYY_REDUCE_USE_DFLT (%d)\n", 
mnNtOf¡
-1); 
lš’o
++;

3776 
n
 = 
Ëmp
->
n¡©e
;

3777  
n
>0 && 
Ëmp
->
sÜ‹d
[n-1]->
iNtOf¡
==
NO_OFFSET
 )‚--;

3778 
	`årštf
(
out
, "#defšYY_REDUCE_MAX %d\n", 
n
-1); 
lš’o
++;

3779 
	`årštf
(
out
, "static const %s yy_reduce_ofst[] = {\n",

3780 
	`mšimum_size_ty³
(
mnNtOf¡
-1, 
mxNtOf¡
)); 
lš’o
++;

3781 
i
=
j
=0; i<
n
; i++){

3782 
of¡
;

3783 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3784 
of¡
 = 
¡p
->
iNtOf¡
;

3785 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnNtOf¡
 - 1;

3786 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3787 
	`årštf
(
out
, " %4d,", 
of¡
);

3788 ifĞ
j
==9 || 
i
==
n
-1 ){

3789 
	`årštf
(
out
, "\n"); 
lš’o
++;

3790 
j
 = 0;

3792 
j
++;

3795 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3798 
	`årštf
(
out
, "¡©iøcÚ¡ YYACTIONTYPE yy_deçuÉ[] = {\n"); 
lš’o
++;

3799 
n
 = 
Ëmp
->
n¡©e
;

3800 
i
=
j
=0; i<
n
; i++){

3801 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3802 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3803 
	`årštf
(
out
, " %4d,", 
¡p
->
iDæt
);

3804 ifĞ
j
==9 || 
i
==
n
-1 ){

3805 
	`årštf
(
out
, "\n"); 
lš’o
++;

3806 
j
 = 0;

3808 
j
++;

3811 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3812 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3816 ifĞ
Ëmp
->
has_çÎback
 ){

3817 
mx
 = 
Ëmp
->
Á”mš®
 - 1;

3818  
mx
>0 && 
Ëmp
->
symbŞs
[mx]->
çÎback
==0 ){ mx--; }

3819 
i
=0; i<=
mx
; i++){

3820 
symbŞ
 *
p
 = 
Ëmp
->
symbŞs
[
i
];

3821 ifĞ
p
->
çÎback
==0 ){

3822 
	`årštf
(
out
, " 0, /* %10 =>‚Ùhšg */\n", 
p
->
Çme
);

3824 
	`årštf
(
out
, " %3d, /* %10 => % */\n", 
p
->
çÎback
->
šdex
,

3825 
p
->
Çme
,…->
çÎback
->name);

3827 
lš’o
++;

3830 
	`É_xãr
(
Ëmp
->
Çme
, 
š
, 
out
, &
lš’o
);

3834 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3835 
	`¥rštf
(
lše
,"\"%s\",",
Ëmp
->
symbŞs
[
i
]->
Çme
);

3836 
	`årštf
(
out
," %-15s",
lše
);

3837 ifĞ(
i
&3)==3 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3839 ifĞ(
i
&3)!=0 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3840 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3846 
i
=0, 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
, i++){

3847 
	`as£¹
Ğ
½
->
šdex
==
i
 );

3848 
	`årštf
(
out
," /* %3d */ \"", 
i
);

3849 
	`wr™eRuËText
(
out
, 
½
);

3850 
	`årštf
(
out
,"\",\n"); 
lš’o
++;

3852 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3858 ifĞ
Ëmp
->
tok’de¡
 ){

3859 
Úû
 = 1;

3860 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3861 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3862 ifĞ
¥
==0 || sp->
ty³
!=
TERMINAL
 ) ;

3863 ifĞ
Úû
 ){

3864 
	`årštf
(
out
, " /* TERMINAL De¡ruùÜ */\n"); 
lš’o
++;

3865 
Úû
 = 0;

3867 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3869 
i
=0; i<
Ëmp
->
nsymbŞ
 &&†emp->
symbŞs
[i]->
ty³
!=
TERMINAL
; i++);

3870 ifĞ
i
<
Ëmp
->
nsymbŞ
 ){

3871 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3872 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3875 ifĞ
Ëmp
->
v¬de¡
 ){

3876 
symbŞ
 *
dæt_¥
 = 0;

3877 
Úû
 = 1;

3878 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3879 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3880 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 ||

3881 
¥
->
šdex
<=0 || sp->
de¡ruùÜ
!=0 ) ;

3882 ifĞ
Úû
 ){

3883 
	`årštf
(
out
, " /* DeçuÉ NON-TERMINAL De¡ruùÜ */\n"); 
lš’o
++;

3884 
Úû
 = 0;

3886 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3887 
dæt_¥
 = 
¥
;

3889 ifĞ
dæt_¥
!=0 ){

3890 
	`em™_de¡ruùÜ_code
(
out
,
dæt_¥
,
Ëmp
,&
lš’o
);

3892 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3894 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3895 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3896 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 || sp->
de¡ruùÜ
==0 ) ;

3897 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3900 
j
=
i
+1; j<
Ëmp
->
nsymbŞ
; j++){

3901 
symbŞ
 *
¥2
 = 
Ëmp
->
symbŞs
[
j
];

3902 ifĞ
¥2
 && sp2->
ty³
!=
TERMINAL
 && sp2->
de¡ruùÜ


3903 && 
¥2
->
dŠum
==
¥
->dtnum

3904 && 
	`¡rcmp
(
¥
->
de¡ruùÜ
,
¥2
->destructor)==0 ){

3905 
	`årštf
(
out
," case %d: /* %s */\n",

3906 
¥2
->
šdex
, sp2->
Çme
); 
lš’o
++;

3907 
¥2
->
de¡ruùÜ
 = 0;

3911 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3912 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3914 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3917 
	`É_´št
(
out
,
Ëmp
,Ëmp->
ov”æow
,&
lš’o
);

3918 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3925 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3926 
	`årštf
(
out
," { %d, %d },\n",
½
->
lhs
->
šdex
,½->
Ähs
); 
lš’o
++;

3928 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3931 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3932 
	`Œª¦©e_code
(
Ëmp
, 
½
);

3935 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3936 
ruË
 *
½2
;

3937 ifĞ
½
->
code
==0 ) ;

3938 ifĞ
½
->
code
[0]=='\n' &&„p->code[1]==0 ) ;

3939 
	`årštf
(
out
," ca£ %d: /* ", 
½
->
šdex
);

3940 
	`wr™eRuËText
(
out
, 
½
);

3941 
	`årštf
(
out
, " */\n"); 
lš’o
++;

3942 
½2
=
½
->
Ãxt
;„p2;„p2=rp2->next){

3943 ifĞ
½2
->
code
==
½
->code ){

3944 
	`årštf
(
out
," ca£ %d: /* ", 
½2
->
šdex
);

3945 
	`wr™eRuËText
(
out
, 
½2
);

3946 
	`årštf
(
out
," */ yy‹¡ÿ£(yyruËno==%d);\n", 
½2
->
šdex
); 
lš’o
++;

3947 
½2
->
code
 = 0;

3950 
	`em™_code
(
out
,
½
,
Ëmp
,&
lš’o
);

3951 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3952 
½
->
code
 = 0;

3956 
	`årštf
(
out
," deçuÉ:\n"); 
lš’o
++;

3957 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3958 ifĞ
½
->
code
==0 ) ;

3959 
	`as£¹
Ğ
½
->
code
[0]=='\n' &&„p->code[1]==0 );

3960 
	`årštf
(
out
," /* (%dè", 
½
->
šdex
);

3961 
	`wr™eRuËText
(
out
, 
½
);

3962 
	`årštf
(
out
, " */ yy‹¡ÿ£(yyruËno==%d);\n", 
½
->
šdex
); 
lš’o
++;

3964 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3965 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3968 
	`É_´št
(
out
,
Ëmp
,Ëmp->
çu»
,&
lš’o
);

3969 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3972 
	`É_´št
(
out
,
Ëmp
,Ëmp->
”rÜ
,&
lš’o
);

3973 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3976 
	`É_´št
(
out
,
Ëmp
,Ëmp->
acû±
,&
lš’o
);

3977 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3980 
	`É_´št
(
out
,
Ëmp
,Ëmp->
exŒacode
,&
lš’o
);

3982 
	`fşo£
(
š
);

3983 
	`fşo£
(
out
);

3985 
	}
}

3988 
	$R•ÜtH—d”
(
Ëmp
)

3989 
ËmÚ
 *
Ëmp
;

3991 
FILE
 *
out
, *
š
;

3992 *
´efix
;

3993 
lše
[
LINESIZE
];

3994 
·‰”n
[
LINESIZE
];

3995 
i
;

3997 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3998 
´efix
 = "";

3999 
š
 = 
	`fe_İ’
(
Ëmp
,".h","rb");

4000 ifĞ
š
 ){

4001 
i
=1; i<
Ëmp
->
Á”mš®
 && 
	`fg‘s
(
lše
,
LINESIZE
,
š
); i++){

4002 
	`¥rštf
(
·‰”n
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

4003 ifĞ
	`¡rcmp
(
lše
,
·‰”n
) ) ;

4005 
	`fşo£
(
š
);

4006 ifĞ
i
==
Ëmp
->
Á”mš®
 ){

4011 
out
 = 
	`fe_İ’
(
Ëmp
,".h","wb");

4012 ifĞ
out
 ){

4013 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

4014 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

4016 
	`fşo£
(
out
);

4019 
	}
}

4028 
	$Com´essTabËs
(
Ëmp
)

4029 
ËmÚ
 *
Ëmp
;

4031 
¡©e
 *
¡p
;

4032 
aùiÚ
 *
­
, *
­2
;

4033 
ruË
 *
½
, *
½2
, *
rbe¡
;

4034 
nbe¡
, 
n
;

4035 
i
;

4036 
u£sWdÿrd
;

4038 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4039 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

4040 
nbe¡
 = 0;

4041 
rbe¡
 = 0;

4042 
u£sWdÿrd
 = 0;

4044 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4045 ifĞ
­
->
ty³
==
SHIFT
 &&‡p->
¥
==
Ëmp
->
wdÿrd
 ){

4046 
u£sWdÿrd
 = 1;

4048 ifĞ
­
->
ty³
!=
REDUCE
 ) ;

4049 
½
 = 
­
->
x
.rp;

4050 ifĞ
½
->
lhsS¹
 ) ;

4051 ifĞ
½
==
rbe¡
 ) ;

4052 
n
 = 1;

4053 
­2
=
­
->
Ãxt
;‡p2;‡p2=ap2->next){

4054 ifĞ
­2
->
ty³
!=
REDUCE
 ) ;

4055 
½2
 = 
­2
->
x
.
½
;

4056 ifĞ
½2
==
rbe¡
 ) ;

4057 ifĞ
½2
==
½
 ) 
n
++;

4059 ifĞ
n
>
nbe¡
 ){

4060 
nbe¡
 = 
n
;

4061 
rbe¡
 = 
½
;

4069 ifĞ
nbe¡
<1 || 
u£sWdÿrd
 ) ;

4073 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4074 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 ) ;

4076 
	`as£¹
Ğ
­
 );

4077 
­
->
¥
 = 
	`SymbŞ_Ãw
("{default}");

4078 
­
÷p->
Ãxt
;‡p;‡p=ap->next){

4079 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 )‡p->ty³ = 
NOT_USED
;

4081 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

4083 
	}
}

4092 
	$¡©eResÜtCom·»
(cÚ¡ *
a
, cÚ¡ *
b
){

4093 cÚ¡ 
¡©e
 *
pA
 = *(cÚ¡ ¡©e**)
a
;

4094 cÚ¡ 
¡©e
 *
pB
 = *(cÚ¡ ¡©e**)
b
;

4095 
n
;

4097 
n
 = 
pB
->
nNtAù
 - 
pA
->nNtAct;

4098 ifĞ
n
==0 ){

4099 
n
 = 
pB
->
nTknAù
 - 
pA
->nTknAct;

4101  
n
;

4102 
	}
}

4109 
	$ResÜtS‹s
(
Ëmp
)

4110 
ËmÚ
 *
Ëmp
;

4112 
i
;

4113 
¡©e
 *
¡p
;

4114 
aùiÚ
 *
­
;

4116 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4117 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

4118 
¡p
->
nTknAù
 = s->
nNtAù
 = 0;

4119 
¡p
->
iDæt
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
;

4120 
¡p
->
iTknOf¡
 = 
NO_OFFSET
;

4121 
¡p
->
iNtOf¡
 = 
NO_OFFSET
;

4122 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4123 ifĞ
	`compu‹_aùiÚ
(
Ëmp
,
­
)>=0 ){

4124 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ){

4125 
¡p
->
nTknAù
++;

4126 }ifĞ
­
->
¥
->
šdex
<
Ëmp
->
nsymbŞ
 ){

4127 
¡p
->
nNtAù
++;

4129 
¡p
->
iDæt
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

4134 
	`qsÜt
(&
Ëmp
->
sÜ‹d
[1],†emp->
n¡©e
-1, (lemp->sorted[0]),

4135 
¡©eResÜtCom·»
);

4136 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4137 
Ëmp
->
sÜ‹d
[
i
]->
¡©’um
 = i;

4139 
	}
}

4147 
	gsize
 = 0;

4150 
	$S‘Size
(
n
)

4151 
n
;

4153 
size
 = 
n
+1;

4154 
	}
}

4157 *
	$S‘New
(){

4158 *
s
;

4159 
s
 = (*)
	`ÿÎoc
Ğ
size
, 1);

4160 ifĞ
s
==0 ){

4161 
	`memÜy_”rÜ
();

4162 
	`memÜy_”rÜ
();

4164  
s
;

4165 
	}
}

4168 
	$S‘F»e
(
s
)

4169 *
s
;

4171 
	`ä“
(
s
);

4172 
	}
}

4176 
	$S‘Add
(
s
,
e
)

4177 *
s
;

4178 
e
;

4180 
rv
;

4181 
	`as£¹
Ğ
e
>=0 &&ƒ<
size
 );

4182 
rv
 = 
s
[
e
];

4183 
s
[
e
] = 1;

4184  !
rv
;

4185 
	}
}

4188 
	$S‘UniÚ
(
s1
,
s2
)

4189 *
s1
;

4190 *
s2
;

4192 
i
, 
´og»ss
;

4193 
´og»ss
 = 0;

4194 
i
=0; i<
size
; i++){

4195 ifĞ
s2
[
i
]==0 ) ;

4196 ifĞ
s1
[
i
]==0 ){

4197 
´og»ss
 = 1;

4198 
s1
[
i
] = 1;

4201  
´og»ss
;

4202 
	}
}

4216 
PRIVATE
 
	$¡rhash
(
x
)

4217 *
x
;

4219 
h
 = 0;

4220  *
x
è
h
 = h*13 + *(x++);

4221  
h
;

4222 
	}
}

4228 *
	$SŒ§ã
(
y
)

4229 *
y
;

4231 *
z
;

4233 ifĞ
y
==0 )  0;

4234 
z
 = 
	`SŒ§ã_fšd
(
y
);

4235 ifĞ
z
==0 && (z=
	`m®loc
Ğ
	`ËmÚSŒËn
(
y
)+1 ))!=0 ){

4236 
	`¡rıy
(
z
,
y
);

4237 
	`SŒ§ã_š£¹
(
z
);

4239 
	`MemÜyCheck
(
z
);

4240  
z
;

4241 
	}
}

4246 
	ss_x1
 {

4247 
	msize
;

4250 
	mcouÁ
;

4251 
s_x1node
 *
	mtbl
;

4252 
s_x1node
 **
	mht
;

4258 
	ss_x1node
 {

4259 *
	md©a
;

4260 
s_x1node
 *
	mÃxt
;

4261 
s_x1node
 **
	mäom
;

4262 } 
	tx1node
;

4265 
s_x1
 *
	gx1a
;

4268 
	$SŒ§ã_š™
(){

4269 ifĞ
x1a
 ) ;

4270 
x1a
 = (
s_x1
*)
	`m®loc
( (s_x1) );

4271 ifĞ
x1a
 ){

4272 
x1a
->
size
 = 1024;

4273 
x1a
->
couÁ
 = 0;

4274 
x1a
->
tbl
 = (
x1node
*)
	`m®loc
(

4275 ((
x1node
) + (x1node*))*1024 );

4276 ifĞ
x1a
->
tbl
==0 ){

4277 
	`ä“
(
x1a
);

4278 
x1a
 = 0;

4280 
i
;

4281 
x1a
->
ht
 = (
x1node
**)&(x1a->
tbl
[1024]);

4282 
i
=0; i<1024; i++è
x1a
->
ht
[i] = 0;

4285 
	}
}

4288 
	$SŒ§ã_š£¹
(
d©a
)

4289 *
d©a
;

4291 
x1node
 *
Å
;

4292 
h
;

4293 
ph
;

4295 ifĞ
x1a
==0 )  0;

4296 
ph
 = 
	`¡rhash
(
d©a
);

4297 
h
 = 
ph
 & (
x1a
->
size
-1);

4298 
Å
 = 
x1a
->
ht
[
h
];

4299  
Å
 ){

4300 ifĞ
	`¡rcmp
(
Å
->
d©a
,data)==0 ){

4305 
Å
 =‚p->
Ãxt
;

4307 ifĞ
x1a
->
couÁ
>=x1a->
size
 ){

4309 
i
,
size
;

4310 
s_x1
 
¬¿y
;

4311 
¬¿y
.
size
 = sizğ
x1a
->size*2;

4312 
¬¿y
.
couÁ
 = 
x1a
->count;

4313 
¬¿y
.
tbl
 = (
x1node
*)
	`m®loc
(

4314 ((
x1node
è+ (x1node*))*
size
 );

4315 ifĞ
¬¿y
.
tbl
==0 )  0;

4316 
¬¿y
.
ht
 = (
x1node
**)&×¼ay.
tbl
[
size
]);

4317 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4318 
i
=0; i<
x1a
->
couÁ
; i++){

4319 
x1node
 *
ŞdÅ
, *
ÃwÅ
;

4320 
ŞdÅ
 = &(
x1a
->
tbl
[
i
]);

4321 
h
 = 
	`¡rhash
(
ŞdÅ
->
d©a
è& (
size
-1);

4322 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4323 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4324 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4325 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4326 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4327 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4329 
	`ä“
(
x1a
->
tbl
);

4330 *
x1a
 = 
¬¿y
;

4333 
h
 = 
ph
 & (
x1a
->
size
-1);

4334 
Å
 = &(
x1a
->
tbl
[x1a->
couÁ
++]);

4335 
Å
->
d©a
 = data;

4336 ifĞ
x1a
->
ht
[
h
] ) x1a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4337 
Å
->
Ãxt
 = 
x1a
->
ht
[
h
];

4338 
x1a
->
ht
[
h
] = 
Å
;

4339 
Å
->
äom
 = &(
x1a
->
ht
[
h
]);

4341 
	}
}

4345 *
	$SŒ§ã_fšd
(
key
)

4346 *
key
;

4348 
h
;

4349 
x1node
 *
Å
;

4351 ifĞ
x1a
==0 )  0;

4352 
h
 = 
	`¡rhash
(
key
è& (
x1a
->
size
-1);

4353 
Å
 = 
x1a
->
ht
[
h
];

4354  
Å
 ){

4355 ifĞ
	`¡rcmp
(
Å
->
d©a
,
key
)==0 ) ;

4356 
Å
 =‚p->
Ãxt
;

4358  
Å
 ?‚p->
d©a
 : 0;

4359 
	}
}

4364 
symbŞ
 *
	$SymbŞ_Ãw
(
x
)

4365 *
x
;

4367 
symbŞ
 *
¥
;

4369 
¥
 = 
	`SymbŞ_fšd
(
x
);

4370 ifĞ
¥
==0 ){

4371 
¥
 = (
symbŞ
 *)
	`ÿÎoc
(1, (symbol) );

4372 
	`MemÜyCheck
(
¥
);

4373 
¥
->
Çme
 = 
	`SŒ§ã
(
x
);

4374 
¥
->
ty³
 = 
	`isuµ”
(*
x
è? 
TERMINAL
 : 
NONTERMINAL
;

4375 
¥
->
ruË
 = 0;

4376 
¥
->
çÎback
 = 0;

4377 
¥
->
´ec
 = -1;

4378 
¥
->
assoc
 = 
UNK
;

4379 
¥
->
fœ¡£t
 = 0;

4380 
¥
->
Ïmbda
 = 
LEMON_FALSE
;

4381 
¥
->
de¡ruùÜ
 = 0;

4382 
¥
->
de¡Lš’o
 = 0;

4383 
¥
->
d©©y³
 = 0;

4384 
¥
->
u£CÁ
 = 0;

4385 
	`SymbŞ_š£¹
(
¥
,¥->
Çme
);

4387 
¥
->
u£CÁ
++;

4388  
¥
;

4389 
	}
}

4401 
	$SymbŞcmµ
(
symbŞ
 **
a
, symbŞ **
b
){

4402 
i1
 = (**
a
).
šdex
 + 10000000*((**a).
Çme
[0]>'Z');

4403 
i2
 = (**
b
).
šdex
 + 10000000*((**b).
Çme
[0]>'Z');

4404  
i1
-
i2
;

4405 
	}
}

4410 
	ss_x2
 {

4411 
	msize
;

4414 
	mcouÁ
;

4415 
s_x2node
 *
	mtbl
;

4416 
s_x2node
 **
	mht
;

4422 
	ss_x2node
 {

4423 
symbŞ
 *
	md©a
;

4424 *
	mkey
;

4425 
s_x2node
 *
	mÃxt
;

4426 
s_x2node
 **
	mäom
;

4427 } 
	tx2node
;

4430 
s_x2
 *
	gx2a
;

4433 
	$SymbŞ_š™
(){

4434 ifĞ
x2a
 ) ;

4435 
x2a
 = (
s_x2
*)
	`m®loc
( (s_x2) );

4436 ifĞ
x2a
 ){

4437 
x2a
->
size
 = 128;

4438 
x2a
->
couÁ
 = 0;

4439 
x2a
->
tbl
 = (
x2node
*)
	`m®loc
(

4440 ((
x2node
) + (x2node*))*128 );

4441 ifĞ
x2a
->
tbl
==0 ){

4442 
	`ä“
(
x2a
);

4443 
x2a
 = 0;

4445 
i
;

4446 
x2a
->
ht
 = (
x2node
**)&(x2a->
tbl
[128]);

4447 
i
=0; i<128; i++è
x2a
->
ht
[i] = 0;

4450 
	}
}

4453 
	$SymbŞ_š£¹
(
d©a
,
key
)

4454 
symbŞ
 *
d©a
;

4455 *
key
;

4457 
x2node
 *
Å
;

4458 
h
;

4459 
ph
;

4461 ifĞ
x2a
==0 )  0;

4462 
ph
 = 
	`¡rhash
(
key
);

4463 
h
 = 
ph
 & (
x2a
->
size
-1);

4464 
Å
 = 
x2a
->
ht
[
h
];

4465  
Å
 ){

4466 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ){

4471 
Å
 =‚p->
Ãxt
;

4473 ifĞ
x2a
->
couÁ
>=x2a->
size
 ){

4475 
i
,
size
;

4476 
s_x2
 
¬¿y
;

4477 
¬¿y
.
size
 = sizğ
x2a
->size*2;

4478 
¬¿y
.
couÁ
 = 
x2a
->count;

4479 
¬¿y
.
tbl
 = (
x2node
*)
	`m®loc
(

4480 ((
x2node
è+ (x2node*))*
size
 );

4481 ifĞ
¬¿y
.
tbl
==0 )  0;

4482 
¬¿y
.
ht
 = (
x2node
**)&×¼ay.
tbl
[
size
]);

4483 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4484 
i
=0; i<
x2a
->
couÁ
; i++){

4485 
x2node
 *
ŞdÅ
, *
ÃwÅ
;

4486 
ŞdÅ
 = &(
x2a
->
tbl
[
i
]);

4487 
h
 = 
	`¡rhash
(
ŞdÅ
->
key
è& (
size
-1);

4488 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4489 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4490 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4491 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4492 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4493 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4494 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4496 
	`ä“
(
x2a
->
tbl
);

4497 *
x2a
 = 
¬¿y
;

4500 
h
 = 
ph
 & (
x2a
->
size
-1);

4501 
Å
 = &(
x2a
->
tbl
[x2a->
couÁ
++]);

4502 
Å
->
key
 = key;

4503 
Å
->
d©a
 = data;

4504 ifĞ
x2a
->
ht
[
h
] ) x2a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4505 
Å
->
Ãxt
 = 
x2a
->
ht
[
h
];

4506 
x2a
->
ht
[
h
] = 
Å
;

4507 
Å
->
äom
 = &(
x2a
->
ht
[
h
]);

4509 
	}
}

4513 
symbŞ
 *
	$SymbŞ_fšd
(
key
)

4514 *
key
;

4516 
h
;

4517 
x2node
 *
Å
;

4519 ifĞ
x2a
==0 )  0;

4520 
h
 = 
	`¡rhash
(
key
è& (
x2a
->
size
-1);

4521 
Å
 = 
x2a
->
ht
[
h
];

4522  
Å
 ){

4523 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ) ;

4524 
Å
 =‚p->
Ãxt
;

4526  
Å
 ?‚p->
d©a
 : 0;

4527 
	}
}

4530 
symbŞ
 *
	$SymbŞ_Nth
(
n
)

4531 
n
;

4533 
symbŞ
 *
d©a
;

4534 ifĞ
x2a
 && 
n
>0 &&‚<=x2a->
couÁ
 ){

4535 
d©a
 = 
x2a
->
tbl
[
n
-1].data;

4537 
d©a
 = 0;

4539  
d©a
;

4540 
	}
}

4543 
	$SymbŞ_couÁ
()

4545  
x2a
 ? x2a->
couÁ
 : 0;

4546 
	}
}

4551 
symbŞ
 **
	$SymbŞ_¬¿yof
()

4553 
symbŞ
 **
¬¿y
;

4554 
i
,
size
;

4555 ifĞ
x2a
==0 )  0;

4556 
size
 = 
x2a
->
couÁ
;

4557 
¬¿y
 = (
symbŞ
 **)
	`ÿÎoc
(
size
, (symbol *));

4558 ifĞ
¬¿y
 ){

4559 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x2a
->
tbl
[i].
d©a
;

4561  
¬¿y
;

4562 
	}
}

4565 
	$CÚfigcmp
(
a
,
b
)

4566 
cÚfig
 *
a
;

4567 
cÚfig
 *
b
;

4569 
x
;

4570 
x
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4571 ifĞ
x
==0 ) x = 
a
->
dÙ
 - 
b
->dot;

4572  
x
;

4573 
	}
}

4576 
PRIVATE
 
	$¡©ecmp
(
a
,
b
)

4577 
cÚfig
 *
a
;

4578 
cÚfig
 *
b
;

4580 
rc
;

4581 
rc
=0;„c==0 && 
a
 && 
b
;‡÷->
bp
, b=b->bp){

4582 
rc
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4583 ifĞ
rc
==0 )„øğ
a
->
dÙ
 - 
b
->dot;

4585 ifĞ
rc
==0 ){

4586 ifĞ
a
 ) 
rc
 = 1;

4587 ifĞ
b
 ) 
rc
 = -1;

4589  
rc
;

4590 
	}
}

4593 
PRIVATE
 
	$¡©ehash
(
a
)

4594 
cÚfig
 *
a
;

4596 
h
=0;

4597  
a
 ){

4598 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4599 
a
 =‡->
bp
;

4601  
h
;

4602 
	}
}

4605 
¡©e
 *
	$S‹_Ãw
()

4607 
¡©e
 *
Ãw
;

4608 
Ãw
 = (
¡©e
 *)
	`ÿÎoc
(1, (state) );

4609 
	`MemÜyCheck
(
Ãw
);

4610  
Ãw
;

4611 
	}
}

4616 
	ss_x3
 {

4617 
	msize
;

4620 
	mcouÁ
;

4621 
s_x3node
 *
	mtbl
;

4622 
s_x3node
 **
	mht
;

4628 
	ss_x3node
 {

4629 
¡©e
 *
	md©a
;

4630 
cÚfig
 *
	mkey
;

4631 
s_x3node
 *
	mÃxt
;

4632 
s_x3node
 **
	mäom
;

4633 } 
	tx3node
;

4636 
s_x3
 *
	gx3a
;

4639 
	$S‹_š™
(){

4640 ifĞ
x3a
 ) ;

4641 
x3a
 = (
s_x3
*)
	`m®loc
( (s_x3) );

4642 ifĞ
x3a
 ){

4643 
x3a
->
size
 = 128;

4644 
x3a
->
couÁ
 = 0;

4645 
x3a
->
tbl
 = (
x3node
*)
	`m®loc
(

4646 ((
x3node
) + (x3node*))*128 );

4647 ifĞ
x3a
->
tbl
==0 ){

4648 
	`ä“
(
x3a
);

4649 
x3a
 = 0;

4651 
i
;

4652 
x3a
->
ht
 = (
x3node
**)&(x3a->
tbl
[128]);

4653 
i
=0; i<128; i++è
x3a
->
ht
[i] = 0;

4656 
	}
}

4659 
	$S‹_š£¹
(
d©a
,
key
)

4660 
¡©e
 *
d©a
;

4661 
cÚfig
 *
key
;

4663 
x3node
 *
Å
;

4664 
h
;

4665 
ph
;

4667 ifĞ
x3a
==0 )  0;

4668 
ph
 = 
	`¡©ehash
(
key
);

4669 
h
 = 
ph
 & (
x3a
->
size
-1);

4670 
Å
 = 
x3a
->
ht
[
h
];

4671  
Å
 ){

4672 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ){

4677 
Å
 =‚p->
Ãxt
;

4679 ifĞ
x3a
->
couÁ
>=x3a->
size
 ){

4681 
i
,
size
;

4682 
s_x3
 
¬¿y
;

4683 
¬¿y
.
size
 = sizğ
x3a
->size*2;

4684 
¬¿y
.
couÁ
 = 
x3a
->count;

4685 
¬¿y
.
tbl
 = (
x3node
*)
	`m®loc
(

4686 ((
x3node
è+ (x3node*))*
size
 );

4687 ifĞ
¬¿y
.
tbl
==0 )  0;

4688 
¬¿y
.
ht
 = (
x3node
**)&×¼ay.
tbl
[
size
]);

4689 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4690 
i
=0; i<
x3a
->
couÁ
; i++){

4691 
x3node
 *
ŞdÅ
, *
ÃwÅ
;

4692 
ŞdÅ
 = &(
x3a
->
tbl
[
i
]);

4693 
h
 = 
	`¡©ehash
(
ŞdÅ
->
key
è& (
size
-1);

4694 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4695 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4696 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4697 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4698 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4699 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4700 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4702 
	`ä“
(
x3a
->
tbl
);

4703 *
x3a
 = 
¬¿y
;

4706 
h
 = 
ph
 & (
x3a
->
size
-1);

4707 
Å
 = &(
x3a
->
tbl
[x3a->
couÁ
++]);

4708 
Å
->
key
 = key;

4709 
Å
->
d©a
 = data;

4710 ifĞ
x3a
->
ht
[
h
] ) x3a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4711 
Å
->
Ãxt
 = 
x3a
->
ht
[
h
];

4712 
x3a
->
ht
[
h
] = 
Å
;

4713 
Å
->
äom
 = &(
x3a
->
ht
[
h
]);

4715 
	}
}

4719 
¡©e
 *
	$S‹_fšd
(
key
)

4720 
cÚfig
 *
key
;

4722 
h
;

4723 
x3node
 *
Å
;

4725 ifĞ
x3a
==0 )  0;

4726 
h
 = 
	`¡©ehash
(
key
è& (
x3a
->
size
-1);

4727 
Å
 = 
x3a
->
ht
[
h
];

4728  
Å
 ){

4729 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ) ;

4730 
Å
 =‚p->
Ãxt
;

4732  
Å
 ?‚p->
d©a
 : 0;

4733 
	}
}

4738 
¡©e
 **
	$S‹_¬¿yof
()

4740 
¡©e
 **
¬¿y
;

4741 
i
,
size
;

4742 ifĞ
x3a
==0 )  0;

4743 
size
 = 
x3a
->
couÁ
;

4744 
¬¿y
 = (
¡©e
 **)
	`m®loc
Ğ(¡©*)*
size
 );

4745 ifĞ
¬¿y
 ){

4746 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x3a
->
tbl
[i].
d©a
;

4748  
¬¿y
;

4749 
	}
}

4752 
PRIVATE
 
	$cÚfighash
(
a
)

4753 
cÚfig
 *
a
;

4755 
h
=0;

4756 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4757  
h
;

4758 
	}
}

4763 
	ss_x4
 {

4764 
	msize
;

4767 
	mcouÁ
;

4768 
s_x4node
 *
	mtbl
;

4769 
s_x4node
 **
	mht
;

4775 
	ss_x4node
 {

4776 
cÚfig
 *
	md©a
;

4777 
s_x4node
 *
	mÃxt
;

4778 
s_x4node
 **
	mäom
;

4779 } 
	tx4node
;

4782 
s_x4
 *
	gx4a
;

4785 
	$CÚfigbË_š™
(){

4786 ifĞ
x4a
 ) ;

4787 
x4a
 = (
s_x4
*)
	`m®loc
( (s_x4) );

4788 ifĞ
x4a
 ){

4789 
x4a
->
size
 = 64;

4790 
x4a
->
couÁ
 = 0;

4791 
x4a
->
tbl
 = (
x4node
*)
	`m®loc
(

4792 ((
x4node
) + (x4node*))*64 );

4793 ifĞ
x4a
->
tbl
==0 ){

4794 
	`ä“
(
x4a
);

4795 
x4a
 = 0;

4797 
i
;

4798 
x4a
->
ht
 = (
x4node
**)&(x4a->
tbl
[64]);

4799 
i
=0; i<64; i++è
x4a
->
ht
[i] = 0;

4802 
	}
}

4805 
	$CÚfigbË_š£¹
(
d©a
)

4806 
cÚfig
 *
d©a
;

4808 
x4node
 *
Å
;

4809 
h
;

4810 
ph
;

4812 ifĞ
x4a
==0 )  0;

4813 
ph
 = 
	`cÚfighash
(
d©a
);

4814 
h
 = 
ph
 & (
x4a
->
size
-1);

4815 
Å
 = 
x4a
->
ht
[
h
];

4816  
Å
 ){

4817 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,data)==0 ){

4822 
Å
 =‚p->
Ãxt
;

4824 ifĞ
x4a
->
couÁ
>=x4a->
size
 ){

4826 
i
,
size
;

4827 
s_x4
 
¬¿y
;

4828 
¬¿y
.
size
 = sizğ
x4a
->size*2;

4829 
¬¿y
.
couÁ
 = 
x4a
->count;

4830 
¬¿y
.
tbl
 = (
x4node
*)
	`m®loc
(

4831 ((
x4node
è+ (x4node*))*
size
 );

4832 ifĞ
¬¿y
.
tbl
==0 )  0;

4833 
¬¿y
.
ht
 = (
x4node
**)&×¼ay.
tbl
[
size
]);

4834 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4835 
i
=0; i<
x4a
->
couÁ
; i++){

4836 
x4node
 *
ŞdÅ
, *
ÃwÅ
;

4837 
ŞdÅ
 = &(
x4a
->
tbl
[
i
]);

4838 
h
 = 
	`cÚfighash
(
ŞdÅ
->
d©a
è& (
size
-1);

4839 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4840 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4841 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4842 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4843 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4844 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4846 
	`ä“
(
x4a
->
tbl
);

4847 *
x4a
 = 
¬¿y
;

4850 
h
 = 
ph
 & (
x4a
->
size
-1);

4851 
Å
 = &(
x4a
->
tbl
[x4a->
couÁ
++]);

4852 
Å
->
d©a
 = data;

4853 ifĞ
x4a
->
ht
[
h
] ) x4a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4854 
Å
->
Ãxt
 = 
x4a
->
ht
[
h
];

4855 
x4a
->
ht
[
h
] = 
Å
;

4856 
Å
->
äom
 = &(
x4a
->
ht
[
h
]);

4858 
	}
}

4862 
cÚfig
 *
	$CÚfigbË_fšd
(
key
)

4863 
cÚfig
 *
key
;

4865 
h
;

4866 
x4node
 *
Å
;

4868 ifĞ
x4a
==0 )  0;

4869 
h
 = 
	`cÚfighash
(
key
è& (
x4a
->
size
-1);

4870 
Å
 = 
x4a
->
ht
[
h
];

4871  
Å
 ){

4872 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,
key
)==0 ) ;

4873 
Å
 =‚p->
Ãxt
;

4875  
Å
 ?‚p->
d©a
 : 0;

4876 
	}
}

4880 
	$CÚfigbË_ş—r
(
f
)

4881 (*
f
)( );

4883 
i
;

4884 ifĞ
x4a
==0 || x4a->
couÁ
==0 ) ;

4885 ifĞ
f
 ) 
i
=0; i<
x4a
->
couÁ
; i++è(*f)(x4a->
tbl
[i].
d©a
);

4886 
i
=0; i<
x4a
->
size
; i++èx4a->
ht
[i] = 0;

4887 
x4a
->
couÁ
 = 0;

4889 
	}
}

	@examples/kegogi/lempar.c

6 
	~<¡dio.h
>

7 %% /* 
	$yy·r£
 */ 
	`yyËx
()

18 
	}
%%

21 #iâdeà
INTERFACE


22 
	#INTERFACE
 1

	)

58 %% /* 
	$yy·r£
 */ 
	`yyËx
()

59 #
defše
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

60 #
defše
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

61 #
defše
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

65 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

75 #
iâdef
 
yy‹¡ÿ£


76 #
defše
 
	`yy‹¡ÿ£
(
X
)

77 #
’dif


127 
	}
%%

128 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

140 #ifdeà
YYFALLBACK


141 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

142 %% /* 
	$yy·r£
 */ 
	`yyËx
()

144 #
’dif


158 
	syySckEÁry
 {

159 
YYACTIONTYPE
 
	m¡©’o
;

160 
YYCODETYPE
 
	mmajÜ
;

162 
YYMINORTYPE
 
	mmšÜ
;

165 
yySckEÁry
 
	tyySckEÁry
;

169 
	syyP¬£r
 {

170 
	myyidx
;

171 #
ifdef
 
YYTRACKMAXSTACKDEPTH


172 
	myyidxMax
;

173 #
’dif


174 
	myy”rút
;

175 
	mP¬£ARG_SDECL


176 #
YYSTACKDEPTH
<=0

177 
	myy¡ksz
;

178 
yySckEÁry
 *
	myy¡ack
;

180 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

181 #
’dif


183 
yyP¬£r
 
	tyyP¬£r
;

185 #
iâdef
 
NDEBUG


186 #
šşude
 <
¡dio
.
h
>

187 
FILE
 *
	gyyT¿ûFILE
 = 0;

188 *
	gyyT¿ûProm±
 = 0;

189 #
’dif


191 #
iâdef
 
NDEBUG


209 
	`P¬£T¿û
(
FILE
 *
	gT¿ûFILE
, *
	gzT¿ûProm±
){

210 
	gyyT¿ûFILE
 = 
T¿ûFILE
;

211 
	gyyT¿ûProm±
 = 
zT¿ûProm±
;

212 ifĞ
	gyyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

213 ifĞ
	gyyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

215 #
’dif


217 #
iâdef
 
NDEBUG


220 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

221 
	}
%%

225 #iâdeà
NDEBUG


228 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

229 %% /* 
	$yy·r£
 */ 
	`yyËx
()

231 #
’dif


234 #
YYSTACKDEPTH
<=0

238 
	`yyGrowSck
(
yyP¬£r
 *
	gp
){

239 
	gÃwSize
;

240 
yySckEÁry
 *
	gpNew
;

242 
	gÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

243 
	gpNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

244 ifĞ
	gpNew
 ){

245 
	gp
->
	gyy¡ack
 = 
pNew
;

246 
	gp
->
	gyy¡ksz
 = 
ÃwSize
;

247 #
iâdef
 
NDEBUG


248 ifĞ
	gyyT¿ûFILE
 ){

249 
	`årštf
(
	gyyT¿ûFILE
,"%sStack growso %dƒntries!\n",

250 
	gyyT¿ûProm±
, 
	gp
->
	gyy¡ksz
);

252 #
’dif


255 #
’dif


269 *
	`P¬£AÎoc
(*(*
	gm®locProc
)(
	gsize_t
)){

270 
yyP¬£r
 *
	gpP¬£r
;

271 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

272 ifĞ
	gpP¬£r
 ){

273 
	gpP¬£r
->
	gyyidx
 = -1;

274 #
ifdef
 
YYTRACKMAXSTACKDEPTH


275 
	gpP¬£r
->
	gyyidxMax
 = 0;

276 #
’dif


277 #
YYSTACKDEPTH
<=0

278 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

279 
	gpP¬£r
->
	gyy¡ksz
 = 0;

280 
	`yyGrowSck
(
	gpP¬£r
);

281 #
’dif


283  
	gpP¬£r
;

291 
	`yy_de¡ruùÜ
(

292 
yyP¬£r
 *
	gyypP¬£r
,

293 
YYCODETYPE
 
	gyymajÜ
,

294 
YYMINORTYPE
 *
	gyypmšÜ


296 
	gP¬£ARG_FETCH
;

297  
	gyymajÜ
 ){

308 
	}
%%

321 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

322 
YYCODETYPE
 
yymajÜ
;

323 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

325 ifĞ
pP¬£r
->
yyidx
<0 )  0;

326 #iâdeà
NDEBUG


327 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

328 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

329 
yyT¿ûProm±
,

330 
yyTok’Name
[
yytos
->
majÜ
]);

333 
yymajÜ
 = 
yytos
->
majÜ
;

334 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

335 
pP¬£r
->
yyidx
--;

336  
yymajÜ
;

337 
	}
}

351 
P¬£F»e
(

352 *
p
,

353 (*
ä“Proc
)(*)

355 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

356 ifĞ
pP¬£r
==0 ) ;

357  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

358 #ià
YYSTACKDEPTH
<=0

359 
	`ä“
(
pP¬£r
->
yy¡ack
);

361 (*
ä“Proc
)((*)
pP¬£r
);

362 
	}
}

367 #ifdeà
YYTRACKMAXSTACKDEPTH


368 
	$P¬£SckP—k
(*
p
){

369 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

370  
pP¬£r
->
yyidxMax
;

371 
	}
}

382 
	$yy_fšd_shiá_aùiÚ
(

383 
yyP¬£r
 *
pP¬£r
,

384 
YYCODETYPE
 
iLookAh—d


386 
i
;

387 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

389 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

390  
yy_deçuÉ
[
¡©’o
];

392 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

393 
i
 +ğ
iLookAh—d
;

394 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

395 ifĞ
iLookAh—d
>0 ){

396 #ifdeà
YYFALLBACK


397 
YYCODETYPE
 
iF®lback
;

398 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

399 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

400 #iâdeà
NDEBUG


401 ifĞ
yyT¿ûFILE
 ){

402 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

403 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

406  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

409 #ifdeà
YYWILDCARD


411 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

412 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

413 #iâdeà
NDEBUG


414 ifĞ
yyT¿ûFILE
 ){

415 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

416 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

419  
yy_aùiÚ
[
j
];

424  
yy_deçuÉ
[
¡©’o
];

426  
yy_aùiÚ
[
i
];

428 
	}
}

438 
	$yy_fšd_»duû_aùiÚ
(

439 
¡©’o
,

440 
YYCODETYPE
 
iLookAh—d


442 
i
;

443 #ifdeà
YYERRORSYMBOL


444 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

445  
yy_deçuÉ
[
¡©’o
];

448 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

450 
i
 = 
yy_»duû_of¡
[
¡©’o
];

451 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

452 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

453 
i
 +ğ
iLookAh—d
;

454 #ifdeà
YYERRORSYMBOL


455 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

456  
yy_deçuÉ
[
¡©’o
];

459 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

460 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

462  
yy_aùiÚ
[
i
];

463 
	}
}

468 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

469 
P¬£ARG_FETCH
;

470 
yypP¬£r
->
yyidx
--;

471 #iâdeà
NDEBUG


472 ifĞ
yyT¿ûFILE
 ){

473 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

476  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

479 %% /* 
	$yy·r£
 */ 
	`yyËx
()

480 
P¬£ARG_STORE
;

481 
	}
}

486 
	`yy_shiá
(

487 
yyP¬£r
 *
	gyypP¬£r
,

488 
	gyyNewS‹
,

489 
	gyyMajÜ
,

490 
YYMINORTYPE
 *
	gyypMšÜ


492 
yySckEÁry
 *
	gyytos
;

493 
	gyypP¬£r
->
	gyyidx
++;

494 #
ifdef
 
YYTRACKMAXSTACKDEPTH


495 ifĞ
	gyypP¬£r
->
	gyyidx
>yypP¬£r->
	gyyidxMax
 ){

496 
	gyypP¬£r
->
	gyyidxMax
 = 
yypP¬£r
->
yyidx
;

498 #
’dif


499 #
YYSTACKDEPTH
>0

500 ifĞ
	gyypP¬£r
->
	gyyidx
>=
YYSTACKDEPTH
 ){

501 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

505 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

506 
	`yyGrowSck
(
yypP¬£r
);

507 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

508 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

512 #
’dif


513 
	gyytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

514 
	gyytos
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

515 
	gyytos
->
	gmajÜ
 = (
YYCODETYPE
)
yyMajÜ
;

516 
	gyytos
->
	gmšÜ
 = *
yypMšÜ
;

517 #
iâdef
 
NDEBUG


518 ifĞ
	gyyT¿ûFILE
 && 
	gyypP¬£r
->
	gyyidx
>0 ){

519 
	gi
;

520 
	`årštf
(
	gyyT¿ûFILE
,"%sShiá %d\n",
	gyyT¿ûProm±
,
	gyyNewS‹
);

521 
	`årštf
(
	gyyT¿ûFILE
,"%sSck:",
	gyyT¿ûProm±
);

522 
	gi
=1; i<=
yypP¬£r
->
yyidx
; i++)

523 
	`årštf
(
	gyyT¿ûFILE
," %s",
	gyyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
	gmajÜ
]);

524 
	`årštf
(
	gyyT¿ûFILE
,"\n");

526 #
’dif


533 
YYCODETYPE
 
	mlhs
;

534 
	mÄhs
;

535 } 
	gyyRuËInfo
[] = {

536 
	}
%%

539 
yy_acû±
(
yyP¬£r
*);

545 
	$yy_»duû
(

546 
yyP¬£r
 *
yypP¬£r
,

547 
yyruËno


549 
yygÙo
;

550 
yyaù
;

551 
YYMINORTYPE
 
yygÙomšÜ
;

552 
yySckEÁry
 *
yym¥
;

553 
yysize
;

554 
P¬£ARG_FETCH
;

555 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

556 #iâdeà
NDEBUG


557 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

558 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

559 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

560 
yyRuËName
[
yyruËno
]);

579 
yygÙomšÜ
 = 
yyz”omšÜ
;

582  
yyruËno
 ){

591 %% /* 
	$yy·r£
 */ 
	`yyËx
()

592 
	}
};

593 
	gyygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

594 
	gyysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

595 
	gyypP¬£r
->
	gyyidx
 -ğ
yysize
;

596 
	gyyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
	gYYCODETYPE
)
	gyygÙo
);

597 ifĞ
	gyyaù
 < 
	gYYNSTATE
 ){

598 #
ifdef
 
NDEBUG


603 ifĞ
	gyysize
 ){

604 
	gyypP¬£r
->
	gyyidx
++;

605 
	gyym¥
 -ğ
yysize
-1;

606 
	gyym¥
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

607 
	gyym¥
->
	gmajÜ
 = (
YYCODETYPE
)
yygÙo
;

608 
	gyym¥
->
	gmšÜ
 = 
yygÙomšÜ
;

610 #
’dif


612 
	`yy_shiá
(
	gyypP¬£r
,
	gyyaù
,
	gyygÙo
,&
	gyygÙomšÜ
);

615 
	`as£¹
Ğ
	gyyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

616 
	`yy_acû±
(
	gyypP¬£r
);

623 #
iâdef
 
YYNOERRORRECOVERY


624 
	`yy_·r£_çed
(

625 
yyP¬£r
 *
	gyypP¬£r


627 
	gP¬£ARG_FETCH
;

628 #
iâdef
 
NDEBUG


629 ifĞ
	gyyT¿ûFILE
 ){

630 
	`årštf
(
	gyyT¿ûFILE
,"%sFa!\n",
	gyyT¿ûProm±
);

632 #
’dif


633  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

636 
	}
%%

637 
	gP¬£ARG_STORE
;

644 
	$yy_syÁax_”rÜ
(

645 
yyP¬£r
 *
yypP¬£r
,

646 
yymajÜ
,

647 
YYMINORTYPE
 
yymšÜ


649 
P¬£ARG_FETCH
;

650 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

651 %% /* 
	$yy·r£
 */ 
	`yyËx
()

652 
P¬£ARG_STORE
;

653 
	}
}

658 
	`yy_acû±
(

659 
yyP¬£r
 *
	gyypP¬£r


661 
	gP¬£ARG_FETCH
;

662 #
iâdef
 
NDEBUG


663 ifĞ
	gyyT¿ûFILE
 ){

664 
	`årštf
(
	gyyT¿ûFILE
,"%sAcû±!\n",
	gyyT¿ûProm±
);

666 #
’dif


667  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

670 
	}
%%

671 
	gP¬£ARG_STORE
;

693 
	$P¬£
(

694 *
yyp
,

695 
yymajÜ
,

696 
P¬£TOKENTYPE
 
yymšÜ


697 
P¬£ARG_PDECL


699 
YYMINORTYPE
 
yymšÜuniÚ
;

700 
yyaù
;

701 
yy’dofšput
;

702 #ifdeà
YYERRORSYMBOL


703 
yy”rÜh™
 = 0;

705 
yyP¬£r
 *
yypP¬£r
;

708 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

709 ifĞ
yypP¬£r
->
yyidx
<0 ){

710 #ià
YYSTACKDEPTH
<=0

711 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

713 
yymšÜuniÚ
 = 
yyz”omšÜ
;

714 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

718 
yypP¬£r
->
yyidx
 = 0;

719 
yypP¬£r
->
yy”rút
 = -1;

720 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

721 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

723 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

724 
yy’dofšput
 = (
yymajÜ
==0);

725 
P¬£ARG_STORE
;

727 #iâdeà
NDEBUG


728 ifĞ
yyT¿ûFILE
 ){

729 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

734 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

735 ifĞ
yyaù
<
YYNSTATE
 ){

736 
	`as£¹
Ğ!
yy’dofšput
 );

737 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

738 
yypP¬£r
->
yy”rút
--;

739 
yymajÜ
 = 
YYNOCODE
;

740 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

741 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

743 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

744 #ifdeà
YYERRORSYMBOL


745 
yymx
;

747 #iâdeà
NDEBUG


748 ifĞ
yyT¿ûFILE
 ){

749 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

752 #ifdeà
YYERRORSYMBOL


772 ifĞ
yypP¬£r
->
yy”rút
<0 ){

773 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

775 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

776 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

777 #iâdeà
NDEBUG


778 ifĞ
yyT¿ûFILE
 ){

779 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

780 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

783 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

784 
yymajÜ
 = 
YYNOCODE
;

787 
yypP¬£r
->
yyidx
 >= 0 &&

788 
yymx
 !ğ
YYERRORSYMBOL
 &&

789 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

790 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

791 
YYERRORSYMBOL
)è>ğ
YYNSTATE


793 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

795 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

796 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

797 
	`yy_·r£_çed
(
yypP¬£r
);

798 
yymajÜ
 = 
YYNOCODE
;

799 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

800 
YYMINORTYPE
 
u2
;

801 
u2
.
YYERRSYMDT
 = 0;

802 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

805 
yypP¬£r
->
yy”rút
 = 3;

806 
yy”rÜh™
 = 1;

807 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

815 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

816 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

817 
yymajÜ
 = 
YYNOCODE
;

829 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

830 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

832 
yypP¬£r
->
yy”rút
 = 3;

833 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

834 ifĞ
yy’dofšput
 ){

835 
	`yy_·r£_çed
(
yypP¬£r
);

837 
yymajÜ
 = 
YYNOCODE
;

840 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

842 
	}
}

	@examples/kegogi/src/fuzzrnd.c

35 
	~<as£¹.h
>

36 
	~<¡ršg.h
>

37 
	~<ùy³.h
>

38 
	~<¡dlib.h
>

47 
	mi
,
	mj
;

48 
	msbox
[256];

49 } 
	gArcFour
;

67 *
	$FuzzRnd_d©a
(
size_t
 
Ën
)

70 
n
;

71 
a
,
b
;

72 *
p
 = 
NULL
;

74 
p
 = 
	`m®loc
(
Ën
);

76 
n
=0;n<
Ën
;n++)

78 
ArcFour
.
i
++;

79 
a
 = 
ArcFour
.
sbox
[ArcFour.
i
];

80 
ArcFour
.
j
 = (è(ArcFour.j + 
a
);

81 
b
 = 
ArcFour
.
sbox
[ArcFour.
j
];

82 
ArcFour
.
sbox
[ArcFour.
i
] = 
b
;

83 
ArcFour
.
sbox
[ArcFour.
j
] = 
a
;

84 
p
[
n
] = 
ArcFour
.
sbox
[(
a
+
b
) & 0xFF];

87  
p
;

88 
	}
}

103 
	$FuzzRnd_£ed
(*
key
, 
size_t
 
key_Ën
)

106 
t
, 
u
;

107 
keyšdex
;

108 
¡©ešdex
;

109 *
¡©e
;

110 
couÁ”
;

112 
¡©e
 = 
ArcFour
.
sbox
;

113 
ArcFour
.
i
 = 0;

114 
ArcFour
.
j
 = 0;

116 
couÁ”
 = 0; counter < 256; counter++)

117 
¡©e
[
couÁ”
] = counter;

119 
keyšdex
 = 0;

120 
¡©ešdex
 = 0;

121 
couÁ”
 = 0; counter < 256; counter++)

123 
t
 = 
¡©e
[
couÁ”
];

124 
¡©ešdex
 = (¡©ešdex + 
key
[
keyšdex
] + 
t
) & 0xff;

125 
u
 = 
¡©e
[
¡©ešdex
];

126 
¡©e
[
¡©ešdex
] = 
t
;

127 
¡©e
[
couÁ”
] = 
u
;

128 ià(++
keyšdex
 >ğ
key_Ën
)

129 
keyšdex
 = 0;

131 
	}
}

	@examples/kegogi/src/fuzzrnd.h

1 #iâdeà
_fuzzºd_h


2 
	#_fuzzºd_h


	)

4 
	~<¡dlib.h
>

6 *
FuzzRnd_d©a
(
size_t
 
Ën
);

8 
FuzzRnd_£ed
(*
key
, 
size_t
 
key_Ën
);

	@examples/kegogi/src/httpclient.c

1 
	~"h‰pş›Á.h
"

3 
	~<¡dlib.h
>

5 
	~<sk/sk.h
>

6 
	~<b¡ršg.h
>

7 
	~<dbg.h
>

8 
	~<h‰p11/h‰pş›Á_·r£r.h
>

10 
	~"kegogi.h
"

12 
	#FETCH_BUFFER_SIZE
 10 * 1024

	)

14 *
	gREQUEST_FORMAT
 =

20 
	$H—d”s_š™
(
H—d”s
 *
h—d”s
) {

21 if(!
h—d”s
)  -1;

22 
h—d”s
->
num_h—d”s
 = 0;

24 
	}
}

26 
	$H—d”s_ş—nup
(
H—d”s
 *
h—d”s
) {

27 
i
;

28 
i
 = 0; i < 
h—d”s
->
num_h—d”s
; i++) {

29 
	`bde¡roy
(
h—d”s
->h—d”s[
i
].
f›ld
);

30 
	`bde¡roy
(
h—d”s
->h—d”s[
i
].
v®ue
);

33 
	}
}

35 
	$H—d”s_add
(
H—d”s
 *
h—d”s
, 
b¡ršg
 
f›ld
, b¡ršg 
v®ue
) {

36 if(!
h—d”s
 || h—d”s->
num_h—d”s
 >ğ
MAX_NUM_HEADERS
)  -1;

37 
i
 = 
h—d”s
->
num_h—d”s
;

38 
h—d”s
->h—d”s[
i
].
f›ld
 = field;

39 
h—d”s
->h—d”s[
i
].
v®ue
 = value;

40 
h—d”s
->
num_h—d”s
++;

42 
	}
}

44 
Reque¡
 *
	$Reque¡_ü—‹
(
b¡ršg
 
ho¡
, 
pÜt
, b¡ršg 
m‘hod
, b¡ršg 
uri
) {

45 
Reque¡
 *
»q
 = 
	`m®loc
((*req));

46 
»q
->
ho¡
 = host;

47 
»q
->
pÜt
 =…ort;

48 
»q
->
m‘hod
 = method;

49 
»q
->
uri
 = uri;

50 
	`H—d”s_š™
(&
»q
->
h—d”s
);

51 
»q
->
h—d”s
.
num_h—d”s
 = 0;

52  
»q
;

53 
	}
}

55 
	$h‰p_f›ld
(*
d©a
, cÚ¡ *
f›ld
, 
size_t
 
æ’
,

56 cÚ¡ *
v®
, 
size_t
 
vËn
)

58 
Re¥Ú£
 *
r¥
 = (Re¥Ú£ *è
d©a
;

60 
b¡ršg
 
bF›ld
 = 
	`blk2b¡r
(
f›ld
, 
æ’
);

61 
b¡ršg
 
bV®
 = 
	`blk2b¡r
(
v®
, 
vËn
);

63 if(
	`bi£qc¡rÿ£Ëss
(
bF›ld
, "content-length"))

64 
r¥
->
cÚ‹Á_Ën
 = 
	`©oi
((*)
bV®
->
d©a
);

65 ià(
	`bi£qc¡rÿ£Ëss
(
bF›ld
, "transfer-encoding"))

66 
r¥
->
chunked_body
 = 
	`bi£qc¡rÿ£Ëss
(
bV®
, "chunked");

68 
	`check
(!
	`H—d”s_add
(&
r¥
->
h—d”s
, 
bF›ld
, 
bV®
), "Failedo‡dd headers");

71 
”rÜ
:

72 
	`bde¡roy
(
bF›ld
);

73 
	`bde¡roy
(
bV®
);

74 
	}
}

76 
	$¡©us_code
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ën
)

78 
Re¥Ú£
 *
r¥
 = (Re¥Ú£ *è
d©a
;

79 
b¡ršg
 
bs
 = 
	`blk2b¡r
(
©
, 
Ën
);

80 
r¥
->
¡©us_code
 = 
	`©oi
((*)
bs
->
d©a
);

81 
	`bde¡roy
(
bs
);

82 
	}
}

84 
	$h—d”_dÚe
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ën
)

86 
Re¥Ú£
 *
r¥
 = (Re¥Ú£ *è
d©a
;

87 
r¥
->
body_¡¬t
 = 
©
;

88 
r¥
->
body_so_çr
 = 
Ën
;

89 
	}
}

91 
	$–em’t_nİ
(*
_
, cÚ¡ *
__
, 
size_t
 
___
è{ 
	}
}

94 
šlše
 
	$Re¥Ú£_»ad_chunks
(
Re¥Ú£
 *
r¥
, 
Ä—d
, *
bufãr
, 
fd
)

96 
i
 = 0;

97 
r
 = 0;

98 
chunk_size
 = -1;

99 
»ad_some_of_chunk_size
 = 0;

101 if(
r¥
->
body_¡¬t
) {

102 
i
 = 
r¥
->
body_¡¬t
 - 
bufãr
;

104 
Ä—d
 = 
i
 = 0;

107 
chunk_size
 != 0) {

108 if(
i
 >ğ
Ä—d
) {

112 
i
 = (˜- 
Ä—d
);

113 
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
FETCH_BUFFER_SIZE
);

114 
	`check
(
Ä—d
 > 0, "Failedo fdrecv in chunk„eading");

117 if(
chunk_size
 == -1) {

118 
c
 = 
	`touµ”
(
bufãr
[
i
]);

119 
i
++;

121 if((
c
 >= 'A' && c <= 'F') || (c >= '0' && c <= '9')) {

122 
c
 = (c >= 'A') ? c - 'A' + 10 : c - '0';

123 
r
 = (¸* 16è+ 
c
;

124 
»ad_some_of_chunk_size
 = 1;

126 if(
»ad_some_of_chunk_size
) {

127 
chunk_size
 = 
r
;

128 
»ad_some_of_chunk_size
 = 
r
 = 0;

129 
i
++;

132 if(
chunk_size
 <ğ
Ä—d
 - 
i
) {

133 
	`bÿtblk
(
r¥
->
body
, 
bufãr
 + 
i
, 
chunk_size
);

134 
i
 +ğ
chunk_size
;

135 
chunk_size
 = -1;

138 
	`bÿtblk
(
r¥
->
body
, 
bufãr
 + 
i
, 
Ä—d
 - i);

139 
chunk_size
 -ğ(
Ä—d
 - 
i
);

140 
i
 = 
Ä—d
;

145 
”rÜ
:

147 
	}
}

149 
šlše
 
	$Re¥Ú£_»ad_body
(
Re¥Ú£
 *
r¥
, 
Ä—d
, *
bufãr
, 
fd
)

151 if(
r¥
->
cÚ‹Á_Ën
 == -1) {

152 (
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
FETCH_BUFFER_SIZE
)) > 0)

153 
	`bÿtblk
(
r¥
->
body
, 
bufãr
, 
Ä—d
);

155 if(
r¥
->
cÚ‹Á_Ën
 > 0) {

156 
ssize_t
 
»maššg
 = 
r¥
->
cÚ‹Á_Ën
 -„¥->
body_so_çr
;

157 
»maššg
 > 0) {

158 
ssize_t
 
tÜ—d
 = 
FETCH_BUFFER_SIZE
;

159 if(
tÜ—d
 > 
»maššg
)oread =„emaining;

160 
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
tÜ—d
);

161 
	`check
(
Ä—d
 > 0, "fd»cv faed w™h %d„emaššg", ()
»maššg
);

162 
	`bÿtblk
(
r¥
->
body
, 
bufãr
, 
Ä—d
);

163 
»maššg
 -ğ
Ä—d
;

165 
»maššg
 -ğ
r¥
->
body_so_çr
;

170 
”rÜ
:

172 
	}
}

174 
Re¥Ú£
 *
	$Re¥Ú£_ü—‹
()

176 
Re¥Ú£
 *
r¥
 = 
	`ÿÎoc
((*rsp), 1);

177 
	`check_mem
(
r¥
);

179 
	`H—d”s_š™
(&
r¥
->
h—d”s
);

180 
r¥
->
cÚ‹Á_Ën
 = -1;

181 
r¥
->
body
 = 
NULL
;

182 
r¥
->
¡©us_code
 = -1;

183 
r¥
->
chunked_body
 = 0;

184 
r¥
->
body
 = 
	`bäomc¡r
("");

185 
r¥
->
body_¡¬t
 = 
NULL
;

186 
r¥
->
body_so_çr
 = 0;

187  
r¥
;

189 
”rÜ
:

190 
	`Re¥Ú£_de¡roy
(
r¥
);

191  
NULL
;

192 
	}
}

194 
	$Re¥Ú£_£tup_·r£r
(
Re¥Ú£
 *
r¥
, 
h‰pş›Á_·r£r
 *
·r£r
)

196 
rc
 = 
	`h‰pş›Á_·r£r_š™
(
·r£r
);

197 
	`check
(
rc
, "Failedo init…arser.");

199 
·r£r
->
h‰p_f›ld
 = http_field;

200 
·r£r
->
»asÚ_ph¿£
 = 
–em’t_nİ
;

201 
·r£r
->
¡©us_code
 = status_code;

202 
·r£r
->
chunk_size
 = 
–em’t_nİ
;

203 
·r£r
->
h‰p_v”siÚ
 = 
–em’t_nİ
;

204 
·r£r
->
h—d”_dÚe
 = header_done;

205 
·r£r
->
Ï¡_chunk
 = 
–em’t_nİ
;

206 
·r£r
->
d©a
 = 
r¥
;

209 
”rÜ
:

211 
	}
}

214 
Re¥Ú£
 *
	$Re¥Ú£_ãtch
(
Reque¡
 *
»q
)

216 
fd
 = 0;

217 *
bufãr
 = 
NULL
;

218 
b¡ršg
 
»que¡
 = 
NULL
;

219 
h‰pş›Á_·r£r
 
·r£r
;

220 
Re¥Ú£
 *
r¥
 = 
NULL
;

222 
bufãr
 = 
	`m®loc
(
FETCH_BUFFER_SIZE
);

223 
	`check_mem
(
bufãr
);

225 
r¥
 = 
	`Re¥Ú£_ü—‹
();

226 
	`check
(
r¥
, "Failedo create Response.");

228 
	`check
(
	`Re¥Ú£_£tup_·r£r
(
r¥
, &
·r£r
) == 0, "Failedo setup…arser.");

230 
fd
 = 
	`ÃtdŸl
(
TCP
, 
	`bd©a
(
»q
->
ho¡
),„eq->
pÜt
);

231 
	`check
(
fd
 > 0, "FaedØcÚÃùØ% Ú…Üˆ%d.", 
	`bd©a
(
»q
->
ho¡
),

232 
»q
->
pÜt
);

234 
»que¡
 = 
	`bfÜm©
(
REQUEST_FORMAT
, 
	`bd©a
(
»q
->
m‘hod
),

235 
	`bd©a
(
»q
->
uri
), bd©aÔeq->
ho¡
));

236 
tÙ®£Á
 = 
	`fd£nd
(
fd
, 
	`bd©a
(
»que¡
), 
	`bËngth
(request));

237 
	`check
(
tÙ®£Á
 =ğ
	`bËngth
(
»que¡
), "Didn't send‡ll ofhe„equest.");

240 
ssize_t
 
Ä—d
 = 0;

241 
ssize_t
 
Å¬£d
 = 0;

242 !
	`h‰pş›Á_·r£r_fšish
(&
·r£r
)) {

243 
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
FETCH_BUFFER_SIZE
 - 1);

244 
	`check
(
Ä—d
 > 0, "Failedo get‡ll of headers");

245 
bufãr
[
Ä—d
] = '\0';

246 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(&
·r£r
, 
bufãr
, 
Ä—d
, 0);

248 
	`check
(
	`h‰pş›Á_·r£r_fšish
(&
·r£r
) == 1, "Didn't…arse.");

252 
Å¬£d
--;

254 if(
Å¬£d
 < 
Ä—d
)

255 
	`bÿtblk
(
r¥
->
body
, 
bufãr
 + 
Å¬£d
, 
Ä—d
 -‚parsed);

257 if(
r¥
->
chunked_body
) {

258 
	`check
(
	`Re¥Ú£_»ad_chunks
(
r¥
, 
Ä—d
, 
bufãr
, 
fd
) == 0, "Failedo„ead chunked„esponse.");

261 
	`check
(
	`Re¥Ú£_»ad_body
(
r¥
, 
Ä—d
, 
bufãr
, 
fd
) == 0, "Failedo„ead full body.");

264  
r¥
;

266 
”rÜ
:

267 
	`Re¥Ú£_de¡roy
(
r¥
);

268 if(
»que¡
è
	`bde¡roy
(request);

269 if(
bufãr
è
	`ä“
(buffer);

271  
NULL
;

272 
	}
}

275 
	$Reque¡_de¡roy
(
Reque¡
 *
»q
) {

276 if(
»q
) {

277 
	`bde¡roy
(
»q
->
ho¡
);

278 
	`bde¡roy
(
»q
->
uri
);

279 
	`bde¡roy
(
»q
->
m‘hod
);

280 
	`H—d”s_ş—nup
(&
»q
->
h—d”s
);

281 
	`ä“
(
»q
);

283 
	}
}

285 
	$Re¥Ú£_de¡roy
(
Re¥Ú£
 *
r¥
) {

286 if(
r¥
) {

287 if(
r¥
->
body
è
	`bde¡roy
(rsp->body);

288 
	`H—d”s_ş—nup
(&
r¥
->
h—d”s
);

289 
	`ä“
(
r¥
);

291 
	}
}

	@examples/kegogi/src/httpclient.h

1 #iâdeà
_HTTPCLIENT_H


2 
	#_HTTPCLIENT_H


	)

4 
	~<b¡ršg.h
>

6 
	#MAX_NUM_HEADERS
 128

	)

8 
	sH—d”
 {

9 
b¡ršg
 
	mf›ld
;

10 
b¡ršg
 
	mv®ue
;

11 } 
	tH—d”
;

13 
	sH—d”s
 {

14 
	mnum_h—d”s
;

15 
H—d”
 
	mh—d”s
[
MAX_NUM_HEADERS
];

16 } 
	tH—d”s
;

18 
	sReque¡
 {

19 
b¡ršg
 
	mho¡
;

20 
	mpÜt
;

21 
b¡ršg
 
	mm‘hod
;

22 
b¡ršg
 
	muri
;

23 
H—d”s
 
	mh—d”s
;

24 } 
	tReque¡
;

26 
	sRe¥Ú£
 {

27 
	m¡©us_code
;

28 
b¡ršg
 
	mbody
;

29 
H—d”s
 
	mh—d”s
;

30 
	mcÚ‹Á_Ën
;

31 cÚ¡ *
	mbody_¡¬t
;

32 
	mbody_so_çr
;

33 
	mchunked_body
;

34 } 
	tRe¥Ú£
;

36 
H—d”s_š™
(
H—d”s
 *
h—d”s
);

37 
H—d”s_ş—nup
(
H—d”s
 *
h—d”s
);

38 
H—d”s_add
(
H—d”s
 *
h—d”s
, 
b¡ršg
 
f›ld
, b¡ršg 
v®ue
);

40 
Reque¡
 *
Reque¡_ü—‹
(
b¡ršg
 
ho¡
, 
pÜt
, b¡ršg 
m‘hod
, b¡ršg 
uri
);

41 
Reque¡_de¡roy
(
Reque¡
 *
»q
);

43 
Re¥Ú£
 *
Re¥Ú£_ãtch
(
Reque¡
 *
»q
);

44 
Re¥Ú£_de¡roy
(
Re¥Ú£
 *
r¥
);

	@examples/kegogi/src/kegogi.c

1 
	~"kegogi.h
"

2 
	~"fuzzºd.h
"

3 
	~<h‰p11/h‰pş›Á_·r£r.h
>

4 
	~<dbg.h
>

5 
	~<sk/sk.h
>

6 
	~<b¡r/b¡¾ib.h
>

7 
	~<·‰”n.h
>

8 
	~<g‘İt.h
>

10 
	~"h‰pş›Á.h
"

11 
	~"kegogi_·r£r.h
"

12 
	~"kegogi_tok’s.h
"

14 
	#MAX_COMMANDS
 1024

	)

16 
gb¡ršg
 
	gDEFAULT_HOST_KEY
 = 
bsStic
("host");

17 
gb¡ršg
 
	gDEFAULT_PORT_KEY
 = 
bsStic
("port");

19 
v”ify_»¥Ú£
(
Ex³ù
 *
ex³ù
, 
Reque¡
 *
»q
, 
Re¥Ú£
 *
aùu®
);

20 
Reque¡
 *
ü—‹_»que¡
(
S’d
 *
£nd
, 
P¬amDiù
 *
deçuÉs
);

22 
	sRunKegogiArgs
 {

23 
b¡ršg
 
	msüt_·th
;

24 
	mnum_th»ads
;

25 
	m™”©iÚs_³r_th»ad
;

26 } 
	tRunKegogiArgs
;

28 
	sKegogiTe¡Args
 {

29 
	mnum_commªds
;

30 
Commªd
 *
	mcommªds
;

31 
P¬amDiù
 *
	mdeçuÉs
;

32 
	m‹¡s_³r_th»ad
;

33 
R’dez
 *
	m»ndez
;

34 
	mth»ads_ruÂšg
;

35 
	m·s£d
;

36 
	mçed
;

37 } 
	tKegogiTe¡Args
;

39 
	$kegog™e¡
(*
¬g
)

41 
KegogiTe¡Args
 *
¬gs
 = (KegogiTe¡Args*è
¬g
;

43 
i
;

44 
i
 = 0; i < 
¬gs
->
‹¡s_³r_th»ad
; i++) {

45 
n
 = 
i
 % 
¬gs
->
num_commªds
;

46 
Reque¡
 *
»q
 = 
	`ü—‹_»que¡
(&
¬gs
->
commªds
[
n
].
£nd
,‡rgs->
deçuÉs
);

48 
Re¥Ú£
 *
aùu®
 = 
	`Re¥Ú£_ãtch
(
»q
);

50 if(
	`v”ify_»¥Ú£
(&
¬gs
->
commªds
[
n
].
ex³ù
, 
»q
, 
aùu®
))

51 
¬gs
->
·s£d
++;

53 
¬gs
->
çed
++;

54 
	`Reque¡_de¡roy
(
»q
);

55 
	`Re¥Ú£_de¡roy
(
aùu®
);

58 
¬gs
->
th»ads_ruÂšg
--;

59 
	`skwakeup
(
¬gs
->
»ndez
);

61 
	`skex™
(0);

62 
	}
}

64 
	$runkegogi
(*
¬g
)

66 
RunKegogiArgs
 *
runArgs
 = (RunKegogiArg *è
¬g
;

68 
KegogiTe¡Args
 *
‹¡Args
 = 
	`ÿÎoc
((*testArgs), 1);

69 
	`check_mem
(
‹¡Args
);

71 
‹¡Args
->
·s£d
 = 0;

72 
‹¡Args
->
çed
 = 0;

76 
‹¡Args
->
»ndez
 = 
	`ÿÎoc
((*testArgs->rendez), 1);

78 
‹¡Args
->
th»ads_ruÂšg
 = 
runArgs
->
num_th»ads
;

79 
‹¡Args
->
commªds
 = 
	`ÿÎoc
((
Commªd
), 
MAX_COMMANDS
);

80 
	`check_mem
(
‹¡Args
->
commªds
);

82 
‹¡Args
->
num_commªds
 = 
	`·r£_kegogi_fe
(
	`bd©a
(
runArgs
->
süt_·th
),

83 
‹¡Args
->
commªds
,

84 
MAX_COMMANDS
,

85 &
‹¡Args
->
deçuÉs
);

86 
	`check
(
‹¡Args
->
num_commªds
 > 0, "No kegogiests in file");

87 
‹¡Args
->
‹¡s_³r_th»ad
 =

88 
runArgs
->
™”©iÚs_³r_th»ad
 * 
‹¡Args
->
num_commªds
;

90 
i
;

91 
i
 = 0; i < 
runArgs
->
num_th»ads
; i++)

92 
	`skü—‹
(
kegog™e¡
, 
‹¡Args
, 128 * 1024);

94 
‹¡Args
->
th»ads_ruÂšg
 > 0)

95 
	`sk¦“p
(
‹¡Args
->
»ndez
);

97 
	`´štf
("Pas£d %d oà%d\n", 
‹¡Args
->
·s£d
,

98 
‹¡Args
->
·s£d
 +e¡Args->
çed
);

100 
	`ä“
(
runArgs
);

101 
	`ä“
(
‹¡Args
);

103 
	`skex™®l
((
‹¡Args
->
çed
 > 0) ? 1 : 0);

106 
	`ä“
(
runArgs
);

107 
	`skex™
(0);

109 
”rÜ
:

110 if(
runArgs
è
	`ä“
(runArgs);

111 if(
‹¡Args
è
	`ä“
(testArgs);

113 
	`skex™®l
(1);

114 
	}
}

116 
Reque¡
 *
	$ü—‹_»que¡
(
S’d
 *
£nd
, 
P¬amDiù
 *
deçuÉs
)

118 
	`check
(
£nd
 !ğ
NULL
, "create_request cannot‡ccept NULL send‡rg");

119 
gb¡ršg
 
deçuÉ_ho¡_key
 = 
	`bsStic
("host");

120 
gb¡ršg
 
deçuÉ_pÜt_key
 = 
	`bsStic
("port");

121 
P¬am
 *
p
;

123 
b¡ršg
 
m‘hod
 = 
£nd
->method;

124 
	`check
(
m‘hod
 !ğ
NULL
, "Command must specify method");

126 
b¡ršg
 
uri
 = 
£nd
->uri;

127 
	`check
(
uri
 !ğ
NULL
, "Command must specify uri");

129 
b¡ršg
 
ho¡
 = 
£nd
->host;

130 if(
ho¡
 =ğ
NULL
) {

131 
p
 = 
	`P¬amDiù_g‘
(
deçuÉs
, &
deçuÉ_ho¡_key
);

132 if(
p
 &&…->
ty³
 =ğ
STRING
)

133 
ho¡
 = 
p
->
d©a
.
¡ršg
;

135 
	`check
(
ho¡
 !ğ
NULL
, "Command is missing host‡ndhere is‚o default");

137 
b¡ršg
 
pÜt
 = 
£nd
->port;

138 if(
pÜt
 =ğ
NULL
) {

139 
p
 = 
	`P¬amDiù_g‘
(
deçuÉs
, &
deçuÉ_pÜt_key
);

140 if(
p
 &&…->
ty³
 =ğ
STRING
)

141 
pÜt
 = 
p
->
d©a
.
¡ršg
;

145  
	`Reque¡_ü—‹
(
	`b¡rıy
(
ho¡
),

146 (
pÜt
 !ğ
NULL
è? 
	`©oi
(
	`bd©a
ÕÜt)è: 
DEFAULT_PORT
,

147 
	`b¡rıy
(
m‘hod
),

148 
	`b¡rıy
(
uri
));

150 
”rÜ
:

151  
NULL
;

152 
	}
}

154 
	$v”ify_»¥Ú£
(
Ex³ù
 *
ex³ù
, 
Reque¡
 *
»q
, 
Re¥Ú£
 *
aùu®
) {

155 
	`check
(
ex³ù
 !ğ
NULL
 && 
»q
 != NULL, "command‡nd„eq must‚ot be NULL");

156 
gb¡ršg
 
body_key
 = 
	`bsStic
("body");

158 if(
aùu®
 =ğ
NULL
) {

159 
	`´štf
("Fau» wh’ f‘chšg %s:%d%s\n", 
	`bd©a
(
»q
->
ho¡
),„eq->
pÜt
,

160 
	`bd©a
(
»q
->
uri
));

161 
	`´štf
(" Failedo„etrieve„esponse from server,‡ctual is NULL\n");

165 
ex³ùed_¡©us_code
 = 
	`©oi
(
	`bd©a
(
ex³ù
->
¡©us_code
));

166 if(
ex³ùed_¡©us_code
 !ğ
aùu®
->
¡©us_code
) {

167 
	`´štf
("Fau» wh’ f‘chšg %s:%d%s\n", 
	`bd©a
(
»q
->
ho¡
),„eq->
pÜt
,

168 
	`bd©a
(
»q
->
uri
));

169 
	`´štf
(" Stu codwa %d,ƒx³ùed %d\n", 
aùu®
->
¡©us_code
,

170 
ex³ùed_¡©us_code
);

175 
P¬am
 *
p
 = 
	`P¬amDiù_g‘
(
ex³ù
->
·¿ms
, &
body_key
);

176 if(
p
 !ğ
NULL
) {

177 
·ss
 = 0;

178 if(
p
->
ty³
 =ğ
PATTERN
)

179 
·ss
 = (
	`b¡ršg_m©ch
(
aùu®
->
body
, 
p
->
d©a
.
·‰”n
è!ğ
NULL
);

180 if(
p
->
ty³
 =ğ
STRING
)

181 
·ss
 = (
	`b¡rcmp
(
aùu®
->
body
, 
p
->
d©a
.
¡ršg
) == 0);

183 if(!
·ss
) {

184 
	`´štf
("Fau» wh’ f‘chšg %s:%d%s\n", 
	`bd©a
(
»q
->
ho¡
),

185 
»q
->
pÜt
, 
	`bd©a
Ôeq->
uri
));

186 
	`´štf
(" Aùu®: \"%s\"\n", 
	`bd©a
(
aùu®
->
body
));

187 if(
p
->
ty³
 =ğ
PATTERN
)

188 
	`´štf
(" Ex³ùed: (%s)\n", 
	`bd©a
(
p
->
d©a
.
·‰”n
));

189 ià(
p
->
ty³
 =ğ
STRING
)

190 
	`´štf
(" Ex³ùed: \"%s\"\n", 
	`bd©a
(
p
->
d©a
.
¡ršg
));

192 
	`´štf
(" Expected dict?\n");

200 
”rÜ
:

202 
	}
}

204 
	$skmaš
(
¬gc
, *
¬gv
[])

206 
	`dbg_£t_log
(
¡d”r
);

207 
RunKegogiArgs
 *
¬gs
 = 
	`ÿÎoc
((*args), 1);

208 
	`check_mem
(
¬gs
);

209 
¬gs
->
süt_·th
 = 
NULL
;

210 
¬gs
->
num_th»ads
 = 1;

211 
¬gs
->
™”©iÚs_³r_th»ad
 = 1;

213 
İtiÚ
 
lÚg_İtiÚs
[] = {

218 
c
;

219 (
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, "t:i:", 
lÚg_İtiÚs
, 
NULL
)) != -1) {

220 
c
) {

222 
¬gs
->
num_th»ads
 = 
	`©oi
(
İrg
);

223 
	`check
(
¬gs
->
num_th»ads
 > 0, "Invalid‚umber ofhreads");

226 
¬gs
->
™”©iÚs_³r_th»ad
 = 
	`©oi
(
İrg
);

227 
	`check
(
¬gs
->
™”©iÚs_³r_th»ad
 > 0, "Invalid‚umber of "

231 
	`check
(0, "Invalid‡rgument");

235 
	`check
(
İtšd
 < 
¬gc
, "Expected kegogi file");

237 
¬gs
->
süt_·th
 = 
	`bäomc¡r
(
¬gv
[
İtšd
]);

239 
	`skü—‹
(
runkegogi
, 
¬gs
, 128 * 1024);

241 
	`skex™
(0);

243 
”rÜ
:

244 
	`skex™®l
(1);

245 
	}
}

	@examples/kegogi/src/kegogi.h

1 #iâdeà
_KEGOGI_H


2 
	#_KEGOGI_H


	)

4 
	~<b¡ršg.h
>

6 
	~"·¿m.h
"

7 
	~"kegogi_tok’s.h
"

9 
	#DEFAULT_PORT
 80

	)

11 
	sS’d
 {

12 
b¡ršg
 
	mm‘hod
;

13 
b¡ršg
 
	mho¡
;

14 
b¡ršg
 
	mpÜt
;

15 
b¡ršg
 
	muri
;

16 
P¬amDiù
 *
	m·¿ms
;

17 } 
	tS’d
;

19 
	sEx³ù
 {

20 
b¡ršg
 
	m¡©us_code
;

21 
P¬amDiù
 *
	m·¿ms
;

22 } 
	tEx³ù
;

24 
	sCommªd
 {

25 
S’d
 
	m£nd
;

26 
Ex³ù
 
	mex³ù
;

27 } 
	tCommªd
;

29 
	sCommªdLi¡
 {

30 
	msize
;

31 
	mcouÁ
;

32 
Commªd
 *
	mcommªds
;

33 
P¬amDiù
 *
	mdeçuÉs
;

34 } 
	tCommªdLi¡
;

35 
·r£_kegogi_fe
(cÚ¡ *
·th
, 
Commªd
 
commªds
[],

36 
max_num_commªds
, 
P¬amDiù
 **
deçuÉs
);

37 
Tok’Li¡
 *
g‘_kegogi_tok’s
(
b¡ršg
 
cÚ‹Á
);

	@examples/kegogi/src/kegogi_lexer.c

3 
	~"kegogi_tok’s.h
"

4 
	~"kegogi_·r£r.h
"

6 
	~<¡dio.h
>

8 
	~<b¡ršg.h
>

9 
	~<dbg.h
>

17 cÚ¡ 
	g_kegogi_Ëx”_aùiÚs
[] = {

37 cÚ¡ 
	g_kegogi_Ëx”_key_off£ts
[] = {

47 cÚ¡ 
	g_kegogi_Ëx”_Œªs_keys
[] = {

97 cÚ¡ 
	g_kegogi_Ëx”_sšgË_Ëngths
[] = {

107 cÚ¡ 
	g_kegogi_Ëx”_¿nge_Ëngths
[] = {

117 cÚ¡ 
	g_kegogi_Ëx”_šdex_off£ts
[] = {

127 cÚ¡ 
	g_kegogi_Ëx”_šdic›s
[] = {

171 cÚ¡ 
	g_kegogi_Ëx”_Œªs_rgs
[] = {

188 cÚ¡ 
	g_kegogi_Ëx”_Œªs_aùiÚs
[] = {

205 cÚ¡ 
	g_kegogi_Ëx”_to_¡©e_aùiÚs
[] = {

215 cÚ¡ 
	g_kegogi_Ëx”_äom_¡©e_aùiÚs
[] = {

225 cÚ¡ 
	g_kegogi_Ëx”_eof_Œªs
[] = {

235 cÚ¡ 
	gkegogi_Ëx”_¡¬t
 = 25;

236 cÚ¡ 
	gkegogi_Ëx”_fœ¡_fš®
 = 25;

237 cÚ¡ 
	gkegogi_Ëx”_”rÜ
 = 0;

239 cÚ¡ 
	gkegogi_Ëx”_’_maš
 = 25;

244 
Tok’Li¡
 *
	$g‘_kegogi_tok’s
(
b¡ršg
 
cÚ‹Á
) {

245 
Tok’Li¡
 *
tok’_li¡
 = 
	`Tok’Li¡_ü—‹
(1024);

246 
	`check_mem
(
tok’_li¡
);

248 *
p
 = 
	`bd©a
(
cÚ‹Á
);

249 *
³
 = 
p
 + 
	`bËngth
(
cÚ‹Á
);

250 *
m
 = 
NULL
;

251 *
eof
 = 
³
;

252 
cs
 = -1;

253 
aù
 = -1;

254 *
ts
 = 
NULL
;

255 *
‹
 = 
NULL
;

257 
b¡ršg
 
s1
 = 
NULL
;

258 
b¡ršg
 
s2
 = 
NULL
;

259 
b¡ršg
 
s3
 = 
NULL
;

264 
cs
 = 
kegogi_Ëx”_¡¬t
;

265 
ts
 = 0;

266 
‹
 = 0;

267 
aù
 = 0;

274 
_kËn
;

275 
_Œªs
;

276 cÚ¡ *
_aùs
;

277 
_Çùs
;

278 cÚ¡ *
_keys
;

280 iàĞ
p
 =ğ
³
 )

281 
_‹¡_eof
;

282 iàĞ
cs
 == 0 )

283 
_out
;

284 
_»sume
:

285 
_aùs
 = 
_kegogi_Ëx”_aùiÚs
 + 
_kegogi_Ëx”_äom_¡©e_aùiÚs
[
cs
];

286 
_Çùs
 = (è*
_aùs
++;

287  
_Çùs
-- > 0 ) {

288  *
_aùs
++ ) {

291 {
ts
 = 
p
;}

297 
_keys
 = 
_kegogi_Ëx”_Œªs_keys
 + 
_kegogi_Ëx”_key_off£ts
[
cs
];

298 
_Œªs
 = 
_kegogi_Ëx”_šdex_off£ts
[
cs
];

300 
_kËn
 = 
_kegogi_Ëx”_sšgË_Ëngths
[
cs
];

301 iàĞ
_kËn
 > 0 ) {

302 cÚ¡ *
_low”
 = 
_keys
;

303 cÚ¡ *
_mid
;

304 cÚ¡ *
_uµ”
 = 
_keys
 + 
_kËn
 - 1;

306 iàĞ
_uµ”
 < 
_low”
 )

309 
_mid
 = 
_low”
 + ((
_uµ”
-_lower) >> 1);

310 iàĞ(*
p
è< *
_mid
 )

311 
_uµ”
 = 
_mid
 - 1;

312 iàĞ(*
p
è> *
_mid
 )

313 
_low”
 = 
_mid
 + 1;

315 
_Œªs
 +ğ(
_mid
 - 
_keys
);

316 
_m©ch
;

319 
_keys
 +ğ
_kËn
;

320 
_Œªs
 +ğ
_kËn
;

323 
_kËn
 = 
_kegogi_Ëx”_¿nge_Ëngths
[
cs
];

324 iàĞ
_kËn
 > 0 ) {

325 cÚ¡ *
_low”
 = 
_keys
;

326 cÚ¡ *
_mid
;

327 cÚ¡ *
_uµ”
 = 
_keys
 + (
_kËn
<<1) - 2;

329 iàĞ
_uµ”
 < 
_low”
 )

332 
_mid
 = 
_low”
 + (((
_uµ”
-_lower) >> 1) & ~1);

333 iàĞ(*
p
è< 
_mid
[0] )

334 
_uµ”
 = 
_mid
 - 2;

335 iàĞ(*
p
è> 
_mid
[1] )

336 
_low”
 = 
_mid
 + 2;

338 
_Œªs
 +ğ((
_mid
 - 
_keys
)>>1);

339 
_m©ch
;

342 
_Œªs
 +ğ
_kËn
;

345 
_m©ch
:

346 
_Œªs
 = 
_kegogi_Ëx”_šdic›s
[_trans];

347 
_eof_Œªs
:

348 
cs
 = 
_kegogi_Ëx”_Œªs_rgs
[
_Œªs
];

350 iàĞ
_kegogi_Ëx”_Œªs_aùiÚs
[
_Œªs
] == 0 )

351 
_agaš
;

353 
_aùs
 = 
_kegogi_Ëx”_aùiÚs
 + 
_kegogi_Ëx”_Œªs_aùiÚs
[
_Œªs
];

354 
_Çùs
 = (è*
_aùs
++;

355  
_Çùs
-- > 0 )

357  *
_aùs
++ )

361 { 
m
 = 
p
; }

365 { 
s1
 = 
	`blk2b¡r
(
m
, 
p
-m); }

369 { 
s2
 = 
	`blk2b¡r
(
m
, 
p
-m); }

373 { 
s3
 = 
	`blk2b¡r
(
m
, 
p
-m); }

377 {
‹
 = 
p
+1;}

381 {
aù
 = 1;}

385 {
aù
 = 2;}

389 {
aù
 = 3;}

393 {
aù
 = 4;}

397 {
aù
 = 5;}

401 {
aù
 = 6;}

405 {
aù
 = 7;}

409 {
aù
 = 9;}

413 {
aù
 = 10;}

417 {
aù
 = 11;}

421 {
aù
 = 13;}

425 {
‹
 = 
p
+1;{

426 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKSTRING
, 
s1
);

427 
s1
 = 
s2
 = 
s3
 = 
NULL
;

432 {
‹
 = 
p
+1;{

433 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKPATTERN
, 
s1
);

434 
s1
 = 
s2
 = 
s3
 = 
NULL
;

439 {
‹
 = 
p
+1;{

440 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKNEWLINE
);

441 
s1
 = 
s2
 = 
s3
 = 
NULL
;

446 {
‹
 = 
p
+1;{

447 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKEQUALS
);

448 
s1
 = 
s2
 = 
s3
 = 
NULL
;

453 {
‹
 = 
p
+1;{ }}

457 {
‹
 = 
p
;p--;{

458 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKSTRING
, 
s1
);

459 
s1
 = 
s2
 = 
s3
 = 
NULL
;

464 {
‹
 = 
p
;p--;{

465 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKNUMBER
, 
s1
);

466 
s1
 = 
s2
 = 
s3
 = 
NULL
;

471 {
‹
 = 
p
;p--;{

472 
	`Tok’Li¡_­³nd3
(&
tok’_li¡
, 
TKURL
, 
s1
, 
s2
, 
s3
);

473 
s1
 = 
s2
 = 
s3
 = 
NULL
;

478 {  
aù
 ) {

480 {{
cs
 = 0; 
_agaš
;}}

483 {{
p
 = ((
‹
))-1;}

484 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKDEFAULTS
);

485 
s1
 = 
s2
 = 
s3
 = 
NULL
;

489 {{
p
 = ((
‹
))-1;}

490 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKSEND
);

491 
s1
 = 
s2
 = 
s3
 = 
NULL
;

495 {{
p
 = ((
‹
))-1;}

496 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKEXPECT
);

497 
s1
 = 
s2
 = 
s3
 = 
NULL
;

501 {{
p
 = ((
‹
))-1;}

502 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKSTRING
, 
s1
);

503 
s1
 = 
s2
 = 
s3
 = 
NULL
;

507 {{
p
 = ((
‹
))-1;}

508 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKPATTERN
, 
s1
);

509 
s1
 = 
s2
 = 
s3
 = 
NULL
;

513 {{
p
 = ((
‹
))-1;}

514 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKNUMBER
, 
s1
);

515 
s1
 = 
s2
 = 
s3
 = 
NULL
;

519 {{
p
 = ((
‹
))-1;}

520 
	`Tok’Li¡_­³nd3
(&
tok’_li¡
, 
TKURL
, 
s1
, 
s2
, 
s3
);

521 
s1
 = 
s2
 = 
s3
 = 
NULL
;

525 {{
p
 = ((
‹
))-1;}

526 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKDICT_START
);

527 
s1
 = 
s2
 = 
s3
 = 
NULL
;

531 {{
p
 = ((
‹
))-1;}

532 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKDICT_END
);

533 
s1
 = 
s2
 = 
s3
 = 
NULL
;

537 {{
p
 = ((
‹
))-1;}

538 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKEQUALS
);

539 
s1
 = 
s2
 = 
s3
 = 
NULL
;

543 {{
p
 = ((
‹
))-1;} }

552 
_agaš
:

553 
_aùs
 = 
_kegogi_Ëx”_aùiÚs
 + 
_kegogi_Ëx”_to_¡©e_aùiÚs
[
cs
];

554 
_Çùs
 = (è*
_aùs
++;

555  
_Çùs
-- > 0 ) {

556  *
_aùs
++ ) {

559 {
ts
 = 0;}

563 {
aù
 = 0;}

569 iàĞ
cs
 == 0 )

570 
_out
;

571 iàĞ++
p
 !ğ
³
 )

572 
_»sume
;

573 
_‹¡_eof
: {}

574 iàĞ
p
 =ğ
eof
 )

576 iàĞ
_kegogi_Ëx”_eof_Œªs
[
cs
] > 0 ) {

577 
_Œªs
 = 
_kegogi_Ëx”_eof_Œªs
[
cs
] - 1;

578 
_eof_Œªs
;

582 
_out
: {}

587  
tok’_li¡
;

589 
”rÜ
:

590 
	`Tok’Li¡_de¡roy
(
tok’_li¡
);

591  
NULL
;

592 
	}
}

	@examples/kegogi/src/kegogi_parser.c

6 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<dbg.h
>

13 
	~"kegogi_·r£r.h
"

14 
	~"kegogi_tok’s.h
"

15 
	~"kegogi.h
"

17 
	#as£¹
(
S
) { \

18 if(!(
S
)) { \

19 
	`debug
(#S); \

20 
	`skex™®l
(-1); \

22 }

	)

37 #iâdeà
INTERFACE


38 
	#INTERFACE
 1

	)

74 
	#YYCODETYPE
 

	)

75 
	#YYNOCODE
 21

	)

76 
	#YYACTIONTYPE
 

	)

77 
	#P¬£TOKENTYPE
 
Tok’
*

	)

79 
	myyš™
;

80 
P¬£TOKENTYPE
 
	myy0
;

81 
P¬am
* 
	myy8
;

82 
P¬amDiù
* 
	myy24
;

83 
Commªd
* 
	myy30
;

84 } 
	tYYMINORTYPE
;

85 #iâdeà
YYSTACKDEPTH


86 
	#YYSTACKDEPTH
 100

	)

88 
	#P¬£ARG_SDECL
 
CommªdLi¡
 *
commªdLi¡
;

	)

89 
	#P¬£ARG_PDECL
 ,
CommªdLi¡
 *
commªdLi¡


	)

90 
	#P¬£ARG_FETCH
 
CommªdLi¡
 *
commªdLi¡
 = 
yypP¬£r
->
	)
commandList

91 
	#P¬£ARG_STORE
 
yypP¬£r
->
commªdLi¡
 = 
	)
commandList

92 
	#YYNSTATE
 25

	)

93 
	#YYNRULE
 12

	)

94 
	#YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

	)

95 
	#YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

	)

96 
	#YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

	)

100 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

110 #iâdeà
yy‹¡ÿ£


111 
	#yy‹¡ÿ£
(
X
)

	)

162 cÚ¡ 
YYACTIONTYPE
 
	gyy_aùiÚ
[] = {

167 cÚ¡ 
YYCODETYPE
 
	gyy_lookah—d
[] = {

172 
	#YY_SHIFT_USE_DFLT
 (-1)

	)

173 
	#YY_SHIFT_MAX
 15

	)

174 cÚ¡ sigÃd 
	gyy_shiá_of¡
[] = {

178 
	#YY_REDUCE_USE_DFLT
 (-12)

	)

179 
	#YY_REDUCE_MAX
 9

	)

180 cÚ¡ sigÃd 
	gyy_»duû_of¡
[] = {

183 cÚ¡ 
YYACTIONTYPE
 
	gyy_deçuÉ
[] = {

188 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

200 #ifdeà
YYFALLBACK


201 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

217 
	syySckEÁry
 {

218 
YYACTIONTYPE
 
	m¡©’o
;

219 
YYCODETYPE
 
	mmajÜ
;

221 
YYMINORTYPE
 
	mmšÜ
;

224 
yySckEÁry
 
	tyySckEÁry
;

228 
	syyP¬£r
 {

229 
	myyidx
;

230 #ifdeà
YYTRACKMAXSTACKDEPTH


231 
	myyidxMax
;

233 
	myy”rút
;

234 
	mP¬£ARG_SDECL


235 #ià
YYSTACKDEPTH
<=0

236 
	myy¡ksz
;

237 
yySckEÁry
 *
	myy¡ack
;

239 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

242 
yyP¬£r
 
	tyyP¬£r
;

244 #iâdeà
NDEBUG


245 
	~<¡dio.h
>

246 
FILE
 *
	gyyT¿ûFILE
 = 0;

247 *
	gyyT¿ûProm±
 = 0;

250 #iâdeà
NDEBUG


268 
	$P¬£T¿û
(
FILE
 *
T¿ûFILE
, *
zT¿ûProm±
){

269 
yyT¿ûFILE
 = 
T¿ûFILE
;

270 
yyT¿ûProm±
 = 
zT¿ûProm±
;

271 ifĞ
yyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

272 ifĞ
yyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

273 
	}
}

276 #iâdeà
NDEBUG


279 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

288 #iâdeà
NDEBUG


291 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

308 #ià
YYSTACKDEPTH
<=0

312 
	$yyGrowSck
(
yyP¬£r
 *
p
){

313 
ÃwSize
;

314 
yySckEÁry
 *
pNew
;

316 
ÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

317 
pNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

318 ifĞ
pNew
 ){

319 
p
->
yy¡ack
 = 
pNew
;

320 
p
->
yy¡ksz
 = 
ÃwSize
;

321 #iâdeà
NDEBUG


322 ifĞ
yyT¿ûFILE
 ){

323 
	`årštf
(
yyT¿ûFILE
,"%sStack growso %dƒntries!\n",

324 
yyT¿ûProm±
, 
p
->
yy¡ksz
);

328 
	}
}

343 *
P¬£AÎoc
(*(*
m®locProc
)(
size_t
)){

344 
yyP¬£r
 *
	gpP¬£r
;

345 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

346 ifĞ
	gpP¬£r
 ){

347 
	gpP¬£r
->
	gyyidx
 = -1;

348 #ifdeà
YYTRACKMAXSTACKDEPTH


349 
	gpP¬£r
->
	gyyidxMax
 = 0;

351 #ià
YYSTACKDEPTH
<=0

352 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

353 
	gpP¬£r
->
	gyy¡ksz
 = 0;

354 
yyGrowSck
(
pP¬£r
);

357  
	gpP¬£r
;

365 
	$yy_de¡ruùÜ
(

366 
yyP¬£r
 *
yypP¬£r
,

367 
YYCODETYPE
 
yymajÜ
,

368 
YYMINORTYPE
 *
yypmšÜ


370 
P¬£ARG_FETCH
;

371  
yymajÜ
 ){

385 
	`ä“
((
yypmšÜ
->
yy30
));

391 
	}
}

401 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

402 
YYCODETYPE
 
yymajÜ
;

403 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

405 ifĞ
pP¬£r
->
yyidx
<0 )  0;

406 #iâdeà
NDEBUG


407 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

408 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

409 
yyT¿ûProm±
,

410 
yyTok’Name
[
yytos
->
majÜ
]);

413 
yymajÜ
 = 
yytos
->
majÜ
;

414 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

415 
pP¬£r
->
yyidx
--;

416  
yymajÜ
;

417 
	}
}

431 
P¬£F»e
(

432 *
p
,

433 (*
ä“Proc
)(*)

435 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

436 ifĞ
pP¬£r
==0 ) ;

437  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

438 #ià
YYSTACKDEPTH
<=0

439 
	`ä“
(
pP¬£r
->
yy¡ack
);

441 (*
ä“Proc
)((*)
pP¬£r
);

442 
	}
}

447 #ifdeà
YYTRACKMAXSTACKDEPTH


448 
	$P¬£SckP—k
(*
p
){

449 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

450  
pP¬£r
->
yyidxMax
;

451 
	}
}

462 
	$yy_fšd_shiá_aùiÚ
(

463 
yyP¬£r
 *
pP¬£r
,

464 
YYCODETYPE
 
iLookAh—d


466 
i
;

467 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

469 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

470  
yy_deçuÉ
[
¡©’o
];

472 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

473 
i
 +ğ
iLookAh—d
;

474 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

475 ifĞ
iLookAh—d
>0 ){

476 #ifdeà
YYFALLBACK


477 
YYCODETYPE
 
iF®lback
;

478 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

479 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

480 #iâdeà
NDEBUG


481 ifĞ
yyT¿ûFILE
 ){

482 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

483 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

486  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

489 #ifdeà
YYWILDCARD


491 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

492 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

493 #iâdeà
NDEBUG


494 ifĞ
yyT¿ûFILE
 ){

495 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

496 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

499  
yy_aùiÚ
[
j
];

504  
yy_deçuÉ
[
¡©’o
];

506  
yy_aùiÚ
[
i
];

508 
	}
}

518 
	$yy_fšd_»duû_aùiÚ
(

519 
¡©’o
,

520 
YYCODETYPE
 
iLookAh—d


522 
i
;

523 #ifdeà
YYERRORSYMBOL


524 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

525  
yy_deçuÉ
[
¡©’o
];

528 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

530 
i
 = 
yy_»duû_of¡
[
¡©’o
];

531 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

532 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

533 
i
 +ğ
iLookAh—d
;

534 #ifdeà
YYERRORSYMBOL


535 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

536  
yy_deçuÉ
[
¡©’o
];

539 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

540 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

542  
yy_aùiÚ
[
i
];

543 
	}
}

548 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

549 
P¬£ARG_FETCH
;

550 
yypP¬£r
->
yyidx
--;

551 #iâdeà
NDEBUG


552 ifĞ
yyT¿ûFILE
 ){

553 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

556  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

561 
	`debug
("There was‡ stack overflow");

564 
P¬£ARG_STORE
;

565 
	}
}

570 
	$yy_shiá
(

571 
yyP¬£r
 *
yypP¬£r
,

572 
yyNewS‹
,

573 
yyMajÜ
,

574 
YYMINORTYPE
 *
yypMšÜ


576 
yySckEÁry
 *
yytos
;

577 
yypP¬£r
->
yyidx
++;

578 #ifdeà
YYTRACKMAXSTACKDEPTH


579 ifĞ
yypP¬£r
->
yyidx
>yypP¬£r->
yyidxMax
 ){

580 
yypP¬£r
->
yyidxMax
 = yypP¬£r->
yyidx
;

583 #ià
YYSTACKDEPTH
>0

584 ifĞ
yypP¬£r
->
yyidx
>=
YYSTACKDEPTH
 ){

585 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

589 ifĞ
yypP¬£r
->
yyidx
>=yypP¬£r->
yy¡ksz
 ){

590 
	`yyGrowSck
(
yypP¬£r
);

591 ifĞ
yypP¬£r
->
yyidx
>=yypP¬£r->
yy¡ksz
 ){

592 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

597 
yytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

598 
yytos
->
¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

599 
yytos
->
majÜ
 = (
YYCODETYPE
)
yyMajÜ
;

600 
yytos
->
mšÜ
 = *
yypMšÜ
;

601 #iâdeà
NDEBUG


602 ifĞ
yyT¿ûFILE
 && 
yypP¬£r
->
yyidx
>0 ){

603 
i
;

604 
	`årštf
(
yyT¿ûFILE
,"%sShiá %d\n",
yyT¿ûProm±
,
yyNewS‹
);

605 
	`årštf
(
yyT¿ûFILE
,"%sSck:",
yyT¿ûProm±
);

606 
i
=1; i<=
yypP¬£r
->
yyidx
; i++)

607 
	`årštf
(
yyT¿ûFILE
," %s",
yyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
majÜ
]);

608 
	`årštf
(
yyT¿ûFILE
,"\n");

611 
	}
}

617 
YYCODETYPE
 
	mlhs
;

618 
	mÄhs
;

619 } 
	gyyRuËInfo
[] = {

634 
yy_acû±
(
yyP¬£r
*);

640 
	$yy_»duû
(

641 
yyP¬£r
 *
yypP¬£r
,

642 
yyruËno


644 
yygÙo
;

645 
yyaù
;

646 
YYMINORTYPE
 
yygÙomšÜ
;

647 
yySckEÁry
 *
yym¥
;

648 
yysize
;

649 
P¬£ARG_FETCH
;

650 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

651 #iâdeà
NDEBUG


652 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

653 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

654 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

655 
yyRuËName
[
yyruËno
]);

674 
yygÙomšÜ
 = 
yyz”omšÜ
;

677  
yyruËno
 ){

689 
idx
 = 
commªdLi¡
->
couÁ
;

690 
	`as£¹
(
idx
 < 
commªdLi¡
->
size
);

691 
commªdLi¡
->
couÁ
++;

692 
commªdLi¡
->
commªds
[
idx
] = *
yym¥
[0].
mšÜ
.
yy30
;

693 
	`ä“
(
yym¥
[0].
mšÜ
.
yy30
);

700 if(
commªdLi¡
->
deçuÉs
 !ğ
NULL
)

701 
	`debug
("You can only specify defaults once");

703 
commªdLi¡
->
deçuÉs
 = 
yym¥
[0].
mšÜ
.
yy24
;

709 { 
yygÙomšÜ
.
yy24
 = 
yym¥
[-1].
mšÜ
.yy24; 
	`P¬amDiù_£t
(yygÙomšÜ.yy24, yym¥[0].mšÜ.
yy8
); }

714 { 
yygÙomšÜ
.
yy24
 = 
	`P¬amDiù_ü—‹
(); }

720 
yygÙomšÜ
.
yy8
 = 
	`P¬am_ü—‹
(
	`b¡rıy
(
yym¥
[-2].
mšÜ
.
yy0
->
s1
), 
PATTERN
, bstrcpy(yymsp[0].minor.yy0->s1));

727 
yygÙomšÜ
.
yy8
 = 
	`P¬am_ü—‹
(
	`b¡rıy
(
yym¥
[-2].
mšÜ
.
yy0
->
s1
), 
STRING
, bstrcpy(yymsp[0].minor.yy0->s1));

734 
yygÙomšÜ
.
yy8
 = 
	`P¬am_ü—‹
(
	`b¡rıy
(
yym¥
[-4].
mšÜ
.
yy0
->
s1
), 
DICT
, yym¥[-1].mšÜ.
yy24
);

740 { 
yygÙomšÜ
.
yy24
 = 
yym¥
[-1].
mšÜ
.yy24; }

746 
yygÙomšÜ
.
yy30
 = 
	`ÿÎoc
((
Commªd
), 1);

747 
yygÙomšÜ
.
yy30
->
£nd
.
m‘hod
 = 
	`b¡rıy
(
yym¥
[-7].
mšÜ
.
yy0
->
s1
);

748 
yygÙomšÜ
.
yy30
->
£nd
.
uri
 = 
	`b¡rıy
(
yym¥
[-6].
mšÜ
.
yy0
->
s1
);

749 
yygÙomšÜ
.
yy30
->
£nd
.
ho¡
 = (
yym¥
[-6].
mšÜ
.
yy0
->
s2
 =ğ
NULL
è? NULL : 
	`b¡rıy
(yymsp[-6].minor.yy0->s2);

750 
yygÙomšÜ
.
yy30
->
£nd
.
pÜt
 = (
yym¥
[-6].
mšÜ
.
yy0
->
s3
 =ğ
NULL
è? NULL : 
	`b¡rıy
(yymsp[-6].minor.yy0->s3);

751 
yygÙomšÜ
.
yy30
->
£nd
.
·¿ms
 = 
yym¥
[-5].
mšÜ
.
yy24
;

752 
yygÙomšÜ
.
yy30
->
ex³ù
.
¡©us_code
 = 
	`b¡rıy
(
yym¥
[-2].
mšÜ
.
yy0
->
s1
);

753 
yygÙomšÜ
.
yy30
->
ex³ù
.
·¿ms
 = 
yym¥
[-1].
mšÜ
.
yy24
;

758  
	`yy‹¡ÿ£
(
yyruËno
==0);

759  
	`yy‹¡ÿ£
(
yyruËno
==3);

760  
	`yy‹¡ÿ£
(
yyruËno
==4);

763 
yygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

764 
yysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

765 
yypP¬£r
->
yyidx
 -ğ
yysize
;

766 
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
YYCODETYPE
)
yygÙo
);

767 ifĞ
yyaù
 < 
YYNSTATE
 ){

768 #ifdeà
NDEBUG


773 ifĞ
yysize
 ){

774 
yypP¬£r
->
yyidx
++;

775 
yym¥
 -ğ
yysize
-1;

776 
yym¥
->
¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

777 
yym¥
->
majÜ
 = (
YYCODETYPE
)
yygÙo
;

778 
yym¥
->
mšÜ
 = 
yygÙomšÜ
;

782 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yygÙo
,&
yygÙomšÜ
);

785 
	`as£¹
Ğ
yyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

786 
	`yy_acû±
(
yypP¬£r
);

788 
	}
}

793 #iâdeà
YYNOERRORRECOVERY


794 
	$yy_·r£_çed
(

795 
yyP¬£r
 *
yypP¬£r


797 
P¬£ARG_FETCH
;

798 #iâdeà
NDEBUG


799 ifĞ
yyT¿ûFILE
 ){

800 
	`årštf
(
yyT¿ûFILE
,"%sFa!\n",
yyT¿ûProm±
);

803  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

806 
P¬£ARG_STORE
;

807 
	}
}

813 
	$yy_syÁax_”rÜ
(

814 
yyP¬£r
 *
yypP¬£r
,

815 
yymajÜ
,

816 
YYMINORTYPE
 
yymšÜ


818 
P¬£ARG_FETCH
;

819 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

822 
	`debug
("There was‡ syntaxƒrror");

825 
P¬£ARG_STORE
;

826 
	}
}

831 
	$yy_acû±
(

832 
yyP¬£r
 *
yypP¬£r


834 
P¬£ARG_FETCH
;

835 #iâdeà
NDEBUG


836 ifĞ
yyT¿ûFILE
 ){

837 
	`årštf
(
yyT¿ûFILE
,"%sAcû±!\n",
yyT¿ûProm±
);

840  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

843 
P¬£ARG_STORE
;

844 
	}
}

865 
	$P¬£
(

866 *
yyp
,

867 
yymajÜ
,

868 
P¬£TOKENTYPE
 
yymšÜ


869 
P¬£ARG_PDECL


871 
YYMINORTYPE
 
yymšÜuniÚ
;

872 
yyaù
;

873 
yy’dofšput
;

874 #ifdeà
YYERRORSYMBOL


875 
yy”rÜh™
 = 0;

877 
yyP¬£r
 *
yypP¬£r
;

880 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

881 ifĞ
yypP¬£r
->
yyidx
<0 ){

882 #ià
YYSTACKDEPTH
<=0

883 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

885 
yymšÜuniÚ
 = 
yyz”omšÜ
;

886 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

890 
yypP¬£r
->
yyidx
 = 0;

891 
yypP¬£r
->
yy”rút
 = -1;

892 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

893 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

895 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

896 
yy’dofšput
 = (
yymajÜ
==0);

897 
P¬£ARG_STORE
;

899 #iâdeà
NDEBUG


900 ifĞ
yyT¿ûFILE
 ){

901 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

906 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

907 ifĞ
yyaù
<
YYNSTATE
 ){

908 
	`as£¹
Ğ!
yy’dofšput
 );

909 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

910 
yypP¬£r
->
yy”rút
--;

911 
yymajÜ
 = 
YYNOCODE
;

912 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

913 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

915 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

916 #ifdeà
YYERRORSYMBOL


917 
yymx
;

919 #iâdeà
NDEBUG


920 ifĞ
yyT¿ûFILE
 ){

921 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

924 #ifdeà
YYERRORSYMBOL


944 ifĞ
yypP¬£r
->
yy”rút
<0 ){

945 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

947 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

948 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

949 #iâdeà
NDEBUG


950 ifĞ
yyT¿ûFILE
 ){

951 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

952 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

955 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

956 
yymajÜ
 = 
YYNOCODE
;

959 
yypP¬£r
->
yyidx
 >= 0 &&

960 
yymx
 !ğ
YYERRORSYMBOL
 &&

961 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

962 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

963 
YYERRORSYMBOL
)è>ğ
YYNSTATE


965 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

967 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

968 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

969 
	`yy_·r£_çed
(
yypP¬£r
);

970 
yymajÜ
 = 
YYNOCODE
;

971 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

972 
YYMINORTYPE
 
u2
;

973 
u2
.
YYERRSYMDT
 = 0;

974 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

977 
yypP¬£r
->
yy”rút
 = 3;

978 
yy”rÜh™
 = 1;

979 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

987 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

988 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

989 
yymajÜ
 = 
YYNOCODE
;

1001 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

1002 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1004 
yypP¬£r
->
yy”rút
 = 3;

1005 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

1006 ifĞ
yy’dofšput
 ){

1007 
	`yy_·r£_çed
(
yypP¬£r
);

1009 
yymajÜ
 = 
YYNOCODE
;

1012 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

1014 
	}
}

1017 
	$·r£_kegogi_fe
(cÚ¡ *
·th
, 
Commªd
 
commªds
[],

1018 
max_num_commªds
, 
P¬amDiù
 **
deçuÉs
) {

1019 
FILE
 *
süt
;

1020 
Tok’Li¡
 *
tok’s
 = 
NULL
;

1021 
b¡ršg
 
bufãr
 = 
NULL
;

1022 *
·r£r
 = 
NULL
;

1024 
CommªdLi¡
 
commªdLi¡
 = {

1025 .
size
 = 
max_num_commªds
,

1026 .
couÁ
 = 0,

1027 .
deçuÉs
 = 
NULL
,

1028 .
commªds
 = commands

1031 
süt
 = 
	`fİ’
(
·th
, "r");

1032 
	`check
(
süt
, "FaedØİ’ fe: %s", 
·th
);

1034 
bufãr
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
süt
);

1035 
	`check_mem
(
bufãr
);

1037 
	`fşo£
(
süt
);

1038 
süt
 = 
NULL
;

1040 
tok’s
 = 
	`g‘_kegogi_tok’s
(
bufãr
);

1041 
	`check_mem
(
tok’s
);

1043 
	`bde¡roy
(
bufãr
);

1044 
bufãr
 = 
NULL
;

1046 
·r£r
 = 
	`P¬£AÎoc
(
m®loc
);

1047 
	`check_mem
(
·r£r
);

1049 
i
;

1050 
i
 = 0; i < 
tok’s
->
couÁ
; i++) {

1051 
	`P¬£
(
·r£r
, 
tok’s
->tok’s[
i
].
ty³
, &tokens->tokens[i],

1052 &
commªdLi¡
);

1054 
	`P¬£
(
·r£r
, 
TKNEWLINE
, 0, &
commªdLi¡
);

1055 
	`P¬£
(
·r£r
, 0, 0, &
commªdLi¡
);

1056 
	`Tok’Li¡_de¡roy
(
tok’s
);

1057 
tok’s
 = 
NULL
;

1059 *
deçuÉs
 = 
commªdLi¡
.defaults;

1060  
commªdLi¡
.
couÁ
;

1062 
”rÜ
:

1063 
	`Tok’Li¡_de¡roy
(
tok’s
);

1064 
	`bde¡roy
(
bufãr
);

1065 if(
süt
è
	`fşo£
(script);

1066 if(
·r£r
è
	`P¬£F»e
Õ¬£r, 
ä“
);

1069 
	}
}

	@examples/kegogi/src/kegogi_parser.h

1 
	#TKNEWLINE
 1

	)

2 
	#TKSTRING
 2

	)

3 
	#TKEQUALS
 3

	)

4 
	#TKPATTERN
 4

	)

5 
	#TKDICT_START
 5

	)

6 
	#TKDICT_END
 6

	)

7 
	#TKDEFAULTS
 7

	)

8 
	#TKSEND
 8

	)

9 
	#TKURL
 9

	)

10 
	#TKEXPECT
 10

	)

11 
	#TKNUMBER
 11

	)

	@examples/kegogi/src/kegogi_parser_extra.c

3 
	$·r£_kegogi_fe
(cÚ¡ *
·th
, 
Commªd
 
commªds
[],

4 
max_num_commªds
, 
P¬amDiù
 **
deçuÉs
) {

5 
FILE
 *
süt
;

6 
Tok’Li¡
 *
tok’s
 = 
NULL
;

7 
b¡ršg
 
bufãr
 = 
NULL
;

8 *
·r£r
 = 
NULL
;

10 
CommªdLi¡
 
commªdLi¡
 = {

11 .
size
 = 
max_num_commªds
,

12 .
couÁ
 = 0,

13 .
deçuÉs
 = 
NULL
,

14 .
commªds
 = commands

17 
süt
 = 
	`fİ’
(
·th
, "r");

18 
	`check
(
süt
, "FaedØİ’ fe: %s", 
·th
);

20 
bufãr
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
süt
);

21 
	`check_mem
(
bufãr
);

23 
	`fşo£
(
süt
);

24 
süt
 = 
NULL
;

26 
tok’s
 = 
	`g‘_kegogi_tok’s
(
bufãr
);

27 
	`check_mem
(
tok’s
);

29 
	`bde¡roy
(
bufãr
);

30 
bufãr
 = 
NULL
;

32 
·r£r
 = 
	`P¬£AÎoc
(
m®loc
);

33 
	`check_mem
(
·r£r
);

35 
i
;

36 
i
 = 0; i < 
tok’s
->
couÁ
; i++) {

37 
	`P¬£
(
·r£r
, 
tok’s
->tok’s[
i
].
ty³
, &tokens->tokens[i],

38 &
commªdLi¡
);

40 
	`P¬£
(
·r£r
, 
TKNEWLINE
, 0, &
commªdLi¡
);

41 
	`P¬£
(
·r£r
, 0, 0, &
commªdLi¡
);

42 
	`Tok’Li¡_de¡roy
(
tok’s
);

43 
tok’s
 = 
NULL
;

45 *
deçuÉs
 = 
commªdLi¡
.defaults;

46  
commªdLi¡
.
couÁ
;

48 
”rÜ
:

49 
	`Tok’Li¡_de¡roy
(
tok’s
);

50 
	`bde¡roy
(
bufãr
);

51 if(
süt
è
	`fşo£
(script);

52 if(
·r£r
è
	`P¬£F»e
Õ¬£r, 
ä“
);

55 
	}
}

	@examples/kegogi/src/kegogi_tokens.c

1 
	~"kegogi_tok’s.h
"

3 
	~<¡dlib.h
>

5 
	~<dbg.h
>

7 
Tok’Li¡
* 
	$Tok’Li¡_ü—‹
(
size
) {

8 
Tok’Li¡
 *
li¡
 = 
	`m®loc
((Tok’Li¡è+ ((
Tok’
è* 
size
));

9 if(!
li¡
è 
NULL
;

11 
li¡
->
size
 = size;

12 
li¡
->
couÁ
 = 0;

14  
li¡
;

15 
	}
}

17 
	$Tok’Li¡_»size
(
Tok’Li¡
** 
li¡P
, 
Ãw_size
) {

18 if(!
li¡P
 || !(*listP))  -1;

19 
Tok’Li¡
 *
Ãw
 = 
	`»®loc
((*
li¡P
),

20 (
Tok’Li¡
è+ ((
Tok’
è* 
Ãw_size
));

21 
	`check_mem
(
Ãw
);

23 
Ãw
->
size
 = 
Ãw_size
;

24 *
li¡P
 = 
Ãw
;

28 
”rÜ
:

29 
	`Tok’Li¡_de¡roy
(*
li¡P
);

31 
	}
}

33 
	$Tok’Li¡_de¡roy
(
Tok’Li¡
* 
li¡
) {

34 if(
li¡
) {

35 
i
;

36 
i
 = 0; i < 
li¡
->
couÁ
; i++) {

37 if(
li¡
->
tok’s
[
i
].
s1
è
	`ä“
(list->tokens[i].s1);

38 if(
li¡
->
tok’s
[
i
].
s2
è
	`ä“
(list->tokens[i].s2);

39 if(
li¡
->
tok’s
[
i
].
s3
è
	`ä“
(list->tokens[i].s3);

41 
	`ä“
(
li¡
);

44 
	}
}

46 
	$Tok’Li¡_­³nd0
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
) {

47  
	`Tok’Li¡_­³nd3
(
li¡P
, 
ty³
, 0, 0, 0);

48 
	}
}

50 
	$Tok’Li¡_­³nd1
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
) {

51  
	`Tok’Li¡_­³nd3
(
li¡P
, 
ty³
, 
s1
, 0, 0);

52 
	}
}

53 
	$Tok’Li¡_­³nd2
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
, b¡ršg 
s2
) {

54  
	`Tok’Li¡_­³nd3
(
li¡P
, 
ty³
, 
s1
, 
s2
, 0);

55 
	}
}

57 
	$Tok’Li¡_­³nd3
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
, b¡ršg 
s2
,

58 
b¡ršg
 
s3
) {

59 
	`check
(
li¡P
 !ğ
NULL
 && *listP != NULL, "Invalid…ointer…assedo‡ppend");

61 
Tok’Li¡
 *
li¡
 = *
li¡P
;

62 if(
li¡
->
couÁ
 + 1 >†i¡->
size
) {

63 
rc
 = 
	`Tok’Li¡_»size
(
li¡P
, 
li¡
->
size
 * 2);

64 
	`check
(
rc
 == 0, "Failedo„esize TokenList");

67 
li¡
 = *
li¡P
;

69 
li¡
->
couÁ
++;

70 
idx
 = 
li¡
->
couÁ
 - 1;

72 
li¡
->
tok’s
[
idx
].
ty³
 =ype;

73 
li¡
->
tok’s
[
idx
].
s1
 = s1;

74 
li¡
->
tok’s
[
idx
].
s2
 = s2;

75 
li¡
->
tok’s
[
idx
].
s3
 = s3;

78 
”rÜ
:

80 
	}
}

	@examples/kegogi/src/kegogi_tokens.h

1 #iâdeà
_KEGOGI_TOKENS_H


2 
	#_KEGOGI_TOKENS_H


	)

4 
	~<b¡ršg.h
>

6 
	tTok’Ty³
;

8 
	sTok’
 {

9 
Tok’Ty³
 
	mty³
;

10 
b¡ršg
 
	ms1
;

11 
b¡ršg
 
	ms2
;

12 
b¡ršg
 
	ms3
;

13 } 
	tTok’
;

15 
	sTok’Li¡
 {

16 
	mcouÁ
;

17 
	msize
;

18 
Tok’
 
	mtok’s
[0];

19 } 
	tTok’Li¡
;

21 *
blk2c¡r
(*
¡¬t
, 
Ën
);

23 
Tok’Li¡
* 
Tok’Li¡_ü—‹
(
size
);

24 
Tok’Li¡_de¡roy
(
Tok’Li¡
* 
li¡
);

25 
Tok’Li¡_­³nd0
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
);

26 
Tok’Li¡_­³nd1
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
);

27 
Tok’Li¡_­³nd2
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
,

28 
b¡ršg
 
s2
);

29 
Tok’Li¡_­³nd3
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
,

30 
b¡ršg
 
s2
, b¡ršg 
s3
);

	@examples/kegogi/src/param.c

1 
	~"·¿m.h
"

3 
	~<¡dlib.h
>

5 
	~<adt/diù.h
>

6 
	~<b¡ršg.h
>

7 
	~<dbg.h
>

9 
P¬am
 *
	$P¬am_ü—‹
(
b¡ršg
 
Çme
, 
P¬amTy³
 
ty³
, *
v®
) {

10 
	`check
(
Çme
 !ğ
NULL
 && 
v®
 != NULL, "Null‚ame or val…assedo Param_create");

11 
P¬am
 *
p
 = 
	`ÿÎoc
((*p), 1);

12 
	`check_mem
(
p
);

13 
p
->
Çme
 =‚ame;

14 
p
->
ty³
 =ype;

15 
p
->
ty³
) {

16 
DICT
:

17 
p
->
d©a
.
diù
 = (
P¬amDiù
 *)
v®
;

19 
STRING
:

20 
p
->
d©a
.
¡ršg
 = (
b¡ršg
)
v®
;

22 
PATTERN
:

23 
p
->
d©a
.
·‰”n
 = (
b¡ršg
)
v®
;

26  
p
;

28 
”rÜ
:

29 
	`P¬am_de¡roy
(
p
);

30  
NULL
;

31 
	}
}

33 
P¬am
 *
	$P¬am_cİy
(
P¬am
 *
p
) {

34 if(!
p
è 
NULL
;

35 
P¬am
 *
p2
 = 
	`ÿÎoc
((*p2), 1);

36 
	`check_mem
(
p2
);

38 
p2
->
Çme
 = 
	`b¡rıy
(
p
->name);

39 
	`check_mem
(
p2
->
Çme
);

40 
p2
->
ty³
 = 
p
->type;

42 
p
->
ty³
) {

43 
DICT
:

44 
p2
->
d©a
.
diù
 = 
	`P¬amDiù_cİy
(
p
->data.dict);

45 
	`check_mem
(
p2
->
d©a
.
diù
);

47 
STRING
:

48 
p2
->
d©a
.
¡ršg
 = 
	`b¡rıy
(
p
->data.string);

49 
	`check_mem
(
p2
->
d©a
.
¡ršg
);

51 
PATTERN
:

52 
p2
->
d©a
.
·‰”n
 = 
	`b¡rıy
(
p
->data.pattern);

53 
	`check_mem
(
p2
->
d©a
.
·‰”n
);

57  
p2
;

59 
”rÜ
:

60 
	`P¬am_de¡roy
(
p2
);

61  
NULL
;

62 
	}
}

64 
	$P¬am_de¡roy
(
P¬am
 *
p
) {

65 if(
p
) {

66 if(
p
->
Çme
è
	`bde¡roy
(p->name);

67 
p
->
ty³
) {

68 
DICT
:

69 if(
p
->
d©a
.
diù
è
	`P¬amDiù_de¡roy
(p->data.dict);

71 
STRING
:

72 if(
p
->
d©a
.
¡ršg
è
	`bde¡roy
(p->data.string);

74 
PATTERN
:

75 if(
p
->
d©a
.
·‰”n
è
	`bde¡roy
(p->data.pattern);

78 
	`ä“
(
p
);

80 
	}
}

82 
dnode_t
 *
	$pd_®loc_diù
(*
nÙu£d
) {

83  (
dnode_t
 *)
	`ÿÎoc
((dnode_t), 1);

84 
	}
}

86 
	$pd_ä“_diù
(
dnode_t
 *
node
, *
nÙu£d
) {

88 
	`P¬am_de¡roy
((
P¬am
 *)
	`dnode_g‘
(
node
));

89 
	`ä“
(
node
);

90 
	}
}

92 
P¬amDiù
 *
	$P¬amDiù_ü—‹
() {

93 
P¬amDiù
 *
pd
 = 
	`ÿÎoc
((*pd), 1);

94 
	`check_mem
(
pd
);

95 
pd
->
diù
 = 
	`diù_ü—‹
(
MAX_PARAM_COUNT
, (
diù_comp_t
è
b¡ricmp
);

96 
	`check_mem
(
pd
->
diù
);

98 
	`diù_£t_®loÿtÜ
(
pd
->
diù
, 
pd_®loc_diù
, 
pd_ä“_diù
, 
NULL
);

101  
pd
;

103 
”rÜ
:

104 
	`P¬amDiù_de¡roy
(
pd
);

105  
NULL
;

106 
	}
}

108 
P¬amDiù
 *
	$P¬amDiù_cİy
(
P¬amDiù
 *
pd
) {

109 if(!
pd
è 
NULL
;

111 
P¬amDiù
 *
pd2
 = 
	`P¬amDiù_ü—‹
();

112 
dnode_t
 *
d
;

113 
P¬am
 *
p
, *
p2
;

115 
	`check_mem
(
pd2
);

116 
	`P¬amDiù_fÜ—ch
(
pd
, 
p
, 
d
) {

117 
p2
 = 
	`P¬am_cİy
(
p
);

118 
	`check_mem
(
p2
);

119 
	`P¬amDiù_£t
(
pd2
, 
p2
);

122  
pd2
;

124 
”rÜ
:

125 
	`P¬amDiù_de¡roy
(
pd
);

126  
NULL
;

127 
	}
}

129 
	$P¬amDiù_de¡roy
(
P¬amDiù
 *
pd
) {

130 if(
pd
) {

131 if(
pd
->
diù
) {

132 
	`diù_ä“_nodes
(
pd
->
diù
);

133 
	`diù_de¡roy
(
pd
->
diù
);

135 
	`ä“
(
pd
);

137 
	}
}

139 
	$P¬amDiù_£t
(
P¬amDiù
 *
pd
, 
P¬am
 *
p
) {

140 if(!
pd
 || !
p
) ;

142 
dnode_t
 *
node
 = 
	`diù_lookup
(
pd
->
diù
, 
p
->
Çme
);

143 if(
node
è
	`diù_d–‘e_ä“
(
pd
->
diù
,‚ode);

145 
	`diù_®loc_š£¹
(
pd
->
diù
, 
p
->
Çme
,…);

148 
	}
}

150 
P¬am
 *
	$P¬amDiù_g‘
(
P¬amDiù
 *
pd
, 
b¡ršg
 
Çme
) {

151 if(!
pd
 || !
Çme
è 
NULL
;

153 
dnode_t
 *
node
 = 
	`diù_lookup
(
pd
->
diù
, 
Çme
);

154  
node
 =ğ
NULL
 ? NULL : 
	`dnode_g‘
(node);

155 
	}
}

	@examples/kegogi/src/param.h

1 #iâdeà
_PARAM_H


2 
	#_PARAM_H


	)

4 
	~<b¡ršg.h
>

5 
	~<adt/diù.h
>

7 
	#MAX_PARAM_COUNT
 100

	)

9 
	eP¬amTy³
 {

10 
	mSTRING
,

11 
	mPATTERN
,

12 
	mDICT


13 } 
	tP¬amTy³
;

15 
	sP¬amDiù
 {

16 
diù_t
 *
	mdiù
;

17 } 
	tP¬amDiù
;

19 
	sP¬am
 {

20 
b¡ršg
 
	mÇme
;

21 
P¬amTy³
 
	mty³
;

23 
b¡ršg
 
	m¡ršg
;

24 
b¡ršg
 
	m·‰”n
;

25 
P¬amDiù
 *
	mdiù
;

26 } 
	md©a
;

27 } 
	tP¬am
;

29 
P¬am
 *
P¬am_ü—‹
(
b¡ršg
 
Çme
, 
P¬amTy³
 
ty³
, *
v®
);

30 
P¬am
 *
P¬am_·r£
(
b¡ršg
 
Çme
, **
pP
, **
pPe
);

31 
P¬am
 *
P¬am_cİy
(P¬am *
p
);

32 
P¬am_de¡roy
(
P¬am
 *
p
);

34 
P¬amDiù
 *
P¬amDiù_ü—‹
();

35 
P¬amDiù
 *
P¬amDiù_cİy
();

36 
P¬amDiù_de¡roy
(
P¬amDiù
 *
pd
);

37 
P¬amDiù_£t
(
P¬amDiù
 *
pd
, 
P¬am
 *
p
);

38 
P¬am
 *
P¬amDiù_g‘
(
P¬amDiù
 *
pd
, 
b¡ršg
 
Çme
);

40 
	#P¬amDiù_fÜ—ch
(
pd
, 
p
, 
d
) \

41 
d
 = 
	`diù_fœ¡
(
pd
->
diù
), 
p
 = (d =ğ
NULL
è? NULL : 
	`dnode_g‘
(d); \

42 
d
 !ğ
NULL
; \

43 
d
 = 
	`diù_Ãxt
(
pd
->
diù
, d), 
p
 = (d =ğ
NULL
è? NULL : 
	`dnode_g‘
(d))

	)

	@examples/procer/procer.c

1 
	~<unixy.h
>

2 
	~<dbg.h
>

3 
	~"´oûr.h
"

4 
	~<glob.h
>

5 
	~<adt/t¡.h
>

6 
	~<sigÇl.h
>

7 
	~<¡dlib.h
>

8 
	~<uni¡d.h
>

9 
	~<sys/wa™.h
>

10 
	~<sys/¡©.h
>

12 **
’vœÚ
;

14 
šlše
 
	$h¬d¦“p
(
£c
)

16 
	`sky›ld
();

17 
	`¦“p
(
£c
);

18 
	}
}

21 
šlše
 
	$»dœeù_ouut
(cÚ¡ *
run_log
)

23 
	`äeİ’
(
run_log
, "a+", 
¡dout
);

24 
	`£tbuf
(
¡dout
, 
NULL
);

25 
	`äeİ’
(
run_log
, "a+", 
¡d”r
);

26 
	`£tbuf
(
¡dout
, 
NULL
);

27 
	`äeİ’
("/dev/nuÎ", "r", 
¡dš
);

28 
	}
}

31 
	$AùiÚ_exec
(
AùiÚ
 *
aùiÚ
, 
Profe
 *
´of
)

33 
rc
 = 0;

35 
	`debug
("ACTION: command=%s,…id_file=%s,„estart=%d, depends=%s",

36 
	`bd©a
(
´of
->
commªd
), bd©aÕrof->
pid_fe
),…rof->
»¡¬t
,

37 
	`bd©a
(
aùiÚ
->
d•’ds
));

39 
pid_t
 
pid
 = 
	`fÜk
();

40 
	`check
(
pid
 >= 0, "Fork failed, WTF. How can fork fail?");

42 if(
pid
 == 0) {

43 
rc
 = 
	`Unixy_drİ_´iv
(
aùiÚ
->
´ofe_dœ
);

45 if(
rc
 != 0) {

46 
	`log_”r
("Not fatal, but we couldn't drop…riv for %s",

47 
	`bd©a
(
aùiÚ
->
Çme
));

50 
	`»dœeù_ouut
("run.log");

52 
rc
 = 
	`exeşe
(
	`bd©a
(
´of
->
commªd
), bd©aÕrof->commªd), 
NULL
, 
’vœÚ
);

53 
	`check
(
rc
 !ğ-1, "FaedØexeøcommªd: %s", 
	`bd©a
(
´of
->
commªd
));

55 
¡©us
 = 0;

56 
	`debug
("WAITING FOR CHILD.");

57 
pid
 = 
	`wa™pid
Õid, &
¡©us
, 0);

60 
	`debug
("Command„an‡ndƒxited successfully,‚ow†ooking forhe PID file.");

62 
”rÜ
:

64 
	}
}

67 
	$AùiÚ_sk
(*
v
)

69 
AùiÚ
 *
aùiÚ
 = (AùiÚ *)
v
;

70 
rc
 = 0;

71 
pid_t
 
chd
 = 0;

72 
Profe
 *
´of
 = 
	`Profe_lßd
(
aùiÚ
->
´ofe_dœ
);

74 
	`skÇme
(
	`bd©a
(
aùiÚ
->
Çme
));

76 
	`sk¡©e
("depends");

77 
rc
 = 
	`Ram·¹_wa™
(
aùiÚ
->
befÜe
);

78 
	`check
(
rc
 != -1, "A dependency failedo start, we can't start.");

80 
	`Ram·¹_ruÂšg
(&
aùiÚ
->
aá”
);

82 
	`sk¡©e
("ready");

83 
	`debug
("STARTED %s", 
	`bd©a
(
aùiÚ
->
Çme
));

86 
	`sk¡©e
("starting");

88 if(
	`Unixy_¡l_ruÂšg
(
´of
->
pid_fe
, &
chd
)) {

89 
	`debug
("Look lik% i ®»ady„uÂšg, we'Î ju¡†—v™‡lÚe.", 
	`bd©a
(
aùiÚ
->
Çme
));

91 
	`Unixy_»move_d—d_pidfe
(
´of
->
pid_fe
);

92 
	`AùiÚ_exec
(
aùiÚ
, 
´of
);

95 
	`check
(
	`acûss
(
	`bd©a
(
´of
->
pid_fe
), 
R_OK
) == 0, "%s didn't make…idfile %s.",

96 
	`bd©a
(
aùiÚ
->
Çme
), bd©a(
´of
->
pid_fe
));

98 
	`sk¡©e
("waiting");

99 
	`Unixy_¡l_ruÂšg
(
´of
->
pid_fe
, &
chd
)) {

100 
	`h¬d¦“p
(1);

103 if(!
´of
->
»¡¬t
) {

107 
	`sk¡©e
("restarting");

108 
	`h¬d¦“p
(1);

111 
	`debug
("ACTION % ex™ed.", 
	`bd©a
(
aùiÚ
->
Çme
));

113 
”rÜ
:

114 
	`Ram·¹_çed
(&
aùiÚ
->
aá”
);

116 
	}
}

119 
AùiÚ
 *
	$AùiÚ_ü—‹
(cÚ¡ *
´ofe
)

121 
AùiÚ
 *
aùiÚ
 = 
	`ÿÎoc
((Action), 1);

122 
	`check_mem
(
aùiÚ
);

124 
aùiÚ
->
´ofe_dœ
 = 
	`bäomc¡r
(
´ofe
);

125 
aùiÚ
->
Çme
 = 
	`bTa
×ùiÚ->
´ofe_dœ
,

126 
	`bËngth
(
aùiÚ
->
´ofe_dœ
) -

127 
	`b¡¼chr
(
aùiÚ
->
´ofe_dœ
, '/') - 1);

129 
aùiÚ
->
d•’ds
 = 
	`Profe_»ad_£‰šg
×ùiÚ->
´ofe_dœ
, "depends");

131  
aùiÚ
;

133 
”rÜ
:

134  
NULL
;

135 
	}
}

138 
	$AùiÚ_d•’ds
(
AùiÚ
 *
this_Úe
, AùiÚ *
Ãeds
)

140 
	`check
(
this_Úe
->
wa™šg_couÁ
 < 
MAX_DEPENDS
,

142 
	`bd©a
(
this_Úe
->
Çme
), 
MAX_DEPENDS
);

144 
this_Úe
->
befÜe
[this_Úe->
wa™šg_couÁ
] = &
Ãeds
->
aá”
;

145 
this_Úe
->
wa™šg_couÁ
++;

148 
”rÜ
:

150 
	}
}

153 
	$AùiÚ_¡¬t
(
AùiÚ
 *
aùiÚ
)

155 
	`skü—‹
(
AùiÚ_sk
, 
aùiÚ
, 32 * 1024);

156 
	}
}

158 
	$AùiÚ_d•’d’cy_assign
(*
v®ue
, *
d©a
)

160 
AùiÚ
 *
aùiÚ
 = (AùiÚ *)
v®ue
;

161 
AùiÚ
 *
rg‘
 = 
NULL
;

162 
t¡_t
 *
rg‘s
 = (t¡_ˆ*)
d©a
;

163 
i
 = 0;

165 if(!
aùiÚ
->
d•’ds
) ;

167 
	`debug
("Proûs£d % aùiÚ d•’dšg on: %s", 
	`bd©a
(
aùiÚ
->
Çme
), bd©a×ùiÚ->
d•’ds
));

169 if(
aùiÚ
->
d•’ds
) {

170 
b¡rLi¡
 *
d•_li¡
 = 
	`b¥l™
(
aùiÚ
->
d•’ds
, ' ');

172 
i
 = 0; i < 
d•_li¡
->
qty
; i++) {

173 
b¡ršg
 
d•
 = 
d•_li¡
->
’Œy
[
i
];

175 
rg‘
 = (
AùiÚ
 *)
	`t¡_£¬ch
(
rg‘s
, 
	`bd©a
(
d•
), 
	`bËngth
(dep));

177 if(
rg‘
) {

178 
	`AùiÚ_d•’ds
(
aùiÚ
, 
rg‘
);

180 
	`log_”r
("Could‚ot find dependency %s has on %s.",

181 
	`bd©a
(
aùiÚ
->
Çme
), bd©a(
d•
));

185 
	`b¡rLi¡De¡roy
(
d•_li¡
);

187 
	}
}

189 
	$AùiÚ_¡¬t_®l
(*
v®ue
, *
d©a
)

191 
AùiÚ
 *
aùiÚ
 = (AùiÚ *)
v®ue
;

192 
	`AùiÚ_¡¬t
(
aùiÚ
);

193 
	}
}

196 
	$skmaš
(
¬gc
, *
¬gv
[])

198 
	`dbg_£t_log
(
¡d”r
);

199 
glob_t
 
´ofe_glob
;

200 
rc
 = 0;

201 
i
 = 0;

202 
AùiÚ
 *
aùiÚ
 = 
NULL
;

203 
t¡_t
 *
rg‘s
 = 
NULL
;

204 
b¡ršg
 
pid_fe
 = 
NULL
;

206 
	`check
(
¬gc
 == 3, "USAGE:…rocer <profile_dir> <procer_pid_file>");

207 
pid_fe
 = 
	`bäomc¡r
(
¬gv
[2]);

209 
rc
 = 
	`Unixy_»move_d—d_pidfe
(
pid_fe
);

210 
	`check
(
rc
 =ğ0, "FaedØ»mov%s,…roû¸i ´obably‡Ì—dy„uÂšg.", 
	`bd©a
(
pid_fe
));

212 
rc
 = 
	`Unixy_d«mÚize
();

213 
	`check
(
rc
 == 0, "Couldn't daemonize,hat's‚ot good.");

215 
rc
 = 
	`chdœ
(
¬gv
[1]);

216 
	`check
(
rc
 =ğ0, "Couldn'ˆchªgtØ% ´ofdœ.", 
¬gv
[1]);

218 
rc
 = 
	`Unixy_pid_fe
(
pid_fe
);

219 
	`check
(
rc
 =ğ0, "FaedØmakthPID fe: %s", 
	`bd©a
(
pid_fe
));

221 
FILE
 *
log
 = 
	`fİ’
("error.log", "a+");

222 
	`check
(
log
, "Couldn't openƒrror.log");

223 
	`£tbuf
(
log
, 
NULL
);

224 
	`dbg_£t_log
(
log
);

226 
b¡ršg
 
dœ_glob
 = 
	`bfÜm©
("%s/[A-Za-z0-9]*", 
¬gv
[1]);

227 
	`check
(
dœ_glob
, "Couldn't makehe directory glob.");

229 
rc
 = 
	`glob
(
	`bd©a
(
dœ_glob
), 
GLOB_ERR
, 
NULL
, &
´ofe_glob
);

230 
	`check
(
rc
 == 0, "Failedo find directories inhe…rofiles.");

232 
¡©
 
sb
;

233 
	`debug
("Lßdšg %zu‡ùiÚs.", 
´ofe_glob
.
gl_·thc
);

234 
i
 = 0; i < 
´ofe_glob
.
gl_·thc
; i++) {

235 
rc
 = 
	`l¡©
(
´ofe_glob
.
gl_·thv
[
i
], &
sb
);

236 
	`check
(
rc
 =ğ0, "FaedØ¡© fÜ dœeùÜy: %s", 
´ofe_glob
.
gl_·thv
[
i
]);

238 ià(
sb
.
¡_mode
 & 
S_IFDIR
) {

239 
aùiÚ
 = 
	`AùiÚ_ü—‹
(
´ofe_glob
.
gl_·thv
[
i
]);

240 
rg‘s
 = 
	`t¡_š£¹
Ñ¬g‘s, 
	`bd©a
(
aùiÚ
->
Çme
), 
	`bËngth
(action->name),‡ction);

245 
	`t¡_Œav”£
(
rg‘s
, 
AùiÚ_d•’d’cy_assign
,argets);

246 
	`t¡_Œav”£
(
rg‘s
, 
AùiÚ_¡¬t_®l
, 
NULL
);

248 
	`skex™
(0);

250 
”rÜ
:

251 
	`skex™®l
(1);

252 
	}
}

	@examples/procer/procer.h

1 #iâdeà
_´oûr_h


2 
	#_´oûr_h


	)

4 
	~<b¡ršg.h
>

5 
	~<sk/sk.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

10 
	mMAX_DEPENDS
 = 128

13 
	sRam·¹
 {

14 
R’dez
 
	mwa™
;

15 
	mruÂšg
;

16 
	mçed
;

17 } 
	tRam·¹
;

20 
	sProfe
 {

22 
b¡ršg
 
	mcommªd
;

24 
b¡ršg
 
	mpid_fe
;

26 
	m»¡¬t
;

27 } 
	tProfe
;

31 
	sAùiÚ
 {

33 
b¡ršg
 
	mÇme
;

35 
b¡ršg
 
	m´ofe_dœ
;

37 
b¡ršg
 
	md•’ds
;

40 
Ram·¹
 
	maá”
;

42 
	mwa™šg_couÁ
;

45 
Ram·¹
 *
	mbefÜe
[
MAX_DEPENDS
];

46 } 
	tAùiÚ
;

49 
	#Ram·¹_should_wa™
(
R
è!((R)->
ruÂšg
 || (R)->
çed
)

	)

51 
Ram·¹_wa™
(
Ram·¹
 *
Ú
[]);

53 
Ram·¹_ruÂšg
(
Ram·¹
 *
Ú
);

55 
Ram·¹_nÙruÂšg
(
Ram·¹
 *
Ú
);

57 
Ram·¹_çed
(
Ram·¹
 *
Ú
);

59 
b¡ršg
 
Profe_»ad_£‰šg
(b¡ršg 
·th
, cÚ¡ *
fe
);

61 
Profe_check_£‰šg
(
b¡ršg
 
·th
, cÚ¡ *
fe
);

63 
Profe
 *
Profe_lßd
(
b¡ršg
 
´ofe_dœ
);

	@examples/procer/profile.c

1 
	~"´oûr.h
"

2 
	~<dbg.h
>

4 
b¡ršg
 
	$Profe_»ad_£‰šg
(
b¡ršg
 
·th
, cÚ¡ *
fe
)

6 
b¡ršg
 
rg‘
 = 
	`bfÜm©
("%s/%s", 
	`bd©a
(
·th
), 
fe
);

7 
b¡ršg
 
d©a
 = 
NULL
;

8 
FILE
 *
‹¡_fe
 = 
NULL
;

10 
‹¡_fe
 = 
	`fİ’
(
	`bd©a
(
rg‘
), "r");

11 
	`check
(
‹¡_fe
, "Failedo open %s filehat's„equired.",

12 
	`bd©a
(
rg‘
));

14 
d©a
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
‹¡_fe
, '\n');

15 if(
d©a
è
	`bŒimws
(data);

18 
”rÜ
:

20 if(
‹¡_fe
è
	`fşo£
(test_file);

21 
	`bde¡roy
(
rg‘
);

22  
d©a
;

23 
	}
};

26 
	$Profe_check_£‰šg
(
b¡ršg
 
·th
, cÚ¡ *
fe
)

28 
b¡ršg
 
rg‘
 = 
	`bfÜm©
("%s/%s", 
	`bd©a
(
·th
), 
fe
);

29 
rc
 = 
	`acûss
(
	`bd©a
(
rg‘
), 
R_OK
);

30 
	`bde¡roy
(
rg‘
);

32  
rc
 == 0;

33 
	}
}

36 
Profe
 *
	$Profe_lßd
(
b¡ršg
 
´ofe_dœ
)

38 
Profe
 *
´of
 = 
	`ÿÎoc
((Profile), 1);

39 
	`check_mem
(
´of
);

41 
´of
->
commªd
 = 
	`bfÜm©
("%s/run", 
	`bd©a
(
´ofe_dœ
));

42 
´of
->
pid_fe
 = 
	`Profe_»ad_£‰šg
(
´ofe_dœ
, "pid_file");

43 
´of
->
»¡¬t
 = 
	`Profe_check_£‰šg
(
´ofe_dœ
, "restart");

45  
´of
;

47 
”rÜ
:

48  
NULL
;

49 
	}
}

	@examples/procer/rampart.c

1 
	~"´oûr.h
"

4 
	$Ram·¹_wa™
(
Ram·¹
 *
Ú
[])

6 
i
 = 0;

8 
i
 = 0; 
Ú
[i] !ğ
NULL
; i++) {

9 if(
	`Ram·¹_should_wa™
(
Ú
[
i
])) {

10 
	`sk¦“p
(&(
Ú
[
i
]->
wa™
));

15 
	}
}

17 
	$Ram·¹_ruÂšg
(
Ram·¹
 *
Ú
)

19 
Ú
->
ruÂšg
 = 1;

20 
Ú
->
çed
 = 0;

21 
	`skwakeu·Î
(&
Ú
->
wa™
);

22 
	}
}

24 
	$Ram·¹_nÙruÂšg
(
Ram·¹
 *
Ú
)

26 
Ú
->
ruÂšg
 = 0;

27 
	}
}

29 
	$Ram·¹_çed
(
Ram·¹
 *
Ú
)

31 
Ú
->
ruÂšg
 = 0;

32 
Ú
->
çed
 = 1;

33 
	`skwakeu·Î
(&
Ú
->
wa™
);

34 
	}
}

	@src/adt/darray.c

35 
	~"adt/d¬¿y.h
"

36 
	~"mem/h®loc.h
"

37 
	~<as£¹.h
>

40 
d¬¿y_t
 *
	$d¬¿y_ü—‹
(
size_t
 
–em’t_size
, size_ˆ
š™Ÿl_max
)

42 
d¬¿y_t
 *
¬¿y
 = 
	`h_m®loc
((darray_t));

43 
	`check_mem
(
¬¿y
);

44 
¬¿y
->
max
 = 
š™Ÿl_max
;

45 
	`check
(
¬¿y
->
max
 > 0, "You must set‡n initial_max > 0.");

47 
¬¿y
->
cÚ‹Ás
 = 
	`h_ÿÎoc
((*), 
š™Ÿl_max
);

48 
	`check_mem
(
¬¿y
->
cÚ‹Ás
);

49 
	`h©ch
(
¬¿y
->
cÚ‹Ás
,‡rray);

51 
¬¿y
->
’d
 = 0;

52 
¬¿y
->
–em’t_size
 =ƒlement_size;

53 
¬¿y
->
ex·nd_¿‹
 = 
DEFAULT_EXPAND_RATE
;

55  
¬¿y
;

57 
”rÜ
:

58 if(
¬¿y
è
	`h_ä“
(array);

59  
NULL
;

60 
	}
}

62 
	$d¬¿y_ş—r
(
d¬¿y_t
 *
¬¿y
)

64 
i
 = 0;

65 if(
¬¿y
->
–em’t_size
 > 0) {

66 
i
 = 0; i < 
¬¿y
->
max
; i++) {

67 if(
¬¿y
->
cÚ‹Ás
[
i
] !ğ
NULL
) {

68 
	`ä“
(
¬¿y
->
cÚ‹Ás
[
i
]);

72 
	}
}

74 
šlše
 
	$d¬¿y_»size
(
d¬¿y_t
 *
¬¿y
, 
size_t
 
Ãwsize
)

76 
¬¿y
->
max
 = 
Ãwsize
;

77 
	`check
(
¬¿y
->
max
 > 0, "The‚ewsize must be > 0.");

78 
¬¿y
->
cÚ‹Ás
 = 
	`h_»®loc
×¼ay->cÚ‹Ás,‡¼ay->
max
 * (*));

79 
	`check_mem
(
¬¿y
->
cÚ‹Ás
);

81 
”rÜ
:

83 
	}
}

85 
	$d¬¿y_ex·nd
(
d¬¿y_t
 *
¬¿y
)

87 
size_t
 
Şd_max
 = 
¬¿y
->
max
;

88 
	`check
(
	`d¬¿y_»size
(
¬¿y
,‡¼ay->
max
 +‡¼ay->
ex·nd_¿‹
) == 0,

90 
¬¿y
->
max
 + (ï¼ay->
ex·nd_¿‹
);

92 
	`mem£t
(
¬¿y
->
cÚ‹Ás
 + 
Şd_max
, 0,‡¼ay->
ex·nd_¿‹
 + 1);

95 
”rÜ
:

97 
	}
}

99 
	$d¬¿y_cÚŒaù
(
d¬¿y_t
 *
¬¿y
)

101 
Ãw_size
 = 
¬¿y
->
’d
 < (ï¼ay->
ex·nd_¿‹
 ? ()array->expand_rate :‡rray->end;

103  
	`d¬¿y_»size
(
¬¿y
, 
Ãw_size
 + 1);

104 
	}
}

107 
	$d¬¿y_de¡roy
(
d¬¿y_t
 *
¬¿y
)

109 
	`d¬¿y_ş—r
(
¬¿y
);

110 
	`h_ä“
(
¬¿y
);

111 
	}
}

113 
	$d¬¿y_push
(
d¬¿y_t
 *
¬¿y
, *
–
)

115 
¬¿y
->
cÚ‹Ás
[¬¿y->
’d
] = 
–
;

116 
¬¿y
->
’d
++;

118 if(
	`d¬¿y_’d
(
¬¿y
è>ğ
	`d¬¿y_max
(array)) {

119  
	`d¬¿y_ex·nd
(
¬¿y
);

123 
	}
}

125 *
	$d¬¿y_pİ
(
d¬¿y_t
 *
¬¿y
)

127 
	`check
(
¬¿y
->
’d
 - 1 > 0, "Attempto…op fromƒmpty‡rray.");

129 *
–
 = 
	`d¬¿y_»move
(
¬¿y
,‡¼ay->
’d
 - 1);

130 
¬¿y
->
’d
--;

132 if(
	`d¬¿y_’d
(
¬¿y
è> (ï¼ay->
ex·nd_¿‹
 && darray_end(array) %‡rray->expand_rate) {

133 
	`d¬¿y_cÚŒaù
(
¬¿y
);

136  
–
;

137 
”rÜ
:

138  
NULL
;

139 
	}
}

	@src/adt/darray.h

1 #iâdeà
_d¬¿y_h


2 
	#_d¬¿y_h


	)

3 
	~"dbg.h
"

4 
	~<¡dlib.h
>

5 
	~<as£¹.h
>

7 
	sd¬¿y_t
 {

8 
	m’d
;

9 
	mmax
;

10 
size_t
 
	m–em’t_size
;

11 
size_t
 
	mex·nd_¿‹
;

12 **
	mcÚ‹Ás
;

13 } 
	td¬¿y_t
;

15 
d¬¿y_t
 *
d¬¿y_ü—‹
(
size_t
 
–em’t_size
, size_ˆ
š™Ÿl_max
);

17 
d¬¿y_de¡roy
(
d¬¿y_t
 *
¬¿y
);

19 
d¬¿y_ş—r
(
d¬¿y_t
 *
¬¿y
);

21 
d¬¿y_ex·nd
(
d¬¿y_t
 *
¬¿y
);

23 
d¬¿y_cÚŒaù
(
d¬¿y_t
 *
¬¿y
);

25 
d¬¿y_push
(
d¬¿y_t
 *
¬¿y
, *
–
);

27 *
d¬¿y_pİ
(
d¬¿y_t
 *
¬¿y
);

29 
	#d¬¿y_Ï¡
(
A
è((A)->
cÚ‹Ás
[(A)->
’d
 - 1])

	)

30 
	#d¬¿y_fœ¡
(
A
è((A)->
cÚ‹Ás
[0])

	)

31 
	#d¬¿y_’d
(
A
è((A)->
’d
)

	)

32 
	#d¬¿y_max
(
A
è((A)->
max
)

	)

34 
	#DEFAULT_EXPAND_RATE
 300

	)

37 
šlše
 
	$d¬¿y_£t
(
d¬¿y_t
 *
¬¿y
, 
i
, *
–
)

39 
	`check
(
i
 < 
¬¿y
->
max
, "darray‡ttempto set…ast max");

40 
¬¿y
->
cÚ‹Ás
[
i
] = 
–
;

41 
”rÜ
:

43 
	}
}

45 
šlše
 *
	$d¬¿y_g‘
(
d¬¿y_t
 *
¬¿y
, 
i
)

47 
	`as£¹
(
i
 < 
¬¿y
->
max
 && "darray‡ttempto get…ast max");

48  
¬¿y
->
cÚ‹Ás
[
i
];

49 
	}
}

51 
šlše
 *
	$d¬¿y_»move
(
d¬¿y_t
 *
¬¿y
, 
i
)

53 *
–
 = 
¬¿y
->
cÚ‹Ás
[
i
];

55 
¬¿y
->
cÚ‹Ás
[
i
] = 
NULL
;

57  
–
;

58 
	}
}

60 
šlše
 *
	$d¬¿y_Ãw
(
d¬¿y_t
 *
¬¿y
)

62 
	`check
(
¬¿y
->
–em’t_size
 > 0, "Can't use darray_new on 0 size darrays.");

64  
	`ÿÎoc
(1, 
¬¿y
->
–em’t_size
);

66 
”rÜ
:

67  
NULL
;

68 
	}
}

	@src/adt/dict.c

21 
	~<¡dlib.h
>

22 
	~<¡ddef.h
>

23 
	~<as£¹.h
>

24 
	#DICT_IMPLEMENTATION


	)

25 
	~"diù.h
"

27 #ifdeà
KAZLIB_RCSID


28 cÚ¡ 
	grcsid
[] = "$Id: dict.c,v 1.40.2.7 2000/11/13 01:36:44 kaz Exp $";

43 
	#Ëá
 
diù_Ëá


	)

44 
	#right
 
diù_right


	)

45 
	#·»Á
 
diù_·»Á


	)

46 
	#cŞÜ
 
diù_cŞÜ


	)

47 
	#key
 
diù_key


	)

48 
	#d©a
 
diù_d©a


	)

50 
	#nnode
 
diù_nnode


	)

51 
	#nodecouÁ
 
diù_nodecouÁ


	)

52 
	#maxcouÁ
 
diù_maxcouÁ


	)

53 
	#com·»
 
diù_com·»


	)

54 
	#®loúode
 
diù_®loúode


	)

55 
	#ä“node
 
diù_ä“node


	)

56 
	#cÚ‹xt
 
diù_cÚ‹xt


	)

57 
	#du³s
 
diù_du³s


	)

59 
	#diù±r
 
diù_diù±r


	)

61 
	#diù_roÙ
(
D
è((D)->
nnode
.
Ëá
)

	)

62 
	#diù_n
(
D
è(&(D)->
nnode
)

	)

63 
	#DICT_DEPTH_MAX
 64

	)

65 
dnode_t
 *
dnode_®loc
(*
cÚ‹xt
);

66 
dnode_ä“
(
dnode_t
 *
node
, *
cÚ‹xt
);

75 
	$rÙ©e_Ëá
(
dnode_t
 *
uµ”
)

77 
dnode_t
 *
low”
, *
lowËá
, *
uµ¬’t
;

79 
low”
 = 
uµ”
->
right
;

80 
uµ”
->
right
 = 
lowËá
 = 
low”
->
Ëá
;

81 
lowËá
->
·»Á
 = 
uµ”
;

83 
low”
->
·»Á
 = 
uµ¬’t
 = 
uµ”
->parent;

88 ià(
uµ”
 =ğ
uµ¬’t
->
Ëá
) {

89 
uµ¬’t
->
Ëá
 = 
low”
;

91 
	`as£¹
 (
uµ”
 =ğ
uµ¬’t
->
right
);

92 
uµ¬’t
->
right
 = 
low”
;

95 
low”
->
Ëá
 = 
uµ”
;

96 
uµ”
->
·»Á
 = 
low”
;

97 
	}
}

104 
	$rÙ©e_right
(
dnode_t
 *
uµ”
)

106 
dnode_t
 *
low”
, *
lowright
, *
uµ¬’t
;

108 
low”
 = 
uµ”
->
Ëá
;

109 
uµ”
->
Ëá
 = 
lowright
 = 
low”
->
right
;

110 
lowright
->
·»Á
 = 
uµ”
;

112 
low”
->
·»Á
 = 
uµ¬’t
 = 
uµ”
->parent;

114 ià(
uµ”
 =ğ
uµ¬’t
->
right
) {

115 
uµ¬’t
->
right
 = 
low”
;

117 
	`as£¹
 (
uµ”
 =ğ
uµ¬’t
->
Ëá
);

118 
uµ¬’t
->
Ëá
 = 
low”
;

121 
low”
->
right
 = 
uµ”
;

122 
uµ”
->
·»Á
 = 
low”
;

123 
	}
}

130 
	$ä“_nodes
(
diù_t
 *
diù
, 
dnode_t
 *
node
, dnode_ˆ*
n
)

132 ià(
node
 =ğ
n
)

134 
	`ä“_nodes
(
diù
, 
node
->
Ëá
, 
n
);

135 
	`ä“_nodes
(
diù
, 
node
->
right
, 
n
);

136 
diù
->
	`ä“node
(
node
, diù->
cÚ‹xt
);

137 
	}
}

148 
	$v”ify_bšŒ“
(
diù_t
 *
diù
)

150 
dnode_t
 *
fœ¡
, *
Ãxt
;

152 
fœ¡
 = 
	`diù_fœ¡
(
diù
);

154 ià(
diù
->
du³s
) {

155 
fœ¡
 && (
Ãxt
 = 
	`diù_Ãxt
(
diù
, first))) {

156 ià(
diù
->
	`com·»
(
fœ¡
->
key
, 
Ãxt
->key) > 0)

158 
fœ¡
 = 
Ãxt
;

161 
fœ¡
 && (
Ãxt
 = 
	`diù_Ãxt
(
diù
, first))) {

162 ià(
diù
->
	`com·»
(
fœ¡
->
key
, 
Ãxt
->key) >= 0)

164 
fœ¡
 = 
Ãxt
;

168 
	}
}

184 
	$v”ify_»dbÏck
(
dnode_t
 *
n
, dnode_ˆ*
roÙ
)

186 
height_Ëá
, 
height_right
;

188 ià(
roÙ
 !ğ
n
) {

189 
height_Ëá
 = 
	`v”ify_»dbÏck
(
n
, 
roÙ
->
Ëá
);

190 
height_right
 = 
	`v”ify_»dbÏck
(
n
, 
roÙ
->
right
);

191 ià(
height_Ëá
 =ğ0 || 
height_right
 == 0)

193 ià(
height_Ëá
 !ğ
height_right
)

195 ià(
roÙ
->
cŞÜ
 =ğ
dnode_»d
) {

196 ià(
roÙ
->
Ëá
->
cŞÜ
 !ğ
dnode_bÏck
)

198 ià(
roÙ
->
right
->
cŞÜ
 !ğ
dnode_bÏck
)

200  
height_Ëá
;

202 ià(
roÙ
->
cŞÜ
 !ğ
dnode_bÏck
)

204  
height_Ëá
 + 1;

207 
	}
}

215 
diùcouÁ_t
 
	$v”ify_node_couÁ
(
dnode_t
 *
n
, dnode_ˆ*
roÙ
)

217 ià(
roÙ
 =ğ
n
)

220  1 + 
	`v”ify_node_couÁ
(
n
, 
roÙ
->
Ëá
)

221 + 
	`v”ify_node_couÁ
(
n
, 
roÙ
->
right
);

222 
	}
}

231 
	$v”ify_diù_has_node
(
dnode_t
 *
n
, dnode_ˆ*
roÙ
, dnode_ˆ*
node
)

233 ià(
roÙ
 !ğ
n
) {

234  
roÙ
 =ğ
node


235 || 
	`v”ify_diù_has_node
(
n
, 
roÙ
->
Ëá
, 
node
)

236 || 
	`v”ify_diù_has_node
(
n
, 
roÙ
->
right
, 
node
);

239 
	}
}

246 
diù_t
 *
	$diù_ü—‹
(
diùcouÁ_t
 
maxcouÁ
, 
diù_comp_t
 
comp
)

248 
diù_t
 *
Ãw
 = 
	`m®loc
( *new);

250 ià(
Ãw
) {

251 
Ãw
->
com·»
 = 
comp
;

252 
Ãw
->
®loúode
 = 
dnode_®loc
;

253 
Ãw
->
ä“node
 = 
dnode_ä“
;

254 
Ãw
->
cÚ‹xt
 = 
NULL
;

255 
Ãw
->
nodecouÁ
 = 0;

256 
Ãw
->
maxcouÁ
 = maxcount;

257 
Ãw
->
nnode
.
Ëá
 = &new->nilnode;

258 
Ãw
->
nnode
.
right
 = &new->nilnode;

259 
Ãw
->
nnode
.
·»Á
 = &new->nilnode;

260 
Ãw
->
nnode
.
cŞÜ
 = 
dnode_bÏck
;

261 
Ãw
->
du³s
 = 0;

263  
Ãw
;

264 
	}
}

270 
	$diù_£t_®loÿtÜ
(
diù_t
 *
diù
, 
dnode_®loc_t
 
®
,

271 
dnode_ä“_t
 
ä
, *
cÚ‹xt
)

273 
	`as£¹
 (
	`diù_couÁ
(
diù
) == 0);

274 
	`as£¹
 ((
®
 =ğ
NULL
 && 
ä
 == NULL) || (al != NULL && fr != NULL));

276 
diù
->
®loúode
 = 
®
 ?‡È: 
dnode_®loc
;

277 
diù
->
ä“node
 = 
ä
 ? f¸: 
dnode_ä“
;

278 
diù
->
cÚ‹xt
 = context;

279 
	}
}

286 
	$diù_de¡roy
(
diù_t
 *
diù
)

288 
	`as£¹
 (
	`diù_i£m±y
(
diù
));

289 
	`ä“
(
diù
);

290 
	}
}

297 
	$diù_ä“_nodes
(
diù_t
 *
diù
)

299 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(dict);

300 
	`ä“_nodes
(
diù
, 
roÙ
, 
n
);

301 
diù
->
nodecouÁ
 = 0;

302 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

303 
diù
->
nnode
.
right
 = &dict->nilnode;

304 
	}
}

310 
	$diù_ä“
(
diù_t
 *
diù
)

312 #ifdeà
KAZLIB_OBSOLESCENT_DEBUG


313 
	`as£¹
 ("callo obsolescent function dict_free()" && 0);

315 
	`diù_ä“_nodes
(
diù
);

316 
	}
}

322 
diù_t
 *
	$diù_š™
(
diù_t
 *
diù
, 
diùcouÁ_t
 
maxcouÁ
, 
diù_comp_t
 
comp
)

324 
diù
->
com·»
 = 
comp
;

325 
diù
->
®loúode
 = 
dnode_®loc
;

326 
diù
->
ä“node
 = 
dnode_ä“
;

327 
diù
->
cÚ‹xt
 = 
NULL
;

328 
diù
->
nodecouÁ
 = 0;

329 
diù
->
maxcouÁ
 = maxcount;

330 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

331 
diù
->
nnode
.
right
 = &dict->nilnode;

332 
diù
->
nnode
.
·»Á
 = &dict->nilnode;

333 
diù
->
nnode
.
cŞÜ
 = 
dnode_bÏck
;

334 
diù
->
du³s
 = 0;

335  
diù
;

336 
	}
}

342 
	$diù_š™_like
(
diù_t
 *
diù
, cÚ¡ diù_ˆ*
‹m¶©e
)

344 
diù
->
com·»
 = 
‹m¶©e
->compare;

345 
diù
->
®loúode
 = 
‹m¶©e
->allocnode;

346 
diù
->
ä“node
 = 
‹m¶©e
->freenode;

347 
diù
->
cÚ‹xt
 = 
‹m¶©e
->context;

348 
diù
->
nodecouÁ
 = 0;

349 
diù
->
maxcouÁ
 = 
‹m¶©e
->maxcount;

350 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

351 
diù
->
nnode
.
right
 = &dict->nilnode;

352 
diù
->
nnode
.
·»Á
 = &dict->nilnode;

353 
diù
->
nnode
.
cŞÜ
 = 
dnode_bÏck
;

354 
diù
->
du³s
 = 
‹m¶©e
->dupes;

356 
	`as£¹
 (
	`diù_sim¬
(
diù
, 
‹m¶©e
));

357 
	}
}

363 
	$diù_ş—r
(
diù_t
 *
diù
)

365 
diù
->
nodecouÁ
 = 0;

366 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

367 
diù
->
nnode
.
right
 = &dict->nilnode;

368 
diù
->
nnode
.
·»Á
 = &dict->nilnode;

369 
	`as£¹
 (
diù
->
nnode
.
cŞÜ
 =ğ
dnode_bÏck
);

370 
	}
}

380 
	$diù_v”ify
(
diù_t
 *
diù
)

382 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(dict);

385 ià(
roÙ
->
cŞÜ
 !ğ
dnode_bÏck
)

387 ià(
n
->
cŞÜ
 !ğ
dnode_bÏck
)

389 ià(
n
->
right
 !=‚il)

392 ià(
n
->
Ëá
->
·»Á
 !=‚il)

395 ià(!
	`v”ify_bšŒ“
(
diù
))

398 ià(!
	`v”ify_»dbÏck
(
n
, 
roÙ
))

400 ià(
	`v”ify_node_couÁ
(
n
, 
roÙ
è!ğ
	`diù_couÁ
(
diù
))

403 
	}
}

410 
	$diù_sim¬
(cÚ¡ 
diù_t
 *
Ëá
, cÚ¡ diù_ˆ*
right
)

412 ià(
Ëá
->
com·»
 !ğ
right
->compare)

415 ià(
Ëá
->
®loúode
 !ğ
right
->allocnode)

418 ià(
Ëá
->
ä“node
 !ğ
right
->freenode)

421 ià(
Ëá
->
cÚ‹xt
 !ğ
right
->context)

424 ià(
Ëá
->
du³s
 !ğ
right
->dupes)

428 
	}
}

437 
dnode_t
 *
	$diù_lookup
(
diù_t
 *
diù
, cÚ¡ *
key
)

439 
dnode_t
 *
roÙ
 = 
	`diù_roÙ
(
diù
);

440 
dnode_t
 *
n
 = 
	`diù_n
(
diù
);

441 
dnode_t
 *
§ved
;

442 
»suÉ
;

446 
roÙ
 !ğ
n
) {

447 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
roÙ
->key);

448 ià(
»suÉ
 < 0)

449 
roÙ
 =„oÙ->
Ëá
;

450 ià(
»suÉ
 > 0)

451 
roÙ
 =„oÙ->
right
;

453 ià(!
diù
->
du³s
) {

454  
roÙ
;

457 
§ved
 = 
roÙ
;

458 
roÙ
 =„oÙ->
Ëá
;

459 
roÙ
 !ğ
n
 && 
diù
->
	`com·»
(
key
,„oot->key))

460 
roÙ
 =„oÙ->
right
;

461 } 
roÙ
 !ğ
n
);

462  
§ved
;

467  
NULL
;

468 
	}
}

475 
dnode_t
 *
	$diù_low”_bound
(
diù_t
 *
diù
, cÚ¡ *
key
)

477 
dnode_t
 *
roÙ
 = 
	`diù_roÙ
(
diù
);

478 
dnode_t
 *
n
 = 
	`diù_n
(
diù
);

479 
dnode_t
 *
‹Á©ive
 = 0;

481 
roÙ
 !ğ
n
) {

482 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
roÙ
->key);

484 ià(
»suÉ
 > 0) {

485 
roÙ
 =„oÙ->
right
;

486 } ià(
»suÉ
 < 0) {

487 
‹Á©ive
 = 
roÙ
;

488 
roÙ
 =„oÙ->
Ëá
;

490 ià(!
diù
->
du³s
) {

491  
roÙ
;

493 
‹Á©ive
 = 
roÙ
;

494 
roÙ
 =„oÙ->
Ëá
;

499  
‹Á©ive
;

500 
	}
}

507 
dnode_t
 *
	$diù_uµ”_bound
(
diù_t
 *
diù
, cÚ¡ *
key
)

509 
dnode_t
 *
roÙ
 = 
	`diù_roÙ
(
diù
);

510 
dnode_t
 *
n
 = 
	`diù_n
(
diù
);

511 
dnode_t
 *
‹Á©ive
 = 0;

513 
roÙ
 !ğ
n
) {

514 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
roÙ
->key);

516 ià(
»suÉ
 < 0) {

517 
roÙ
 =„oÙ->
Ëá
;

518 } ià(
»suÉ
 > 0) {

519 
‹Á©ive
 = 
roÙ
;

520 
roÙ
 =„oÙ->
right
;

522 ià(!
diù
->
du³s
) {

523  
roÙ
;

525 
‹Á©ive
 = 
roÙ
;

526 
roÙ
 =„oÙ->
right
;

531  
‹Á©ive
;

532 
	}
}

542 
	$diù_š£¹
(
diù_t
 *
diù
, 
dnode_t
 *
node
, cÚ¡ *
key
)

544 
dnode_t
 *
wh”e
 = 
	`diù_roÙ
(
diù
), *
n
 = 
	`diù_n
(dict);

545 
dnode_t
 *
·»Á
 = 
n
, *
unşe
, *
g¿nd·
;

546 
»suÉ
 = -1;

548 
node
->
key
 = key;

550 
	`as£¹
 (!
	`diù_isfuÎ
(
diù
));

551 
	`as£¹
 (!
	`diù_cÚšs
(
diù
, 
node
));

552 
	`as£¹
 (!
	`dnode_is_š_a_diù
(
node
));

556 
wh”e
 !ğ
n
) {

557 
·»Á
 = 
wh”e
;

558 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
wh”e
->key);

560 
	`as£¹
 (
diù
->
du³s
 || 
»suÉ
 != 0);

561 ià(
»suÉ
 < 0)

562 
wh”e
 = wh”e->
Ëá
;

564 
wh”e
 = wh”e->
right
;

567 
	`as£¹
 (
wh”e
 =ğ
n
);

569 ià(
»suÉ
 < 0)

570 
·»Á
->
Ëá
 = 
node
;

572 
·»Á
->
right
 = 
node
;

574 
node
->
·»Á
 =…arent;

575 
node
->
Ëá
 = 
n
;

576 
node
->
right
 = 
n
;

578 
diù
->
nodecouÁ
++;

582 
node
->
cŞÜ
 = 
dnode_»d
;

584 
·»Á
->
cŞÜ
 =ğ
dnode_»d
) {

585 
g¿nd·
 = 
·»Á
->parent;

586 ià(
·»Á
 =ğ
g¿nd·
->
Ëá
) {

587 
unşe
 = 
g¿nd·
->
right
;

588 ià(
unşe
->
cŞÜ
 =ğ
dnode_»d
) {

589 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

590 
unşe
->
cŞÜ
 = 
dnode_bÏck
;

591 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

592 
node
 = 
g¿nd·
;

593 
·»Á
 = 
g¿nd·
->parent;

595 ià(
node
 =ğ
·»Á
->
right
) {

596 
	`rÙ©e_Ëá
(
·»Á
);

597 
·»Á
 = 
node
;

598 
	`as£¹
 (
g¿nd·
 =ğ
·»Á
->parent);

601 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

602 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

603 
	`rÙ©e_right
(
g¿nd·
);

607 
unşe
 = 
g¿nd·
->
Ëá
;

608 ià(
unşe
->
cŞÜ
 =ğ
dnode_»d
) {

609 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

610 
unşe
->
cŞÜ
 = 
dnode_bÏck
;

611 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

612 
node
 = 
g¿nd·
;

613 
·»Á
 = 
g¿nd·
->parent;

615 ià(
node
 =ğ
·»Á
->
Ëá
) {

616 
	`rÙ©e_right
(
·»Á
);

617 
·»Á
 = 
node
;

618 
	`as£¹
 (
g¿nd·
 =ğ
·»Á
->parent);

620 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

621 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

622 
	`rÙ©e_Ëá
(
g¿nd·
);

628 
	`diù_roÙ
(
diù
)->
cŞÜ
 = 
dnode_bÏck
;

630 
	`as£¹
 (
	`diù_v”ify
(
diù
));

631 
	}
}

639 
dnode_t
 *
	$diù_d–‘e
(
diù_t
 *
diù
, 
dnode_t
 *
d–‘e
)

641 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
chd
, *
d–·»Á
 = 
d–‘e
->
·»Á
;

645 
	`as£¹
 (!
	`diù_i£m±y
(
diù
));

646 
	`as£¹
 (
	`diù_cÚšs
(
diù
, 
d–‘e
));

660 ià(
d–‘e
->
Ëá
 !ğ
n
 && d–‘e->
right
 !=‚il) {

661 
dnode_t
 *
Ãxt
 = 
	`diù_Ãxt
(
diù
, 
d–‘e
);

662 
dnode_t
 *
Ãx¬’t
 = 
Ãxt
->
·»Á
;

663 
dnode_cŞÜ_t
 
ÃxtcŞÜ
 = 
Ãxt
->
cŞÜ
;

665 
	`as£¹
 (
Ãxt
 !ğ
n
);

666 
	`as£¹
 (
Ãxt
->
·»Á
 !ğ
n
);

667 
	`as£¹
 (
Ãxt
->
Ëá
 =ğ
n
);

674 
chd
 = 
Ãxt
->
right
;

675 
chd
->
·»Á
 = 
Ãx¬’t
;

677 ià(
Ãx¬’t
->
Ëá
 =ğ
Ãxt
) {

678 
Ãx¬’t
->
Ëá
 = 
chd
;

680 
	`as£¹
 (
Ãx¬’t
->
right
 =ğ
Ãxt
);

681 
Ãx¬’t
->
right
 = 
chd
;

689 
Ãxt
->
·»Á
 = 
d–·»Á
;

690 
Ãxt
->
Ëá
 = 
d–‘e
->left;

691 
Ãxt
->
right
 = 
d–‘e
->right;

692 
Ãxt
->
Ëá
->
·»Á
 =‚ext;

693 
Ãxt
->
right
->
·»Á
 =‚ext;

694 
Ãxt
->
cŞÜ
 = 
d–‘e
->color;

695 
d–‘e
->
cŞÜ
 = 
ÃxtcŞÜ
;

697 ià(
d–·»Á
->
Ëá
 =ğ
d–‘e
) {

698 
d–·»Á
->
Ëá
 = 
Ãxt
;

700 
	`as£¹
 (
d–·»Á
->
right
 =ğ
d–‘e
);

701 
d–·»Á
->
right
 = 
Ãxt
;

705 
	`as£¹
 (
d–‘e
 !ğ
n
);

706 
	`as£¹
 (
d–‘e
->
Ëá
 =ğ
n
 || d–‘e->
right
 ==‚il);

708 
chd
 = (
d–‘e
->
Ëá
 !ğ
n
è? d–‘e->Ëá : d–‘e->
right
;

710 
chd
->
·»Á
 = 
d–·»Á
 = 
d–‘e
->parent;

712 ià(
d–‘e
 =ğ
d–·»Á
->
Ëá
) {

713 
d–·»Á
->
Ëá
 = 
chd
;

715 
	`as£¹
 (
d–‘e
 =ğ
d–·»Á
->
right
);

716 
d–·»Á
->
right
 = 
chd
;

720 
d–‘e
->
·»Á
 = 
NULL
;

721 
d–‘e
->
right
 = 
NULL
;

722 
d–‘e
->
Ëá
 = 
NULL
;

724 
diù
->
nodecouÁ
--;

726 
	`as£¹
 (
	`v”ify_bšŒ“
(
diù
));

730 ià(
d–‘e
->
cŞÜ
 =ğ
dnode_bÏck
) {

731 
dnode_t
 *
·»Á
, *
si¡”
;

733 
	`diù_roÙ
(
diù
)->
cŞÜ
 = 
dnode_»d
;

735 
chd
->
cŞÜ
 =ğ
dnode_bÏck
) {

736 
·»Á
 = 
chd
->parent;

737 ià(
chd
 =ğ
·»Á
->
Ëá
) {

738 
si¡”
 = 
·»Á
->
right
;

739 
	`as£¹
 (
si¡”
 !ğ
n
);

740 ià(
si¡”
->
cŞÜ
 =ğ
dnode_»d
) {

741 
si¡”
->
cŞÜ
 = 
dnode_bÏck
;

742 
·»Á
->
cŞÜ
 = 
dnode_»d
;

743 
	`rÙ©e_Ëá
(
·»Á
);

744 
si¡”
 = 
·»Á
->
right
;

745 
	`as£¹
 (
si¡”
 !ğ
n
);

747 ià(
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_bÏck


748 && 
si¡”
->
right
->
cŞÜ
 =ğ
dnode_bÏck
) {

749 
si¡”
->
cŞÜ
 = 
dnode_»d
;

750 
chd
 = 
·»Á
;

752 ià(
si¡”
->
right
->
cŞÜ
 =ğ
dnode_bÏck
) {

753 
	`as£¹
 (
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_»d
);

754 
si¡”
->
Ëá
->
cŞÜ
 = 
dnode_bÏck
;

755 
si¡”
->
cŞÜ
 = 
dnode_»d
;

756 
	`rÙ©e_right
(
si¡”
);

757 
si¡”
 = 
·»Á
->
right
;

758 
	`as£¹
 (
si¡”
 !ğ
n
);

760 
si¡”
->
cŞÜ
 = 
·»Á
->color;

761 
si¡”
->
right
->
cŞÜ
 = 
dnode_bÏck
;

762 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

763 
	`rÙ©e_Ëá
(
·»Á
);

767 
	`as£¹
 (
chd
 =ğ
·»Á
->
right
);

768 
si¡”
 = 
·»Á
->
Ëá
;

769 
	`as£¹
 (
si¡”
 !ğ
n
);

770 ià(
si¡”
->
cŞÜ
 =ğ
dnode_»d
) {

771 
si¡”
->
cŞÜ
 = 
dnode_bÏck
;

772 
·»Á
->
cŞÜ
 = 
dnode_»d
;

773 
	`rÙ©e_right
(
·»Á
);

774 
si¡”
 = 
·»Á
->
Ëá
;

775 
	`as£¹
 (
si¡”
 !ğ
n
);

777 ià(
si¡”
->
right
->
cŞÜ
 =ğ
dnode_bÏck


778 && 
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_bÏck
) {

779 
si¡”
->
cŞÜ
 = 
dnode_»d
;

780 
chd
 = 
·»Á
;

782 ià(
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_bÏck
) {

783 
	`as£¹
 (
si¡”
->
right
->
cŞÜ
 =ğ
dnode_»d
);

784 
si¡”
->
right
->
cŞÜ
 = 
dnode_bÏck
;

785 
si¡”
->
cŞÜ
 = 
dnode_»d
;

786 
	`rÙ©e_Ëá
(
si¡”
);

787 
si¡”
 = 
·»Á
->
Ëá
;

788 
	`as£¹
 (
si¡”
 !ğ
n
);

790 
si¡”
->
cŞÜ
 = 
·»Á
->color;

791 
si¡”
->
Ëá
->
cŞÜ
 = 
dnode_bÏck
;

792 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

793 
	`rÙ©e_right
(
·»Á
);

799 
chd
->
cŞÜ
 = 
dnode_bÏck
;

800 
	`diù_roÙ
(
diù
)->
cŞÜ
 = 
dnode_bÏck
;

803 
	`as£¹
 (
	`diù_v”ify
(
diù
));

805  
d–‘e
;

806 
	}
}

813 
	$diù_®loc_š£¹
(
diù_t
 *
diù
, cÚ¡ *
key
, *
d©a
)

815 
dnode_t
 *
node
 = 
diù
->
	`®loúode
(diù->
cÚ‹xt
);

817 ià(
node
) {

818 
	`dnode_š™
(
node
, 
d©a
);

819 
	`diù_š£¹
(
diù
, 
node
, 
key
);

823 
	}
}

825 
	$diù_d–‘e_ä“
(
diù_t
 *
diù
, 
dnode_t
 *
node
)

827 
	`diù_d–‘e
(
diù
, 
node
);

828 
diù
->
	`ä“node
(
node
, diù->
cÚ‹xt
);

829 
	}
}

836 
dnode_t
 *
	$diù_fœ¡
(
diù_t
 *
diù
)

838 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(diù), *
Ëá
;

840 ià(
roÙ
 !ğ
n
)

841 (
Ëá
 = 
roÙ
->Ëáè!ğ
n
)

842 
roÙ
 = 
Ëá
;

844  (
roÙ
 =ğ
n
è? 
NULL
 :„oot;

845 
	}
}

852 
dnode_t
 *
	$diù_Ï¡
(
diù_t
 *
diù
)

854 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(diù), *
right
;

856 ià(
roÙ
 !ğ
n
)

857 (
right
 = 
roÙ
->rightè!ğ
n
)

858 
roÙ
 = 
right
;

860  (
roÙ
 =ğ
n
è? 
NULL
 :„oot;

861 
	}
}

870 
dnode_t
 *
	$diù_Ãxt
(
diù_t
 *
diù
, 
dnode_t
 *
cu¼
)

872 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
·»Á
, *
Ëá
;

874 ià(
cu¼
->
right
 !ğ
n
) {

875 
cu¼
 = cu¼->
right
;

876 (
Ëá
 = 
cu¼
->Ëáè!ğ
n
)

877 
cu¼
 = 
Ëá
;

878  
cu¼
;

881 
·»Á
 = 
cu¼
->parent;

883 
·»Á
 !ğ
n
 && 
cu¼
 =ğ·»Á->
right
) {

884 
cu¼
 = 
·»Á
;

885 
·»Á
 = 
cu¼
->parent;

888  (
·»Á
 =ğ
n
è? 
NULL
 :…arent;

889 
	}
}

896 
dnode_t
 *
	$diù_´ev
(
diù_t
 *
diù
, 
dnode_t
 *
cu¼
)

898 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
·»Á
, *
right
;

900 ià(
cu¼
->
Ëá
 !ğ
n
) {

901 
cu¼
 = cu¼->
Ëá
;

902 (
right
 = 
cu¼
->rightè!ğ
n
)

903 
cu¼
 = 
right
;

904  
cu¼
;

907 
·»Á
 = 
cu¼
->parent;

909 
·»Á
 !ğ
n
 && 
cu¼
 =ğ·»Á->
Ëá
) {

910 
cu¼
 = 
·»Á
;

911 
·»Á
 = 
cu¼
->parent;

914  (
·»Á
 =ğ
n
è? 
NULL
 :…arent;

915 
	}
}

917 
	$diù_®low_du³s
(
diù_t
 *
diù
)

919 
diù
->
du³s
 = 1;

920 
	}
}

922 #undeà
diù_couÁ


923 #undeà
diù_i£m±y


924 #undeà
diù_isfuÎ


925 #undeà
dnode_g‘


926 #undeà
dnode_put


927 #undeà
dnode_g‘key


929 
diùcouÁ_t
 
	$diù_couÁ
(
diù_t
 *
diù
)

931  
diù
->
nodecouÁ
;

932 
	}
}

934 
	$diù_i£m±y
(
diù_t
 *
diù
)

936  
diù
->
nodecouÁ
 == 0;

937 
	}
}

939 
	$diù_isfuÎ
(
diù_t
 *
diù
)

941  
diù
->
nodecouÁ
 =ğdiù->
maxcouÁ
;

942 
	}
}

944 
	$diù_cÚšs
(
diù_t
 *
diù
, 
dnode_t
 *
node
)

946  
	`v”ify_diù_has_node
(
	`diù_n
(
diù
), 
	`diù_roÙ
(diù), 
node
);

947 
	}
}

949 
dnode_t
 *
	$dnode_®loc
(*
cÚ‹xt
)

951  
	`m®loc
( *
	`dnode_®loc
(
NULL
));

952 
	}
}

954 
	$dnode_ä“
(
dnode_t
 *
node
, *
cÚ‹xt
)

956 
	`ä“
(
node
);

957 
	}
}

959 
dnode_t
 *
	$dnode_ü—‹
(*
d©a
)

961 
dnode_t
 *
Ãw
 = 
	`m®loc
( *new);

962 ià(
Ãw
) {

963 
Ãw
->
d©a
 = data;

964 
Ãw
->
·»Á
 = 
NULL
;

965 
Ãw
->
Ëá
 = 
NULL
;

966 
Ãw
->
right
 = 
NULL
;

968  
Ãw
;

969 
	}
}

971 
dnode_t
 *
	$dnode_š™
(
dnode_t
 *
dnode
, *
d©a
)

973 
dnode
->
d©a
 = data;

974 
dnode
->
·»Á
 = 
NULL
;

975 
dnode
->
Ëá
 = 
NULL
;

976 
dnode
->
right
 = 
NULL
;

977  
dnode
;

978 
	}
}

980 
	$dnode_de¡roy
(
dnode_t
 *
dnode
)

982 
	`as£¹
 (!
	`dnode_is_š_a_diù
(
dnode
));

983 
	`ä“
(
dnode
);

984 
	}
}

986 *
	$dnode_g‘
(
dnode_t
 *
dnode
)

988  
dnode
->
d©a
;

989 
	}
}

991 cÚ¡ *
	$dnode_g‘key
(
dnode_t
 *
dnode
)

993  
dnode
->
key
;

994 
	}
}

996 
	$dnode_put
(
dnode_t
 *
dnode
, *
d©a
)

998 
dnode
->
d©a
 = data;

999 
	}
}

1001 
	$dnode_is_š_a_diù
(
dnode_t
 *
dnode
)

1003  (
dnode
->
·»Á
 && dnode->
Ëá
 && dnode->
right
);

1004 
	}
}

1006 
	$diù_´oûss
(
diù_t
 *
diù
, *
cÚ‹xt
, 
dnode_´oûss_t
 
funùiÚ
)

1008 
dnode_t
 *
node
 = 
	`diù_fœ¡
(
diù
), *
Ãxt
;

1010 
node
 !ğ
NULL
) {

1013 
	`as£¹
 (
	`diù_cÚšs
(
diù
, 
node
));

1014 
Ãxt
 = 
	`diù_Ãxt
(
diù
, 
node
);

1015 
	`funùiÚ
(
diù
, 
node
, 
cÚ‹xt
);

1016 
node
 = 
Ãxt
;

1018 
	}
}

1020 
	$lßd_begš_š‹º®
(
diù_lßd_t
 *
lßd
, 
diù_t
 *
diù
)

1022 
lßd
->
diù±r
 = 
diù
;

1023 
lßd
->
nnode
.
Ëá
 = &load->nilnode;

1024 
lßd
->
nnode
.
right
 = &load->nilnode;

1025 
	}
}

1027 
	$diù_lßd_begš
(
diù_lßd_t
 *
lßd
, 
diù_t
 *
diù
)

1029 
	`as£¹
 (
	`diù_i£m±y
(
diù
));

1030 
	`lßd_begš_š‹º®
(
lßd
, 
diù
);

1031 
	}
}

1033 
	$diù_lßd_Ãxt
(
diù_lßd_t
 *
lßd
, 
dnode_t
 *
Ãwnode
, cÚ¡ *
key
)

1035 
diù_t
 *
diù
 = 
lßd
->
diù±r
;

1036 
dnode_t
 *
n
 = &
lßd
->
nnode
;

1038 
	`as£¹
 (!
	`dnode_is_š_a_diù
(
Ãwnode
));

1039 
	`as£¹
 (
diù
->
nodecouÁ
 < diù->
maxcouÁ
);

1041 #iâdeà
NDEBUG


1042 ià(
diù
->
nodecouÁ
 > 0) {

1043 ià(
diù
->
du³s
)

1044 
	`as£¹
 (
diù
->
	`com·»
(
n
->
Ëá
->
key
, key) <= 0);

1046 
	`as£¹
 (
diù
->
	`com·»
(
n
->
Ëá
->
key
, key) < 0);

1050 
Ãwnode
->
key
 = key;

1051 
n
->
right
->
Ëá
 = 
Ãwnode
;

1052 
n
->
right
 = 
Ãwnode
;

1053 
Ãwnode
->
Ëá
 = 
n
;

1054 
diù
->
nodecouÁ
++;

1055 
	}
}

1057 
	$diù_lßd_’d
(
diù_lßd_t
 *
lßd
)

1059 
diù_t
 *
diù
 = 
lßd
->
diù±r
;

1060 
dnode_t
 *
Œ“
[
DICT_DEPTH_MAX
] = { 0 };

1061 
dnode_t
 *
cu¼
, *
diùn
 = 
	`diù_n
(
diù
), *
lßdn
 = &
lßd
->
nnode
, *
Ãxt
;

1062 
dnode_t
 *
com¶‘e
 = 0;

1063 
diùcouÁ_t
 
fuÎcouÁ
 = 
DICTCOUNT_T_MAX
, 
nodecouÁ
 = 
diù
->nodecount;

1064 
diùcouÁ_t
 
bÙrowcouÁ
;

1065 
ba£Ëv–
 = 0, 
Ëv–
 = 0, 
i
;

1067 
	`as£¹
 (
dnode_»d
 =ğ0 && 
dnode_bÏck
 == 1);

1069 
fuÎcouÁ
 >ğ
nodecouÁ
 && fullcount)

1070 
fuÎcouÁ
 >>= 1;

1072 
bÙrowcouÁ
 = 
nodecouÁ
 - 
fuÎcouÁ
;

1074 
cu¼
 = 
lßdn
->
Ëá
; cu¼ !ğlßdn; cu¼ = 
Ãxt
) {

1075 
Ãxt
 = 
cu¼
->
Ëá
;

1077 ià(
com¶‘e
 =ğ
NULL
 && 
bÙrowcouÁ
-- == 0) {

1078 
	`as£¹
 (
ba£Ëv–
 == 0);

1079 
	`as£¹
 (
Ëv–
 == 0);

1080 
ba£Ëv–
 = 
Ëv–
 = 1;

1081 
com¶‘e
 = 
Œ“
[0];

1083 ià(
com¶‘e
 != 0) {

1084 
Œ“
[0] = 0;

1085 
com¶‘e
->
right
 = 
diùn
;

1086 
Œ“
[
Ëv–
] != 0) {

1087 
Œ“
[
Ëv–
]->
right
 = 
com¶‘e
;

1088 
com¶‘e
->
·»Á
 = 
Œ“
[
Ëv–
];

1089 
com¶‘e
 = 
Œ“
[
Ëv–
];

1090 
Œ“
[
Ëv–
++] = 0;

1095 ià(
com¶‘e
 =ğ
NULL
) {

1096 
cu¼
->
Ëá
 = 
diùn
;

1097 
cu¼
->
right
 = 
diùn
;

1098 
cu¼
->
cŞÜ
 = 
Ëv–
 % 2;

1099 
com¶‘e
 = 
cu¼
;

1101 
	`as£¹
 (
Ëv–
 =ğ
ba£Ëv–
);

1102 
Œ“
[
Ëv–
] != 0) {

1103 
Œ“
[
Ëv–
]->
right
 = 
com¶‘e
;

1104 
com¶‘e
->
·»Á
 = 
Œ“
[
Ëv–
];

1105 
com¶‘e
 = 
Œ“
[
Ëv–
];

1106 
Œ“
[
Ëv–
++] = 0;

1109 
cu¼
->
Ëá
 = 
com¶‘e
;

1110 
cu¼
->
cŞÜ
 = (
Ëv–
 + 1) % 2;

1111 
com¶‘e
->
·»Á
 = 
cu¼
;

1112 
Œ“
[
Ëv–
] = 
cu¼
;

1113 
com¶‘e
 = 0;

1114 
Ëv–
 = 
ba£Ëv–
;

1118 ià(
com¶‘e
 =ğ
NULL
)

1119 
com¶‘e
 = 
diùn
;

1121 
i
 = 0; i < 
DICT_DEPTH_MAX
; i++) {

1122 ià(
Œ“
[
i
] != 0) {

1123 
Œ“
[
i
]->
right
 = 
com¶‘e
;

1124 
com¶‘e
->
·»Á
 = 
Œ“
[
i
];

1125 
com¶‘e
 = 
Œ“
[
i
];

1129 
diùn
->
cŞÜ
 = 
dnode_bÏck
;

1130 
diùn
->
right
 = dictnil;

1131 
com¶‘e
->
·»Á
 = 
diùn
;

1132 
com¶‘e
->
cŞÜ
 = 
dnode_bÏck
;

1133 
	`diù_roÙ
(
diù
èğ
com¶‘e
;

1135 
	`as£¹
 (
	`diù_v”ify
(
diù
));

1136 
	}
}

1138 
	$diù_m”ge
(
diù_t
 *
de¡
, diù_ˆ*
sourû
)

1140 
diù_lßd_t
 
lßd
;

1141 
dnode_t
 *
Ëánode
 = 
	`diù_fœ¡
(
de¡
), *
righŠode
 = diù_fœ¡(
sourû
);

1143 
	`as£¹
 (
	`diù_sim¬
(
de¡
, 
sourû
));

1145 ià(
sourû
 =ğ
de¡
)

1148 
de¡
->
nodecouÁ
 = 0;

1149 
	`lßd_begš_š‹º®
(&
lßd
, 
de¡
);

1152 ià(
Ëánode
 !ğ
NULL
 && 
righŠode
 != NULL) {

1153 ià(
de¡
->
	`com·»
(
Ëánode
->
key
, 
righŠode
->key) < 0)

1154 
cİyËá
;

1156 
cİyright
;

1157 } ià(
Ëánode
 !ğ
NULL
) {

1158 
cİyËá
;

1159 } ià(
righŠode
 !ğ
NULL
) {

1160 
cİyright
;

1162 
	`as£¹
 (
Ëánode
 =ğ
NULL
 && 
righŠode
 == NULL);

1166 
cİyËá
:

1168 
dnode_t
 *
Ãxt
 = 
	`diù_Ãxt
(
de¡
, 
Ëánode
);

1169 #iâdeà
NDEBUG


1170 
Ëánode
->
Ëá
 = 
NULL
;

1172 
	`diù_lßd_Ãxt
(&
lßd
, 
Ëánode
,†eánode->
key
);

1173 
Ëánode
 = 
Ãxt
;

1177 
cİyright
:

1179 
dnode_t
 *
Ãxt
 = 
	`diù_Ãxt
(
sourû
, 
righŠode
);

1180 #iâdeà
NDEBUG


1181 
righŠode
->
Ëá
 = 
NULL
;

1183 
	`diù_lßd_Ãxt
(&
lßd
, 
righŠode
,„ighŠode->
key
);

1184 
righŠode
 = 
Ãxt
;

1189 
	`diù_ş—r
(
sourû
);

1190 
	`diù_lßd_’d
(&
lßd
);

1191 
	}
}

	@src/adt/dict.h

1 #undeà
KAZLIB_OPAQUE_DEBUG


23 #iâdeà
DICT_H


24 
	#DICT_H


	)

26 
	~<lim™s.h
>

27 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


28 
	~"sfx.h
"

35 #ifdeà
__ılu¥lus


39 
	tdiùcouÁ_t
;

40 
	#DICTCOUNT_T_MAX
 
ULONG_MAX


	)

46 ’um { 
dnode_»d
, 
dnode_bÏck
 } 
	tdnode_cŞÜ_t
;

48 
	sdnode_t
 {

49 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

50 
dnode_t
 *
diù_Ëá
;

51 
dnode_t
 *
diù_right
;

52 
dnode_t
 *
diù_·»Á
;

53 
dnode_cŞÜ_t
 
diù_cŞÜ
;

54 cÚ¡ *
diù_key
;

55 *
diù_d©a
;

57 
diù_dummy
;

59 } 
	tdnode_t
;

61 (*
diù_comp_t
)(const *, const *);

62 
dnode_t
 *(*
	tdnode_®loc_t
)(*);

63 (*
dnode_ä“_t
)(
	tdnode_t
 *, *);

65 
	sdiù_t
 {

66 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

67 
dnode_t
 
diù_nnode
;

68 
diùcouÁ_t
 
diù_nodecouÁ
;

69 
diùcouÁ_t
 
diù_maxcouÁ
;

70 
diù_comp_t
 
diù_com·»
;

71 
dnode_®loc_t
 
diù_®loúode
;

72 
dnode_ä“_t
 
diù_ä“node
;

73 *
diù_cÚ‹xt
;

74 
diù_du³s
;

76 
diù_dummmy
;

78 } 
	tdiù_t
;

80 (*
dnode_´oûss_t
)(
	tdiù_t
 *, 
	tdnode_t
 *, *);

82 
	sdiù_lßd_t
 {

83 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

84 
diù_t
 *
diù_diù±r
;

85 
dnode_t
 
diù_nnode
;

87 
diù_dummmy
;

89 } 
	tdiù_lßd_t
;

91 
diù_t
 *
diù_ü—‹
(
diùcouÁ_t
, 
diù_comp_t
);

92 
diù_£t_®loÿtÜ
(
diù_t
 *, 
dnode_®loc_t
, 
dnode_ä“_t
, *);

93 
diù_de¡roy
(
diù_t
 *);

94 
diù_ä“_nodes
(
diù_t
 *);

95 
diù_ä“
(
diù_t
 *);

96 
diù_t
 *
diù_š™
(diù_ˆ*, 
diùcouÁ_t
, 
diù_comp_t
);

97 
diù_š™_like
(
diù_t
 *, const dict_t *);

98 
diù_v”ify
(
diù_t
 *);

99 
diù_sim¬
(cÚ¡ 
diù_t
 *, const dict_t *);

100 
dnode_t
 *
diù_lookup
(
diù_t
 *, const *);

101 
dnode_t
 *
diù_low”_bound
(
diù_t
 *, const *);

102 
dnode_t
 *
diù_uµ”_bound
(
diù_t
 *, const *);

103 
diù_š£¹
(
diù_t
 *, 
dnode_t
 *, const *);

104 
dnode_t
 *
diù_d–‘e
(
diù_t
 *, dnode_t *);

105 
diù_®loc_š£¹
(
diù_t
 *, const *, *);

106 
diù_d–‘e_ä“
(
diù_t
 *, 
dnode_t
 *);

107 
dnode_t
 *
diù_fœ¡
(
diù_t
 *);

108 
dnode_t
 *
diù_Ï¡
(
diù_t
 *);

109 
dnode_t
 *
diù_Ãxt
(
diù_t
 *, dnode_t *);

110 
dnode_t
 *
diù_´ev
(
diù_t
 *, dnode_t *);

111 
diùcouÁ_t
 
diù_couÁ
(
diù_t
 *);

112 
diù_i£m±y
(
diù_t
 *);

113 
diù_isfuÎ
(
diù_t
 *);

114 
diù_cÚšs
(
diù_t
 *, 
dnode_t
 *);

115 
diù_®low_du³s
(
diù_t
 *);

116 
dnode_is_š_a_diù
(
dnode_t
 *);

117 
dnode_t
 *
dnode_ü—‹
(*);

118 
dnode_t
 *
dnode_š™
(dnode_t *, *);

119 
dnode_de¡roy
(
dnode_t
 *);

120 *
dnode_g‘
(
dnode_t
 *);

121 cÚ¡ *
dnode_g‘key
(
dnode_t
 *);

122 
dnode_put
(
dnode_t
 *, *);

123 
diù_´oûss
(
diù_t
 *, *, 
dnode_´oûss_t
);

124 
diù_lßd_begš
(
diù_lßd_t
 *, 
diù_t
 *);

125 
diù_lßd_Ãxt
(
diù_lßd_t
 *, 
dnode_t
 *, const *);

126 
diù_lßd_’d
(
diù_lßd_t
 *);

127 
diù_m”ge
(
diù_t
 *, dict_t *);

129 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

130 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


131 
	#diù_isfuÎ
(
D
è(
	`SFX_CHECK
(D)->
diù_nodecouÁ
 =ğ(D)->
diù_maxcouÁ
)

	)

133 
	#diù_isfuÎ
(
D
è((D)->
diù_nodecouÁ
 =ğ(D)->
diù_maxcouÁ
)

	)

135 
	#diù_couÁ
(
D
è((D)->
diù_nodecouÁ
)

	)

136 
	#diù_i£m±y
(
D
è((D)->
diù_nodecouÁ
 =ğ0)

	)

137 
	#dnode_g‘
(
N
è((N)->
diù_d©a
)

	)

138 
	#dnode_g‘key
(
N
è((N)->
diù_key
)

	)

139 
	#dnode_put
(
N
, 
X
è((N)->
diù_d©a
 = (X))

	)

142 #ifdeà
__ılu¥lus


	@src/adt/hash.c

21 
	~<¡dlib.h
>

22 
	~<¡ddef.h
>

23 
	~<as£¹.h
>

24 
	~<¡ršg.h
>

25 
	#HASH_IMPLEMENTATION


	)

26 
	~"hash.h
"

28 #ifdeà
KAZLIB_RCSID


29 cÚ¡ 
	grcsid
[] = "$Id: hash.c,v 1.36.2.11 2000/11/13 01:36:45 kaz Exp $";

32 
	#INIT_BITS
 6

	)

33 
	#INIT_SIZE
 (1UL << (
INIT_BITS
)è

	)

34 
	#INIT_MASK
 ((
INIT_SIZE
è- 1)

	)

36 
	#Ãxt
 
hash_Ãxt


	)

37 
	#key
 
hash_key


	)

38 
	#d©a
 
hash_d©a


	)

39 
	#hkey
 
hash_hkey


	)

41 
	#bË
 
hash_bË


	)

42 
	#nchašs
 
hash_nchašs


	)

43 
	#nodecouÁ
 
hash_nodecouÁ


	)

44 
	#maxcouÁ
 
hash_maxcouÁ


	)

45 
	#highm¬k
 
hash_highm¬k


	)

46 
	#lowm¬k
 
hash_lowm¬k


	)

47 
	#com·»
 
hash_com·»


	)

48 
	#funùiÚ
 
hash_funùiÚ


	)

49 
	#®loúode
 
hash_®loúode


	)

50 
	#ä“node
 
hash_ä“node


	)

51 
	#cÚ‹xt
 
hash_cÚ‹xt


	)

52 
	#mask
 
hash_mask


	)

53 
	#dyÇmic
 
hash_dyÇmic


	)

55 
	#bË
 
hash_bË


	)

56 
	#chaš
 
hash_chaš


	)

58 
hnode_t
 *
hnode_®loc
(*
cÚ‹xt
);

59 
hnode_ä“
(
hnode_t
 *
node
, *
cÚ‹xt
);

60 
hash_v®_t
 
hash_fun_deçuÉ
(cÚ¡ *
key
);

61 
hash_comp_deçuÉ
(cÚ¡ *
key1
, cÚ¡ *
key2
);

80 
Fixed
 
our
 
	gu§ge
 -
josh


81 
	$compu‹_b™s
()

83 
hash_v®_t
 
v®
 = 
HASH_VAL_T_MAX
;

84 
b™s
 = 0;

86 
v®
) {

87 
b™s
++;

88 
v®
 >>= 1;

91 
hash_v®_t_b™
 = 
b™s
;

92 
	}
}

99 
	$is_pow”_of_two
(
hash_v®_t
 
¬g
)

101 ià(
¬g
 == 0)

103 (
¬g
 & 1) == 0)

104 
¬g
 >>= 1;

105  (
¬g
 == 1);

106 
	}
}

112 
hash_v®_t
 
	$compu‹_mask
(
hashcouÁ_t
 
size
)

114 
	`as£¹
 (
	`is_pow”_of_two
(
size
));

115 
	`as£¹
 (
size
 >= 2);

117  
size
 - 1;

118 
	}
}

124 
	$ş—r_bË
(
hash_t
 *
hash
)

126 
hash_v®_t
 
i
;

128 
i
 = 0; i < 
hash
->
nchašs
; i++)

129 
hash
->
bË
[
i
] = 
NULL
;

130 
	}
}

160 
	$grow_bË
(
hash_t
 *
hash
)

162 
hnode_t
 **
ÃwbË
;

164 
	`as£¹
 (2 * 
hash
->
nchašs
 > hash->nchains);

166 
ÃwbË
 = 
	`»®loc
(
hash
->
bË
,

167  *
ÃwbË
 * 
hash
->
nchašs
 * 2);

169 ià(
ÃwbË
) {

170 
hash_v®_t
 
mask
 = (
hash
->mask << 1) | 1;

171 
hash_v®_t
 
expo£d_b™
 = 
mask
 ^ 
hash
->mask;

172 
hash_v®_t
 
chaš
;

174 
	`as£¹
 (
mask
 !ğ
hash
->mask);

176 
chaš
 = 0; chaš < 
hash
->
nchašs
; chain++) {

177 
hnode_t
 *
low_chaš
 = 0, *
high_chaš
 = 0, *
h±r
, *
Ãxt
;

179 
h±r
 = 
ÃwbË
[
chaš
]; h±¸!ğ0; h±¸ğ
Ãxt
) {

180 
Ãxt
 = 
h±r
->next;

182 ià(
h±r
->
hkey
 & 
expo£d_b™
) {

183 
h±r
->
Ãxt
 = 
high_chaš
;

184 
high_chaš
 = 
h±r
;

186 
h±r
->
Ãxt
 = 
low_chaš
;

187 
low_chaš
 = 
h±r
;

191 
ÃwbË
[
chaš
] = 
low_chaš
;

192 
ÃwbË
[
chaš
 + 
hash
->
nchašs
] = 
high_chaš
;

195 
hash
->
bË
 = 
ÃwbË
;

196 
hash
->
mask
 = mask;

197 
hash
->
nchašs
 *= 2;

198 
hash
->
lowm¬k
 *= 2;

199 
hash
->
highm¬k
 *= 2;

201 
	`as£¹
 (
	`hash_v”ify
(
hash
));

202 
	}
}

234 
	$shršk_bË
(
hash_t
 *
hash
)

236 
hash_v®_t
 
chaš
, 
nchašs
;

237 
hnode_t
 **
ÃwbË
, *
low_
, *
low_chaš
, *
high_chaš
;

239 
	`as£¹
 (
hash
->
nchašs
 >= 2);

240 
nchašs
 = 
hash
->nchains / 2;

242 
chaš
 = 0; chaš < 
nchašs
; chain++) {

243 
low_chaš
 = 
hash
->
bË
[
chaš
];

244 
high_chaš
 = 
hash
->
bË
[
chaš
 + 
nchašs
];

245 
low_
 = 
low_chaš
;†ow_ &&†ow_->
Ãxt
;†ow_tail =†ow_tail->next)

247 ià(
low_chaš
 != 0)

248 
low_
->
Ãxt
 = 
high_chaš
;

249 ià(
high_chaš
 != 0)

250 
hash
->
bË
[
chaš
] = 
high_chaš
;

252 
	`as£¹
 (
hash
->
bË
[
chaš
] =ğ
NULL
);

254 
ÃwbË
 = 
	`»®loc
(
hash
->
bË
,

255  *
ÃwbË
 * 
nchašs
);

256 ià(
ÃwbË
)

257 
hash
->
bË
 = 
ÃwbË
;

258 
hash
->
mask
 >>= 1;

259 
hash
->
nchašs
 =‚chains;

260 
hash
->
lowm¬k
 /= 2;

261 
hash
->
highm¬k
 /= 2;

262 
	`as£¹
 (
	`hash_v”ify
(
hash
));

263 
	}
}

295 
hash_t
 *
	$hash_ü—‹
(
hashcouÁ_t
 
maxcouÁ
, 
hash_comp_t
 
compfun
,

296 
hash_fun_t
 
hashfun
)

298 
hash_t
 *
hash
;

304 
hash
 = 
	`m®loc
( *hash);

306 ià(
hash
) {

307 
hash
->
bË
 = 
	`m®loc
( *hash->bË * 
INIT_SIZE
);

308 ià(
hash
->
bË
) {

309 
hash
->
nchašs
 = 
INIT_SIZE
;

310 
hash
->
highm¬k
 = 
INIT_SIZE
 * 2;

311 
hash
->
lowm¬k
 = 
INIT_SIZE
 / 2;

312 
hash
->
nodecouÁ
 = 0;

313 
hash
->
maxcouÁ
 = maxcount;

314 
hash
->
com·»
 = 
compfun
 ? compfuÀ: 
hash_comp_deçuÉ
;

315 
hash
->
funùiÚ
 = 
hashfun
 ? hashfuÀ: 
hash_fun_deçuÉ
;

316 
hash
->
®loúode
 = 
hnode_®loc
;

317 
hash
->
ä“node
 = 
hnode_ä“
;

318 
hash
->
cÚ‹xt
 = 
NULL
;

319 
hash
->
mask
 = 
INIT_MASK
;

320 
hash
->
dyÇmic
 = 1;

321 
	`ş—r_bË
(
hash
);

322 
	`as£¹
 (
	`hash_v”ify
(
hash
));

323  
hash
;

325 
	`ä“
(
hash
);

328  
NULL
;

329 
	}
}

335 
	$hash_£t_®loÿtÜ
(
hash_t
 *
hash
, 
hnode_®loc_t
 
®
,

336 
hnode_ä“_t
 
ä
, *
cÚ‹xt
)

338 
	`as£¹
 (
	`hash_couÁ
(
hash
) == 0);

339 
	`as£¹
 ((
®
 =ğ0 && 
ä
 == 0) || (al != 0 && fr != 0));

341 
hash
->
®loúode
 = 
®
 ?‡È: 
hnode_®loc
;

342 
hash
->
ä“node
 = 
ä
 ? f¸: 
hnode_ä“
;

343 
hash
->
cÚ‹xt
 = context;

344 
	}
}

351 
	$hash_ä“_nodes
(
hash_t
 *
hash
)

353 
hsÿn_t
 
hs
;

354 
hnode_t
 *
node
;

355 
	`hash_sÿn_begš
(&
hs
, 
hash
);

356 (
node
 = 
	`hash_sÿn_Ãxt
(&
hs
))) {

357 
	`hash_sÿn_d–‘e
(
hash
, 
node
);

358 
hash
->
	`ä“node
(
node
, hash->
cÚ‹xt
);

360 
hash
->
nodecouÁ
 = 0;

361 
	`ş—r_bË
(
hash
);

362 
	}
}

369 
	$hash_ä“
(
hash_t
 *
hash
)

371 #ifdeà
KAZLIB_OBSOLESCENT_DEBUG


372 
	`as£¹
 ("callo obsolescent function hash_free()" && 0);

374 
	`hash_ä“_nodes
(
hash
);

375 
	`hash_de¡roy
(
hash
);

376 
	}
}

382 
	$hash_de¡roy
(
hash_t
 *
hash
)

384 
	`as£¹
 (
hash_v®_t_b™
 != 0);

385 
	`as£¹
 (
	`hash_i£m±y
(
hash
));

386 
	`ä“
(
hash
->
bË
);

387 
	`ä“
(
hash
);

388 
	}
}

403 
hash_t
 *
	$hash_š™
(
hash_t
 *
hash
, 
hashcouÁ_t
 
maxcouÁ
,

404 
hash_comp_t
 
compfun
, 
hash_fun_t
 
hashfun
, 
hnode_t
 **
bË
,

405 
hashcouÁ_t
 
nchašs
)

411 
	`as£¹
 (
	`is_pow”_of_two
(
nchašs
));

413 
hash
->
bË
 =able;

414 
hash
->
nchašs
 =‚chains;

415 
hash
->
nodecouÁ
 = 0;

416 
hash
->
maxcouÁ
 = maxcount;

417 
hash
->
com·»
 = 
compfun
 ? compfuÀ: 
hash_comp_deçuÉ
;

418 
hash
->
funùiÚ
 = 
hashfun
 ? hashfuÀ: 
hash_fun_deçuÉ
;

419 
hash
->
dyÇmic
 = 0;

420 
hash
->
mask
 = 
	`compu‹_mask
(
nchašs
);

421 
	`ş—r_bË
(
hash
);

423 
	`as£¹
 (
	`hash_v”ify
(
hash
));

425  
hash
;

426 
	}
}

439 
	$hash_sÿn_begš
(
hsÿn_t
 *
sÿn
, 
hash_t
 *
hash
)

441 
hash_v®_t
 
nchašs
 = 
hash
->nchains;

442 
hash_v®_t
 
chaš
;

444 
sÿn
->
bË
 = 
hash
;

448 
chaš
 = 0; chaš < 
nchašs
 && 
hash
->
bË
[chain] == 0; chain++)

451 ià(
chaš
 < 
nchašs
) {

452 
sÿn
->
chaš
 = chain;

453 
sÿn
->
Ãxt
 = 
hash
->
bË
[
chaš
];

455 
sÿn
->
Ãxt
 = 
NULL
;

457 
	}
}

485 
hnode_t
 *
	$hash_sÿn_Ãxt
(
hsÿn_t
 *
sÿn
)

487 
hnode_t
 *
Ãxt
 = 
sÿn
->next;

488 
hash_t
 *
hash
 = 
sÿn
->
bË
;

489 
hash_v®_t
 
chaš
 = 
sÿn
->chain + 1;

490 
hash_v®_t
 
nchašs
 = 
hash
->nchains;

492 
	`as£¹
 (
hash_v®_t_b™
 != 0);

494 ià(
Ãxt
) {

495 ià(
Ãxt
->next) {

496 
sÿn
->
Ãxt
 =‚ext->next;

498 
chaš
 < 
nchašs
 && 
hash
->
bË
[chain] == 0)

499 
chaš
++;

500 ià(
chaš
 < 
nchašs
) {

501 
sÿn
->
chaš
 = chain;

502 
sÿn
->
Ãxt
 = 
hash
->
bË
[
chaš
];

504 
sÿn
->
Ãxt
 = 
NULL
;

508  
Ãxt
;

509 
	}
}

524 
	$hash_š£¹
(
hash_t
 *
hash
, 
hnode_t
 *
node
, cÚ¡ *
key
)

526 
hash_v®_t
 
hkey
, 
chaš
;

528 
	`as£¹
 (
hash_v®_t_b™
 != 0);

529 
	`as£¹
 (
node
->
Ãxt
 =ğ
NULL
);

530 
	`as£¹
 (
hash
->
nodecouÁ
 < hash->
maxcouÁ
);

531 
	`as£¹
 (
	`hash_lookup
(
hash
, 
key
è=ğ
NULL
);

533 ià(
hash
->
dyÇmic
 && hash->
nodecouÁ
 >ğhash->
highm¬k
)

534 
	`grow_bË
(
hash
);

536 
hkey
 = 
hash
->
	`funùiÚ
(
key
);

537 
chaš
 = 
hkey
 & 
hash
->
mask
;

539 
node
->
key
 = key;

540 
node
->
hkey
 = hkey;

541 
node
->
Ãxt
 = 
hash
->
bË
[
chaš
];

542 
hash
->
bË
[
chaš
] = 
node
;

543 
hash
->
nodecouÁ
++;

545 
	`as£¹
 (
	`hash_v”ify
(
hash
));

546 
	}
}

562 
hnode_t
 *
	$hash_lookup
(
hash_t
 *
hash
, cÚ¡ *
key
)

564 
hash_v®_t
 
hkey
, 
chaš
;

565 
hnode_t
 *
ÅŒ
;

567 
hkey
 = 
hash
->
	`funùiÚ
(
key
);

568 
chaš
 = 
hkey
 & 
hash
->
mask
;

570 
ÅŒ
 = 
hash
->
bË
[
chaš
];‚±r;‚±¸ğÅŒ->
Ãxt
) {

571 ià(
ÅŒ
->
hkey
 =ğhkey && 
hash
->
	`com·»
Ò±r->
key
, key) == 0)

572  
ÅŒ
;

575  
NULL
;

576 
	}
}

596 
hnode_t
 *
	$hash_d–‘e
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

598 
hash_v®_t
 
chaš
;

599 
hnode_t
 *
h±r
;

601 
	`as£¹
 (
	`hash_lookup
(
hash
, 
node
->
key
) ==‚ode);

602 
	`as£¹
 (
hash_v®_t_b™
 != 0);

604 ià(
hash
->
dyÇmic
 && hash->
nodecouÁ
 <ğhash->
lowm¬k


605 && 
hash
->
nodecouÁ
 > 
INIT_SIZE
)

606 
	`shršk_bË
(
hash
);

608 
chaš
 = 
node
->
hkey
 & 
hash
->
mask
;

609 
h±r
 = 
hash
->
bË
[
chaš
];

611 ià(
h±r
 =ğ
node
) {

612 
hash
->
bË
[
chaš
] = 
node
->
Ãxt
;

614 
h±r
->
Ãxt
 !ğ
node
) {

615 
	`as£¹
 (
h±r
 != 0);

616 
h±r
 = h±r->
Ãxt
;

618 
	`as£¹
 (
h±r
->
Ãxt
 =ğ
node
);

619 
h±r
->
Ãxt
 = 
node
->next;

622 
hash
->
nodecouÁ
--;

623 
	`as£¹
 (
	`hash_v”ify
(
hash
));

625 
node
->
Ãxt
 = 
NULL
;

626  
node
;

627 
	}
}

629 
	$hash_®loc_š£¹
(
hash_t
 *
hash
, cÚ¡ *
key
, *
d©a
)

631 
hnode_t
 *
node
 = 
hash
->
	`®loúode
(hash->
cÚ‹xt
);

633 ià(
node
) {

634 
	`hnode_š™
(
node
, 
d©a
);

635 
	`hash_š£¹
(
hash
, 
node
, 
key
);

639 
	}
}

641 
	$hash_d–‘e_ä“
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

643 
	`hash_d–‘e
(
hash
, 
node
);

644 
hash
->
	`ä“node
(
node
, hash->
cÚ‹xt
);

645 
	}
}

652 
hnode_t
 *
	$hash_sÿn_d–‘e
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

654 
hash_v®_t
 
chaš
;

655 
hnode_t
 *
h±r
;

657 
	`as£¹
 (
	`hash_lookup
(
hash
, 
node
->
key
) ==‚ode);

658 
	`as£¹
 (
hash_v®_t_b™
 != 0);

660 
chaš
 = 
node
->
hkey
 & 
hash
->
mask
;

661 
h±r
 = 
hash
->
bË
[
chaš
];

663 ià(
h±r
 =ğ
node
) {

664 
hash
->
bË
[
chaš
] = 
node
->
Ãxt
;

666 
h±r
->
Ãxt
 !ğ
node
)

667 
h±r
 = h±r->
Ãxt
;

668 
h±r
->
Ãxt
 = 
node
->next;

671 
hash
->
nodecouÁ
--;

672 
	`as£¹
 (
	`hash_v”ify
(
hash
));

673 
node
->
Ãxt
 = 
NULL
;

675  
node
;

676 
	}
}

682 
	$hash_sÿn_d–ä“
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

684 
	`hash_sÿn_d–‘e
(
hash
, 
node
);

685 
hash
->
	`ä“node
(
node
, hash->
cÚ‹xt
);

686 
	}
}

697 
	$hash_v”ify
(
hash_t
 *
hash
)

699 
hashcouÁ_t
 
couÁ
 = 0;

700 
hash_v®_t
 
chaš
;

701 
hnode_t
 *
h±r
;

703 ià(
hash
->
dyÇmic
) {

704 ià(
hash
->
lowm¬k
 >ğhash->
highm¬k
)

706 ià(!
	`is_pow”_of_two
(
hash
->
highm¬k
))

708 ià(!
	`is_pow”_of_two
(
hash
->
lowm¬k
))

712 
chaš
 = 0; chaš < 
hash
->
nchašs
; chain++) {

713 
h±r
 = 
hash
->
bË
[
chaš
]; h±¸!ğ0; h±¸ğh±r->
Ãxt
) {

714 ià((
h±r
->
hkey
 & 
hash
->
mask
è!ğ
chaš
)

716 
couÁ
++;

720 ià(
couÁ
 !ğ
hash
->
nodecouÁ
)

724 
	}
}

731 #undeà
hash_isfuÎ


732 
	$hash_isfuÎ
(
hash_t
 *
hash
)

734  
hash
->
nodecouÁ
 =ğhash->
maxcouÁ
;

735 
	}
}

742 #undeà
hash_i£m±y


743 
	$hash_i£m±y
(
hash_t
 *
hash
)

745  
hash
->
nodecouÁ
 == 0;

746 
	}
}

748 
hnode_t
 *
	$hnode_®loc
(*
cÚ‹xt
)

750  
	`m®loc
( *
	`hnode_®loc
(
NULL
));

751 
	}
}

753 
	$hnode_ä“
(
hnode_t
 *
node
, *
cÚ‹xt
)

755 
	`ä“
(
node
);

756 
	}
}

763 
hnode_t
 *
	$hnode_ü—‹
(*
d©a
)

765 
hnode_t
 *
node
 = 
	`m®loc
( *node);

766 ià(
node
) {

767 
node
->
d©a
 = data;

768 
node
->
Ãxt
 = 
NULL
;

770  
node
;

771 
	}
}

777 
hnode_t
 *
	$hnode_š™
(
hnode_t
 *
hnode
, *
d©a
)

779 
hnode
->
d©a
 = data;

780 
hnode
->
Ãxt
 = 
NULL
;

781  
hnode
;

782 
	}
}

788 
	$hnode_de¡roy
(
hnode_t
 *
hnode
)

790 
	`ä“
(
hnode
);

791 
	}
}

793 #undeà
hnode_put


794 
	$hnode_put
(
hnode_t
 *
node
, *
d©a
)

796 
node
->
d©a
 = data;

797 
	}
}

799 #undeà
hnode_g‘


800 *
	$hnode_g‘
(
hnode_t
 *
node
)

802  
node
->
d©a
;

803 
	}
}

805 #undeà
hnode_g‘key


806 cÚ¡ *
	$hnode_g‘key
(
hnode_t
 *
node
)

808  
node
->
key
;

809 
	}
}

811 #undeà
hash_couÁ


812 
hashcouÁ_t
 
	$hash_couÁ
(
hash_t
 *
hash
)

814  
hash
->
nodecouÁ
;

815 
	}
}

817 #undeà
hash_size


818 
hashcouÁ_t
 
	$hash_size
(
hash_t
 *
hash
)

820  
hash
->
nchašs
;

821 
	}
}

823 
hash_v®_t
 
	$hash_fun_deçuÉ
(cÚ¡ *
key
)

825 
¿ndbox
[] = {

832 cÚ¡ *
¡r
 = 
key
;

833 
hash_v®_t
 
acc
 = 0;

835 *
¡r
) {

836 
acc
 ^ğ
¿ndbox
[(*
¡r
 +‡cc) & 0xf];

837 
acc
 = (acc << 1) | (acc >> 31);

838 
acc
 &= 0xffffffffU;

839 
acc
 ^ğ
¿ndbox
[((*
¡r
++ >> 4) +‡cc) & 0xf];

840 
acc
 = (acc << 2) | (acc >> 30);

841 
acc
 &= 0xffffffffU;

843  
acc
;

844 
	}
}

846 
	$hash_comp_deçuÉ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

848  
	`¡rcmp
(
key1
, 
key2
);

849 
	}
}

	@src/adt/hash.h

1 #undeà
KAZLIB_OPAQUE_DEBUG


23 #iâdeà
HASH_H


24 
	#HASH_H


	)

26 
	~<lim™s.h
>

27 
	~<¡dšt.h
>

29 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


30 
	~"sfx.h
"

37 #ifdeà
__ılu¥lus


41 
	thashcouÁ_t
;

42 
	#HASHCOUNT_T_MAX
 
ULONG_MAX


	)

44 
ušt32_t
 
	thash_v®_t
;

45 
	#HASH_VAL_T_MAX
 
UINT32_MAX


	)

47 cÚ¡ 
hash_v®_t_b™
 = 32;

49 #iâdeà
HASH_VAL_T_BIT


50 
	#HASH_VAL_T_BIT
 ((è
hash_v®_t_b™
)

	)

77 
	shnode_t
 {

78 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

79 
hnode_t
 *
hash_Ãxt
;

80 cÚ¡ *
hash_key
;

81 *
hash_d©a
;

82 
hash_v®_t
 
hash_hkey
;

84 
hash_dummy
;

86 } 
	thnode_t
;

95 (*
hash_comp_t
)(const *, const *);

109 
hash_v®_t
 (*
	thash_fun_t
)(const *);

115 
hnode_t
 *(*
	thnode_®loc_t
)(*);

116 (*
hnode_ä“_t
)(
	thnode_t
 *, *);

153 
	shash_t
 {

154 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

155 
hnode_t
 **
hash_bË
;

156 
hashcouÁ_t
 
hash_nchašs
;

157 
hashcouÁ_t
 
hash_nodecouÁ
;

158 
hashcouÁ_t
 
hash_maxcouÁ
;

159 
hashcouÁ_t
 
hash_highm¬k
;

160 
hashcouÁ_t
 
hash_lowm¬k
;

161 
hash_comp_t
 
hash_com·»
;

162 
hash_fun_t
 
hash_funùiÚ
;

163 
hnode_®loc_t
 
hash_®loúode
;

164 
hnode_ä“_t
 
hash_ä“node
;

165 *
hash_cÚ‹xt
;

166 
hash_v®_t
 
hash_mask
;

167 
hash_dyÇmic
;

169 
hash_dummy
;

171 } 
	thash_t
;

183 
	shsÿn_t
 {

184 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

185 
hash_t
 *
hash_bË
;

186 
hash_v®_t
 
hash_chaš
;

187 
hnode_t
 *
hash_Ãxt
;

189 
hash_dummy
;

191 } 
	thsÿn_t
;

193 
hash_t
 *
hash_ü—‹
(
hashcouÁ_t
, 
hash_comp_t
, 
hash_fun_t
);

194 
hash_£t_®loÿtÜ
(
hash_t
 *, 
hnode_®loc_t
, 
hnode_ä“_t
, *);

195 
hash_de¡roy
(
hash_t
 *);

196 
hash_ä“_nodes
(
hash_t
 *);

197 
hash_ä“
(
hash_t
 *);

198 
hash_t
 *
hash_š™
(hash_ˆ*, 
hashcouÁ_t
, 
hash_comp_t
,

199 
hash_fun_t
, 
hnode_t
 **, 
hashcouÁ_t
);

200 
hash_š£¹
(
hash_t
 *, 
hnode_t
 *, const *);

201 
hnode_t
 *
hash_lookup
(
hash_t
 *, const *);

202 
hnode_t
 *
hash_d–‘e
(
hash_t
 *, hnode_t *);

203 
hash_®loc_š£¹
(
hash_t
 *, const *, *);

204 
hash_d–‘e_ä“
(
hash_t
 *, 
hnode_t
 *);

206 
hnode_put
(
hnode_t
 *, *);

207 *
hnode_g‘
(
hnode_t
 *);

208 cÚ¡ *
hnode_g‘key
(
hnode_t
 *);

209 
hashcouÁ_t
 
hash_couÁ
(
hash_t
 *);

210 
hashcouÁ_t
 
hash_size
(
hash_t
 *);

212 
hash_isfuÎ
(
hash_t
 *);

213 
hash_i£m±y
(
hash_t
 *);

215 
hash_sÿn_begš
(
hsÿn_t
 *, 
hash_t
 *);

216 
hnode_t
 *
hash_sÿn_Ãxt
(
hsÿn_t
 *);

217 
hnode_t
 *
hash_sÿn_d–‘e
(
hash_t
 *, hnode_t *);

218 
hash_sÿn_d–ä“
(
hash_t
 *, 
hnode_t
 *);

220 
hash_v”ify
(
hash_t
 *);

222 
hnode_t
 *
hnode_ü—‹
(*);

223 
hnode_t
 *
hnode_š™
(hnode_t *, *);

224 
hnode_de¡roy
(
hnode_t
 *);

226 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

227 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


228 
	#hash_isfuÎ
(
H
è(
	`SFX_CHECK
(H)->
hash_nodecouÁ
 =ğ(H)->
hash_maxcouÁ
)

	)

230 
	#hash_isfuÎ
(
H
è((H)->
hash_nodecouÁ
 =ğ(H)->
hash_maxcouÁ
)

	)

232 
	#hash_i£m±y
(
H
è((H)->
hash_nodecouÁ
 =ğ0)

	)

233 
	#hash_couÁ
(
H
è((H)->
hash_nodecouÁ
)

	)

234 
	#hash_size
(
H
è((H)->
hash_nchašs
)

	)

235 
	#hnode_g‘
(
N
è((N)->
hash_d©a
)

	)

236 
	#hnode_g‘key
(
N
è((N)->
hash_key
)

	)

237 
	#hnode_put
(
N
, 
V
è((N)->
hash_d©a
 = (V))

	)

240 #ifdeà
__ılu¥lus


	@src/adt/list.c

22 
	~<¡dlib.h
>

23 
	~<¡ddef.h
>

24 
	~<as£¹.h
>

25 
	#LIST_IMPLEMENTATION


	)

26 
	~"li¡.h
"

28 
	#Ãxt
 
li¡_Ãxt


	)

29 
	#´ev
 
li¡_´ev


	)

30 
	#d©a
 
li¡_d©a


	)

32 
	#poŞ
 
li¡_poŞ


	)

33 
	#äe
 
li¡_ä“


	)

34 
	#size
 
li¡_size


	)

36 
	#nnode
 
li¡_nnode


	)

37 
	#nodecouÁ
 
li¡_nodecouÁ


	)

38 
	#maxcouÁ
 
li¡_maxcouÁ


	)

40 
	#li¡_n
(
L
è(&(L)->
nnode
)

	)

41 
	#li¡_fœ¡_´iv
(
L
è((L)->
nnode
.
Ãxt
)

	)

42 
	#li¡_Ï¡_´iv
(
L
è((L)->
nnode
.
´ev
)

	)

43 
	#Êode_Ãxt
(
N
è((N)->
Ãxt
)

	)

44 
	#Êode_´ev
(
N
è((N)->
´ev
)

	)

46 #ifdeà
KAZLIB_RCSID


47 cÚ¡ 
	grcsid
[] = "$Id:†ist.c,v 1.19.2.1 2000/04/17 01:07:21 kaz Exp $";

57 
li¡_t
 *
	$li¡_š™
(
li¡_t
 *
li¡
, 
li¡couÁ_t
 
maxcouÁ
)

59 
	`as£¹
 (
maxcouÁ
 != 0);

60 
li¡
->
nnode
.
Ãxt
 = &list->nilnode;

61 
li¡
->
nnode
.
´ev
 = &list->nilnode;

62 
li¡
->
nodecouÁ
 = 0;

63 
li¡
->
maxcouÁ
 = maxcount;

64  
li¡
;

65 
	}
}

73 
li¡_t
 *
	$li¡_ü—‹
(
li¡couÁ_t
 
maxcouÁ
)

75 
li¡_t
 *
Ãw
 = 
	`m®loc
( *new);

76 ià(
Ãw
) {

77 
	`as£¹
 (
maxcouÁ
 != 0);

78 
Ãw
->
nnode
.
Ãxt
 = &new->nilnode;

79 
Ãw
->
nnode
.
´ev
 = &new->nilnode;

80 
Ãw
->
nodecouÁ
 = 0;

81 
Ãw
->
maxcouÁ
 = maxcount;

83  
Ãw
;

84 
	}
}

91 
	$li¡_de¡roy
(
li¡_t
 *
li¡
)

93 
	`as£¹
 (
	`li¡_i£m±y
(
li¡
));

94 
	`ä“
(
li¡
);

95 
	}
}

103 
	$li¡_de¡roy_nodes
(
li¡_t
 *
li¡
)

105 
Êode_t
 *
Êode
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
n
 = 
	`li¡_n
Öi¡), *
tmp
;

107 
Êode
 !ğ
n
) {

108 
tmp
 = 
Êode
->
Ãxt
;

109 
Êode
->
Ãxt
 = 
NULL
;

110 
Êode
->
´ev
 = 
NULL
;

111 
	`Êode_de¡roy
(
Êode
);

112 
Êode
 = 
tmp
;

115 
	`li¡_š™
(
li¡
,†i¡->
maxcouÁ
);

116 
	}
}

123 
	$li¡_»tuº_nodes
(
li¡_t
 *
li¡
, 
Êod•oŞ_t
 *
poŞ
)

125 
Êode_t
 *
Êode
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
tmp
, *
n
 = 
	`li¡_n
(list);

127 
Êode
 !ğ
n
) {

128 
tmp
 = 
Êode
->
Ãxt
;

129 
Êode
->
Ãxt
 = 
NULL
;

130 
Êode
->
´ev
 = 
NULL
;

131 
	`Êode_»tuº
(
poŞ
, 
Êode
);

132 
Êode
 = 
tmp
;

135 
	`li¡_š™
(
li¡
,†i¡->
maxcouÁ
);

136 
	}
}

142 
	$li¡_šs_aá”
(
li¡_t
 *
li¡
, 
Êode_t
 *
Ãw
,†node_ˆ*
this
)

144 
Êode_t
 *
th©
 = 
this
->
Ãxt
;

146 
	`as£¹
 (
Ãw
 !ğ
NULL
);

147 
	`as£¹
 (!
	`li¡_cÚšs
(
li¡
, 
Ãw
));

148 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
Ãw
));

149 
	`as£¹
 (
this
 =ğ
	`li¡_n
(
li¡
è|| 
	`li¡_cÚšs
(list,his));

150 
	`as£¹
 (
li¡
->
nodecouÁ
 + 1 >†ist->nodecount);

152 
Ãw
->
´ev
 = 
this
;

153 
Ãw
->
Ãxt
 = 
th©
;

154 
th©
->
´ev
 = 
Ãw
;

155 
this
->
Ãxt
 = 
Ãw
;

156 
li¡
->
nodecouÁ
++;

158 
	`as£¹
 (
li¡
->
nodecouÁ
 <ğli¡->
maxcouÁ
);

159 
	}
}

165 
	$li¡_šs_befÜe
(
li¡_t
 *
li¡
, 
Êode_t
 *
Ãw
,†node_ˆ*
this
)

167 
Êode_t
 *
th©
 = 
this
->
´ev
;

169 
	`as£¹
 (
Ãw
 !ğ
NULL
);

170 
	`as£¹
 (!
	`li¡_cÚšs
(
li¡
, 
Ãw
));

171 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
Ãw
));

172 
	`as£¹
 (
this
 =ğ
	`li¡_n
(
li¡
è|| 
	`li¡_cÚšs
(list,his));

173 
	`as£¹
 (
li¡
->
nodecouÁ
 + 1 >†ist->nodecount);

175 
Ãw
->
Ãxt
 = 
this
;

176 
Ãw
->
´ev
 = 
th©
;

177 
th©
->
Ãxt
 = 
Ãw
;

178 
this
->
´ev
 = 
Ãw
;

179 
li¡
->
nodecouÁ
++;

181 
	`as£¹
 (
li¡
->
nodecouÁ
 <ğli¡->
maxcouÁ
);

182 
	}
}

188 
Êode_t
 *
	$li¡_d–‘e
(
li¡_t
 *
li¡
, 
Êode_t
 *
d–
)

190 
Êode_t
 *
Ãxt
 = 
d–
->next;

191 
Êode_t
 *
´ev
 = 
d–
->prev;

193 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
d–
));

195 
´ev
->
Ãxt
 =‚ext;

196 
Ãxt
->
´ev
 =…rev;

197 
li¡
->
nodecouÁ
--;

199 
d–
->
Ãxt
 = d–->
´ev
 = 
NULL
;

201  
d–
;

202 
	}
}

210 
li¡_´oûss
(
li¡_t
 *
li¡
, *
cÚ‹xt
,

211 (* 
funùiÚ
)(
li¡_t
 *
li¡
, 
Êode_t
 *
Êode
, *
cÚ‹xt
))

213 
Êode_t
 *
node
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
Ãxt
, *
n
 = 
	`li¡_n
(list);

215 
node
 !ğ
n
) {

218 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
node
));

219 
Ãxt
 = 
node
->next;

220 
	`funùiÚ
(
li¡
, 
node
, 
cÚ‹xt
);

221 
node
 = 
Ãxt
;

223 
	}
}

229 
Êode_t
 *
	$Êode_ü—‹
(*
d©a
)

231 
Êode_t
 *
Ãw
 = 
	`m®loc
( *new);

232 ià(
Ãw
) {

233 
Ãw
->
d©a
 = data;

234 
Ãw
->
Ãxt
 = 
NULL
;

235 
Ãw
->
´ev
 = 
NULL
;

237  
Ãw
;

238 
	}
}

244 
Êode_t
 *
	$Êode_š™
(
Êode_t
 *
Êode
, *
d©a
)

246 
Êode
->
d©a
 = data;

247 
Êode
->
Ãxt
 = 
NULL
;

248 
Êode
->
´ev
 = 
NULL
;

249  
Êode
;

250 
	}
}

256 
	$Êode_de¡roy
(
Êode_t
 *
Êode
)

258 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
Êode
));

259 
	`ä“
(
Êode
);

260 
	}
}

268 
Êod•oŞ_t
 *
	$Êode_poŞ_š™
(
Êod•oŞ_t
 *
poŞ
, 
Êode_t
 *
nodes
, 
li¡couÁ_t
 
n
)

270 
li¡couÁ_t
 
i
;

272 
	`as£¹
 (
n
 != 0);

274 
poŞ
->poŞ = 
nodes
;

275 
poŞ
->
äe
 = 
nodes
;

276 
poŞ
->
size
 = 
n
;

277 
i
 = 0; i < 
n
 - 1; i++) {

278 
nodes
[
i
].
Ãxt
 =‚odes + i + 1;

280 
nodes
[
i
].
Ãxt
 = 
NULL
;

281 
nodes
[
i
].
´ev
 =‚odes;

282  
poŞ
;

283 
	}
}

289 
Êod•oŞ_t
 *
	$Êode_poŞ_ü—‹
(
li¡couÁ_t
 
n
)

291 
Êod•oŞ_t
 *
poŞ
;

292 
Êode_t
 *
nodes
;

294 
	`as£¹
 (
n
 != 0);

296 
poŞ
 = 
	`m®loc
( *pool);

297 ià(!
poŞ
)

298  
NULL
;

299 
nodes
 = 
	`m®loc
(
n
 *  *nodes);

300 ià(!
nodes
) {

301 
	`ä“
(
poŞ
);

302  
NULL
;

304 
	`Êode_poŞ_š™
(
poŞ
, 
nodes
, 
n
);

305  
poŞ
;

306 
	}
}

312 
	$Êode_poŞ_isäom
(
Êod•oŞ_t
 *
poŞ
, 
Êode_t
 *
node
)

314 
li¡couÁ_t
 
i
;

320 
i
 = 0; i < 
poŞ
->
size
; i++) {

321 ià(
poŞ
->poŞ + 
i
 =ğ
node
)

325 
	}
}

331 
	$Êode_poŞ_de¡roy
(
Êod•oŞ_t
 *
p
)

333 
	`ä“
(
p
->
poŞ
);

334 
	`ä“
(
p
);

335 
	}
}

342 
Êode_t
 *
	$Êode_bÜrow
(
Êod•oŞ_t
 *
poŞ
, *
d©a
)

344 
Êode_t
 *
Ãw
 = 
poŞ
->
äe
;

345 ià(
Ãw
) {

346 
poŞ
->
äe
 = 
Ãw
->
Ãxt
;

347 
Ãw
->
d©a
 = data;

348 
Ãw
->
Ãxt
 = 
NULL
;

349 
Ãw
->
´ev
 = 
NULL
;

351  
Ãw
;

352 
	}
}

359 
	$Êode_»tuº
(
Êod•oŞ_t
 *
poŞ
, 
Êode_t
 *
node
)

361 
	`as£¹
 (
	`Êode_poŞ_isäom
(
poŞ
, 
node
));

362 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
node
));

364 
node
->
Ãxt
 = 
poŞ
->
äe
;

365 
node
->
´ev
 =‚ode;

366 
poŞ
->
äe
 = 
node
;

367 
	}
}

374 
	$li¡_cÚšs
(
li¡_t
 *
li¡
, 
Êode_t
 *
node
)

376 
Êode_t
 *
n
, *
n
 = 
	`li¡_n
(
li¡
);

378 
n
 = 
	`li¡_fœ¡_´iv
(
li¡
);‚ !ğ
n
;‚ = 
	`Êode_Ãxt
(n)) {

379 ià(
node
 =ğ
n
)

384 
	}
}

392 
	$li¡_exŒaù
(
li¡_t
 *
de¡
,†i¡_ˆ*
sourû
, 
Êode_t
 *
fœ¡
,†node_ˆ*
Ï¡
)

394 
li¡couÁ_t
 
moved
 = 1;

396 
	`as£¹
 (
fœ¡
 =ğ
NULL
 || 
	`li¡_cÚšs
(
sourû
, first));

397 
	`as£¹
 (
Ï¡
 =ğ
NULL
 || 
	`li¡_cÚšs
(
sourû
,†ast));

399 ià(
fœ¡
 =ğ
NULL
 || 
Ï¡
 == NULL)

404 
fœ¡
->
´ev
->
Ãxt
 = 
Ï¡
->next;

405 
Ï¡
->
Ãxt
->
´ev
 = 
fœ¡
->prev;

409 
Ï¡
->
Ãxt
 = &
de¡
->
nnode
;

410 
fœ¡
->
´ev
 = 
de¡
->
nnode
.prev;

411 
de¡
->
nnode
.
´ev
->
Ãxt
 = 
fœ¡
;

412 
de¡
->
nnode
.
´ev
 = 
Ï¡
;

414 
fœ¡
 !ğ
Ï¡
) {

415 
fœ¡
 = fœ¡->
Ãxt
;

416 
	`as£¹
 (
fœ¡
 !ğ
	`li¡_n
(
sourû
));

417 
moved
++;

421 
	`as£¹
 (
sourû
->
nodecouÁ
 - 
moved
 <= source->nodecount);

422 
	`as£¹
 (
de¡
->
nodecouÁ
 + 
moved
 >= dest->nodecount);

425 
	`as£¹
 (
moved
 <ğ
sourû
->
nodecouÁ
);

427 
sourû
->
nodecouÁ
 -ğ
moved
;

428 
de¡
->
nodecouÁ
 +ğ
moved
;

431 
	`as£¹
 (
	`li¡_v”ify
(
sourû
));

432 
	`as£¹
 (
	`li¡_v”ify
(
de¡
));

433 
	}
}

444 
	$li¡_Œªsãr
(
li¡_t
 *
de¡
,†i¡_ˆ*
sourû
, 
Êode_t
 *
fœ¡
)

446 
li¡couÁ_t
 
moved
 = 1;

447 
Êode_t
 *
Ï¡
;

449 
	`as£¹
 (
fœ¡
 =ğ
NULL
 || 
	`li¡_cÚšs
(
sourû
, first));

451 ià(
fœ¡
 =ğ
NULL
)

454 
Ï¡
 = 
sourû
->
nnode
.
´ev
;

456 
sourû
->
nnode
.
´ev
 = 
fœ¡
->prev;

457 
fœ¡
->
´ev
->
Ãxt
 = &
sourû
->
nnode
;

459 
Ï¡
->
Ãxt
 = &
de¡
->
nnode
;

460 
fœ¡
->
´ev
 = 
de¡
->
nnode
.prev;

461 
de¡
->
nnode
.
´ev
->
Ãxt
 = 
fœ¡
;

462 
de¡
->
nnode
.
´ev
 = 
Ï¡
;

464 
fœ¡
 !ğ
Ï¡
) {

465 
fœ¡
 = fœ¡->
Ãxt
;

466 
moved
++;

470 
	`as£¹
 (
sourû
->
nodecouÁ
 - 
moved
 <= source->nodecount);

471 
	`as£¹
 (
de¡
->
nodecouÁ
 + 
moved
 >= dest->nodecount);

474 
	`as£¹
 (
moved
 <ğ
sourû
->
nodecouÁ
);

476 
sourû
->
nodecouÁ
 -ğ
moved
;

477 
de¡
->
nodecouÁ
 +ğ
moved
;

480 
	`as£¹
 (
	`li¡_v”ify
(
sourû
));

481 
	`as£¹
 (
	`li¡_v”ify
(
de¡
));

482 
	}
}

484 
li¡_m”ge
(
li¡_t
 *
de¡
,†i¡_ˆ*
sour
,

485 
	$com·»
 (const *, const *))

487 
Êode_t
 *
dn
, *
¢
, *
Š
;

488 
Êode_t
 *
d_n
 = 
	`li¡_n
(
de¡
), *
s_n
 =†i¡_n(
sour
);

491 ià(
de¡
 =ğ
sour
)

495 
	`as£¹
 (
	`li¡_couÁ
(
sour
è+†i¡_couÁ(
de¡
) >=†ist_count(sour));

498 
	`as£¹
 (
	`li¡_is_sÜ‹d
(
sour
, 
com·»
));

499 
	`as£¹
 (
	`li¡_is_sÜ‹d
(
de¡
, 
com·»
));

501 
dn
 = 
	`li¡_fœ¡_´iv
(
de¡
);

502 
¢
 = 
	`li¡_fœ¡_´iv
(
sour
);

504 
dn
 !ğ
d_n
 && 
¢
 !ğ
s_n
) {

505 ià(
	`com·»
(
	`Êode_g‘
(
dn
),†node_g‘(
¢
)) >= 0) {

506 
Š
 = 
	`Êode_Ãxt
(
¢
);

507 
	`li¡_d–‘e
(
sour
, 
¢
);

508 
	`li¡_šs_befÜe
(
de¡
, 
¢
, 
dn
);

509 
¢
 = 
Š
;

511 
dn
 = 
	`Êode_Ãxt
(dn);

515 ià(
dn
 !ğ
d_n
)

518 ià(
¢
 !ğ
s_n
)

519 
	`li¡_Œªsãr
(
de¡
, 
sour
, 
¢
);

520 
	}
}

522 
li¡_sÜt
(
li¡_t
 *
li¡
, 
	$com·»
(const *, const *))

524 
li¡_t
 
exŒa
;

525 
li¡couÁ_t
 
middË
;

526 
Êode_t
 *
node
;

528 ià(
	`li¡_couÁ
(
li¡
) > 1) {

529 
middË
 = 
	`li¡_couÁ
(
li¡
) / 2;

530 
node
 = 
	`li¡_fœ¡_´iv
(
li¡
);

532 
	`li¡_š™
(&
exŒa
, 
	`li¡_couÁ
(
li¡
è- 
middË
);

534 
middË
--)

535 
node
 = 
	`Êode_Ãxt
(node);

537 
	`li¡_Œªsãr
(&
exŒa
, 
li¡
, 
node
);

538 
	`li¡_sÜt
(
li¡
, 
com·»
);

539 
	`li¡_sÜt
(&
exŒa
, 
com·»
);

540 
	`li¡_m”ge
(
li¡
, &
exŒa
, 
com·»
);

542 
	`as£¹
 (
	`li¡_is_sÜ‹d
(
li¡
, 
com·»
));

543 
	}
}

545 
Êode_t
 *
li¡_fšd
(
li¡_t
 *
li¡
, cÚ¡ *
key
, 
	$com·»
(const *, const *))

547 
Êode_t
 *
node
;

549 
node
 = 
	`li¡_fœ¡_´iv
(
li¡
);‚od!ğ
	`li¡_n
Öi¡);‚odğnode->
Ãxt
) {

550 ià(
	`com·»
(
	`Êode_g‘
(
node
), 
key
) == 0)

551  
node
;

555 
	}
}

562 
li¡_is_sÜ‹d
(
li¡_t
 *
li¡
, 
	$com·»
(const *, const *))

564 
Êode_t
 *
node
, *
Ãxt
, *
n
;

566 
Ãxt
 = 
n
 = 
	`li¡_n
(
li¡
);

567 
node
 = 
	`li¡_fœ¡_´iv
(
li¡
);

569 ià(
node
 !ğ
n
)

570 
Ãxt
 = 
	`Êode_Ãxt
(
node
);

572 ; 
Ãxt
 !ğ
n
; 
node
 =‚ext,‚exˆğ
	`Êode_Ãxt
(next)) {

573 ià(
	`com·»
(
	`Êode_g‘
(
node
),†node_g‘(
Ãxt
)) > 0)

578 
	}
}

585 #undeà
li¡_i£m±y


586 #undeà
li¡_isfuÎ


587 #undeà
Êode_poŞ_i£m±y


588 #undeà
li¡_­³nd


589 #undeà
li¡_´•’d


590 #undeà
li¡_fœ¡


591 #undeà
li¡_Ï¡


592 #undeà
li¡_Ãxt


593 #undeà
li¡_´ev


594 #undeà
li¡_couÁ


595 #undeà
li¡_d–_fœ¡


596 #undeà
li¡_d–_Ï¡


597 #undeà
Êode_put


598 #undeà
Êode_g‘


604 
	$li¡_i£m±y
(
li¡_t
 *
li¡
)

606  
li¡
->
nodecouÁ
 == 0;

607 
	}
}

614 
	$li¡_isfuÎ
(
li¡_t
 *
li¡
)

616  
li¡
->
nodecouÁ
 =ğli¡->
maxcouÁ
;

617 
	}
}

623 
	$Êode_poŞ_i£m±y
(
Êod•oŞ_t
 *
poŞ
)

625  (
poŞ
->
äe
 =ğ
NULL
);

626 
	}
}

632 
	$li¡_­³nd
(
li¡_t
 *
li¡
, 
Êode_t
 *
node
)

634 
	`li¡_šs_befÜe
(
li¡
, 
node
, &li¡->
nnode
);

635 
	}
}

641 
	$li¡_´•’d
(
li¡_t
 *
li¡
, 
Êode_t
 *
node
)

643 
	`li¡_šs_aá”
(
li¡
, 
node
, &li¡->
nnode
);

644 
	}
}

650 
Êode_t
 *
	$li¡_fœ¡
(
li¡_t
 *
li¡
)

652 ià(
li¡
->
nnode
.
Ãxt
 == &list->nilnode)

653  
NULL
;

654  
li¡
->
nnode
.
Ãxt
;

655 
	}
}

661 
Êode_t
 *
	$li¡_Ï¡
(
li¡_t
 *
li¡
)

663 ià(
li¡
->
nnode
.
´ev
 == &list->nilnode)

664  
NULL
;

665  
li¡
->
nnode
.
´ev
;

666 
	}
}

672 
li¡couÁ_t
 
	$li¡_couÁ
(
li¡_t
 *
li¡
)

674  
li¡
->
nodecouÁ
;

675 
	}
}

681 
Êode_t
 *
	$li¡_d–_fœ¡
(
li¡_t
 *
li¡
)

683  
	`li¡_d–‘e
(
li¡
,†i¡->
nnode
.
Ãxt
);

684 
	}
}

690 
Êode_t
 *
	$li¡_d–_Ï¡
(
li¡_t
 *
li¡
)

692  
	`li¡_d–‘e
(
li¡
,†i¡->
nnode
.
´ev
);

693 
	}
}

700 
	$Êode_put
(
Êode_t
 *
Êode
, *
d©a
)

702 
Êode
->
d©a
 = data;

703 
	}
}

709 *
	$Êode_g‘
(
Êode_t
 *
Êode
)

711  
Êode
->
d©a
;

712 
	}
}

719 
Êode_t
 *
	$li¡_Ãxt
(
li¡_t
 *
li¡
, 
Êode_t
 *
Êode
)

721 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
Êode
));

723 ià(
Êode
->
Ãxt
 =ğ
	`li¡_n
(
li¡
))

724  
NULL
;

725  
Êode
->
Ãxt
;

726 
	}
}

732 
Êode_t
 *
	$li¡_´ev
(
li¡_t
 *
li¡
, 
Êode_t
 *
Êode
)

734 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
Êode
));

736 ià(
Êode
->
´ev
 =ğ
	`li¡_n
(
li¡
))

737  
NULL
;

738  
Êode
->
´ev
;

739 
	}
}

745 
	$Êode_is_š_a_li¡
(
Êode_t
 *
Êode
)

747  (
Êode
->
Ãxt
 !ğ
NULL
 ||†node->
´ev
 != NULL);

748 
	}
}

751 
	$li¡_v”ify
(
li¡_t
 *
li¡
)

753 
Êode_t
 *
node
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
n
 = 
	`li¡_n
(list);

754 
li¡couÁ_t
 
couÁ
 = 
	`li¡_couÁ
(
li¡
);

756 ià(
node
->
´ev
 !ğ
n
)

759 ià(
couÁ
 > 
li¡
->
maxcouÁ
)

762 
node
 !ğ
n
 && 
couÁ
--) {

763 ià(
node
->
Ãxt
->
´ev
 !=‚ode)

765 
node
 =‚ode->
Ãxt
;

768 ià(
couÁ
 !ğ0 || 
node
 !ğ
n
)

772 
	}
}

	@src/adt/list.h

1 #undeà
KAZLIB_OPAQUE_DEBUG


23 #iâdeà
LIST_H


24 
	#LIST_H


	)

26 
	~<lim™s.h
>

28 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


29 
	~"sfx.h
"

30 
	#LIST_SFX_CHECK
(
E
è
	`SFX_CHECK
(E)

	)

32 
	#LIST_SFX_CHECK
(
E
è(E)

	)

39 #ifdeà
__ılu¥lus


43 
	tli¡couÁ_t
;

44 
	#LISTCOUNT_T_MAX
 
ULONG_MAX


	)

46 
	sÊode_t
 {

47 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

48 
Êode_t
 *
li¡_Ãxt
;

49 
Êode_t
 *
li¡_´ev
;

50 *
li¡_d©a
;

52 
li¡_dummy
;

54 } 
	tÊode_t
;

56 
	sÊod•oŞ_t
 {

57 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

58 
Êode_t
 *
li¡_poŞ
;

59 
Êode_t
 *
li¡_ä“
;

60 
li¡couÁ_t
 
li¡_size
;

62 
li¡_dummy
;

64 } 
	tÊod•oŞ_t
;

66 
	sli¡_t
 {

67 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

68 
Êode_t
 
li¡_nnode
;

69 
li¡couÁ_t
 
li¡_nodecouÁ
;

70 
li¡couÁ_t
 
li¡_maxcouÁ
;

72 
li¡_dummy
;

74 } 
	tli¡_t
;

76 
Êode_t
 *
Êode_ü—‹
(*);

77 
Êode_t
 *
Êode_š™
(lnode_t *, *);

78 
Êode_de¡roy
(
Êode_t
 *);

79 
Êode_put
(
Êode_t
 *, *);

80 *
Êode_g‘
(
Êode_t
 *);

81 
Êode_is_š_a_li¡
(
Êode_t
 *);

83 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

84 
	#Êode_put
(
N
, 
D
è((N)->
li¡_d©a
 = (D))

	)

85 
	#Êode_g‘
(
N
è((N)->
li¡_d©a
)

	)

88 
Êod•oŞ_t
 *
Êode_poŞ_š™
Önod•oŞ_ˆ*, 
Êode_t
 *, 
li¡couÁ_t
);

89 
Êod•oŞ_t
 *
Êode_poŞ_ü—‹
(
li¡couÁ_t
);

90 
Êode_poŞ_de¡roy
(
Êod•oŞ_t
 *);

91 
Êode_t
 *
Êode_bÜrow
(
Êod•oŞ_t
 *, *);

92 
Êode_»tuº
(
Êod•oŞ_t
 *, 
Êode_t
 *);

93 
Êode_poŞ_i£m±y
(
Êod•oŞ_t
 *);

94 
Êode_poŞ_isäom
(
Êod•oŞ_t
 *, 
Êode_t
 *);

96 
li¡_t
 *
li¡_š™
Öi¡_ˆ*, 
li¡couÁ_t
);

97 
li¡_t
 *
li¡_ü—‹
(
li¡couÁ_t
);

98 
li¡_de¡roy
(
li¡_t
 *);

99 
li¡_de¡roy_nodes
(
li¡_t
 *);

100 
li¡_»tuº_nodes
(
li¡_t
 *, 
Êod•oŞ_t
 *);

102 
li¡couÁ_t
 
li¡_couÁ
(
li¡_t
 *);

103 
li¡_i£m±y
(
li¡_t
 *);

104 
li¡_isfuÎ
(
li¡_t
 *);

105 
li¡_cÚšs
(
li¡_t
 *, 
Êode_t
 *);

107 
li¡_­³nd
(
li¡_t
 *, 
Êode_t
 *);

108 
li¡_´•’d
(
li¡_t
 *, 
Êode_t
 *);

109 
li¡_šs_befÜe
(
li¡_t
 *, 
Êode_t
 *,†node_t *);

110 
li¡_šs_aá”
(
li¡_t
 *, 
Êode_t
 *,†node_t *);

112 
Êode_t
 *
li¡_fœ¡
(
li¡_t
 *);

113 
Êode_t
 *
li¡_Ï¡
(
li¡_t
 *);

114 
Êode_t
 *
li¡_Ãxt
(
li¡_t
 *,†node_t *);

115 
Êode_t
 *
li¡_´ev
(
li¡_t
 *,†node_t *);

117 
Êode_t
 *
li¡_d–_fœ¡
(
li¡_t
 *);

118 
Êode_t
 *
li¡_d–_Ï¡
(
li¡_t
 *);

119 
Êode_t
 *
li¡_d–‘e
(
li¡_t
 *,†node_t *);

121 
li¡_´oûss
(
li¡_t
 *, *, (*)Öi¡_ˆ*, 
Êode_t
 *, *));

123 
li¡_v”ify
(
li¡_t
 *);

125 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

126 
	#Êode_poŞ_i£m±y
(
P
è((P)->
li¡_ä“
 =ğ0)

	)

127 
	#li¡_couÁ
(
L
è((L)->
li¡_nodecouÁ
)

	)

128 
	#li¡_i£m±y
(
L
è((L)->
li¡_nodecouÁ
 =ğ0)

	)

129 
	#li¡_isfuÎ
(
L
è(
	`LIST_SFX_CHECK
(L)->
li¡_nodecouÁ
 =ğ(L)->
li¡_maxcouÁ
)

	)

130 
	#li¡_Ãxt
(
L
, 
N
è(
	`LIST_SFX_CHECK
(N)->
li¡_Ãxt
 =ğ&(L)->
li¡_nnode
 ? 
NULL
 : (N)->li¡_Ãxt)

	)

131 
	#li¡_´ev
(
L
, 
N
è(
	`LIST_SFX_CHECK
(N)->
li¡_´ev
 =ğ&(L)->
li¡_nnode
 ? 
NULL
 : (N)->li¡_´ev)

	)

132 
	#li¡_fœ¡
(
L
è
	`li¡_Ãxt
(
	`LIST_SFX_CHECK
(L), &(L)->
li¡_nnode
)

	)

133 
	#li¡_Ï¡
(
L
è
	`li¡_´ev
(
	`LIST_SFX_CHECK
(L), &(L)->
li¡_nnode
)

	)

136 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

137 
	#li¡_­³nd
(
L
, 
N
è
	`li¡_šs_befÜe
(
	`LIST_SFX_CHECK
(L), N, &(L)->
li¡_nnode
)

	)

138 
	#li¡_´•’d
(
L
, 
N
è
	`li¡_šs_aá”
(
	`LIST_SFX_CHECK
(L), N, &(L)->
li¡_nnode
)

	)

139 
	#li¡_d–_fœ¡
(
L
è
	`li¡_d–‘e
(
	`LIST_SFX_CHECK
(L), 
	`li¡_fœ¡
(L))

	)

140 
	#li¡_d–_Ï¡
(
L
è
	`li¡_d–‘e
(
	`LIST_SFX_CHECK
(L), 
	`li¡_Ï¡
(L))

	)

145 
li¡_exŒaù
(
li¡_t
 *,†i¡_ˆ*, 
Êode_t
 *,†node_t *);

146 
li¡_Œªsãr
(
li¡_t
 *,†i¡_ˆ*, 
Êode_t
 *
fœ¡
);

147 
li¡_m”ge
(
li¡_t
 *,†ist_t *, (const *, const *));

148 
li¡_sÜt
(
li¡_t
 *, (const *, const *));

149 
Êode_t
 *
li¡_fšd
(
li¡_t
 *, const *, (const *, const *));

150 
li¡_is_sÜ‹d
(
li¡_t
 *, (const *, const *));

152 #ifdeà
__ılu¥lus


	@src/adt/tst.c

35 
	~<¡dlib.h
>

36 
	~"t¡.h
"

37 
	~<¡dio.h
>

38 
	~<as£¹.h
>

39 
	~<dbg.h
>

40 
	~<mem/h®loc.h
>

42 
	st¡_cŞËù_t
 {

43 
li¡_t
 *
	mv®ues
;

44 
t¡_cŞËù_‹¡_cb
 
	m‹¡”
;

45 cÚ¡ *
	mkey
;

46 
size_t
 
	mËn
;

47 } 
	tt¡_cŞËù_t
;

50 
	mMAX_TRAVERSE_SIZE
 = 128

53 
	$t¡_cŞËù_bud
(*
v®ue
, 
t¡_cŞËù_t
 *
»suÉs
)

55 if(!
»suÉs
->
‹¡”
 ||„esuÉs->
	`‹¡”
(
v®ue
,„esuÉs->
key
,„esuÉs->
Ën
)) {

56 
Êode_t
 *
node
 = 
	`Êode_ü—‹
(
v®ue
);

57 
	`li¡_­³nd
(
»suÉs
->
v®ues
, 
node
);

59 
	}
}

62 
li¡_t
 *
	$t¡_cŞËù
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
, 
t¡_cŞËù_‹¡_cb
 
‹¡”
)

64 
t¡_cŞËù_t
 
»suÉs
 = {.
v®ues
 = 
NULL
, .
‹¡”
 =e¡”, .
key
 = 
s
, .
Ën
 =†en};

65 
t¡_t
 *
p
 = 
roÙ
;

66 
t¡_t
 *
Ï¡
 = 
p
;

67 
size_t
 
i
 = 0;

68 
»suÉs
.
v®ues
 = 
	`li¡_ü—‹
(
LISTCOUNT_T_MAX
);

71 
i
 < 
Ën
 && 
p
) {

72 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

73 
p
 =…->
low
;

74 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

75 
i
++;

76 if(
i
 < 
Ën
) {

77 if(
p
->
v®ue
è
Ï¡
 =…;

78 
p
 =…->
equ®
;

81 
p
 =…->
high
;

85 if((
Ï¡
 && 
»suÉs
.
‹¡”
è|| 
p
) {

87 
	`t¡_Œav”£
(
p
 =ğ
NULL
 ? 
Ï¡
 :…, (
t¡_Œav”£_cb
)
t¡_cŞËù_bud
, &
»suÉs
);

90  
»suÉs
.
v®ues
;

91 
	}
}

93 *
	$t¡_£¬ch_suffix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
)

95 if(
Ën
 =ğ0è 
NULL
;

97 
t¡_t
 *
p
 = 
roÙ
;

98 
t¡_t
 *
Ï¡
 = 
NULL
;

99 
i
 = 
Ën
-1;

101 
i
 >ğ0 && 
p
) {

102 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

103 
p
 =…->
low
;

104 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

105 
i
--;

106 if(
i
 >= 0) {

107 if(
p
->
v®ue
è
Ï¡
 =…;

108 
p
 =…->
equ®
;

111 
p
 =…->
high
;

115 
p
 =… ?… : 
Ï¡
;

117 
p
 && !p->
v®ue
) {

118 
p
 =…->
equ®
;

121  
p
 ?…->
v®ue
 : 
NULL
;

122 
	}
}

124 *
	$t¡_£¬ch_´efix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
)

126 if(
Ën
 =ğ0è 
NULL
;

128 
t¡_t
 *
p
 = 
roÙ
;

129 
t¡_t
 *
Ï¡
 = 
NULL
;

130 
size_t
 
i
 = 0;

132 
i
 < 
Ën
 && 
p
) {

133 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

134 
p
 =…->
low
;

135 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

136 
i
++;

137 if(
i
 < 
Ën
) {

138 if(
p
->
v®ue
è
Ï¡
 =…;

139 
p
 =…->
equ®
;

142 
p
 =…->
high
;

146 
p
 =… ?… : 
Ï¡
;

149 
p
 && !p->
v®ue
) {

150 
p
 =…->
equ®
;

153  
p
 ?…->
v®ue
 : 
NULL
;

154 
	}
}

156 *
	$t¡_£¬ch
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
)

158 
t¡_t
 *
p
 = 
roÙ
;

159 
size_t
 
i
 = 0;

161 
i
 < 
Ën
 && 
p
) {

163 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

164 
p
 =…->
low
;

165 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

166 
i
++;

167 if(
i
 < 
Ën
è
p
 =…->
equ®
;

169 
p
 =…->
high
;

173 if(
p
) {

174  
p
->
v®ue
;

176  
NULL
;

178 
	}
}

181 
t¡_t
 *
	$t¡_š£¹_ba£
(
t¡_t
 *
roÙ
,¡_ˆ*
p
, cÚ¡ *
s
, 
size_t
 
Ën
, *
v®ue
)

183 ià(
p
 =ğ
NULL
) {

184 
p
 = (
t¡_t
 *è
	`h_ÿÎoc
((tst_t), 1);

186 if(
roÙ
 =ğ
NULL
) {

187 
roÙ
 = 
p
;

189 
	`h©ch
(
p
, 
roÙ
);

192 
p
->
¥l™ch¬
 = *
s
;

195 ià(*
s
 < 
p
->
¥l™ch¬
) {

196 
p
->
low
 = 
	`t¡_š£¹_ba£
(
roÙ
,…->low, 
s
, 
Ën
, 
v®ue
);

197 } ià(*
s
 =ğ
p
->
¥l™ch¬
) {

198 ià(
Ën
 > 1) {

200 
p
->
equ®
 = 
	`t¡_š£¹_ba£
(
roÙ
,…->equ®, 
s
+1, 
Ën
 - 1, 
v®ue
);

202 
	`as£¹
(
p
->
v®ue
 =ğ
NULL
 && "Duplicate insert intost.");

203 
p
->
v®ue
 = value;

206 
p
->
high
 = 
	`t¡_š£¹_ba£
(
roÙ
,…->high, 
s
, 
Ën
, 
v®ue
);

209  
p
;

210 
	}
}

212 
t¡_t
 *
	$t¡_š£¹
(
t¡_t
 *
p
, cÚ¡ *
s
, 
size_t
 
Ën
, *
v®ue
)

214  
	`t¡_š£¹_ba£
(
p
,…, 
s
, 
Ën
, 
v®ue
);

215 
	}
}

218 
t¡_t
 **
	$t¡_»size_queue
(
t¡_t
 **
queue
, 
q_¡¬t
, 
q_size
, 
q_max
, 
Ãw_size
)

220 
i
 = 0;

221 
t¡_t
 ** 
Ãw_queue
 = 
	`ÿÎoc
(Ñ¡_ˆ*), 
Ãw_size
);

222 
	`check
(
Ãw_queue
, "Failedo„eallocate queue forraverse");

224 
i
 = 0; i < 
q_size
; i++) {

225 
Ãw_queue
[
i
] = 
queue
[(˜+ 
q_¡¬t
è% 
q_max
];

228 
	`ä“
(
queue
);

229  
Ãw_queue
;

231 
”rÜ
:

232 
	`ä“
(
queue
);

233  
NULL
;

234 
	}
}

238 
	$t¡_Œav”£
(
t¡_t
 *
p
, 
t¡_Œav”£_cb
 
cb
, *
d©a
)

240 ià(!
p
) ;

242 
q_¡¬t
 = 0;

243 
q_size
 = 0;

244 
q_max
 = 
MAX_TRAVERSE_SIZE
;

245 
t¡_t
 **
queue
 = 
	`ÿÎoc
(Ñ¡_ˆ*), 
MAX_TRAVERSE_SIZE
);

247 
	`check
(
queue
, "Failedo malloc queue forraverse");

249 
queue
[
q_¡¬t
] = 
p
;

250 
q_size
++;

252 
q_size
 > 0) {

253 
t¡_t
 *
cur
 = 
queue
[
q_¡¬t
];

254 
q_¡¬t
 = (q_¡¬ˆ+ 1è% 
q_max
;

255 
q_size
--;

258 if(
q_size
 + 3 > 
q_max
) {

259 
queue
 = 
	`t¡_»size_queue
(queue, 
q_¡¬t
, 
q_size
, 
q_max
, q_max * 2);

260 
q_¡¬t
 = 0;

261 
q_max
 = q_max * 2;

264 if(
cur
->
v®ue
è
	`cb
(cur->v®ue, 
d©a
);

266 if(
cur
->
low
è
queue
[(
q_¡¬t
 + (
q_size
++)è% 
q_max
] = cur->low;

267 if(
cur
->
equ®
è
queue
[(
q_¡¬t
 + (
q_size
++)è% 
q_max
] = cur->equal;

268 if(
cur
->
high
è
queue
[(
q_¡¬t
 + (
q_size
++)è% 
q_max
] = cur->high;

271 
	`ä“
(
queue
);

274 
”rÜ
:

275 if(
queue
è
	`ä“
(queue);

276 
	}
}

279 
	$t¡_de¡roy
(
t¡_t
 *
roÙ
)

281 if(
roÙ
) {

282 
	`h_ä“
(
roÙ
);

284 
	}
}

	@src/adt/tst.h

35 #iâdeà
t¡_h


36 
	#t¡_h


	)

38 
	~<¡dlib.h
>

39 
	~<adt/li¡.h
>

41 
	st¡_t
 {

42 
	m¥l™ch¬
;

43 
t¡_t
 *
	mlow
;

44 
t¡_t
 *
	mequ®
;

45 
t¡_t
 *
	mhigh
;

46 *
	mv®ue
;

47 } 
	tt¡_t
;

50 (*
	tt¡_Œav”£_cb
)(*
	tv®ue
, *
	td©a
);

51 (*
	tt¡_cŞËù_‹¡_cb
)(*
	tv®ue
, cÚ¡ *
	t·th
, 
	tsize_t
 
	tËn
);

56 *
	`t¡_£¬ch_suffix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
);

58 *
	`t¡_£¬ch
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
);

60 *
	`t¡_£¬ch_´efix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
);

62 
t¡_t
 *
	`t¡_š£¹
Ñ¡_ˆ*
p
, cÚ¡ *
s
, 
size_t
 
Ën
, *
v®ue
);

64 
	`t¡_Œav”£
(
t¡_t
 *
p
, 
t¡_Œav”£_cb
 
cb
, *
d©a
);

66 
li¡_t
 *
	`t¡_cŞËù
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
, 
t¡_cŞËù_‹¡_cb
 
‹¡”
);

68 
	`t¡_de¡roy
(
t¡_t
 *
roÙ
);

	@src/bsd_specific.c

35 
	~<¡ddef.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/uio.h
>

39 
	~<sk/sk.h
>

40 
	~<dbg.h
>

43 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
)

48 
	$bsd_£ndfe
(
out_fd
, 
š_fd
, 
off_t
 *
off£t
, 
size_t
 
couÁ
) {

49 
off_t
 
my_couÁ
 = 
couÁ
;

50 
rc
;

55 
	`fdwa™
(
out_fd
, 'w');

56 #ià
	`defšed
(
__APPLE__
)

57 
rc
 = 
	`£ndfe
(
š_fd
, 
out_fd
, *
off£t
, &
my_couÁ
, 
NULL
, 0);

58 #–ià
	`defšed
(
__F»eBSD__
)

59 
rc
 = 
	`£ndfe
(
š_fd
, 
out_fd
, *
off£t
, 
couÁ
, 
NULL
, &
my_couÁ
, 0);

61 *
off£t
 +ğ
my_couÁ
;

62 } 
rc
 !ğ0 && 
”ºo
 == 35);

64 
	`check
(
rc
 == 0, "OS X sendfile wrapper failed");

66  
my_couÁ
;

68 
”rÜ
:

70 
	}
}

74 
fd»cv
(
fd
, *
buf
, 
n
);

75 
fd£nd
(
fd
, *
buf
, 
n
);

77 
	#BSD_SENDFILE_BUF_SIZE
 16384

	)

78 
	~<uni¡d.h
>

82 
	$bsd_£ndfe
(
out_fd
, 
š_fd
, 
off_t
 *
off£t
, 
size_t
 
couÁ
) {

83 
buf
[
BSD_SENDFILE_BUF_SIZE
];

84 
»t
 = -1;

85 
off_t
 
Üig_off£t
 = 0;

86 
cur
 = 0;

87 
»m
 = 
couÁ
;

88 
£Á
 = 0;

89 
size_t
 
tÙ
 = 0;

91 
	`check
(
»m
 > 0, "Possible integer overflow in count.");

93 ià(
off£t
 !ğ
NULL
) {

94 
Üig_off£t
 = 
	`l£ek
(
š_fd
, 0, 
SEEK_CUR
);

95 
	`check
(
Üig_off£t
 >= 0, "lseek failure when determining current…osition");

96 
	`check
(
	`l£ek
(
š_fd
, *
off£t
, 
SEEK_SET
) >= 0, "lseek failure when setting‚ew…osition");

99 
tÙ
 = 0, 
»m
 = 
couÁ
, 
cur
 =„em; cur != 0 &&ot < count;ot += cur,„em -= cur) {

100 ià(
»m
 >ğ
BSD_SENDFILE_BUF_SIZE
) {

101 
cur
 = 
BSD_SENDFILE_BUF_SIZE
;

103 
cur
 = 
»m
;

106 
cur
 = 
	`fd»ad
(
š_fd
, 
buf
, cur);

107 
	`check
(
cur
 >= 0, "Internal sendfileƒmulation failed: fdread: %i", cur);

109 ià(
cur
 != 0) {

110 
£Á
 = 
	`fdwr™e
(
out_fd
, 
buf
, 
cur
);

111 
	`check
(
£Á
 =ğ
cur
, "Internal sendfileƒmulation failed: fdread: %i, fdwrite: %i", cur, sent);

115 
»t
 = 
tÙ
;

117 
”rÜ
:

118 ià(
off£t
 !ğ
NULL
) {

119 ià(
»t
 != -1) {

120 *
off£t
 +ğ
tÙ
;

122 
	`l£ek
(
š_fd
, 
Üig_off£t
, 
SEEK_SET
);

124  
»t
;

125 
	}
}

	@src/bsd_specific.h

35 #iâdeà
_MAC_SPECIFIC_H


36 
	#_MAC_SPECIFIC_H


	)

37 
	~<sys/ty³s.h
>

39 
bsd_£ndfe
(
out_fd
, 
š_fd
, 
off_t
 *
off£t
, 
size_t
 
couÁ
);

	@src/bstr/bsafe.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~"b§ã.h
"

21 
	gb§ãShouldEx™
 = 1;

23 * 
¡rıy
 (*
d¡
, cÚ¡ *
¤c
);

24 * 
¡rÿt
 (*
d¡
, cÚ¡ *
¤c
);

26 * 
	$¡rıy
 (*
d¡
, cÚ¡ *
¤c
) {

27 
d¡
 = dst;

28 
¤c
 = src;

29 
	`årštf
 (
¡d”r
, "bsafeƒrror: strcpy() is‚ot safe, use bstrcpy instead.\n");

30 ià(
b§ãShouldEx™
è
	`ex™
 (-1);

31  
NULL
;

32 
	}
}

34 * 
	$¡rÿt
 (*
d¡
, cÚ¡ *
¤c
) {

35 
d¡
 = dst;

36 
¤c
 = src;

37 
	`årštf
 (
¡d”r
, "bsafeƒrror: strcat() is‚ot safe, use bstrcat instead.\n");

38 ià(
b§ãShouldEx™
è
	`ex™
 (-1);

39  
NULL
;

40 
	}
}

42 #ià!
defšed
 (
__GNUC__
è&& (!defšed(
_MSC_VER
) || (_MSC_VER <= 1310))

43 * (
	gg‘s
è(* 
	gbuf
) {

44 
	gbuf
 = 
buf
;

45 
årštf
 (
¡d”r
, "bsafeƒrror: gets() is‚ot safe, use bgets.\n");

46 ià(
	gb§ãShouldEx™
è
ex™
 (-1);

47  
	gNULL
;

60 * (
	g¡ºÿt
è(*
	gd¡
, cÚ¡ *
	g¤c
, 
size_t
 
	gn
) {

61 
	gd¡
 = 
d¡
;

62 
	g¤c
 = 
¤c
;

63 
	gn
 = 
n
;

64 
årštf
 (
¡d”r
, "bsafeƒrror: strncat() is‚ot safe, use bstrcathen btrunc\n\tor cstr2tbstr, btrunchen bstrcat instead.\n");

65 ià(
	gb§ãShouldEx™
è
ex™
 (-1);

66  
	gNULL
;

69 * (
	g¡¹ok
è(*
	gs1
, cÚ¡ *
	gs2
) {

70 
	gs1
 = 
s1
;

71 
	gs2
 = 
s2
;

72 
årštf
 (
¡d”r
, "bsafeƒrror: strtok() is‚ot safe, use bsplit or bsplits instead.\n");

73 ià(
	gb§ãShouldEx™
è
ex™
 (-1);

74  
	gNULL
;

	@src/bstr/bsafe.h

17 #iâdeà
BSTRLIB_BSAFE_INCLUDE


18 
	#BSTRLIB_BSAFE_INCLUDE


	)

20 #ifdeà
__ılu¥lus


24 #ià!
defšed
 (
__GNUC__
è&& (!defšed(
_MSC_VER
) || (_MSC_VER <= 1310))

26 * (
g‘s
è(* 
buf
);

30 * (
¡ºÿt
è(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
n
);

31 * (
¡¹ok
è(*
s1
, cÚ¡ *
s2
);

34 #undeà
¡rıy


35 #undeà
¡rÿt


36 
	#¡rıy
(
a
,
b
è
	`b§ã_¡rıy
×,b)

	)

37 
	#¡rÿt
(
a
,
b
è
	`b§ã_¡rÿt
×,b)

	)

39 #ifdeà
__ılu¥lus


	@src/bstr/bstraux.c

1 #ifdeà
_MSC_VER


2 
	#_CRT_SECURE_NO_WARNINGS


	)

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<lim™s.h
>

24 
	~<ùy³.h
>

25 
	~<¡dšt.h
>

26 
	~"b¡¾ib.h
"

27 
	~"b¡¿ux.h
"

33 
b¡ršg
 
	$bTa
 (
b¡ršg
 
b
, 
n
) {

34 ià(
b
 =ğ
NULL
 || 
n
 < 0 || (b->
mËn
 < b->
¦’
 && b->mlen > 0))  NULL;

35 ià(
n
 >ğ
b
->
¦’
è 
	`b¡rıy
 (b);

36  
	`bmid¡r
 (
b
, b->
¦’
 - 
n
,‚);

37 
	}
}

43 
b¡ršg
 
	$bH—d
 (
b¡ršg
 
b
, 
n
) {

44 ià(
b
 =ğ
NULL
 || 
n
 < 0 || (b->
mËn
 < b->
¦’
 && b->mlen > 0))  NULL;

45 ià(
n
 >ğ
b
->
¦’
è 
	`b¡rıy
 (b);

46  
	`bmid¡r
 (
b
, 0, 
n
);

47 
	}
}

53 
	$bFl
 (
b¡ršg
 
b
, 
c
, 
Ën
) {

54 ià(
b
 =ğ
NULL
 || 
Ën
 < 0 || (b->
mËn
 < b->
¦’
 && b->mËÀ> 0)è -
__LINE__
;

55 
b
->
¦’
 = 0;

56  
	`b£t¡r
 (
b
, 
Ën
, 
NULL
, 
c
);

57 
	}
}

63 
	$bR•liÿ‹
 (
b¡ršg
 
b
, 
n
) {

64  
	`b·‰”n
 (
b
, 
n
 * b->
¦’
);

65 
	}
}

71 
	$bRev”£
 (
b¡ršg
 
b
) {

72 
i
, 
n
, 
m
;

73 
t
;

75 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->¦’è -
__LINE__
;

76 
n
 = 
b
->
¦’
;

77 ià(2 <ğ
n
) {

78 
m
 = (()
n
) >> 1;

79 
n
--;

80 
i
=0; i < 
m
; i++) {

81 
t
 = 
b
->
d©a
[
n
 - 
i
];

82 
b
->
d©a
[
n
 - 
i
] = b->data[i];

83 
b
->
d©a
[
i
] = 
t
;

87 
	}
}

94 
	$bIn£¹Chrs
 (
b¡ršg
 
b
, 
pos
, 
Ën
, 
c
, 
fl
) {

95 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->¦’ || 
pos
 < 0 || 
Ën
 <ğ0è -
__LINE__
;

97 ià(
pos
 > 
b
->
¦’


98 && 0 > 
	`b£t¡r
 (
b
, 
pos
, 
NULL
, 
fl
)è -
__LINE__
;

100 ià(0 > 
	`b®loc
 (
b
, b->
¦’
 + 
Ën
)è -
__LINE__
;

101 ià(
pos
 < 
b
->
¦’
è
	`memmove
 (b->
d©a
 +…o + 
Ën
, b->data +…os, b->slen -…os);

102 
	`mem£t
 (
b
->
d©a
 + 
pos
, 
c
, 
Ën
);

103 
b
->
¦’
 +ğ
Ën
;

104 
b
->
d©a
[b->
¦’
] = () '\0';

105  
BSTR_OK
;

106 
	}
}

112 
	$bJu¡ifyLeá
 (
b¡ršg
 
b
, 
¥aû
) {

113 
j
, 
i
, 
s
, 
t
;

114 
c
 = (è
¥aû
;

116 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->¦’è -
__LINE__
;

117 ià(
¥aû
 !ğ(è
c
è 
BSTR_OK
;

119 
s
=
j
=
i
=0; i < 
b
->
¦’
; i++) {

120 
t
 = 
s
;

121 
s
 = 
c
 !ğ(
b
->
d©a
[
j
] = b->d©a[
i
]);

122 
j
 +ğ(
t
|
s
);

124 ià(
j
 > 0 && 
b
->
d©a
[j-1] =ğ
c
) j--;

126 
b
->
d©a
[
j
] = () '\0';

127 
b
->
¦’
 = 
j
;

128  
BSTR_OK
;

129 
	}
}

135 
	$bJu¡ifyRight
 (
b¡ršg
 
b
, 
width
, 
¥aû
) {

136 
»t
;

137 ià(
width
 <ğ0è -
__LINE__
;

138 ià(0 > (
»t
 = 
	`bJu¡ifyLeá
 (
b
, 
¥aû
))) „et;

139 ià(
b
->
¦’
 <ğ
width
)

140  
	`bIn£¹Chrs
 (
b
, 0, 
width
 - b->
¦’
, (è
¥aû
, () space);

141  
BSTR_OK
;

142 
	}
}

149 
	$bJu¡ifyC’‹r
 (
b¡ršg
 
b
, 
width
, 
¥aû
) {

150 
»t
;

151 ià(
width
 <ğ0è -
__LINE__
;

152 ià(0 > (
»t
 = 
	`bJu¡ifyLeá
 (
b
, 
¥aû
))) „et;

153 ià(
b
->
¦’
 <ğ
width
)

154  
	`bIn£¹Chrs
 (
b
, 0, (
width
 - b->
¦’
 + 1è>> 1, (è
¥aû
, () space);

155  
BSTR_OK
;

156 
	}
}

164 
	$bJu¡ifyM¬gš
 (
b¡ršg
 
b
, 
width
, 
¥aû
) {

165 
b¡rLi¡
 * 
¦
;

166 
i
, 
l
, 
c
;

168 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 =ğ0 || b->mËÀ< b->¦’è -
__LINE__
;

169 ià(
NULL
 =ğ(
¦
 = 
	`b¥l™
 (
b
, (è
¥aû
))è -
__LINE__
;

170 
l
=
c
=
i
=0; i < 
¦
->
qty
; i++) {

171 ià(
¦
->
’Œy
[
i
]->
¦’
 > 0) {

172 
c
 ++;

173 
l
 +ğ
¦
->
’Œy
[
i
]->
¦’
;

177 ià(
l
 + 
c
 >ğ
width
 || c < 2) {

178 
	`b¡rLi¡De¡roy
 (
¦
);

179  
	`bJu¡ifyLeá
 (
b
, 
¥aû
);

182 
b
->
¦’
 = 0;

183 
i
=0; i < 
¦
->
qty
; i++) {

184 ià(
¦
->
’Œy
[
i
]->
¦’
 > 0) {

185 ià(
b
->
¦’
 > 0) {

186 
s
 = (
width
 - 
l
 + (
c
 / 2)) / c;

187 
	`bIn£¹Chrs
 (
b
, b->
¦’
, 
s
, (è
¥aû
, () space);

188 
l
 +ğ
s
;

190 
	`bcÚÿt
 (
b
, 
¦
->
’Œy
[
i
]);

191 
c
--;

192 ià(
c
 <= 0) ;

196 
	`b¡rLi¡De¡roy
 (
¦
);

197  
BSTR_OK
;

198 
	}
}

200 
size_t
 
	$»adNÙhšg
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

201 
buff
 = buff;

202 
–size
 =ƒlsize;

203 
ÃËm
 =‚elem;

204 
·rm
 =…arm;

206 
	}
}

213 
bSŒ—m
 * 
	$bsFromB¡r
 (
cÚ¡_b¡ršg
 
b
) {

214 
bSŒ—m
 * 
s
 = 
	`bsİ’
 ((
bN»ad
è
»adNÙhšg
, 
NULL
);

215 
	`bsuÄ—d
 (
s
, 
b
);

216  
s
;

217 
	}
}

219 
size_t
 
	$»adRef
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

220 
gb¡ršg
 * 
t
 = (gb¡ršg *è
·rm
;

221 
size_t
 
tsz
 = 
–size
 * 
ÃËm
;

223 ià(
tsz
 > (
size_t
è
t
->
¦’
)sz = (size_t)->slen;

224 ià(
tsz
 > 0) {

225 
	`memıy
 (
buff
, 
t
->
d©a
, 
tsz
);

226 
t
->
¦’
 -ğ(è
tsz
;

227 
t
->
d©a
 +ğ
tsz
;

228  
tsz
 / 
–size
;

231 
	}
}

239 
bSŒ—m
 * 
	$bsFromB¡rRef
 (
gb¡ršg
 * 
t
) {

240 ià(!
t
è 
NULL
;

241  
	`bsİ’
 ((
bN»ad
è
»adRef
, 
t
);

242 
	}
}

254 * 
	$bSŒ2N‘SŒ
 (
cÚ¡_b¡ršg
 
b
) {

255 
size_t
 
numËn
 =  (
b
->
¦’
) * 3 + 1;

256 
¡ºum
[
numËn
+1];

257 
b¡ršg
 
s
;

258 * 
buff
;

260 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0)  NULL;

261 
	`¢´štf
(
¡ºum
, 
numËn
+1, "%d:", 
b
->
¦’
);

262 ià(
NULL
 =ğ(
s
 = 
	`bäomc¡r
 (
¡ºum
))

263 || 
	`bcÚÿt
 (
s
, 
b
è=ğ
BSTR_ERR
 || 
	`bcÚch¬
 (s, () ',') == BSTR_ERR) {

264 
	`bde¡roy
 (
s
);

265  
NULL
;

267 
buff
 = 
s
->
d©a
;

268 
	`bc¡rä“
 ((*è
s
);

269  (*è
buff
;

270 
	}
}

279 
b¡ršg
 
	$bN‘SŒ2B¡r
 (cÚ¡ * 
buff
) {

280 
i
, 
x
;

281 
b¡ršg
 
b
;

282 ià(
buff
 =ğ
NULL
)  NULL;

283 
x
 = 0;

284 
i
=0; 
buff
[i] != ':'; i++) {

285 
v
 = 
buff
[
i
] - '0';

286 ià(
v
 > 9 || 
x
 > ((
INT_MAX
 - (sigÃd )vè/ 10)è 
NULL
;

287 
x
 = (x * 10è+ 
v
;

291 ià(
buff
[
i
 + 1 + 
x
] !ğ','è 
NULL
;

293 ià(
NULL
 =ğ(
b
 = 
	`bäomc¡r
 ("")))  NULL;

294 ià(
	`b®loc
 (
b
, 
x
 + 1è!ğ
BSTR_OK
) {

295 
	`bde¡roy
 (
b
);

296  
NULL
;

298 
	`memıy
 (
b
->
d©a
, 
buff
 + 
i
 + 1, 
x
);

299 
b
->
d©a
[
x
] = () '\0';

300 
b
->
¦’
 = 
x
;

301  
b
;

302 
	}
}

304 
	gb64ETabË
[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

310 
b¡ršg
 
	$bBa£64Encode
 (
cÚ¡_b¡ršg
 
b
) {

311 
i
, 
c0
, 
c1
, 
c2
, 
c3
;

312 
b¡ršg
 
out
;

314 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

316 
out
 = 
	`bäomc¡r
 ("");

317 
i
=0; i + 2 < 
b
->
¦’
; i += 3) {

318 
c0
 = 
b
->
d©a
[
i
] >> 2;

319 
c1
 = ((
b
->
d©a
[
i
] << 4) |

320 (
b
->
d©a
[
i
+1] >> 4)) & 0x3F;

321 
c2
 = ((
b
->
d©a
[
i
+1] << 2) |

322 (
b
->
d©a
[
i
+2] >> 6)) & 0x3F;

323 
c3
 = 
b
->
d©a
[
i
+2] & 0x3F;

324 ià(
	`bcÚch¬
 (
out
, 
b64ETabË
[
c0
]) < 0 ||

325 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c1
]) < 0 ||

326 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c2
]) < 0 ||

327 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c3
]) < 0) {

328 
	`bde¡roy
 (
out
);

329  
NULL
;

333 
i
 + 2 - 
b
->
¦’
) {

334 0: 
c0
 = 
b
->
d©a
[
i
] >> 2;

335 
c1
 = ((
b
->
d©a
[
i
] << 4) |

336 (
b
->
d©a
[
i
+1] >> 4)) & 0x3F;

337 
c2
 = (
b
->
d©a
[
i
+1] << 2) & 0x3F;

338 ià(
	`bcÚch¬
 (
out
, 
b64ETabË
[
c0
]) < 0 ||

339 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c1
]) < 0 ||

340 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c2
]) < 0 ||

341 
	`bcÚch¬
 (
out
, () '=') < 0) {

342 
	`bde¡roy
 (
out
);

343  
NULL
;

346 1: 
c0
 = 
b
->
d©a
[
i
] >> 2;

347 
c1
 = (
b
->
d©a
[
i
] << 4) & 0x3F;

348 ià(
	`bcÚch¬
 (
out
, 
b64ETabË
[
c0
]) < 0 ||

349 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c1
]) < 0 ||

350 
	`bcÚch¬
 (
out
, () '=') < 0 ||

351 
	`bcÚch¬
 (
out
, () '=') < 0) {

352 
	`bde¡roy
 (
out
);

353  
NULL
;

359  
out
;

360 
	}
}

362 
	#B64_PAD
 (-2)

	)

363 
	#B64_ERR
 (-1)

	)

365 
	$ba£64DecodeSymbŞ
 (
®pha
) {

366 ià((
®pha
 >= 'A') && (alpha <= 'Z'))  ()(alpha - 'A');

367 ià((
®pha
 >= 'a') && (alpha <= 'z'))

368  26 + ()(
®pha
 - 'a');

369 ià((
®pha
 >= '0') && (alpha <= '9'))

370  52 + ()(
®pha
 - '0');

371 ià(
®pha
 == '+')  62;

372 ià(
®pha
 == '/')  63;

373 ià(
®pha
 =ğ'='è 
B64_PAD
;

374  
B64_ERR
;

375 
	}
}

382 
b¡ršg
 
	$bBa£64DecodeEx
 (
cÚ¡_b¡ršg
 
b
, * 
boŞTruncE¼Ü
) {

383 
i
, 
v
;

384 
c0
, 
c1
, 
c2
;

385 
b¡ršg
 
out
;

387 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

388 ià(
boŞTruncE¼Ü
) *boolTruncError = 0;

389 
out
 = 
	`bäomc¡r
 ("");

390 
i
 = 0;

393 ià(
i
 >ğ
b
->
¦’
è 
out
;

394 ià(
b
->
d©a
[
i
] == '=') {

395 ià(
boŞTruncE¼Ü
) {

396 *
boŞTruncE¼Ü
 = 1;

397  
out
;

399 
	`bde¡roy
 (
out
);

400  
NULL
;

402 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

403 
i
++;

404 } 
v
 < 0);

405 
c0
 = (è(
v
 << 2);

407 ià(
i
 >ğ
b
->
¦’
 || b->
d©a
[i] == '=') {

408 ià(
boŞTruncE¼Ü
) {

409 *
boŞTruncE¼Ü
 = 1;

410  
out
;

412 
	`bde¡roy
 (
out
);

413  
NULL
;

415 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

416 
i
++;

417 } 
v
 < 0);

418 
c0
 |ğ(è(
v
 >> 4);

419 
c1
 = (è(
v
 << 4);

421 ià(
i
 >ğ
b
->
¦’
) {

422 ià(
boŞTruncE¼Ü
) {

423 *
boŞTruncE¼Ü
 = 1;

424  
out
;

426 
	`bde¡roy
 (
out
);

427  
NULL
;

429 ià(
b
->
d©a
[
i
] == '=') {

430 
i
++;

431 ià(
i
 >ğ
b
->
¦’
 || b->
d©a
[i] !ğ'=' || 
	`bcÚch¬
 (
out
, 
c0
) < 0) {

432 ià(
boŞTruncE¼Ü
) {

433 *
boŞTruncE¼Ü
 = 1;

434  
out
;

436 
	`bde¡roy
 (
out
);

437  
NULL
;

439  
out
;

441 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

442 
i
++;

443 } 
v
 < 0);

444 
c1
 |ğ(è(
v
 >> 2);

445 
c2
 = (è(
v
 << 6);

447 ià(
i
 >ğ
b
->
¦’
) {

448 ià(
boŞTruncE¼Ü
) {

449 *
boŞTruncE¼Ü
 = 1;

450  
out
;

452 
	`bde¡roy
 (
out
);

453  
NULL
;

455 ià(
b
->
d©a
[
i
] == '=') {

456 ià(
	`bcÚch¬
 (
out
, 
c0
è< 0 || bcÚch¬ (out, 
c1
) < 0) {

457 ià(
boŞTruncE¼Ü
) {

458 *
boŞTruncE¼Ü
 = 1;

459  
out
;

461 
	`bde¡roy
 (
out
);

462  
NULL
;

464 ià(
boŞTruncE¼Ü
) *boolTruncError = 0;

465  
out
;

467 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

468 
i
++;

469 } 
v
 < 0);

470 
c2
 |ğ(è(
v
);

471 ià(
	`bcÚch¬
 (
out
, 
c0
) < 0 ||

472 
	`bcÚch¬
 (
out
, 
c1
) < 0 ||

473 
	`bcÚch¬
 (
out
, 
c2
) < 0) {

474 ià(
boŞTruncE¼Ü
) {

475 *
boŞTruncE¼Ü
 = -1;

476  
out
;

478 
	`bde¡roy
 (
out
);

479  
NULL
;

482 
	}
}

484 
	#UU_DECODE_BYTE
(
b
è(((bè=ğ(sigÃd )'`'è? 0 : (bè- (sigÃd )' ')

	)

486 
	sbUuInOut
 {

487 
b¡ršg
 
	m¤c
, 
	md¡
;

488 * 
	mbadlšes
;

491 
	#UU_MAX_LINELEN
 45

	)

493 
	$bUuDecLše
 (* 
·rm
, 
ofs
, 
Ën
) {

494 
bUuInOut
 * 
io
 = (bUuInOuˆ*è
·rm
;

495 
b¡ršg
 
s
 = 
io
->
¤c
;

496 
b¡ršg
 
t
 = 
io
->
d¡
;

497 
i
, 
Î’
, 
ÙËn
, 
»t
, 
c0
, 
c1
, 
c2
, 
c3
, 
d0
, 
d1
, 
d2
, 
d3
;

499 ià(
Ën
 == 0)  0;

500 
Î’
 = 
	`UU_DECODE_BYTE
 (
s
->
d©a
[
ofs
]);

501 
»t
 = 0;

503 
ÙËn
 = 
t
->
¦’
;

505 ià(((è
Î’
è> 
UU_MAX_LINELEN
è{ 
»t
 = -
__LINE__
;

506 
bl
;

509 
Î’
 +ğ
t
->
¦’
;

511 
i
=1; i < 
s
->
¦’
 && 
t
->¦’ < 
Î’
;i += 4) {

512 
outoù‘
[3];

513 
c0
 = 
	`UU_DECODE_BYTE
 (
d0
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+0, ' ' - 1));

514 
c1
 = 
	`UU_DECODE_BYTE
 (
d1
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+1, ' ' - 1));

515 
c2
 = 
	`UU_DECODE_BYTE
 (
d2
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+2, ' ' - 1));

516 
c3
 = 
	`UU_DECODE_BYTE
 (
d3
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+3, ' ' - 1));

518 ià(((è(
c0
|
c1
è>ğ0x40)è{ ià(!
»t
è»ˆğ-
__LINE__
;

519 ià(
d0
 > 0x60 || (d0 < (' ' - 1è&& !
	`is¥aû
 (d0)) ||

520 
d1
 > 0x60 || (d1 < (' ' - 1è&& !
	`is¥aû
 (d1))) {

521 
t
->
¦’
 = 
ÙËn
;

522 
bl
;

524 
c0
 = 
c1
 = 0;

526 
outoù‘
[0] = (è((
c0
 << 2è| ((è
c1
 >> 4));

527 ià(
t
->
¦’
+1 >ğ
Î’
) {

528 ià(0 > 
	`bcÚch¬
 (
t
, (è
outoù‘
[0])è -
__LINE__
;

531 ià((è
c2
 >ğ0x40è{ ià(!
»t
è»ˆğ-
__LINE__
;

532 ià(
d2
 > 0x60 || (d2 < (' ' - 1è&& !
	`is¥aû
 (d2))) {

533 
t
->
¦’
 = 
ÙËn
;

534 
bl
;

536 
c2
 = 0;

538 
outoù‘
[1] = (è((
c1
 << 4è| ((è
c2
 >> 2));

539 ià(
t
->
¦’
+2 >ğ
Î’
) {

540 ià(0 > 
	`bÿtblk
 (
t
, 
outoù‘
, 2)è -
__LINE__
;

543 ià((è
c3
 >ğ0x40è{ ià(!
»t
è»ˆğ-
__LINE__
;

544 ià(
d3
 > 0x60 || (d3 < (' ' - 1è&& !
	`is¥aû
 (d3))) {

545 
t
->
¦’
 = 
ÙËn
;

546 
bl
;

548 
c3
 = 0;

550 
outoù‘
[2] = (è((
c2
 << 6è| ((è
c3
));

551 ià(0 > 
	`bÿtblk
 (
t
, 
outoù‘
, 3)è -
__LINE__
;

553 ià(
t
->
¦’
 < 
Î’
è{ ià(0 =ğ
»t
è»ˆğ-
__LINE__
;

554 
t
->
¦’
 = 
ÙËn
;

556 
bl
:;

557 ià(
»t
 && 
io
->
badlšes
) {

558 (*
io
->
badlšes
)++;

561  
»t
;

562 
	}
}

574 #ifdeà
_MSC_VER


575 #´agm¨
w¬nšg
(
di§bË
:4204)

578 
b¡ršg
 
	$bUuDecodeEx
 (
cÚ¡_b¡ršg
 
¤c
, * 
badlšes
) {

579 
gb¡ršg
 
t
;

580 
bSŒ—m
 * 
s
;

581 
bSŒ—m
 * 
d
;

582 
b¡ršg
 
b
;

584 ià(!
¤c
è 
NULL
;

585 
t
 = *
¤c
;

586 
s
 = 
	`bsFromB¡rRef
 (&
t
);

587 ià(!
s
è 
NULL
;

588 
d
 = 
	`bsUuDecode
 (
s
, 
badlšes
);

589 
b
 = 
	`bäomc¡¿Îoc
 (256, "");

590 ià(
NULL
 =ğ
b
 || 0 > 
	`b¤—d
 (b, 
d
, 
INT_MAX
)) {

591 
	`bde¡roy
 (
b
);

592 
b
 = 
NULL
;

595 
	`bsşo£
(
d
);

596 
	`bsşo£
(
s
);

597  
b
;

598 
	}
}

600 
	sbsUuCtx
 {

601 
bUuInOut
 
	mio
;

602 
bSŒ—m
 * 
	msIÅ
;

605 
size_t
 
	$bsUuDecodeP¬t
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

606 
gb¡ršg
 
eŞ
 = 
	`bsStic
 ("\r\n");

607 
bsUuCtx
 * 
luuCtx
 = (bsUuCtx *è
·rm
;

608 
size_t
 
tsz
;

609 
l
, 
Ì‘
;

611 ià(
NULL
 =ğ
buff
 || NULL =ğ
·rm
)  0;

612 
tsz
 = 
–size
 * 
ÃËm
;

614 
CheckIÁ”ÇlBufãr
:;

616 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
è> 
tsz
) {

617 
	`memıy
 (
buff
, 
luuCtx
->
io
.
d¡
->
d©a
, 
tsz
);

618 
	`bd–‘e
 (
luuCtx
->
io
.
d¡
, 0, (è
tsz
);

619  
ÃËm
;

622 
DecodeMÜe
:;

623 ià(0 <ğ(
l
 = 
	`bšchr
 (
luuCtx
->
io
.
¤c
, 0, &
eŞ
))) {

624 
Ş
 = 0;

625 
gb¡ršg
 
t
;

626 
b¡ršg
 
s
 = 
luuCtx
->
io
.
¤c
;

627 
luuCtx
->
io
.
¤c
 = &
t
;

630 ià(
l
 > 
Ş
) {

631 
	`bmid2tb¡r
 (
t
, 
s
, 
Ş
, 
l
 - ol);

632 
Ì‘
 = 
	`bUuDecLše
 (&
luuCtx
->
io
, 0, 
t
.
¦’
);

633 ià(0 > 
Ì‘
) {

634 
luuCtx
->
io
.
¤c
 = 
s
;

635 
DÚe
;

638 
Ş
 = 
l
 + 1;

639 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
è> 
tsz
) ;

640 
l
 = 
	`bšchr
 (
s
, 
Ş
, &
eŞ
);

641 } 
BSTR_ERR
 !ğ
l
);

642 
	`bd–‘e
 (
s
, 0, 
Ş
);

643 
luuCtx
->
io
.
¤c
 = 
s
;

644 
CheckIÁ”ÇlBufãr
;

647 ià(
BSTR_ERR
 !ğ
	`b¤—da
 (
luuCtx
->
io
.
¤c
,†uuCtx->
sIÅ
, 
	`bsbufæ’gth
 (luuCtx->sIÅ, 
BSTR_BS_BUFF_LENGTH_GET
))) {

648 
DecodeMÜe
;

651 
	`bUuDecLše
 (&
luuCtx
->
io
, 0,†uuCtx->io.
¤c
->
¦’
);

653 
DÚe
:;

655 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
) > 0) {

656 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
è> 
tsz
è
CheckIÁ”ÇlBufãr
;

657 
	`memıy
 (
buff
, 
luuCtx
->
io
.
d¡
->
d©a
,†uuCtx->io.d¡->
¦’
);

658 
tsz
 = 
luuCtx
->
io
.
d¡
->
¦’
 / 
–size
;

659 
luuCtx
->
io
.
d¡
->
¦’
 = 0;

660 ià(
tsz
 > 0) sz;

664 
	`bde¡roy
 (
luuCtx
->
io
.
d¡
);

665 
	`bde¡roy
 (
luuCtx
->
io
.
¤c
);

666 
	`ä“
 (
luuCtx
);

668 
	}
}

680 
bSŒ—m
 * 
	$bsUuDecode
 (
bSŒ—m
 * 
sIÅ
, * 
badlšes
) {

681 
bsUuCtx
 * 
luuCtx
 = (bsUuCtx *è
	`m®loc
 ( (bsUuCtx));

682 
bSŒ—m
 * 
sOut
;

684 ià(
NULL
 =ğ
luuCtx
)  NULL;

686 
luuCtx
->
io
.
¤c
 = 
	`bäomc¡r
 ("");

687 
luuCtx
->
io
.
d¡
 = 
	`bäomc¡r
 ("");

688 ià(
NULL
 =ğ
luuCtx
->
io
.
d¡
 || NULL =ğluuCtx->io.
¤c
) {

689 
CËªUpFau»ToAÎoÿ‹
:;

690 
	`bde¡roy
 (
luuCtx
->
io
.
d¡
);

691 
	`bde¡roy
 (
luuCtx
->
io
.
¤c
);

692 
	`ä“
 (
luuCtx
);

693  
NULL
;

695 
luuCtx
->
io
.
badlšes
 = badlines;

696 ià(
badlšes
) *badlines = 0;

698 
luuCtx
->
sIÅ
 = sInp;

700 
sOut
 = 
	`bsİ’
 ((
bN»ad
è
bsUuDecodeP¬t
, 
luuCtx
);

701 ià(
NULL
 =ğ
sOut
è
CËªUpFau»ToAÎoÿ‹
;

702  
sOut
;

703 
	}
}

705 
	#UU_ENCODE_BYTE
(
b
è(è(((bè=ğ0è? '`' : ((bè+ ' '))

	)

712 
b¡ršg
 
	$bUuEncode
 (
cÚ¡_b¡ršg
 
¤c
) {

713 
b¡ršg
 
out
;

714 
i
, 
j
, 
jm
;

715 
c0
, 
c1
, 
c2
;

716 ià(
¤c
 =ğ
NULL
 || src->
¦’
 < 0 || src->
d©a
 == NULL)  NULL;

717 ià((
out
 = 
	`bäomc¡r
 ("")è=ğ
NULL
)  NULL;

718 
i
=0; i < 
¤c
->
¦’
; i +ğ
UU_MAX_LINELEN
) {

719 ià((
jm
 = 
i
 + 
UU_MAX_LINELEN
è> 
¤c
->
¦’
) jm = src->slen;

720 ià(
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 (
jm
 - 
i
)) < 0) {

721 
	`b¡rF»e
 (
out
);

724 
j
 = 
i
; j < 
jm
; j += 3) {

725 
c0
 = (è
	`bch¬
 (
¤c
, 
j
 );

726 
c1
 = (è
	`bch¬
 (
¤c
, 
j
 + 1);

727 
c2
 = (è
	`bch¬
 (
¤c
, 
j
 + 2);

728 ià(
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 ( (
c0
 & 0xFC) >> 2)) < 0 ||

729 
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 (((
c0
 & 0x03è<< 4è| ((
c1
 & 0xF0) >> 4))) < 0 ||

730 
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 (((
c1
 & 0x0Fè<< 2è| ((
c2
 & 0xC0) >> 6))) < 0 ||

731 
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 ( (
c2
 & 0x3F))) < 0) {

732 
	`b¡rF»e
 (
out
);

733 
End
;

736 ià(
	`bcÚch¬
 (
out
, () '\r') < 0 || bconchar (out, () '\n') < 0) {

737 
	`b¡rF»e
 (
out
);

741 
End
:;

742  
out
;

743 
	}
}

751 
b¡ršg
 
	$bYEncode
 (
cÚ¡_b¡ršg
 
¤c
) {

752 
i
;

753 
b¡ršg
 
out
;

754 
c
;

756 ià(
¤c
 =ğ
NULL
 || src->
¦’
 < 0 || src->
d©a
 == NULL)  NULL;

757 ià((
out
 = 
	`bäomc¡r
 ("")è=ğ
NULL
)  NULL;

758 
i
=0; i < 
¤c
->
¦’
; i++) {

759 
c
 = ()(
¤c
->
d©a
[
i
] + 42);

760 ià(
c
 == '=' || c == '\0' || c == '\r' || c == '\n') {

761 ià(0 > 
	`bcÚch¬
 (
out
, () '=')) {

762 
	`bde¡roy
 (
out
);

763  
NULL
;

765 
c
 += () 64;

767 ià(0 > 
	`bcÚch¬
 (
out
, 
c
)) {

768 
	`bde¡roy
 (
out
);

769  
NULL
;

772  
out
;

773 
	}
}

780 
	#MAX_OB_LEN
 (64)

	)

782 
b¡ršg
 
	$bYDecode
 (
cÚ¡_b¡ršg
 
¤c
) {

783 
i
;

784 
b¡ršg
 
out
;

785 
c
;

786 
où‘buff
[
MAX_OB_LEN
];

787 
obl
;

789 ià(
¤c
 =ğ
NULL
 || src->
¦’
 < 0 || src->
d©a
 == NULL)  NULL;

790 ià((
out
 = 
	`bäomc¡r
 ("")è=ğ
NULL
)  NULL;

792 
obl
 = 0;

794 
i
=0; i < 
¤c
->
¦’
; i++) {

795 ià('=' =ğ(
c
 = 
¤c
->
d©a
[
i
])) {

796 
i
++;

797 ià(
i
 >ğ
¤c
->
¦’
) {

798 
	`bde¡roy
 (
out
);

799  
NULL
;

801 
c
 = (è(
¤c
->
d©a
[
i
] - 64);

803 ià('\0' =ğ
c
) {

804 
	`bde¡roy
 (
out
);

805  
NULL
;

809 ià(
c
 == '\r' || c == '\n') ;

812 
où‘buff
[
obl
] = (è((è
c
 - 42);

813 
obl
++;

815 ià(
obl
 >ğ
MAX_OB_LEN
) {

816 ià(0 > 
	`bÿtblk
 (
out
, 
où‘buff
, 
obl
)) {

817 
	`bde¡roy
 (
out
);

818  
NULL
;

820 
obl
 = 0;

824 ià(0 > 
	`bÿtblk
 (
out
, 
où‘buff
, 
obl
)) {

825 
	`bde¡roy
 (
out
);

826 
out
 = 
NULL
;

828  
out
;

829 
	}
}

838 
b¡ršg
 
	$bSŒfTime
 (cÚ¡ * 
fmt
, cÚ¡ 
tm
 * 
tim•Œ
) {

839 #ià
	`defšed
 (
__TURBOC__
è&& !defšed (
__BORLANDC__
)

840 
gb¡ršg
 
ns
 = 
	`bsStic
 ("bStrfTime Not supported");

841 
fmt
 = fmt;

842 
tim•Œ
 =imeptr;

843  &
ns
;

845 
b¡ršg
 
buff
;

846 
n
;

847 
size_t
 
r
;

849 ià(
fmt
 =ğ
NULL
)  NULL;

855 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))) < 16)‚ = 16;

856 
buff
 = 
	`bäomc¡¿Îoc
 (
n
+2, "");

859 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

860 
	`bde¡roy
 (
buff
);

861  
NULL
;

864 
r
 = 
	`¡ráime
 ((*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
tim•Œ
);

866 ià(
r
 > 0) {

867 
buff
->
¦’
 = (è
r
;

871 
n
 +=‚;

874  
buff
;

876 
	}
}

886 
	$bS‘C¡rCh¬
 (
b¡ršg
 
b
, 
pos
, 
c
) {

887 ià(
NULL
 =ğ
b
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen)

888  
BSTR_ERR
;

889 ià(
pos
 < 0 ||…o > 
b
->
¦’
è 
BSTR_ERR
;

891 ià(
pos
 =ğ
b
->
¦’
) {

892 ià('\0' !ğ
c
è 
	`bcÚch¬
 (
b
, c);

896 
b
->
d©a
[
pos
] = (è
c
;

897 ià('\0' =ğ
c
è
b
->
¦’
 = 
pos
;

900 
	}
}

909 
	$bS‘Ch¬
 (
b¡ršg
 
b
, 
pos
, 
c
) {

910 ià(
NULL
 =ğ
b
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen)

911  
BSTR_ERR
;

912 ià(
pos
 < 0 ||…o > 
b
->
¦’
è 
BSTR_ERR
;

914 ià(
pos
 =ğ
b
->
¦’
) {

915  
	`bcÚch¬
 (
b
, 
c
);

918 
b
->
d©a
[
pos
] = (è
c
;

920 
	}
}

922 
	#INIT_SECURE_INPUT_LENGTH
 (256)

	)

925 
	#BWS_BUFF_SZ
 (1024)

	)

927 
	sbwr™eSŒ—m
 {

928 
b¡ršg
 
	mbuff
;

929 * 
	m·rm
;

930 
bNwr™e
 
	mwr™eFn
;

931 
	misEOF
;

932 
	mmšBuffSz
;

941 
bwr™eSŒ—m
 * 
	$bwsO³n
 (
bNwr™e
 
wr™eFn
, * 
·rm
) {

942 
bwr™eSŒ—m
 * 
ws
;

944 ià(
NULL
 =ğ
wr™eFn
)  NULL;

945 
ws
 = (
bwr™eSŒ—m
 *è
	`m®loc
 ( (bwriteStream));

946 ià(
ws
) {

947 ià(
NULL
 =ğ(
ws
->
buff
 = 
	`bäomc¡r
 (""))) {

948 
	`ä“
 (
ws
);

949 
ws
 = 
NULL
;

951 
ws
->
·rm
 =…arm;

952 
ws
->
wr™eFn
 = writeFn;

953 
ws
->
isEOF
 = 0;

954 
ws
->
mšBuffSz
 = 
BWS_BUFF_SZ
;

957  
ws
;

958 
	}
}

960 
	#š‹º®_bwswr™eout
(
ws
,
b
è{ \

	)

961 ià((
	gb
)->
	g¦’
 > 0) { \

962 ià(1 !ğ(
ws
->
wr™eFn
 ((
b
)->
d©a
, (b)->
¦’
, 1, ws->
·rm
))) { \

963 
	gws
->
	gisEOF
 = 1; \

964  
	gBSTR_ERR
; \

973 
	$bwsWr™eFlush
 (
bwr™eSŒ—m
 * 
ws
) {

974 ià(
NULL
 =ğ
ws
 || ws->
isEOF
 || 0 >ğws->
mšBuffSz
 ||

975 
NULL
 =ğ
ws
->
wr™eFn
 || NULL =ğws->
buff
è 
BSTR_ERR
;

976 
	`š‹º®_bwswr™eout
 (
ws
, ws->
buff
);

977 
ws
->
buff
->
¦’
 = 0;

979 
	}
}

987 
	$bwsWr™eB¡r
 (
bwr™eSŒ—m
 * 
ws
, 
cÚ¡_b¡ršg
 
b
) {

988 
gb¡ršg
 
t
;

989 
l
;

991 ià(
NULL
 =ğ
ws
 || NULL =ğ
b
 || NULL =ğws->
buff
 ||

992 
ws
->
isEOF
 || 0 >ğws->
mšBuffSz
 || 
NULL
 =ğws->
wr™eFn
)

993  
BSTR_ERR
;

996 ià(
b
->
¦’
 > 0 && 
ws
->
buff
->
mËn
 - ws->buff->slen > b->slen) {

997 
gb¡ršg
 
em±y
 = 
	`bsStic
 ("");

998 ià(0 > 
	`bcÚÿt
 (
ws
->
buff
, 
b
)è 
BSTR_ERR
;

999  
	`bwsWr™eB¡r
 (
ws
, &
em±y
);

1002 ià(0 > (
l
 = 
ws
->
mšBuffSz
 - ws->
buff
->
¦’
)) {

1003 
	`š‹º®_bwswr™eout
 (
ws
, ws->
buff
);

1004 
ws
->
buff
->
¦’
 = 0;

1005 
l
 = 
ws
->
mšBuffSz
;

1008 ià(
b
->
¦’
 < 
l
è 
	`bcÚÿt
 (
ws
->
buff
, b);

1010 ià(0 > 
	`bÿtblk
 (
ws
->
buff
, 
b
->
d©a
, 
l
)è 
BSTR_ERR
;

1011 
	`š‹º®_bwswr™eout
 (
ws
, ws->
buff
);

1012 
ws
->
buff
->
¦’
 = 0;

1014 
	`bmid2tb¡r
 (
t
, (
b¡ršg
è
b
, 
l
, b->
¦’
);

1016 ià(
t
.
¦’
 >ğ
ws
->
mšBuffSz
) {

1017 
	`š‹º®_bwswr™eout
 (
ws
, &
t
);

1021  
	`bassign
 (
ws
->
buff
, &
t
);

1022 
	}
}

1029 
	$bwsWr™eBlk
 (
bwr™eSŒ—m
 * 
ws
, * 
blk
, 
Ën
) {

1030 
gb¡ršg
 
t
;

1031 ià(
NULL
 =ğ
blk
 || 
Ën
 < 0è 
BSTR_ERR
;

1032 
	`blk2tb¡r
 (
t
, 
blk
, 
Ën
);

1033  
	`bwsWr™eB¡r
 (
ws
, &
t
);

1034 
	}
}

1041 
	$bwsIsEOF
 (cÚ¡ 
bwr™eSŒ—m
 * 
ws
) {

1042 ià(
NULL
 =ğ
ws
 || NULL =ğws->
buff
 || 0 > ws->
mšBuffSz
 ||

1043 
NULL
 =ğ
ws
->
wr™eFn
è 
BSTR_ERR
;

1044  
ws
->
isEOF
;

1045 
	}
}

1052 
	$bwsBuffL’gth
 (
bwr™eSŒ—m
 * 
ws
, 
sz
) {

1053 
ŞdSz
;

1054 ià(
ws
 =ğ
NULL
 || 
sz
 < 0è 
BSTR_ERR
;

1055 
ŞdSz
 = 
ws
->
mšBuffSz
;

1056 ià(
sz
 > 0è
ws
->
mšBuffSz
 = sz;

1057  
ŞdSz
;

1058 
	}
}

1066 * 
	$bwsClo£
 (
bwr™eSŒ—m
 * 
ws
) {

1067 * 
·rm
;

1068 ià(
NULL
 =ğ
ws
 || NULL =ğws->
buff
 || 0 >ğws->
mšBuffSz
 ||

1069 
NULL
 =ğ
ws
->
wr™eFn
)  NULL;

1070 
	`bwsWr™eFlush
 (
ws
);

1071 
·rm
 = 
ws
->parm;

1072 
ws
->
·rm
 = 
NULL
;

1073 
ws
->
mšBuffSz
 = -1;

1074 
ws
->
wr™eFn
 = 
NULL
;

1075 
	`b¡rF»e
 (
ws
->
buff
);

1076 
	`ä“
 (
ws
);

1077  
·rm
;

1078 
	}
}

1082 cÚ¡ 
	gFNV_PRIME
 = 16777619;

1083 cÚ¡ 
	gFNV_OFFSET_BASIS
 = 2166136261;

1086 
ušt32_t
 
	$b¡r_hash_fun
(cÚ¡ *
kv
)

1088 
b¡ršg
 
key
 = (b¡ršg)
kv
;

1089 cÚ¡ *
¡r
 = (cÚ¡ *)
	`bd©a
(
key
);

1091 
ušt32_t
 
acc
 = 
FNV_OFFSET_BASIS
;

1093 *
¡r
) {

1094 
acc
 ^ğ*
¡r
;

1095 
acc
 *ğ
FNV_PRIME
;

1096 
¡r
++;

1099  
acc
;

1100 
	}
}

	@src/bstr/bstraux.h

16 #iâdeà
BSTRAUX_INCLUDE


17 
	#BSTRAUX_INCLUDE


	)

19 
	~<¡dšt.h
>

20 
	~<time.h
>

21 
	~"b¡¾ib.h
"

23 #ifdeà
__ılu¥lus


28 
	#b¡rDeş¬e
(
b
è
	`b¡ršg
 (bèğ
NULL
;

	)

29 
	#b¡rF»e
(
b
è{ià((bè!ğ
NULL
 && (b)->
¦’
 >ğ0 && (b)->
mËn
 >ğ(b)->¦’è{ 
	`bde¡roy
 (b); (bèğNULL; }}

	)

32 
	#bAssign
(
a
,
b
è((
bassign
)(×), (b)))

	)

33 
	#bSubs
(
b
,
pos
,
Ën
,
a
,
c
è((
b»¶aû
)((b),Õos),Ö’),×),()(c)))

	)

34 
	#bSŒchr
(
b
,
c
è((
b¡rchr
)((b), (c)))

	)

35 
	#bSŒchrFa¡
(
b
,
c
è((
b¡rchr
)((b), (c)))

	)

36 
	#bC©C¡r
(
b
,
s
è((
bÿtc¡r
)((b), (s)))

	)

37 
	#bC©Blk
(
b
,
s
,
Ën
è((
bÿtblk
)((b),(s),Ö’)))

	)

38 
	#bC©Stic
(
b
,
s
è
	`bC©Blk
 ((b), ("" s ""),  (sè- 1)

	)

39 
	#bTrunc
(
b
,
n
è((
bŒunc
)((b), (n)))

	)

40 
	#bR•ÏûAÎ
(
b
,
fšd
,
»¶
,
pos
è((
bfšd»¶aû
)((b),(fšd),Ô•l),Õos)))

	)

41 
	#bUµ”ÿ£
(
b
è((
btouµ”
)(b))

	)

42 
	#bLow”ÿ£
(
b
è((
btŞow”
)(b))

	)

43 
	#bCa£ËssCmp
(
a
,
b
è((
b¡ricmp
)(×), (b)))

	)

44 
	#bCa£ËssNCmp
(
a
,
b
,
n
è((
b¡ºicmp
)(×), (b), (n)))

	)

45 
	#bBa£64Decode
(
b
è(
	`bBa£64DecodeEx
 ((b), 
NULL
))

	)

46 
	#bUuDecode
(
b
è(
	`bUuDecodeEx
 ((b), 
NULL
))

	)

49 
bSŒ—m
 * 
bsFromB¡r
 (
cÚ¡_b¡ršg
 
b
);

50 
b¡ršg
 
bTa
 (b¡ršg 
b
, 
n
);

51 
b¡ršg
 
bH—d
 (b¡ršg 
b
, 
n
);

52 
bS‘C¡rCh¬
 (
b¡ršg
 
a
, 
pos
, 
c
);

53 
bS‘Ch¬
 (
b¡ršg
 
b
, 
pos
, 
c
);

54 
bFl
 (
b¡ršg
 
a
, 
c
, 
Ën
);

55 
bR•liÿ‹
 (
b¡ršg
 
b
, 
n
);

56 
bRev”£
 (
b¡ršg
 
b
);

57 
bIn£¹Chrs
 (
b¡ršg
 
b
, 
pos
, 
Ën
, 
c
, 
fl
);

58 
b¡ršg
 
bSŒfTime
 (cÚ¡ * 
fmt
, cÚ¡ 
tm
 * 
tim•Œ
);

59 
	#bAscTime
(
t
è(
	`bSŒfTime
 ("%c\n", (t)))

	)

60 
	#bCTime
(
t
è(Ñè? 
	`bAscTime
 (
	`loÿÉime
 (t)è: 
NULL
)

	)

63 
bJu¡ifyLeá
 (
b¡ršg
 
b
, 
¥aû
);

64 
bJu¡ifyRight
 (
b¡ršg
 
b
, 
width
, 
¥aû
);

65 
bJu¡ifyM¬gš
 (
b¡ršg
 
b
, 
width
, 
¥aû
);

66 
bJu¡ifyC’‹r
 (
b¡ršg
 
b
, 
width
, 
¥aû
);

69 
ušt32_t
 
b¡r_hash_fun
(cÚ¡ *
kv
);

72 * 
bSŒ2N‘SŒ
 (
cÚ¡_b¡ršg
 
b
);

73 
b¡ršg
 
bN‘SŒ2B¡r
 (cÚ¡ * 
buf
);

74 
b¡ršg
 
bBa£64Encode
 (
cÚ¡_b¡ršg
 
b
);

75 
b¡ršg
 
bBa£64DecodeEx
 (
cÚ¡_b¡ršg
 
b
, * 
boŞTruncE¼Ü
);

76 
bSŒ—m
 * 
bsUuDecode
 (bSŒ—m * 
sIÅ
, * 
badlšes
);

77 
b¡ršg
 
bUuDecodeEx
 (
cÚ¡_b¡ršg
 
¤c
, * 
badlšes
);

78 
b¡ršg
 
bUuEncode
 (
cÚ¡_b¡ršg
 
¤c
);

79 
b¡ršg
 
bYEncode
 (
cÚ¡_b¡ršg
 
¤c
);

80 
b¡ršg
 
bYDecode
 (
cÚ¡_b¡ršg
 
¤c
);

83 (* 
	gbNwr™e
è(cÚ¡ * 
	tbuf
, 
	tsize_t
 
	t–size
, size_ˆ
	tÃËm
, * 
	t·rm
);

85 
bwr™eSŒ—m
 * 
bwsO³n
 (
bNwr™e
 
wr™eFn
, * 
·rm
);

86 
bwsWr™eB¡r
 (
bwr™eSŒ—m
 * 
¡»am
, 
cÚ¡_b¡ršg
 
b
);

87 
bwsWr™eBlk
 (
bwr™eSŒ—m
 * 
¡»am
, * 
blk
, 
Ën
);

88 
bwsWr™eFlush
 (
bwr™eSŒ—m
 * 
¡»am
);

89 
bwsIsEOF
 (cÚ¡ 
bwr™eSŒ—m
 * 
¡»am
);

90 
bwsBuffL’gth
 (
bwr™eSŒ—m
 * 
¡»am
, 
sz
);

91 * 
bwsClo£
 (
bwr™eSŒ—m
 * 
¡»am
);

94 
	#bSecu»De¡roy
(
b
è{ \

	)

95 
b¡ršg
 
	gb¡r__tmp
 = (
b
); \

96 ià(
	gb¡r__tmp
 && b¡r__tmp->
	gmËn
 > 0 && b¡r__tmp->
	gd©a
) { \

97 (è
mem£t
 (
b¡r__tmp
->
d©a
, 0, (
size_t
èb¡r__tmp->
mËn
); \

98 
bde¡roy
 (
b¡r__tmp
); \

101 
	#bSecu»Wr™ePrÙeù
(
t
è{ \

	)

102 ià((
	gt
).
	gmËn
 >= 0) { \

103 ià((
t
).
mËn
 > (t).
¦’
)) { \

104 (è
mem£t
 ((
t
).
d©a
 + (t).
¦’
, 0, (
size_t
èÑ).
mËn
 - (t).slen); \

106 (
	gt
).
	gmËn
 = -1; \

110 #ifdeà
__ılu¥lus


	@src/bstr/bstrlib.c

14 #ià
defšed
 (
_MSC_VER
)

16 
	#_CRT_SECURE_NO_WARNINGS


	)

19 
	~<¡dio.h
>

20 
	~<¡ddef.h
>

21 
	~<¡d¬g.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<ùy³.h
>

25 
	~"b¡¾ib.h
"

29 #ià
defšed
(
MEMORY_DEBUG
è|| defšed(
BSTRLIB_MEMORY_DEBUG
)

30 
	~"memdbg.h
"

33 #iâdeà
b¡r__®loc


34 
	#b¡r__®loc
(
x
è
	`m®loc
 (x)

	)

37 #iâdeà
b¡r__ä“


38 
	#b¡r__ä“
(
p
è
	`ä“
 (p)

	)

41 #iâdeà
b¡r__»®loc


42 
	#b¡r__»®loc
(
p
,
x
è
	`»®loc
 (Õ), (x))

	)

45 #iâdeà
b¡r__memıy


46 
	#b¡r__memıy
(
d
,
s
,
l
è
	`memıy
 ((d), (s), (l))

	)

49 #iâdeà
b¡r__memmove


50 
	#b¡r__memmove
(
d
,
s
,
l
è
	`memmove
 ((d), (s), (l))

	)

53 #iâdeà
b¡r__mem£t


54 
	#b¡r__mem£t
(
d
,
c
,
l
è
	`mem£t
 ((d), (c), (l))

	)

57 #iâdeà
b¡r__memcmp


58 
	#b¡r__memcmp
(
d
,
c
,
l
è
	`memcmp
 ((d), (c), (l))

	)

61 #iâdeà
b¡r__memchr


62 
	#b¡r__memchr
(
s
,
c
,
l
è
	`memchr
 ((s), (c), (l))

	)

67 
	#bBlockCİy
(
D
,
S
,
L
è{ ià((Lè> 0è
	`b¡r__memmove
 ((D),(S),(L)); }

	)

71 
	$¢­UpSize
 (
i
) {

72 ià(
i
 < 8) {

73 
i
 = 8;

75 
j
;

76 
j
 = (è
i
;

78 
j
 |= (j >> 1);

79 
j
 |= (j >> 2);

80 
j
 |= (j >> 4);

81 
j
 |= (j >> 8);

82 #ià(
UINT_MAX
 != 0xffff)

83 
j
 |= (j >> 16);

84 #ià(
UINT_MAX
 > 0xffffffffUL)

85 
j
 |= (j >> 32);

89 
j
++;

90 ià((è
j
 >ğ
i
) i = () j;

92  
i
;

93 
	}
}

99 
	$b®loc
 (
b¡ršg
 
b
, 
Ş’
) {

100 
Ën
;

101 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 || b->
mËn
 <= 0 ||

102 
b
->
mËn
 < b->
¦’
 || 
Ş’
 <= 0) {

103  
BSTR_ERR
;

106 ià(
Ş’
 >ğ
b
->
mËn
) {

107 * 
x
;

109 ià((
Ën
 = 
	`¢­UpSize
 (
Ş’
)è<ğ
b
->
mËn
è 
BSTR_OK
;

112 ià(7 * 
b
->
mËn
 < 8 * b->
¦’
) {

117 
»®locSŒ©egy
:;

119 
x
 = (*è
	`b¡r__»®loc
 (
b
->
d©a
, (
size_t
è
Ën
);

120 ià(
x
 =ğ
NULL
) {

125 ià(
NULL
 =ğ(
x
 = (*è
	`b¡r__»®loc
 (
b
->
d©a
, (
size_t
è(
Ën
 = 
Ş’
)))) {

126  
BSTR_ERR
;

135 ià(
NULL
 =ğ(
x
 = (*è
	`b¡r__®loc
 ((
size_t
è
Ën
))) {

140 
»®locSŒ©egy
;

143 ià(
b
->
¦’
è
	`b¡r__memıy
 ((*è
x
, (*èb->
d©a
, (
size_t
) b->slen);

144 
	`b¡r__ä“
 (
b
->
d©a
);

147 
b
->
d©a
 = 
x
;

148 
b
->
mËn
 = 
Ën
;

149 
b
->
d©a
[b->
¦’
] = () '\0';

152  
BSTR_OK
;

153 
	}
}

161 
	$b®locmš
 (
b¡ršg
 
b
, 
Ën
) {

162 * 
s
;

164 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || (b->
¦’
+1è< 0 || b->
mËn
 <= 0 ||

165 
b
->
mËn
 < b->
¦’
 || 
Ën
 <= 0) {

166  
BSTR_ERR
;

169 ià(
Ën
 < 
b
->
¦’
 + 1)†en = b->slen + 1;

171 ià(
Ën
 !ğ
b
->
mËn
) {

172 
s
 = (*è
	`b¡r__»®loc
 (
b
->
d©a
, (
size_t
è
Ën
);

173 ià(
NULL
 =ğ
s
è 
BSTR_ERR
;

174 
s
[
b
->
¦’
] = () '\0';

175 
b
->
d©a
 = 
s
;

176 
b
->
mËn
 = 
Ën
;

179  
BSTR_OK
;

180 
	}
}

187 
b¡ršg
 
	$bäomc¡r
 (cÚ¡ * 
¡r
) {

188 
b¡ršg
 
b
;

189 
i
;

190 
size_t
 
j
;

192 ià(
¡r
 =ğ
NULL
)  NULL;

193 
j
 = (
¡¾’
è(
¡r
);

194 
i
 = 
	`¢­UpSize
 ((è(
j
 + (2 - (j != 0))));

195 ià(
i
 <ğ(è
j
è 
NULL
;

197 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

198 ià(
NULL
 =ğ
b
)  NULL;

199 
b
->
¦’
 = (è
j
;

200 ià(
NULL
 =ğ(
b
->
d©a
 = (*è
	`b¡r__®loc
 (b->
mËn
 = 
i
))) {

201 
	`b¡r__ä“
 (
b
);

202  
NULL
;

205 
	`b¡r__memıy
 (
b
->
d©a
, 
¡r
, 
j
+1);

206  
b
;

207 
	}
}

215 
b¡ršg
 
	$bäomc¡¿Îoc
 (
mËn
, cÚ¡ * 
¡r
) {

216 
b¡ršg
 
b
;

217 
i
;

218 
size_t
 
j
;

220 ià(
¡r
 =ğ
NULL
)  NULL;

221 
j
 = (
¡¾’
è(
¡r
);

222 
i
 = 
	`¢­UpSize
 ((è(
j
 + (2 - (j != 0))));

223 ià(
i
 <ğ(è
j
è 
NULL
;

225 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

226 ià(
b
 =ğ
NULL
)  NULL;

227 
b
->
¦’
 = (è
j
;

228 ià(
i
 < 
mËn
) i = mlen;

230 ià(
NULL
 =ğ(
b
->
d©a
 = (*è
	`b¡r__®loc
 (b->
mËn
 = 
i
))) {

231 
	`b¡r__ä“
 (
b
);

232  
NULL
;

235 
	`b¡r__memıy
 (
b
->
d©a
, 
¡r
, 
j
+1);

236  
b
;

237 
	}
}

244 
b¡ršg
 
	$blk2b¡r
 (cÚ¡ * 
blk
, 
Ën
) {

245 
b¡ršg
 
b
;

246 
i
;

248 ià(
blk
 =ğ
NULL
 || 
Ën
 < 0)  NULL;

249 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

250 ià(
b
 =ğ
NULL
)  NULL;

251 
b
->
¦’
 = 
Ën
;

253 
i
 = 
Ën
 + (2 - (len != 0));

254 
i
 = 
	`¢­UpSize
 (i);

256 
b
->
mËn
 = 
i
;

258 
b
->
d©a
 = (*è
	`b¡r__®loc
 ((
size_t
èb->
mËn
);

259 ià(
b
->
d©a
 =ğ
NULL
) {

260 
	`b¡r__ä“
 (
b
);

261  
NULL
;

264 ià(
Ën
 > 0è
	`b¡r__memıy
 (
b
->
d©a
, 
blk
, (
size_t
)†en);

265 
b
->
d©a
[
Ën
] = () '\0';

267  
b
;

268 
	}
}

277 * 
	$b¡r2c¡r
 (
cÚ¡_b¡ršg
 
b
, 
z
) {

278 
i
, 
l
;

279 * 
r
;

281 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

282 
l
 = 
b
->
¦’
;

283 
r
 = (*è
	`b¡r__®loc
 ((
size_t
è(
l
 + 1));

284 ià(
r
 =ğ
NULL
) „;

286 
i
=0; i < 
l
; i ++) {

287 
r
[
i
] = (è((
b
->
d©a
[i] =ğ'\0'è? 
z
 : () (b->data[i]));

290 
r
[
l
] = () '\0';

292  
r
;

293 
	}
}

306 
	$bc¡rä“
 (* 
s
) {

307 ià(
s
) {

308 
	`b¡r__ä“
 (
s
);

309  
BSTR_OK
;

311  
BSTR_ERR
;

312 
	}
}

318 
	$bcÚÿt
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
) {

319 
Ën
, 
d
;

320 
b¡ršg
 
aux
 = (b¡ršgè
b1
;

322 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 =ğNULL || b1->d©¨=ğNULLè 
BSTR_ERR
;

324 
d
 = 
b0
->
¦’
;

325 
Ën
 = 
b1
->
¦’
;

326 ià((
d
 | (
b0
->
mËn
 - dè| 
Ën
 | (d +†’)è< 0è 
BSTR_ERR
;

328 ià(
b0
->
mËn
 <ğ
d
 + 
Ën
 + 1) {

329 
±rdiff_t
 
pd
 = 
b1
->
d©a
 - 
b0
->data;

330 ià(0 <ğ
pd
 &&…d < 
b0
->
mËn
) {

331 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b1
))è 
BSTR_ERR
;

333 ià(
	`b®loc
 (
b0
, 
d
 + 
Ën
 + 1è!ğ
BSTR_OK
) {

334 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

335  
BSTR_ERR
;

339 
	`bBlockCİy
 (&
b0
->
d©a
[
d
], &
aux
->d©a[0], (
size_t
è
Ën
);

340 
b0
->
d©a
[
d
 + 
Ën
] = () '\0';

341 
b0
->
¦’
 = 
d
 + 
Ën
;

342 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

343  
BSTR_OK
;

344 
	}
}

350 
	$bcÚch¬
 (
b¡ršg
 
b
, 
c
) {

351 
d
;

353 ià(
b
 =ğ
NULL
è 
BSTR_ERR
;

354 
d
 = 
b
->
¦’
;

355 ià((
d
 | (
b
->
mËn
 - d)è< 0 || 
	`b®loc
 (b, d + 2è!ğ
BSTR_OK
è 
BSTR_ERR
;

356 
b
->
d©a
[
d
] = (è
c
;

357 
b
->
d©a
[
d
 + 1] = () '\0';

358 
b
->
¦’
++;

359  
BSTR_OK
;

360 
	}
}

366 
	$bÿtc¡r
 (
b¡ršg
 
b
, cÚ¡ * 
s
) {

367 * 
d
;

368 
i
, 
l
;

370 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 || b->
mËn
 < b->slen

371 || 
b
->
mËn
 <ğ0 || 
s
 =ğ
NULL
è 
BSTR_ERR
;

374 
l
 = 
b
->
mËn
 - b->
¦’
;

375 
d
 = (*è&
b
->
d©a
[b->
¦’
];

376 
i
=0; i < 
l
; i++) {

377 ià((*
d
++ = *
s
++) == '\0') {

378 
b
->
¦’
 +ğ
i
;

379  
BSTR_OK
;

382 
b
->
¦’
 +ğ
i
;

385  
	`bÿtblk
 (
b
, (cÚ¡ *è
s
, (è
	`¡¾’
 (s));

386 
	}
}

392 
	$bÿtblk
 (
b¡ršg
 
b
, cÚ¡ * 
s
, 
Ën
) {

393 
Æ
;

395 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 || b->
mËn
 < b->slen

396 || 
b
->
mËn
 <ğ0 || 
s
 =ğ
NULL
 || 
Ën
 < 0è 
BSTR_ERR
;

398 ià(0 > (
Æ
 = 
b
->
¦’
 + 
Ën
)è 
BSTR_ERR
;

399 ià(
b
->
mËn
 <ğ
Æ
 && 0 > 
	`b®loc
 (b,‚È+ 1)è 
BSTR_ERR
;

401 
	`bBlockCİy
 (&
b
->
d©a
[b->
¦’
], 
s
, (
size_t
è
Ën
);

402 
b
->
¦’
 = 
Æ
;

403 
b
->
d©a
[
Æ
] = () '\0';

404  
BSTR_OK
;

405 
	}
}

411 
b¡ršg
 
	$b¡rıy
 (
cÚ¡_b¡ršg
 
b
) {

412 
b¡ršg
 
b0
;

413 
i
,
j
;

416 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

418 
b0
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

419 ià(
b0
 =ğ
NULL
) {

421  
NULL
;

424 
i
 = 
b
->
¦’
;

425 
j
 = 
	`¢­UpSize
 (
i
 + 1);

427 
b0
->
d©a
 = (*è
	`b¡r__®loc
 (
j
);

428 ià(
b0
->
d©a
 =ğ
NULL
) {

429 
j
 = 
i
 + 1;

430 
b0
->
d©a
 = (*è
	`b¡r__®loc
 (
j
);

431 ià(
b0
->
d©a
 =ğ
NULL
) {

433 
	`b¡r__ä“
 (
b0
);

434  
NULL
;

438 
b0
->
mËn
 = 
j
;

439 
b0
->
¦’
 = 
i
;

441 ià(
i
è
	`b¡r__memıy
 ((*è
b0
->
d©a
, (*è
b
->data, i);

442 
b0
->
d©a
[b0->
¦’
] = () '\0';

444  
b0
;

445 
	}
}

451 
	$bassign
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
) {

452 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0)

453  
BSTR_ERR
;

454 ià(
b
->
¦’
 != 0) {

455 ià(
	`b®loc
 (
a
, 
b
->
¦’
è!ğ
BSTR_OK
è 
BSTR_ERR
;

456 
	`b¡r__memmove
 (
a
->
d©a
, 
b
->d©a, b->
¦’
);

458 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

459 
a
->
¦’
 < 0 ||‡->
mËn
 == 0)

460  
BSTR_ERR
;

462 
a
->
d©a
[
b
->
¦’
] = () '\0';

463 
a
->
¦’
 = 
b
->slen;

464  
BSTR_OK
;

465 
	}
}

473 
	$bassignmid¡r
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
) {

474 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0)

475  
BSTR_ERR
;

477 ià(
Ëá
 < 0) {

478 
Ën
 +ğ
Ëá
;

479 
Ëá
 = 0;

482 ià(
Ën
 > 
b
->
¦’
 - 
Ëá
)†en = b->slen -†eft;

484 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

485 
a
->
¦’
 < 0 ||‡->
mËn
 == 0)

486  
BSTR_ERR
;

488 ià(
Ën
 > 0) {

489 ià(
	`b®loc
 (
a
, 
Ën
è!ğ
BSTR_OK
è 
BSTR_ERR
;

490 
	`b¡r__memmove
 (
a
->
d©a
, 
b
->d©¨+ 
Ëá
, 
Ën
);

491 
a
->
¦’
 = 
Ën
;

493 
a
->
¦’
 = 0;

495 
a
->
d©a
[a->
¦’
] = () '\0';

496  
BSTR_OK
;

497 
	}
}

505 
	$bassignc¡r
 (
b¡ršg
 
a
, cÚ¡ * 
¡r
) {

506 
i
;

507 
size_t
 
Ën
;

508 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

509 
a
->
¦’
 < 0 ||‡->
mËn
 =ğ0 || 
NULL
 =ğ
¡r
)

510  
BSTR_ERR
;

512 
i
=0; i < 
a
->
mËn
; i++) {

513 ià('\0' =ğ(
a
->
d©a
[
i
] = 
¡r
[i])) {

514 
a
->
¦’
 = 
i
;

515  
BSTR_OK
;

519 
a
->
¦’
 = 
i
;

520 
Ën
 = 
	`¡¾’
 (
¡r
 + 
i
);

521 ià(
Ën
 > 
INT_MAX
 || 
i
 +†en + 1 > INT_MAX ||

522 0 > 
	`b®loc
 (
a
, (è(
i
 + 
Ën
 + 1))è 
BSTR_ERR
;

523 
	`bBlockCİy
 (
a
->
d©a
 + 
i
, 
¡r
 + i, (
size_t
è
Ën
 + 1);

524 
a
->
¦’
 +ğ(è
Ën
;

525  
BSTR_OK
;

526 
	}
}

534 
	$bassignblk
 (
b¡ršg
 
a
, cÚ¡ * 
s
, 
Ën
) {

535 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

536 
a
->
¦’
 < 0 ||‡->
mËn
 =ğ0 || 
NULL
 =ğ
s
 || 
Ën
 + 1 < 1)

537  
BSTR_ERR
;

538 ià(
Ën
 + 1 > 
a
->
mËn
 && 0 > 
	`b®loc
 (a,†’ + 1)è 
BSTR_ERR
;

539 
	`bBlockCİy
 (
a
->
d©a
, 
s
, (
size_t
è
Ën
);

540 
a
->
d©a
[
Ën
] = () '\0';

541 
a
->
¦’
 = 
Ën
;

542  
BSTR_OK
;

543 
	}
}

549 
	$bŒunc
 (
b¡ršg
 
b
, 
n
) {

550 ià(
n
 < 0 || 
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

551 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

552 ià(
b
->
¦’
 > 
n
) {

553 
b
->
¦’
 = 
n
;

554 
b
->
d©a
[
n
] = () '\0';

556  
BSTR_OK
;

557 
	}
}

559 
	#upÿ£
(
c
è(
	`touµ”
 ((èc))

	)

560 
	#downÿ£
(
c
è(
	`tŞow”
 ((èc))

	)

561 
	#w¥aû
(
c
è(
	`is¥aû
 ((èc))

	)

567 
	$btouµ”
 (
b¡ršg
 
b
) {

568 
i
, 
Ën
;

569 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

570 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

571 
i
=0, 
Ën
 = 
b
->
¦’
; i <†en; i++) {

572 
b
->
d©a
[
i
] = (è
	`upÿ£
 (b->data[i]);

574  
BSTR_OK
;

575 
	}
}

581 
	$btŞow”
 (
b¡ršg
 
b
) {

582 
i
, 
Ën
;

583 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

584 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

585 
i
=0, 
Ën
 = 
b
->
¦’
; i <†en; i++) {

586 
b
->
d©a
[
i
] = (è
	`downÿ£
 (b->data[i]);

588  
BSTR_OK
;

589 
	}
}

600 
	$b¡ricmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

601 
i
, 
v
, 
n
;

603 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 ||

604 
	`bd©a
 (
b1
è=ğ
NULL
 || b1->
¦’
 < 0è 
SHRT_MIN
;

605 ià((
n
 = 
b0
->
¦’
è> 
b1
->slen)‚ = b1->slen;

606 ià(
b0
->
¦’
 =ğ
b1
->¦’ && b0->
d©a
 =ğb1->d©aè 
BSTR_OK
;

608 
i
 = 0; i < 
n
; i ++) {

609 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
i
])

610 - (è
	`downÿ£
 (
b1
->
d©a
[
i
]);

611 ià(0 !ğ
v
)  v;

614 ià(
b0
->
¦’
 > 
n
) {

615 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
n
]);

616 ià(
v
)  v;

617  
UCHAR_MAX
 + 1;

619 ià(
b1
->
¦’
 > 
n
) {

620 
v
 = - (è
	`downÿ£
 (
b1
->
d©a
[
n
]);

621 ià(
v
)  v;

622  - (è(
UCHAR_MAX
 + 1);

624  
BSTR_OK
;

625 
	}
}

637 
	$b¡ºicmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
) {

638 
i
, 
v
, 
m
;

640 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 ||

641 
	`bd©a
 (
b1
è=ğ
NULL
 || b1->
¦’
 < 0 || 
n
 < 0è 
SHRT_MIN
;

642 
m
 = 
n
;

643 ià(
m
 > 
b0
->
¦’
) m = b0->slen;

644 ià(
m
 > 
b1
->
¦’
) m = b1->slen;

646 ià(
b0
->
d©a
 !ğ
b1
->data) {

647 
i
 = 0; i < 
m
; i ++) {

648 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
i
]);

649 
v
 -ğ(è
	`downÿ£
 (
b1
->
d©a
[
i
]);

650 ià(
v
 !ğ0è 
b0
->
d©a
[
i
] - 
b1
->data[i];

654 ià(
n
 =ğ
m
 || 
b0
->
¦’
 =ğ
b1
->¦’è 
BSTR_OK
;

656 ià(
b0
->
¦’
 > 
m
) {

657 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
m
]);

658 ià(
v
)  v;

659  
UCHAR_MAX
 + 1;

662 
v
 = - (è
	`downÿ£
 (
b1
->
d©a
[
m
]);

663 ià(
v
)  v;

664  - (è(
UCHAR_MAX
 + 1);

665 
	}
}

675 
	$bi£qÿ£Ëss
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

676 
i
, 
n
;

678 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 ||

679 
	`bd©a
 (
b1
è=ğ
NULL
 || b1->
¦’
 < 0è 
BSTR_ERR
;

680 ià(
b0
->
¦’
 !ğ
b1
->¦’è 
BSTR_OK
;

681 ià(
b0
->
d©a
 =ğ
b1
->d©¨|| b0->
¦’
 == 0)  1;

682 
i
=0, 
n
=
b0
->
¦’
; i <‚; i++) {

683 ià(
b0
->
d©a
[
i
] !ğ
b1
->data[i]) {

684 
c
 = (è
	`downÿ£
 (
b0
->
d©a
[
i
]);

685 ià(
c
 !ğ(è
	`downÿ£
 (
b1
->
d©a
[
i
]))  0;

689 
	}
}

700 
	$bis¡emeqÿ£Ëssblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
) {

701 
i
;

703 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 || NULL =ğ
blk
 || 
Ën
 < 0)

704  
BSTR_ERR
;

705 ià(
b0
->
¦’
 < 
Ën
è 
BSTR_OK
;

706 ià(
b0
->
d©a
 =ğ(cÚ¡ *è
blk
 || 
Ën
 == 0)  1;

708 
i
 = 0; i < 
Ën
; i ++) {

709 ià(
b0
->
d©a
[
i
] !ğ((cÚ¡ *è
blk
)[i]) {

710 ià(
	`downÿ£
 (
b0
->
d©a
[
i
]) !=

711 
	`downÿ£
 (((cÚ¡ *è
blk
)[
i
]))  0;

715 
	}
}

722 
	$bÉrimws
 (
b¡ršg
 
b
) {

723 
i
, 
Ën
;

725 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

726 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

728 
Ën
 = 
b
->
¦’
, 
i
 = 0; i <†en; i++) {

729 ià(!
	`w¥aû
 (
b
->
d©a
[
i
])) {

730  
	`bd–‘e
 (
b
, 0, 
i
);

734 
b
->
d©a
[0] = () '\0';

735 
b
->
¦’
 = 0;

736  
BSTR_OK
;

737 
	}
}

744 
	$b¹rimws
 (
b¡ršg
 
b
) {

745 
i
;

747 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

748 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

750 
i
 = 
b
->
¦’
 - 1; i >= 0; i--) {

751 ià(!
	`w¥aû
 (
b
->
d©a
[
i
])) {

752 ià(
b
->
mËn
 > 
i
èb->
d©a
[i+1] = () '\0';

753 
b
->
¦’
 = 
i
 + 1;

754  
BSTR_OK
;

758 
b
->
d©a
[0] = () '\0';

759 
b
->
¦’
 = 0;

760  
BSTR_OK
;

761 
	}
}

768 
	$bŒimws
 (
b¡ršg
 
b
) {

769 
i
, 
j
;

771 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

772 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

774 
i
 = 
b
->
¦’
 - 1; i >= 0; i--) {

775 ià(!
	`w¥aû
 (
b
->
d©a
[
i
])) {

776 ià(
b
->
mËn
 > 
i
èb->
d©a
[i+1] = () '\0';

777 
b
->
¦’
 = 
i
 + 1;

778 
j
 = 0; 
	`w¥aû
 (
b
->
d©a
[j]); j++) {}

779  
	`bd–‘e
 (
b
, 0, 
j
);

783 
b
->
d©a
[0] = () '\0';

784 
b
->
¦’
 = 0;

785  
BSTR_OK
;

786 
	}
}

795 
	$bi£q
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

796 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 == NULL || b1->data == NULL ||

797 
b0
->
¦’
 < 0 || 
b1
->¦’ < 0è 
BSTR_ERR
;

798 ià(
b0
->
¦’
 !ğ
b1
->¦’è 
BSTR_OK
;

799 ià(
b0
->
d©a
 =ğ
b1
->d©¨|| b0->
¦’
 == 0)  1;

800  !
	`b¡r__memcmp
 (
b0
->
d©a
, 
b1
->d©a, b0->
¦’
);

801 
	}
}

811 
	$bis¡emeqblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
) {

812 
i
;

814 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 || NULL =ğ
blk
 || 
Ën
 < 0)

815  
BSTR_ERR
;

816 ià(
b0
->
¦’
 < 
Ën
è 
BSTR_OK
;

817 ià(
b0
->
d©a
 =ğ(cÚ¡ *è
blk
 || 
Ën
 == 0)  1;

819 
i
 = 0; i < 
Ën
; i ++) {

820 ià(
b0
->
d©a
[
i
] !ğ((cÚ¡ *è
blk
)[i]è 
BSTR_OK
;

823 
	}
}

836 
	$bi£qc¡r
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
) {

837 
i
;

838 ià(
b
 =ğ
NULL
 || 
s
 =ğNULL || b->
d©a
 =ğNULL || b->
¦’
 < 0è 
BSTR_ERR
;

839 
i
=0; i < 
b
->
¦’
; i++) {

840 ià(
s
[
i
] =ğ'\0' || 
b
->
d©a
[i] !ğ(ès[i]è 
BSTR_OK
;

842  
s
[
i
] == '\0';

843 
	}
}

857 
	$bi£qc¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
) {

858 
i
;

859 ià(
b
 =ğ
NULL
 || 
s
 =ğNULL || b->
d©a
 =ğNULL || b->
¦’
 < 0è 
BSTR_ERR
;

860 
i
=0; i < 
b
->
¦’
; i++) {

861 ià(
s
[
i
] == '\0' ||

862 (
b
->
d©a
[
i
] !ğ(è
s
[i] &&

863 
	`downÿ£
 (
b
->
d©a
[
i
]è!ğ(èdownÿ£ (
s
[i])))

864  
BSTR_OK
;

866  
s
[
i
] == '\0';

867 
	}
}

883 
	$b¡rcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

884 
i
, 
v
, 
n
;

886 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 == NULL || b1->data == NULL ||

887 
b0
->
¦’
 < 0 || 
b1
->¦’ < 0è 
SHRT_MIN
;

888 
n
 = 
b0
->
¦’
; iàÒ > 
b1
->slen)‚ = b1->slen;

889 ià(
b0
->
¦’
 =ğ
b1
->¦’ && (b0->
d©a
 == b1->data || b0->slen == 0))

890  
BSTR_OK
;

892 
i
 = 0; i < 
n
; i ++) {

893 
v
 = ((è
b0
->
d©a
[
i
]è- ((è
b1
->data[i]);

894 ià(
v
 != 0)  v;

895 ià(
b0
->
d©a
[
i
] =ğ(è'\0'è 
BSTR_OK
;

898 ià(
b0
->
¦’
 > 
n
)  1;

899 ià(
b1
->
¦’
 > 
n
)  -1;

900  
BSTR_OK
;

901 
	}
}

913 
	$b¡ºcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
) {

914 
i
, 
v
, 
m
;

916 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 == NULL || b1->data == NULL ||

917 
b0
->
¦’
 < 0 || 
b1
->¦’ < 0è 
SHRT_MIN
;

918 
m
 = 
n
;

919 ià(
m
 > 
b0
->
¦’
) m = b0->slen;

920 ià(
m
 > 
b1
->
¦’
) m = b1->slen;

922 ià(
b0
->
d©a
 !ğ
b1
->data) {

923 
i
 = 0; i < 
m
; i ++) {

924 
v
 = ((è
b0
->
d©a
[
i
]è- ((è
b1
->data[i]);

925 ià(
v
 != 0)  v;

926 ià(
b0
->
d©a
[
i
] =ğ(è'\0'è 
BSTR_OK
;

930 ià(
n
 =ğ
m
 || 
b0
->
¦’
 =ğ
b1
->¦’è 
BSTR_OK
;

932 ià(
b0
->
¦’
 > 
m
)  1;

934 
	}
}

943 
b¡ršg
 
	$bmid¡r
 (
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
) {

945 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

947 ià(
Ëá
 < 0) {

948 
Ën
 +ğ
Ëá
;

949 
Ëá
 = 0;

952 ià(
Ën
 > 
b
->
¦’
 - 
Ëá
)†en = b->slen -†eft;

954 ià(
Ën
 <ğ0è 
	`bäomc¡r
 ("");

955  
	`blk2b¡r
 (
b
->
d©a
 + 
Ëá
, 
Ën
);

956 
	}
}

965 
	$bd–‘e
 (
b¡ršg
 
b
, 
pos
, 
Ën
) {

967 ià(
pos
 < 0) {

968 
Ën
 +ğ
pos
;

969 
pos
 = 0;

972 ià(
Ën
 < 0 || 
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 ||

973 
b
->
mËn
 < b->
¦’
 || b->mlen <= 0)

974  
BSTR_ERR
;

975 ià(
Ën
 > 0 && 
pos
 < 
b
->
¦’
) {

976 ià(
pos
 + 
Ën
 >ğ
b
->
¦’
) {

977 
b
->
¦’
 = 
pos
;

979 
	`bBlockCİy
 ((*è(
b
->
d©a
 + 
pos
),

980 (*è(
b
->
d©a
 + 
pos
 + 
Ën
),

981 
b
->
¦’
 - (
pos
+
Ën
));

982 
b
->
¦’
 -ğ
Ën
;

984 
b
->
d©a
[b->
¦’
] = () '\0';

986  
BSTR_OK
;

987 
	}
}

996 
	$bde¡roy
 (
b¡ršg
 
b
) {

997 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 <= 0 || b->mlen < b->slen ||

998 
b
->
d©a
 =ğ
NULL
)

999  
BSTR_ERR
;

1001 
	`b¡r__ä“
 (
b
->
d©a
);

1006 
b
->
¦’
 = -1;

1007 
b
->
mËn
 = -
__LINE__
;

1008 
b
->
d©a
 = 
NULL
;

1010 
	`b¡r__ä“
 (
b
);

1011  
BSTR_OK
;

1012 
	}
}

1023 
	$bš¡r
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1024 
j
, 
ii
, 
Î
, 
lf
;

1025 * 
d0
;

1026 
c0
;

1027 * 
d1
;

1028 
c1
;

1029 
i
;

1031 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1032 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1033 ià(
b1
->
¦’
 =ğ
pos
è (
b2
->¦’ =ğ0)?pos:
BSTR_ERR
;

1034 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1035 ià(
b2
->
¦’
 =ğ0è 
pos
;

1038 ià((
lf
 = 
b1
->
¦’
 - 
b2
->¦’ + 1è<ğ
pos
è 
BSTR_ERR
;

1041 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 == 0)  0;

1043 
i
 = 
pos
;

1045 
d0
 = 
b2
->
d©a
;

1046 
d1
 = 
b1
->
d©a
;

1047 
Î
 = 
b2
->
¦’
;

1050 
c0
 = 
d0
[0];

1051 ià(1 =ğ
Î
) {

1052 ;
i
 < 
lf
; i++èià(
c0
 =ğ
d1
[i])  i;

1053  
BSTR_ERR
;

1056 
c1
 = 
c0
;

1057 
j
 = 0;

1058 
lf
 = 
b1
->
¦’
 - 1;

1060 
ii
 = -1;

1061 ià(
i
 < 
lf
) do {

1063 ià(
c1
 !ğ
d1
[
i
]) {

1064 ià(
c1
 !ğ
d1
[1+
i
]) {

1065 
i
 += 2;

1068 
i
++;

1072 ià(0 =ğ
j
è
ii
 = 
i
;

1075 
j
++;

1076 
i
++;

1079 ià(
j
 < 
Î
) {

1080 
c1
 = 
d0
[
j
];

1084 
N0
:;

1087 ià(
i
 =ğ
ii
+
j
)  ii;

1090 
i
 -ğ
j
;

1091 
j
 = 0;

1092 
c1
 = 
c0
;

1093 } 
i
 < 
lf
);

1096 ià(
i
 =ğ
lf
 && 
Î
 =ğ
j
+1 && 
c1
 =ğ
d1
[i]è
N0
;

1098  
BSTR_ERR
;

1099 
	}
}

1110 
	$bš¡¼
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1111 
j
, 
i
, 
l
;

1112 * 
d0
, * 
d1
;

1114 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1115 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1116 ià(
b1
->
¦’
 =ğ
pos
 && 
b2
->slen == 0) …os;

1117 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1118 ià(
b2
->
¦’
 =ğ0è 
pos
;

1121 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 =ğ0 && b2->
¦’
 <= b1->slen)  0;

1123 
i
 = 
pos
;

1124 ià((
l
 = 
b1
->
¦’
 - 
b2
->¦’è< 0è 
BSTR_ERR
;

1127 ià(
l
 + 1 <ğ
i
) i =†;

1128 
j
 = 0;

1130 
d0
 = 
b2
->
d©a
;

1131 
d1
 = 
b1
->
d©a
;

1132 
l
 = 
b2
->
¦’
;

1135 ià(
d0
[
j
] =ğ
d1
[
i
 + j]) {

1136 
j
 ++;

1137 ià(
j
 >ğ
l
è 
i
;

1139 
i
 --;

1140 ià(
i
 < 0) ;

1141 
j
=0;

1145  
BSTR_ERR
;

1146 
	}
}

1157 
	$bš¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1158 
j
, 
i
, 
l
, 
Î
;

1159 * 
d0
, * 
d1
;

1161 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1162 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1163 ià(
b1
->
¦’
 =ğ
pos
è (
b2
->¦’ =ğ0)?pos:
BSTR_ERR
;

1164 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1165 ià(
b2
->
¦’
 =ğ0è 
pos
;

1167 
l
 = 
b1
->
¦’
 - 
b2
->slen + 1;

1170 ià(
l
 <ğ
pos
è 
BSTR_ERR
;

1173 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 =ğ0è 
BSTR_OK
;

1175 
i
 = 
pos
;

1176 
j
 = 0;

1178 
d0
 = 
b2
->
d©a
;

1179 
d1
 = 
b1
->
d©a
;

1180 
Î
 = 
b2
->
¦’
;

1183 ià(
d0
[
j
] =ğ
d1
[
i
 + j] || 
	`downÿ£
 (d0[j]) == downcase (d1[i + j])) {

1184 
j
 ++;

1185 ià(
j
 >ğ
Î
è 
i
;

1187 
i
 ++;

1188 ià(
i
 >ğ
l
) ;

1189 
j
=0;

1193  
BSTR_ERR
;

1194 
	}
}

1205 
	$bš¡¼ÿ£Ëss
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1206 
j
, 
i
, 
l
;

1207 * 
d0
, * 
d1
;

1209 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1210 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1211 ià(
b1
->
¦’
 =ğ
pos
 && 
b2
->slen == 0) …os;

1212 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1213 ià(
b2
->
¦’
 =ğ0è 
pos
;

1216 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 =ğ0 && b2->
¦’
 <ğb1->¦’è 
BSTR_OK
;

1218 
i
 = 
pos
;

1219 ià((
l
 = 
b1
->
¦’
 - 
b2
->¦’è< 0è 
BSTR_ERR
;

1222 ià(
l
 + 1 <ğ
i
) i =†;

1223 
j
 = 0;

1225 
d0
 = 
b2
->
d©a
;

1226 
d1
 = 
b1
->
d©a
;

1227 
l
 = 
b2
->
¦’
;

1230 ià(
d0
[
j
] =ğ
d1
[
i
 + j] || 
	`downÿ£
 (d0[j]) == downcase (d1[i + j])) {

1231 
j
 ++;

1232 ià(
j
 >ğ
l
è 
i
;

1234 
i
 --;

1235 ià(
i
 < 0) ;

1236 
j
=0;

1240  
BSTR_ERR
;

1241 
	}
}

1249 
	$b¡rch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
) {

1250 * 
p
;

1252 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 <ğ
pos
 ||…o < 0è 
BSTR_ERR
;

1253 
p
 = (*è
	`b¡r__memchr
 ((
b
->
d©a
 + 
pos
), (è
c
, (b->
¦’
 -…os));

1254 ià(
p
è (èÕ - 
b
->
d©a
);

1255  
BSTR_ERR
;

1256 
	}
}

1263 
	$b¡¼ch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
) {

1264 
i
;

1266 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 <ğ
pos
 ||…o < 0è 
BSTR_ERR
;

1267 
i
=
pos
; i >= 0; i--) {

1268 ià(
b
->
d©a
[
i
] =ğ(è
c
)  i;

1270  
BSTR_ERR
;

1271 
	}
}

1273 #ià!
defšed
 (
BSTRLIB_AGGRESSIVE_MEMORY_FOR_SPEED_TRADEOFF
)

1274 
	#LONG_LOG_BITS_QTY
 (3)

	)

1275 
	#LONG_BITS_QTY
 (1 << 
LONG_LOG_BITS_QTY
)

	)

1276 
	#LONG_TYPE
 

	)

1278 
	#CFCLEN
 ((1 << 
CHAR_BIT
è/ 
LONG_BITS_QTY
)

	)

1279 
	sch¬F›ld
 { 
LONG_TYPE
 
	mcÚ‹Á
[
CFCLEN
]; };

1280 
	#‹¡InCh¬F›ld
(
cf
,
c
è((cf)->
cÚ‹Á
[(cè>> 
LONG_LOG_BITS_QTY
] & ((()1è<< ((cè& (
LONG_BITS_QTY
-1))))

	)

1281 
	#£tInCh¬F›ld
(
cf
,
idx
è{ \

	)

1282 
	gc
 = (è(
idx
); \

1283 (
	gcf
)->
	gcÚ‹Á
[
c
 >> 
LONG_LOG_BITS_QTY
] |ğ(
LONG_TYPE
è(1uÈ<< (ø& (
LONG_BITS_QTY
-1))); \

1288 
	#CFCLEN
 (1 << 
CHAR_BIT
)

	)

1289 
	sch¬F›ld
 { 
	mcÚ‹Á
[
CFCLEN
]; };

1290 
	#‹¡InCh¬F›ld
(
cf
,
c
è((cf)->
cÚ‹Á
[(è(c)])

	)

1291 
	#£tInCh¬F›ld
(
cf
,
idx
è(cf)->
cÚ‹Á
[(è(idx)] = ~0

	)

1296 
	$budCh¬F›ld
 (
ch¬F›ld
 * 
cf
, 
cÚ¡_b¡ršg
 
b
) {

1297 
i
;

1298 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 <ğ0è 
BSTR_ERR
;

1299 
	`mem£t
 ((*è
cf
->
cÚ‹Á
, 0,  (
ch¬F›ld
));

1300 
i
=0; i < 
b
->
¦’
; i++) {

1301 
	`£tInCh¬F›ld
 (
cf
, 
b
->
d©a
[
i
]);

1303  
BSTR_OK
;

1304 
	}
}

1306 
	$šv”tCh¬F›ld
 (
ch¬F›ld
 * 
cf
) {

1307 
i
;

1308 
i
=0; i < 
CFCLEN
; i++è
cf
->
cÚ‹Á
[i] = ~cf->content[i];

1309 
	}
}

1312 
	$bšchrCF
 (cÚ¡ * 
d©a
, 
Ën
, 
pos
, cÚ¡ 
ch¬F›ld
 * 
cf
) {

1313 
i
;

1314 
i
=
pos
; i < 
Ën
; i++) {

1315 
c
 = (è
d©a
[
i
];

1316 ià(
	`‹¡InCh¬F›ld
 (
cf
, 
c
)è 
i
;

1318  
BSTR_ERR
;

1319 
	}
}

1327 
	$bšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1328 
ch¬F›ld
 
chrs
;

1329 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 == NULL ||

1330 
b0
->
¦’
 <ğ
pos
è 
BSTR_ERR
;

1331 ià(1 =ğ
b1
->
¦’
è 
	`b¡rch½
 (
b0
, b1->
d©a
[0], 
pos
);

1332 ià(0 > 
	`budCh¬F›ld
 (&
chrs
, 
b1
)è 
BSTR_ERR
;

1333  
	`bšchrCF
 (
b0
->
d©a
, b0->
¦’
, 
pos
, &
chrs
);

1334 
	}
}

1337 
	$bšch¼CF
 (cÚ¡ * 
d©a
, 
pos
, cÚ¡ 
ch¬F›ld
 * 
cf
) {

1338 
i
;

1339 
i
=
pos
; i >= 0; i--) {

1340 
c
 = (è
d©a
[
i
];

1341 ià(
	`‹¡InCh¬F›ld
 (
cf
, 
c
)è 
i
;

1343  
BSTR_ERR
;

1344 
	}
}

1352 
	$bšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1353 
ch¬F›ld
 
chrs
;

1354 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 =ğNULL || 
b1
 == NULL ||

1355 
b0
->
¦’
 < 
pos
è 
BSTR_ERR
;

1356 ià(
pos
 =ğ
b0
->
¦’
)…os--;

1357 ià(1 =ğ
b1
->
¦’
è 
	`b¡¼ch½
 (
b0
, b1->
d©a
[0], 
pos
);

1358 ià(0 > 
	`budCh¬F›ld
 (&
chrs
, 
b1
)è 
BSTR_ERR
;

1359  
	`bšch¼CF
 (
b0
->
d©a
, 
pos
, &
chrs
);

1360 
	}
}

1368 
	$bnšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1369 
ch¬F›ld
 
chrs
;

1370 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 == NULL ||

1371 
b0
->
¦’
 <ğ
pos
è 
BSTR_ERR
;

1372 ià(
	`budCh¬F›ld
 (&
chrs
, 
b1
è< 0è 
BSTR_ERR
;

1373 
	`šv”tCh¬F›ld
 (&
chrs
);

1374  
	`bšchrCF
 (
b0
->
d©a
, b0->
¦’
, 
pos
, &
chrs
);

1375 
	}
}

1383 
	$bnšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1384 
ch¬F›ld
 
chrs
;

1385 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 == NULL ||

1386 
b0
->
¦’
 < 
pos
è 
BSTR_ERR
;

1387 ià(
pos
 =ğ
b0
->
¦’
)…os--;

1388 ià(
	`budCh¬F›ld
 (&
chrs
, 
b1
è< 0è 
BSTR_ERR
;

1389 
	`šv”tCh¬F›ld
 (&
chrs
);

1390  
	`bšch¼CF
 (
b0
->
d©a
, 
pos
, &
chrs
);

1391 
	}
}

1400 
	$b£t¡r
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
) {

1401 
d
, 
ÃwËn
;

1402 
±rdiff_t
 
pd
;

1403 
b¡ršg
 
aux
 = (b¡ršgè
b1
;

1405 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
¦’
 < 0 || NULL =ğb0->
d©a
 ||

1406 
b0
->
mËn
 < b0->
¦’
 || b0->mËÀ<ğ0è 
BSTR_ERR
;

1407 ià(
b1
 !ğ
NULL
 && (b1->
¦’
 < 0 || b1->
d©a
 =ğNULL)è 
BSTR_ERR
;

1409 
d
 = 
pos
;

1412 ià(
NULL
 !ğ
aux
) {

1413 ià((
pd
 = (
±rdiff_t
è(
b1
->
d©a
 - 
b0
->d©a)è>ğ0 &&…d < (±rdiff_tèb0->
mËn
) {

1414 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b1
))è 
BSTR_ERR
;

1416 
d
 +ğ
aux
->
¦’
;

1420 ià(
	`b®loc
 (
b0
, 
d
 + 1è!ğ
BSTR_OK
) {

1421 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

1422  
BSTR_ERR
;

1425 
ÃwËn
 = 
b0
->
¦’
;

1428 ià(
pos
 > 
ÃwËn
) {

1429 
	`b¡r__mem£t
 (
b0
->
d©a
 + b0->
¦’
, (è
fl
, (
size_t
è(
pos
 - b0->slen));

1430 
ÃwËn
 = 
pos
;

1434 ià(
aux
 !ğ
NULL
) {

1435 
	`bBlockCİy
 ((*è(
b0
->
d©a
 + 
pos
), (*è
aux
->d©a,‡ux->
¦’
);

1436 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

1440 ià(
d
 > 
ÃwËn
)‚ewlen = d;

1442 
b0
->
¦’
 = 
ÃwËn
;

1443 
b0
->
d©a
[
ÃwËn
] = () '\0';

1445  
BSTR_OK
;

1446 
	}
}

1455 
	$bš£¹
 (
b¡ršg
 
b1
, 
pos
, 
cÚ¡_b¡ršg
 
b2
, 
fl
) {

1456 
d
, 
l
;

1457 
±rdiff_t
 
pd
;

1458 
b¡ršg
 
aux
 = (b¡ršgè
b2
;

1460 ià(
pos
 < 0 || 
b1
 =ğ
NULL
 || 
b2
 =ğNULL || b1->
¦’
 < 0 ||

1461 
b2
->
¦’
 < 0 || 
b1
->
mËn
 < b1->¦’ || b1->mËÀ<ğ0è 
BSTR_ERR
;

1464 ià((
pd
 = (
±rdiff_t
è(
b2
->
d©a
 - 
b1
->d©a)è>ğ0 &&…d < (±rdiff_tèb1->
mËn
) {

1465 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b2
))è 
BSTR_ERR
;

1469 
d
 = 
b1
->
¦’
 + 
aux
->slen;

1470 
l
 = 
pos
 + 
aux
->
¦’
;

1471 ià((
d
|
l
è< 0è 
BSTR_ERR
;

1473 ià(
l
 > 
d
) {

1475 ià(
	`b®loc
 (
b1
, 
l
 + 1è!ğ
BSTR_OK
) {

1476 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1477  
BSTR_ERR
;

1479 
	`b¡r__mem£t
 (
b1
->
d©a
 + b1->
¦’
, (è
fl
, (
size_t
è(
pos
 - b1->slen));

1480 
b1
->
¦’
 = 
l
;

1483 ià(
	`b®loc
 (
b1
, 
d
 + 1è!ğ
BSTR_OK
) {

1484 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1485  
BSTR_ERR
;

1487 
	`bBlockCİy
 (
b1
->
d©a
 + 
l
, b1->d©¨+ 
pos
, 
d
 -†);

1488 
b1
->
¦’
 = 
d
;

1490 
	`bBlockCİy
 (
b1
->
d©a
 + 
pos
, 
aux
->d©a,‡ux->
¦’
);

1491 
b1
->
d©a
[b1->
¦’
] = () '\0';

1492 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1493  
BSTR_OK
;

1494 
	}
}

1502 
	$b»¶aû
 (
b¡ršg
 
b1
, 
pos
, 
Ën
, 
cÚ¡_b¡ršg
 
b2
,

1503 
fl
) {

1504 
¶
, 
»t
;

1505 
±rdiff_t
 
pd
;

1506 
b¡ršg
 
aux
 = (b¡ršgè
b2
;

1508 ià(
pos
 < 0 || 
Ën
 < 0 || (
¶
 =…o +†’è< 0 || 
b1
 =ğ
NULL
 ||

1509 
b2
 =ğ
NULL
 || 
b1
->
d©a
 == NULL || b2->data == NULL ||

1510 
b1
->
¦’
 < 0 || 
b2
->¦’ < 0 || b1->
mËn
 < b1->slen ||

1511 
b1
->
mËn
 <ğ0è 
BSTR_ERR
;

1514 ià(
¶
 >ğ
b1
->
¦’
) {

1515 ià((
»t
 = 
	`b£t¡r
 (
b1
, 
pos
, 
b2
, 
fl
)) < 0) „et;

1516 ià(
pos
 + 
b2
->
¦’
 < 
b1
->slen) {

1517 
b1
->
¦’
 = 
pos
 + 
b2
->slen;

1518 
b1
->
d©a
[b1->
¦’
] = () '\0';

1520  
»t
;

1524 ià((
pd
 = (
±rdiff_t
è(
b2
->
d©a
 - 
b1
->d©a)è>ğ0 &&…d < (±rdiff_tèb1->
¦’
) {

1525 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b2
))è 
BSTR_ERR
;

1528 ià(
aux
->
¦’
 > 
Ën
) {

1529 ià(
	`b®loc
 (
b1
, b1->
¦’
 + 
aux
->¦’ - 
Ën
è!ğ
BSTR_OK
) {

1530 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1531  
BSTR_ERR
;

1535 ià(
aux
->
¦’
 !ğ
Ën
è
	`b¡r__memmove
 (
b1
->
d©a
 + 
pos
 +‡ux->slen, b1->data +…os +†en, b1->slen - (pos +†en));

1536 
	`b¡r__memıy
 (
b1
->
d©a
 + 
pos
, 
aux
->d©a,‡ux->
¦’
);

1537 
b1
->
¦’
 +ğ
aux
->¦’ - 
Ën
;

1538 
b1
->
d©a
[b1->
¦’
] = () '\0';

1539 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1540  
BSTR_OK
;

1541 
	}
}

1550 (*
	tš¡r_â±r
è(
	tcÚ¡_b¡ršg
 
	ts1
, 
	tpos
, cÚ¡_b¡ršg 
	ts2
);

1552 
	#INITIAL_STATIC_FIND_INDEX_COUNT
 32

	)

1554 
	$fšd»¶aû’gše
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
, 
š¡r_â±r
 
š¡r
) {

1555 
i
, 
»t
, 
¦’
, 
mËn
, 
d–
, 
acc
;

1556 * 
d
;

1557 
¡©ic_d
[
INITIAL_STATIC_FIND_INDEX_COUNT
+1];

1558 
±rdiff_t
 
pd
;

1559 
b¡ršg
 
auxf
 = (b¡ršgè
fšd
;

1560 
b¡ršg
 
auxr
 = (b¡ršgè
»¶
;

1562 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || 
fšd
 == NULL ||

1563 
fšd
->
d©a
 =ğ
NULL
 || 
»¶
 == NULL ||„epl->data == NULL ||

1564 
pos
 < 0 || 
fšd
->
¦’
 <ğ0 || 
b
->
mËn
 < 0 || b->slen > b->mlen ||

1565 
b
->
mËn
 <ğ0 || b->
¦’
 < 0 || 
»¶
->¦’ < 0è 
BSTR_ERR
;

1566 ià(
pos
 > 
b
->
¦’
 - 
fšd
->¦’è 
BSTR_OK
;

1569 
pd
 = (
±rdiff_t
è(
fšd
->
d©a
 - 
b
->data);

1570 ià((
±rdiff_t
è(
pos
 - 
fšd
->
¦’
è< 
pd
 &&…d < (±rdiff_tè
b
->slen) {

1571 ià(
NULL
 =ğ(
auxf
 = 
	`b¡rıy
 (
fšd
))è 
BSTR_ERR
;

1575 
pd
 = (
±rdiff_t
è(
»¶
->
d©a
 - 
b
->data);

1576 ià((
±rdiff_t
è(
pos
 - 
»¶
->
¦’
è< 
pd
 &&…d < (±rdiff_tè
b
->slen) {

1577 ià(
NULL
 =ğ(
auxr
 = 
	`b¡rıy
 (
»¶
))) {

1578 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1579  
BSTR_ERR
;

1583 
d–
 = 
auxf
->
¦’
 - 
auxr
->slen;

1587 ià(
d–
 == 0) {

1588 (
pos
 = 
	`š¡r
 (
b
,…os, 
auxf
)) >= 0) {

1589 
	`b¡r__memıy
 (
b
->
d©a
 + 
pos
, 
auxr
->d©a,‡uxr->
¦’
);

1590 
pos
 +ğ
auxf
->
¦’
;

1592 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1593 ià(
auxr
 !ğ
»¶
è
	`bde¡roy
 (auxr);

1594  
BSTR_OK
;

1598 ià(
d–
 > 0) {

1599 
acc
 = 0;

1601 (
i
 = 
	`š¡r
 (
b
, 
pos
, 
auxf
)) >= 0) {

1602 ià(
acc
 && 
i
 > 
pos
)

1603 
	`b¡r__memmove
 (
b
->
d©a
 + 
pos
 - 
acc
, b->d©¨+…os, 
i
 -…os);

1604 ià(
auxr
->
¦’
)

1605 
	`b¡r__memıy
 (
b
->
d©a
 + 
i
 - 
acc
, 
auxr
->d©a,‡uxr->
¦’
);

1606 
acc
 +ğ
d–
;

1607 
pos
 = 
i
 + 
auxf
->
¦’
;

1610 ià(
acc
) {

1611 
i
 = 
b
->
¦’
;

1612 ià(
i
 > 
pos
)

1613 
	`b¡r__memmove
 (
b
->
d©a
 + 
pos
 - 
acc
, b->d©¨+…os, 
i
 -…os);

1614 
b
->
¦’
 -ğ
acc
;

1615 
b
->
d©a
[b->
¦’
] = () '\0';

1618 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1619 ià(
auxr
 !ğ
»¶
è
	`bde¡roy
 (auxr);

1620  
BSTR_OK
;

1637 
mËn
 = 
INITIAL_STATIC_FIND_INDEX_COUNT
;

1638 
d
 = (*è
¡©ic_d
;

1639 
acc
 = 
¦’
 = 0;

1641 (
pos
 = 
	`š¡r
 (
b
,…os, 
auxf
)) >= 0) {

1642 ià(
¦’
 >ğ
mËn
 - 1) {

1643 
¦
, *
t
;

1645 
mËn
 += mlen;

1646 
¦
 =  (*è* 
mËn
;

1647 ià(
¡©ic_d
 =ğ
d
èd = 
NULL
;

1648 ià(
mËn
 <ğ0 || 
¦
 < mËÀ|| 
NULL
 =ğ(
t
 = (*è
	`b¡r__»®loc
 (
d
, sl))) {

1649 
»t
 = 
BSTR_ERR
;

1650 
dÚe
;

1652 ià(
NULL
 =ğ
d
è
	`b¡r__memıy
 (
t
, 
¡©ic_d
,  (static_d));

1653 
d
 = 
t
;

1655 
d
[
¦’
] = 
pos
;

1656 
¦’
++;

1657 
acc
 -ğ
d–
;

1658 
pos
 +ğ
auxf
->
¦’
;

1659 ià(
pos
 < 0 || 
acc
 < 0) {

1660 
»t
 = 
BSTR_ERR
;

1661 
dÚe
;

1666 
d
[
¦’
] = 
b
->slen;

1668 ià(
BSTR_OK
 =ğ(
»t
 = 
	`b®loc
 (
b
, b->
¦’
 + 
acc
 + 1))) {

1669 
b
->
¦’
 +ğ
acc
;

1670 
i
 = 
¦’
-1; i >= 0; i--) {

1671 
s
, 
l
;

1672 
s
 = 
d
[
i
] + 
auxf
->
¦’
;

1673 
l
 = 
d
[
i
+1] - 
s
;

1674 ià(
l
) {

1675 
	`b¡r__memmove
 (
b
->
d©a
 + 
s
 + 
acc
, b->d©¨+ s, 
l
);

1677 ià(
auxr
->
¦’
) {

1678 
	`b¡r__memmove
 (
b
->
d©a
 + 
s
 + 
acc
 - 
auxr
->
¦’
,

1679 
auxr
->
d©a
,‡uxr->
¦’
);

1681 
acc
 +ğ
d–
;

1683 
b
->
d©a
[b->
¦’
] = () '\0';

1686 
dÚe
:;

1687 ià(
¡©ic_d
 =ğ
d
èd = 
NULL
;

1688 
	`b¡r__ä“
 (
d
);

1689 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1690 ià(
auxr
 !ğ
»¶
è
	`bde¡roy
 (auxr);

1691  
»t
;

1692 
	}
}

1700 
	$bfšd»¶aû
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
) {

1701  
	`fšd»¶aû’gše
 (
b
, 
fšd
, 
»¶
, 
pos
, 
bš¡r
);

1702 
	}
}

1710 
	$bfšd»¶aûÿ£Ëss
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
) {

1711  
	`fšd»¶aû’gše
 (
b
, 
fšd
, 
»¶
, 
pos
, 
bš¡rÿ£Ëss
);

1712 
	}
}

1721 
	$bš£¹ch
 (
b¡ršg
 
b
, 
pos
, 
Ën
, 
fl
) {

1722 
d
, 
l
, 
i
;

1724 ià(
pos
 < 0 || 
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->slen ||

1725 
b
->
mËn
 <ğ0 || 
Ën
 < 0è 
BSTR_ERR
;

1728 
d
 = 
b
->
¦’
 + 
Ën
;

1729 
l
 = 
pos
 + 
Ën
;

1730 ià((
d
|
l
è< 0è 
BSTR_ERR
;

1732 ià(
l
 > 
d
) {

1734 ià(
	`b®loc
 (
b
, 
l
 + 1è!ğ
BSTR_OK
è 
BSTR_ERR
;

1735 
pos
 = 
b
->
¦’
;

1736 
b
->
¦’
 = 
l
;

1739 ià(
	`b®loc
 (
b
, 
d
 + 1è!ğ
BSTR_OK
è 
BSTR_ERR
;

1740 
i
 = 
d
 - 1; i >ğ
l
; i--) {

1741 
b
->
d©a
[
i
] = b->d©a[˜- 
Ën
];

1743 
b
->
¦’
 = 
d
;

1746 
i
=
pos
; i < 
l
; i++è
b
->
d©a
[i] = 
fl
;

1747 
b
->
d©a
[b->
¦’
] = () '\0';

1748  
BSTR_OK
;

1749 
	}
}

1758 
	$b·‰”n
 (
b¡ršg
 
b
, 
Ën
) {

1759 
i
, 
d
;

1761 
d
 = 
	`bËngth
 (
b
);

1762 ià(
d
 <ğ0 || 
Ën
 < 0 || 
	`b®loc
 (
b
,†’ + 1è!ğ
BSTR_OK
è 
BSTR_ERR
;

1763 ià(
Ën
 > 0) {

1764 ià(
d
 =ğ1è 
	`b£t¡r
 (
b
, 
Ën
, 
NULL
, b->
d©a
[0]);

1765 
i
 = 
d
; i < 
Ën
; i++è
b
->
d©a
[i] = b->data[i - d];

1767 
b
->
d©a
[
Ën
] = () '\0';

1768 
b
->
¦’
 = 
Ën
;

1769  
BSTR_OK
;

1770 
	}
}

1772 
	#BS_BUFF_SZ
 (1024)

	)

1780 
	$b»ada
 (
b¡ršg
 
b
, 
bN»ad
 
»adPŒ
, * 
·rm
) {

1781 
i
, 
l
, 
n
;

1783 ià(
b
 =ğ
NULL
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen ||

1784 
b
->
mËn
 <ğ0 || 
»adPŒ
 =ğ
NULL
è 
BSTR_ERR
;

1786 
i
 = 
b
->
¦’
;

1787 
n
=
i
+16; ;‚ +ğ(Ò < 
BS_BUFF_SZ
) ?‚ : BS_BUFF_SZ)) {

1788 ià(
BSTR_OK
 !ğ
	`b®loc
 (
b
, 
n
 + 1)è 
BSTR_ERR
;

1789 
l
 = (è
	`»adPŒ
 ((*è(
b
->
d©a
 + 
i
), 1, 
n
 - i, 
·rm
);

1790 
i
 +ğ
l
;

1791 
b
->
¦’
 = 
i
;

1792 ià(
i
 < 
n
) ;

1795 
b
->
d©a
[
i
] = () '\0';

1796  
BSTR_OK
;

1797 
	}
}

1805 
b¡ršg
 
	$b»ad
 (
bN»ad
 
»adPŒ
, * 
·rm
) {

1806 
b¡ršg
 
buff
;

1808 ià(0 > 
	`b»ada
 (
buff
 = 
	`bäomc¡r
 (""), 
»adPŒ
, 
·rm
)) {

1809 
	`bde¡roy
 (
buff
);

1810  
NULL
;

1812  
buff
;

1813 
	}
}

1828 
	$bassigng‘s
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
) {

1829 
c
, 
d
, 
e
;

1831 ià(
b
 =ğ
NULL
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen ||

1832 
b
->
mËn
 <ğ0 || 
g‘cPŒ
 =ğ
NULL
è 
BSTR_ERR
;

1833 
d
 = 0;

1834 
e
 = 
b
->
mËn
 - 2;

1836 (
c
 = 
	`g‘cPŒ
 (
·rm
)) >= 0) {

1837 ià(
d
 > 
e
) {

1838 
b
->
¦’
 = 
d
;

1839 ià(
	`b®loc
 (
b
, 
d
 + 2è!ğ
BSTR_OK
è 
BSTR_ERR
;

1840 
e
 = 
b
->
mËn
 - 2;

1842 
b
->
d©a
[
d
] = (è
c
;

1843 
d
++;

1844 ià(
c
 =ğ
‹rmš©Ü
) ;

1847 
b
->
d©a
[
d
] = () '\0';

1848 
b
->
¦’
 = 
d
;

1850  
d
 =ğ0 && 
c
 < 0;

1851 
	}
}

1866 
	$bg‘§
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
) {

1867 
c
, 
d
, 
e
;

1869 ià(
b
 =ğ
NULL
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen ||

1870 
b
->
mËn
 <ğ0 || 
g‘cPŒ
 =ğ
NULL
è 
BSTR_ERR
;

1871 
d
 = 
b
->
¦’
;

1872 
e
 = 
b
->
mËn
 - 2;

1874 (
c
 = 
	`g‘cPŒ
 (
·rm
)) >= 0) {

1875 ià(
d
 > 
e
) {

1876 
b
->
¦’
 = 
d
;

1877 ià(
	`b®loc
 (
b
, 
d
 + 2è!ğ
BSTR_OK
è 
BSTR_ERR
;

1878 
e
 = 
b
->
mËn
 - 2;

1880 
b
->
d©a
[
d
] = (è
c
;

1881 
d
++;

1882 ià(
c
 =ğ
‹rmš©Ü
) ;

1885 
b
->
d©a
[
d
] = () '\0';

1886 
b
->
¦’
 = 
d
;

1888  
d
 =ğ0 && 
c
 < 0;

1889 
	}
}

1902 
b¡ršg
 
	$bg‘s
 (
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
) {

1903 
b¡ršg
 
buff
;

1905 ià(0 > 
	`bg‘§
 (
buff
 = 
	`bäomc¡r
 (""), 
g‘cPŒ
, 
·rm
, 
‹rmš©Ü
è|| 0 >ğbuff->
¦’
) {

1906 
	`bde¡roy
 (
buff
);

1907 
buff
 = 
NULL
;

1909  
buff
;

1910 
	}
}

1912 
	sbSŒ—m
 {

1913 
b¡ršg
 
	mbuff
;

1914 * 
	m·rm
;

1915 
bN»ad
 
	m»adFnPŒ
;

1916 
	misEOF
;

1917 
	mmaxBuffSz
;

1926 
bSŒ—m
 * 
	$bsİ’
 (
bN»ad
 
»adPŒ
, * 
·rm
) {

1927 
bSŒ—m
 * 
s
;

1929 ià(
»adPŒ
 =ğ
NULL
)  NULL;

1930 
s
 = (
bSŒ—m
 *è
	`b¡r__®loc
 ( (bStream));

1931 ià(
s
 =ğ
NULL
)  NULL;

1932 
s
->
·rm
 =…arm;

1933 
s
->
buff
 = 
	`bäomc¡r
 ("");

1934 
s
->
»adFnPŒ
 = 
»adPŒ
;

1935 
s
->
maxBuffSz
 = 
BS_BUFF_SZ
;

1936 
s
->
isEOF
 = 0;

1937  
s
;

1938 
	}
}

1945 
	$bsbufæ’gth
 (
bSŒ—m
 * 
s
, 
sz
) {

1946 
ŞdSz
;

1947 ià(
s
 =ğ
NULL
 || 
sz
 < 0è 
BSTR_ERR
;

1948 
ŞdSz
 = 
s
->
maxBuffSz
;

1949 ià(
sz
 > 0è
s
->
maxBuffSz
 = sz;

1950  
ŞdSz
;

1951 
	}
}

1953 
	$b£of
 (cÚ¡ 
bSŒ—m
 * 
s
) {

1954 ià(
s
 =ğ
NULL
 || s->
»adFnPŒ
 =ğNULLè 
BSTR_ERR
;

1955  
s
->
isEOF
 && (s->
buff
->
¦’
 == 0);

1956 
	}
}

1963 * 
	$bsşo£
 (
bSŒ—m
 * 
s
) {

1964 * 
·rm
;

1965 ià(
s
 =ğ
NULL
)  NULL;

1966 
s
->
»adFnPŒ
 = 
NULL
;

1967 ià(
s
->
buff
è
	`bde¡roy
 (s->buff);

1968 
s
->
buff
 = 
NULL
;

1969 
·rm
 = 
s
->parm;

1970 
s
->
·rm
 = 
NULL
;

1971 
s
->
isEOF
 = 1;

1972 
	`b¡r__ä“
 (
s
);

1973  
·rm
;

1974 
	}
}

1983 
	$b¤—dÊa
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
) {

1984 
i
, 
l
, 
»t
, 
¾o
;

1985 * 
b
;

1986 
gb¡ršg
 
x
;

1988 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0 ||

1989 
r
->
¦’
 < 0 ||„->
mËn
 <„->¦’è 
BSTR_ERR
;

1990 
l
 = 
s
->
buff
->
¦’
;

1991 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

1992 
b
 = (*è
s
->
buff
->
d©a
;

1993 
x
.
d©a
 = (*è
b
;

1996 
b
[
l
] = 
‹rmš©Ü
;

1997 
i
=0; 
b
[i] !ğ
‹rmš©Ü
; i++) ;

1998 ià(
i
 < 
l
) {

1999 
x
.
¦’
 = 
i
 + 1;

2000 
»t
 = 
	`bcÚÿt
 (
r
, &
x
);

2001 
s
->
buff
->
¦’
 = 
l
;

2002 ià(
BSTR_OK
 =ğ
»t
è
	`bd–‘e
 (
s
->
buff
, 0, 
i
 + 1);

2003  
BSTR_OK
;

2006 
¾o
 = 
r
->
¦’
;

2009 
x
.
¦’
 = 
l
;

2010 ià(
BSTR_OK
 !ğ
	`bcÚÿt
 (
r
, &
x
)è 
BSTR_ERR
;

2015 ià(
BSTR_OK
 !ğ
	`b®loc
 (
r
,„->
¦’
 + 
s
->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2016 
b
 = (*è(
r
->
d©a
 +„->
¦’
);

2017 
l
 = (è
s
->
	`»adFnPŒ
 (
b
, 1, s->
maxBuffSz
, s->
·rm
);

2018 ià(
l
 <= 0) {

2019 
r
->
d©a
[r->
¦’
] = () '\0';

2020 
s
->
buff
->
¦’
 = 0;

2021 
s
->
isEOF
 = 1;

2023  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
¾o
);

2025 
b
[
l
] = 
‹rmš©Ü
;

2026 
i
=0; 
b
[i] !ğ
‹rmš©Ü
; i++) ;

2027 ià(
i
 < 
l
) ;

2028 
r
->
¦’
 +ğ
l
;

2032 
i
++;

2033 
r
->
¦’
 +ğ
i
;

2034 
s
->
buff
->
¦’
 = 
l
 - 
i
;

2035 
	`b¡r__memıy
 (
s
->
buff
->
d©a
, 
b
 + 
i
, 
l
 - i);

2036 
r
->
d©a
[r->
¦’
] = () '\0';

2037  
BSTR_OK
;

2038 
	}
}

2047 
	$b¤—dÊ§
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
) {

2048 
i
, 
l
, 
»t
, 
¾o
;

2049 * 
b
;

2050 
gb¡ršg
 
x
;

2051 
ch¬F›ld
 
cf
;

2053 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL || 
‹rm
 == NULL ||

2054 
‹rm
->
d©a
 =ğ
NULL
 || 
r
->
mËn
 <ğ0 ||„->
¦’
 < 0 ||

2055 
r
->
mËn
 <„->
¦’
è 
BSTR_ERR
;

2056 ià(
‹rm
->
¦’
 =ğ1è 
	`b¤—dÊa
 (
r
, 
s
,”m->
d©a
[0]);

2057 ià(
‹rm
->
¦’
 < 1 || 
	`budCh¬F›ld
 (&
cf
,”m)è 
BSTR_ERR
;

2059 
l
 = 
s
->
buff
->
¦’
;

2060 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2061 
b
 = (*è
s
->
buff
->
d©a
;

2062 
x
.
d©a
 = 
b
;

2065 
b
[
l
] = 
‹rm
->
d©a
[0];

2066 
i
=0; !
	`‹¡InCh¬F›ld
 (&
cf
, 
b
[i]); i++) ;

2067 ià(
i
 < 
l
) {

2068 
x
.
¦’
 = 
i
 + 1;

2069 
»t
 = 
	`bcÚÿt
 (
r
, &
x
);

2070 
s
->
buff
->
¦’
 = 
l
;

2071 ià(
BSTR_OK
 =ğ
»t
è
	`bd–‘e
 (
s
->
buff
, 0, 
i
 + 1);

2072  
BSTR_OK
;

2075 
¾o
 = 
r
->
¦’
;

2078 
x
.
¦’
 = 
l
;

2079 ià(
BSTR_OK
 !ğ
	`bcÚÿt
 (
r
, &
x
)è 
BSTR_ERR
;

2084 ià(
BSTR_OK
 !ğ
	`b®loc
 (
r
,„->
¦’
 + 
s
->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2085 
b
 = (*è(
r
->
d©a
 +„->
¦’
);

2086 
l
 = (è
s
->
	`»adFnPŒ
 (
b
, 1, s->
maxBuffSz
, s->
·rm
);

2087 ià(
l
 <= 0) {

2088 
r
->
d©a
[r->
¦’
] = () '\0';

2089 
s
->
buff
->
¦’
 = 0;

2090 
s
->
isEOF
 = 1;

2092  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
¾o
);

2095 
b
[
l
] = 
‹rm
->
d©a
[0];

2096 
i
=0; !
	`‹¡InCh¬F›ld
 (&
cf
, 
b
[i]); i++) ;

2097 ià(
i
 < 
l
) ;

2098 
r
->
¦’
 +ğ
l
;

2102 
i
++;

2103 
r
->
¦’
 +ğ
i
;

2104 
s
->
buff
->
¦’
 = 
l
 - 
i
;

2105 
	`b¡r__memıy
 (
s
->
buff
->
d©a
, 
b
 + 
i
, 
l
 - i);

2106 
r
->
d©a
[r->
¦’
] = () '\0';

2107  
BSTR_OK
;

2108 
	}
}

2118 
	$b¤—da
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
n
) {

2119 
l
, 
»t
, 
Ü¦’
;

2120 * 
b
;

2121 
gb¡ršg
 
x
;

2123 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0

2124 || 
r
->
¦’
 < 0 ||„->
mËn
 <„->¦’ || 
n
 <ğ0è 
BSTR_ERR
;

2126 
n
 +ğ
r
->
¦’
;

2127 ià(
n
 <ğ0è 
BSTR_ERR
;

2129 
l
 = 
s
->
buff
->
¦’
;

2131 
Ü¦’
 = 
r
->
¦’
;

2133 ià(0 =ğ
l
) {

2134 ià(
s
->
isEOF
è 
BSTR_ERR
;

2135 ià(
r
->
mËn
 > 
n
) {

2136 
l
 = (è
s
->
	`»adFnPŒ
 (
r
->
d©a
 +„->
¦’
, 1, 
n
 -„->¦’, s->
·rm
);

2137 ià(0 >ğ
l
 ||† > 
n
 - 
r
->
¦’
) {

2138 
s
->
isEOF
 = 1;

2139  
BSTR_ERR
;

2141 
r
->
¦’
 +ğ
l
;

2142 
r
->
d©a
[r->
¦’
] = () '\0';

2147 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2148 
b
 = (*è
s
->
buff
->
d©a
;

2149 
x
.
d©a
 = (*è
b
;

2152 ià(
l
 + 
r
->
¦’
 >ğ
n
) {

2153 
x
.
¦’
 = 
n
 - 
r
->slen;

2154 
»t
 = 
	`bcÚÿt
 (
r
, &
x
);

2155 
s
->
buff
->
¦’
 = 
l
;

2156 ià(
BSTR_OK
 =ğ
»t
è
	`bd–‘e
 (
s
->
buff
, 0, 
x
.
¦’
);

2157  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
Ü¦’
);

2160 
x
.
¦’
 = 
l
;

2161 ià(
BSTR_OK
 !ğ
	`bcÚÿt
 (
r
, &
x
)) ;

2163 
l
 = 
n
 - 
r
->
¦’
;

2164 ià(
l
 > 
s
->
maxBuffSz
)† = s->maxBuffSz;

2166 
l
 = (è
s
->
	`»adFnPŒ
 (
b
, 1,†, s->
·rm
);

2168 } 
l
 > 0);

2169 ià(
l
 < 0)† = 0;

2170 ià(
l
 =ğ0è
s
->
isEOF
 = 1;

2171 
s
->
buff
->
¦’
 = 
l
;

2172  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
Ü¦’
);

2173 
	}
}

2182 
	$b¤—dÊ
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
) {

2183 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0)

2184  
BSTR_ERR
;

2185 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2186 
r
->
¦’
 = 0;

2187  
	`b¤—dÊa
 (
r
, 
s
, 
‹rmš©Ü
);

2188 
	}
}

2197 
	$b¤—dÊs
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
) {

2198 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL || 
‹rm
 == NULL

2199 || 
‹rm
->
d©a
 =ğ
NULL
 || 
r
->
mËn
 <ğ0è 
BSTR_ERR
;

2200 ià(
‹rm
->
¦’
 =ğ1è 
	`b¤—dÊ
 (
r
, 
s
,”m->
d©a
[0]);

2201 ià(
‹rm
->
¦’
 < 1è 
BSTR_ERR
;

2202 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2203 
r
->
¦’
 = 0;

2204  
	`b¤—dÊ§
 (
r
, 
s
, 
‹rm
);

2205 
	}
}

2215 
	$b¤—d
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
n
) {

2216 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0

2217 || 
n
 <ğ0è 
BSTR_ERR
;

2218 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2219 
r
->
¦’
 = 0;

2220  
	`b¤—da
 (
r
, 
s
, 
n
);

2221 
	}
}

2229 
	$bsuÄ—d
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
b
) {

2230 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULLè 
BSTR_ERR
;

2231  
	`bš£¹
 (
s
->
buff
, 0, 
b
, () '?');

2232 
	}
}

2239 
	$b¥“k
 (
b¡ršg
 
r
, cÚ¡ 
bSŒ—m
 * 
s
) {

2240 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULLè 
BSTR_ERR
;

2241  
	`bassign
 (
r
, 
s
->
buff
);

2242 
	}
}

2250 
b¡ršg
 
	$bjoš
 (cÚ¡ 
b¡rLi¡
 * 
bl
, 
cÚ¡_b¡ršg
 
£p
) {

2251 
b¡ršg
 
b
;

2252 
i
, 
c
, 
v
;

2254 ià(
bl
 =ğ
NULL
 || bl->
qty
 < 0)  NULL;

2255 ià(
£p
 !ğ
NULL
 && (£p->
¦’
 < 0 || s•->
d©a
 == NULL))  NULL;

2257 
i
 = 0, 
c
 = 1; i < 
bl
->
qty
; i++) {

2258 
v
 = 
bl
->
’Œy
[
i
]->
¦’
;

2259 ià(
v
 < 0è 
NULL
;

2260 
c
 +ğ
v
;

2261 ià(
c
 < 0è 
NULL
;

2264 ià(
£p
 !ğ
NULL
è
c
 +ğ(
bl
->
qty
 - 1è* s•->
¦’
;

2266 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

2267 ià(
NULL
 =ğ
b
)  NULL;

2268 
b
->
d©a
 = (*è
	`b¡r__®loc
 (
c
);

2269 ià(
b
->
d©a
 =ğ
NULL
) {

2270 
	`b¡r__ä“
 (
b
);

2271  
NULL
;

2274 
b
->
mËn
 = 
c
;

2275 
b
->
¦’
 = 
c
-1;

2277 
i
 = 0, 
c
 = 0; i < 
bl
->
qty
; i++) {

2278 ià(
i
 > 0 && 
£p
 !ğ
NULL
) {

2279 
	`b¡r__memıy
 (
b
->
d©a
 + 
c
, 
£p
->d©a, s•->
¦’
);

2280 
c
 +ğ
£p
->
¦’
;

2282 
v
 = 
bl
->
’Œy
[
i
]->
¦’
;

2283 
	`b¡r__memıy
 (
b
->
d©a
 + 
c
, 
bl
->
’Œy
[
i
]->d©a, 
v
);

2284 
c
 +ğ
v
;

2286 
b
->
d©a
[
c
] = () '\0';

2287  
b
;

2288 
	}
}

2290 
	#BSSSC_BUFF_LEN
 (256)

	)

2309 
bs¥l™scb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

2310 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm) {

2311 
ch¬F›ld
 
chrs
;

2312 
b¡ršg
 
buff
;

2313 
i
, 
p
, 
»t
;

2315 ià(
cb
 =ğ
NULL
 || 
s
 =ğNULL || s->
»adFnPŒ
 == NULL

2316 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2318 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡r
 (""))è 
BSTR_ERR
;

2320 ià(
¥l™SŒ
->
¦’
 == 0) {

2321 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
) >= 0) ;

2322 ià((
»t
 = 
	`cb
 (
·rm
, 0, 
buff
)) > 0)

2323 
»t
 = 0;

2325 
	`budCh¬F›ld
 (&
chrs
, 
¥l™SŒ
);

2326 
»t
 = 
p
 = 
i
 = 0;

2328 ià(
i
 >ğ
buff
->
¦’
) {

2329 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
);

2330 ià(
i
 >ğ
buff
->
¦’
) {

2331 ià(0 < (
»t
 = 
	`cb
 (
·rm
, 
p
, 
buff
)))„et = 0;

2335 ià(
	`‹¡InCh¬F›ld
 (&
chrs
, 
buff
->
d©a
[
i
])) {

2336 
gb¡ršg
 
t
;

2337 
c
;

2339 
	`blk2tb¡r
 (
t
, 
buff
->
d©a
 + 
i
 + 1, buff->
¦’
 - (i + 1));

2340 ià((
»t
 = 
	`bsuÄ—d
 (
s
, &
t
)) < 0) ;

2341 
buff
->
¦’
 = 
i
;

2342 
c
 = 
buff
->
d©a
[
i
];

2343 
buff
->
d©a
[
i
] = () '\0';

2344 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
buff
)) < 0) ;

2345 
buff
->
d©a
[
i
] = 
c
;

2346 
buff
->
¦’
 = 0;

2347 
p
 +ğ
i
 + 1;

2348 
i
 = -1;

2350 
i
++;

2354 
	`bde¡roy
 (
buff
);

2355  
»t
;

2356 
	}
}

2375 
bs¥l™¡rcb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

2376 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm) {

2377 
b¡ršg
 
buff
;

2378 
i
, 
p
, 
»t
;

2380 ià(
cb
 =ğ
NULL
 || 
s
 =ğNULL || s->
»adFnPŒ
 == NULL

2381 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2383 ià(
¥l™SŒ
->
¦’
 =ğ1è 
	`bs¥l™scb
 (
s
, s¶™SŒ, 
cb
, 
·rm
);

2385 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡r
 (""))è 
BSTR_ERR
;

2387 ià(
¥l™SŒ
->
¦’
 == 0) {

2388 
i
=0; 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
) >= 0; i++) {

2389 ià((
»t
 = 
	`cb
 (
·rm
, 0, 
buff
)) < 0) {

2390 
	`bde¡roy
 (
buff
);

2391  
»t
;

2393 
buff
->
¦’
 = 0;

2395  
BSTR_OK
;

2397 
»t
 = 
p
 = 
i
 = 0;

2398 
i
=
p
=0;;) {

2399 ià((
»t
 = 
	`bš¡r
 (
buff
, 0, 
¥l™SŒ
)) >= 0) {

2400 
gb¡ršg
 
t
;

2401 
	`blk2tb¡r
 (
t
, 
buff
->
d©a
, 
»t
);

2402 
i
 = 
»t
 + 
¥l™SŒ
->
¦’
;

2403 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, &
t
)) < 0) ;

2404 
p
 +ğ
i
;

2405 
	`bd–‘e
 (
buff
, 0, 
i
);

2407 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
);

2408 ià(
	`b£of
 (
s
)) {

2409 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
buff
)) > 0)„et = 0;

2416 
	`bde¡roy
 (
buff
);

2417  
»t
;

2418 
	}
}

2424 
b¡rLi¡
 * 
	$b¡rLi¡C»©e
 () {

2425 
b¡rLi¡
 * 
¦
 = (b¡rLi¡ *è
	`b¡r__®loc
 ( (bstrList));

2426 ià(
¦
) {

2427 
¦
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (1* (bstring));

2428 ià(!
¦
->
’Œy
) {

2429 
	`b¡r__ä“
 (
¦
);

2430 
¦
 = 
NULL
;

2432 
¦
->
qty
 = 0;

2433 
¦
->
mËn
 = 1;

2436  
¦
;

2437 
	}
}

2443 
	$b¡rLi¡De¡roy
 (
b¡rLi¡
 * 
¦
) {

2444 
i
;

2445 ià(
¦
 =ğ
NULL
 || sl->
qty
 < 0è 
BSTR_ERR
;

2446 
i
=0; i < 
¦
->
qty
; i++) {

2447 ià(
¦
->
’Œy
[
i
]) {

2448 
	`bde¡roy
 (
¦
->
’Œy
[
i
]);

2449 
¦
->
’Œy
[
i
] = 
NULL
;

2452 
¦
->
qty
 = -1;

2453 
¦
->
mËn
 = -1;

2454 
	`b¡r__ä“
 (
¦
->
’Œy
);

2455 
¦
->
’Œy
 = 
NULL
;

2456 
	`b¡r__ä“
 (
¦
);

2457  
BSTR_OK
;

2458 
	}
}

2465 
	$b¡rLi¡AÎoc
 (
b¡rLi¡
 * 
¦
, 
msz
) {

2466 
b¡ršg
 * 
l
;

2467 
smsz
;

2468 
size_t
 
nsz
;

2469 ià(!
¦
 || 
msz
 <ğ0 || !¦->
’Œy
 || sl->
qty
 < 0 || sl->
mËn
 <ğ0 || sl->qty > sl->mËnè 
BSTR_ERR
;

2470 ià(
¦
->
mËn
 >ğ
msz
è 
BSTR_OK
;

2471 
smsz
 = 
	`¢­UpSize
 (
msz
);

2472 
nsz
 = ((
size_t
è
smsz
è*  (
b¡ršg
);

2473 ià(
nsz
 < (
size_t
è
smsz
è 
BSTR_ERR
;

2474 
l
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
¦
->
’Œy
, 
nsz
);

2475 ià(!
l
) {

2476 
smsz
 = 
msz
;

2477 
nsz
 = ((
size_t
è
smsz
è*  (
b¡ršg
);

2478 
l
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
¦
->
’Œy
, 
nsz
);

2479 ià(!
l
è 
BSTR_ERR
;

2481 
¦
->
mËn
 = 
smsz
;

2482 
¦
->
’Œy
 = 
l
;

2483  
BSTR_OK
;

2484 
	}
}

2491 
	$b¡rLi¡AÎocMš
 (
b¡rLi¡
 * 
¦
, 
msz
) {

2492 
b¡ršg
 * 
l
;

2493 
size_t
 
nsz
;

2494 ià(!
¦
 || 
msz
 <ğ0 || !¦->
’Œy
 || sl->
qty
 < 0 || sl->
mËn
 <ğ0 || sl->qty > sl->mËnè 
BSTR_ERR
;

2495 ià(
msz
 < 
¦
->
qty
) msz = sl->qty;

2496 ià(
¦
->
mËn
 =ğ
msz
è 
BSTR_OK
;

2497 
nsz
 = ((
size_t
è
msz
è*  (
b¡ršg
);

2498 ià(
nsz
 < (
size_t
è
msz
è 
BSTR_ERR
;

2499 
l
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
¦
->
’Œy
, 
nsz
);

2500 ià(!
l
è 
BSTR_ERR
;

2501 
¦
->
mËn
 = 
msz
;

2502 
¦
->
’Œy
 = 
l
;

2503  
BSTR_OK
;

2504 
	}
}

2521 
b¥l™cb
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
, 
pos
,

2522 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm) {

2523 
i
, 
p
, 
»t
;

2525 ià(
cb
 =ğ
NULL
 || 
¡r
 =ğNULL || 
pos
 < 0 ||…o > sŒ->
¦’
)

2526  
BSTR_ERR
;

2528 
p
 = 
pos
;

2530 
i
=
p
; i < 
¡r
->
¦’
; i++) {

2531 ià(
¡r
->
d©a
[
i
] =ğ
¥l™Ch¬
) ;

2533 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
i
 -…)) < 0) „et;

2534 
p
 = 
i
 + 1;

2535 } 
p
 <ğ
¡r
->
¦’
);

2536  
BSTR_OK
;

2537 
	}
}

2555 
b¥l™scb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

2556 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm) {

2557 
ch¬F›ld
 
chrs
;

2558 
i
, 
p
, 
»t
;

2560 ià(
cb
 =ğ
NULL
 || 
¡r
 =ğNULL || 
pos
 < 0 ||…o > sŒ->
¦’


2561 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2562 ià(
¥l™SŒ
->
¦’
 == 0) {

2563 ià((
»t
 = 
	`cb
 (
·rm
, 0, 
¡r
->
¦’
)) > 0)„et = 0;

2564  
»t
;

2567 ià(
¥l™SŒ
->
¦’
 == 1)

2568  
	`b¥l™cb
 (
¡r
, 
¥l™SŒ
->
d©a
[0], 
pos
, 
cb
, 
·rm
);

2570 
	`budCh¬F›ld
 (&
chrs
, 
¥l™SŒ
);

2572 
p
 = 
pos
;

2574 
i
=
p
; i < 
¡r
->
¦’
; i++) {

2575 ià(
	`‹¡InCh¬F›ld
 (&
chrs
, 
¡r
->
d©a
[
i
])) ;

2577 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
i
 -…)) < 0) „et;

2578 
p
 = 
i
 + 1;

2579 } 
p
 <ğ
¡r
->
¦’
);

2580  
BSTR_OK
;

2581 
	}
}

2599 
b¥l™¡rcb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

2600 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm) {

2601 
i
, 
p
, 
»t
;

2603 ià(
cb
 =ğ
NULL
 || 
¡r
 =ğNULL || 
pos
 < 0 ||…o > sŒ->
¦’


2604 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2606 ià(0 =ğ
¥l™SŒ
->
¦’
) {

2607 
i
=
pos
; i < 
¡r
->
¦’
; i++) {

2608 ià((
»t
 = 
	`cb
 (
·rm
, 
i
, 1)) < 0) „et;

2610  
BSTR_OK
;

2613 ià(
¥l™SŒ
->
¦’
 == 1)

2614  
	`b¥l™cb
 (
¡r
, 
¥l™SŒ
->
d©a
[0], 
pos
, 
cb
, 
·rm
);

2616 
i
=
p
=
pos
; i <ğ
¡r
->
¦’
 - 
¥l™SŒ
->slen; i++) {

2617 ià(0 =ğ
	`b¡r__memcmp
 (
¥l™SŒ
->
d©a
, 
¡r
->d©¨+ 
i
, s¶™SŒ->
¦’
)) {

2618 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
i
 -…)) < 0) „et;

2619 
i
 +ğ
¥l™SŒ
->
¦’
;

2620 
p
 = 
i
;

2623 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
¡r
->
¦’
 -…)) < 0) „et;

2624  
BSTR_OK
;

2625 
	}
}

2627 
	sg’B¡rLi¡
 {

2628 
b¡ršg
 
	mb
;

2629 
b¡rLi¡
 * 
	mbl
;

2632 
	$bscb
 (* 
·rm
, 
ofs
, 
Ën
) {

2633 
g’B¡rLi¡
 * 
g
 = (g’B¡rLi¡ *è
·rm
;

2634 ià(
g
->
bl
->
qty
 >ğg->bl->
mËn
) {

2635 
mËn
 = 
g
->
bl
->mlen * 2;

2636 
b¡ršg
 * 
tbl
;

2638 
g
->
bl
->
qty
 >ğ
mËn
) {

2639 ià(
mËn
 < 
g
->
bl
->mËnè 
BSTR_ERR
;

2640 
mËn
 += mlen;

2643 
tbl
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
g
->
bl
->
’Œy
,  (b¡ršgè* 
mËn
);

2644 ià(
tbl
 =ğ
NULL
è 
BSTR_ERR
;

2646 
g
->
bl
->
’Œy
 = 
tbl
;

2647 
g
->
bl
->
mËn
 = mlen;

2650 
g
->
bl
->
’Œy
[g->bl->
qty
] = 
	`bmid¡r
 (g->
b
, 
ofs
, 
Ën
);

2651 
g
->
bl
->
qty
++;

2652  
BSTR_OK
;

2653 
	}
}

2660 
b¡rLi¡
 * 
	$b¥l™
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
) {

2661 
g’B¡rLi¡
 
g
;

2663 ià(
¡r
 =ğ
NULL
 || sŒ->
d©a
 =ğNULL || sŒ->
¦’
 < 0)  NULL;

2665 
g
.
bl
 = (
b¡rLi¡
 *è
	`b¡r__®loc
 ( (bstrList));

2666 ià(
g
.
bl
 =ğ
NULL
)  NULL;

2667 
g
.
bl
->
mËn
 = 4;

2668 
g
.
bl
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (g.bl->
mËn
 *  (bstring));

2669 ià(
NULL
 =ğ
g
.
bl
->
’Œy
) {

2670 
	`b¡r__ä“
 (
g
.
bl
);

2671  
NULL
;

2674 
g
.
b
 = (
b¡ršg
è
¡r
;

2675 
g
.
bl
->
qty
 = 0;

2676 ià(
	`b¥l™cb
 (
¡r
, 
¥l™Ch¬
, 0, 
bscb
, &
g
) < 0) {

2677 
	`b¡rLi¡De¡roy
 (
g
.
bl
);

2678  
NULL
;

2680  
g
.
bl
;

2681 
	}
}

2688 
b¡rLi¡
 * 
	$b¥l™¡r
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
) {

2689 
g’B¡rLi¡
 
g
;

2691 ià(
¡r
 =ğ
NULL
 || sŒ->
d©a
 =ğNULL || sŒ->
¦’
 < 0)  NULL;

2693 
g
.
bl
 = (
b¡rLi¡
 *è
	`b¡r__®loc
 ( (bstrList));

2694 ià(
g
.
bl
 =ğ
NULL
)  NULL;

2695 
g
.
bl
->
mËn
 = 4;

2696 
g
.
bl
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (g.bl->
mËn
 *  (bstring));

2697 ià(
NULL
 =ğ
g
.
bl
->
’Œy
) {

2698 
	`b¡r__ä“
 (
g
.
bl
);

2699  
NULL
;

2702 
g
.
b
 = (
b¡ršg
è
¡r
;

2703 
g
.
bl
->
qty
 = 0;

2704 ià(
	`b¥l™¡rcb
 (
¡r
, 
¥l™SŒ
, 0, 
bscb
, &
g
) < 0) {

2705 
	`b¡rLi¡De¡roy
 (
g
.
bl
);

2706  
NULL
;

2708  
g
.
bl
;

2709 
	}
}

2717 
b¡rLi¡
 * 
	$b¥l™s
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
) {

2718 
g’B¡rLi¡
 
g
;

2720 iàĞ
¡r
 =ğ
NULL
 || sŒ->
¦’
 < 0 || sŒ->
d©a
 == NULL ||

2721 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0 || s¶™SŒ->
d©a
 == NULL)

2722  
NULL
;

2724 
g
.
bl
 = (
b¡rLi¡
 *è
	`b¡r__®loc
 ( (bstrList));

2725 ià(
g
.
bl
 =ğ
NULL
)  NULL;

2726 
g
.
bl
->
mËn
 = 4;

2727 
g
.
bl
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (g.bl->
mËn
 *  (bstring));

2728 ià(
NULL
 =ğ
g
.
bl
->
’Œy
) {

2729 
	`b¡r__ä“
 (
g
.
bl
);

2730  
NULL
;

2732 
g
.
b
 = (
b¡ršg
è
¡r
;

2733 
g
.
bl
->
qty
 = 0;

2735 ià(
	`b¥l™scb
 (
¡r
, 
¥l™SŒ
, 0, 
bscb
, &
g
) < 0) {

2736 
	`b¡rLi¡De¡roy
 (
g
.
bl
);

2737  
NULL
;

2739  
g
.
bl
;

2740 
	}
}

2742 #ià
defšed
 (
__TURBOC__
è&& !defšed (
__BORLANDC__
)

2743 #iâdeà
BSTRLIB_NOVSNP


2744 
	#BSTRLIB_NOVSNP


	)

2749 #ià
defšed
(
__WATCOMC__
è|| defšed(
_MSC_VER
)

2750 
	#exv¢´štf
(
r
,
b
,
n
,
f
,
a
è{¸ğ
	`_v¢´štf
 (b,n,f,a);}

	)

2752 #ifdeà
BSTRLIB_NOVSNP


2755 
	#exv¢´štf
(
r
,
b
,
n
,
f
,
a
è{
	`v¥rštf
 (b,f,a);„ = -1;}

	)

2756 
	#START_VSNBUFF
 (256)

	)

2759 #ià
defšed
(
__GNUC__
è&& !defšed(
__APPLE__
)

2762 
v¢´štf
 (*
buf
, 
size_t
 
couÁ
, cÚ¡ *
fÜm©
, 
va_li¡
 
¬g
);

2765 
	#exv¢´štf
(
r
,
b
,
n
,
f
,
a
è{¸ğ
	`v¢´štf
 (b,n,f,a);}

	)

2769 #ià!
defšed
 (
BSTRLIB_NOVSNP
)

2771 #iâdeà
START_VSNBUFF


2772 
	#START_VSNBUFF
 (16)

	)

2790 
	$bfÜm©a
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...) {

2791 
va_li¡
 
¬gli¡
;

2792 
b¡ršg
 
buff
;

2793 
n
, 
r
;

2795 ià(
b
 =ğ
NULL
 || 
fmt
 =ğNULL || b->
d©a
 =ğNULL || b->
mËn
 <= 0

2796 || 
b
->
¦’
 < 0 || b->¦’ > b->
mËn
è 
BSTR_ERR
;

2802 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))è< 
START_VSNBUFF
)‚ = START_VSNBUFF;

2803 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))) {

2804 
n
 = 1;

2805 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))è 
BSTR_ERR
;

2809 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

2810 
	`exv¢´štf
 (
r
, (*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
¬gli¡
);

2811 
	`va_’d
 (
¬gli¡
);

2813 
buff
->
d©a
[
n
] = () '\0';

2814 
buff
->
¦’
 = (è(
¡¾’
è((*èbuff->
d©a
);

2816 ià(
buff
->
¦’
 < 
n
) ;

2818 ià(
r
 > 
n
)‚ =„; n +=‚;

2820 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

2821 
	`bde¡roy
 (
buff
);

2822  
BSTR_ERR
;

2826 
r
 = 
	`bcÚÿt
 (
b
, 
buff
);

2827 
	`bde¡roy
 (
buff
);

2828  
r
;

2829 
	}
}

2838 
	$bassignfÜm©
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...) {

2839 
va_li¡
 
¬gli¡
;

2840 
b¡ršg
 
buff
;

2841 
n
, 
r
;

2843 ià(
b
 =ğ
NULL
 || 
fmt
 =ğNULL || b->
d©a
 =ğNULL || b->
mËn
 <= 0

2844 || 
b
->
¦’
 < 0 || b->¦’ > b->
mËn
è 
BSTR_ERR
;

2850 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))è< 
START_VSNBUFF
)‚ = START_VSNBUFF;

2851 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))) {

2852 
n
 = 1;

2853 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))è 
BSTR_ERR
;

2857 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

2858 
	`exv¢´štf
 (
r
, (*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
¬gli¡
);

2859 
	`va_’d
 (
¬gli¡
);

2861 
buff
->
d©a
[
n
] = () '\0';

2862 
buff
->
¦’
 = (è(
¡¾’
è((*èbuff->
d©a
);

2864 ià(
buff
->
¦’
 < 
n
) ;

2866 ià(
r
 > 
n
)‚ =„; n +=‚;

2868 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

2869 
	`bde¡roy
 (
buff
);

2870  
BSTR_ERR
;

2874 
r
 = 
	`bassign
 (
b
, 
buff
);

2875 
	`bde¡roy
 (
buff
);

2876  
r
;

2877 
	}
}

2886 
b¡ršg
 
	$bfÜm©
 (cÚ¡ * 
fmt
, ...) {

2887 
va_li¡
 
¬gli¡
;

2888 
b¡ršg
 
buff
;

2889 
n
, 
r
;

2891 ià(
fmt
 =ğ
NULL
)  NULL;

2897 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))è< 
START_VSNBUFF
)‚ = START_VSNBUFF;

2898 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))) {

2899 
n
 = 1;

2900 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, "")))  NULL;

2904 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

2905 
	`exv¢´štf
 (
r
, (*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
¬gli¡
);

2906 
	`va_’d
 (
¬gli¡
);

2908 
buff
->
d©a
[
n
] = () '\0';

2909 
buff
->
¦’
 = (è(
¡¾’
è((*èbuff->
d©a
);

2911 ià(
buff
->
¦’
 < 
n
) ;

2913 ià(
r
 > 
n
)‚ =„; n +=‚;

2915 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

2916 
	`bde¡roy
 (
buff
);

2917  
NULL
;

2921  
buff
;

2922 
	}
}

2944 
	$bvcfÜm©a
 (
b¡ršg
 
b
, 
couÁ
, cÚ¡ * 
fmt
, 
va_li¡
 
¬g
) {

2945 
n
, 
r
, 
l
;

2947 ià(
b
 =ğ
NULL
 || 
fmt
 =ğNULL || 
couÁ
 <ğ0 || b->
d©a
 == NULL

2948 || 
b
->
mËn
 <ğ0 || b->
¦’
 < 0 || b->¦’ > b->mËnè 
BSTR_ERR
;

2950 ià(
couÁ
 > (
n
 = 
b
->
¦’
 + couÁè+ 2è 
BSTR_ERR
;

2951 ià(
BSTR_OK
 !ğ
	`b®loc
 (
b
, 
n
 + 2)è 
BSTR_ERR
;

2953 
	`exv¢´štf
 (
r
, (*è
b
->
d©a
 + b->
¦’
, 
couÁ
 + 2, 
fmt
, 
¬g
);

2956 
l
 = 
b
->
¦’
;† <ğ
n
;†++) {

2957 ià('\0' =ğ
b
->
d©a
[
l
]) {

2958 
b
->
¦’
 = 
l
;

2959  
BSTR_OK
;

2966 
b
->
d©a
[b->
¦’
] = '\0';

2967 ià(
r
 > 
couÁ
 + 1) {

2968 
n
 = 
r
;

2970 
n
 = 
couÁ
 + count;

2971 ià(
couÁ
 > 
n
èÀğ
INT_MAX
;

2973 
n
 = -n;

2975 ià(
n
 > 
BSTR_ERR
-1)‚ = BSTR_ERR-1;

2976  
n
;

2977 
	}
}

	@src/bstr/bstrlib.h

15 #iâdeà
BSTRLIB_INCLUDE


16 
	#BSTRLIB_INCLUDE


	)

18 #ifdeà
__ılu¥lus


22 
	~<¡d¬g.h
>

23 
	~<¡ršg.h
>

24 
	~<lim™s.h
>

25 
	~<ùy³.h
>

27 #ià!
defšed
 (
BSTRLIB_VSNP_OK
è&& !defšed (
BSTRLIB_NOVSNP
)

28 #ià
defšed
 (
__TURBOC__
è&& !defšed (
__BORLANDC__
)

29 
	#BSTRLIB_NOVSNP


	)

33 
	#BSTR_ERR
 (-1)

	)

34 
	#BSTR_OK
 (0)

	)

35 
	#BSTR_BS_BUFF_LENGTH_GET
 (0)

	)

37 
gb¡ršg
 * 
	tb¡ršg
;

38 cÚ¡ 
	tgb¡ršg
 * 
	tcÚ¡_b¡ršg
;

41 
	#c¡r2b¡r
 
bäomc¡r


	)

42 
b¡ršg
 
bäomc¡r
 (cÚ¡ * 
¡r
);

43 
b¡ršg
 
bäomc¡¿Îoc
 (
mËn
, cÚ¡ * 
¡r
);

44 
b¡ršg
 
blk2b¡r
 (cÚ¡ * 
blk
, 
Ën
);

45 * 
b¡r2c¡r
 (
cÚ¡_b¡ršg
 
s
, 
z
);

46 
bc¡rä“
 (* 
s
);

47 
b¡ršg
 
b¡rıy
 (
cÚ¡_b¡ršg
 
b1
);

48 
bassign
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
);

49 
bassignmid¡r
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
);

50 
bassignc¡r
 (
b¡ršg
 
a
, cÚ¡ * 
¡r
);

51 
bassignblk
 (
b¡ršg
 
a
, cÚ¡ * 
s
, 
Ën
);

54 
bde¡roy
 (
b¡ršg
 
b
);

57 
b®loc
 (
b¡ršg
 
s
, 
Ën
);

58 
b®locmš
 (
b¡ršg
 
b
, 
Ën
);

61 
b¡ršg
 
bmid¡r
 (
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
);

64 
bcÚÿt
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
);

65 
bcÚch¬
 (
b¡ršg
 
b0
, 
c
);

66 
bÿtc¡r
 (
b¡ršg
 
b
, cÚ¡ * 
s
);

67 
bÿtblk
 (
b¡ršg
 
b
, cÚ¡ * 
s
, 
Ën
);

68 
bš£¹
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
fl
);

69 
bš£¹ch
 (
b¡ršg
 
s1
, 
pos
, 
Ën
, 
fl
);

70 
b»¶aû
 (
b¡ršg
 
b1
, 
pos
, 
Ën
, 
cÚ¡_b¡ršg
 
b2
, 
fl
);

71 
bd–‘e
 (
b¡ršg
 
s1
, 
pos
, 
Ën
);

72 
b£t¡r
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
);

73 
bŒunc
 (
b¡ršg
 
b
, 
n
);

76 
b¡ricmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

77 
b¡ºicmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
);

78 
bi£qÿ£Ëss
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

79 
bis¡emeqÿ£Ëssblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
);

80 
bi£q
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

81 
bis¡emeqblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
);

82 
bi£qc¡r
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
);

83 
bi£qc¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
);

84 
b¡rcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

85 
b¡ºcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
);

86 
bš¡r
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

87 
bš¡¼
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

88 
bš¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

89 
bš¡¼ÿ£Ëss
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

90 
b¡rch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
);

91 
b¡¼ch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
);

92 
	#b¡rchr
(
b
,
c
è
	`b¡rch½
 ((b), (c), 0)

	)

93 
	#b¡¼chr
(
b
,
c
è
	`b¡¼ch½
 ((b), (c), 
	`bËngth
(b)-1)

	)

94 
bšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

95 
bšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

96 
bnšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

97 
bnšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

98 
bfšd»¶aû
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
);

99 
bfšd»¶aûÿ£Ëss
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
);

102 
	sb¡rLi¡
 {

103 
	gqty
, 
	gmËn
;

104 
b¡ršg
 * 
	g’Œy
;

106 
b¡rLi¡
 * 
b¡rLi¡C»©e
 ();

107 
b¡rLi¡De¡roy
 (
b¡rLi¡
 * 
¦
);

108 
b¡rLi¡AÎoc
 (
b¡rLi¡
 * 
¦
, 
msz
);

109 
b¡rLi¡AÎocMš
 (
b¡rLi¡
 * 
¦
, 
msz
);

112 
b¡rLi¡
 * 
b¥l™
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
);

113 
b¡rLi¡
 * 
b¥l™s
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
);

114 
b¡rLi¡
 * 
b¥l™¡r
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
);

115 
b¡ršg
 
bjoš
 (cÚ¡ 
b¡rLi¡
 * 
bl
, 
cÚ¡_b¡ršg
 
£p
);

116 
b¥l™cb
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
, 
pos
,

117 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm);

118 
b¥l™scb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

119 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm);

120 
b¥l™¡rcb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

121 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm);

124 
b·‰”n
 (
b¡ršg
 
b
, 
Ën
);

125 
btouµ”
 (
b¡ršg
 
b
);

126 
btŞow”
 (
b¡ršg
 
b
);

127 
bÉrimws
 (
b¡ršg
 
b
);

128 
b¹rimws
 (
b¡ršg
 
b
);

129 
bŒimws
 (
b¡ršg
 
b
);

132 #ià!
defšed
 (
BSTRLIB_NOVSNP
)

133 
b¡ršg
 
bfÜm©
 (cÚ¡ * 
fmt
, ...);

134 
bfÜm©a
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...);

135 
bassignfÜm©
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...);

136 
bvcfÜm©a
 (
b¡ršg
 
b
, 
couÁ
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gli¡
);

138 
	#bvfÜm©a
(
»t
, 
b
, 
fmt
, 
Ï¡¬g
è{ \

	)

139 
b¡ršg
 
	gb¡¹mp_b
 = (
b
); \

140 cÚ¡ * 
	gb¡¹mp_fmt
 = (
fmt
); \

141 
	gb¡¹mp_r
 = 
BSTR_ERR
, 
	gb¡¹mp_sz
 = 16; \

143 
va_li¡
 
	gb¡¹mp_¬gli¡
; \

144 
va_¡¬t
 (
b¡¹mp_¬gli¡
, 
Ï¡¬g
); \

145 
	gb¡¹mp_r
 = 
bvcfÜm©a
 (
b¡¹mp_b
, 
b¡¹mp_sz
, 
b¡¹mp_fmt
, 
b¡¹mp_¬gli¡
); \

146 
va_’d
 (
b¡¹mp_¬gli¡
); \

147 ià(
	gb¡¹mp_r
 >= 0) { \

148 
b¡¹mp_r
 = 
BSTR_OK
; \

150 } ià(-
	gb¡¹mp_r
 <ğ
b¡¹mp_sz
) { \

151 
b¡¹mp_r
 = 
BSTR_ERR
; \

154 
	gb¡¹mp_sz
 = -
b¡¹mp_r
; \

156 
	g»t
 = 
b¡¹mp_r
; \

161 (*
	gbNg‘c
è(*
	t·rm
);

162 
size_t
 (* 
	tbN»ad
è(*
	tbuff
, 
	tsize_t
 
	t–size
, size_ˆ
	tÃËm
, *
	t·rm
);

165 
b¡ršg
 
bg‘s
 (
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
);

166 
b¡ršg
 
b»ad
 (
bN»ad
 
»adPŒ
, * 
·rm
);

167 
bg‘§
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
);

168 
bassigng‘s
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
);

169 
b»ada
 (
b¡ršg
 
b
, 
bN»ad
 
»adPŒ
, * 
·rm
);

172 
bSŒ—m
 * 
bsİ’
 (
bN»ad
 
»adPŒ
, * 
·rm
);

173 * 
bsşo£
 (
bSŒ—m
 * 
s
);

174 
bsbufæ’gth
 (
bSŒ—m
 * 
s
, 
sz
);

175 
b¤—dÊ
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
);

176 
b¤—dÊs
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
);

177 
b¤—d
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
n
);

178 
b¤—dÊa
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
);

179 
b¤—dÊ§
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
);

180 
b¤—da
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
n
);

181 
bsuÄ—d
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
b
);

182 
b¥“k
 (
b¡ršg
 
r
, cÚ¡ 
bSŒ—m
 * 
s
);

183 
bs¥l™scb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

184 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm);

185 
bs¥l™¡rcb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

186 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm);

187 
b£of
 (cÚ¡ 
bSŒ—m
 * 
s
);

189 
	sgb¡ršg
 {

190 
	gmËn
;

191 
	g¦’
;

192 * 
	gd©a
;

196 
	#bËngthe
(
b
, 
e
è(((bè=ğ(*)0 || (b)->
¦’
 < 0è? ()Óè: ((b)->¦’))

	)

197 
	#bËngth
(
b
è(
	`bËngthe
 ((b), 0))

	)

198 
	#bd©aof£
(
b
, 
o
, 
e
è(((bè=ğ(*)0 || (b)->
d©a
 =ğ(*)0è? (*)Óè: ((*)(b)->d©aè+ (o))

	)

199 
	#bd©aofs
(
b
, 
o
è(
	`bd©aof£
 ((b), (o), (*)0))

	)

200 
	#bd©«
(
b
, 
e
è(
	`bd©aof£
 (b, 0,ƒ))

	)

201 
	#bd©a
(
b
è(
	`bd©aofs
 (b, 0))

	)

202 
	#bch¬e
(
b
, 
p
, 
e
è(((()Õ)è< ()
	`bËngth
(b)è? ((b)->
d©a
[Õ)]è: (e))

	)

203 
	#bch¬
(
b
, 
p
è
	`bch¬e
 ((b), (p), '\0')

	)

206 
	#bsSticMËn
(
q
,
m
è{(m), (è(q)-1, (*è("" q "")}

	)

207 #ià
defšed
(
_MSC_VER
)

209 
	#bsStic
(
q
è
	`bsSticMËn
(q,-32)

	)

211 #iâdeà
bsStic


212 
	#bsStic
(
q
è
	`bsSticMËn
(q,-
__LINE__
)

	)

216 
	#bsSticBlkP¬ms
(
q
è((*)("" q "")), ((è(q)-1)

	)

219 
	#c¡r2tb¡r
 
btäomc¡r


	)

220 
	#btäomc¡r
(
t
,
s
è{ \

	)

221 (
	gt
).
	gd©a
 = (*è(
s
); \

222 (
	gt
).
	g¦’
 = ((
t
).
d©a
è? ((è(
¡¾’
) ((*)(t).data)) : 0; \

223 (
	gt
).
	gmËn
 = -1; \

225 
	#blk2tb¡r
(
t
,
s
,
l
è{ \

	)

226 (
	gt
).
	gd©a
 = (*è(
s
); \

227 (
	gt
).
	g¦’
 = 
l
; \

228 (
	gt
).
	gmËn
 = -1; \

230 
	#btäomblk
(
t
,
s
,
l
è
	`blk2tb¡r
Ñ,s,l)

	)

231 
	#bmid2tb¡r
(
t
,
b
,
p
,
l
è{ \

	)

232 
cÚ¡_b¡ršg
 
	gb¡¹mp_s
 = (
b
); \

233 ià(
	gb¡¹mp_s
 && b¡¹mp_s->
	gd©a
 && b¡¹mp_s->
	g¦’
 >= 0) { \

234 
b¡¹mp_Ëá
 = (
p
); \

235 
	gb¡¹mp_Ën
 = (
l
); \

236 ià(
	gb¡¹mp_Ëá
 < 0) { \

237 
	gb¡¹mp_Ën
 +ğ
b¡¹mp_Ëá
; \

238 
	gb¡¹mp_Ëá
 = 0; \

240 ià(
	gb¡¹mp_Ën
 > 
	gb¡¹mp_s
->
	g¦’
 - 
	gb¡¹mp_Ëá
) \

241 
	gb¡¹mp_Ën
 = 
b¡¹mp_s
->
¦’
 - 
b¡¹mp_Ëá
; \

242 ià(
	gb¡¹mp_Ën
 <= 0) { \

243 (
t
).
d©a
 = (*)""; \

244 (
	gt
).
	g¦’
 = 0; \

246 (
	gt
).
	gd©a
 = 
b¡¹mp_s
->
d©a
 + 
b¡¹mp_Ëá
; \

247 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
; \

250 (
	gt
).
	gd©a
 = (*)""; \

251 (
	gt
).
	g¦’
 = 0; \

253 (
	gt
).
	gmËn
 = -
__LINE__
; \

255 
	#btäomblkÉrimws
(
t
,
s
,
l
è{ \

	)

256 
	gb¡¹mp_idx
 = 0, 
	gb¡¹mp_Ën
 = (
l
); \

257 * 
	gb¡¹mp_s
 = (
s
); \

258 ià(
	gb¡¹mp_s
 && 
	gb¡¹mp_Ën
 >= 0) { \

259 ; 
	gb¡¹mp_idx
 < 
	gb¡¹mp_Ën
; bstrtmp_idx++) { \

260 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_idx
])) ; \

263 (
	gt
).
	gd©a
 = 
b¡¹mp_s
 + 
b¡¹mp_idx
; \

264 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
 - 
b¡¹mp_idx
; \

265 (
	gt
).
	gmËn
 = -
__LINE__
; \

267 
	#btäomblk¹rimws
(
t
,
s
,
l
è{ \

	)

268 
	gb¡¹mp_Ën
 = (
l
) - 1; \

269 * 
	gb¡¹mp_s
 = (
s
); \

270 ià(
	gb¡¹mp_s
 && 
	gb¡¹mp_Ën
 >= 0) { \

271 ; 
	gb¡¹mp_Ën
 >= 0; bstrtmp_len--) { \

272 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_Ën
])) ; \

275 (
	gt
).
	gd©a
 = 
b¡¹mp_s
; \

276 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
 + 1; \

277 (
	gt
).
	gmËn
 = -
__LINE__
; \

279 
	#btäomblkŒimws
(
t
,
s
,
l
è{ \

	)

280 
	gb¡¹mp_idx
 = 0, 
	gb¡¹mp_Ën
 = (
l
) - 1; \

281 * 
	gb¡¹mp_s
 = (
s
); \

282 ià(
	gb¡¹mp_s
 && 
	gb¡¹mp_Ën
 >= 0) { \

283 ; 
	gb¡¹mp_idx
 <ğ
b¡¹mp_Ën
; bstrtmp_idx++) { \

284 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_idx
])) ; \

286 ; 
	gb¡¹mp_Ën
 >ğ
b¡¹mp_idx
; bstrtmp_len--) { \

287 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_Ën
])) ; \

290 (
	gt
).
	gd©a
 = 
b¡¹mp_s
 + 
b¡¹mp_idx
; \

291 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
 + 1 - 
b¡¹mp_idx
; \

292 (
	gt
).
	gmËn
 = -
__LINE__
; \

296 
	#bwr™•rÙeù
(
t
è{ ià(Ñ).
mËn
 >ğ0èÑ).mËÀğ-1; }

	)

297 
	#bwr™—Îow
(
t
è{ ià(Ñ).
mËn
 =ğ-1èÑ).mËÀğÑ).
¦’
 + (Ñ).¦’ =ğ0); }

	)

298 
	#biswr™•rÙeùed
(
t
è(Ñ).
mËn
 <ğ0)

	)

300 #ifdeà
__ılu¥lus


	@src/bstring.h

35 #iâdeà
_b¡ršg_h


36 
	#_b¡ršg_h


	)

38 
	~<b¡r/b¡¾ib.h
>

39 
	~<b¡r/b¡¿ux.h
>

	@src/cache.c

35 
	~"ÿche.h
"

37 
	~<¡dio.h
>

38 
	~<¡dlib.h
>

39 
	~<lim™s.h
>

41 
	~"dbg.h
"

43 
Cache
 *
	$Cache_ü—‹
(
size
, 
ÿche_lookup_cb
 
lookup
, 
ÿche_eviù_cb
 
eviù
)

45 
Cache
 *
ÿche
 = 
NULL
;

46 
size_t
 
exŒa_size
 = 0;

47 
i
 = 0;

49 
	`check
(
lookup
, "lookup…assedo cache_create is NULL");

51 if(
size
 > 
MIN_CACHE_SIZE
) {

52 
exŒa_size
 = (
size
 - 
MIN_CACHE_SIZE
è* (
ÿche_’Œy
);

55 
ÿche
 = 
	`ÿÎoc
((
Cache
è+ 
exŒa_size
, 1);

56 
	`check_mem
(
ÿche
);

58 
ÿche
->
size
 = size;

59 
ÿche
->
lookup
 =†ookup;

60 
ÿche
->
eviù
 =ƒvict;

62 
i
 = 0; i < 
size
; i++) {

63 
ÿche
->
¬r
[
i
].
g
 = 
INT_MAX
;

66  
ÿche
;

68 
”rÜ
:

69  
NULL
;

70 
	}
}

72 
	$Cache_de¡roy
(
Cache
 *
ÿche
)

74 
i
 = 0;

75 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_destroy");

77 if(
ÿche
->
eviù
) {

78 
i
 = 0; i < 
ÿche
->
size
; i++) {

79 if(
ÿche
->
¬r
[
i
].
d©a
) {

80 
ÿche
->
	`eviù
(ÿche->
¬r
[
i
].
d©a
);

85 
	`ä“
(
ÿche
);

87 
”rÜ
:

89 
	}
}

91 *
	$Cache_lookup
(
Cache
 *
ÿche
, *
key
)

93 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_lookup");

95 *
rd©a
 = 
NULL
;

96 
i
 = 0;

98 
i
 = 0; i < 
ÿche
->
size
; i++) {

99 if(
ÿche
->
¬r
[
i
].
g
 > 0) {

100 
ÿche
->
¬r
[
i
].
g
--;

103 
rd©a
 = 
ÿche
->
¬r
[
i
].
d©a
;

105 if(
rd©a
 && 
ÿche
->
	`lookup
Ôd©a, 
key
)) {

106 
ÿche
->
¬r
[
i
].
g
 = 
INT_MAX
;

109 
rd©a
 = 
NULL
;

112 
i
 = i + 1; i < 
ÿche
->
size
; i++) {

113 if(
ÿche
->
¬r
[
i
].
g
 > 0) {

114 
ÿche
->
¬r
[
i
].
g
--;

118  
rd©a
;

120 
”rÜ
:

121  
NULL
;

122 
	}
}

124 
	$Cache_add
(
Cache
 *
ÿche
, *
d©a
)

126 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_add");

127 
	`check
(
d©a
, "Cannot‡dd NULL‡s datao cache");

129 
i
 = 0;

130 
mš_idx
 = 0;

131 
mš_g
 = 
ÿche
->
¬r
[
mš_idx
].
g
;

133 if(
ÿche
->
¬r
[0].
g
 > 0) {

134 
ÿche
->
¬r
[0].
g
--;

137 
i
 = 1; i < 
ÿche
->
size
; i++) {

138 if(
ÿche
->
¬r
[
i
].
g
 < 
mš_g
) {

139 
mš_g
 = 
ÿche
->
¬r
[
i
].
g
;

140 
mš_idx
 = 
i
;

143 if(
ÿche
->
¬r
[
i
].
g
 > 0) {

144 
ÿche
->
¬r
[
i
].
g
--;

148 if(
ÿche
->
¬r
[
mš_idx
].
d©a
 && cache->
eviù
) {

149 
ÿche
->
	`eviù
(ÿche->
¬r
[
mš_idx
].
d©a
);

152 
ÿche
->
¬r
[
mš_idx
].
d©a
 = data;

153 
ÿche
->
¬r
[
mš_idx
].
g
 = 
INT_MAX
;

155 
”rÜ
:

157 
	}
}

159 
	$Cache_eviù_objeù
(
Cache
 *
ÿche
, *
obj
)

161 
i
 = 0;

163 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_evict_object");

164 
	`check
(
obj
, "NULL obj‡rgumento Cache_evict_object");

166 
i
 = 0; i < 
ÿche
->
size
; i++) {

167 if(
ÿche
->
¬r
[
i
].
d©a
 =ğ
obj
) {

168 if(
ÿche
->
eviù
) {

169 
ÿche
->
	`eviù
(ÿche->
¬r
[
i
].
d©a
);

172 
ÿche
->
¬r
[
i
].
d©a
 = 
NULL
;

173 
ÿche
->
¬r
[
i
].
g
 = 0;

177 
”rÜ
:

179 
	}
}

	@src/cache.h

1 #iâdeà
_CACHE_H


2 
	#_CACHE_H


	)

4 
	#MIN_CACHE_SIZE
 16

	)

7 (*
	tÿche_lookup_cb
)(*
	td©a
, *
	tkey
);

8 (*
	tÿche_eviù_cb
)(*
	td©a
);

10 
	sÿche_’Œy
 {

11 
g
;

12 *
d©a
;

15 
	sCache
 {

16 
ÿche_lookup_cb
 
lookup
;

17 
ÿche_eviù_cb
 
eviù
;

18 
size
;

21 
ÿche_’Œy
 
¬r
[
MIN_CACHE_SIZE
];

22 } 
	tCache
;

24 
Cache
 *
	`Cache_ü—‹
(
size
, 
ÿche_lookup_cb
 
lookup
, 
ÿche_eviù_cb
 
eviù
);

25 
	`Cache_de¡roy
(
Cache
 *
ÿche
);

26 *
	`Cache_lookup
(
Cache
 *
ÿche
, *
key
);

27 
	`Cache_add
(
Cache
 *
ÿche
, *
d©a
);

28 
	`Cache_eviù_objeù
(
Cache
 *
ÿche
, *
obj
);

	@src/config/config.c

34 
	~"cÚfig/cÚfig.h
"

36 
	~<as£¹.h
>

37 
	~<¡d¬g.h
>

38 
	~<¡dlib.h
>

39 
	~<¡ršg.h
>

40 
	~<sigÇl.h
>

42 
	~<sql™e3.h
>

44 
	~"adt/t¡.h
"

45 
	~"dœ.h
"

46 
	~"dbg.h
"

47 
	~"mime.h
"

48 
	~"´oxy.h
"

49 
	~"£rv”.h
"

50 
	~"£‰šg.h
"

51 
	~"cÚfig/moduË.h
"

52 
	~"cÚfig/db.h
"

53 
	~<dlfú.h
>

56 
HªdËr
 *
	$CÚfig_lßd_hªdËr
(
hªdËr_id
)

58 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_hªdËr
(
hªdËr_id
);

60 
	`DB_check
(
»s
, 0, 7,

61 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,ns_tag_string,

62 
Šs_g_¡ršg
, 
Šs_g_numb”
,ns_tag_string);

64 
HªdËr
 *
hªdËr
 = 
	`HªdËr_ü—‹
(

65 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

66 
	`DB_g‘_as
(
»s
, 0, 2, 
¡ršg
),

67 
	`DB_g‘_as
(
»s
, 0, 3, 
¡ršg
),

68 
	`DB_g‘_as
(
»s
, 0, 4, 
¡ršg
)

70 
	`check
(
hªdËr
 !ğ
NULL
, "FaedØü—‹ hªdË¸id %d.", 
hªdËr_id
);

72 if(
	`DB_g‘_as
(
»s
, 0, 5, 
numb”
) == 1) {

73 
hªdËr
->
¿w
 = 1;

76 if(
	`bi£qc¡r
(
	`DB_g‘_as
(
»s
, 0, 6, 
¡ršg
), "tnetstring")) {

77 
hªdËr
->
´ÙocŞ
 = 
HANDLER_PROTO_TNET
;

80 
	`log_šfo
("Loaded handler %d:%s:%s:%s:%s",

81 
hªdËr_id
, 
	`bd©a
(
hªdËr
->
£nd_¥ec
),

82 
	`bd©a
(
hªdËr
->
£nd_id’t
),

83 
	`bd©a
(
hªdËr
->
»cv_¥ec
),

84 
	`bd©a
(
hªdËr
->
»cv_id’t
));

86 
	`Šs_v®ue_de¡roy
(
»s
);

87  
hªdËr
;

88 
”rÜ
:

89 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

90  
NULL
;

91 
	}
}

94 
Proxy
 *
	$CÚfig_lßd_´oxy
(
´oxy_id
)

96 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_´oxy
(
´oxy_id
);

98 
	`DB_check
(
»s
, 0, 3,

99 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_number);

101 
Proxy
 *
´oxy
 = 
	`Proxy_ü—‹
(

102 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

103 
	`DB_g‘_as
(
»s
, 0, 2, 
numb”
)

105 
	`check
(
´oxy
 !ğ
NULL
, "FaedØü—‹…roxy w™h id %d.", 
´oxy_id
);

107 
	`log_šfo
("Loaded…roxy %d:%s:%d",

108 
´oxy_id
, 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

110 
	`Šs_v®ue_de¡roy
(
»s
);

111  
´oxy
;

112 
”rÜ
:

113 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

114  
NULL
;

115 
	}
}

118 
Dœ
 *
	$CÚfig_lßd_dœ
(
dœ_id
)

120 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_dœ
(
dœ_id
);

122 
	`DB_check
(
»s
, 0, 5,

123 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,

124 
Šs_g_¡ršg
, 
Šs_g_numb”
);

126 
Dœ
 *
dœ
 = 
	`Dœ_ü—‹
(

127 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

128 
	`DB_g‘_as
(
»s
, 0, 2, 
¡ršg
),

129 
	`DB_g‘_as
(
»s
, 0, 3, 
¡ršg
),

130 
	`DB_g‘_as
(
»s
, 0, 4, 
numb”
)

132 
	`check
(
dœ
 !ğ
NULL
, "FaedØü—‹ dœeùÜy id %d.", 
dœ_id
);

134 
	`log_šfo
("Loaded directory %d:%s:%s",

135 
dœ_id
, 
	`bd©a
(
dœ
->
ba£
), bd©a(dœ->
šdex_fe
));

137 
	`Šs_v®ue_de¡roy
(
»s
);

138  
dœ
;

139 
”rÜ
:

140 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

141  
NULL
;

142 
	}
}

144 
šlše
 
HªdËr
 *
	$CÚfig_push_unique_hªdËr
(
S”v”
 *
¤v
, 
HªdËr
 *
hªdËr
)

146 
i
 = 0;

151 
i
 = 0; i < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); i++) {

152 
HªdËr
 *
‹¡
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
i
);

153 
§me_£nd
 = 
	`bi£q
(
‹¡
->
£nd_¥ec
, 
hªdËr
->send_spec);

154 
§me_»cv
 = 
	`bi£q
(
‹¡
->
»cv_¥ec
, 
hªdËr
->recv_spec);

156 if(
§me_£nd
 && 
§me_»cv
) {

157 
	`HªdËr_de¡roy
(
hªdËr
);

159  
‹¡
;

160 } if(
§me_£nd
) {

161 
	`log_w¬n
("You havewo handlers withhe same send_spec: %s",

162 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

163 } if(
§me_»cv
) {

164 
	`log_w¬n
("You havewo handlers withhe same„ecv_spec: %s",

165 
	`bd©a
(
hªdËr
->
»cv_¥ec
));

171 
	`d¬¿y_push
(
¤v
->
hªdËrs
, 
hªdËr
);

172  
hªdËr
;

173 
	}
}

175 
	$CÚfig_lßd_rou‹s
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
, 
ho¡_id
, 
£rv”_id
)

177 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_rou‹s
(
ho¡_id
, 
£rv”_id
);

178 
cŞs
 = 0;

179 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

180 
row_i
 = 0;

181 
rc
 = 0;

183 if(
rows
 == 0) {

184 
	`log_w¬n
("Server has‚o„outes, it won't do‡nything without‡t†east one.");

185 
	`Šs_v®ue_de¡roy
(
»s
);

189 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

190 
	`DB_check
(
»s
, 
row_i
, 4,

191 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_number,ns_tag_string);

193 
rou‹_id
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 0, 
numb”
);

194 
b¡ršg
 
·th
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 1, 
¡ršg
);

195 
id
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 2, 
numb”
);

196 
b¡ršg
 
ty³
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 3, 
¡ršg
);

197 *
rg‘
 = 
NULL
;

198 
Back’dTy³
 
back’d_ty³
 = 0;

200 if(
	`bi£qc¡r
(
ty³
, "dir")) {

201 
rg‘
 = 
	`CÚfig_lßd_dœ
(
id
);

202 
back’d_ty³
 = 
BACKEND_DIR
;

203 } if(
	`bi£qc¡r
(
ty³
, "proxy")) {

204 
rg‘
 = 
	`CÚfig_lßd_´oxy
(
id
);

205 
back’d_ty³
 = 
BACKEND_PROXY
;

206 } if(
	`bi£qc¡r
(
ty³
, "handler")) {

207 
HªdËr
 *
‹mp
 = 
	`CÚfig_lßd_hªdËr
(
id
);

208 
rg‘
 = 
	`CÚfig_push_unique_hªdËr
(
¤v
, 
‹mp
);

209 
	`check
(
rg‘
 !ğ
NULL
, "Fau»…ushšg hªdË¸%d:%s.", 
id
, 
	`bd©a
(
·th
));

210 
back’d_ty³
 = 
BACKEND_HANDLER
;

212 
	`£Áš–
("Invalid backendype: %s for„oute %d:%s.",

213 
	`bd©a
(
ty³
), 
rou‹_id
, bd©a(
·th
));

216 
	`check
(
rg‘
 !ğ
NULL
, "Failedo†oad backendype: %s for„oute %d:%s.",

217 
	`bd©a
(
ty³
), 
rou‹_id
, bd©a(
·th
));

220 
rc
 = 
	`Ho¡_add_back’d
(
ho¡
, 
·th
, 
back’d_ty³
, 
rg‘
);

221 
	`check
(
rc
 == 0, "Failedo‡dd„oute %so host %s.",

222 
	`bd©a
(
·th
), bd©a(
ho¡
->
Çme
));

224 
	`log_šfo
("Loaded„oute %d:%s:%s for host %d:%s",

225 
rou‹_id
, 
	`bd©a
(
·th
), bd©a(
ty³
),

226 
ho¡_id
, 
	`bd©a
(
ho¡
->
Çme
));

229 
	`Šs_v®ue_de¡roy
(
»s
);

230  
row_i
;

232 
”rÜ
:

233 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

235 
	}
}

237 
	$CÚfig_lßd_ho¡s
(
S”v”
 *
¤v
, 
£rv”_id
)

239 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_ho¡s
(
£rv”_id
);

240 
cŞs
 = 0;

241 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

242 
row_i
 = 0;

243 
rc
 = 0;

245 if(
rows
 == 0) {

246 
	`log_w¬n
("No hosts configured for server, I hope you know what you're doing.");

247 
	`Šs_v®ue_de¡roy
(
»s
);

251 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

252 
	`DB_check
(
»s
, 
row_i
, 4,

253 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,ns_tag_number);

255 
Ho¡
 *
ho¡
 = 
	`Ho¡_ü—‹
(

256 
	`DB_g‘_as
(
»s
, 
row_i
, 1, 
¡ršg
),

257 
	`DB_g‘_as
(
»s
, 
row_i
, 2, 
¡ršg
)

259 
	`check_mem
(
ho¡
);

261 
ho¡_id
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 0, 
numb”
);

262 
rc
 = 
	`CÚfig_lßd_rou‹s
(
¤v
, 
ho¡
, 
ho¡_id
, 
£rv”_id
);

263 
	`check
(
rc
 !ğ-1, "FaedØlßd„ou‹ fÜ ho¡ %s.", 
	`bd©a
(
ho¡
->
Çme
));

265 
rc
 = 
	`S”v”_add_ho¡
(
¤v
, 
ho¡
);

266 
	`check
(
rc
 == 0, "Failedo‡dd host %s:%so server.",

267 
	`bd©a
(
ho¡
->
Çme
), bd©a(ho¡->
m©chšg
));

269 if(
	`bi£q
(
¤v
->
deçuÉ_ho¡Çme
, 
ho¡
->
Çme
)) {

270 
¤v
->
deçuÉ_ho¡
 = 
ho¡
;

274 
	`log_šfo
("Lßded %d ho¡ fÜ s”v” %d:%s", 
row_i
, 
£rv”_id
, 
	`bd©a
(
¤v
->
uuid
));

276 
	`Šs_v®ue_de¡roy
(
»s
);

279 
”rÜ
:

280 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

283 
	}
}

285 
S”v”
 *
	$CÚfig_lßd_£rv”
(cÚ¡ *
uuid
)

287 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_£rv”
(
uuid
);

288 
rc
 = 0;

290 
	`DB_check
(
»s
, 0, 10,

291 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,ns_tag_string,ns_tag_number,

292 
Šs_g_¡ršg
,ns_g_¡ršg,ns_g_¡ršg,ns_g_¡ršg, 
Šs_g_numb”
);

294 
£rv”_id
 = 
	`DB_g‘_as
(
»s
, 0, 0, 
numb”
);

296 
S”v”
 *
¤v
 = 
	`S”v”_ü—‹
(

297 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

298 
	`DB_g‘_as
(
»s
, 0, 2, 
¡ršg
),

299 
	`DB_g‘_as
(
»s
, 0, 3, 
¡ršg
),

300 
	`DB_g‘_as
(
»s
, 0, 4, 
numb”
),

301 
	`DB_g‘_as
(
»s
, 0, 5, 
¡ršg
),

302 
	`DB_g‘_as
(
»s
, 0, 6, 
¡ršg
),

303 
	`DB_g‘_as
(
»s
, 0, 7, 
¡ršg
),

304 
	`DB_g‘_as
(
»s
, 0, 8, 
¡ršg
),

305 
	`DB_g‘_as
(
»s
, 0, 9, 
numb”
)

307 
	`check
(
¤v
 !ğ
NULL
, "FaedØü—‹ s”v” %s", 
uuid
);

310 
rc
 = 
	`CÚfig_lßd_ho¡s
(
¤v
, 
£rv”_id
);

311 
	`check
(
rc
 =ğ0, "FaedØlßdhho¡ fÜ s”v”: %s", 
	`bd©a
(
¤v
->
uuid
));

313 
	`Šs_v®ue_de¡roy
(
»s
);

314  
¤v
;

316 
”rÜ
:

317 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

318  
NULL
;

319 
	}
}

322 
sim¶e_qu”y_run
(
Šs_v®ue_t
 *
»s
,

323 (*
ÿÎback
)(cÚ¡ *
key
, cÚ¡ *
v®ue
))

325 
row_i
 = 0;

326 
cŞs
 = 0;

327 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

328 
	`check
(
rows
 != -1, "Results‡re‚ot‡able.");

330 if(
rows
 > 0) {

331 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

332 
	`DB_check
(
»s
, 
row_i
, 3,

333 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string);

335 
b¡ršg
 
key
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 1, 
¡ršg
);

336 
b¡ršg
 
v®ue
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 2, 
¡ršg
);

338 
rc
 = 
	`ÿÎback
(
	`bd©a
(
key
), bd©a(
v®ue
));

339 
	`check_debug
(
rc
 == 0, "Load callback failed.");

343  
row_i
;

344 
”rÜ
:

346 
	}
}

348 
	$CÚfig_lßd_mim‘y³s
()

350 
rc
 = -1;

351 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_mim‘y³s
();

352 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Wrongype,ƒxpected valid„ows.");

354 
rc
 = 
	`sim¶e_qu”y_run
(
»s
, 
MIME_add_ty³
);

355 
	`check
(
rc
 != -1, "Failed‡dding your settings,†ook‡t…reviousƒrrors for clues.");

357 
”rÜ
:

358 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

359  
rc
;

360 
	}
}

363 
	$CÚfig_lßd_£‰šgs
()

365 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_£‰šgs
();

366 
rc
 = -1;

367 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Wrongype,ƒxpected valid„ows.");

368 
rc
 = 
	`sim¶e_qu”y_run
(
»s
, 
S‘tšg_add
);

369 
	`check
(
rc
 != -1, "Failed‡dding your settings,†ook‡t…reviousƒrrors for clues.");

371 
”rÜ
:

372 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

373  
rc
;

374 
	}
}

376 
	$CÚfig_š™_db
(cÚ¡ *
·th
)

378  
CONFIG_MODULE
.
	`š™
(
·th
);

379 
	}
}

381 
	$CÚfig_şo£_db
()

383 
CONFIG_MODULE
.
	`şo£
();

384 
	}
}

386 
	#SET_MODULE_FUNC
(
N
è
CONFIG_MODULE
.N = 
	`dlsym
(
lib
, "config_" #N);\

387 
	`check
(
CONFIG_MODULE
.
N
 !ğ
NULL
, "CÚfig moduË % dÛ¢'ˆhavª " #N " funùiÚ.", 
lßd_·th
);

	)

390 
	$CÚfig_moduË_lßd
(cÚ¡ *
lßd_·th
)

392 *
lib
 = 
	`dlİ’
(
lßd_·th
, 
RTLD_LAZY
 | 
RTLD_LOCAL
);

393 
	`check
(
lib
 !ğ
NULL
, "FaedØlßd cÚfig moduË %s: %s.", 
lßd_·th
, 
	`dË¼Ü
());

395 
	`SET_MODULE_FUNC
(
š™
);

396 
	`SET_MODULE_FUNC
(
şo£
);

397 
	`SET_MODULE_FUNC
(
lßd_hªdËr
);

398 
	`SET_MODULE_FUNC
(
lßd_´oxy
);

399 
	`SET_MODULE_FUNC
(
lßd_dœ
);

400 
	`SET_MODULE_FUNC
(
lßd_rou‹s
);

401 
	`SET_MODULE_FUNC
(
lßd_ho¡s
);

402 
	`SET_MODULE_FUNC
(
lßd_£rv”
);

403 
	`SET_MODULE_FUNC
(
lßd_mim‘y³s
);

404 
	`SET_MODULE_FUNC
(
lßd_£‰šgs
);

407 
”rÜ
:

409 
	}
}

	@src/config/config.h

35 #iâdeà
__cÚfig_h__


36 
	#__cÚfig_h__


	)

38 
	~"£rv”.h
"

40 
CÚfig_š™_db
(cÚ¡ *
·th
);

42 
S”v”
 *
CÚfig_lßd_£rv”
(cÚ¡ *
uuid
);

44 
CÚfig_lßd_mim‘y³s
();

46 
CÚfig_lßd_£‰šgs
();

48 
CÚfig_şo£_db
();

50 
CÚfig_moduË_lßd
(cÚ¡ *
lßd_·th
);

	@src/config/db.c

35 
	~<¡dio.h
>

36 
	~<¡dlib.h
>

37 
	~<sql™e3.h
>

38 
	~"dbg.h
"

39 
	~"cÚfig/db.h
"

40 
	~"as£¹.h
"

41 
	~<¡d¬g.h
>

42 
	~"Š‘¡ršgs_im¶.h
"

44 
sql™e3
 *
	gCONFIG_DB
 = 
NULL
;

46 
	$DB_š™
(cÚ¡ *
·th
)

48 
	`check
(
CONFIG_DB
 =ğ
NULL
, "Must closehe config db first,ell Zed.");

49  
	`sql™e3_İ’
(
·th
, &
CONFIG_DB
);

50 
”rÜ
:

52 
	}
}

55 
	$DB_şo£
()

57 if(
CONFIG_DB
) {

58 
	`sql™e3_şo£
(
CONFIG_DB
);

59 
CONFIG_DB
 = 
NULL
;

61 
	}
}

64 
šlše
 
Šs_v®ue_t
 *
	$DB_cÚv”t_cŞumn
(
sql™e3_¡mt
 *
¡mt
)

66 
cŞ
 = 0;

67 
Šs_v®ue_t
 *
–
 = 
NULL
;

68 
Šs_v®ue_t
 *
row
 = 
	`Šs_Ãw_li¡
();

69 
	`check_mem
(
row
);

71 
cŞ
 = 0; cŞ < 
	`sql™e3_cŞumn_couÁ
(
¡mt
); col++) {

72 
	`sql™e3_cŞumn_ty³
(
¡mt
, 
cŞ
)) {

73 
SQLITE_INTEGER
:

74 
–
 = 
	`Šs_Ãw_š‹g”
(
	`sql™e3_cŞumn_št
(
¡mt
, 
cŞ
));

76 
SQLITE_FLOAT
:

77 
–
 = 
	`Šs_Ãw_æßt
(
	`sql™e3_cŞumn_doubË
(
¡mt
, 
cŞ
));

79 
SQLITE_TEXT
:

80 
–
 = 
	`Šs_·r£_¡ršg
(

81 (cÚ¡ *)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 
cŞ
),

82 
	`sql™e3_cŞumn_by‹s
(
¡mt
, 
cŞ
));

84 
SQLITE_BLOB
:

85 
–
 = 
	`Šs_·r£_¡ršg
(

86 
	`sql™e3_cŞumn_blob
(
¡mt
, 
cŞ
),

87 
	`sql™e3_cŞumn_by‹s
(
¡mt
, 
cŞ
));

89 
SQLITE_NULL
:

90 
–
 = 
	`Šs_g‘_nuÎ
();

96 
	`check
(
–
 !ğ
NULL
, "Got‡ NULL for‡ column");

97 
	`Šs_add_to_li¡
(
row
, 
–
);

100  
row
;

102 
”rÜ
:

103 if(
row
è
	`Šs_v®ue_de¡roy
(row);

104 if(
–
è
	`Šs_v®ue_de¡roy
(el);

105  
NULL
;

106 
	}
}

108 
	$DB_v®id_schema
(
Šs_v®ue_t
 *
»s
, 
row
, 
ncŞs
, ...)

110 
va_li¡
 
¬gp
;

111 
	`va_¡¬t
(
¬gp
, 
ncŞs
);

112 
i
 = 0;

114 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Invalid„esult set, must be‡†ist.");

115 
rows
 = 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
);

116 
	`check
(
rows
 != -1, "Result isn't in‡able format.");

117 
	`check
(
row
 < 
rows
, "Row is…astƒnd of„esult set: %d > %d",„ow,„ows);

120 
Šs_v®ue_t
 *
row_d©a
 = 
	`d¬¿y_g‘
(
»s
->
v®ue
.
li¡
, 
row
);

123 
	`check
(
	`Šs_g‘_ty³
(
row_d©a
è=ğ
Šs_g_li¡
, "Inv®id„ow %d, mu¡ b¨li¡.", 
row
);

124 
cŞs
 = 
	`d¬¿y_’d
(
row_d©a
->
v®ue
.
li¡
);

125 
	`check
(
cŞs
 =ğ
ncŞs
, "Expected %d columns, but„esult set has %d.", cols,‚cols);

127 
i
 = 0; i < 
ncŞs
; i++) {

128 
Šs_ty³_g
 
ex³ùšg
 = 
	`va_¬g
(
¬gp
,ns_type_tag);

129 
Šs_v®ue_t
 *
ûÎ
 = 
	`DB_g‘
(
»s
, 
row
, 
i
);

130 
	`check
(
	`Šs_g‘_ty³
(
ûÎ
è=ğ
ex³ùšg
,

131 "Row %d, CŞumÀ%d ha wrÚgy³.", 
row
, 
i
);

134 
	`va_’d
(
¬gp
);

136 
”rÜ
:

138 
	`va_’d
(
¬gp
);

140 
	}
}

155 
Šs_v®ue_t
 *
	$DB_exec
(cÚ¡ *
qu”y
, ...)

157 
va_li¡
 
¬gp
;

158 
	`va_¡¬t
(
¬gp
, 
qu”y
);

159 *
zE¼Msg
 = 
NULL
;

160 
Šs_v®ue_t
 *
»s
 = 
NULL
;

161 
rc
 = 0;

162 
sql™e3_¡mt
 *
¡mt
 = 
NULL
;

163 cÚ¡ *
sql_
 = 
NULL
;

164 *
sql
 = 
NULL
;

166 
	`check
(
CONFIG_DB
 !ğ
NULL
, "The config database is‚ot open.");

168 
sql
 = 
	`sql™e3_vm´štf
(
qu”y
, 
¬gp
);

169 
	`check_mem
(
sql
);

171 
rc
 = 
	`sql™e3_´•¬e_v2
(
CONFIG_DB
, 
sql
, -1, &
¡mt
, &
sql_
);

172 
	`check
(
rc
 =ğ
SQLITE_OK
, "SQLƒ¼Ü \"%s\"‡t: '%s'", 
	`sql™e3_”rmsg
(
CONFIG_DB
), 
sql_
);

176 
rc
 = 
	`sql™e3_¡•
(
¡mt
);

178 if(
rc
 =ğ
SQLITE_DONE
) {

179 if(
	`sql™e3_cŞumn_couÁ
(
¡mt
) == 0) {

181 
»s
 = 
	`Šs_g‘_nuÎ
();

184 
»s
 = 
	`Šs_Ãw_li¡
();

186 } if(
rc
 =ğ
SQLITE_ROW
) {

188 
»s
 = 
	`Šs_Ãw_li¡
();

191 
Šs_v®ue_t
 *
row
 = 
	`DB_cÚv”t_cŞumn
(
¡mt
);

192 
	`check
(
row
 !ğ
NULL
, "FaedØcÚv”ˆDB cŞumÀfÜ sql: '%s'", 
sql
);

193 
	`Šs_add_to_li¡
(
»s
, 
row
);

194 } (
rc
 = 
	`sql™e3_¡•
(
¡mt
)è=ğ
SQLITE_ROW
);

197 
	`check
(
rc
 !ğ
SQLITE_ERROR
, "Fau»ƒxecutšg sql: %s", 
	`sql™e3_”rmsg
(
CONFIG_DB
));

199 
	`sql™e3_ä“
(
sql
);

200 
	`sql™e3_fš®ize
(
¡mt
);

201 
	`va_’d
(
¬gp
);

202  
»s
;

204 
”rÜ
:

205 
	`va_’d
(
¬gp
);

206 if(
¡mt
è
	`sql™e3_fš®ize
(stmt);

207 if(
zE¼Msg
è
	`sql™e3_ä“
(zErrMsg);

208 if(
sql
è
	`sql™e3_ä“
(sql);

209 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

210  
NULL
;

211 
	}
}

218 
Šs_v®ue_t
 *
	$DB_g‘
(
Šs_v®ue_t
 *
»s
, 
row
, 
cŞ
)

220 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Result should be‡†ist.");

221 
	`check
(
row
 < 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
),

222 "Row %d…a¡ƒnd oà»suÉ s‘†’gth: %d", 
row
,

223 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
));

225 
Šs_v®ue_t
 *
r
 = 
	`d¬¿y_g‘
(
»s
->
v®ue
.
li¡
, 
row
);

226 
	`check
(
	`Šs_g‘_ty³
(
r
è=ğ
Šs_g_li¡
, "Row %d should b¨li¡.", 
row
);

227 
	`check
(
cŞ
 < 
	`d¬¿y_’d
(
r
->
v®ue
.
li¡
),

228 "CŞumÀ%d…a¡ƒnd oà»suÉ s‘†’gth: %d", 
cŞ
,

229 
	`d¬¿y_’d
(
r
->
v®ue
.
li¡
));

231  
	`d¬¿y_g‘
(
r
->
v®ue
.
li¡
, 
cŞ
);

232 
”rÜ
:

233  
NULL
;

234 
	}
}

242 
	$DB_couÁs
(
Šs_v®ue_t
 *
»s
, *
cŞs
)

244 
rows
 = 0;

246 if(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_nuÎ
) {

247 *
cŞs
 = 0;

249 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Result should get‡†ist.");

250 
rows
 = 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
);

252 if(
rows
) {

253 
Šs_v®ue_t
 *
fœ¡_row
 = 
	`d¬¿y_g‘
(
»s
->
v®ue
.
li¡
, 0);

254 
	`check
(
	`Šs_g‘_ty³
(
fœ¡_row
è=ğ
Šs_g_li¡
,

256 *
cŞs
 = 
	`d¬¿y_’d
(
fœ¡_row
->
v®ue
.
li¡
);

258 *
cŞs
 = 0;

262  
rows
;

263 
”rÜ
:

265 
	}
}

268 
	$DB_Ï¡id
()

270  ()
	`sql™e3_Ï¡_š£¹_rowid
(
CONFIG_DB
);

271 
	}
}

	@src/config/db.h

35 #iâdeà
_db_h


36 
	#_db_h


	)

38 
	~<sql™e3.h
>

39 
	~"Š‘¡ršgs.h
"

41 
DB_š™
(cÚ¡ *
·th
);

43 
DB_şo£
();

45 
Šs_v®ue_t
 *
DB_exec
(cÚ¡ *
qu”y
, ...);

47 
Šs_v®ue_t
 *
DB_g‘
Ñns_v®ue_ˆ*
»s
, 
row
, 
cŞ
);

49 
DB_couÁs
(
Šs_v®ue_t
 *
»s
, *
cŞs
);

51 
DB_v®id_schema
(
Šs_v®ue_t
 *
»s
, 
row
, 
ncŞs
, ...);

53 
DB_Ï¡id
();

55 
	#DB_g‘_as
(
RES
, 
ROW
, 
COL
, 
TYPE
è(
	`DB_g‘
((RES), (ROW), (COL))->
v®ue
.TYPE)

	)

57 
sql™e3
 *
CONFIG_DB
;

59 
	#DB_check
(
RES
, 
ROW
, 
COLS
, ...è
	`check
(
	`DB_v®id_schema
((RES), (ROW), (COLS), ##
__VA_ARGS__
), "Inv®id schem¨fÜ„ow, should be: " #__VA_ARGS__)

	)

	@src/config/module.c

35 
	~"cÚfig/moduË.h
"

36 
	~"cÚfig/db.h
"

38 
	$deçuÉ_š™
(cÚ¡ *
·th
)

40  
	`DB_š™
(
·th
);

41 
	}
}

43 
	$deçuÉ_şo£
()

45 
	`DB_şo£
();

46 
	}
}

48 
Šs_v®ue_t
 *
	$deçuÉ_lßd_hªdËr
(
hªdËr_id
)

50 cÚ¡ *
HANDLER_QUERY
 = "SELECT id, send_spec, send_ident,„ecv_spec,„ecv_ident,„aw_payload,…rotocol FROM handler WHERE id=%d";

51  
	`DB_exec
(
HANDLER_QUERY
, 
hªdËr_id
);

52 
	}
}

54 
Šs_v®ue_t
 *
	$deçuÉ_lßd_´oxy
(
´oxy_id
)

56 cÚ¡ *
PROXY_QUERY
 = "SELECT id,‡ddr,…ort FROM…roxy WHERE id=%d";

57  
	`DB_exec
(
PROXY_QUERY
, 
´oxy_id
);

58 
	}
}

60 
Šs_v®ue_t
 *
	$deçuÉ_lßd_dœ
(
dœ_id
)

62 cÚ¡ *
DIR_QUERY
 = "SELECT id, base, index_file, default_ctype, cache_ttl FROM directory WHERE id=%d";

63  
	`DB_exec
(
DIR_QUERY
, 
dœ_id
);

64 
	}
}

66 
Šs_v®ue_t
 *
	$deçuÉ_lßd_rou‹s
(
ho¡_id
, 
£rv”_id
)

68 cÚ¡ *
ROUTE_QUERY
 = "SELECT„oute.id,„oute.path,„oute.target_id,„oute.target_type "

72  
	`DB_exec
(
ROUTE_QUERY
, 
ho¡_id
, 
£rv”_id
);

73 
	}
}

75 
Šs_v®ue_t
 *
	$deçuÉ_lßd_ho¡s
(
£rv”_id
)

77 cÚ¡ *
HOST_QUERY
 = "SELECT id,‚ame, matching, server_id FROM host WHERE server_id = %d";

78  
	`DB_exec
(
HOST_QUERY
, 
£rv”_id
);

79 
	}
}

81 
Šs_v®ue_t
 *
	$deçuÉ_lßd_£rv”
(cÚ¡ *
uuid
)

83 cÚ¡ *
SERVER_QUERY
 = "SELECT id, uuid, default_host, bind_addr,…ort, chroot,‡ccess_log,ƒrror_log,…id_file, use_ssl FROM server WHERE uuid=%Q";

85  
	`DB_exec
(
SERVER_QUERY
, 
uuid
);

86 
	}
}

89 
Šs_v®ue_t
 *
	$deçuÉ_lßd_mim‘y³s
()

91 cÚ¡ *
MIME_QUERY
 = "SELECT id,ƒxtension, mimetype FROM mimetype";

92  
	`DB_exec
(
MIME_QUERY
);

93 
	}
}

95 
Šs_v®ue_t
 *
	$deçuÉ_lßd_£‰šgs
()

97 cÚ¡ *
SETTINGS_QUERY
 = "SELECT id, key, value FROM setting";

98  
	`DB_exec
(
SETTINGS_QUERY
);

99 
	}
}

102 
CÚfigModuË
 
	gCONFIG_MODULE
 = {

103 .
š™
 = 
deçuÉ_š™
,

104 .
	gşo£
 = 
deçuÉ_şo£
,

105 .
	glßd_hªdËr
 = 
deçuÉ_lßd_hªdËr
,

106 .
	glßd_´oxy
 = 
deçuÉ_lßd_´oxy
,

107 .
	glßd_dœ
 = 
deçuÉ_lßd_dœ
,

108 .
	glßd_rou‹s
 = 
deçuÉ_lßd_rou‹s
,

109 .
	glßd_ho¡s
 = 
deçuÉ_lßd_ho¡s
,

110 .
	glßd_£rv”
 = 
deçuÉ_lßd_£rv”
,

111 .
	glßd_mim‘y³s
 = 
deçuÉ_lßd_mim‘y³s
,

112 .
	glßd_£‰šgs
 = 
deçuÉ_lßd_£‰šgs


	@src/config/module.h

1 #iâdeà
_moduË_h


2 
	#_moduË_h


	)

4 
	~"Š‘¡ršgs.h
"

6 
	sCÚfigModuË
 {

7 (*
	mš™
)(cÚ¡ *
	m·th
);

8 (*
	mşo£
)();

9 
	mŠs_v®ue_t
 *(*
	mlßd_hªdËr
)(
	mhªdËr_id
);

10 
	mŠs_v®ue_t
 *(*
	mlßd_´oxy
)(
	m´oxy_id
);

11 
	mŠs_v®ue_t
 *(*
	mlßd_dœ
)(
	mdœ_id
);

12 
	mŠs_v®ue_t
 *(*
	mlßd_rou‹s
)(
	mho¡_id
, 
	m£rv”_id
);

13 
	mŠs_v®ue_t
 *(*
	mlßd_ho¡s
)(
	m£rv”_id
);

14 
	mŠs_v®ue_t
 *(*
	mlßd_£rv”
)(cÚ¡ *
	muuid
);

15 
	mŠs_v®ue_t
 *(*
	mlßd_mim‘y³s
)();

16 
	mŠs_v®ue_t
 *(*
	mlßd_£‰šgs
)();

17 } 
	tCÚfigModuË
;

19 
CÚfigModuË
 
CONFIG_MODULE
;

	@src/connection.c

35 
	~<as£¹.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

39 
	~"cÚÃùiÚ.h
"

40 
	~"h‰p11/h‰pş›Á_·r£r.h
"

41 
	~"dbg.h
"

42 
	~"ev’ts.h
"

43 
	~"»gi¡”.h
"

44 
	~"·‰”n.h
"

45 
	~"dœ.h
"

46 
	~"»¥Ú£.h
"

47 
	~"mem/h®loc.h
"

48 
	~"£‰šg.h
"

49 
	~"log.h
"

50 
	~"u¶ßd.h
"

51 
	~"f‹r.h
"

53 
gb¡ršg
 
	gPING_PATTERN
 = 
bsStic
("@[a-z/]- {\"type\":\\s*\"ping\"}");

55 
gb¡ršg
 
	gPOLICY_XML_REQUEST
 = 
bsStic
("<policy-file-request");

57 
	gMAX_CONTENT_LENGTH
 = 20 * 1024;

58 
	gBUFFER_SIZE
 = 4 * 1024;

59 
	gCONNECTION_STACK
 = 32 * 1024;

60 
	gCLIENT_READ_RETRIES
 = 5;

63 
šlše
 
	$CÚÃùiÚ_back’d_ev’t
(
Back’d
 *
found
, 
CÚÃùiÚ
 *
cÚn
)

65 
found
->
ty³
) {

66 
BACKEND_HANDLER
:

67  
HANDLER
;

68 
BACKEND_DIR
:

69  
DIRECTORY
;

70 
BACKEND_PROXY
:

71  
PROXY
;

73 
	`”rÜ_»¥Ú£
(
cÚn
, 501, "Inv®id back’dy³: %d", 
found
->
ty³
);

76 
”rÜ
:

77  
CLOSE
;

78 
	}
}

82 
	$cÚÃùiÚ_£nd_sock‘_»¥Ú£
(
CÚÃùiÚ
 *
cÚn
)

84 if(
	`Re¥Ú£_£nd_sock‘_pŞicy
(
cÚn
) > 0) {

85  
RESP_SENT
;

87  
CLOSE
;

89 
	}
}

92 
	$cÚÃùiÚ_rou‹_»que¡
(
CÚÃùiÚ
 *
cÚn
)

94 
Ho¡
 *
ho¡
 = 
NULL
;

95 
Rou‹
 *
rou‹
 = 
NULL
;

97 
b¡ršg
 
·th
 = 
	`Reque¡_·th
(
cÚn
->
»q
);

99 if(
cÚn
->
»q
->
ho¡_Çme
) {

100 
ho¡
 = 
	`S”v”_m©ch_back’d
(
cÚn
->
£rv”
, cÚn->
»q
->
ho¡_Çme
);

102 
ho¡
 = 
cÚn
->
£rv”
->
deçuÉ_ho¡
;

105 
	`”rÜ_uÆess
(
ho¡
, 
cÚn
, 404, "Reque¡ fÜ‡ ho¡ wdÚ'ˆhav»gi¡”ed: %s", 
	`bd©a
(cÚn->
»q
->
ho¡_Çme
));

107 
Back’d
 *
found
 = 
	`Ho¡_m©ch_back’d
(
ho¡
, 
·th
, &
rou‹
);

108 
	`”rÜ_uÆess
(
found
, 
cÚn
, 404, "HªdË¸nÙ found: %s", 
	`bd©a
(
·th
));

110 
	`Reque¡_£t_aùiÚ
(
cÚn
->
»q
, 
found
);

112 
cÚn
->
»q
->
rg‘_ho¡
 = 
ho¡
;

113 
cÚn
->
»q
->
·‰”n
 = 
rou‹
->pattern;

114 
cÚn
->
»q
->
´efix
 = 
rou‹
->prefix;

116  
	`CÚÃùiÚ_back’d_ev’t
(
found
, 
cÚn
);

118 
”rÜ
:

119  
CLOSE
;

120 
	}
}

124 
	$cÚÃùiÚ_msg_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
)

126 
HªdËr
 *
hªdËr
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
, handler);

127 
rc
 = 0;

128 
h—d”_Ën
 = 
	`Reque¡_h—d”_Ëngth
(
cÚn
->
»q
);

130 
body_Ën
 = 
	`Reque¡_cÚ‹Á_Ëngth
(
cÚn
->
»q
);

132 
	`check
(
hªdËr
, "JSON„equest doesn't match‡ny handler: %s",

133 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

135 if(
	`·‰”n_m©ch
(
	`IOBuf_¡¬t
(
cÚn
->
iob
), 
h—d”_Ën
 + 
body_Ën
, 
	`bd©a
(&
PING_PATTERN
))) {

136 
	`Regi¡”_pšg
(
	`IOBuf_fd
(
cÚn
->
iob
));

138 
	`check
(
body_Ën
 >= 0, "Parsingƒrror, body†engthƒnded up being: %d", body_len);

139 
b¡ršg
 
·ylßd
 = 
NULL
;

141 if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_TNET
) {

142 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

143 
	`IOBuf_fd
(
cÚn
->
iob
), 
	`IOBuf_¡¬t
(cÚn->iobè+ 
h—d”_Ën
,

144 
body_Ën
 - 1);

145 } if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_JSON
) {

146 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

147 
	`IOBuf_fd
(
cÚn
->
iob
), 
	`IOBuf_¡¬t
(cÚn->iobè+ 
h—d”_Ën
,

148 
body_Ën
 - 1);

150 
	`£Áš–
("Inv®id…rÙocŞy³: %d", 
hªdËr
->
´ÙocŞ
);

153 
	`debug
("SENT: %s", 
	`bd©a
(
·ylßd
));

154 
	`check
(
·ylßd
 !ğ
NULL
, "Failedo generate…ayload.");

155 
	`check
(
hªdËr
->
£nd_sock‘
 !ğ
NULL
, "Handler socket is NULL,ell Zed.");

157 
rc
 = 
	`HªdËr_d–iv”
(
hªdËr
->
£nd_sock‘
, 
	`bd©a
(
·ylßd
), 
	`bËngth
(payload));

158 
	`ä“
(
·ylßd
);

160 
	`check
(
rc
 =ğ0, "FaedØd–iv”ØhªdËr: %s", 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

164 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
iob
, 
h—d”_Ën
 + 
body_Ën
) != -1, "Final commit failed.");

166  
REQ_SENT
;

168 
”rÜ
:

169  
CLOSE
;

170 
	}
}

173 
	$CÚÃùiÚ_£nd_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, *
body
, 
cÚ‹Á_Ën
)

175 
rc
 = 0;

176 
b¡ršg
 
·ylßd
 = 
NULL
;

178 
	`”rÜ_uÆess
(
hªdËr
->
ruÂšg
, 
cÚn
, 502, "Handler shutdown whileryingo deliver: %s",

179 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

181 if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_TNET
) {

182 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

183 
	`IOBuf_fd
(
cÚn
->
iob
), 
body
, 
cÚ‹Á_Ën
);

184 } if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_JSON
) {

185 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

186 
	`IOBuf_fd
(
cÚn
->
iob
), 
body
, 
cÚ‹Á_Ën
);

188 
	`£Áš–
("Inv®id…rÙocŞy³: %d", 
hªdËr
->
´ÙocŞ
);

191 
	`debug
("SENT: %s", 
	`bd©a
(
·ylßd
));

192 
	`check
(
·ylßd
, "Failedo create…ayload for„equest.");

194 
	`debug
("HTTP TO HANDLER: %.*s", 
	`bËngth
(
·ylßd
è- 
cÚ‹Á_Ën
, 
	`bd©a
(payload));

196 
rc
 = 
	`HªdËr_d–iv”
(
hªdËr
->
£nd_sock‘
, 
	`bd©a
(
·ylßd
), 
	`bËngth
(payload));

197 
	`ä“
(
·ylßd
);…aylßd = 
NULL
;

199 
	`”rÜ_uÆess
(
rc
 !ğ-1, 
cÚn
, 502, "Failedo delivero handler: %s",

200 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

204 
”rÜ
:

205 if(
·ylßd
è
	`ä“
(payload);

207 
	}
}

210 
gb¡ršg
 
	gUPGRADE
 = 
bsStic
("upgrade");

211 
gb¡ršg
 
	gCONNECTION
 = 
bsStic
("connection");

212 cÚ¡ 
	gWEBSOCKET_ARBITRARY_BODY_SIZE
 = 8;

214 
šlše
 
	$is_websock‘
(
CÚÃùiÚ
 *
cÚn
)

216  
	`Reque¡_g‘
(
cÚn
->
»q
, &
UPGRADE
è!ğ
NULL
 &&

217 
	`Reque¡_g‘
(
cÚn
->
»q
, &
CONNECTION
è!ğ
NULL
;

218 
	}
}

220 
	$cÚÃùiÚ_h‰p_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
)

222 
cÚ‹Á_Ën
 = 
	`Reque¡_cÚ‹Á_Ëngth
(
cÚn
->
»q
);

223 
rc
 = 0;

224 *
body
 = 
NULL
;

226 
HªdËr
 *
hªdËr
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
, handler);

227 
	`”rÜ_uÆess
(
hªdËr
, 
cÚn
, 404, "NØaùiÚ fÜ„eque¡: %s", 
	`bd©a
(
	`Reque¡_·th
(cÚn->
»q
)));

230 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
iob
, 
	`Reque¡_h—d”_Ëngth
(cÚn->
»q
)) != -1, "Finaly commit failed streaminghe connectiono http handlers.");

233 if(
	`is_websock‘
(
cÚn
)) {

234 
cÚ‹Á_Ën
 = 
	`IOBuf_ava
(
cÚn
->
iob
);

235 
	`check
(
cÚ‹Á_Ën
 =ğ
WEBSOCKET_ARBITRARY_BODY_SIZE
, "Purported websocket but body does‚ot have 8 bytes");

238 if(
cÚ‹Á_Ën
 == 0) {

239 
body
 = "";

240 
rc
 = 
	`CÚÃùiÚ_£nd_to_hªdËr
(
cÚn
, 
hªdËr
, 
body
, 
cÚ‹Á_Ën
);

241 
	`check_debug
(
rc
 == 0, "Failedo deliverohe handler.");

242 } if(
cÚ‹Á_Ën
 > 
MAX_CONTENT_LENGTH
) {

243 
rc
 = 
	`U¶ßd_fe
(
cÚn
, 
hªdËr
, 
cÚ‹Á_Ën
);

244 
	`check
(
rc
 == 0, "Failedo upload file.");

246 
	`debug
("READ ALL CALLED w™h cÚ‹Á_Ën: %d,‡nd MAX_CONTENT_LENGTH: %d", 
cÚ‹Á_Ën
, 
MAX_CONTENT_LENGTH
);

248 
body
 = 
	`IOBuf_»ad_®l
(
cÚn
->
iob
, 
cÚ‹Á_Ën
, 
CLIENT_READ_RETRIES
);

249 
	`check
(
body
 !ğ
NULL
, "Client closedhe connection during upload.");

251 
rc
 = 
	`CÚÃùiÚ_£nd_to_hªdËr
(
cÚn
, 
hªdËr
, 
body
, 
cÚ‹Á_Ën
);

252 
	`check_debug
(
rc
 == 0, "Failedo deliverohe handler.");

255 
	`Log_»que¡
(
cÚn
, 200, 
cÚ‹Á_Ën
);

257  
REQ_SENT
;

259 
”rÜ
:

260  
CLOSE
;

261 
	}
}

264 
	$cÚÃùiÚ_h‰p_to_dœeùÜy
(
CÚÃùiÚ
 *
cÚn
)

266 
Dœ
 *
dœ
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
, dir);

268 
rc
 = 
	`Dœ_£rve_fe
(
dœ
, 
cÚn
->
»q
, conn);

269 
	`check_debug
(
rc
 =ğ0, "FaedØ£rvfe: %s", 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

271 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
iob
,

272 
	`Reque¡_h—d”_Ëngth
(
cÚn
->
»q
è+ 
	`Reque¡_cÚ‹Á_Ëngth
(conn->req)) != -1, "Finaly commit failed sending from directory.");

275 
	`Log_»que¡
(
cÚn
, cÚn->
»q
->
¡©us_code
, cÚn->»q->
»¥Ú£_size
);

277 if(
cÚn
->
şo£
) {

278  
CLOSE
;

280  
RESP_SENT
;

283 
”rÜ
:

284  
CLOSE
;

285 
	}
}

290 
	$cÚÃùiÚ_h‰p_to_´oxy
(
CÚÃùiÚ
 *
cÚn
)

292 
Proxy
 *
´oxy
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
,…roxy);

293 
	`check
(
´oxy
 !ğ
NULL
, "Should have‡…roxy backend.");

295 
	`debug
("CONNECT TO: %s:%d", 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

297 
´oxy_fd
 = 
	`ÃtdŸl
(1, 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

298 
	`check
(
´oxy_fd
 != -1, "Failedo connecto…roxy backend %s:%d",

299 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

301 if(!
cÚn
->
´oxy_iob
) {

302 
cÚn
->
´oxy_iob
 = 
	`IOBuf_ü—‹
(
BUFFER_SIZE
, 
´oxy_fd
, 
IOBUF_SOCKET
);

303 
	`check_mem
(
cÚn
->
´oxy_iob
);

306 if(!
cÚn
->
ş›Á
) {

307 
cÚn
->
ş›Á
 = 
	`h_ÿÎoc
((
h‰pş›Á_·r£r
), 1);

308 
	`check_mem
(
cÚn
->
ş›Á
);

309 
	`h©ch
(
cÚn
->
ş›Á
, conn);

312  
CONNECT
;

314 
”rÜ
:

315  
FAILED
;

316 
	}
}

320 
	$cÚÃùiÚ_´oxy_d–iv”
(
CÚÃùiÚ
 *
cÚn
)

322 
rc
 = 0;

323 
tÙ®_Ën
 = 
	`Reque¡_h—d”_Ëngth
(
cÚn
->
»q
è+ 
	`Reque¡_cÚ‹Á_Ëngth
(conn->req);

325 *
buf
 = 
	`IOBuf_»ad_®l
(
cÚn
->
iob
, 
tÙ®_Ën
, 
CLIENT_READ_RETRIES
);

326 
	`check
(
buf
 !ğ
NULL
, "Failedo„ead fromhe client socketo…roxy.");

328 
rc
 = 
	`IOBuf_£nd
(
cÚn
->
´oxy_iob
, 
	`IOBuf_¡¬t
(cÚn->
iob
), 
tÙ®_Ën
);

329 
	`check
(
rc
 > 0, "Failedo sendo…roxy.");

331  
REQ_SENT
;

333 
”rÜ
:

334  
REMOTE_CLOSE
;

335 
	}
}

339 
	$cÚÃùiÚ_´oxy_»¶y_·r£
(
CÚÃùiÚ
 *
cÚn
)

341 
rc
 = 0;

342 
tÙ®
 = 0;

343 
Proxy
 *
´oxy
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
,…roxy);

344 
h‰pş›Á_·r£r
 *
ş›Á
 = 
cÚn
->client;

346 
rc
 = 
	`Proxy_»ad_ªd_·r£
(
cÚn
);

347 
	`check
(
rc
 != -1, "Failedo„ead from…roxy server: %s:%d",

348 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

350 if(
ş›Á
->
chunked
) {

352 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
ş›Á
->
body_¡¬t
);

353 
	`check_debug
(
rc
 != -1, "Failed streaming headero client.");

358 
rc
 = 
	`Proxy_¡»am_chunks
(
cÚn
);

359 
	`check
(
rc
 != -1, "Failedo stream chunkedƒncodingo client.");

360 } 
rc
 == 0);

362 } if(
ş›Á
->
cÚ‹Á_Ën
 >= 0) {

363 
tÙ®
 = 
ş›Á
->
body_¡¬t
 + cl›Á->
cÚ‹Á_Ën
;

364 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
tÙ®
);

365 
	`check
(
rc
 != -1, "Failed streaming‚on-chunked„esponse.");

366 } if(
ş›Á
->
¡©us
 == 204 || client->status == 304) {

369 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
ş›Á
->
body_¡¬t
);

370 
	`check
(
rc
 != -1, "Failed streaming‚on-chunked„esponse.");

371 } if(
ş›Á
->
şo£
 || cl›Á->
cÚ‹Á_Ën
 == -1) {

372 
	`debug
("Response„equested‡„ead until close.");

373 
	`check
(
	`Proxy_¡»am_to_şo£
(
cÚn
) != -1, "Failed streamingo client.");

375 
	`£Áš–
("Should‚ot„eachhis code, Tell Zed.");

378 
	`Log_»que¡
(
cÚn
, 
ş›Á
->
¡©us
, cl›Á->
cÚ‹Á_Ën
);

380 if(
ş›Á
->
şo£
) {

381  
REMOTE_CLOSE
;

383  
REQ_RECV
;

386 
”rÜ
:

387  
FAILED
;

388 
	}
}

391 
	$cÚÃùiÚ_´oxy_»q_·r£
(
CÚÃùiÚ
 *
cÚn
)

393 
rc
 = 0;

394 
Ho¡
 *
rg‘_ho¡
 = 
cÚn
->
»q
->target_host;

395 
Back’d
 *
»q_aùiÚ
 = 
cÚn
->
»q
->
aùiÚ
;

397 
	`check_debug
(!
	`IOBuf_şo£d
(
cÚn
->
iob
), "Client closed, goodbye.");

399 
rc
 = 
	`CÚÃùiÚ_»ad_h—d”
(
cÚn
, cÚn->
»q
);

401 
	`check_debug
(
rc
 > 0, "Failedo„ead‡nother header.");

402 
	`”rÜ_uÆess
(
	`Reque¡_is_h‰p
(
cÚn
->
»q
), conn, 400,

405 
Back’d
 *
found
 = 
	`Ho¡_m©ch_back’d
(
rg‘_ho¡
, 
	`Reque¡_·th
(
cÚn
->
»q
), 
NULL
);

406 
	`”rÜ_uÆess
(
found
, 
cÚn
, 404,

407 "HªdË¸nÙ found: %s", 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

410 if(
found
 !ğ
»q_aùiÚ
) {

411 
	`Reque¡_£t_aùiÚ
(
cÚn
->
»q
, 
found
);

412  
	`CÚÃùiÚ_back’d_ev’t
(
found
, 
cÚn
);

414  
HTTP_REQ
;

417 
	`”rÜ_»¥Ú£
(
cÚn
, 500, "Invalid code branch,ell Zed.");

418 
”rÜ
:

419  
REMOTE_CLOSE
;

420 
	}
}

424 
	$cÚÃùiÚ_´oxy_çed
(
CÚÃùiÚ
 *
cÚn
)

426 
	`Re¥Ú£_£nd_¡©us
(
cÚn
, &
HTTP_502
);

428  
CLOSE
;

429 
	}
}

432 
	$cÚÃùiÚ_´oxy_şo£
(
CÚÃùiÚ
 *
cÚn
)

434 
	`IOBuf_de¡roy
(
cÚn
->
´oxy_iob
);

435 
cÚn
->
´oxy_iob
 = 
NULL
;

437  
CLOSE
;

438 
	}
}

440 
šlše
 
	$şo£_Ü_”rÜ
(
CÚÃùiÚ
 *
cÚn
, 
Ãxt
)

443 
	`IOBuf_de¡roy
(
cÚn
->
´oxy_iob
);

444 
cÚn
->
´oxy_iob
 = 
NULL
;

446 
	`check_debug
(
	`Regi¡”_discÚÃù
(
	`IOBuf_fd
(
cÚn
->
iob
)) != -1,

447 "Regi¡” discÚÃù didn'ˆwÜk fÜ %d", 
	`IOBuf_fd
(
cÚn
->
iob
));

449 
”rÜ
:

451  
Ãxt
;

452 
	}
}

455 
	$cÚÃùiÚ_şo£
(
CÚÃùiÚ
 *
cÚn
)

457  
	`şo£_Ü_”rÜ
(
cÚn
, 0);

458 
	}
}

462 
	$cÚÃùiÚ_”rÜ
(
CÚÃùiÚ
 *
cÚn
)

464  
	`şo£_Ü_”rÜ
(
cÚn
, 
CLOSE
);

465 
	}
}

468 
	$cÚÃùiÚ_id’tify_»que¡
(
CÚÃùiÚ
 *
cÚn
)

470 
Ãxt
 = 
CLOSE
;

472 if(
	`Reque¡_is_xml
(
cÚn
->
»q
)) {

473 if(
	`bi£q
(
	`Reque¡_·th
(
cÚn
->
»q
), &
POLICY_XML_REQUEST
)) {

474 
	`debug
("XML POLICY CONNECTION");

475 
cÚn
->
ty³
 = 
CONN_TYPE_SOCKET
;

476 
	`skÇme
("XML");

477 
Ãxt
 = 
SOCKET_REQ
;

479 
	`debug
("XML MESSAGE");

480 
cÚn
->
ty³
 = 
CONN_TYPE_MSG
;

481 
	`skÇme
("MSG");

482 
Ãxt
 = 
MSG_REQ
;

484 } if(
	`Reque¡_is_jsÚ
(
cÚn
->
»q
)) {

485 
	`debug
("JSON SOCKET MESSAGE");

486 
cÚn
->
ty³
 = 
CONN_TYPE_MSG
;

487 
	`skÇme
("MSG");

488 
Ãxt
 = 
MSG_REQ
;

489 } if(
	`Reque¡_is_h‰p
(
cÚn
->
»q
)) {

490 
	`debug
("HTTP MESSAGE");

491 
cÚn
->
ty³
 = 
CONN_TYPE_HTTP
;

492 
	`skÇme
("HTTP");

493 
Ãxt
 = 
HTTP_REQ
;

495 
	`”rÜ_»¥Ú£
(
cÚn
, 500, "Invalid code branch,ell Zed.");

498  
Ãxt
;

500 
”rÜ
:

501  
CLOSE
;

503 
	}
}

506 
	$cÚÃùiÚ_·r£
(
CÚÃùiÚ
 *
cÚn
)

508 if(
	`CÚÃùiÚ_»ad_h—d”
(
cÚn
, cÚn->
»q
) > 0) {

509  
REQ_RECV
;

511  
CLOSE
;

513 
	}
}

515 
S‹AùiÚs
 
	gCONN_ACTIONS
 = {

516 .
”rÜ
 = 
cÚÃùiÚ_”rÜ
,

517 .
	gşo£
 = 
cÚÃùiÚ_şo£
,

518 .
	g·r£
 = 
cÚÃùiÚ_·r£
,

519 .
	g»gi¡”_»que¡
 = 
cÚÃùiÚ_id’tify_»que¡
,

520 .
	gid’tify_»que¡
 = 
cÚÃùiÚ_id’tify_»que¡
,

521 .
	grou‹_»que¡
 = 
cÚÃùiÚ_rou‹_»que¡
,

522 .
	g£nd_sock‘_»¥Ú£
 = 
cÚÃùiÚ_£nd_sock‘_»¥Ú£
,

523 .
	gmsg_to_hªdËr
 = 
cÚÃùiÚ_msg_to_hªdËr
,

524 .
	gh‰p_to_hªdËr
 = 
cÚÃùiÚ_h‰p_to_hªdËr
,

525 .
	gh‰p_to_´oxy
 = 
cÚÃùiÚ_h‰p_to_´oxy
,

526 .
	gh‰p_to_dœeùÜy
 = 
cÚÃùiÚ_h‰p_to_dœeùÜy
,

527 .
	g´oxy_d–iv”
 = 
cÚÃùiÚ_´oxy_d–iv”
,

528 .
	g´oxy_çed
 = 
cÚÃùiÚ_´oxy_çed
,

529 .
	g´oxy_»¶y_·r£
 = 
cÚÃùiÚ_´oxy_»¶y_·r£
,

530 .
	g´oxy_»q_·r£
 = 
cÚÃùiÚ_´oxy_»q_·r£
,

531 .
	g´oxy_şo£
 = 
cÚÃùiÚ_´oxy_şo£


536 
	$CÚÃùiÚ_de¡roy
(
CÚÃùiÚ
 *
cÚn
)

538 if(
cÚn
) {

539 
	`Reque¡_de¡roy
(
cÚn
->
»q
);

540 
cÚn
->
»q
 = 
NULL
;

541 
	`IOBuf_de¡roy
(
cÚn
->
iob
);

542 
	`IOBuf_de¡roy
(
cÚn
->
´oxy_iob
);

543 
	`h_ä“
(
cÚn
);

545 
	}
}

548 
CÚÃùiÚ
 *
	$CÚÃùiÚ_ü—‹
(
S”v”
 *
¤v
, 
fd
, 
½Üt
,

549 cÚ¡ *
»mÙe
)

551 
CÚÃùiÚ
 *
cÚn
 = 
	`h_ÿÎoc
((Connection), 1);

552 
	`check_mem
(
cÚn
);

554 
cÚn
->
£rv”
 = 
¤v
;

556 
cÚn
->
½Üt
 =„port;

557 
	`memıy
(
cÚn
->
»mÙe
,„emÙe, 
IPADDR_SIZE
);

558 
cÚn
->
»mÙe
[
IPADDR_SIZE
] = '\0';

559 
cÚn
->
ty³
 = 0;

561 
cÚn
->
»q
 = 
	`Reque¡_ü—‹
();

562 
	`check_mem
(
cÚn
->
»q
);

564 if(
¤v
 !ğ
NULL
 && srv->
u£_s¦
) {

565 
cÚn
->
iob
 = 
	`IOBuf_ü—‹
(
BUFFER_SIZE
, 
fd
, 
IOBUF_SSL
);

566 
	`check
(
cÚn
->
iob
 !ğ
NULL
, "Failedo createhe SSL IOBuf.");

568 
	`s¦_£t_own_û¹
(&
cÚn
->
iob
->
s¦
, &
¤v
->
own_û¹
, &¤v->
r§_key
);

569 
	`s¦_£t_dh_·¿m
(&
cÚn
->
iob
->
s¦
, 
¤v
->
dhm_P
, srv->
dhm_G
);

570 
	`s¦_£t_ch”s
(&
cÚn
->
iob
->
s¦
, 
¤v
->
ch”s
);

572 
cÚn
->
iob
 = 
	`IOBuf_ü—‹
(
BUFFER_SIZE
, 
fd
, 
IOBUF_SOCKET
);

575  
cÚn
;

577 
”rÜ
:

578 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

579  
NULL
;

580 
	}
}

583 
	$CÚÃùiÚ_acû±
(
CÚÃùiÚ
 *
cÚn
)

585 
	`check
(
	`Regi¡”_cÚÃù
(
	`IOBuf_fd
(
cÚn
->
iob
), (*)conn) != -1,

588 
	`check
(
	`skü—‹
(
CÚÃùiÚ_sk
, 
cÚn
, 
CONNECTION_STACK
) != -1,

592 
”rÜ
:

594 
	}
}

598 
	$CÚÃùiÚ_sk
(*
v
)

600 
CÚÃùiÚ
 *
cÚn
 = (CÚÃùiÚ *)
v
;

601 
i
 = 0;

602 
Ãxt
 = 0;

604 
	`S‹_š™
(&
cÚn
->
¡©e
, &
CONN_ACTIONS
);

606 
i
 = 0, 
Ãxt
 = 
OPEN
;‚exˆ!ğ
CLOSE
; i++) {

608 if(
	`F‹r_aùiv©ed
()) {

609 
Ãxt
 = 
	`F‹r_run
Òext, 
cÚn
);

610 
	`check
(
Ãxt
 >ğ
CLOSE
 &&‚exˆ< 
EVENT_END
,

611 "!!! Inv®id‚exˆev’t[%d]: %d from f‹r!", 
i
, 
Ãxt
);

614 
Ãxt
 = 
	`S‹_exec
(&
cÚn
->
¡©e
,‚ext, (*)conn);

616 
	`check
(
Ãxt
 >ğ
CLOSE
 &&‚exˆ< 
EVENT_END
,

617 "!!! Inv®id‚exˆev’t[%d]: %d, T–ÈZED!", 
i
, 
Ãxt
);

619 if(
cÚn
->
iob
 && !cÚn->iob->
şo£d
) {

620 
	`Regi¡”_pšg
(
	`IOBuf_fd
(
cÚn
->
iob
));

624 
”rÜ
:

625 
	`S‹_exec
(&
cÚn
->
¡©e
, 
CLOSE
, (*)conn);

626 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

627 
	`skex™
(0);

628 
	}
}

630 
	$CÚÃùiÚ_d–iv”_¿w
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
)

632  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
buf
), 
	`bËngth
(buf));

633 
	}
}

635 
	$CÚÃùiÚ_d–iv”
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
)

637 
rc
 = 0;

639 
b¡ršg
 
b64_buf
 = 
	`bBa£64Encode
(
buf
);

640 
	`as£¹
(
b64_buf
 !ğ
NULL
 && "WTF!");

641 
	`as£¹
(
cÚn
->
iob
 !ğ
NULL
 && "WTF! NO IOBUF!");

642 
rc
 = 
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
b64_buf
), 
	`bËngth
(b64_buf)+1);

643 
	`check_debug
(
rc
 =ğ
	`bËngth
(
b64_buf
)+1, "FaedØwr™’tœmes§gtØcÚÀ%d", 
	`IOBuf_fd
(
cÚn
->
iob
));

645 
	`bde¡roy
(
b64_buf
);

648 
”rÜ
:

649 
	`bde¡roy
(
b64_buf
);

651 
	}
}

654 
šlše
 
	$check_should_şo£
(
CÚÃùiÚ
 *
cÚn
, 
Reque¡
 *
»q
)

656 if(
»q
->
v”siÚ
 && 
	`bi£qc¡r
(req->version, "HTTP/1.0")) {

657 
	`debug
("HTTP 1.0„eque¡ comšg iÀäom %s", 
cÚn
->
»mÙe
);

658 
cÚn
->
şo£
 = 1;

660 
b¡ršg
 
cÚn_şo£
 = 
	`Reque¡_g‘
(
»q
, &
HTTP_CONNECTION
);

662 if(
cÚn_şo£
 && 
	`bi£qc¡rÿ£Ëss
(conn_close, "close")) {

663 
cÚn
->
şo£
 = 1;

665 
cÚn
->
şo£
 = 0;

668 
	}
}

671 
	$CÚÃùiÚ_»ad_h—d”
(
CÚÃùiÚ
 *
cÚn
, 
Reque¡
 *
»q
)

673 *
d©a
 = 
	`IOBuf_¡¬t
(
cÚn
->
iob
);

674 
ava
 = 
	`IOBuf_ava
(
cÚn
->
iob
);

675 
rc
 = 0;

676 
size_t
 
Å¬£d
 = 0;

677 
Œ›s
 = 0;

679 
	`Reque¡_¡¬t
(
»q
);

681 
Œ›s
 = 0; 
rc
 =ğ0 &&r› < 
CLIENT_READ_RETRIES
;ries++) {

682 if(
ava
 > 0) {

683 
rc
 = 
	`Reque¡_·r£
(
»q
, 
d©a
, 
ava
, &
Å¬£d
);

686 if(
rc
 == 0) {

687 
d©a
 = 
	`IOBuf_»ad_some
(
cÚn
->
iob
, &
ava
);

688 
	`check_debug
(!
	`IOBuf_şo£d
(
cÚn
->
iob
), "Client closed during„ead.");

692 
	`”rÜ_uÆess
(
Œ›s
 < 
CLIENT_READ_RETRIES
, 
cÚn
,

694 
	`”rÜ_uÆess
(
rc
 =ğ1, 
cÚn
, 400, "Error…arsing„equest.");

697 
	`Reque¡_£t
(
cÚn
->
»q
, 
	`b¡rıy
(&
HTTP_X_FORWARDED_FOR
),

698 
	`bäomc¡r
(
cÚn
->
»mÙe
), 1);

700 
	`check_should_şo£
(
cÚn
, cÚn->
»q
);

702  
Å¬£d
;

704 
”rÜ
:

707 
	}
}

710 
	$CÚÃùiÚ_š™
()

712 
MAX_CONTENT_LENGTH
 = 
	`S‘tšg_g‘_št
("limits.content_length", 20 * 1024);

713 
BUFFER_SIZE
 = 
	`S‘tšg_g‘_št
("limits.buffer_size", 4 * 1024);

714 
CONNECTION_STACK
 = 
	`S‘tšg_g‘_št
("limits.connection_stack_size", 32 * 1024);

715 
CLIENT_READ_RETRIES
 = 
	`S‘tšg_g‘_št
("limits.client_read_retries", 5);

718 
	`log_šfo
("MAX†imits.content_length=%d,†imits.buffer_size=%d,†imits.connection_stack_size=%d,†imits.client_read_retries=%d",

719 
MAX_CONTENT_LENGTH
, 
BUFFER_SIZE
, 
CONNECTION_STACK
,

720 
CLIENT_READ_RETRIES
);

722 
PROXY_READ_RETRIES
 = 
	`S‘tšg_g‘_št
("limits.proxy_read_retries", 100);

723 
PROXY_READ_RETRY_WARN
 = 
	`S‘tšg_g‘_št
("limits.proxy_read_retry_warn", 10);

725 
	`log_šfo
("MAX†imits.proxy_read_retries=%d,†imits.proxy_read_retry_warn=%d",

726 
PROXY_READ_RETRIES
, 
PROXY_READ_RETRY_WARN
);

727 
	}
}

	@src/connection.h

35 #iâdeà
_li¡’”_h


36 
	#_li¡’”_h


	)

38 
	~"£rv”.h
"

39 
	~"»que¡.h
"

40 
	~"¡©e.h
"

41 
	~"´oxy.h
"

42 
	~"io.h
"

43 
	~"adt/hash.h
"

45 
CONNECTION_STACK
;

46 
BUFFER_SIZE
;

47 
MAX_CONTENT_LENGTH
;

50 
	mCONN_TYPE_HTTP
=1,

51 
	mCONN_TYPE_MSG
,

52 
	mCONN_TYPE_SOCKET


55 
	sCÚÃùiÚ
 {

56 
S”v”
 *
	m£rv”
;

57 
Reque¡
 *
	m»q
;

59 
IOBuf
 *
	miob
;

60 
IOBuf
 *
	m´oxy_iob
;

62 
	m½Üt
;

63 
S‹
 
	m¡©e
;

64 
h‰pş›Á_·r£r
 *
	mş›Á
;

65 
	mşo£
;

66 
	mty³
;

67 
hash_t
 *
	mf‹r_¡©e
;

68 
	m»mÙe
[
IPADDR_SIZE
+1];

69 } 
	tCÚÃùiÚ
;

71 
CÚÃùiÚ_de¡roy
(
CÚÃùiÚ
 *
cÚn
);

73 
CÚÃùiÚ
 *
CÚÃùiÚ_ü—‹
(
S”v”
 *
¤v
, 
fd
, 
½Üt
,

74 cÚ¡ *
»mÙe
);

76 
CÚÃùiÚ_acû±
(
CÚÃùiÚ
 *
cÚn
);

78 
CÚÃùiÚ_sk
(*
v
);

80 
	gHªdËr
;

81 
CÚÃùiÚ_£nd_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, *
body
, 
cÚ‹Á_Ën
);

83 
CÚÃùiÚ_d–iv”_¿w
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
);

85 
CÚÃùiÚ_d–iv”
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
);

87 
CÚÃùiÚ_»ad_h—d”
(
CÚÃùiÚ
 *
cÚn
, 
Reque¡
 *
»q
);

89 
CÚÃùiÚ_š™
();

	@src/control.c

35 
	~"cÚŒŞ.h
"

36 
	~"b¡ršg.h
"

37 
	~"sk/sk.h
"

38 
	~"»gi¡”.h
"

39 
	~"£rv”.h
"

40 
	~"dbg.h
"

41 
	~<¡dlib.h
>

42 
	~<time.h
>

43 
	~"£‰šg.h
"

44 
	~<sigÇl.h
>

45 
	~"Š‘¡ršgs.h
"

46 
	~"Š‘¡ršgs_im¶.h
"

47 
	~"v”siÚ.h
"

49 
S”v”
 *
SERVER
;

51 
	$c¡r_ä“
(*
d©a
, *
hšt
)

53 
	`ä“
(
d©a
);

54 
	}
}

56 
	gCONTROL_RUNNING
 = 1;

57 *
	gCONTROL_SOCKET
 = 
NULL
;

60 
gb¡ršg
 
	gINVALID_FORMAT_ERR
 = 
bsStic
("101:4:code,15:INVALID_REQUEST,5:error,63:Invalid„equest format, must be‡†ist withwoƒlements in it.,}");

61 
gb¡ršg
 
	gINVALID_DATA_ERR
 = 
bsStic
("97:4:code,12:INVALID_DATA,5:error,62:Invalid data,ƒxpecting‡†ist with‡ string‡nd‡ hash in it.,}");

62 
gb¡ršg
 
	gCALLBACK_RETURN_ERR
 = 
bsStic
("91:4:code,15:CALLBACK_RETURN,5:error,53:Callback failed‡nd„eturned NULL, should‚ot happen.,}");

63 
gb¡ršg
 
	gCALLBACK_NOT_FOUND_ERR
 = 
bsStic
("74:4:code,18:CALLBACK_NOT_FOUND,5:error,33:Callback„equested was‚ot found.,}");

64 
gb¡ršg
 
	gSIGNAL_FAILED_ERR
 = 
bsStic
("75:4:code,13:SIGNAL_FAILED,5:error,39:raise call failed, can't signal…rocess,}");

65 
gb¡ršg
 
	gINVALID_ARGUMENT_ERR
 = 
bsStic
("61:4:code,16:INVALID_ARGUMENT,5:error,22:Invalid‡rgumentype.,}");

66 
gb¡ršg
 
	gNOT_CONNECTED_ERR
 = 
bsStic
("57:4:code,13:NOT_CONNECTED,5:error,21:Socket‚ot connected.,}");

69 
	#check_cÚŒŞ_”r
(
A
, 
E
, 
M
, ...èif(!(A)è{ 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(E), 
	`bËngth
(E), 
NULL
); 
	`log_w¬n
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

71 
	gŠs_v®ue_t
 *(*
	tÿÎback_t
)(
	tb¡ršg
 
	tÇme
, 
	thash_t
 *
	t¬gs
);

73 
	sÿÎback_li¡_t
 {

74 
gb¡ršg
 
	mÇme
;

75 
gb¡ršg
 
	mh–p
;

76 
ÿÎback_t
 
	mÿÎback
;

77 } 
	tÿÎback_li¡_t
;

79 
ÿÎback_li¡_t
 
	gCALLBACKS
[];

81 
šlše
 
Šs_v®ue_t
 *
	$»ad_mes§ge
(*
sock
)

83 
Šs_v®ue_t
 *
»q
 = 
NULL
;

84 
rc
 = 0;

86 
zmq_msg_t
 *
šmsg
 = 
	`ÿÎoc
((zmq_msg_t), 1);

87 
rc
 = 
	`zmq_msg_š™
(
šmsg
);

88 
	`check
(
rc
 == 0, "init failed.");

90 
rc
 = 
	`mq»cv
(
sock
, 
šmsg
, 0);

91 
	`check
(
rc
 == 0, "Receive on control failed.");

93 
»q
 = 
	`Šs_·r£
(
	`zmq_msg_d©a
(
šmsg
), 
	`zmq_msg_size
(šmsg), 
NULL
);

95 if(
»q
 =ğ
NULL
) {

96 
»q
 = 
	`Šs_g‘_nuÎ
();

99 
	`check
(
»q
, "Failedo createhe„equest string.");

101 
	`zmq_msg_şo£
(
šmsg
);

102 
	`ä“
(
šmsg
);

104  
»q
;

106 
”rÜ
:

107 if(
šmsg
) {

108 
	`zmq_msg_şo£
(
šmsg
);

109 
	`ä“
(
šmsg
);

112  
NULL
;

113 
	}
}

116 
šlše
 
	$£nd_»¶y
(*
sock
, 
Šs_v®ue_t
 *
»p
)

118 
rc
 = 0;

119 
size_t
 
Ën
 = 0;

121 
zmq_msg_t
 *
outmsg
 = 
	`ÿÎoc
((zmq_msg_t), 1);

122 
	`check_mem
(
outmsg
);

124 
rc
 = 
	`zmq_msg_š™
(
outmsg
);

125 
	`check
(
rc
 == 0, "Cannot‡llocate zmq msg.");

127 *
outbuf
 = 
	`Šs_»nd”
(
»p
, &
Ën
);

128 
	`check
(
outbuf
 !ğ
NULL
, "Failedo„ender control…ort„eply.");

129 
	`check
(
Ën
 > 0, "Control…ort„eply isoo small.");

131 
rc
 = 
	`zmq_msg_š™_d©a
(
outmsg
, 
outbuf
, 
Ën
, 
c¡r_ä“
, 
»p
);

132 
	`check
(
rc
 == 0, "Failedo init„eply data.");

134 
rc
 = 
	`mq£nd
(
sock
, 
outmsg
, 0);

135 
	`check
(
rc
 == 0, "Failedo deliver 0mq messageo„equestor.");

136 
	`ä“
(
outmsg
);

139 
”rÜ
:

140 
	`ä“
(
outmsg
);

142 
	}
}

151 
šlše
 
Šs_v®ue_t
 *
	$basic_»¥Ú£
(
b¡ršg
 
key
, b¡ršg 
v®ue
)

153 
Šs_v®ue_t
 *
»suÉs
 = 
	`Šs_Ãw_diù
();

154 
Šs_v®ue_t
 *
h—d”s
 = 
	`Šs_Ãw_li¡
();

155 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

156 
Šs_v®ue_t
 *
cŞs
 = 
	`Šs_Ãw_li¡
();

158 
	`Šs_add_to_li¡
(
h—d”s
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(
key
), 
	`bËngth
(key)));

159 
	`Šs_add_to_li¡
(
cŞs
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(
v®ue
), 
	`bËngth
(value)));

160 
	`Šs_add_to_li¡
(
rows
, 
cŞs
);

162 
	`bde¡roy
(
key
);

163 
	`bde¡roy
(
v®ue
);

165 
	`Šs_diù_£tc¡r
(
»suÉs
, "h—d”s", 
h—d”s
);

166 
	`Šs_diù_£tc¡r
(
»suÉs
, "rows", 
rows
);

168  
»suÉs
;

169 
	}
}

172 
šlše
 
Šs_v®ue_t
 *
	$g‘_¬g
(
hash_t
 *
¬gs
, cÚ¡ *
Çme
)

174 
b¡ršg
 
key
 = 
	`bäomc¡r
(
Çme
);

175 
hnode_t
 *
node
 = 
	`hash_lookup
(
¬gs
, 
key
);

176 
	`bde¡roy
(
key
);

178 
	`check
(
node
 !ğ
NULL
, "Missšg‡rgum’ˆ% š c®l.", 
Çme
);

180 
Šs_v®ue_t
 *
v®
 = 
	`hnode_g‘
(
node
);

181 
	`check
(
v®
 !ğ
NULL
, "Got‡‚ull for‡ dict in‡rguments.");

183  
v®
;

184 
”rÜ
:

185  
NULL
;

186 
	}
}

188 
Šs_v®ue_t
 *
	$sigÇl_£rv”_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

190 
rc
 = -1;

191 
Šs_v®ue_t
 *
»suÉ
 = 
NULL
;

193 if(
	`bi£qc¡r
(
Çme
, "stop")) {

194 
rc
 = 
	`¿i£
(
SIGINT
);

195 } if(
	`bi£qc¡r
(
Çme
, "reload")) {

196 
rc
 = 
	`¿i£
(
SIGHUP
);

197 } if(
	`bi£qc¡r
(
Çme
, "terminate")) {

198 
rc
 = 
	`¿i£
(
SIGTERM
);

200 
rc
 = -1;

203 
	`check_cÚŒŞ_”r
(
rc
 =ğ0, &
SIGNAL_FAILED_ERR
, "Signal failed.");

205 
»suÉ
 = 
	`basic_»¥Ú£
(
	`bäomc¡r
("msg"), bfromcstr("signal sento server"));

207 
”rÜ
:

208  
»suÉ
;

209 
	}
}

212 
Šs_v®ue_t
 *
	$v”siÚ_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

214  
	`basic_»¥Ú£
(
	`bäomc¡r
("v”siÚ"), bäomc¡r(
VERSION
));

215 
	}
}

217 
Šs_v®ue_t
 *
	$h–p_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

219 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

220 
Šs_v®ue_t
 *
h—d”s
 = 
	`Šs_Ãw_li¡
();

221 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

223 
	`Šs_add_to_li¡
(
h—d”s
, 
	`Šs_·r£_¡ršg
("Çme", 
	`¡¾’
("name")));

224 
	`Šs_add_to_li¡
(
h—d”s
, 
	`Šs_·r£_¡ršg
("h–p", 
	`¡¾’
("help")));

225 
	`Šs_diù_£tc¡r
(
»suÉ
, "h—d”s", 
h—d”s
);

227 
ÿÎback_li¡_t
 *
cb–
 = 
NULL
;

229 
cb–
 = 
CALLBACKS
; cb–->
ÿÎback
 !ğ
NULL
; cbel++) {

230 
Šs_v®ue_t
 *
cŞ
 = 
	`Šs_Ãw_li¡
();

231 
	`Šs_add_to_li¡
(
cŞ
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(&
cb–
->
Çme
), 
	`bËngth
(&cbel->name)));

232 
	`Šs_add_to_li¡
(
cŞ
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(&
cb–
->
h–p
), 
	`bËngth
(&cbel->help)));

233 
	`Šs_add_to_li¡
(
rows
, 
cŞ
);

236 
	`Šs_diù_£tc¡r
(
»suÉ
, "rows", 
rows
);

238  
»suÉ
;

239 
	}
}

241 
Šs_v®ue_t
 *
	$cÚŒŞ_¡İ_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

243 
CONTROL_RUNNING
 = 0;

245  
	`basic_»¥Ú£
(
	`bäomc¡r
("msg"), bfromcstr("stoppinghe control…ort"));

246 
	}
}

248 
Šs_v®ue_t
 *
	$kl_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

250 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

252 
Šs_v®ue_t
 *
¬g
 = 
	`g‘_¬g
(
¬gs
, "id");

253 
	`check_cÚŒŞ_”r
(
¬g
 !ğ
NULL
, &
INVALID_ARGUMENT_ERR
, "Missing‡rgument 'id'.");

254 
	`check_cÚŒŞ_”r
(
	`Šs_g‘_ty³
(
¬g
è=ğ
Šs_g_numb”
, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

256 
id
 = 
¬g
->
v®ue
.
numb”
;

257 
	`check_cÚŒŞ_”r
(
id
 >ğ0 && id < 
MAX_REGISTERED_FDS
, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

260 
fd
 = 
	`Regi¡”_fd_fÜ_id
(
id
);

261 
	`check_cÚŒŞ_”r
(
fd
 >ğ0, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

262 
	`check_cÚŒŞ_”r
(
	`Regi¡”_fd_exi¡s
(
fd
), &
NOT_CONNECTED_ERR
, "Socket‚ot connected.");

264 
	`Regi¡”_discÚÃù
(
fd
);

266 
	`Šs_v®ue_de¡roy
(
»suÉ
);

268  
	`basic_»¥Ú£
(
	`bäomc¡r
("status"), bfromcstr("OK"));

270 
”rÜ
:

271  
»suÉ
;

272 
	}
}

275 
Šs_v®ue_t
 *
	$¡©us_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

277 
Šs_v®ue_t
 *
v®
 = 
	`g‘_¬g
(
¬gs
, "what");

278 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

280 
	`check_cÚŒŞ_”r
(
v®
 !ğ
NULL
, &
INVALID_ARGUMENT_ERR
, "Missing‡rgument what.");

281 
	`check_cÚŒŞ_”r
(
v®
->
ty³
 =ğ
Šs_g_¡ršg
, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

282 
b¡ršg
 
wh©
 = 
v®
->
v®ue
.
¡ršg
;

284 if(
	`bi£qc¡r
(
wh©
, "tasks")) {

285 
	`Šs_v®ue_de¡roy
(
»suÉ
);

286  
	`skg‘šfo
();

287 } if(
	`bi£qc¡r
(
wh©
, "net")) {

288 
	`Šs_v®ue_de¡roy
(
»suÉ
);

289  
	`Regi¡”_šfo
();

291 
b¡ršg
 
”r
 = 
	`bäomc¡r
("Expected‡rgument what=['net'|'tasks'].");

292 
	`Šs_diù_£tc¡r
(
»suÉ
, "”rÜ", 
	`Šs_·r£_¡ršg
(
	`bd©a
(
”r
), 
	`bËngth
(err)));

293 
	`bde¡roy
(
”r
);

296 
”rÜ
:

297  
»suÉ
;

298 
	}
}

300 
gb¡ršg
 
	gINFO_HEADERS
 = 
bsStic
("92:4:port,9:bind_addr,4:uuid,6:chroot,10:access_log,9:error_log,8:pid_file,16:default_hostname,]");

302 
Šs_v®ue_t
 *
	$šfo_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

304 if(
	`bi£qc¡r
(
Çme
, "time")) {

305  
	`basic_»¥Ú£
(
	`bäomc¡r
("time"), 
	`bfÜm©
("%d", ()
	`time
(
NULL
)));

306 } if(
	`bi£qc¡r
(
Çme
, "uuid")) {

307  
	`basic_»¥Ú£
(
	`bäomc¡r
("uuid"), 
	`b¡rıy
(
SERVER
->
uuid
));

309 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

310 
Šs_v®ue_t
 *
cŞs
 = 
	`Šs_Ãw_li¡
();

311 
	`Šs_add_to_li¡
(
cŞs
, 
	`Šs_Ãw_š‹g”
(
SERVER
->
pÜt
));

312 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
bšd_addr
);

313 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
uuid
);

314 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
chroÙ
);

315 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
acûss_log
);

316 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
”rÜ_log
);

317 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
pid_fe
);

318 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
deçuÉ_ho¡Çme
);

320 
	`Šs_add_to_li¡
(
rows
, 
cŞs
);

321  
	`Šs_¡ªd¬d_bË
(&
INFO_HEADERS
, 
rows
);

323 
	}
}

326 
ÿÎback_li¡_t
 
	gCALLBACKS
[] = {

327 {.
Çme
 = 
bsStic
("stop"),

328 .
	gh–p
 = 
bsStic
("¡İh£rv” (SIGINT)"), .
	gÿÎback
 = 
sigÇl_£rv”_cb
},

329 {.
	gÇme
 = 
bsStic
("reload"),

330 .
	gh–p
 = 
bsStic
("»lßdh£rv”"), .
	gÿÎback
 = 
sigÇl_£rv”_cb
},

331 {.
	gÇme
 = 
bsStic
("help"),

332 .
	gh–p
 = 
bsStic
("thi commªd"), .
	gÿÎback
 = 
h–p_cb
},

333 {.
	gÇme
 = 
bsStic
("control_stop"),

334 .
	gh–p
 = 
bsStic
("¡İ cÚŒŞ…Üt"), .
	gÿÎback
 = 
cÚŒŞ_¡İ_cb
},

335 {.
	gÇme
 = 
bsStic
("kill"),

336 .
	gh–p
 = 
bsStic
("kÈ¨cÚÃùiÚ"), .
	gÿÎback
 = 
kl_cb
},

337 {.
	gÇme
 = 
bsStic
("status"),

338 .
	gh–p
 = 
bsStic
("¡©us, wh©=['Ãt'|'sks']"), .
	gÿÎback
 = 
¡©us_cb
},

339 {.
	gÇme
 = 
bsStic
("terminate"),

340 .
	gh–p
 = 
bsStic
("‹rmš©th£rv” (SIGTERM)"), .
	gÿÎback
 = 
sigÇl_£rv”_cb
},

341 {.
	gÇme
 = 
bsStic
("time"),

342 .
	gh–p
 = 
bsStic
("th£rv”' time"), .
	gÿÎback
 = 
šfo_cb
},

343 {.
	gÇme
 = 
bsStic
("uuid"),

344 .
	gh–p
 = 
bsStic
("th£rv”' uuid"), .
	gÿÎback
 = 
šfo_cb
},

345 {.
	gÇme
 = 
bsStic
("info"),

346 .
	gh–p
 = 
bsStic
("šfÜm©iÚ‡bouˆthi £rv”"), .
	gÿÎback
 = 
šfo_cb
},

348 {.
	gÇme
 = 
bsStic
(""), .
	gh–p
 = bsStic(""), .
	gÿÎback
 = 
NULL
},

352 
Šs_v®ue_t
 *
	$CÚŒŞ_execu‹
(
Šs_v®ue_t
 *
»q
, 
ÿÎback_li¡_t
 *
ÿÎbacks
)

354 
Šs_v®ue_t
 *
»suÉ
 = 
NULL
;

355 
Šs_v®ue_t
 *
ÿÎ
 = 
NULL
;

356 
Šs_v®ue_t
 *
¬gs
 = 
NULL
;

357 
ÿÎback_li¡_t
 *
cb–
 = 
NULL
;

360 
	`check_cÚŒŞ_”r
(
»q
->
ty³
 =ğ
Šs_g_li¡
, &
INVALID_FORMAT_ERR
, "Invalid„equest format.");

362 
ÿÎ
 = 
	`d¬¿y_g‘
(
»q
->
v®ue
.
li¡
, 0);

363 
	`check_cÚŒŞ_”r
(
ÿÎ
 !ğ
NULL
, &
INVALID_DATA_ERR
, "Invalid first‡rgument.");

364 
	`check_cÚŒŞ_”r
(
ÿÎ
->
ty³
 =ğ
Šs_g_¡ršg
, &
INVALID_DATA_ERR
, "First‡rgument must be string.");

367 
¬gs
 = 
	`d¬¿y_g‘
(
»q
->
v®ue
.
li¡
, 1);

368 
	`check_cÚŒŞ_”r
(
¬gs
 !ğ
NULL
, &
INVALID_DATA_ERR
, "Invalid second‡rgument.");

369 
	`check_cÚŒŞ_”r
(
¬gs
 !ğ
ÿÎ
, &
INVALID_DATA_ERR
, "Must have morehan oneƒlemento„equest.");

370 
	`check_cÚŒŞ_”r
(
¬gs
->
ty³
 =ğ
Šs_g_diù
, &
INVALID_DATA_ERR
, "Second‡rgument must be dict.");

376 
cb–
 = 
ÿÎbacks
; cb–->
ÿÎback
 !ğ
NULL
; cbel++) {

377 if(
	`bi£q
(
ÿÎ
->
v®ue
.
¡ršg
, &
cb–
->
Çme
)) {

378 
»suÉ
 = 
cb–
->
	`ÿÎback
(
ÿÎ
->
v®ue
.
¡ršg
, 
¬gs
->v®ue.
diù
);

379 
	`check_cÚŒŞ_”r
(
»suÉ
 !ğ
NULL
, &
CALLBACK_RETURN_ERR
, "Callback„eturn invalid data (NULL).");

385 
	`check_cÚŒŞ_”r
(
»suÉ
 !ğ
NULL
, &
CALLBACK_NOT_FOUND_ERR
, "Callback‚ot found.");

387 
”rÜ
:

388  
»suÉ
;

389 
	}
}

391 
gb¡ršg
 
	gDEFAULT_CONTROL_SPEC
 = 
bsStic
("ipc://run/control");

393 
	$CÚŒŞ_sk
(*
v
)

395 
rc
 = 0;

396 
Šs_v®ue_t
 *
»q
 = 
NULL
;

397 
Šs_v®ue_t
 *
»p
 = 
NULL
;

398 
b¡ršg
 
¥ec
 = 
	`S‘tšg_g‘_¡r
("cÚŒŞ_pÜt", &
DEFAULT_CONTROL_SPEC
);

399 
	`skÇme
("control");

401 
	`log_šfo
("S‘tšg u°cÚŒŞ sock‘ iÀ© %s", 
	`bd©a
(
¥ec
));

403 
CONTROL_SOCKET
 = 
	`mqsock‘
(
ZMQ_REP
);

404 
	`check
(
CONTROL_SOCKET
 !ğ
NULL
, "Can't create contol socket.");

406 
rc
 = 
	`zmq_bšd
(
CONTROL_SOCKET
, 
	`bd©a
(
¥ec
));

407 
	`check
(
rc
 == 0, "Failedo bind control…orto„un/control.");

409 
CONTROL_RUNNING
) {

410 
	`sk¡©e
("waiting");

412 
»q
 = 
	`»ad_mes§ge
(
CONTROL_SOCKET
);

413 
	`check
(
»q
, "FaedØ»ad mes§ge: %s.", 
	`¡»¼Ü
(
”ºo
));

415 if(
»q
->
ty³
 =ğ
Šs_g_nuÎ
) {

416 
»p
 = 
	`Šs_·r£
(
	`bd©a
(&
INVALID_DATA_ERR
), 
	`bËngth
(&INVALID_DATA_ERR), 
NULL
);

418 
»p
 = 
	`CÚŒŞ_execu‹
(
»q
, 
CALLBACKS
);

421 
	`check
(
»p
 !ğ
NULL
, "Should‚ever get‡ NULL fromhe control…ortƒxecutor.");

423 
	`sk¡©e
("replying");

424 
rc
 = 
	`£nd_»¶y
(
CONTROL_SOCKET
, 
»p
);

425 
	`check
(
rc
 == 0, "Failedo send‡„eply.");

427 
	`Šs_v®ue_de¡roy
(
»q
);

428 
	`Šs_v®ue_de¡roy
(
»p
);

431 
rc
 = 
	`zmq_şo£
(
CONTROL_SOCKET
);

432 
	`check
(
rc
 == 0, "Failedo close control…ort socket.");

433 
CONTROL_SOCKET
 = 
NULL
;

434 
	`log_šfo
("Control…ortƒxiting.");

435 
	`skex™
(0);

437 
”rÜ
:

438 
	`log_šfo
("Control…ortƒxiting withƒrror.");

439 
	`zmq_şo£
(
CONTROL_SOCKET
);

440 
CONTROL_SOCKET
 = 
NULL
;

441 
	`skex™
(1);

442 
	}
}

445 
	$CÚŒŞ_pÜt_¡¬t
()

447 
	`skü—‹
(
CÚŒŞ_sk
, 
NULL
, 32 * 1024);

448 
	}
}

450 
	$CÚŒŞ_pÜt_¡İ
()

452 
CONTROL_RUNNING
 = 0;

453 
	}
}

	@src/control.h

1 #iâdeà
_cÚŒŞ_h


2 
	#_cÚŒŞ_h


	)

4 
CÚŒŞ_pÜt_¡¬t
();

6 
CÚŒŞ_pÜt_¡İ
();

	@src/dbg.c

35 
	~"dbg.h
"

37 
FILE
 *
	gLOG_FILE
 = 
NULL
;

39 
	$dbg_£t_log
(
FILE
 *
log_fe
)

41 
LOG_FILE
 = 
log_fe
;

42 
	}
}

45 
FILE
 *
	$dbg_g‘_log
()

47  
LOG_FILE
 !ğ
NULL
 ? LOG_FILE : 
¡d”r
;

48 
	}
}

	@src/dbg.h

35 #iâdeà
__dbg_h__


36 
	#__dbg_h__


	)

38 
	~<¡dio.h
>

39 
	~<”ºo.h
>

40 
	~<¡ršg.h
>

42 
dbg_£t_log
(
FILE
 *
log_fe
);

43 
FILE
 *
dbg_g‘_log
();

45 #ifdeà
NDEBUG


46 
	#debug
(
M
, ...)

	)

48 
	#debug
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "DEBUG %s:%d: " M "\n", 
__FILE__
, 
__LINE__
, ##
__VA_ARGS__
)

	)

55 
	#check_debug
(
A
, 
M
, ...èif(!(A)è{ 
	`debug
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

57 
	#ş—n_”ºo
(è(
”ºo
 =ğ0 ? "NÚe" : 
	`¡»¼Ü
Ó¼no))

	)

59 #ifdeà
NO_LINENOS


61 
	#log_”r
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[ERROR] (”ºo: %sè" M "\n", 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

62 
	#log_w¬n
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[WARN] (”ºo: %sè" M "\n", 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

63 
	#log_šfo
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[INFO] " M "\n", ##
__VA_ARGS__
)

	)

65 
	#log_”r
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[ERROR] (%s:%d:ƒ¼no: %sè" M "\n", 
__FILE__
, 
__LINE__
, 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

66 
	#log_w¬n
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[WARN] (%s:%d:ƒ¼no: %sè" M "\n", 
__FILE__
, 
__LINE__
, 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

67 
	#log_šfo
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[INFO] (%s:%dè" M "\n", 
__FILE__
, 
__LINE__
, ##
__VA_ARGS__
)

	)

70 
	#check
(
A
, 
M
, ...èif(!(A)è{ 
	`log_”r
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

72 
	#£Áš–
(
M
, ...è{ 
	`log_”r
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

74 
	#check_mem
(
A
è
	`check
((A), "OuˆoàmemÜy.")

	)

76 
	#TRACE
(
C
,
E
è
	`debug
("--> %s(%s:%dè%s:%d ", "" #C, 
	`S‹_ev’t_Çme
(E), E, 
__FUNCTION__
, 
__LINE__
)

	)

78 
	#”rÜ_»¥Ú£
(
F
, 
C
, 
M
, ...è{
	`Re¥Ú£_£nd_¡©us
(F, &
HTTP_
##C); 
	`£Áš–
(M, ##
__VA_ARGS__
);}

	)

80 
	#”rÜ_uÆess
(
T
, 
F
, 
C
, 
M
, ...èif(!(T)è
	`”rÜ_»¥Ú£
(F, C, M, ##
__VA_ARGS__
)

	)

	@src/dir.c

35 
	#_FILE_OFFSET_BITS
 64

	)

36 
	~<dœ.h
>

37 
	~<ÿche.h
>

38 
	~<fú.h
>

39 
	~<dbg.h
>

40 
	~<sk/sk.h
>

41 
	~<¡ršg.h
>

42 
	~<·‰”n.h
>

43 
	~<as£¹.h
>

44 
	~<mime.h
>

45 
	~<»¥Ú£.h
>

46 
	~"v”siÚ.h
"

47 
	~"£‰šg.h
"

49 
	gMAX_DIR_PATH
 = 0;

50 
	gMAX_SEND_BUFFER
 = 0;

52 
gb¡ršg
 
	gETAG_PATTERN
 = 
bsStic
("[a-e0-9]+-[a-e0-9]+");

54 cÚ¡ *
	gRESPONSE_FORMAT
 = "HTTP/1.1 200 OK\r\n"

60 "S”v”: " 
VERSION


63 cÚ¡ *
	gDIR_REDIRECT_FORMAT
 = "HTTP/1.1 301 Moved Permanently\r\n"

66 "S”v”: " 
VERSION


70 cÚ¡ *
	gRFC_822_TIME
 = "%a, %d %b %Y %H:%M:%S GMT";

72 
	$f”ecÜd_ÿche_lookup
(*
d©a
, *
key
) {

73 
b¡ršg
 
»que¡_·th
 = (b¡ršgè
key
;

74 
FeRecÜd
 *
ä
 = (FeRecÜd *è
d©a
;

76  !
	`b¡rcmp
(
ä
->
»que¡_·th
,„equest_path);

77 
	}
}

79 
	$f”ecÜd_ÿche_eviù
(*
d©a
) {

80 
	`FeRecÜd_»Ëa£
((
FeRecÜd
 *è
d©a
);

81 
	}
}

84 
FeRecÜd
 *
	$Dœ_fšd_fe
(
b¡ršg
 
·th
, b¡ršg 
deçuÉ_ty³
)

86 
FeRecÜd
 *
ä
 = 
	`ÿÎoc
((FileRecord), 1);

87 cÚ¡ *
p
 = 
	`bd©a
(
·th
);

89 
	`check_mem
(
ä
);

92 
ä
->
u£rs
 = 1;

94 
rc
 = 
	`¡©
(
p
, &
ä
->
sb
);

95 
	`check
(
rc
 =ğ0, "F¡© faed: %s", 
	`bd©a
(
·th
));

97 if(
	`S_ISDIR
(
ä
->
sb
.
¡_mode
)) {

98 
ä
->
fuÎ_·th
 = 
·th
;

99 
ä
->
is_dœ
 = 1;

100  
ä
;

103 
ä
->
fd
 = 
	`İ’
(
p
, 
O_RDONLY
);

104 
	`check
(
ä
->
fd
 >ğ0, "FaedØİ’ fbuˆ¡© wÜked: %s", 
	`bd©a
(
·th
));

106 
ä
->
fe_size
 = 
	`l£ek
(ä->
fd
, 0L, 
SEEK_END
);

107 
	`l£ek
(
ä
->
fd
, 0L, 
SEEK_SET
);

109 
ä
->
lßded
 = 
	`time
(
NULL
);

111 
ä
->
Ï¡_mod
 = 
	`bSŒfTime
(
RFC_822_TIME
, 
	`gmtime
(&ä->
sb
.
¡_mtime
));

112 
	`check
(
ä
->
Ï¡_mod
, "Failedo format†ast modifiedime.");

115 
ä
->
cÚ‹Á_ty³
 = 
	`MIME_m©ch_ext
(
·th
, 
deçuÉ_ty³
);

116 
	`check
(
ä
->
cÚ‹Á_ty³
, "Should‡lways get‡ contentype back.");

119 
ä
->
fuÎ_·th
 = 
·th
;

121 
time_t
 
now
 = 
	`time
(
NULL
);

123 
ä
->
d©e
 = 
	`bSŒfTime
(
RFC_822_TIME
, 
	`gmtime
(&
now
));

125 
ä
->
‘ag
 = 
	`bfÜm©
("%x-%x", fr->
sb
.
¡_mtime
, fr->
fe_size
);

127 
ä
->
h—d”
 = 
	`bfÜm©
(
RESPONSE_FORMAT
,

128 
	`bd©a
(
ä
->
d©e
),

129 
	`bd©a
(
ä
->
cÚ‹Á_ty³
),

130 
ä
->
fe_size
,

131 
	`bd©a
(
ä
->
Ï¡_mod
),

132 
	`bd©a
(
ä
->
‘ag
));

134 
	`check
(
ä
->
h—d”
 !ğ
NULL
, "Failedo create„esponse header.");

136  
ä
;

138 
”rÜ
:

139 
	`FeRecÜd_de¡roy
(
ä
);

140  
NULL
;

141 
	}
}

143 
šlše
 
	$Dœ_£nd_h—d”
(
FeRecÜd
 *
fe
, 
CÚÃùiÚ
 *
cÚn
)

145  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
fe
->
h—d”
), 
	`bËngth
(file->header));

146 
	}
}

148 
	$Dœ_¡»am_fe
(
FeRecÜd
 *
fe
, 
CÚÃùiÚ
 *
cÚn
)

150 
£Á
 = 0;

152 
rc
 = 
	`Dœ_£nd_h—d”
(
fe
, 
cÚn
);

153 
	`check_debug
(
rc
, "Failedo write headero socket.");

155 
£Á
 = 
	`IOBuf_¡»am_fe
(
cÚn
->
iob
, 
fe
->
fd
, fe->
fe_size
);

157  
fe
->
fe_size
;

159 
”rÜ
:

161 
	}
}

164 
Dœ
 *
	$Dœ_ü—‹
(
b¡ršg
 
ba£
, b¡ršg 
šdex_fe
, b¡ršg 
deçuÉ_ùy³
, 
ÿche_‰l
)

166 
Dœ
 *
dœ
 = 
	`ÿÎoc
((Dir), 1);

167 
	`check_mem
(
dœ
);

169 
dœ
->
ruÂšg
 = 1;

171 if(!
MAX_SEND_BUFFER
 || !
MAX_DIR_PATH
) {

172 
MAX_SEND_BUFFER
 = 
	`S‘tšg_g‘_št
("limits.dir_send_buffer", 16 * 1024);

173 
MAX_DIR_PATH
 = 
	`S‘tšg_g‘_št
("limits.dir_max_path", 256);

174 
	`log_šfo
("MAX†imits.dir_send_buffer=%d,†imits.dir_max_path=%d",

175 
MAX_SEND_BUFFER
, 
MAX_DIR_PATH
);

178 
dœ
->
ba£
 = 
	`b¡rıy
(base);

179 
	`check
(
	`bËngth
(
dœ
->
ba£
è< 
MAX_DIR_PATH
, "Base directory isoo†ong, must be†esshan %d", MAX_DIR_PATH);

180 
	`check
(
	`bch¬
(
dœ
->
ba£
, 0è!ğ'/', "DÚ'ˆ¡¬ˆthba£ w™h / iÀ%s,h© wÈç wh’‚Ù iÀchroÙ.", 
	`bd©a
(base));

181 
	`check
(
	`bch¬
(
dœ
->
ba£
, 
	`bËngth
(dœ->ba£è- 1è=ğ'/', "End dœeùÜy ba£ w™h / iÀ% Ü iˆwÚ'ˆwÜk„ight.", 
	`bd©a
(base));

183 
dœ
->
šdex_fe
 = 
	`b¡rıy
(index_file);

184 
dœ
->
deçuÉ_ùy³
 = 
	`b¡rıy
(default_ctype);

186 
dœ
->
ä_ÿche
 = 
	`Cache_ü—‹
(
FR_CACHE_SIZE
, 
f”ecÜd_ÿche_lookup
,

187 
f”ecÜd_ÿche_eviù
);

188 
	`check
(
dœ
->
ä_ÿche
, "Failedo create FileRecord cache");

190 
	`check
(
ÿche_‰l
 >= 0, "Invalid cachetl, must be‡…ositive integer");

191 
dœ
->
ÿche_‰l
 = cache_ttl;

193  
dœ
;

195 
”rÜ
:

196 if(
dœ
)

197 
	`ä“
(
dœ
);

199  
NULL
;

200 
	}
}

204 
	$Dœ_de¡roy
(
Dœ
 *
dœ
)

206 if(
dœ
) {

207 
	`bde¡roy
(
dœ
->
ba£
);

208 
	`bde¡roy
(
dœ
->
šdex_fe
);

209 
	`bde¡roy
(
dœ
->
nÜm®ized_ba£
);

210 
	`bde¡roy
(
dœ
->
deçuÉ_ùy³
);

211 if(
dœ
->
ä_ÿche
è
	`Cache_de¡roy
(dir->fr_cache);

212 
	`ä“
(
dœ
);

214 
	}
}

216 
	$FeRecÜd_»Ëa£
(
FeRecÜd
 *
fe
)

218 if(
fe
) {

219 
fe
->
u£rs
--;

220 
	`check
(
fe
->
u£rs
 >= 0, "User count on file„ecord somehow fell below 0");

221 if(
fe
->
u£rs
 <ğ0è
	`FeRecÜd_de¡roy
(file);

224 
”rÜ
:

226 
	}
}

228 
	$FeRecÜd_de¡roy
(
FeRecÜd
 *
fe
)

230 if(
fe
) {

231 if(!
fe
->
is_dœ
) {

232 
	`fdşo£
(
fe
->
fd
);

233 
	`bde¡roy
(
fe
->
d©e
);

234 
	`bde¡roy
(
fe
->
Ï¡_mod
);

235 
	`bde¡roy
(
fe
->
h—d”
);

236 
	`bde¡roy
(
fe
->
‘ag
);

238 
	`bde¡roy
(
fe
->
fuÎ_·th
);

240 
	`ä“
(
fe
);

242 
	}
}

245 
šlše
 
	$nÜm®ize_·th
(
b¡ršg
 
rg‘
)

247 
	`b®locmš
(
rg‘
, 
PATH_MAX
);

248 *
·th_buf
 = 
NULL
;

251 if(
·th_buf
 =ğ
NULL
) {

252 
·th_buf
 = 
	`ÿÎoc
(
PATH_MAX
+1, 1);

253 
	`check_mem
(
·th_buf
);

256 *
nÜm®ized
 = 
	`»®·th
((cÚ¡ *)(
	`bd©a
(
rg‘
)), 
·th_buf
);

257 
	`check_debug
(
nÜm®ized
, "FaedØnÜm®iz·th: %s", 
	`bd©a
(
rg‘
));

259 
	`bassignc¡r
(
rg‘
, 
nÜm®ized
);

263 
”rÜ
:

265 
	}
}

267 
šlše
 
	$Dœ_Ïzy_nÜm®ize_ba£
(
Dœ
 *
dœ
)

269 if(
dœ
->
nÜm®ized_ba£
 =ğ
NULL
) {

270 
dœ
->
nÜm®ized_ba£
 = 
	`b¡rıy
(dœ->
ba£
);

271 
	`check
(
	`nÜm®ize_·th
(
dœ
->
nÜm®ized_ba£
) == 0,

272 "FaedØnÜm®izba£…©h: %s", 
	`bd©a
(
dœ
->
nÜm®ized_ba£
));

274 
	`debug
("Lazy‚Üm®ized ba£…©h % štØ%s", 
	`bd©a
(
dœ
->
ba£
), bd©a(dœ->
nÜm®ized_ba£
));

278 
”rÜ
:

280 
	}
}

282 
FeRecÜd
 *
	$FeRecÜd_ÿche_check
(
Dœ
 *
dœ
, 
b¡ršg
 
·th
)

284 
FeRecÜd
 *
fe
 = 
	`Cache_lookup
(
dœ
->
ä_ÿche
, 
·th
);

286 if(
fe
) {

287 
time_t
 
now
 = 
	`time
(
NULL
);

288 cÚ¡ *
p
 = 
	`bd©a
(
fe
->
fuÎ_·th
);

289 
¡©
 
sb
;

291 if(
	`difáime
(
now
, 
fe
->
lßded
è> 
dœ
->
ÿche_‰l
) {

292 
rc¡©
 = 
	`¡©
(
p
, &
sb
);

294 if(
rc¡©
 !ğ0 || 
fe
->
sb
.
¡_mtime
 !ğsb.¡_mtim|| fe->sb.
¡_size
 != sb.st_size) {

295 
	`Cache_eviù_objeù
(
dœ
->
ä_ÿche
, 
fe
);

296 
fe
 = 
NULL
;

298 
fe
->
lßded
 = 
now
;

303  
fe
;

304 
	}
}

307 
FeRecÜd
 *
	$Dœ_»sŞve_fe
(
Dœ
 *
dœ
, 
b¡ršg
 
´efix
, b¡ršg 
·th
)

309 
FeRecÜd
 *
fe
 = 
NULL
;

310 
b¡ršg
 
rg‘
 = 
NULL
;

312 
	`check
(
	`Dœ_Ïzy_nÜm®ize_ba£
(
dœ
) == 0, "Failedo‚ormalize base…ath when„equesting %s",

313 
	`bd©a
(
·th
));

315 
fe
 = 
	`FeRecÜd_ÿche_check
(
dœ
, 
·th
);

317 if(
fe
) {

319 
fe
->
u£rs
++;

320  
fe
;

323 
	`check
(
	`bch¬
(
´efix
, 0è=ğ'/', "Rou‹ '%s'…oštšgØdœeùÜy mu¡ hav´efix w™h†—dšg '/'", 
	`bd©a
(prefix));

324 
	`check
(
	`bËngth
(
´efix
è< 
MAX_DIR_PATH
, "Prefix isoo†ong, must be†esshan %d", MAX_DIR_PATH);

326 
	`debug
("Buildingarget from base: %s…refix: %s…ath: %s index_file: %s",

327 
	`bd©a
(
dœ
->
nÜm®ized_ba£
),

328 
	`bd©a
(
´efix
),

329 
	`bd©a
(
·th
),

330 
	`bd©a
(
dœ
->
šdex_fe
));

332 if(
	`bch¬
(
·th
, 
	`bËngth
(path) - 1) == '/') {

334 
rg‘
 = 
	`bfÜm©
("%s/%s%s",

335 
	`bd©a
(
dœ
->
nÜm®ized_ba£
),

336 
	`bd©aofs
(
·th
, 
	`bËngth
(
´efix
)),

337 
	`bd©a
(
dœ
->
šdex_fe
));

338 } if(
	`bi£q
(
´efix
, 
·th
)) {

339 
rg‘
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
dœ
->
nÜm®ized_ba£
), bd©a(
·th
));

342 
rg‘
 = 
	`bfÜm©
("%s/%s", 
	`bd©a
(
dœ
->
nÜm®ized_ba£
), 
	`bd©aofs
(
·th
, 
	`bËngth
(
´efix
)));

345 
	`check_mem
(
rg‘
);

347 
	`check_debug
(
	`nÜm®ize_·th
(
rg‘
) == 0,

348 "FaedØnÜm®izrg‘…©h: %s", 
	`bd©a
(
rg‘
));

350 
	`check_debug
(
	`b¡ºcmp
(
rg‘
, 
dœ
->
nÜm®ized_ba£
, 
	`bËngth
(dir->normalized_base)) == 0,

352 
	`bd©a
(
rg‘
), bd©a(
dœ
->
ba£
));

355 
fe
 = 
	`Dœ_fšd_fe
(
rg‘
, 
dœ
->
deçuÉ_ùy³
);

356 
	`check_debug
(
fe
, "E¼Ü o³nšg fe: %s", 
	`bd©a
(
rg‘
));

359 
fe
->
u£rs
++;

360 
fe
->
»que¡_·th
 = 
	`b¡rıy
(
·th
);

361 
	`Cache_add
(
dœ
->
ä_ÿche
, 
fe
);

363  
fe
;

365 
”rÜ
:

366 
	`bde¡roy
(
rg‘
);

367 
	`FeRecÜd_»Ëa£
(
fe
);

368  
NULL
;

369 
	}
}

372 
šlše
 
b¡ršg
 
	$Dœ_if_modif›d_sšû
(
Reque¡
 *
»q
, 
FeRecÜd
 *
fe
, 
if_modif›d_sšû
)

374 if(
if_modif›d_sšû
 <ğ()
	`time
(
NULL
è&& 
fe
->
sb
.
¡_mtime
 <= if_modified_since) {

375 
»q
->
¡©us_code
 = 304;

376  &
HTTP_304
;

378  
NULL
;

381 
»q
->
¡©us_code
 = 500;

382  &
HTTP_500
;

383 
	}
}

385 
šlše
 
b¡ršg
 
	$Dœ_nÚe_m©ch
(
Reque¡
 *
»q
, 
FeRecÜd
 *
fe
, 
if_modif›d_sšû
, 
b¡ršg
 
if_nÚe_m©ch
)

387 if(
	`bi£qc¡r
(
if_nÚe_m©ch
, "*"è|| 
	`bi£q
(if_nÚe_m©ch, 
fe
->
‘ag
)) {

388 
»q
->
¡©us_code
 = 304;

389  &
HTTP_304
;

391 if(
if_modif›d_sšû
) {

392  
	`Dœ_if_modif›d_sšû
(
»q
, 
fe
, 
if_modif›d_sšû
);

394  
NULL
;

398 
»q
->
¡©us_code
 = 500;

399  &
HTTP_500
;

400 
	}
}

402 
šlše
 
b¡ršg
 
	$Dœ_ÿlcuÏ‹_»¥Ú£
(
Reque¡
 *
»q
, 
FeRecÜd
 *
fe
)

404 
if_unmodif›d_sšû
 = 0;

405 
if_modif›d_sšû
 = 0;

406 
b¡ršg
 
if_m©ch
 = 
NULL
;

407 
b¡ršg
 
if_nÚe_m©ch
 = 
NULL
;

409 if(
fe
) {

410 if(
fe
->
is_dœ
)

411  
	`bfÜm©
(
DIR_REDIRECT_FORMAT
, 
	`bd©a
(
»q
->
ho¡
),

412 
	`bd©a
(
»q
->
uri
));

414 
if_m©ch
 = 
	`Reque¡_g‘
(
»q
, &
HTTP_IF_MATCH
);

416 if(!
if_m©ch
 || 
	`bi£qc¡r
(if_m©ch, "*"è|| 
	`b¡ršg_m©ch
(if_m©ch, &
ETAG_PATTERN
)) {

417 
if_nÚe_m©ch
 = 
	`Reque¡_g‘
(
»q
, &
HTTP_IF_NONE_MATCH
);

418 
if_unmodif›d_sšû
 = 
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_UNMODIFIED_SINCE
, 
RFC_822_TIME
);

419 
if_modif›d_sšû
 = 
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_MODIFIED_SINCE
, 
RFC_822_TIME
);

421 
	`debug
("TESTING WITH: if_match: %s, if_none_match: %s, if_unmodified_since: %d, if_modified_since: %d",

422 
	`bd©a
(
if_m©ch
), bd©a(
if_nÚe_m©ch
), 
if_unmodif›d_sšû
, 
if_modif›d_sšû
);

424 if(
if_unmodif›d_sšû
) {

425 if(
fe
->
sb
.
¡_mtime
 > 
if_unmodif›d_sšû
) {

426 
»q
->
¡©us_code
 = 412;

427  &
HTTP_412
;

428 } if(
if_nÚe_m©ch
) {

429  
	`Dœ_nÚe_m©ch
(
»q
, 
fe
, 
if_modif›d_sšû
, 
if_nÚe_m©ch
);

430 } if(
if_modif›d_sšû
) {

431  
	`Dœ_if_modif›d_sšû
(
»q
, 
fe
, 
if_modif›d_sšû
);

433 } if(
if_nÚe_m©ch
) {

434  
	`Dœ_nÚe_m©ch
(
»q
, 
fe
, 
if_modif›d_sšû
, 
if_nÚe_m©ch
);

435 } if(
if_modif›d_sšû
) {

436  
	`Dœ_if_modif›d_sšû
(
»q
, 
fe
, 
if_modif›d_sšû
);

439 
»q
->
¡©us_code
 = 200;

440  
NULL
;

443 
»q
->
¡©us_code
 = 412;

444  &
HTTP_412
;

447 
»q
->
¡©us_code
 = 404;

448  &
HTTP_404
;

451 
»q
->
¡©us_code
 = 500;

452  &
HTTP_500
;

453 
	}
}

455 
	$Dœ_£rve_fe
(
Dœ
 *
dœ
, 
Reque¡
 *
»q
, 
CÚÃùiÚ
 *
cÚn
)

457 
FeRecÜd
 *
fe
 = 
NULL
;

458 
b¡ršg
 
»¥
 = 
NULL
;

459 
b¡ršg
 
·th
 = 
	`Reque¡_·th
(
»q
);

460 
b¡ršg
 
´efix
 = 
»q
->prefix;

461 
	`check
(
´efix
 !ğ
NULL
, "Request without‡…refix hit.");

462 
	`check
(
dœ
->
ruÂšg
, "Directory is‚ot„unning‡nymore.");

464 
rc
 = 0;

465 
is_g‘
 = 
	`bi£q
(
»q
->
»que¡_m‘hod
, &
HTTP_GET
);

466 
is_h—d
 = 
is_g‘
 ? 0 : 
	`bi£q
(
»q
->
»que¡_m‘hod
, &
HTTP_HEAD
);

468 
	`check
(
·th
, "Request had‚ot…ath. That's weird.");

469 
»q
->
»¥Ú£_size
 = 0;

471 if(!(
is_g‘
 || 
is_h—d
)) {

472 
»q
->
¡©us_code
 = 405;

473 
rc
 = 
	`Re¥Ú£_£nd_¡©us
(
cÚn
, &
HTTP_405
);

474 
	`check_debug
(
rc
 =ğ
	`bËngth
(&
HTTP_405
), "Failedo send 405o client.");

477 
fe
 = 
	`Dœ_»sŞve_fe
(
dœ
, 
´efix
, 
·th
);

478 
»¥
 = 
	`Dœ_ÿlcuÏ‹_»¥Ú£
(
»q
, 
fe
);

480 if(
»¥
) {

481 
rc
 = 
	`Re¥Ú£_£nd_¡©us
(
cÚn
, 
»¥
);

482 
	`check_debug
(
rc
 =ğ
	`bËngth
(
»¥
), "Failedo sendƒrror„esponse on file serving.");

483 } if(
is_g‘
) {

484 
rc
 = 
	`Dœ_¡»am_fe
(
fe
, 
cÚn
);

485 
»q
->
»¥Ú£_size
 = 
rc
;

486 
	`check_debug
(
rc
 =ğ
fe
->
fe_size
, "Didn'ˆ£nd‡Î oàthfe, s’ˆ%Îd oà%s.",„c, 
	`bd©a
(
·th
));

487 } if(
is_h—d
) {

488 
rc
 = 
	`Dœ_£nd_h—d”
(
fe
, 
cÚn
);

489 
	`check_debug
(
rc
, "Failedo write headero socket.");

491 
	`£Áš–
("Howhe hell did you geto here. Tell Zed.");

494 
	`FeRecÜd_»Ëa£
(
fe
);

498 
	`£Áš–
("Invalid code branch, Tell Zed you have magic.");

499 
”rÜ
:

500 
	`FeRecÜd_»Ëa£
(
fe
);

502 
	}
}

	@src/dir.h

35 #iâdeà
_dœ_h


36 
	#_dœ_h


	)

38 #iâdeà
_FILE_OFFSET_BITS


39 
	#_FILE_OFFSET_BITS
 64

	)

42 
	~<¡dlib.h
>

44 
	~<b¡ršg.h
>

45 
	~<ÿche.h
>

46 
	~<sys/ty³s.h
>

47 
	~<sys/¡©.h
>

48 
	~<uni¡d.h
>

49 
	~<»que¡.h
>

50 
	~<cÚÃùiÚ.h
>

51 
	~"v”siÚ.h
"

53 
MAX_SEND_BUFFER
;

54 
MAX_DIR_PATH
;

56 cÚ¡ *
RESPONSE_FORMAT
;

58 
	sFeRecÜd
 {

59 
	mis_dœ
;

60 
	mfd
;

61 
	mu£rs
;

62 
time_t
 
	mlßded
;

63 
b¡ršg
 
	md©e
;

64 
b¡ršg
 
	mÏ¡_mod
;

65 
b¡ršg
 
	mcÚ‹Á_ty³
;

66 
b¡ršg
 
	mh—d”
;

67 
b¡ršg
 
	m»que¡_·th
;

68 
b¡ršg
 
	mfuÎ_·th
;

69 
b¡ršg
 
	m‘ag
;

70 
¡©
 
	msb
;

71 
off_t
 
	mfe_size
;

72 } 
	tFeRecÜd
;

74 
	sDœ
 {

75 
	mruÂšg
;

76 
Cache
 *
	mä_ÿche
;

77 
b¡ršg
 
	mba£
;

78 
b¡ršg
 
	mnÜm®ized_ba£
;

79 
b¡ršg
 
	mšdex_fe
;

80 
b¡ršg
 
	mdeçuÉ_ùy³
;

81 
	mÿche_‰l
;

82 } 
	tDœ
;

84 
Dœ
 *
Dœ_ü—‹
(
b¡ršg
 
ba£
, b¡ršg 
šdex_fe
,

85 
b¡ršg
 
deçuÉ_ùy³
, 
ÿche_‰l
);

87 
Dœ_de¡roy
(
Dœ
 *
dœ
);

89 
FeRecÜd
 *
Dœ_fšd_fe
(
b¡ršg
 
·th
, b¡ršg 
deçuÉ_ty³
);

91 
Dœ_¡»am_fe
(
FeRecÜd
 *
fe
, 
CÚÃùiÚ
 *
cÚn
);

93 
Dœ_£rve_fe
(
Dœ
 *
dœ
, 
Reque¡
 *
»q
, 
CÚÃùiÚ
 *
cÚn
);

95 
FeRecÜd
 *
Dœ_»sŞve_fe
(
Dœ
 *
dœ
, 
b¡ršg
 
´efix
, b¡ršg 
·th
);

97 
FeRecÜd_»Ëa£
(
FeRecÜd
 *
fe
);

98 
FeRecÜd_de¡roy
(
FeRecÜd
 *
fe
);

100 
	#FR_CACHE_SIZE
 32

	)

	@src/events.h

35 #iâdeà
_ev’ts_h


36 
	#_ev’ts_h


	)

38 
	#EVENT_MIN
 100

	)

40 
	eS‹Ev’t
 {

41 
	mCLOSE
=100,

42 
	mCONNECT
=101,

43 
	mDIRECTORY
=102,

44 
	mFAILED
=103,

45 
	mHANDLER
=104,

46 
	mHTTP_REQ
=105,

47 
	mMSG_REQ
=106,

48 
	mOPEN
=107,

49 
	mPROXY
=108,

50 
	mREMOTE_CLOSE
=109,

51 
	mREQ_RECV
=110,

52 
	mREQ_SENT
=111,

53 
	mRESP_SENT
=112,

54 
	mSOCKET_REQ
=113,

55 
	mTIMEOUT
=114,

56 
	mEVENT_END
=115

57 } 
	tS‹Ev’t
 ;

	@src/filter.c

35 
	~"f‹r.h
"

36 
	~"adt/d¬¿y.h
"

37 
	~"mem/h®loc.h
"

38 
	~<dlfú.h
>

42 
d¬¿y_t
 *
	gREGISTERED_FILTERS
 = 
NULL
;

43 
	gFILTERS_ACTIVATED
 = 0;

45 
	$F‹r_š™
()

47 
REGISTERED_FILTERS
 = 
	`d¬¿y_ü—‹
((
d¬¿y_t
 *), 
EVENT_END
 - 
EVENT_MIN
);

48 
	`check_mem
(
REGISTERED_FILTERS
);

51 
”rÜ
:

53 
	}
}

58 
	$F‹r_de¡roy
()

60 
	`d¬¿y_de¡roy
(
REGISTERED_FILTERS
);

61 
REGISTERED_FILTERS
 = 
NULL
;

62 
	}
}

64 
šlše
 
d¬¿y_t
 *
	$F‹r_lookup
(
S‹Ev’t
 
Ãxt
)

66  
	`d¬¿y_g‘
(
REGISTERED_FILTERS
, 
Ãxt
 - 
EVENT_MIN
);

67 
	}
}

69 
šlše
 
d¬¿y_t
 *
	$F‹r_lookup_ü—‹
(
S‹Ev’t
 
Ãxt
)

71 
d¬¿y_t
 *
fts
 = 
	`F‹r_lookup
(
Ãxt
);

73 if(
fts
 =ğ
NULL
) {

75 
fts
 = 
	`d¬¿y_ü—‹
((
F‹r
), 10);

76 
	`check_mem
(
fts
);

77 
	`d¬¿y_£t
(
REGISTERED_FILTERS
, 
Ãxt
 - 
EVENT_MIN
, 
fts
);

80  
fts
;

81 
”rÜ
:

82  
NULL
;

83 
	}
}

86 
	$F‹r_run
(
S‹Ev’t
 
Ãxt
, 
CÚÃùiÚ
 *
cÚn
)

88 
i
 = 0;

89 
S‹Ev’t
 
»s
 = 
Ãxt
;

90 
	`check
(
REGISTERED_FILTERS
 !ğ
NULL
, "No filters†oaded yet, don't callhis.");

92 
d¬¿y_t
 *
f‹rs
 = 
	`F‹r_lookup
(
Ãxt
);

94 if(
f‹rs
 !ğ
NULL
) {

95 
i
 = 0; i < 
	`d¬¿y_’d
(
f‹rs
è&& 
»s
 =ğ
Ãxt
; i++) {

96 
F‹r
 *
f‹r
 = 
	`d¬¿y_g‘
(
f‹rs
, 
i
);

97 
	`check
(
f‹r
 !ğ
NULL
, "Expectedo get‡ filter„ecord but got NULL.");

99 
»s
 = 
f‹r
->
	`cb
(
Ãxt
, 
cÚn
);

100 
	`check
(
»s
 >ğ
CLOSE
 &&„e < 
EVENT_END
,

101 "F‹¸% »tuºed inv®idƒv’t: %d", 
	`bd©a
(
f‹r
->
lßd_·th
), 
»s
);

105  
»s
;

107 
”rÜ
:

109 
	}
}

111 
	$F‹r_add
(
S‹Ev’t
 
¡©e
, 
f‹r_cb
 
cb
, 
b¡ršg
 
lßd_·th
)

113 
d¬¿y_t
 *
f‹rs
 = 
	`F‹r_lookup_ü—‹
(
¡©e
);

114 
	`check
(
f‹rs
 !ğ
NULL
, "Invalid filter state: %d given for filter %s",

115 
¡©e
, 
	`bd©a
(
lßd_·th
));

117 
F‹r
 *
f‹r
 = 
	`h_ÿÎoc
((Filter), 1);

118 
	`check_mem
(
f‹r
);

120 
	`h©ch
(
f‹rs
->
cÚ‹Ás
, 
f‹r
);

122 
f‹r
->
¡©e
 = state;

123 
f‹r
->
cb
 = cb;

124 
f‹r
->
lßd_·th
 = 
	`b¡rıy
(load_path);

126 
	`d¬¿y_push
(
f‹rs
, 
f‹r
);

129 
”rÜ
:

131 
	}
}

134 
	$F‹r_lßd
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
)

136 
i
 = 0;

138 if(
REGISTERED_FILTERS
 =ğ
NULL
) {

139 
	`check
(
	`F‹r_š™
() == 0, "Failedo initialize filter storage.");

140 
FILTERS_ACTIVATED
 = 1;

144 *
lib
 = 
	`dlİ’
(
	`bd©a
(
lßd_·th
), 
RTLD_LAZY
 | 
RTLD_LOCAL
);

145 
	`check
(
lib
 !ğ
NULL
, "FaedØlßd f‹¸%s: %s.", 
	`bd©a
(
lßd_·th
), 
	`dË¼Ü
());

148 
f‹r_š™_cb
 
š™
 = 
	`dlsym
(
lib
, "filter_init");

149 
	`check
(
š™
 !ğ
NULL
, "F‹¸% dÛ¢'ˆhavª in™ funùiÚ.", 
	`bd©a
(
lßd_·th
));

151 
n¡©es
 = 0;

152 
S‹Ev’t
 *
¡©es
 = 
	`š™
(
¤v
, 
lßd_·th
, &
n¡©es
);

153 
	`check
(
¡©es
 !ğ
NULL
, "In™ fÜ % »tuº NULL fau».", 
	`bd©a
(
lßd_·th
));

154 
	`check
(
n¡©es
 > 0, "In™ fÜ % »tuº <ğ0 s‹s,‚ÙhšgØdo.", 
	`bd©a
(
lßd_·th
));

156 
f‹r_cb
 
cb
 = 
	`dlsym
(
lib
, "filter_transition");

157 
	`check
(
cb
 !ğ
NULL
, "NØF‹r_Œªs™iÚ defšed iÀ%s, fa.", 
	`bd©a
(
lßd_·th
));

160 
i
 = 0; i < 
n¡©es
; i++) {

161 
S‹Ev’t
 
¡©e
 = 
¡©es
[
i
];

162 
	`check
(
¡©e
 >ğ
CLOSE
 && s‹ < 
EVENT_END
,

163 "Inv®id s‹„‘uº by % F‹r_š™: %d", 
	`bd©a
(
lßd_·th
), 
¡©e
);

166 
	`check
(
	`F‹r_add
(
¡©e
, 
cb
, 
lßd_·th
) == 0, "Failedo‡dd filter:state %s:%d",

167 
	`bd©a
(
lßd_·th
), 
¡©e
);

171 
”rÜ
:

173 
	}
}

	@src/filter.h

1 #iâdeà
_f‹r_h


2 
	#_f‹r_h


	)

4 
	~"cÚÃùiÚ.h
"

5 
	~"b¡ršg.h
"

6 
	~"ev’ts.h
"

8 
FILTERS_ACTIVATED
;

10 
	$S‹Ev’t
 (*
	tf‹r_cb
)(
	tÃxt
, 
	tCÚÃùiÚ
 *
	tcÚn
);

11 
S‹Ev’t
* (*
	tf‹r_š™_cb
)(
	tS”v”
 *
	t¤v
, 
	tb¡ršg
 
	tlßd_·th
, *
	tout_n¡©es
);

13 
	sF‹r
 {

14 
¡©e
;

15 
f‹r_cb
 
cb
;

16 
b¡ršg
 
lßd_·th
;

17 } 
	tF‹r
;

19 
	`F‹r_š™
();

20 
	`F‹r_de¡roy
();

21 
	`F‹r_run
(
S‹Ev’t
 
Ãxt
, 
CÚÃùiÚ
 *
cÚn
);

22 
	`F‹r_add
(
S‹Ev’t
 
¡©e
, 
f‹r_cb
 
cb
, 
b¡ršg
 
lßd_·th
);

23 
	`F‹r_lßd
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
);

25 
šlše
 
S‹Ev’t
 *
	$F‹r_¡©e_li¡
(
S‹Ev’t
 *
¡©es
, 
Ëngth
)

27 
S‹Ev’t
 *
Ãw_¡©es
 = 
	`ÿÎoc
((S‹Ev’t), 
Ëngth
);

28 
	`memıy
(
Ãw_¡©es
, 
¡©es
, 
Ëngth
);

30  
Ãw_¡©es
;

31 
	}
}

33 
	#F‹r_¡©es_Ëngth
(
L
è((Lè/ (
S‹Ev’t
))

	)

35 
	#F‹r_aùiv©ed
(è(
FILTERS_ACTIVATED
)

	)

	@src/handler.c

35 
	~<hªdËr.h
>

36 
	~<hªdËr_·r£r.h
>

37 
	~<sk/sk.h
>

38 
	~<zmq.h
>

39 
	~<dbg.h
>

40 
	~<¡dlib.h
>

41 
	~<¡ršg.h
>

42 
	~<cÚÃùiÚ.h
>

43 
	~<as£¹.h
>

44 
	~<»gi¡”.h
>

46 
	~"£‰šg.h
"

48 
gb¡ršg
 
	gLEAVE_HEADER_JSON
 = 
bsStic
("{\"METHOD\":\"JSON\"}");

49 
gb¡ršg
 
	gLEAVE_HEADER_TNET
 = 
bsStic
("16:6:METHOD,4:JSON,}");

50 
gb¡ršg
 
	gLEAVE_MSG
 = 
bsStic
("{\"type\":\"disconnect\"}");

53 
	gHANDLER_STACK
;

55 
	$c¡r_ä“
(*
d©a
, *
hšt
)

57 
	`ä“
(
d©a
);

58 
	}
}

60 
	$HªdËr_nÙify_Ëave
(
HªdËr
 *
hªdËr
, 
id
)

62 *
sock‘
 = 
hªdËr
->
£nd_sock‘
;

63 
	`as£¹
(
sock‘
 && "Socket can't be NULL");

64 
b¡ršg
 
·ylßd
 = 
NULL
;

66 if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_TNET
) {

67 
·ylßd
 = 
	`bfÜm©
("%s %d @* %s%d:%s,",

68 
	`bd©a
(
hªdËr
->
£nd_id’t
), 
id
,

69 
	`bd©a
(&
LEAVE_HEADER_TNET
),

70 
	`bËngth
(&
LEAVE_MSG
), 
	`bd©a
(&LEAVE_MSG));

72 
·ylßd
 = 
	`bfÜm©
("%s %d @* %d:%s,%d:%s,",

73 
	`bd©a
(
hªdËr
->
£nd_id’t
), 
id
,

74 
	`bËngth
(&
LEAVE_HEADER_JSON
), 
	`bd©a
(&LEAVE_HEADER_JSON),

75 
	`bËngth
(&
LEAVE_MSG
), 
	`bd©a
(&LEAVE_MSG));

78 
	`check
(
·ylßd
 !ğ
NULL
, "Failedo makehe…ayload for disconnect.");

80 if(
	`HªdËr_d–iv”
(
sock‘
, 
	`bd©a
(
·ylßd
), 
	`bËngth
(payload)) == -1) {

81 
	`log_”r
("Cª'ˆ‹Î hªdË¸%d d›d.", 
id
);

84 
”rÜ
:

85 if(
·ylßd
è
	`ä“
(payload);

86 
	}
}

89 
	$HªdËr_£tup
(
HªdËr
 *
hªdËr
)

91 
	`skÇme
("Handler_task");

93 
hªdËr
->
sk
 = 
	`sk£lf
();

95 
hªdËr
->
£nd_sock‘
 = 
	`HªdËr_£nd_ü—‹
(
	`bd©a
(hªdËr->
£nd_¥ec
), bd©a(hªdËr->
£nd_id’t
));

96 
	`check
(
hªdËr
->
£nd_sock‘
, "Failedo create handler socket.");

98 
hªdËr
->
»cv_sock‘
 = 
	`HªdËr_»cv_ü—‹
(
	`bd©a
(hªdËr->
»cv_¥ec
), bd©a(hªdËr->
»cv_id’t
));

99 
	`check
(
hªdËr
->
»cv_sock‘
, "Failedo create†istener socket.");

103 
”rÜ
:

106 
	}
}

108 
šlše
 
	$hªdËr_ÿp_·ylßd
(
b¡ršg
 
·ylßd
)

110 if(
·ylßd
->
d©a
[·ylßd->
¦’
 - 1] == '\0') {

111 
	`bŒunc
(
·ylßd
, 
	`bËngth
(payload)-1);

112 } if(
·ylßd
->
d©a
[·ylßd->
¦’
] != '\0') {

113 
	`bcÚch¬
(
·ylßd
, '\0');

115 
	}
}

117 
šlše
 
	$d–iv”_·ylßd
(
¿w
, 
fd
, 
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
·ylßd
)

119 
rc
 = 0;

121 if(
¿w
) {

122 
	`debug
("S’dšg„aw mes§gtØ%d†’gth %d", 
fd
, 
	`bËngth
(
·ylßd
));

123 
rc
 = 
	`CÚÃùiÚ_d–iv”_¿w
(
cÚn
, 
·ylßd
);

124 
	`check
(
rc
 !ğ-1, "E¼Ü s’dšg„aw mes§gtØHTTP†i¡’” oÀFD %d, closšghem.", 
fd
);

126 
	`debug
("S’dšg BASE64 mes§gtØ%d†’gth %d", 
fd
, 
	`bËngth
(
·ylßd
));

127 
	`hªdËr_ÿp_·ylßd
(
·ylßd
);

128 
rc
 = 
	`CÚÃùiÚ_d–iv”
(
cÚn
, 
·ylßd
);

129 
	`check
(
rc
 !ğ-1, "E¼Ü s’dšgØMSG†i¡’” oÀFD %d, closšghem.", 
fd
);

133 
”rÜ
:

135 
	}
}

137 
šlše
 
	$hªdËr_´oûss_»que¡
(
HªdËr
 *
hªdËr
, 
id
, 
fd
,

138 
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
·ylßd
)

140 
rc
 = 0;

142 if(
cÚn
 =ğ
NULL
) {

143 
	`debug
("Id’ˆ%d (fd %dèi nØlÚg” cÚÃùed.", 
id
, 
fd
);

144 
	`HªdËr_nÙify_Ëave
(
hªdËr
, 
id
);

146 if(
	`bËngth
(
·ylßd
) == 0) {

147 
rc
 = 
	`Regi¡”_discÚÃù
(
fd
);

148 
	`check
(
rc
 !ğ-1, "Regi¡” discÚÃù faed fÜ: %d", 
fd
);

150 
¿w
 = 
cÚn
->
ty³
 !ğ
CONN_TYPE_MSG
 || 
hªdËr
->raw;

152 
rc
 = 
	`d–iv”_·ylßd
(
¿w
, 
fd
, 
cÚn
, 
·ylßd
);

153 
	`check
(
rc
 !ğ-1, "FaedØd–iv”ØcÚÃùiÚ %d oÀsock‘ %d", 
id
, 
fd
);

159 
”rÜ
:

160 
	`Regi¡”_discÚÃù
(
fd
);

162 
	}
}

165 
šlše
 
	$hªdËr_»cv_·r£
(
HªdËr
 *
hªdËr
, 
HªdËrP¬£r
 *
·r£r
)

167 
	`check
(
hªdËr
->
ruÂšg
, "Called while handler wasn't„unning,hat's‚ot good.");

169 
zmq_msg_t
 *
šmsg
 = 
	`ÿÎoc
((zmq_msg_t), 1);

170 
rc
 = 0;

172 
	`check_mem
(
šmsg
);

174 
rc
 = 
	`zmq_msg_š™
(
šmsg
);

175 
	`check
(
rc
 == 0, "Failedo initialize message.");

177 
	`sk¡©e
("recv");

179 
rc
 = 
	`mq»cv
(
hªdËr
->
»cv_sock‘
, 
šmsg
, 0);

180 
	`check
(
rc
 == 0, "Receive on handler socket failed.");

181 
	`check
(
hªdËr
->
ruÂšg
, "Handler marked‡s‚ot„unning.");

183 
rc
 = 
	`HªdËrP¬£r_execu‹
(
·r£r
, 
	`zmq_msg_d©a
(
šmsg
), 
	`zmq_msg_size
(inmsg));

184 
	`check
(
rc
 == 1, "Failedo…arse message from handler.");

186 
	`check
(
·r£r
->
rg‘_couÁ
 > 0, "Message sent had 0argets: %.*s",

187 ()
	`zmq_msg_size
(
šmsg
), (*)
	`zmq_msg_d©a
(inmsg));

189 
	`zmq_msg_şo£
(
šmsg
);

190 
	`ä“
(
šmsg
);

193 
”rÜ
:

194 if(
šmsg
) {

195 
	`zmq_msg_şo£
(
šmsg
);

196 
	`ä“
(
šmsg
);

199 
	}
}

202 
	$HªdËr_sk
(*
v
)

204 
rc
 = 0;

205 
i
 = 0;

206 
HªdËr
 *
hªdËr
 = (HªdË¸*)
v
;

207 
HªdËrP¬£r
 *
·r£r
 = 
NULL
;

208 
max_rg‘s
 = 
	`S‘tšg_g‘_št
("limits.handler_targets", 128);

209 
	`log_šfo
("MAX‡llowing†imits.handler_targets=%d", 128);

211 
·r£r
 = 
	`HªdËrP¬£r_ü—‹
(
max_rg‘s
);

212 
	`check_mem
(
·r£r
);

214 
	`check
(
	`HªdËr_£tup
(
hªdËr
) == 0, "Failedo initialize handler,ƒxiting.");

216 
hªdËr
->
ruÂšg
 && !
	`sk_was_sigÇËd
()) {

217 
	`sk¡©e
("delivering");

219 
rc
 = 
	`hªdËr_»cv_·r£
(
hªdËr
, 
·r£r
);

220 if(
	`sk_was_sigÇËd
()) {

224 if(
rc
 !ğ-1 && 
·r£r
->
rg‘_couÁ
 > 0) {

225 
i
 = 0; i < ()
·r£r
->
rg‘_couÁ
; i++) {

226 
id
 = ()
·r£r
->
rg‘s
[
i
];

227 
fd
 = 
	`Regi¡”_fd_fÜ_id
(
id
);

228 
CÚÃùiÚ
 *
cÚn
 = (CÚÃùiÚ *)
	`Regi¡”_fd_exi¡s
(
fd
);

230 
	`hªdËr_´oûss_»que¡
(
hªdËr
, 
id
, 
fd
, 
cÚn
, 
·r£r
->
body
);

233 
	`debug
("Sk³d inv®id mes§gäom hªdËr: %s", 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

236 
	`HªdËrP¬£r_»£t
(
·r£r
);

239 
	`debug
("############################### HANDLER EXITED: %p,„unning: %d,ask: %p",

240 
hªdËr
, hªdËr->
ruÂšg
, hªdËr->
sk
);

241 
hªdËr
->
ruÂšg
 = 0;

242 
hªdËr
->
sk
 = 
NULL
;

243 
	`HªdËrP¬£r_de¡roy
(
·r£r
);

244 
	`skex™
(0);

246 
”rÜ
:

247 
hªdËr
->
ruÂšg
 = 0;

248 
hªdËr
->
sk
 = 
NULL
;

249 
	`HªdËrP¬£r_de¡roy
(
·r£r
);

250 
	`log_”r
("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! HANDLER TASK DIED");

251 
	`skex™
(1);

252 
	}
}

255 
	$HªdËr_d–iv”
(*
hªdËr_sock‘
, *
bufãr
, 
size_t
 
Ën
)

257 
rc
 = 0;

258 
zmq_msg_t
 
msg
;

260 
rc
 = 
	`zmq_msg_š™
(&
msg
);

261 
	`check
(
rc
 == 0, "Failedo initialize 0mq messageo send.");

263 
rc
 = 
	`zmq_msg_š™_d©a
(&
msg
, 
bufãr
, 
Ën
, 
c¡r_ä“
, 
NULL
);

264 
	`check
(
rc
 == 0, "Failedo init 0mq message data.");

266 
rc
 = 
	`mq£nd
(
hªdËr_sock‘
, &
msg
, 0);

267 
	`check
(
rc
 == 0, "Failedo deliver 0mq messageo handler.");

272 
”rÜ
:

273 
	`ä“
(
bufãr
);

275 
	}
}

278 *
	$HªdËr_£nd_ü—‹
(cÚ¡ *
£nd_¥ec
, cÚ¡ *
id’t™y
)

280 
bšd_©‹m±s
 = 10;

281 *
hªdËr_sock‘
 = 
	`mqsock‘
(
ZMQ_PUSH
);

282 
rc
 = 
	`zmq_£tsockİt
(
hªdËr_sock‘
, 
ZMQ_IDENTITY
, 
id’t™y
, 
	`¡¾’
(identity));

283 
	`check
(
rc
 =ğ0, "FaedØ£ˆhªdË¸sock‘ % id’t™y %s", 
£nd_¥ec
, 
id’t™y
);

285 
	`log_šfo
("Bšdšg hªdË¸PUSH sock‘ % w™h id’t™y: %s", 
£nd_¥ec
, 
id’t™y
);

287 
rc
 = 
	`zmq_bšd
(
hªdËr_sock‘
, 
£nd_¥ec
);

289 
rc
 !ğ0 && 
bšd_©‹m±s
-- > 0) {

290 
	`skd–ay
(1000);

291 
	`log_w¬n
("FaedØbšd s’d sock‘ryšg‡gaš fÜ: %s", 
£nd_¥ec
);

292 
rc
 = 
	`zmq_bšd
(
hªdËr_sock‘
, 
£nd_¥ec
);

295 
	`check
(
bšd_©‹m±s
 > 0, "ToØmªy bšd‡‰em± fÜ hªdË¸%s", 
£nd_¥ec
);

297  
hªdËr_sock‘
;

299 
”rÜ
:

300  
NULL
;

301 
	}
}

303 *
	$HªdËr_»cv_ü—‹
(cÚ¡ *
»cv_¥ec
, cÚ¡ *
uuid
)

305 
bšd_©‹m±s
 = 10;

306 *
li¡’”_sock‘
 = 
	`mqsock‘
(
ZMQ_SUB
);

307 
	`check
(
li¡’”_sock‘
, "Can't create ZMQ_SUB socket.");

309 
rc
 = 
	`zmq_£tsockİt
(
li¡’”_sock‘
, 
ZMQ_SUBSCRIBE
, 
uuid
, 0);

310 
	`check
(
rc
 =ğ0, "FaedØsubsüibli¡’” sock‘: %s", 
»cv_¥ec
);

311 
	`log_šfo
("Bšdšg†i¡’” SUB sock‘ % subsüibedo: %s", 
»cv_¥ec
, 
uuid
);

313 
rc
 = 
	`zmq_bšd
(
li¡’”_sock‘
, 
»cv_¥ec
);

315 
rc
 !ğ0 && 
bšd_©‹m±s
-- > 0) {

316 
	`skd–ay
(1000);

317 
	`debug
("Failedo bind„ecv socketrying‡gain.");

318 
rc
 = 
	`zmq_bšd
(
li¡’”_sock‘
, 
»cv_¥ec
);

321 
	`check
(
bšd_©‹m±s
 > 0, "ToØmªy bšd‡‰em± fÜ hªdË¸%s", 
»cv_¥ec
);

323  
li¡’”_sock‘
;

325 
”rÜ
:

326  
NULL
;

327 
	}
}

329 cÚ¡ 
	gDEFAULT_HANDLER_STACK
 = 100 * 1024;

331 
HªdËr
 *
	$HªdËr_ü—‹
(
b¡ršg
 
£nd_¥ec
, b¡ršg 
£nd_id’t
,

332 
b¡ršg
 
»cv_¥ec
, b¡ršg 
»cv_id’t
)

334 
	`debug
("C»©šg hªdË¸%s:%s", 
	`bd©a
(
£nd_¥ec
), bd©a(
£nd_id’t
));

336 if(!
HANDLER_STACK
) {

337 
HANDLER_STACK
 = 
	`S‘tšg_g‘_št
("lim™s.hªdËr_¡ack", 
DEFAULT_HANDLER_STACK
);

338 
	`log_šfo
("MAX†im™s.hªdËr_¡ack=%d", 
HANDLER_STACK
);

341 
HªdËr
 *
hªdËr
 = 
	`ÿÎoc
((Handler), 1);

342 
	`check_mem
(
hªdËr
);

344 
hªdËr
->
£nd_id’t
 = 
	`b¡rıy
(send_ident);

345 
hªdËr
->
»cv_id’t
 = 
	`b¡rıy
(recv_ident);

346 
hªdËr
->
»cv_¥ec
 = 
	`b¡rıy
(recv_spec);

347 
hªdËr
->
£nd_¥ec
 = 
	`b¡rıy
(send_spec);

348 
hªdËr
->
ruÂšg
 = 0;

349 
hªdËr
->
¿w
 = 0;

350 
hªdËr
->
´ÙocŞ
 = 
HANDLER_PROTO_JSON
;

352  
hªdËr
;

353 
”rÜ
:

355 if(
hªdËr
è
	`ä“
(handler);

356  
NULL
;

357 
	}
}

360 
	$HªdËr_de¡roy
(
HªdËr
 *
hªdËr
)

362 if(
hªdËr
) {

363 if(
hªdËr
->
»cv_sock‘
è
	`zmq_şo£
(handler->recv_socket);

364 if(
hªdËr
->
£nd_sock‘
è
	`zmq_şo£
(handler->send_socket);

366 
	`bde¡roy
(
hªdËr
->
£nd_id’t
);

367 
	`bde¡roy
(
hªdËr
->
»cv_id’t
);

368 
	`bde¡roy
(
hªdËr
->
£nd_¥ec
);

369 
	`bde¡roy
(
hªdËr
->
»cv_¥ec
);

370 
	`ä“
(
hªdËr
);

372 
	}
}

	@src/handler.h

35 #iâdeà
_hªdËr_h


36 
	#_hªdËr_h


	)

38 
	~<¡dlib.h
>

39 
	~<b¡ršg.h
>

40 
	~<sk/sk.h
>

42 
HANDLER_STACK
;

44 ’um { 
	mHANDLER_PROTO_JSON
, 
	mHANDLER_PROTO_TNET
 } 
	thªdËr_´ÙocŞ_t
;

46 
	sHªdËr
 {

47 *
	m£nd_sock‘
;

48 *
	m»cv_sock‘
;

49 
b¡ršg
 
	m£nd_id’t
;

50 
b¡ršg
 
	m»cv_id’t
;

51 
b¡ršg
 
	m»cv_¥ec
;

52 
b¡ršg
 
	m£nd_¥ec
;

53 
Task
 *
	msk
;

54 
	mruÂšg
;

55 
	m¿w
;

56 
hªdËr_´ÙocŞ_t
 
	m´ÙocŞ
;

57 } 
	tHªdËr
;

59 
HªdËr_sk
(*
v
);

61 
HªdËr_d–iv”
(*
hªdËr_sock‘
, *
bufãr
, 
size_t
 
Ën
);

63 
HªdËr
 *
HªdËr_ü—‹
(
b¡ršg
 
£nd_¥ec
, b¡ršg 
£nd_id’t
,

64 
b¡ršg
 
»cv_¥ec
, b¡ršg 
»cv_id’t
);

66 
HªdËr_de¡roy
(
HªdËr
 *
hªdËr
);

68 *
HªdËr_»cv_ü—‹
(cÚ¡ *
»cv_¥ec
, cÚ¡ *
uuid
);

70 *
HªdËr_£nd_ü—‹
(cÚ¡ *
£nd_¥ec
, cÚ¡ *
id’t™y
);

72 
HªdËr_nÙify_Ëave
(
HªdËr
 *
hªdËr
, 
fd
);

	@src/handler_parser.c

37 
	~<as£¹.h
>

38 
	~<¡dlib.h
>

39 
	~<ùy³.h
>

41 
	~"hªdËr_·r£r.h
"

42 
	~"b¡ršg.h
"

43 
	~"dbg.h
"

44 
	~"mem/h®loc.h
"

53 cÚ¡ 
	gHªdËrP¬£r_¡¬t
 = 1;

54 cÚ¡ 
	gHªdËrP¬£r_fœ¡_fš®
 = 9;

55 cÚ¡ 
	gHªdËrP¬£r_”rÜ
 = 0;

57 cÚ¡ 
	gHªdËrP¬£r_’_maš
 = 1;

64 
	$HªdËrP¬£r_execu‹
(
HªdËrP¬£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
)

66 cÚ¡ *
p
 = 
bufãr
;

67 cÚ¡ *
³
 = 
bufãr
+
Ën
;

68 
cs
 = 0;

69 cÚ¡ *
m¬k
 = 
p
;

70 cÚ¡ *
rg‘s_¡¬t
 = 
NULL
;

71 
rg‘_ex³ùed_Ën
 = 0;

72 
·r£r
->
rg‘_couÁ
 = 0;

73 
·r£r
->
uuid
 = 
NULL
;

78 
cs
 = 
HªdËrP¬£r_¡¬t
;

85  
cs
 )

88 iàĞ(*
p
) == 45 )

89 
Œ0
;

90 iàĞ(*
p
) < 65 ) {

91 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

92 
Œ0
;

93 } iàĞ(*
p
) > 90 ) {

94 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

95 
Œ0
;

97 
Œ0
;

98 
¡0
;

99 
¡0
:

100 
cs
 = 0;

101 
_out
;

102 
Œ0
:

104 { 
m¬k
 = 
p
; }

105 
¡2
;

106 
¡2
:

107 
p
 += 1;

110  (*
p
) ) {

111 32: 
Œ2
;

112 45: 
¡2
;

114 iàĞ(*
p
) < 65 ) {

115 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

116 
¡2
;

117 } iàĞ(*
p
) > 90 ) {

118 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

119 
¡2
;

121 
¡2
;

122 
¡0
;

123 
Œ2
:

126 
·r£r
->
uuid
 = 
	`blk2b¡r
(
m¬k
, 
p
-mark);

128 
¡3
;

129 
¡3
:

130 
p
 += 1;

133 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

134 
Œ4
;

135 
¡0
;

136 
Œ4
:

138 { 
m¬k
 = 
p
; }

139 
¡4
;

140 
¡4
:

141 
p
 += 1;

144 iàĞ(*
p
) == 58 )

145 
Œ6
;

146 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

147 
¡4
;

148 
¡0
;

149 
Œ6
:

152 *
’d±r
 = 
NULL
;

153 
rg‘_ex³ùed_Ën
 = 
	`¡¹oul
(
m¬k
, &
’d±r
, 10);

154 
	`check
(
’d±r
 =ğ
p
, "Invalid†ength given, didn't…arse correctly.");

156 
¡5
;

157 
¡5
:

158 
p
 += 1;

161 iàĞ(*
p
) == 44 )

162 
Œ7
;

163 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

164 
Œ8
;

165 
¡0
;

166 
Œ7
:

169 
rg‘s_¡¬t
 = 
p
;

173 
	`check
(
p
-
rg‘s_¡¬t
 =ğ
rg‘_ex³ùed_Ën
,

175 ()(
p
-
rg‘s_¡¬t
), ()
rg‘_ex³ùed_Ën
);

177 
¡6
;

178 
Œ11
:

181 
	`check
(
·r£r
->
rg‘_couÁ
 <…¬£r->
rg‘_max
, "Request containsoo manyarget†isteners.");

182 
·r£r
->
rg‘s
[·r£r->
rg‘_couÁ
++] = 
	`¡¹oul
(
m¬k
, 
NULL
, 10);

186 
	`check
(
p
-
rg‘s_¡¬t
 =ğ
rg‘_ex³ùed_Ën
,

188 ()(
p
-
rg‘s_¡¬t
), ()
rg‘_ex³ùed_Ën
);

190 
¡6
;

191 
¡6
:

192 
p
 += 1;

195 iàĞ(*
p
) == 32 )

196 
Œ9
;

197 
¡0
;

198 
Œ9
:

200 { {
p
++; 
cs
 = 9; 
_out
;} }

201 
¡9
;

202 
¡9
:

203 
p
 += 1;

206 
¡0
;

207 
Œ8
:

210 
rg‘s_¡¬t
 = 
p
;

213 { 
m¬k
 = 
p
; }

214 
¡7
;

215 
Œ13
:

218 
	`check
(
·r£r
->
rg‘_couÁ
 <…¬£r->
rg‘_max
, "Request containsoo manyarget†isteners.");

219 
·r£r
->
rg‘s
[·r£r->
rg‘_couÁ
++] = 
	`¡¹oul
(
m¬k
, 
NULL
, 10);

222 { 
m¬k
 = 
p
; }

223 
¡7
;

224 
¡7
:

225 
p
 += 1;

228  (*
p
) ) {

229 32: 
¡8
;

230 44: 
Œ11
;

232 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

233 
¡7
;

234 
¡0
;

235 
¡8
:

236 
p
 += 1;

238 iàĞ(*
p
) == 44 )

239 
Œ11
;

240 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

241 
Œ13
;

242 
¡0
;

245 
_out
: {}

250 
	`check
(
p
 <ğ
³
, "Buffer overflow‡fter…arsing. Tell Zedhat you sent something from‡ handlerhat went %ld…astheƒnd inhe…arser.",

251 ()(
³
 - 
p
));

253 
·r£r
->
body
 = 
	`blk2b¡r
(
p
, 
³
 -…);

255 iàĞ
cs
 ==

261 } iàĞ
cs
 >=

271 
”rÜ
:

273 
	}
}

276 
HªdËrP¬£r
 *
	$HªdËrP¬£r_ü—‹
(
size_t
 
max_rg‘s
)

278 
HªdËrP¬£r
 *
·r£r
 = 
	`h_ÿÎoc
((HandlerParser), 1);

279 
	`check_mem
(
·r£r
);

281 
·r£r
->
rg‘_max
 = 
max_rg‘s
;

282 
·r£r
->
rg‘s
 = 
	`h_ÿÎoc
((), 
max_rg‘s
);

283 
	`check_mem
(
·r£r
->
rg‘s
);

284 
	`h©ch
(
·r£r
->
rg‘s
,…arser);

286  
·r£r
;

288 
”rÜ
:

289  
NULL
;

290 
	}
}

292 
	$HªdËrP¬£r_»£t
(
HªdËrP¬£r
 *
·r£r
)

294 if(
·r£r
->
uuid
) {

295 
	`bde¡roy
(
·r£r
->
uuid
);

296 
·r£r
->
uuid
 = 
NULL
;

299 if(
·r£r
->
body
) {

300 
	`bde¡roy
(
·r£r
->
body
);

301 
·r£r
->
body
 = 
NULL
;

303 
	}
}

305 
	$HªdËrP¬£r_de¡roy
(
HªdËrP¬£r
 *
·r£r
)

307 if(
·r£r
 !ğ
NULL
) {

308 
	`HªdËrP¬£r_»£t
(
·r£r
);

309 
	`h_ä“
(
·r£r
);

311 
	}
}

	@src/handler_parser.h

1 #iâdeà
_hªdËr_·r£r_h


2 
	#_hªdËr_·r£r_h


	)

4 
	~<¡dlib.h
>

5 
	~<b¡ršg.h
>

7 
	sHªdËrP¬£r
 {

8 
b¡ršg
 
	mbody
;

9 
b¡ršg
 
	muuid
;

11 
size_t
 
	mrg‘_couÁ
;

12 
size_t
 
	mrg‘_max
;

13 *
	mrg‘s
;

14 } 
	tHªdËrP¬£r
;

16 
HªdËrP¬£r
 *
HªdËrP¬£r_ü—‹
(
size_t
 
max_rg‘s
);

18 
HªdËrP¬£r_de¡roy
(
HªdËrP¬£r
 *
·r£r
);

20 
HªdËrP¬£r_execu‹
(
HªdËrP¬£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
);

22 
HªdËrP¬£r_»£t
(
HªdËrP¬£r
 *
·r£r
);

	@src/headers.c

35 
	~<h—d”s.h
>

37 
gb¡ršg
 
	gHTTP_METHOD
 = 
bsStic
("METHOD");

38 
gb¡ršg
 
	gHTTP_VERSION
 = 
bsStic
("VERSION");

39 
gb¡ršg
 
	gHTTP_URI
 = 
bsStic
("URI");

40 
gb¡ršg
 
	gHTTP_PATH
 = 
bsStic
("PATH");

41 
gb¡ršg
 
	gHTTP_QUERY
 = 
bsStic
("QUERY");

42 
gb¡ršg
 
	gHTTP_FRAGMENT
 = 
bsStic
("FRAGMENT");

43 
gb¡ršg
 
	gHTTP_BODY
 = 
bsStic
("BODY");

44 
gb¡ršg
 
	gJSON_METHOD
 = 
bsStic
("JSON");

45 
gb¡ršg
 
	gXML_METHOD
 = 
bsStic
("XML");

48 
gb¡ršg
 
	gHTTP_POST
 = 
bsStic
("POST");

49 
gb¡ršg
 
	gHTTP_GET
 = 
bsStic
("GET");

50 
gb¡ršg
 
	gHTTP_HEAD
 = 
bsStic
("HEAD");

51 
gb¡ršg
 
	gHTTP_DELETE
 = 
bsStic
("DELETE");

52 
gb¡ršg
 
	gHTTP_PUT
 = 
bsStic
("PUT");

53 
gb¡ršg
 
	gHTTP_OPTIONS
 = 
bsStic
("OPTIONS");

54 
gb¡ršg
 
	gHTTP_PATTERN
 = 
bsStic
("PATTERN");

57 
gb¡ršg
 
	gHTTP_CONTENT_LENGTH
 = 
bsStic
("content-length");

58 
gb¡ršg
 
	gHTTP_HOST
 = 
bsStic
("host");

59 
gb¡ršg
 
	gHTTP_IF_MATCH
 = 
bsStic
("if-match");

60 
gb¡ršg
 
	gHTTP_IF_NONE_MATCH
 = 
bsStic
("if-none-match");

61 
gb¡ršg
 
	gHTTP_IF_MODIFIED_SINCE
 = 
bsStic
("if-modified-since");

62 
gb¡ršg
 
	gHTTP_IF_UNMODIFIED_SINCE
 = 
bsStic
("if-unmodified-since");

63 
gb¡ršg
 
	gHTTP_USER_AGENT
 = 
bsStic
("user-agent");

64 
gb¡ršg
 
	gHTTP_CONNECTION
 = 
bsStic
("connection");

66 
gb¡ršg
 
	gHTTP_X_FORWARDED_FOR
 = 
bsStic
("x-forwarded-for");

	@src/headers.h

35 #iâdeà
_h—d”s_h


36 
	#_h—d”s_h


	)

38 
	~<b¡ršg.h
>

40 
gb¡ršg
 
HTTP_CONTENT_LENGTH
;

41 
gb¡ršg
 
HTTP_HOST
;

42 
gb¡ršg
 
HTTP_METHOD
;

43 
gb¡ršg
 
HTTP_VERSION
;

44 
gb¡ršg
 
HTTP_URI
;

45 
gb¡ršg
 
HTTP_PATH
;

46 
gb¡ršg
 
HTTP_QUERY
;

47 
gb¡ršg
 
HTTP_FRAGMENT
;

48 
gb¡ršg
 
HTTP_BODY
;

49 
gb¡ršg
 
JSON_METHOD
;

50 
gb¡ršg
 
XML_METHOD
;

51 
gb¡ršg
 
HTTP_IF_MATCH
;

52 
gb¡ršg
 
HTTP_IF_NONE_MATCH
;

53 
gb¡ršg
 
HTTP_IF_MODIFIED_SINCE
;

54 
gb¡ršg
 
HTTP_IF_UNMODIFIED_SINCE
;

55 
gb¡ršg
 
HTTP_POST
;

56 
gb¡ršg
 
HTTP_GET
;

57 
gb¡ršg
 
HTTP_HEAD
;

58 
gb¡ršg
 
HTTP_DELETE
;

59 
gb¡ršg
 
HTTP_PUT
;

60 
gb¡ršg
 
HTTP_OPTIONS
;

61 
gb¡ršg
 
HTTP_PATTERN
;

62 
gb¡ršg
 
HTTP_USER_AGENT
;

63 
gb¡ršg
 
HTTP_CONNECTION
;

64 
gb¡ršg
 
HTTP_X_FORWARDED_FOR
;

	@src/host.c

35 
	~<ho¡.h
>

36 
	~<¡ršg.h
>

37 
	~<dbg.h
>

38 
	~<as£¹.h
>

39 
	~<mem/h®loc.h
>

40 
	~<dœ.h
>

41 
	~"£‰šg.h
"

43 
	gMAX_HOST_NAME
 = 0;

44 
	gMAX_URL_PATH
 = 0;

46 
	$back’d_de¡roy_cb
(
Rou‹
 *
r
, 
Rou‹M­
 *
m­
)

48 
Back’d
 *
back’d
 = (Back’d *)
r
->
d©a
;

50 if(
back’d
) {

51 
	`ä“
(
back’d
);

52 
r
->
d©a
 = 
NULL
;

54 
	}
}

56 
Ho¡
 *
	$Ho¡_ü—‹
(
b¡ršg
 
Çme
, b¡ršg 
m©chšg
)

58 if(!
MAX_URL_PATH
 || !
MAX_HOST_NAME
) {

59 
MAX_URL_PATH
 = 
	`S‘tšg_g‘_št
("limits.url_path", 256);

60 
MAX_HOST_NAME
 = 
	`S‘tšg_g‘_št
("limits.host_name", 256);

61 
	`log_šfo
("MAX†imits.url_path=%d,†imits.host_name=%d",

62 
MAX_URL_PATH
, 
MAX_HOST_NAME
);

65 
Ho¡
 *
ho¡
 = 
	`h_ÿÎoc
((Host), 1);

66 
	`check_mem
(
ho¡
);

68 
ho¡
->
Çme
 = 
	`b¡rıy
(name);

69 
	`check
(
	`bËngth
(
ho¡
->
Çme
è< 
MAX_HOST_NAME
, "Host‚ameoo†ong (max %d): '%s'\n",

70 
MAX_HOST_NAME
, 
	`bd©a
(
Çme
));

72 
ho¡
->
m©chšg
 = 
	`b¡rıy
(matching);

74 
	`check
(
	`bËngth
(
ho¡
->
m©chšg
è< 
MAX_HOST_NAME
, "Host matching…atternoo†ong (max %d): '%s'\n",

75 
MAX_HOST_NAME
, 
	`bd©a
(
Çme
));

77 
ho¡
->
rou‹s
 = 
	`Rou‹M­_ü—‹
(
back’d_de¡roy_cb
);

78 
	`check
(
ho¡
->
rou‹s
, "FaedØü—‹ ho¡„ou‹ m­ fÜ %s.", 
	`bd©a
(
Çme
));

80  
ho¡
;

82 
”rÜ
:

83  
NULL
;

84 
	}
}

87 
	$Ho¡_de¡roy
(
Ho¡
 *
ho¡
)

89 if(
ho¡
) {

90 
	`bde¡roy
(
ho¡
->
Çme
);

91 
	`Rou‹M­_de¡roy
(
ho¡
->
rou‹s
);

92 
	`h_ä“
(
ho¡
);

94 
	}
}

98 
	$Ho¡_add_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
·th
, 
Back’dTy³
 
ty³
, *
rg‘
)

100 
	`debug
("ADDING ROUTE TO HOST %p: %s", 
ho¡
, 
	`bd©a
(
·th
));

101 
Back’d
 *
back’d
 = 
	`ÿÎoc
((Backend), 1);

102 
	`check_mem
(
back’d
);

104 
back’d
->
ty³
 =ype;

106 if(
ty³
 =ğ
BACKEND_HANDLER
) {

107 
back’d
->
rg‘
.
hªdËr
 =arget;

108 } if(
ty³
 =ğ
BACKEND_PROXY
) {

109 
back’d
->
rg‘
.
´oxy
 =arget;

110 } if(
ty³
 =ğ
BACKEND_DIR
) {

111 
back’d
->
rg‘
.
dœ
 =arget;

113 
	`£Áš–
("Inv®id…roxyy³ giv’: %d", 
ty³
);

116 
rc
 = 
	`Rou‹M­_š£¹
(
ho¡
->
rou‹s
, 
	`b¡rıy
(
·th
), 
back’d
);

117 
	`check
(
rc
 == 0, "Failedo insert %s into host %s„oute map.",

118 
	`bd©a
(
·th
), bd©a(
ho¡
->
Çme
));

122 
”rÜ
:

124 
	}
}

127 
Back’d
 *
	$Ho¡_m©ch_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
rg‘
, 
Rou‹
 **
out_rou‹
)

129 
Rou‹
 *
found
 = 
NULL
;

130 
	`debug
("MATCHING BACKEND IN HOST %°AGAINST % š ROUTES: %p", 
ho¡
, 
	`bd©a
(
rg‘
), ho¡->
rou‹s
);

132 
found
 = 
	`Rou‹M­_sim¶e_´efix_m©ch
(
ho¡
->
rou‹s
, 
rg‘
);

134 if(
found
) {

135 
	`debug
("Found back’d‡ˆ%s", 
	`bd©a
(
found
->
·‰”n
));

136 
	`as£¹
(
found
->
d©a
 && "Invalid value for stored„oute.");

137 if(
out_rou‹
è*out_rou‹ = 
found
;

138  
found
->
d©a
;

140 if(
out_rou‹
è*out_rou‹ = 
found
;

141  
NULL
;

143 
	}
}

	@src/host.h

35 #iâdeà
_ho¡_h


36 
	#_ho¡_h


	)

38 
	~<adt/t¡.h
>

39 
	~<´oxy.h
>

40 
	~<hªdËr.h
>

41 
	~<»que¡.h
>

42 
	~<routšg.h
>

44 
MAX_HOST_NAME
;

45 
MAX_URL_PATH
;

48 
	sHo¡
 {

49 
Rou‹M­
 *
	mrou‹s
;

50 
b¡ršg
 
	mÇme
;

51 
b¡ršg
 
	mm©chšg
;

52 } 
	tHo¡
;

55 
	eBack’dTy³
 {

56 
	mBACKEND_HANDLER
=1, 
	mBACKEND_PROXY
, 
	mBACKEND_DIR


57 } 
	tBack’dTy³
;

59 
	sBack’d
 {

60 
	mty³
;

63 
HªdËr
 *
	mhªdËr
;

64 
Proxy
 *
	m´oxy
;

65 
Dœ
 *
	mdœ
;

66 } 
	mrg‘
;

67 } 
	tBack’d
;

69 
Ho¡
 *
Ho¡_ü—‹
(
b¡ršg
 
Çme
, b¡ršg 
m©chšg
);

70 
Ho¡_de¡roy
(
Ho¡
 *
ho¡
);

72 
Ho¡_add_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
·th
, 
Back’dTy³
 
ty³
, *
rg‘
);

74 
Back’d
 *
Ho¡_m©ch_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
rg‘
, 
Rou‹
 **
out_rou‹
);

	@src/http11/http11_common.h

1 #iâdeà
_h‰p11_commÚ_h


2 
	#_h‰p11_commÚ_h


	)

4 
	~<sys/ty³s.h
>

6 (*
	t–em’t_cb
)(*
	td©a
, cÚ¡ *
	t©
, 
	tsize_t
 
	tËngth
);

7 (*
	tf›ld_cb
)(*
	td©a
, cÚ¡ *
	tf›ld
, 
	tsize_t
 
	tæ’
, cÚ¡ *
	tv®ue
, size_ˆ
	tvËn
);

	@src/http11/http11_parser.c

37 
	~"h‰p11_·r£r.h
"

38 
	~<¡dio.h
>

39 
	~<as£¹.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~<dbg.h
>

45 
	#LEN
(
AT
, 
FPC
è(FPC - 
bufãr
 - 
·r£r
->AT)

	)

46 
	#MARK
(
M
,
FPC
è(
·r£r
->M = (FPCè- 
bufãr
)

	)

47 
	#PTR_TO
(
F
è(
bufãr
 + 
·r£r
->F)

	)

58 cÚ¡ 
	gh‰p_·r£r_¡¬t
 = 1;

59 cÚ¡ 
	gh‰p_·r£r_fœ¡_fš®
 = 78;

60 cÚ¡ 
	gh‰p_·r£r_”rÜ
 = 0;

62 cÚ¡ 
	gh‰p_·r£r_’_maš
 = 1;

67 
	$h‰p_·r£r_š™
(
h‰p_·r£r
 *
·r£r
) {

68 
cs
 = 0;

72 
cs
 = 
h‰p_·r£r_¡¬t
;

76 
·r£r
->
cs
 = cs;

77 
·r£r
->
body_¡¬t
 = 0;

78 
·r£r
->
cÚ‹Á_Ën
 = 0;

79 
·r£r
->
m¬k
 = 0;

80 
·r£r
->
Ä—d
 = 0;

81 
·r£r
->
f›ld_Ën
 = 0;

82 
·r£r
->
f›ld_¡¬t
 = 0;

83 
·r£r
->
xml_£Á
 = 0;

84 
·r£r
->
jsÚ_£Á
 = 0;

87 
	}
}

91 
size_t
 
	$h‰p_·r£r_execu‹
(
h‰p_·r£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
, size_ˆ
off
)

93 if(
Ën
 == 0)  0;

95 cÚ¡ *
p
, *
³
;

96 
cs
 = 
·r£r
->cs;

98 
	`as£¹
(
off
 <ğ
Ën
 && "offset…astƒnd of buffer");

100 
p
 = 
bufãr
+
off
;

101 
³
 = 
bufãr
+
Ën
;

103 
	`as£¹
(
³
 - 
p
 =ğ()
Ën
 - ()
off
 && "pointers‡ren't same distance");

108 iàĞ
p
 =ğ
³
 )

109 
_‹¡_eof
;

110  
cs
 )

113  (*
p
) ) {

114 36: 
Œ0
;

115 60: 
Œ2
;

116 64: 
Œ3
;

117 95: 
Œ0
;

119 iàĞ(*
p
) < 48 ) {

120 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

121 
Œ0
;

122 } iàĞ(*
p
) > 57 ) {

123 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

124 
Œ0
;

126 
Œ0
;

127 
¡0
;

128 
¡0
:

129 
cs
 = 0;

130 
_out
;

131 
Œ0
:

133 {
	`MARK
(
m¬k
, 
p
); }

134 
¡2
;

135 
¡2
:

136 iàĞ++
p
 =ğ
³
 )

137 
_‹¡_eof2
;

140  (*
p
) ) {

141 32: 
Œ4
;

142 36: 
¡41
;

143 95: 
¡41
;

145 iàĞ(*
p
) < 48 ) {

146 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

147 
¡41
;

148 } iàĞ(*
p
) > 57 ) {

149 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

150 
¡41
;

152 
¡41
;

153 
¡0
;

154 
Œ4
:

157 if(
·r£r
->
»que¡_m‘hod
 !ğ
NULL
)

158 
·r£r
->
	`»que¡_m‘hod
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

160 
¡3
;

161 
¡3
:

162 iàĞ++
p
 =ğ
³
 )

163 
_‹¡_eof3
;

166  (*
p
) ) {

167 42: 
Œ6
;

168 47: 
Œ7
;

169 104: 
Œ8
;

171 
¡0
;

172 
Œ6
:

174 {
	`MARK
(
m¬k
, 
p
); }

175 
¡4
;

176 
¡4
:

177 iàĞ++
p
 =ğ
³
 )

178 
_‹¡_eof4
;

181  (*
p
) ) {

182 32: 
Œ9
;

183 35: 
Œ10
;

185 
¡0
;

186 
Œ9
:

189 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

190 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

192 
¡5
;

193 
Œ35
:

195 {
	`MARK
(
m¬k
, 
p
); }

198 if(
·r£r
->
äagm’t
 !ğ
NULL
)

199 
·r£r
->
	`äagm’t
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

201 
¡5
;

202 
Œ38
:

205 if(
·r£r
->
äagm’t
 !ğ
NULL
)

206 
·r£r
->
	`äagm’t
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

208 
¡5
;

209 
Œ42
:

212 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

213 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

217 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

218 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

220 
¡5
;

221 
Œ53
:

223 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

226 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

227 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

231 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

232 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

234 
¡5
;

235 
Œ57
:

238 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

239 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

243 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

244 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

246 
¡5
;

247 
¡5
:

248 iàĞ++
p
 =ğ
³
 )

249 
_‹¡_eof5
;

252 iàĞ(*
p
) == 72 )

253 
Œ11
;

254 
¡0
;

255 
Œ11
:

257 {
	`MARK
(
m¬k
, 
p
); }

258 
¡6
;

259 
¡6
:

260 iàĞ++
p
 =ğ
³
 )

261 
_‹¡_eof6
;

264 iàĞ(*
p
) == 84 )

265 
¡7
;

266 
¡0
;

267 
¡7
:

268 iàĞ++
p
 =ğ
³
 )

269 
_‹¡_eof7
;

271 iàĞ(*
p
) == 84 )

272 
¡8
;

273 
¡0
;

274 
¡8
:

275 iàĞ++
p
 =ğ
³
 )

276 
_‹¡_eof8
;

278 iàĞ(*
p
) == 80 )

279 
¡9
;

280 
¡0
;

281 
¡9
:

282 iàĞ++
p
 =ğ
³
 )

283 
_‹¡_eof9
;

285 iàĞ(*
p
) == 47 )

286 
¡10
;

287 
¡0
;

288 
¡10
:

289 iàĞ++
p
 =ğ
³
 )

290 
_‹¡_eof10
;

292 iàĞ(*
p
) == 49 )

293 
¡11
;

294 
¡0
;

295 
¡11
:

296 iàĞ++
p
 =ğ
³
 )

297 
_‹¡_eof11
;

299 iàĞ(*
p
) == 46 )

300 
¡12
;

301 
¡0
;

302 
¡12
:

303 iàĞ++
p
 =ğ
³
 )

304 
_‹¡_eof12
;

306 iàĞ48 <ğ(*
p
) && (*p) <= 49 )

307 
¡13
;

308 
¡0
;

309 
¡13
:

310 iàĞ++
p
 =ğ
³
 )

311 
_‹¡_eof13
;

313  (*
p
) ) {

314 10: 
Œ19
;

315 13: 
Œ20
;

317 
¡0
;

318 
Œ19
:

321 if(
·r£r
->
h‰p_v”siÚ
 !ğ
NULL
)

322 
·r£r
->
	`h‰p_v”siÚ
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

324 
¡14
;

325 
Œ27
:

327 { 
	`MARK
(
m¬k
, 
p
); }

330 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

331 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

334 
¡14
;

335 
Œ31
:

338 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

339 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

342 
¡14
;

343 
¡14
:

344 iàĞ++
p
 =ğ
³
 )

345 
_‹¡_eof14
;

348  (*
p
) ) {

349 10: 
Œ21
;

350 13: 
¡15
;

351 33: 
Œ23
;

352 124: 
Œ23
;

353 126: 
Œ23
;

355 iàĞ(*
p
) < 45 ) {

356 iàĞ(*
p
) > 39 ) {

357 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

358 
Œ23
;

359 } iàĞ(*
p
) >= 35 )

360 
Œ23
;

361 } iàĞ(*
p
) > 46 ) {

362 iàĞ(*
p
) < 65 ) {

363 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

364 
Œ23
;

365 } iàĞ(*
p
) > 90 ) {

366 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

367 
Œ23
;

369 
Œ23
;

371 
Œ23
;

372 
¡0
;

373 
Œ21
:

376 if(
·r£r
->
xml_£Á
 ||…¬£r->
jsÚ_£Á
) {

377 
·r£r
->
body_¡¬t
 = 
	`PTR_TO
(
m¬k
è- 
bufãr
;

379 
·r£r
->
cÚ‹Á_Ën
 = 
p
 - 
bufãr
 -…¬£r->
body_¡¬t
 + 1;

381 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

383 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
) {

384 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

387 {
p
++; 
cs
 = 78; 
_out
;}

389 
¡78
;

390 
Œ89
:

393 
·r£r
->
xml_£Á
 = 1;

397 if(
·r£r
->
xml_£Á
 ||…¬£r->
jsÚ_£Á
) {

398 
·r£r
->
body_¡¬t
 = 
	`PTR_TO
(
m¬k
è- 
bufãr
;

400 
·r£r
->
cÚ‹Á_Ën
 = 
p
 - 
bufãr
 -…¬£r->
body_¡¬t
 + 1;

402 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

404 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
) {

405 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

408 {
p
++; 
cs
 = 78; 
_out
;}

410 
¡78
;

411 
Œ98
:

414 
·r£r
->
jsÚ_£Á
 = 1;

418 if(
·r£r
->
xml_£Á
 ||…¬£r->
jsÚ_£Á
) {

419 
·r£r
->
body_¡¬t
 = 
	`PTR_TO
(
m¬k
è- 
bufãr
;

421 
·r£r
->
cÚ‹Á_Ën
 = 
p
 - 
bufãr
 -…¬£r->
body_¡¬t
 + 1;

423 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

425 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
) {

426 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

429 {
p
++; 
cs
 = 78; 
_out
;}

431 
¡78
;

432 
¡78
:

433 iàĞ++
p
 =ğ
³
 )

434 
_‹¡_eof78
;

437 
¡0
;

438 
¡15
:

439 iàĞ++
p
 =ğ
³
 )

440 
_‹¡_eof15
;

442 iàĞ(*
p
) == 10 )

443 
Œ21
;

444 
¡0
;

445 
Œ23
:

447 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

448 
¡16
;

449 
¡16
:

450 iàĞ++
p
 =ğ
³
 )

451 
_‹¡_eof16
;

454  (*
p
) ) {

455 33: 
¡16
;

456 58: 
Œ25
;

457 124: 
¡16
;

458 126: 
¡16
;

460 iàĞ(*
p
) < 45 ) {

461 iàĞ(*
p
) > 39 ) {

462 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

463 
¡16
;

464 } iàĞ(*
p
) >= 35 )

465 
¡16
;

466 } iàĞ(*
p
) > 46 ) {

467 iàĞ(*
p
) < 65 ) {

468 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

469 
¡16
;

470 } iàĞ(*
p
) > 90 ) {

471 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

472 
¡16
;

474 
¡16
;

476 
¡16
;

477 
¡0
;

478 
Œ25
:

481 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

483 
¡17
;

484 
Œ29
:

486 { 
	`MARK
(
m¬k
, 
p
); }

487 
¡17
;

488 
¡17
:

489 iàĞ++
p
 =ğ
³
 )

490 
_‹¡_eof17
;

493  (*
p
) ) {

494 10: 
Œ27
;

495 13: 
Œ28
;

496 32: 
Œ29
;

498 
Œ26
;

499 
Œ26
:

501 { 
	`MARK
(
m¬k
, 
p
); }

502 
¡18
;

503 
¡18
:

504 iàĞ++
p
 =ğ
³
 )

505 
_‹¡_eof18
;

508  (*
p
) ) {

509 10: 
Œ31
;

510 13: 
Œ32
;

512 
¡18
;

513 
Œ20
:

516 if(
·r£r
->
h‰p_v”siÚ
 !ğ
NULL
)

517 
·r£r
->
	`h‰p_v”siÚ
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

519 
¡19
;

520 
Œ28
:

522 { 
	`MARK
(
m¬k
, 
p
); }

525 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

526 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

529 
¡19
;

530 
Œ32
:

533 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

534 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

537 
¡19
;

538 
¡19
:

539 iàĞ++
p
 =ğ
³
 )

540 
_‹¡_eof19
;

543 iàĞ(*
p
) == 10 )

544 
¡14
;

545 
¡0
;

546 
Œ10
:

549 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

550 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

552 
¡20
;

553 
Œ43
:

556 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

557 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

561 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

562 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

564 
¡20
;

565 
Œ54
:

567 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

570 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

571 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

575 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

576 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

578 
¡20
;

579 
Œ58
:

582 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

583 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

587 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

588 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

590 
¡20
;

591 
¡20
:

592 iàĞ++
p
 =ğ
³
 )

593 
_‹¡_eof20
;

596  (*
p
) ) {

597 32: 
Œ35
;

598 37: 
Œ36
;

599 60: 
¡0
;

600 62: 
¡0
;

601 127: 
¡0
;

603 iàĞ(*
p
) > 31 ) {

604 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

605 
¡0
;

606 } iàĞ(*
p
) >= 0 )

607 
¡0
;

608 
Œ34
;

609 
Œ34
:

611 {
	`MARK
(
m¬k
, 
p
); }

612 
¡21
;

613 
¡21
:

614 iàĞ++
p
 =ğ
³
 )

615 
_‹¡_eof21
;

618  (*
p
) ) {

619 32: 
Œ38
;

620 37: 
¡22
;

621 60: 
¡0
;

622 62: 
¡0
;

623 127: 
¡0
;

625 iàĞ(*
p
) > 31 ) {

626 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

627 
¡0
;

628 } iàĞ(*
p
) >= 0 )

629 
¡0
;

630 
¡21
;

631 
Œ36
:

633 {
	`MARK
(
m¬k
, 
p
); }

634 
¡22
;

635 
¡22
:

636 iàĞ++
p
 =ğ
³
 )

637 
_‹¡_eof22
;

640 iàĞ(*
p
) < 65 ) {

641 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

642 
¡23
;

643 } iàĞ(*
p
) > 70 ) {

644 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

645 
¡23
;

647 
¡23
;

648 
¡0
;

649 
¡23
:

650 iàĞ++
p
 =ğ
³
 )

651 
_‹¡_eof23
;

653 iàĞ(*
p
) < 65 ) {

654 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

655 
¡21
;

656 } iàĞ(*
p
) > 70 ) {

657 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

658 
¡21
;

660 
¡21
;

661 
¡0
;

662 
Œ7
:

664 {
	`MARK
(
m¬k
, 
p
); }

665 
¡24
;

666 
¡24
:

667 iàĞ++
p
 =ğ
³
 )

668 
_‹¡_eof24
;

671  (*
p
) ) {

672 32: 
Œ42
;

673 34: 
¡0
;

674 35: 
Œ43
;

675 37: 
¡25
;

676 59: 
Œ45
;

677 60: 
¡0
;

678 62: 
¡0
;

679 63: 
Œ46
;

680 127: 
¡0
;

682 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

683 
¡0
;

684 
¡24
;

685 
¡25
:

686 iàĞ++
p
 =ğ
³
 )

687 
_‹¡_eof25
;

689 iàĞ(*
p
) < 65 ) {

690 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

691 
¡26
;

692 } iàĞ(*
p
) > 70 ) {

693 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

694 
¡26
;

696 
¡26
;

697 
¡0
;

698 
¡26
:

699 iàĞ++
p
 =ğ
³
 )

700 
_‹¡_eof26
;

702 iàĞ(*
p
) < 65 ) {

703 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

704 
¡24
;

705 } iàĞ(*
p
) > 70 ) {

706 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

707 
¡24
;

709 
¡24
;

710 
¡0
;

711 
Œ45
:

714 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

715 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

717 
¡27
;

718 
¡27
:

719 iàĞ++
p
 =ğ
³
 )

720 
_‹¡_eof27
;

723  (*
p
) ) {

724 32: 
Œ9
;

725 34: 
¡0
;

726 35: 
Œ10
;

727 37: 
¡28
;

728 60: 
¡0
;

729 62: 
¡0
;

730 63: 
¡30
;

731 127: 
¡0
;

733 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

734 
¡0
;

735 
¡27
;

736 
¡28
:

737 iàĞ++
p
 =ğ
³
 )

738 
_‹¡_eof28
;

740 iàĞ(*
p
) < 65 ) {

741 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

742 
¡29
;

743 } iàĞ(*
p
) > 70 ) {

744 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

745 
¡29
;

747 
¡29
;

748 
¡0
;

749 
¡29
:

750 iàĞ++
p
 =ğ
³
 )

751 
_‹¡_eof29
;

753 iàĞ(*
p
) < 65 ) {

754 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

755 
¡27
;

756 } iàĞ(*
p
) > 70 ) {

757 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

758 
¡27
;

760 
¡27
;

761 
¡0
;

762 
Œ46
:

765 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

766 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

768 
¡30
;

769 
¡30
:

770 iàĞ++
p
 =ğ
³
 )

771 
_‹¡_eof30
;

774  (*
p
) ) {

775 32: 
Œ53
;

776 34: 
¡0
;

777 35: 
Œ54
;

778 37: 
Œ55
;

779 60: 
¡0
;

780 62: 
¡0
;

781 127: 
¡0
;

783 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

784 
¡0
;

785 
Œ52
;

786 
Œ52
:

788 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

789 
¡31
;

790 
¡31
:

791 iàĞ++
p
 =ğ
³
 )

792 
_‹¡_eof31
;

795  (*
p
) ) {

796 32: 
Œ57
;

797 34: 
¡0
;

798 35: 
Œ58
;

799 37: 
¡32
;

800 60: 
¡0
;

801 62: 
¡0
;

802 127: 
¡0
;

804 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

805 
¡0
;

806 
¡31
;

807 
Œ55
:

809 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

810 
¡32
;

811 
¡32
:

812 iàĞ++
p
 =ğ
³
 )

813 
_‹¡_eof32
;

816 iàĞ(*
p
) < 65 ) {

817 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

818 
¡33
;

819 } iàĞ(*
p
) > 70 ) {

820 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

821 
¡33
;

823 
¡33
;

824 
¡0
;

825 
¡33
:

826 iàĞ++
p
 =ğ
³
 )

827 
_‹¡_eof33
;

829 iàĞ(*
p
) < 65 ) {

830 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

831 
¡31
;

832 } iàĞ(*
p
) > 70 ) {

833 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

834 
¡31
;

836 
¡31
;

837 
¡0
;

838 
Œ8
:

840 {
	`MARK
(
m¬k
, 
p
); }

841 
¡34
;

842 
¡34
:

843 iàĞ++
p
 =ğ
³
 )

844 
_‹¡_eof34
;

847 iàĞ(*
p
) == 116 )

848 
¡35
;

849 
¡0
;

850 
¡35
:

851 iàĞ++
p
 =ğ
³
 )

852 
_‹¡_eof35
;

854 iàĞ(*
p
) == 116 )

855 
¡36
;

856 
¡0
;

857 
¡36
:

858 iàĞ++
p
 =ğ
³
 )

859 
_‹¡_eof36
;

861 iàĞ(*
p
) == 112 )

862 
¡37
;

863 
¡0
;

864 
¡37
:

865 iàĞ++
p
 =ğ
³
 )

866 
_‹¡_eof37
;

868 iàĞ(*
p
) == 58 )

869 
¡38
;

870 
¡0
;

871 
¡38
:

872 iàĞ++
p
 =ğ
³
 )

873 
_‹¡_eof38
;

875  (*
p
) ) {

876 32: 
Œ9
;

877 34: 
¡0
;

878 35: 
Œ10
;

879 37: 
¡39
;

880 60: 
¡0
;

881 62: 
¡0
;

882 127: 
¡0
;

884 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

885 
¡0
;

886 
¡38
;

887 
¡39
:

888 iàĞ++
p
 =ğ
³
 )

889 
_‹¡_eof39
;

891 iàĞ(*
p
) < 65 ) {

892 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

893 
¡40
;

894 } iàĞ(*
p
) > 70 ) {

895 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

896 
¡40
;

898 
¡40
;

899 
¡0
;

900 
¡40
:

901 iàĞ++
p
 =ğ
³
 )

902 
_‹¡_eof40
;

904 iàĞ(*
p
) < 65 ) {

905 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

906 
¡38
;

907 } iàĞ(*
p
) > 70 ) {

908 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

909 
¡38
;

911 
¡38
;

912 
¡0
;

913 
¡41
:

914 iàĞ++
p
 =ğ
³
 )

915 
_‹¡_eof41
;

917  (*
p
) ) {

918 32: 
Œ4
;

919 36: 
¡42
;

920 95: 
¡42
;

922 iàĞ(*
p
) < 48 ) {

923 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

924 
¡42
;

925 } iàĞ(*
p
) > 57 ) {

926 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

927 
¡42
;

929 
¡42
;

930 
¡0
;

931 
¡42
:

932 iàĞ++
p
 =ğ
³
 )

933 
_‹¡_eof42
;

935  (*
p
) ) {

936 32: 
Œ4
;

937 36: 
¡43
;

938 95: 
¡43
;

940 iàĞ(*
p
) < 48 ) {

941 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

942 
¡43
;

943 } iàĞ(*
p
) > 57 ) {

944 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

945 
¡43
;

947 
¡43
;

948 
¡0
;

949 
¡43
:

950 iàĞ++
p
 =ğ
³
 )

951 
_‹¡_eof43
;

953  (*
p
) ) {

954 32: 
Œ4
;

955 36: 
¡44
;

956 95: 
¡44
;

958 iàĞ(*
p
) < 48 ) {

959 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

960 
¡44
;

961 } iàĞ(*
p
) > 57 ) {

962 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

963 
¡44
;

965 
¡44
;

966 
¡0
;

967 
¡44
:

968 iàĞ++
p
 =ğ
³
 )

969 
_‹¡_eof44
;

971  (*
p
) ) {

972 32: 
Œ4
;

973 36: 
¡45
;

974 95: 
¡45
;

976 iàĞ(*
p
) < 48 ) {

977 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

978 
¡45
;

979 } iàĞ(*
p
) > 57 ) {

980 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

981 
¡45
;

983 
¡45
;

984 
¡0
;

985 
¡45
:

986 iàĞ++
p
 =ğ
³
 )

987 
_‹¡_eof45
;

989  (*
p
) ) {

990 32: 
Œ4
;

991 36: 
¡46
;

992 95: 
¡46
;

994 iàĞ(*
p
) < 48 ) {

995 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

996 
¡46
;

997 } iàĞ(*
p
) > 57 ) {

998 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

999 
¡46
;

1001 
¡46
;

1002 
¡0
;

1003 
¡46
:

1004 iàĞ++
p
 =ğ
³
 )

1005 
_‹¡_eof46
;

1007  (*
p
) ) {

1008 32: 
Œ4
;

1009 36: 
¡47
;

1010 95: 
¡47
;

1012 iàĞ(*
p
) < 48 ) {

1013 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1014 
¡47
;

1015 } iàĞ(*
p
) > 57 ) {

1016 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1017 
¡47
;

1019 
¡47
;

1020 
¡0
;

1021 
¡47
:

1022 iàĞ++
p
 =ğ
³
 )

1023 
_‹¡_eof47
;

1025  (*
p
) ) {

1026 32: 
Œ4
;

1027 36: 
¡48
;

1028 95: 
¡48
;

1030 iàĞ(*
p
) < 48 ) {

1031 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1032 
¡48
;

1033 } iàĞ(*
p
) > 57 ) {

1034 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1035 
¡48
;

1037 
¡48
;

1038 
¡0
;

1039 
¡48
:

1040 iàĞ++
p
 =ğ
³
 )

1041 
_‹¡_eof48
;

1043  (*
p
) ) {

1044 32: 
Œ4
;

1045 36: 
¡49
;

1046 95: 
¡49
;

1048 iàĞ(*
p
) < 48 ) {

1049 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1050 
¡49
;

1051 } iàĞ(*
p
) > 57 ) {

1052 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1053 
¡49
;

1055 
¡49
;

1056 
¡0
;

1057 
¡49
:

1058 iàĞ++
p
 =ğ
³
 )

1059 
_‹¡_eof49
;

1061  (*
p
) ) {

1062 32: 
Œ4
;

1063 36: 
¡50
;

1064 95: 
¡50
;

1066 iàĞ(*
p
) < 48 ) {

1067 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1068 
¡50
;

1069 } iàĞ(*
p
) > 57 ) {

1070 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1071 
¡50
;

1073 
¡50
;

1074 
¡0
;

1075 
¡50
:

1076 iàĞ++
p
 =ğ
³
 )

1077 
_‹¡_eof50
;

1079  (*
p
) ) {

1080 32: 
Œ4
;

1081 36: 
¡51
;

1082 95: 
¡51
;

1084 iàĞ(*
p
) < 48 ) {

1085 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1086 
¡51
;

1087 } iàĞ(*
p
) > 57 ) {

1088 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1089 
¡51
;

1091 
¡51
;

1092 
¡0
;

1093 
¡51
:

1094 iàĞ++
p
 =ğ
³
 )

1095 
_‹¡_eof51
;

1097  (*
p
) ) {

1098 32: 
Œ4
;

1099 36: 
¡52
;

1100 95: 
¡52
;

1102 iàĞ(*
p
) < 48 ) {

1103 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1104 
¡52
;

1105 } iàĞ(*
p
) > 57 ) {

1106 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1107 
¡52
;

1109 
¡52
;

1110 
¡0
;

1111 
¡52
:

1112 iàĞ++
p
 =ğ
³
 )

1113 
_‹¡_eof52
;

1115  (*
p
) ) {

1116 32: 
Œ4
;

1117 36: 
¡53
;

1118 95: 
¡53
;

1120 iàĞ(*
p
) < 48 ) {

1121 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1122 
¡53
;

1123 } iàĞ(*
p
) > 57 ) {

1124 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1125 
¡53
;

1127 
¡53
;

1128 
¡0
;

1129 
¡53
:

1130 iàĞ++
p
 =ğ
³
 )

1131 
_‹¡_eof53
;

1133  (*
p
) ) {

1134 32: 
Œ4
;

1135 36: 
¡54
;

1136 95: 
¡54
;

1138 iàĞ(*
p
) < 48 ) {

1139 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1140 
¡54
;

1141 } iàĞ(*
p
) > 57 ) {

1142 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1143 
¡54
;

1145 
¡54
;

1146 
¡0
;

1147 
¡54
:

1148 iàĞ++
p
 =ğ
³
 )

1149 
_‹¡_eof54
;

1151  (*
p
) ) {

1152 32: 
Œ4
;

1153 36: 
¡55
;

1154 95: 
¡55
;

1156 iàĞ(*
p
) < 48 ) {

1157 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1158 
¡55
;

1159 } iàĞ(*
p
) > 57 ) {

1160 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1161 
¡55
;

1163 
¡55
;

1164 
¡0
;

1165 
¡55
:

1166 iàĞ++
p
 =ğ
³
 )

1167 
_‹¡_eof55
;

1169  (*
p
) ) {

1170 32: 
Œ4
;

1171 36: 
¡56
;

1172 95: 
¡56
;

1174 iàĞ(*
p
) < 48 ) {

1175 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1176 
¡56
;

1177 } iàĞ(*
p
) > 57 ) {

1178 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1179 
¡56
;

1181 
¡56
;

1182 
¡0
;

1183 
¡56
:

1184 iàĞ++
p
 =ğ
³
 )

1185 
_‹¡_eof56
;

1187  (*
p
) ) {

1188 32: 
Œ4
;

1189 36: 
¡57
;

1190 95: 
¡57
;

1192 iàĞ(*
p
) < 48 ) {

1193 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1194 
¡57
;

1195 } iàĞ(*
p
) > 57 ) {

1196 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1197 
¡57
;

1199 
¡57
;

1200 
¡0
;

1201 
¡57
:

1202 iàĞ++
p
 =ğ
³
 )

1203 
_‹¡_eof57
;

1205  (*
p
) ) {

1206 32: 
Œ4
;

1207 36: 
¡58
;

1208 95: 
¡58
;

1210 iàĞ(*
p
) < 48 ) {

1211 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1212 
¡58
;

1213 } iàĞ(*
p
) > 57 ) {

1214 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1215 
¡58
;

1217 
¡58
;

1218 
¡0
;

1219 
¡58
:

1220 iàĞ++
p
 =ğ
³
 )

1221 
_‹¡_eof58
;

1223  (*
p
) ) {

1224 32: 
Œ4
;

1225 36: 
¡59
;

1226 95: 
¡59
;

1228 iàĞ(*
p
) < 48 ) {

1229 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1230 
¡59
;

1231 } iàĞ(*
p
) > 57 ) {

1232 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1233 
¡59
;

1235 
¡59
;

1236 
¡0
;

1237 
¡59
:

1238 iàĞ++
p
 =ğ
³
 )

1239 
_‹¡_eof59
;

1241 iàĞ(*
p
) == 32 )

1242 
Œ4
;

1243 
¡0
;

1244 
Œ2
:

1246 {
	`MARK
(
m¬k
, 
p
); }

1247 
¡60
;

1248 
¡60
:

1249 iàĞ++
p
 =ğ
³
 )

1250 
_‹¡_eof60
;

1253 iàĞ(*
p
) < 48 ) {

1254 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1255 
¡61
;

1256 } iàĞ(*
p
) > 57 ) {

1257 iàĞ(*
p
) > 90 ) {

1258 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

1259 
¡61
;

1260 } iàĞ(*
p
) >= 65 )

1261 
¡61
;

1263 
¡61
;

1264 
¡0
;

1265 
¡61
:

1266 iàĞ++
p
 =ğ
³
 )

1267 
_‹¡_eof61
;

1269  (*
p
) ) {

1270 32: 
Œ86
;

1271 47: 
Œ86
;

1272 62: 
Œ86
;

1274 iàĞ(*
p
) < 45 ) {

1275 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1276 
Œ86
;

1277 } iàĞ(*
p
) > 57 ) {

1278 iàĞ(*
p
) > 90 ) {

1279 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

1280 
¡61
;

1281 } iàĞ(*
p
) >= 65 )

1282 
¡61
;

1284 
¡61
;

1285 
¡0
;

1286 
Œ86
:

1289 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1290 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1292 
¡62
;

1293 
¡62
:

1294 iàĞ++
p
 =ğ
³
 )

1295 
_‹¡_eof62
;

1298 iàĞ(*
p
) == 62 )

1299 
¡63
;

1300 
¡62
;

1301 
¡63
:

1302 iàĞ++
p
 =ğ
³
 )

1303 
_‹¡_eof63
;

1305  (*
p
) ) {

1306 0: 
Œ89
;

1307 62: 
¡63
;

1309 
¡62
;

1310 
Œ3
:

1312 {
	`MARK
(
m¬k
, 
p
); }

1313 
¡64
;

1314 
¡64
:

1315 iàĞ++
p
 =ğ
³
 )

1316 
_‹¡_eof64
;

1319  (*
p
) ) {

1320 32: 
Œ91
;

1321 37: 
¡69
;

1322 47: 
¡0
;

1323 59: 
Œ93
;

1324 60: 
¡0
;

1325 62: 
¡0
;

1326 63: 
Œ94
;

1327 127: 
¡0
;

1329 iàĞ(*
p
) > 31 ) {

1330 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1331 
¡0
;

1332 } iàĞ(*
p
) >= 0 )

1333 
¡0
;

1334 
¡65
;

1335 
¡65
:

1336 iàĞ++
p
 =ğ
³
 )

1337 
_‹¡_eof65
;

1339  (*
p
) ) {

1340 32: 
Œ91
;

1341 37: 
¡69
;

1342 59: 
Œ93
;

1343 60: 
¡0
;

1344 62: 
¡0
;

1345 63: 
Œ94
;

1346 127: 
¡0
;

1348 iàĞ(*
p
) > 31 ) {

1349 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1350 
¡0
;

1351 } iàĞ(*
p
) >= 0 )

1352 
¡0
;

1353 
¡65
;

1354 
Œ91
:

1357 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1358 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1360 
¡66
;

1361 
Œ105
:

1363 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

1366 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

1367 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

1371 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1372 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1374 
¡66
;

1375 
Œ108
:

1378 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

1379 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

1383 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1384 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1386 
¡66
;

1387 
¡66
:

1388 iàĞ++
p
 =ğ
³
 )

1389 
_‹¡_eof66
;

1392 iàĞ(*
p
) == 123 )

1393 
Œ95
;

1394 
¡0
;

1395 
Œ95
:

1397 {
	`MARK
(
m¬k
, 
p
); }

1398 
¡67
;

1399 
¡67
:

1400 iàĞ++
p
 =ğ
³
 )

1401 
_‹¡_eof67
;

1404 iàĞ(*
p
) == 125 )

1405 
¡68
;

1406 
¡67
;

1407 
¡68
:

1408 iàĞ++
p
 =ğ
³
 )

1409 
_‹¡_eof68
;

1411  (*
p
) ) {

1412 0: 
Œ98
;

1413 125: 
¡68
;

1415 
¡67
;

1416 
¡69
:

1417 iàĞ++
p
 =ğ
³
 )

1418 
_‹¡_eof69
;

1420 iàĞ(*
p
) < 65 ) {

1421 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1422 
¡70
;

1423 } iàĞ(*
p
) > 70 ) {

1424 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1425 
¡70
;

1427 
¡70
;

1428 
¡0
;

1429 
¡70
:

1430 iàĞ++
p
 =ğ
³
 )

1431 
_‹¡_eof70
;

1433 iàĞ(*
p
) < 65 ) {

1434 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1435 
¡65
;

1436 } iàĞ(*
p
) > 70 ) {

1437 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1438 
¡65
;

1440 
¡65
;

1441 
¡0
;

1442 
Œ93
:

1445 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1446 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1448 
¡71
;

1449 
¡71
:

1450 iàĞ++
p
 =ğ
³
 )

1451 
_‹¡_eof71
;

1454  (*
p
) ) {

1455 32: 
Œ91
;

1456 37: 
¡72
;

1457 60: 
¡0
;

1458 62: 
¡0
;

1459 63: 
¡74
;

1460 127: 
¡0
;

1462 iàĞ(*
p
) > 31 ) {

1463 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1464 
¡0
;

1465 } iàĞ(*
p
) >= 0 )

1466 
¡0
;

1467 
¡71
;

1468 
¡72
:

1469 iàĞ++
p
 =ğ
³
 )

1470 
_‹¡_eof72
;

1472 iàĞ(*
p
) < 65 ) {

1473 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1474 
¡73
;

1475 } iàĞ(*
p
) > 70 ) {

1476 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1477 
¡73
;

1479 
¡73
;

1480 
¡0
;

1481 
¡73
:

1482 iàĞ++
p
 =ğ
³
 )

1483 
_‹¡_eof73
;

1485 iàĞ(*
p
) < 65 ) {

1486 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1487 
¡71
;

1488 } iàĞ(*
p
) > 70 ) {

1489 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1490 
¡71
;

1492 
¡71
;

1493 
¡0
;

1494 
Œ94
:

1497 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1498 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1500 
¡74
;

1501 
¡74
:

1502 iàĞ++
p
 =ğ
³
 )

1503 
_‹¡_eof74
;

1506  (*
p
) ) {

1507 32: 
Œ105
;

1508 37: 
Œ106
;

1509 60: 
¡0
;

1510 62: 
¡0
;

1511 127: 
¡0
;

1513 iàĞ(*
p
) > 31 ) {

1514 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1515 
¡0
;

1516 } iàĞ(*
p
) >= 0 )

1517 
¡0
;

1518 
Œ104
;

1519 
Œ104
:

1521 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

1522 
¡75
;

1523 
¡75
:

1524 iàĞ++
p
 =ğ
³
 )

1525 
_‹¡_eof75
;

1528  (*
p
) ) {

1529 32: 
Œ108
;

1530 37: 
¡76
;

1531 60: 
¡0
;

1532 62: 
¡0
;

1533 127: 
¡0
;

1535 iàĞ(*
p
) > 31 ) {

1536 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1537 
¡0
;

1538 } iàĞ(*
p
) >= 0 )

1539 
¡0
;

1540 
¡75
;

1541 
Œ106
:

1543 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

1544 
¡76
;

1545 
¡76
:

1546 iàĞ++
p
 =ğ
³
 )

1547 
_‹¡_eof76
;

1550 iàĞ(*
p
) < 65 ) {

1551 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1552 
¡77
;

1553 } iàĞ(*
p
) > 70 ) {

1554 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1555 
¡77
;

1557 
¡77
;

1558 
¡0
;

1559 
¡77
:

1560 iàĞ++
p
 =ğ
³
 )

1561 
_‹¡_eof77
;

1563 iàĞ(*
p
) < 65 ) {

1564 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1565 
¡75
;

1566 } iàĞ(*
p
) > 70 ) {

1567 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1568 
¡75
;

1570 
¡75
;

1571 
¡0
;

1573 
_‹¡_eof2
: 
cs
 = 2; 
_‹¡_eof
;

1574 
_‹¡_eof3
: 
cs
 = 3; 
_‹¡_eof
;

1575 
_‹¡_eof4
: 
cs
 = 4; 
_‹¡_eof
;

1576 
_‹¡_eof5
: 
cs
 = 5; 
_‹¡_eof
;

1577 
_‹¡_eof6
: 
cs
 = 6; 
_‹¡_eof
;

1578 
_‹¡_eof7
: 
cs
 = 7; 
_‹¡_eof
;

1579 
_‹¡_eof8
: 
cs
 = 8; 
_‹¡_eof
;

1580 
_‹¡_eof9
: 
cs
 = 9; 
_‹¡_eof
;

1581 
_‹¡_eof10
: 
cs
 = 10; 
_‹¡_eof
;

1582 
_‹¡_eof11
: 
cs
 = 11; 
_‹¡_eof
;

1583 
_‹¡_eof12
: 
cs
 = 12; 
_‹¡_eof
;

1584 
_‹¡_eof13
: 
cs
 = 13; 
_‹¡_eof
;

1585 
_‹¡_eof14
: 
cs
 = 14; 
_‹¡_eof
;

1586 
_‹¡_eof78
: 
cs
 = 78; 
_‹¡_eof
;

1587 
_‹¡_eof15
: 
cs
 = 15; 
_‹¡_eof
;

1588 
_‹¡_eof16
: 
cs
 = 16; 
_‹¡_eof
;

1589 
_‹¡_eof17
: 
cs
 = 17; 
_‹¡_eof
;

1590 
_‹¡_eof18
: 
cs
 = 18; 
_‹¡_eof
;

1591 
_‹¡_eof19
: 
cs
 = 19; 
_‹¡_eof
;

1592 
_‹¡_eof20
: 
cs
 = 20; 
_‹¡_eof
;

1593 
_‹¡_eof21
: 
cs
 = 21; 
_‹¡_eof
;

1594 
_‹¡_eof22
: 
cs
 = 22; 
_‹¡_eof
;

1595 
_‹¡_eof23
: 
cs
 = 23; 
_‹¡_eof
;

1596 
_‹¡_eof24
: 
cs
 = 24; 
_‹¡_eof
;

1597 
_‹¡_eof25
: 
cs
 = 25; 
_‹¡_eof
;

1598 
_‹¡_eof26
: 
cs
 = 26; 
_‹¡_eof
;

1599 
_‹¡_eof27
: 
cs
 = 27; 
_‹¡_eof
;

1600 
_‹¡_eof28
: 
cs
 = 28; 
_‹¡_eof
;

1601 
_‹¡_eof29
: 
cs
 = 29; 
_‹¡_eof
;

1602 
_‹¡_eof30
: 
cs
 = 30; 
_‹¡_eof
;

1603 
_‹¡_eof31
: 
cs
 = 31; 
_‹¡_eof
;

1604 
_‹¡_eof32
: 
cs
 = 32; 
_‹¡_eof
;

1605 
_‹¡_eof33
: 
cs
 = 33; 
_‹¡_eof
;

1606 
_‹¡_eof34
: 
cs
 = 34; 
_‹¡_eof
;

1607 
_‹¡_eof35
: 
cs
 = 35; 
_‹¡_eof
;

1608 
_‹¡_eof36
: 
cs
 = 36; 
_‹¡_eof
;

1609 
_‹¡_eof37
: 
cs
 = 37; 
_‹¡_eof
;

1610 
_‹¡_eof38
: 
cs
 = 38; 
_‹¡_eof
;

1611 
_‹¡_eof39
: 
cs
 = 39; 
_‹¡_eof
;

1612 
_‹¡_eof40
: 
cs
 = 40; 
_‹¡_eof
;

1613 
_‹¡_eof41
: 
cs
 = 41; 
_‹¡_eof
;

1614 
_‹¡_eof42
: 
cs
 = 42; 
_‹¡_eof
;

1615 
_‹¡_eof43
: 
cs
 = 43; 
_‹¡_eof
;

1616 
_‹¡_eof44
: 
cs
 = 44; 
_‹¡_eof
;

1617 
_‹¡_eof45
: 
cs
 = 45; 
_‹¡_eof
;

1618 
_‹¡_eof46
: 
cs
 = 46; 
_‹¡_eof
;

1619 
_‹¡_eof47
: 
cs
 = 47; 
_‹¡_eof
;

1620 
_‹¡_eof48
: 
cs
 = 48; 
_‹¡_eof
;

1621 
_‹¡_eof49
: 
cs
 = 49; 
_‹¡_eof
;

1622 
_‹¡_eof50
: 
cs
 = 50; 
_‹¡_eof
;

1623 
_‹¡_eof51
: 
cs
 = 51; 
_‹¡_eof
;

1624 
_‹¡_eof52
: 
cs
 = 52; 
_‹¡_eof
;

1625 
_‹¡_eof53
: 
cs
 = 53; 
_‹¡_eof
;

1626 
_‹¡_eof54
: 
cs
 = 54; 
_‹¡_eof
;

1627 
_‹¡_eof55
: 
cs
 = 55; 
_‹¡_eof
;

1628 
_‹¡_eof56
: 
cs
 = 56; 
_‹¡_eof
;

1629 
_‹¡_eof57
: 
cs
 = 57; 
_‹¡_eof
;

1630 
_‹¡_eof58
: 
cs
 = 58; 
_‹¡_eof
;

1631 
_‹¡_eof59
: 
cs
 = 59; 
_‹¡_eof
;

1632 
_‹¡_eof60
: 
cs
 = 60; 
_‹¡_eof
;

1633 
_‹¡_eof61
: 
cs
 = 61; 
_‹¡_eof
;

1634 
_‹¡_eof62
: 
cs
 = 62; 
_‹¡_eof
;

1635 
_‹¡_eof63
: 
cs
 = 63; 
_‹¡_eof
;

1636 
_‹¡_eof64
: 
cs
 = 64; 
_‹¡_eof
;

1637 
_‹¡_eof65
: 
cs
 = 65; 
_‹¡_eof
;

1638 
_‹¡_eof66
: 
cs
 = 66; 
_‹¡_eof
;

1639 
_‹¡_eof67
: 
cs
 = 67; 
_‹¡_eof
;

1640 
_‹¡_eof68
: 
cs
 = 68; 
_‹¡_eof
;

1641 
_‹¡_eof69
: 
cs
 = 69; 
_‹¡_eof
;

1642 
_‹¡_eof70
: 
cs
 = 70; 
_‹¡_eof
;

1643 
_‹¡_eof71
: 
cs
 = 71; 
_‹¡_eof
;

1644 
_‹¡_eof72
: 
cs
 = 72; 
_‹¡_eof
;

1645 
_‹¡_eof73
: 
cs
 = 73; 
_‹¡_eof
;

1646 
_‹¡_eof74
: 
cs
 = 74; 
_‹¡_eof
;

1647 
_‹¡_eof75
: 
cs
 = 75; 
_‹¡_eof
;

1648 
_‹¡_eof76
: 
cs
 = 76; 
_‹¡_eof
;

1649 
_‹¡_eof77
: 
cs
 = 77; 
_‹¡_eof
;

1651 
_‹¡_eof
: {}

1652 
_out
: {}

1657 
	`as£¹
(
p
 <ğ
³
 && "Buffer overflow‡fter…arsing.");

1659 ià(!
	`h‰p_·r£r_has_”rÜ
(
·r£r
)) {

1660 
·r£r
->
cs
 = cs;

1663 
·r£r
->
Ä—d
 +ğ
p
 - (
bufãr
 + 
off
);

1665 
	`as£¹
(
·r£r
->
Ä—d
 <ğ
Ën
 && "nread†ongerhan†ength");

1666 
	`as£¹
(
·r£r
->
body_¡¬t
 <ğ
Ën
 && "body starts‡fter bufferƒnd");

1667 
	`as£¹
(
·r£r
->
m¬k
 < 
Ën
 && "mark is‡fter bufferƒnd");

1668 
	`as£¹
(
·r£r
->
f›ld_Ën
 <ğ
Ën
 && "field has†ength†ongerhan whole buffer");

1669 
	`as£¹
(
·r£r
->
f›ld_¡¬t
 < 
Ën
 && "field starts‡fter bufferƒnd");

1671 (
·r£r
->
Ä—d
);

1672 
	}
}

1674 
	$h‰p_·r£r_fšish
(
h‰p_·r£r
 *
·r£r
)

1676 ià(
	`h‰p_·r£r_has_”rÜ
(
·r£r
) ) {

1678 } ià(
	`h‰p_·r£r_is_fšished
(
·r£r
) ) {

1683 
	}
}

1685 
	$h‰p_·r£r_has_”rÜ
(
h‰p_·r£r
 *
·r£r
) {

1686  
·r£r
->
cs
 =ğ
h‰p_·r£r_”rÜ
;

1687 
	}
}

1689 
	$h‰p_·r£r_is_fšished
(
h‰p_·r£r
 *
·r£r
) {

1690  
·r£r
->
cs
 >ğ
h‰p_·r£r_fœ¡_fš®
;

1691 
	}
}

	@src/http11/http11_parser.h

2 #iâdeà
h‰p11_·r£r_h


3 
	#h‰p11_·r£r_h


	)

5 
	~<h‰p11/h‰p11_commÚ.h
>

7 
	sh‰p_·r£r
 {

8 
	mcs
;

9 
size_t
 
	mbody_¡¬t
;

10 
	mcÚ‹Á_Ën
;

11 
size_t
 
	mÄ—d
;

12 
size_t
 
	mm¬k
;

13 
size_t
 
	mf›ld_¡¬t
;

14 
size_t
 
	mf›ld_Ën
;

15 
size_t
 
	mqu”y_¡¬t
;

16 
	mxml_£Á
;

17 
	mjsÚ_£Á
;

19 *
	md©a
;

21 
f›ld_cb
 
	mh‰p_f›ld
;

22 
–em’t_cb
 
	m»que¡_m‘hod
;

23 
–em’t_cb
 
	m»que¡_uri
;

24 
–em’t_cb
 
	mäagm’t
;

25 
–em’t_cb
 
	m»que¡_·th
;

26 
–em’t_cb
 
	mqu”y_¡ršg
;

27 
–em’t_cb
 
	mh‰p_v”siÚ
;

28 
–em’t_cb
 
	mh—d”_dÚe
;

30 } 
	th‰p_·r£r
;

32 
h‰p_·r£r_š™
(
h‰p_·r£r
 *
·r£r
);

33 
h‰p_·r£r_fšish
(
h‰p_·r£r
 *
·r£r
);

34 
size_t
 
h‰p_·r£r_execu‹
(
h‰p_·r£r
 *
·r£r
, cÚ¡ *
d©a
, size_ˆ
Ën
, size_ˆ
off
);

35 
h‰p_·r£r_has_”rÜ
(
h‰p_·r£r
 *
·r£r
);

36 
h‰p_·r£r_is_fšished
(
h‰p_·r£r
 *
·r£r
);

38 
	#h‰p_·r£r_Ä—d
(
·r£r
èÕ¬£r)->
Ä—d


	)

	@src/http11/httpclient_parser.c

37 
	~"h‰pş›Á_·r£r.h
"

38 
	~<¡dio.h
>

39 
	~<as£¹.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~"dbg.h
"

45 
	#LEN
(
AT
, 
FPC
è(FPC - 
bufãr
 - 
·r£r
->AT)

	)

46 
	#MARK
(
M
,
FPC
è(
·r£r
->M = (FPCè- 
bufãr
)

	)

47 
	#PTR_TO
(
F
è(
bufãr
 + 
·r£r
->F)

	)

58 cÚ¡ 
	gh‰pş›Á_·r£r_¡¬t
 = 1;

59 cÚ¡ 
	gh‰pş›Á_·r£r_fœ¡_fš®
 = 120;

60 cÚ¡ 
	gh‰pş›Á_·r£r_”rÜ
 = 0;

62 cÚ¡ 
	gh‰pş›Á_·r£r_’_maš
 = 1;

67 
	$h‰pş›Á_·r£r_š™
(
h‰pş›Á_·r£r
 *
·r£r
) {

68 
cs
 = 0;

73 
cs
 = 
h‰pş›Á_·r£r_¡¬t
;

78 
·r£r
->
cs
 = cs;

79 
·r£r
->
body_¡¬t
 = 0;

80 
·r£r
->
cÚ‹Á_Ën
 = -1;

81 
·r£r
->
chunked
 = 0;

82 
·r£r
->
chunks_dÚe
 = 0;

83 
·r£r
->
m¬k
 = 0;

84 
·r£r
->
Ä—d
 = 0;

85 
·r£r
->
f›ld_Ën
 = 0;

86 
·r£r
->
f›ld_¡¬t
 = 0;

87 
·r£r
->
şo£
 = 0;

90 
	}
}

94 
	$h‰pş›Á_·r£r_execu‹
(
h‰pş›Á_·r£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
, size_ˆ
off
)

96 cÚ¡ *
p
, *
³
;

97 
cs
 = 
·r£r
->cs;

99 
	`as£¹
(
off
 <ğ
Ën
 && "offset…astƒnd of buffer");

101 
p
 = 
bufãr
+
off
;

102 
³
 = 
bufãr
+
Ën
;

104 
	`as£¹
(*
³
 == '\0' && "pointer does‚otƒnd on NUL");

105 
	`as£¹
(
³
 - 
p
 =ğ()
Ën
 - ()
off
 && "pointers‡ren't same distance");

111 iàĞ
p
 =ğ
³
 )

112 
_‹¡_eof
;

113  
cs
 )

116 iàĞ(*
p
) == 72 )

117 
Œ2
;

118 iàĞ(*
p
) < 65 ) {

119 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

120 
Œ0
;

121 } iàĞ(*
p
) > 70 ) {

122 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

123 
Œ0
;

125 
Œ0
;

126 
¡0
;

127 
¡0
:

128 
cs
 = 0;

129 
_out
;

130 
Œ0
:

132 {
	`MARK
(
m¬k
, 
p
); }

133 
¡2
;

134 
¡2
:

135 iàĞ++
p
 =ğ
³
 )

136 
_‹¡_eof2
;

139  (*
p
) ) {

140 10: 
Œ3
;

141 13: 
Œ4
;

142 59: 
Œ6
;

144 iàĞ(*
p
) < 65 ) {

145 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

146 
¡2
;

147 } iàĞ(*
p
) > 70 ) {

148 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

149 
¡2
;

151 
¡2
;

152 
¡0
;

153 
Œ3
:

156 
·r£r
->
chunked
 = 1;

157 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 16);

158 
·r£r
->
chunks_dÚe
 =…¬£r->
cÚ‹Á_Ën
 <= 0;

160 if(
·r£r
->
chunks_dÚe
 &&…¬£r->
Ï¡_chunk
) {

161 
·r£r
->
	`Ï¡_chunk
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

162 } if(
·r£r
->
chunk_size
 !ğ
NULL
) {

163 
·r£r
->
	`chunk_size
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

168 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

169 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

170 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

171 {
p
++; 
cs
 = 120; 
_out
;}

173 
¡120
;

174 
Œ7
:

177 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

178 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

179 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

180 {
p
++; 
cs
 = 120; 
_out
;}

182 
¡120
;

183 
Œ9
:

186 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

189 { 
	`MARK
(
m¬k
, 
p
); }

192 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

193 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

198 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

199 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

200 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

201 {
p
++; 
cs
 = 120; 
_out
;}

203 
¡120
;

204 
Œ15
:

207 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

208 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

213 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

214 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

215 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

216 {
p
++; 
cs
 = 120; 
_out
;}

218 
¡120
;

219 
Œ74
:

222 
·r£r
->
şo£
 = 1;

226 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

227 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

228 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

229 {
p
++; 
cs
 = 120; 
_out
;}

231 
¡120
;

232 
¡120
:

233 iàĞ++
p
 =ğ
³
 )

234 
_‹¡_eof120
;

237 
¡0
;

238 
Œ4
:

241 
·r£r
->
chunked
 = 1;

242 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 16);

243 
·r£r
->
chunks_dÚe
 =…¬£r->
cÚ‹Á_Ën
 <= 0;

245 if(
·r£r
->
chunks_dÚe
 &&…¬£r->
Ï¡_chunk
) {

246 
·r£r
->
	`Ï¡_chunk
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

247 } if(
·r£r
->
chunk_size
 !ğ
NULL
) {

248 
·r£r
->
	`chunk_size
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

251 
¡3
;

252 
Œ10
:

255 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

258 { 
	`MARK
(
m¬k
, 
p
); }

261 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

262 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

265 
¡3
;

266 
Œ16
:

269 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

270 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

273 
¡3
;

274 
Œ75
:

277 
·r£r
->
şo£
 = 1;

279 
¡3
;

280 
¡3
:

281 iàĞ++
p
 =ğ
³
 )

282 
_‹¡_eof3
;

285 iàĞ(*
p
) == 10 )

286 
Œ7
;

287 
¡0
;

288 
Œ6
:

291 
·r£r
->
chunked
 = 1;

292 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 16);

293 
·r£r
->
chunks_dÚe
 =…¬£r->
cÚ‹Á_Ën
 <= 0;

295 if(
·r£r
->
chunks_dÚe
 &&…¬£r->
Ï¡_chunk
) {

296 
·r£r
->
	`Ï¡_chunk
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

297 } if(
·r£r
->
chunk_size
 !ğ
NULL
) {

298 
·r£r
->
	`chunk_size
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

301 
¡4
;

302 
Œ12
:

305 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

308 { 
	`MARK
(
m¬k
, 
p
); }

311 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

312 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

315 
¡4
;

316 
Œ18
:

319 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

320 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

323 
¡4
;

324 
¡4
:

325 iàĞ++
p
 =ğ
³
 )

326 
_‹¡_eof4
;

329  (*
p
) ) {

330 33: 
Œ8
;

331 124: 
Œ8
;

332 126: 
Œ8
;

334 iàĞ(*
p
) < 45 ) {

335 iàĞ(*
p
) > 39 ) {

336 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

337 
Œ8
;

338 } iàĞ(*
p
) >= 35 )

339 
Œ8
;

340 } iàĞ(*
p
) > 46 ) {

341 iàĞ(*
p
) < 65 ) {

342 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

343 
Œ8
;

344 } iàĞ(*
p
) > 90 ) {

345 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

346 
Œ8
;

348 
Œ8
;

350 
Œ8
;

351 
¡0
;

352 
Œ8
:

354 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

355 
¡5
;

356 
¡5
:

357 iàĞ++
p
 =ğ
³
 )

358 
_‹¡_eof5
;

361  (*
p
) ) {

362 10: 
Œ9
;

363 13: 
Œ10
;

364 33: 
¡5
;

365 59: 
Œ12
;

366 61: 
Œ13
;

367 124: 
¡5
;

368 126: 
¡5
;

370 iàĞ(*
p
) < 45 ) {

371 iàĞ(*
p
) > 39 ) {

372 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

373 
¡5
;

374 } iàĞ(*
p
) >= 35 )

375 
¡5
;

376 } iàĞ(*
p
) > 46 ) {

377 iàĞ(*
p
) < 65 ) {

378 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

379 
¡5
;

380 } iàĞ(*
p
) > 90 ) {

381 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

382 
¡5
;

384 
¡5
;

386 
¡5
;

387 
¡0
;

388 
Œ13
:

391 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

394 { 
	`MARK
(
m¬k
, 
p
); }

395 
¡6
;

396 
¡6
:

397 iàĞ++
p
 =ğ
³
 )

398 
_‹¡_eof6
;

401  (*
p
) ) {

402 33: 
Œ14
;

403 124: 
Œ14
;

404 126: 
Œ14
;

406 iàĞ(*
p
) < 45 ) {

407 iàĞ(*
p
) > 39 ) {

408 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

409 
Œ14
;

410 } iàĞ(*
p
) >= 35 )

411 
Œ14
;

412 } iàĞ(*
p
) > 46 ) {

413 iàĞ(*
p
) < 65 ) {

414 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

415 
Œ14
;

416 } iàĞ(*
p
) > 90 ) {

417 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

418 
Œ14
;

420 
Œ14
;

422 
Œ14
;

423 
¡0
;

424 
Œ14
:

426 { 
	`MARK
(
m¬k
, 
p
); }

427 
¡7
;

428 
¡7
:

429 iàĞ++
p
 =ğ
³
 )

430 
_‹¡_eof7
;

433  (*
p
) ) {

434 10: 
Œ15
;

435 13: 
Œ16
;

436 33: 
¡7
;

437 59: 
Œ18
;

438 124: 
¡7
;

439 126: 
¡7
;

441 iàĞ(*
p
) < 45 ) {

442 iàĞ(*
p
) > 39 ) {

443 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

444 
¡7
;

445 } iàĞ(*
p
) >= 35 )

446 
¡7
;

447 } iàĞ(*
p
) > 46 ) {

448 iàĞ(*
p
) < 65 ) {

449 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

450 
¡7
;

451 } iàĞ(*
p
) > 90 ) {

452 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

453 
¡7
;

455 
¡7
;

457 
¡7
;

458 
¡0
;

459 
Œ2
:

461 {
	`MARK
(
m¬k
, 
p
); }

462 
¡8
;

463 
¡8
:

464 iàĞ++
p
 =ğ
³
 )

465 
_‹¡_eof8
;

468 iàĞ(*
p
) == 84 )

469 
¡9
;

470 
¡0
;

471 
¡9
:

472 iàĞ++
p
 =ğ
³
 )

473 
_‹¡_eof9
;

475 iàĞ(*
p
) == 84 )

476 
¡10
;

477 
¡0
;

478 
¡10
:

479 iàĞ++
p
 =ğ
³
 )

480 
_‹¡_eof10
;

482 iàĞ(*
p
) == 80 )

483 
¡11
;

484 
¡0
;

485 
¡11
:

486 iàĞ++
p
 =ğ
³
 )

487 
_‹¡_eof11
;

489 iàĞ(*
p
) == 47 )

490 
¡12
;

491 
¡0
;

492 
¡12
:

493 iàĞ++
p
 =ğ
³
 )

494 
_‹¡_eof12
;

496 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

497 
¡13
;

498 
¡0
;

499 
¡13
:

500 iàĞ++
p
 =ğ
³
 )

501 
_‹¡_eof13
;

503 iàĞ(*
p
) == 46 )

504 
¡14
;

505 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

506 
¡13
;

507 
¡0
;

508 
¡14
:

509 iàĞ++
p
 =ğ
³
 )

510 
_‹¡_eof14
;

512 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

513 
¡15
;

514 
¡0
;

515 
¡15
:

516 iàĞ++
p
 =ğ
³
 )

517 
_‹¡_eof15
;

519 iàĞ(*
p
) == 32 )

520 
Œ26
;

521 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

522 
¡15
;

523 
¡0
;

524 
Œ26
:

527 if(
·r£r
->
h‰p_v”siÚ
 !ğ
NULL
)

528 
·r£r
->
	`h‰p_v”siÚ
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

530 
¡16
;

531 
¡16
:

532 iàĞ++
p
 =ğ
³
 )

533 
_‹¡_eof16
;

536 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

537 
Œ27
;

538 
¡0
;

539 
Œ27
:

541 {
	`MARK
(
m¬k
, 
p
); }

542 
¡17
;

543 
¡17
:

544 iàĞ++
p
 =ğ
³
 )

545 
_‹¡_eof17
;

548 iàĞ(*
p
) == 32 )

549 
Œ28
;

550 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

551 
¡17
;

552 
¡0
;

553 
Œ28
:

556 
·r£r
->
¡©us
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 10);

558 if(
·r£r
->
¡©us_code
 !ğ
NULL
)

559 
·r£r
->
	`¡©us_code
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

561 
¡18
;

562 
¡18
:

563 iàĞ++
p
 =ğ
³
 )

564 
_‹¡_eof18
;

567 iàĞ(*
p
) == 10 )

568 
¡0
;

569 
Œ30
;

570 
Œ30
:

572 {
	`MARK
(
m¬k
, 
p
); }

573 
¡19
;

574 
¡19
:

575 iàĞ++
p
 =ğ
³
 )

576 
_‹¡_eof19
;

579  (*
p
) ) {

580 10: 
Œ32
;

581 13: 
Œ33
;

583 
¡19
;

584 
Œ45
:

587 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

588 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

591 
¡20
;

592 
Œ32
:

595 if(
·r£r
->
»asÚ_ph¿£
 !ğ
NULL
)

596 
·r£r
->
	`»asÚ_ph¿£
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

598 
¡20
;

599 
Œ42
:

601 { 
	`MARK
(
m¬k
, 
p
); }

604 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

605 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

608 
¡20
;

609 
Œ111
:

612 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

613 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

618 
·r£r
->
chunked
 = 1;

620 
¡20
;

621 
Œ113
:

624 
·r£r
->
chunked
 = 1;

626 
¡20
;

627 
Œ158
:

630 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 10);

634 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

635 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

638 
¡20
;

639 
¡20
:

640 iàĞ++
p
 =ğ
³
 )

641 
_‹¡_eof20
;

644  (*
p
) ) {

645 10: 
Œ7
;

646 13: 
¡3
;

647 33: 
Œ35
;

648 67: 
Œ36
;

649 84: 
Œ37
;

650 99: 
Œ36
;

651 116: 
Œ37
;

652 124: 
Œ35
;

653 126: 
Œ35
;

655 iàĞ(*
p
) < 45 ) {

656 iàĞ(*
p
) > 39 ) {

657 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

658 
Œ35
;

659 } iàĞ(*
p
) >= 35 )

660 
Œ35
;

661 } iàĞ(*
p
) > 46 ) {

662 iàĞ(*
p
) < 65 ) {

663 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

664 
Œ35
;

665 } iàĞ(*
p
) > 90 ) {

666 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

667 
Œ35
;

669 
Œ35
;

671 
Œ35
;

672 
¡0
;

673 
Œ35
:

675 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

676 
¡21
;

677 
Œ76
:

680 
·r£r
->
şo£
 = 1;

683 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

684 
¡21
;

685 
¡21
:

686 iàĞ++
p
 =ğ
³
 )

687 
_‹¡_eof21
;

690  (*
p
) ) {

691 33: 
¡21
;

692 58: 
Œ39
;

693 124: 
¡21
;

694 126: 
¡21
;

696 iàĞ(*
p
) < 45 ) {

697 iàĞ(*
p
) > 39 ) {

698 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

699 
¡21
;

700 } iàĞ(*
p
) >= 35 )

701 
¡21
;

702 } iàĞ(*
p
) > 46 ) {

703 iàĞ(*
p
) < 65 ) {

704 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

705 
¡21
;

706 } iàĞ(*
p
) > 90 ) {

707 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

708 
¡21
;

710 
¡21
;

712 
¡21
;

713 
¡0
;

714 
Œ41
:

716 { 
	`MARK
(
m¬k
, 
p
); }

717 
¡22
;

718 
Œ39
:

721 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

723 
¡22
;

724 
¡22
:

725 iàĞ++
p
 =ğ
³
 )

726 
_‹¡_eof22
;

729  (*
p
) ) {

730 10: 
Œ42
;

731 13: 
Œ43
;

732 32: 
Œ41
;

734 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

735 
Œ41
;

736 
Œ40
;

737 
Œ40
:

739 { 
	`MARK
(
m¬k
, 
p
); }

740 
¡23
;

741 
¡23
:

742 iàĞ++
p
 =ğ
³
 )

743 
_‹¡_eof23
;

746  (*
p
) ) {

747 10: 
Œ45
;

748 13: 
Œ46
;

750 
¡23
;

751 
Œ46
:

754 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

755 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

758 
¡24
;

759 
Œ33
:

762 if(
·r£r
->
»asÚ_ph¿£
 !ğ
NULL
)

763 
·r£r
->
	`»asÚ_ph¿£
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

765 
¡24
;

766 
Œ43
:

768 { 
	`MARK
(
m¬k
, 
p
); }

771 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

772 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

775 
¡24
;

776 
Œ159
:

779 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 10);

783 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

784 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

787 
¡24
;

788 
¡24
:

789 iàĞ++
p
 =ğ
³
 )

790 
_‹¡_eof24
;

793 iàĞ(*
p
) == 10 )

794 
¡20
;

795 
¡0
;

796 
Œ36
:

798 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

799 
¡25
;

800 
Œ77
:

803 
·r£r
->
şo£
 = 1;

806 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

807 
¡25
;

808 
¡25
:

809 iàĞ++
p
 =ğ
³
 )

810 
_‹¡_eof25
;

813  (*
p
) ) {

814 33: 
¡21
;

815 58: 
Œ39
;

816 79: 
¡26
;

817 111: 
¡26
;

818 124: 
¡21
;

819 126: 
¡21
;

821 iàĞ(*
p
) < 45 ) {

822 iàĞ(*
p
) > 39 ) {

823 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

824 
¡21
;

825 } iàĞ(*
p
) >= 35 )

826 
¡21
;

827 } iàĞ(*
p
) > 46 ) {

828 iàĞ(*
p
) < 65 ) {

829 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

830 
¡21
;

831 } iàĞ(*
p
) > 90 ) {

832 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

833 
¡21
;

835 
¡21
;

837 
¡21
;

838 
¡0
;

839 
¡26
:

840 iàĞ++
p
 =ğ
³
 )

841 
_‹¡_eof26
;

843  (*
p
) ) {

844 33: 
¡21
;

845 58: 
Œ39
;

846 78: 
¡27
;

847 110: 
¡27
;

848 124: 
¡21
;

849 126: 
¡21
;

851 iàĞ(*
p
) < 45 ) {

852 iàĞ(*
p
) > 39 ) {

853 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

854 
¡21
;

855 } iàĞ(*
p
) >= 35 )

856 
¡21
;

857 } iàĞ(*
p
) > 46 ) {

858 iàĞ(*
p
) < 65 ) {

859 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

860 
¡21
;

861 } iàĞ(*
p
) > 90 ) {

862 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

863 
¡21
;

865 
¡21
;

867 
¡21
;

868 
¡0
;

869 
¡27
:

870 iàĞ++
p
 =ğ
³
 )

871 
_‹¡_eof27
;

873  (*
p
) ) {

874 33: 
¡21
;

875 58: 
Œ39
;

876 78: 
¡28
;

877 84: 
¡101
;

878 110: 
¡28
;

879 116: 
¡101
;

880 124: 
¡21
;

881 126: 
¡21
;

883 iàĞ(*
p
) < 45 ) {

884 iàĞ(*
p
) > 39 ) {

885 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

886 
¡21
;

887 } iàĞ(*
p
) >= 35 )

888 
¡21
;

889 } iàĞ(*
p
) > 46 ) {

890 iàĞ(*
p
) < 65 ) {

891 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

892 
¡21
;

893 } iàĞ(*
p
) > 90 ) {

894 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

895 
¡21
;

897 
¡21
;

899 
¡21
;

900 
¡0
;

901 
¡28
:

902 iàĞ++
p
 =ğ
³
 )

903 
_‹¡_eof28
;

905  (*
p
) ) {

906 33: 
¡21
;

907 58: 
Œ39
;

908 69: 
¡29
;

909 101: 
¡29
;

910 124: 
¡21
;

911 126: 
¡21
;

913 iàĞ(*
p
) < 45 ) {

914 iàĞ(*
p
) > 39 ) {

915 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

916 
¡21
;

917 } iàĞ(*
p
) >= 35 )

918 
¡21
;

919 } iàĞ(*
p
) > 46 ) {

920 iàĞ(*
p
) < 65 ) {

921 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

922 
¡21
;

923 } iàĞ(*
p
) > 90 ) {

924 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

925 
¡21
;

927 
¡21
;

929 
¡21
;

930 
¡0
;

931 
¡29
:

932 iàĞ++
p
 =ğ
³
 )

933 
_‹¡_eof29
;

935  (*
p
) ) {

936 33: 
¡21
;

937 58: 
Œ39
;

938 67: 
¡30
;

939 99: 
¡30
;

940 124: 
¡21
;

941 126: 
¡21
;

943 iàĞ(*
p
) < 45 ) {

944 iàĞ(*
p
) > 39 ) {

945 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

946 
¡21
;

947 } iàĞ(*
p
) >= 35 )

948 
¡21
;

949 } iàĞ(*
p
) > 46 ) {

950 iàĞ(*
p
) < 65 ) {

951 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

952 
¡21
;

953 } iàĞ(*
p
) > 90 ) {

954 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

955 
¡21
;

957 
¡21
;

959 
¡21
;

960 
¡0
;

961 
¡30
:

962 iàĞ++
p
 =ğ
³
 )

963 
_‹¡_eof30
;

965  (*
p
) ) {

966 33: 
¡21
;

967 58: 
Œ39
;

968 84: 
¡31
;

969 116: 
¡31
;

970 124: 
¡21
;

971 126: 
¡21
;

973 iàĞ(*
p
) < 45 ) {

974 iàĞ(*
p
) > 39 ) {

975 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

976 
¡21
;

977 } iàĞ(*
p
) >= 35 )

978 
¡21
;

979 } iàĞ(*
p
) > 46 ) {

980 iàĞ(*
p
) < 65 ) {

981 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

982 
¡21
;

983 } iàĞ(*
p
) > 90 ) {

984 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

985 
¡21
;

987 
¡21
;

989 
¡21
;

990 
¡0
;

991 
¡31
:

992 iàĞ++
p
 =ğ
³
 )

993 
_‹¡_eof31
;

995  (*
p
) ) {

996 33: 
¡21
;

997 58: 
Œ39
;

998 73: 
¡32
;

999 105: 
¡32
;

1000 124: 
¡21
;

1001 126: 
¡21
;

1003 iàĞ(*
p
) < 45 ) {

1004 iàĞ(*
p
) > 39 ) {

1005 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1006 
¡21
;

1007 } iàĞ(*
p
) >= 35 )

1008 
¡21
;

1009 } iàĞ(*
p
) > 46 ) {

1010 iàĞ(*
p
) < 65 ) {

1011 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1012 
¡21
;

1013 } iàĞ(*
p
) > 90 ) {

1014 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1015 
¡21
;

1017 
¡21
;

1019 
¡21
;

1020 
¡0
;

1021 
¡32
:

1022 iàĞ++
p
 =ğ
³
 )

1023 
_‹¡_eof32
;

1025  (*
p
) ) {

1026 33: 
¡21
;

1027 58: 
Œ39
;

1028 79: 
¡33
;

1029 111: 
¡33
;

1030 124: 
¡21
;

1031 126: 
¡21
;

1033 iàĞ(*
p
) < 45 ) {

1034 iàĞ(*
p
) > 39 ) {

1035 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1036 
¡21
;

1037 } iàĞ(*
p
) >= 35 )

1038 
¡21
;

1039 } iàĞ(*
p
) > 46 ) {

1040 iàĞ(*
p
) < 65 ) {

1041 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1042 
¡21
;

1043 } iàĞ(*
p
) > 90 ) {

1044 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1045 
¡21
;

1047 
¡21
;

1049 
¡21
;

1050 
¡0
;

1051 
¡33
:

1052 iàĞ++
p
 =ğ
³
 )

1053 
_‹¡_eof33
;

1055  (*
p
) ) {

1056 33: 
¡21
;

1057 58: 
Œ39
;

1058 78: 
¡34
;

1059 110: 
¡34
;

1060 124: 
¡21
;

1061 126: 
¡21
;

1063 iàĞ(*
p
) < 45 ) {

1064 iàĞ(*
p
) > 39 ) {

1065 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1066 
¡21
;

1067 } iàĞ(*
p
) >= 35 )

1068 
¡21
;

1069 } iàĞ(*
p
) > 46 ) {

1070 iàĞ(*
p
) < 65 ) {

1071 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1072 
¡21
;

1073 } iàĞ(*
p
) > 90 ) {

1074 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1075 
¡21
;

1077 
¡21
;

1079 
¡21
;

1080 
¡0
;

1081 
¡34
:

1082 iàĞ++
p
 =ğ
³
 )

1083 
_‹¡_eof34
;

1085  (*
p
) ) {

1086 33: 
¡21
;

1087 58: 
Œ58
;

1088 124: 
¡21
;

1089 126: 
¡21
;

1091 iàĞ(*
p
) < 45 ) {

1092 iàĞ(*
p
) > 39 ) {

1093 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1094 
¡21
;

1095 } iàĞ(*
p
) >= 35 )

1096 
¡21
;

1097 } iàĞ(*
p
) > 46 ) {

1098 iàĞ(*
p
) < 65 ) {

1099 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1100 
¡21
;

1101 } iàĞ(*
p
) > 90 ) {

1102 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1103 
¡21
;

1105 
¡21
;

1107 
¡21
;

1108 
¡0
;

1109 
Œ59
:

1111 { 
	`MARK
(
m¬k
, 
p
); }

1112 
¡35
;

1113 
Œ58
:

1116 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

1118 
¡35
;

1119 
¡35
:

1120 iàĞ++
p
 =ğ
³
 )

1121 
_‹¡_eof35
;

1124  (*
p
) ) {

1125 10: 
Œ60
;

1126 13: 
Œ61
;

1127 32: 
Œ59
;

1128 67: 
Œ62
;

1129 99: 
Œ62
;

1131 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1132 
Œ59
;

1133 
Œ40
;

1134 
Œ60
:

1136 { 
	`MARK
(
m¬k
, 
p
); }

1139 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1140 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1143 
¡36
;

1144 
¡36
:

1145 iàĞ++
p
 =ğ
³
 )

1146 
_‹¡_eof36
;

1149  (*
p
) ) {

1150 10: 
Œ64
;

1151 13: 
¡89
;

1152 32: 
¡37
;

1153 33: 
Œ35
;

1154 67: 
Œ66
;

1155 84: 
Œ37
;

1156 99: 
Œ66
;

1157 116: 
Œ37
;

1158 124: 
Œ35
;

1159 126: 
Œ35
;

1161 iàĞ(*
p
) < 45 ) {

1162 iàĞ(*
p
) < 35 ) {

1163 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1164 
¡37
;

1165 } iàĞ(*
p
) > 39 ) {

1166 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1167 
Œ35
;

1169 
Œ35
;

1170 } iàĞ(*
p
) > 46 ) {

1171 iàĞ(*
p
) < 65 ) {

1172 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1173 
Œ35
;

1174 } iàĞ(*
p
) > 90 ) {

1175 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1176 
Œ35
;

1178 
Œ35
;

1180 
Œ35
;

1181 
¡0
;

1182 
¡37
:

1183 iàĞ++
p
 =ğ
³
 )

1184 
_‹¡_eof37
;

1186  (*
p
) ) {

1187 32: 
¡37
;

1188 67: 
¡38
;

1189 99: 
¡38
;

1191 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1192 
¡37
;

1193 
¡0
;

1194 
¡38
:

1195 iàĞ++
p
 =ğ
³
 )

1196 
_‹¡_eof38
;

1198  (*
p
) ) {

1199 76: 
¡39
;

1200 108: 
¡39
;

1202 
¡0
;

1203 
¡39
:

1204 iàĞ++
p
 =ğ
³
 )

1205 
_‹¡_eof39
;

1207  (*
p
) ) {

1208 79: 
¡40
;

1209 111: 
¡40
;

1211 
¡0
;

1212 
¡40
:

1213 iàĞ++
p
 =ğ
³
 )

1214 
_‹¡_eof40
;

1216  (*
p
) ) {

1217 83: 
¡41
;

1218 115: 
¡41
;

1220 
¡0
;

1221 
¡41
:

1222 iàĞ++
p
 =ğ
³
 )

1223 
_‹¡_eof41
;

1225  (*
p
) ) {

1226 69: 
¡42
;

1227 101: 
¡42
;

1229 
¡0
;

1230 
¡42
:

1231 iàĞ++
p
 =ğ
³
 )

1232 
_‹¡_eof42
;

1234  (*
p
) ) {

1235 10: 
¡43
;

1236 13: 
¡88
;

1238 
¡0
;

1239 
Œ136
:

1242 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1243 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1246 
¡43
;

1247 
¡43
:

1248 iàĞ++
p
 =ğ
³
 )

1249 
_‹¡_eof43
;

1252  (*
p
) ) {

1253 10: 
Œ74
;

1254 13: 
Œ75
;

1255 33: 
Œ76
;

1256 67: 
Œ77
;

1257 84: 
Œ78
;

1258 99: 
Œ77
;

1259 116: 
Œ78
;

1260 124: 
Œ76
;

1261 126: 
Œ76
;

1263 iàĞ(*
p
) < 45 ) {

1264 iàĞ(*
p
) > 39 ) {

1265 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1266 
Œ76
;

1267 } iàĞ(*
p
) >= 35 )

1268 
Œ76
;

1269 } iàĞ(*
p
) > 46 ) {

1270 iàĞ(*
p
) < 65 ) {

1271 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1272 
Œ76
;

1273 } iàĞ(*
p
) > 90 ) {

1274 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1275 
Œ76
;

1277 
Œ76
;

1279 
Œ76
;

1280 
¡0
;

1281 
Œ37
:

1283 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

1284 
¡44
;

1285 
Œ78
:

1288 
·r£r
->
şo£
 = 1;

1291 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

1292 
¡44
;

1293 
¡44
:

1294 iàĞ++
p
 =ğ
³
 )

1295 
_‹¡_eof44
;

1298  (*
p
) ) {

1299 33: 
¡21
;

1300 58: 
Œ39
;

1301 82: 
¡45
;

1302 114: 
¡45
;

1303 124: 
¡21
;

1304 126: 
¡21
;

1306 iàĞ(*
p
) < 45 ) {

1307 iàĞ(*
p
) > 39 ) {

1308 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1309 
¡21
;

1310 } iàĞ(*
p
) >= 35 )

1311 
¡21
;

1312 } iàĞ(*
p
) > 46 ) {

1313 iàĞ(*
p
) < 65 ) {

1314 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1315 
¡21
;

1316 } iàĞ(*
p
) > 90 ) {

1317 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1318 
¡21
;

1320 
¡21
;

1322 
¡21
;

1323 
¡0
;

1324 
¡45
:

1325 iàĞ++
p
 =ğ
³
 )

1326 
_‹¡_eof45
;

1328  (*
p
) ) {

1329 33: 
¡21
;

1330 58: 
Œ39
;

1331 65: 
¡46
;

1332 97: 
¡46
;

1333 124: 
¡21
;

1334 126: 
¡21
;

1336 iàĞ(*
p
) < 45 ) {

1337 iàĞ(*
p
) > 39 ) {

1338 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1339 
¡21
;

1340 } iàĞ(*
p
) >= 35 )

1341 
¡21
;

1342 } iàĞ(*
p
) > 46 ) {

1343 iàĞ(*
p
) < 66 ) {

1344 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1345 
¡21
;

1346 } iàĞ(*
p
) > 90 ) {

1347 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1348 
¡21
;

1350 
¡21
;

1352 
¡21
;

1353 
¡0
;

1354 
¡46
:

1355 iàĞ++
p
 =ğ
³
 )

1356 
_‹¡_eof46
;

1358  (*
p
) ) {

1359 33: 
¡21
;

1360 58: 
Œ39
;

1361 78: 
¡47
;

1362 110: 
¡47
;

1363 124: 
¡21
;

1364 126: 
¡21
;

1366 iàĞ(*
p
) < 45 ) {

1367 iàĞ(*
p
) > 39 ) {

1368 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1369 
¡21
;

1370 } iàĞ(*
p
) >= 35 )

1371 
¡21
;

1372 } iàĞ(*
p
) > 46 ) {

1373 iàĞ(*
p
) < 65 ) {

1374 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1375 
¡21
;

1376 } iàĞ(*
p
) > 90 ) {

1377 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1378 
¡21
;

1380 
¡21
;

1382 
¡21
;

1383 
¡0
;

1384 
¡47
:

1385 iàĞ++
p
 =ğ
³
 )

1386 
_‹¡_eof47
;

1388  (*
p
) ) {

1389 33: 
¡21
;

1390 58: 
Œ39
;

1391 83: 
¡48
;

1392 115: 
¡48
;

1393 124: 
¡21
;

1394 126: 
¡21
;

1396 iàĞ(*
p
) < 45 ) {

1397 iàĞ(*
p
) > 39 ) {

1398 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1399 
¡21
;

1400 } iàĞ(*
p
) >= 35 )

1401 
¡21
;

1402 } iàĞ(*
p
) > 46 ) {

1403 iàĞ(*
p
) < 65 ) {

1404 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1405 
¡21
;

1406 } iàĞ(*
p
) > 90 ) {

1407 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1408 
¡21
;

1410 
¡21
;

1412 
¡21
;

1413 
¡0
;

1414 
¡48
:

1415 iàĞ++
p
 =ğ
³
 )

1416 
_‹¡_eof48
;

1418  (*
p
) ) {

1419 33: 
¡21
;

1420 58: 
Œ39
;

1421 70: 
¡49
;

1422 102: 
¡49
;

1423 124: 
¡21
;

1424 126: 
¡21
;

1426 iàĞ(*
p
) < 45 ) {

1427 iàĞ(*
p
) > 39 ) {

1428 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1429 
¡21
;

1430 } iàĞ(*
p
) >= 35 )

1431 
¡21
;

1432 } iàĞ(*
p
) > 46 ) {

1433 iàĞ(*
p
) < 65 ) {

1434 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1435 
¡21
;

1436 } iàĞ(*
p
) > 90 ) {

1437 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1438 
¡21
;

1440 
¡21
;

1442 
¡21
;

1443 
¡0
;

1444 
¡49
:

1445 iàĞ++
p
 =ğ
³
 )

1446 
_‹¡_eof49
;

1448  (*
p
) ) {

1449 33: 
¡21
;

1450 58: 
Œ39
;

1451 69: 
¡50
;

1452 101: 
¡50
;

1453 124: 
¡21
;

1454 126: 
¡21
;

1456 iàĞ(*
p
) < 45 ) {

1457 iàĞ(*
p
) > 39 ) {

1458 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1459 
¡21
;

1460 } iàĞ(*
p
) >= 35 )

1461 
¡21
;

1462 } iàĞ(*
p
) > 46 ) {

1463 iàĞ(*
p
) < 65 ) {

1464 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1465 
¡21
;

1466 } iàĞ(*
p
) > 90 ) {

1467 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1468 
¡21
;

1470 
¡21
;

1472 
¡21
;

1473 
¡0
;

1474 
¡50
:

1475 iàĞ++
p
 =ğ
³
 )

1476 
_‹¡_eof50
;

1478  (*
p
) ) {

1479 33: 
¡21
;

1480 58: 
Œ39
;

1481 82: 
¡51
;

1482 114: 
¡51
;

1483 124: 
¡21
;

1484 126: 
¡21
;

1486 iàĞ(*
p
) < 45 ) {

1487 iàĞ(*
p
) > 39 ) {

1488 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1489 
¡21
;

1490 } iàĞ(*
p
) >= 35 )

1491 
¡21
;

1492 } iàĞ(*
p
) > 46 ) {

1493 iàĞ(*
p
) < 65 ) {

1494 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1495 
¡21
;

1496 } iàĞ(*
p
) > 90 ) {

1497 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1498 
¡21
;

1500 
¡21
;

1502 
¡21
;

1503 
¡0
;

1504 
¡51
:

1505 iàĞ++
p
 =ğ
³
 )

1506 
_‹¡_eof51
;

1508  (*
p
) ) {

1509 33: 
¡21
;

1510 45: 
¡52
;

1511 46: 
¡21
;

1512 58: 
Œ39
;

1513 124: 
¡21
;

1514 126: 
¡21
;

1516 iàĞ(*
p
) < 48 ) {

1517 iàĞ(*
p
) > 39 ) {

1518 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1519 
¡21
;

1520 } iàĞ(*
p
) >= 35 )

1521 
¡21
;

1522 } iàĞ(*
p
) > 57 ) {

1523 iàĞ(*
p
) > 90 ) {

1524 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1525 
¡21
;

1526 } iàĞ(*
p
) >= 65 )

1527 
¡21
;

1529 
¡21
;

1530 
¡0
;

1531 
¡52
:

1532 iàĞ++
p
 =ğ
³
 )

1533 
_‹¡_eof52
;

1535  (*
p
) ) {

1536 33: 
¡21
;

1537 58: 
Œ39
;

1538 69: 
¡53
;

1539 101: 
¡53
;

1540 124: 
¡21
;

1541 126: 
¡21
;

1543 iàĞ(*
p
) < 45 ) {

1544 iàĞ(*
p
) > 39 ) {

1545 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1546 
¡21
;

1547 } iàĞ(*
p
) >= 35 )

1548 
¡21
;

1549 } iàĞ(*
p
) > 46 ) {

1550 iàĞ(*
p
) < 65 ) {

1551 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1552 
¡21
;

1553 } iàĞ(*
p
) > 90 ) {

1554 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1555 
¡21
;

1557 
¡21
;

1559 
¡21
;

1560 
¡0
;

1561 
¡53
:

1562 iàĞ++
p
 =ğ
³
 )

1563 
_‹¡_eof53
;

1565  (*
p
) ) {

1566 33: 
¡21
;

1567 58: 
Œ39
;

1568 78: 
¡54
;

1569 110: 
¡54
;

1570 124: 
¡21
;

1571 126: 
¡21
;

1573 iàĞ(*
p
) < 45 ) {

1574 iàĞ(*
p
) > 39 ) {

1575 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1576 
¡21
;

1577 } iàĞ(*
p
) >= 35 )

1578 
¡21
;

1579 } iàĞ(*
p
) > 46 ) {

1580 iàĞ(*
p
) < 65 ) {

1581 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1582 
¡21
;

1583 } iàĞ(*
p
) > 90 ) {

1584 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1585 
¡21
;

1587 
¡21
;

1589 
¡21
;

1590 
¡0
;

1591 
¡54
:

1592 iàĞ++
p
 =ğ
³
 )

1593 
_‹¡_eof54
;

1595  (*
p
) ) {

1596 33: 
¡21
;

1597 58: 
Œ39
;

1598 67: 
¡55
;

1599 99: 
¡55
;

1600 124: 
¡21
;

1601 126: 
¡21
;

1603 iàĞ(*
p
) < 45 ) {

1604 iàĞ(*
p
) > 39 ) {

1605 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1606 
¡21
;

1607 } iàĞ(*
p
) >= 35 )

1608 
¡21
;

1609 } iàĞ(*
p
) > 46 ) {

1610 iàĞ(*
p
) < 65 ) {

1611 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1612 
¡21
;

1613 } iàĞ(*
p
) > 90 ) {

1614 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1615 
¡21
;

1617 
¡21
;

1619 
¡21
;

1620 
¡0
;

1621 
¡55
:

1622 iàĞ++
p
 =ğ
³
 )

1623 
_‹¡_eof55
;

1625  (*
p
) ) {

1626 33: 
¡21
;

1627 58: 
Œ39
;

1628 79: 
¡56
;

1629 111: 
¡56
;

1630 124: 
¡21
;

1631 126: 
¡21
;

1633 iàĞ(*
p
) < 45 ) {

1634 iàĞ(*
p
) > 39 ) {

1635 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1636 
¡21
;

1637 } iàĞ(*
p
) >= 35 )

1638 
¡21
;

1639 } iàĞ(*
p
) > 46 ) {

1640 iàĞ(*
p
) < 65 ) {

1641 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1642 
¡21
;

1643 } iàĞ(*
p
) > 90 ) {

1644 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1645 
¡21
;

1647 
¡21
;

1649 
¡21
;

1650 
¡0
;

1651 
¡56
:

1652 iàĞ++
p
 =ğ
³
 )

1653 
_‹¡_eof56
;

1655  (*
p
) ) {

1656 33: 
¡21
;

1657 58: 
Œ39
;

1658 68: 
¡57
;

1659 100: 
¡57
;

1660 124: 
¡21
;

1661 126: 
¡21
;

1663 iàĞ(*
p
) < 45 ) {

1664 iàĞ(*
p
) > 39 ) {

1665 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1666 
¡21
;

1667 } iàĞ(*
p
) >= 35 )

1668 
¡21
;

1669 } iàĞ(*
p
) > 46 ) {

1670 iàĞ(*
p
) < 65 ) {

1671 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1672 
¡21
;

1673 } iàĞ(*
p
) > 90 ) {

1674 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1675 
¡21
;

1677 
¡21
;

1679 
¡21
;

1680 
¡0
;

1681 
¡57
:

1682 iàĞ++
p
 =ğ
³
 )

1683 
_‹¡_eof57
;

1685  (*
p
) ) {

1686 33: 
¡21
;

1687 58: 
Œ39
;

1688 73: 
¡58
;

1689 105: 
¡58
;

1690 124: 
¡21
;

1691 126: 
¡21
;

1693 iàĞ(*
p
) < 45 ) {

1694 iàĞ(*
p
) > 39 ) {

1695 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1696 
¡21
;

1697 } iàĞ(*
p
) >= 35 )

1698 
¡21
;

1699 } iàĞ(*
p
) > 46 ) {

1700 iàĞ(*
p
) < 65 ) {

1701 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1702 
¡21
;

1703 } iàĞ(*
p
) > 90 ) {

1704 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1705 
¡21
;

1707 
¡21
;

1709 
¡21
;

1710 
¡0
;

1711 
¡58
:

1712 iàĞ++
p
 =ğ
³
 )

1713 
_‹¡_eof58
;

1715  (*
p
) ) {

1716 33: 
¡21
;

1717 58: 
Œ39
;

1718 78: 
¡59
;

1719 110: 
¡59
;

1720 124: 
¡21
;

1721 126: 
¡21
;

1723 iàĞ(*
p
) < 45 ) {

1724 iàĞ(*
p
) > 39 ) {

1725 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1726 
¡21
;

1727 } iàĞ(*
p
) >= 35 )

1728 
¡21
;

1729 } iàĞ(*
p
) > 46 ) {

1730 iàĞ(*
p
) < 65 ) {

1731 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1732 
¡21
;

1733 } iàĞ(*
p
) > 90 ) {

1734 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1735 
¡21
;

1737 
¡21
;

1739 
¡21
;

1740 
¡0
;

1741 
¡59
:

1742 iàĞ++
p
 =ğ
³
 )

1743 
_‹¡_eof59
;

1745  (*
p
) ) {

1746 33: 
¡21
;

1747 58: 
Œ39
;

1748 71: 
¡60
;

1749 103: 
¡60
;

1750 124: 
¡21
;

1751 126: 
¡21
;

1753 iàĞ(*
p
) < 45 ) {

1754 iàĞ(*
p
) > 39 ) {

1755 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1756 
¡21
;

1757 } iàĞ(*
p
) >= 35 )

1758 
¡21
;

1759 } iàĞ(*
p
) > 46 ) {

1760 iàĞ(*
p
) < 65 ) {

1761 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1762 
¡21
;

1763 } iàĞ(*
p
) > 90 ) {

1764 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1765 
¡21
;

1767 
¡21
;

1769 
¡21
;

1770 
¡0
;

1771 
¡60
:

1772 iàĞ++
p
 =ğ
³
 )

1773 
_‹¡_eof60
;

1775  (*
p
) ) {

1776 33: 
¡21
;

1777 58: 
Œ95
;

1778 124: 
¡21
;

1779 126: 
¡21
;

1781 iàĞ(*
p
) < 45 ) {

1782 iàĞ(*
p
) > 39 ) {

1783 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1784 
¡21
;

1785 } iàĞ(*
p
) >= 35 )

1786 
¡21
;

1787 } iàĞ(*
p
) > 46 ) {

1788 iàĞ(*
p
) < 65 ) {

1789 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1790 
¡21
;

1791 } iàĞ(*
p
) > 90 ) {

1792 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1793 
¡21
;

1795 
¡21
;

1797 
¡21
;

1798 
¡0
;

1799 
Œ96
:

1801 { 
	`MARK
(
m¬k
, 
p
); }

1802 
¡61
;

1803 
Œ95
:

1806 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

1808 
¡61
;

1809 
¡61
:

1810 iàĞ++
p
 =ğ
³
 )

1811 
_‹¡_eof61
;

1814  (*
p
) ) {

1815 10: 
Œ97
;

1816 13: 
Œ98
;

1817 32: 
Œ96
;

1818 67: 
Œ99
;

1819 99: 
Œ99
;

1821 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1822 
Œ96
;

1823 
Œ40
;

1824 
Œ97
:

1826 { 
	`MARK
(
m¬k
, 
p
); }

1829 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1830 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1833 
¡62
;

1834 
¡62
:

1835 iàĞ++
p
 =ğ
³
 )

1836 
_‹¡_eof62
;

1839  (*
p
) ) {

1840 10: 
Œ101
;

1841 13: 
¡72
;

1842 32: 
¡63
;

1843 33: 
Œ35
;

1844 67: 
Œ103
;

1845 84: 
Œ37
;

1846 99: 
Œ103
;

1847 116: 
Œ37
;

1848 124: 
Œ35
;

1849 126: 
Œ35
;

1851 iàĞ(*
p
) < 45 ) {

1852 iàĞ(*
p
) < 35 ) {

1853 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1854 
¡63
;

1855 } iàĞ(*
p
) > 39 ) {

1856 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1857 
Œ35
;

1859 
Œ35
;

1860 } iàĞ(*
p
) > 46 ) {

1861 iàĞ(*
p
) < 65 ) {

1862 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1863 
Œ35
;

1864 } iàĞ(*
p
) > 90 ) {

1865 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1866 
Œ35
;

1868 
Œ35
;

1870 
Œ35
;

1871 
¡0
;

1872 
¡63
:

1873 iàĞ++
p
 =ğ
³
 )

1874 
_‹¡_eof63
;

1876  (*
p
) ) {

1877 32: 
¡63
;

1878 67: 
Œ104
;

1879 99: 
Œ104
;

1881 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1882 
¡63
;

1883 
¡0
;

1884 
Œ104
:

1886 { 
	`MARK
(
m¬k
, 
p
); }

1887 
¡64
;

1888 
¡64
:

1889 iàĞ++
p
 =ğ
³
 )

1890 
_‹¡_eof64
;

1893  (*
p
) ) {

1894 72: 
¡65
;

1895 104: 
¡65
;

1897 
¡0
;

1898 
¡65
:

1899 iàĞ++
p
 =ğ
³
 )

1900 
_‹¡_eof65
;

1902  (*
p
) ) {

1903 85: 
¡66
;

1904 117: 
¡66
;

1906 
¡0
;

1907 
¡66
:

1908 iàĞ++
p
 =ğ
³
 )

1909 
_‹¡_eof66
;

1911  (*
p
) ) {

1912 78: 
¡67
;

1913 110: 
¡67
;

1915 
¡0
;

1916 
¡67
:

1917 iàĞ++
p
 =ğ
³
 )

1918 
_‹¡_eof67
;

1920  (*
p
) ) {

1921 75: 
¡68
;

1922 107: 
¡68
;

1924 
¡0
;

1925 
¡68
:

1926 iàĞ++
p
 =ğ
³
 )

1927 
_‹¡_eof68
;

1929  (*
p
) ) {

1930 69: 
¡69
;

1931 101: 
¡69
;

1933 
¡0
;

1934 
¡69
:

1935 iàĞ++
p
 =ğ
³
 )

1936 
_‹¡_eof69
;

1938  (*
p
) ) {

1939 68: 
¡70
;

1940 100: 
¡70
;

1942 
¡0
;

1943 
¡70
:

1944 iàĞ++
p
 =ğ
³
 )

1945 
_‹¡_eof70
;

1947  (*
p
) ) {

1948 10: 
Œ111
;

1949 13: 
Œ112
;

1951 
¡0
;

1952 
Œ112
:

1955 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1956 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1959 
¡71
;

1960 
¡71
:

1961 iàĞ++
p
 =ğ
³
 )

1962 
_‹¡_eof71
;

1965 iàĞ(*
p
) == 10 )

1966 
Œ113
;

1967 
¡0
;

1968 
Œ101
:

1971 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

1972 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

1973 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

1974 {
p
++; 
cs
 = 121; 
_out
;}

1976 
¡121
;

1977 
¡121
:

1978 iàĞ++
p
 =ğ
³
 )

1979 
_‹¡_eof121
;

1982  (*
p
) ) {

1983 32: 
¡63
;

1984 67: 
Œ104
;

1985 99: 
Œ104
;

1987 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1988 
¡63
;

1989 
¡0
;

1990 
¡72
:

1991 iàĞ++
p
 =ğ
³
 )

1992 
_‹¡_eof72
;

1994  (*
p
) ) {

1995 10: 
Œ101
;

1996 32: 
¡63
;

1997 67: 
Œ104
;

1998 99: 
Œ104
;

2000 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2001 
¡63
;

2002 
¡0
;

2003 
Œ103
:

2005 { 
	`MARK
(
m¬k
, 
p
); }

2007 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

2008 
¡73
;

2009 
¡73
:

2010 iàĞ++
p
 =ğ
³
 )

2011 
_‹¡_eof73
;

2014  (*
p
) ) {

2015 33: 
¡21
;

2016 58: 
Œ39
;

2017 72: 
¡74
;

2018 79: 
¡26
;

2019 104: 
¡74
;

2020 111: 
¡26
;

2021 124: 
¡21
;

2022 126: 
¡21
;

2024 iàĞ(*
p
) < 45 ) {

2025 iàĞ(*
p
) > 39 ) {

2026 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2027 
¡21
;

2028 } iàĞ(*
p
) >= 35 )

2029 
¡21
;

2030 } iàĞ(*
p
) > 46 ) {

2031 iàĞ(*
p
) < 65 ) {

2032 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2033 
¡21
;

2034 } iàĞ(*
p
) > 90 ) {

2035 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2036 
¡21
;

2038 
¡21
;

2040 
¡21
;

2041 
¡0
;

2042 
¡74
:

2043 iàĞ++
p
 =ğ
³
 )

2044 
_‹¡_eof74
;

2046  (*
p
) ) {

2047 33: 
¡21
;

2048 58: 
Œ39
;

2049 85: 
¡75
;

2050 117: 
¡75
;

2051 124: 
¡21
;

2052 126: 
¡21
;

2054 iàĞ(*
p
) < 45 ) {

2055 iàĞ(*
p
) > 39 ) {

2056 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2057 
¡21
;

2058 } iàĞ(*
p
) >= 35 )

2059 
¡21
;

2060 } iàĞ(*
p
) > 46 ) {

2061 iàĞ(*
p
) < 65 ) {

2062 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2063 
¡21
;

2064 } iàĞ(*
p
) > 90 ) {

2065 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2066 
¡21
;

2068 
¡21
;

2070 
¡21
;

2071 
¡0
;

2072 
¡75
:

2073 iàĞ++
p
 =ğ
³
 )

2074 
_‹¡_eof75
;

2076  (*
p
) ) {

2077 33: 
¡21
;

2078 58: 
Œ39
;

2079 78: 
¡76
;

2080 110: 
¡76
;

2081 124: 
¡21
;

2082 126: 
¡21
;

2084 iàĞ(*
p
) < 45 ) {

2085 iàĞ(*
p
) > 39 ) {

2086 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2087 
¡21
;

2088 } iàĞ(*
p
) >= 35 )

2089 
¡21
;

2090 } iàĞ(*
p
) > 46 ) {

2091 iàĞ(*
p
) < 65 ) {

2092 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2093 
¡21
;

2094 } iàĞ(*
p
) > 90 ) {

2095 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2096 
¡21
;

2098 
¡21
;

2100 
¡21
;

2101 
¡0
;

2102 
¡76
:

2103 iàĞ++
p
 =ğ
³
 )

2104 
_‹¡_eof76
;

2106  (*
p
) ) {

2107 33: 
¡21
;

2108 58: 
Œ39
;

2109 75: 
¡77
;

2110 107: 
¡77
;

2111 124: 
¡21
;

2112 126: 
¡21
;

2114 iàĞ(*
p
) < 45 ) {

2115 iàĞ(*
p
) > 39 ) {

2116 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2117 
¡21
;

2118 } iàĞ(*
p
) >= 35 )

2119 
¡21
;

2120 } iàĞ(*
p
) > 46 ) {

2121 iàĞ(*
p
) < 65 ) {

2122 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2123 
¡21
;

2124 } iàĞ(*
p
) > 90 ) {

2125 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2126 
¡21
;

2128 
¡21
;

2130 
¡21
;

2131 
¡0
;

2132 
¡77
:

2133 iàĞ++
p
 =ğ
³
 )

2134 
_‹¡_eof77
;

2136  (*
p
) ) {

2137 33: 
¡21
;

2138 58: 
Œ39
;

2139 69: 
¡78
;

2140 101: 
¡78
;

2141 124: 
¡21
;

2142 126: 
¡21
;

2144 iàĞ(*
p
) < 45 ) {

2145 iàĞ(*
p
) > 39 ) {

2146 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2147 
¡21
;

2148 } iàĞ(*
p
) >= 35 )

2149 
¡21
;

2150 } iàĞ(*
p
) > 46 ) {

2151 iàĞ(*
p
) < 65 ) {

2152 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2153 
¡21
;

2154 } iàĞ(*
p
) > 90 ) {

2155 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2156 
¡21
;

2158 
¡21
;

2160 
¡21
;

2161 
¡0
;

2162 
¡78
:

2163 iàĞ++
p
 =ğ
³
 )

2164 
_‹¡_eof78
;

2166  (*
p
) ) {

2167 33: 
¡21
;

2168 58: 
Œ39
;

2169 68: 
¡79
;

2170 100: 
¡79
;

2171 124: 
¡21
;

2172 126: 
¡21
;

2174 iàĞ(*
p
) < 45 ) {

2175 iàĞ(*
p
) > 39 ) {

2176 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2177 
¡21
;

2178 } iàĞ(*
p
) >= 35 )

2179 
¡21
;

2180 } iàĞ(*
p
) > 46 ) {

2181 iàĞ(*
p
) < 65 ) {

2182 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2183 
¡21
;

2184 } iàĞ(*
p
) > 90 ) {

2185 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2186 
¡21
;

2188 
¡21
;

2190 
¡21
;

2191 
¡0
;

2192 
¡79
:

2193 iàĞ++
p
 =ğ
³
 )

2194 
_‹¡_eof79
;

2196  (*
p
) ) {

2197 10: 
Œ111
;

2198 13: 
Œ112
;

2199 33: 
¡21
;

2200 58: 
Œ39
;

2201 124: 
¡21
;

2202 126: 
¡21
;

2204 iàĞ(*
p
) < 45 ) {

2205 iàĞ(*
p
) > 39 ) {

2206 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2207 
¡21
;

2208 } iàĞ(*
p
) >= 35 )

2209 
¡21
;

2210 } iàĞ(*
p
) > 46 ) {

2211 iàĞ(*
p
) < 65 ) {

2212 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2213 
¡21
;

2214 } iàĞ(*
p
) > 90 ) {

2215 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2216 
¡21
;

2218 
¡21
;

2220 
¡21
;

2221 
¡0
;

2222 
Œ98
:

2224 { 
	`MARK
(
m¬k
, 
p
); }

2227 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2228 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2231 
¡80
;

2232 
¡80
:

2233 iàĞ++
p
 =ğ
³
 )

2234 
_‹¡_eof80
;

2237  (*
p
) ) {

2238 10: 
¡62
;

2239 32: 
¡63
;

2240 67: 
Œ104
;

2241 99: 
Œ104
;

2243 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2244 
¡63
;

2245 
¡0
;

2246 
Œ99
:

2248 { 
	`MARK
(
m¬k
, 
p
); }

2249 
¡81
;

2250 
¡81
:

2251 iàĞ++
p
 =ğ
³
 )

2252 
_‹¡_eof81
;

2255  (*
p
) ) {

2256 10: 
Œ45
;

2257 13: 
Œ46
;

2258 72: 
¡82
;

2259 104: 
¡82
;

2261 
¡23
;

2262 
¡82
:

2263 iàĞ++
p
 =ğ
³
 )

2264 
_‹¡_eof82
;

2266  (*
p
) ) {

2267 10: 
Œ45
;

2268 13: 
Œ46
;

2269 85: 
¡83
;

2270 117: 
¡83
;

2272 
¡23
;

2273 
¡83
:

2274 iàĞ++
p
 =ğ
³
 )

2275 
_‹¡_eof83
;

2277  (*
p
) ) {

2278 10: 
Œ45
;

2279 13: 
Œ46
;

2280 78: 
¡84
;

2281 110: 
¡84
;

2283 
¡23
;

2284 
¡84
:

2285 iàĞ++
p
 =ğ
³
 )

2286 
_‹¡_eof84
;

2288  (*
p
) ) {

2289 10: 
Œ45
;

2290 13: 
Œ46
;

2291 75: 
¡85
;

2292 107: 
¡85
;

2294 
¡23
;

2295 
¡85
:

2296 iàĞ++
p
 =ğ
³
 )

2297 
_‹¡_eof85
;

2299  (*
p
) ) {

2300 10: 
Œ45
;

2301 13: 
Œ46
;

2302 69: 
¡86
;

2303 101: 
¡86
;

2305 
¡23
;

2306 
¡86
:

2307 iàĞ++
p
 =ğ
³
 )

2308 
_‹¡_eof86
;

2310  (*
p
) ) {

2311 10: 
Œ45
;

2312 13: 
Œ46
;

2313 68: 
¡87
;

2314 100: 
¡87
;

2316 
¡23
;

2317 
¡87
:

2318 iàĞ++
p
 =ğ
³
 )

2319 
_‹¡_eof87
;

2321  (*
p
) ) {

2322 10: 
Œ111
;

2323 13: 
Œ112
;

2325 
¡23
;

2326 
Œ137
:

2329 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2330 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2333 
¡88
;

2334 
¡88
:

2335 iàĞ++
p
 =ğ
³
 )

2336 
_‹¡_eof88
;

2339 iàĞ(*
p
) == 10 )

2340 
¡43
;

2341 
¡0
;

2342 
Œ64
:

2345 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

2346 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

2347 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

2348 {
p
++; 
cs
 = 122; 
_out
;}

2350 
¡122
;

2351 
¡122
:

2352 iàĞ++
p
 =ğ
³
 )

2353 
_‹¡_eof122
;

2356  (*
p
) ) {

2357 32: 
¡37
;

2358 67: 
¡38
;

2359 99: 
¡38
;

2361 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2362 
¡37
;

2363 
¡0
;

2364 
¡89
:

2365 iàĞ++
p
 =ğ
³
 )

2366 
_‹¡_eof89
;

2368  (*
p
) ) {

2369 10: 
Œ64
;

2370 32: 
¡37
;

2371 67: 
¡38
;

2372 99: 
¡38
;

2374 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2375 
¡37
;

2376 
¡0
;

2377 
Œ66
:

2379 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

2380 
¡90
;

2381 
¡90
:

2382 iàĞ++
p
 =ğ
³
 )

2383 
_‹¡_eof90
;

2386  (*
p
) ) {

2387 33: 
¡21
;

2388 58: 
Œ39
;

2389 76: 
¡91
;

2390 79: 
¡26
;

2391 108: 
¡91
;

2392 111: 
¡26
;

2393 124: 
¡21
;

2394 126: 
¡21
;

2396 iàĞ(*
p
) < 45 ) {

2397 iàĞ(*
p
) > 39 ) {

2398 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2399 
¡21
;

2400 } iàĞ(*
p
) >= 35 )

2401 
¡21
;

2402 } iàĞ(*
p
) > 46 ) {

2403 iàĞ(*
p
) < 65 ) {

2404 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2405 
¡21
;

2406 } iàĞ(*
p
) > 90 ) {

2407 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2408 
¡21
;

2410 
¡21
;

2412 
¡21
;

2413 
¡0
;

2414 
¡91
:

2415 iàĞ++
p
 =ğ
³
 )

2416 
_‹¡_eof91
;

2418  (*
p
) ) {

2419 33: 
¡21
;

2420 58: 
Œ39
;

2421 79: 
¡92
;

2422 111: 
¡92
;

2423 124: 
¡21
;

2424 126: 
¡21
;

2426 iàĞ(*
p
) < 45 ) {

2427 iàĞ(*
p
) > 39 ) {

2428 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2429 
¡21
;

2430 } iàĞ(*
p
) >= 35 )

2431 
¡21
;

2432 } iàĞ(*
p
) > 46 ) {

2433 iàĞ(*
p
) < 65 ) {

2434 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2435 
¡21
;

2436 } iàĞ(*
p
) > 90 ) {

2437 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2438 
¡21
;

2440 
¡21
;

2442 
¡21
;

2443 
¡0
;

2444 
¡92
:

2445 iàĞ++
p
 =ğ
³
 )

2446 
_‹¡_eof92
;

2448  (*
p
) ) {

2449 33: 
¡21
;

2450 58: 
Œ39
;

2451 83: 
¡93
;

2452 115: 
¡93
;

2453 124: 
¡21
;

2454 126: 
¡21
;

2456 iàĞ(*
p
) < 45 ) {

2457 iàĞ(*
p
) > 39 ) {

2458 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2459 
¡21
;

2460 } iàĞ(*
p
) >= 35 )

2461 
¡21
;

2462 } iàĞ(*
p
) > 46 ) {

2463 iàĞ(*
p
) < 65 ) {

2464 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2465 
¡21
;

2466 } iàĞ(*
p
) > 90 ) {

2467 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2468 
¡21
;

2470 
¡21
;

2472 
¡21
;

2473 
¡0
;

2474 
¡93
:

2475 iàĞ++
p
 =ğ
³
 )

2476 
_‹¡_eof93
;

2478  (*
p
) ) {

2479 33: 
¡21
;

2480 58: 
Œ39
;

2481 69: 
¡94
;

2482 101: 
¡94
;

2483 124: 
¡21
;

2484 126: 
¡21
;

2486 iàĞ(*
p
) < 45 ) {

2487 iàĞ(*
p
) > 39 ) {

2488 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2489 
¡21
;

2490 } iàĞ(*
p
) >= 35 )

2491 
¡21
;

2492 } iàĞ(*
p
) > 46 ) {

2493 iàĞ(*
p
) < 65 ) {

2494 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2495 
¡21
;

2496 } iàĞ(*
p
) > 90 ) {

2497 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2498 
¡21
;

2500 
¡21
;

2502 
¡21
;

2503 
¡0
;

2504 
¡94
:

2505 iàĞ++
p
 =ğ
³
 )

2506 
_‹¡_eof94
;

2508  (*
p
) ) {

2509 10: 
¡43
;

2510 13: 
¡88
;

2511 33: 
¡21
;

2512 58: 
Œ39
;

2513 124: 
¡21
;

2514 126: 
¡21
;

2516 iàĞ(*
p
) < 45 ) {

2517 iàĞ(*
p
) > 39 ) {

2518 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2519 
¡21
;

2520 } iàĞ(*
p
) >= 35 )

2521 
¡21
;

2522 } iàĞ(*
p
) > 46 ) {

2523 iàĞ(*
p
) < 65 ) {

2524 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2525 
¡21
;

2526 } iàĞ(*
p
) > 90 ) {

2527 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2528 
¡21
;

2530 
¡21
;

2532 
¡21
;

2533 
¡0
;

2534 
Œ61
:

2536 { 
	`MARK
(
m¬k
, 
p
); }

2539 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2540 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2543 
¡95
;

2544 
¡95
:

2545 iàĞ++
p
 =ğ
³
 )

2546 
_‹¡_eof95
;

2549  (*
p
) ) {

2550 10: 
¡36
;

2551 32: 
¡37
;

2552 67: 
¡38
;

2553 99: 
¡38
;

2555 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2556 
¡37
;

2557 
¡0
;

2558 
Œ62
:

2560 { 
	`MARK
(
m¬k
, 
p
); }

2561 
¡96
;

2562 
¡96
:

2563 iàĞ++
p
 =ğ
³
 )

2564 
_‹¡_eof96
;

2567  (*
p
) ) {

2568 10: 
Œ45
;

2569 13: 
Œ46
;

2570 76: 
¡97
;

2571 108: 
¡97
;

2573 
¡23
;

2574 
¡97
:

2575 iàĞ++
p
 =ğ
³
 )

2576 
_‹¡_eof97
;

2578  (*
p
) ) {

2579 10: 
Œ45
;

2580 13: 
Œ46
;

2581 79: 
¡98
;

2582 111: 
¡98
;

2584 
¡23
;

2585 
¡98
:

2586 iàĞ++
p
 =ğ
³
 )

2587 
_‹¡_eof98
;

2589  (*
p
) ) {

2590 10: 
Œ45
;

2591 13: 
Œ46
;

2592 83: 
¡99
;

2593 115: 
¡99
;

2595 
¡23
;

2596 
¡99
:

2597 iàĞ++
p
 =ğ
³
 )

2598 
_‹¡_eof99
;

2600  (*
p
) ) {

2601 10: 
Œ45
;

2602 13: 
Œ46
;

2603 69: 
¡100
;

2604 101: 
¡100
;

2606 
¡23
;

2607 
¡100
:

2608 iàĞ++
p
 =ğ
³
 )

2609 
_‹¡_eof100
;

2611  (*
p
) ) {

2612 10: 
Œ136
;

2613 13: 
Œ137
;

2615 
¡23
;

2616 
¡101
:

2617 iàĞ++
p
 =ğ
³
 )

2618 
_‹¡_eof101
;

2620  (*
p
) ) {

2621 33: 
¡21
;

2622 58: 
Œ39
;

2623 69: 
¡102
;

2624 101: 
¡102
;

2625 124: 
¡21
;

2626 126: 
¡21
;

2628 iàĞ(*
p
) < 45 ) {

2629 iàĞ(*
p
) > 39 ) {

2630 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2631 
¡21
;

2632 } iàĞ(*
p
) >= 35 )

2633 
¡21
;

2634 } iàĞ(*
p
) > 46 ) {

2635 iàĞ(*
p
) < 65 ) {

2636 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2637 
¡21
;

2638 } iàĞ(*
p
) > 90 ) {

2639 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2640 
¡21
;

2642 
¡21
;

2644 
¡21
;

2645 
¡0
;

2646 
¡102
:

2647 iàĞ++
p
 =ğ
³
 )

2648 
_‹¡_eof102
;

2650  (*
p
) ) {

2651 33: 
¡21
;

2652 58: 
Œ39
;

2653 78: 
¡103
;

2654 110: 
¡103
;

2655 124: 
¡21
;

2656 126: 
¡21
;

2658 iàĞ(*
p
) < 45 ) {

2659 iàĞ(*
p
) > 39 ) {

2660 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2661 
¡21
;

2662 } iàĞ(*
p
) >= 35 )

2663 
¡21
;

2664 } iàĞ(*
p
) > 46 ) {

2665 iàĞ(*
p
) < 65 ) {

2666 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2667 
¡21
;

2668 } iàĞ(*
p
) > 90 ) {

2669 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2670 
¡21
;

2672 
¡21
;

2674 
¡21
;

2675 
¡0
;

2676 
¡103
:

2677 iàĞ++
p
 =ğ
³
 )

2678 
_‹¡_eof103
;

2680  (*
p
) ) {

2681 33: 
¡21
;

2682 58: 
Œ39
;

2683 84: 
¡104
;

2684 116: 
¡104
;

2685 124: 
¡21
;

2686 126: 
¡21
;

2688 iàĞ(*
p
) < 45 ) {

2689 iàĞ(*
p
) > 39 ) {

2690 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2691 
¡21
;

2692 } iàĞ(*
p
) >= 35 )

2693 
¡21
;

2694 } iàĞ(*
p
) > 46 ) {

2695 iàĞ(*
p
) < 65 ) {

2696 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2697 
¡21
;

2698 } iàĞ(*
p
) > 90 ) {

2699 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2700 
¡21
;

2702 
¡21
;

2704 
¡21
;

2705 
¡0
;

2706 
¡104
:

2707 iàĞ++
p
 =ğ
³
 )

2708 
_‹¡_eof104
;

2710  (*
p
) ) {

2711 33: 
¡21
;

2712 45: 
¡105
;

2713 46: 
¡21
;

2714 58: 
Œ39
;

2715 124: 
¡21
;

2716 126: 
¡21
;

2718 iàĞ(*
p
) < 48 ) {

2719 iàĞ(*
p
) > 39 ) {

2720 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2721 
¡21
;

2722 } iàĞ(*
p
) >= 35 )

2723 
¡21
;

2724 } iàĞ(*
p
) > 57 ) {

2725 iàĞ(*
p
) > 90 ) {

2726 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2727 
¡21
;

2728 } iàĞ(*
p
) >= 65 )

2729 
¡21
;

2731 
¡21
;

2732 
¡0
;

2733 
¡105
:

2734 iàĞ++
p
 =ğ
³
 )

2735 
_‹¡_eof105
;

2737  (*
p
) ) {

2738 33: 
¡21
;

2739 58: 
Œ39
;

2740 76: 
¡106
;

2741 108: 
¡106
;

2742 124: 
¡21
;

2743 126: 
¡21
;

2745 iàĞ(*
p
) < 45 ) {

2746 iàĞ(*
p
) > 39 ) {

2747 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2748 
¡21
;

2749 } iàĞ(*
p
) >= 35 )

2750 
¡21
;

2751 } iàĞ(*
p
) > 46 ) {

2752 iàĞ(*
p
) < 65 ) {

2753 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2754 
¡21
;

2755 } iàĞ(*
p
) > 90 ) {

2756 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2757 
¡21
;

2759 
¡21
;

2761 
¡21
;

2762 
¡0
;

2763 
¡106
:

2764 iàĞ++
p
 =ğ
³
 )

2765 
_‹¡_eof106
;

2767  (*
p
) ) {

2768 33: 
¡21
;

2769 58: 
Œ39
;

2770 69: 
¡107
;

2771 101: 
¡107
;

2772 124: 
¡21
;

2773 126: 
¡21
;

2775 iàĞ(*
p
) < 45 ) {

2776 iàĞ(*
p
) > 39 ) {

2777 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2778 
¡21
;

2779 } iàĞ(*
p
) >= 35 )

2780 
¡21
;

2781 } iàĞ(*
p
) > 46 ) {

2782 iàĞ(*
p
) < 65 ) {

2783 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2784 
¡21
;

2785 } iàĞ(*
p
) > 90 ) {

2786 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2787 
¡21
;

2789 
¡21
;

2791 
¡21
;

2792 
¡0
;

2793 
¡107
:

2794 iàĞ++
p
 =ğ
³
 )

2795 
_‹¡_eof107
;

2797  (*
p
) ) {

2798 33: 
¡21
;

2799 58: 
Œ39
;

2800 78: 
¡108
;

2801 110: 
¡108
;

2802 124: 
¡21
;

2803 126: 
¡21
;

2805 iàĞ(*
p
) < 45 ) {

2806 iàĞ(*
p
) > 39 ) {

2807 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2808 
¡21
;

2809 } iàĞ(*
p
) >= 35 )

2810 
¡21
;

2811 } iàĞ(*
p
) > 46 ) {

2812 iàĞ(*
p
) < 65 ) {

2813 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2814 
¡21
;

2815 } iàĞ(*
p
) > 90 ) {

2816 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2817 
¡21
;

2819 
¡21
;

2821 
¡21
;

2822 
¡0
;

2823 
¡108
:

2824 iàĞ++
p
 =ğ
³
 )

2825 
_‹¡_eof108
;

2827  (*
p
) ) {

2828 33: 
¡21
;

2829 58: 
Œ39
;

2830 71: 
¡109
;

2831 103: 
¡109
;

2832 124: 
¡21
;

2833 126: 
¡21
;

2835 iàĞ(*
p
) < 45 ) {

2836 iàĞ(*
p
) > 39 ) {

2837 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2838 
¡21
;

2839 } iàĞ(*
p
) >= 35 )

2840 
¡21
;

2841 } iàĞ(*
p
) > 46 ) {

2842 iàĞ(*
p
) < 65 ) {

2843 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2844 
¡21
;

2845 } iàĞ(*
p
) > 90 ) {

2846 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2847 
¡21
;

2849 
¡21
;

2851 
¡21
;

2852 
¡0
;

2853 
¡109
:

2854 iàĞ++
p
 =ğ
³
 )

2855 
_‹¡_eof109
;

2857  (*
p
) ) {

2858 33: 
¡21
;

2859 58: 
Œ39
;

2860 84: 
¡110
;

2861 116: 
¡110
;

2862 124: 
¡21
;

2863 126: 
¡21
;

2865 iàĞ(*
p
) < 45 ) {

2866 iàĞ(*
p
) > 39 ) {

2867 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2868 
¡21
;

2869 } iàĞ(*
p
) >= 35 )

2870 
¡21
;

2871 } iàĞ(*
p
) > 46 ) {

2872 iàĞ(*
p
) < 65 ) {

2873 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2874 
¡21
;

2875 } iàĞ(*
p
) > 90 ) {

2876 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2877 
¡21
;

2879 
¡21
;

2881 
¡21
;

2882 
¡0
;

2883 
¡110
:

2884 iàĞ++
p
 =ğ
³
 )

2885 
_‹¡_eof110
;

2887  (*
p
) ) {

2888 33: 
¡21
;

2889 58: 
Œ39
;

2890 72: 
¡111
;

2891 104: 
¡111
;

2892 124: 
¡21
;

2893 126: 
¡21
;

2895 iàĞ(*
p
) < 45 ) {

2896 iàĞ(*
p
) > 39 ) {

2897 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2898 
¡21
;

2899 } iàĞ(*
p
) >= 35 )

2900 
¡21
;

2901 } iàĞ(*
p
) > 46 ) {

2902 iàĞ(*
p
) < 65 ) {

2903 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2904 
¡21
;

2905 } iàĞ(*
p
) > 90 ) {

2906 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2907 
¡21
;

2909 
¡21
;

2911 
¡21
;

2912 
¡0
;

2913 
¡111
:

2914 iàĞ++
p
 =ğ
³
 )

2915 
_‹¡_eof111
;

2917  (*
p
) ) {

2918 33: 
¡21
;

2919 58: 
Œ148
;

2920 124: 
¡21
;

2921 126: 
¡21
;

2923 iàĞ(*
p
) < 45 ) {

2924 iàĞ(*
p
) > 39 ) {

2925 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2926 
¡21
;

2927 } iàĞ(*
p
) >= 35 )

2928 
¡21
;

2929 } iàĞ(*
p
) > 46 ) {

2930 iàĞ(*
p
) < 65 ) {

2931 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2932 
¡21
;

2933 } iàĞ(*
p
) > 90 ) {

2934 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2935 
¡21
;

2937 
¡21
;

2939 
¡21
;

2940 
¡0
;

2941 
Œ149
:

2943 { 
	`MARK
(
m¬k
, 
p
); }

2944 
¡112
;

2945 
Œ148
:

2948 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

2950 
¡112
;

2951 
¡112
:

2952 iàĞ++
p
 =ğ
³
 )

2953 
_‹¡_eof112
;

2956  (*
p
) ) {

2957 10: 
Œ150
;

2958 13: 
Œ151
;

2959 32: 
Œ149
;

2961 iàĞ(*
p
) > 12 ) {

2962 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2963 
Œ152
;

2964 } iàĞ(*
p
) >= 9 )

2965 
Œ149
;

2966 
Œ40
;

2967 
Œ150
:

2969 { 
	`MARK
(
m¬k
, 
p
); }

2972 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2973 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2976 
¡113
;

2977 
¡113
:

2978 iàĞ++
p
 =ğ
³
 )

2979 
_‹¡_eof113
;

2982  (*
p
) ) {

2983 10: 
Œ154
;

2984 13: 
¡116
;

2985 32: 
¡114
;

2986 33: 
Œ35
;

2987 67: 
Œ36
;

2988 84: 
Œ37
;

2989 99: 
Œ36
;

2990 116: 
Œ37
;

2991 124: 
Œ35
;

2992 126: 
Œ35
;

2994 iàĞ(*
p
) < 45 ) {

2995 iàĞ(*
p
) < 35 ) {

2996 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

2997 
¡114
;

2998 } iàĞ(*
p
) > 39 ) {

2999 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

3000 
Œ35
;

3002 
Œ35
;

3003 } iàĞ(*
p
) > 46 ) {

3004 iàĞ(*
p
) < 65 ) {

3005 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3006 
Œ156
;

3007 } iàĞ(*
p
) > 90 ) {

3008 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

3009 
Œ35
;

3011 
Œ35
;

3013 
Œ35
;

3014 
¡0
;

3015 
¡114
:

3016 iàĞ++
p
 =ğ
³
 )

3017 
_‹¡_eof114
;

3019 iàĞ(*
p
) == 32 )

3020 
¡114
;

3021 iàĞ(*
p
) > 13 ) {

3022 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3023 
Œ157
;

3024 } iàĞ(*
p
) >= 9 )

3025 
¡114
;

3026 
¡0
;

3027 
Œ157
:

3029 { 
	`MARK
(
m¬k
, 
p
); }

3030 
¡115
;

3031 
¡115
:

3032 iàĞ++
p
 =ğ
³
 )

3033 
_‹¡_eof115
;

3036  (*
p
) ) {

3037 10: 
Œ158
;

3038 13: 
Œ159
;

3040 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3041 
¡115
;

3042 
¡0
;

3043 
Œ154
:

3046 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

3047 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

3048 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

3049 {
p
++; 
cs
 = 123; 
_out
;}

3051 
¡123
;

3052 
¡123
:

3053 iàĞ++
p
 =ğ
³
 )

3054 
_‹¡_eof123
;

3057 iàĞ(*
p
) == 32 )

3058 
¡114
;

3059 iàĞ(*
p
) > 13 ) {

3060 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3061 
Œ157
;

3062 } iàĞ(*
p
) >= 9 )

3063 
¡114
;

3064 
¡0
;

3065 
¡116
:

3066 iàĞ++
p
 =ğ
³
 )

3067 
_‹¡_eof116
;

3069  (*
p
) ) {

3070 10: 
Œ154
;

3071 32: 
¡114
;

3073 iàĞ(*
p
) > 13 ) {

3074 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3075 
Œ157
;

3076 } iàĞ(*
p
) >= 9 )

3077 
¡114
;

3078 
¡0
;

3079 
Œ156
:

3081 { 
	`MARK
(
m¬k
, 
p
); }

3083 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

3084 
¡117
;

3085 
¡117
:

3086 iàĞ++
p
 =ğ
³
 )

3087 
_‹¡_eof117
;

3090  (*
p
) ) {

3091 10: 
Œ158
;

3092 13: 
Œ159
;

3093 33: 
¡21
;

3094 58: 
Œ39
;

3095 124: 
¡21
;

3096 126: 
¡21
;

3098 iàĞ(*
p
) < 45 ) {

3099 iàĞ(*
p
) > 39 ) {

3100 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

3101 
¡21
;

3102 } iàĞ(*
p
) >= 35 )

3103 
¡21
;

3104 } iàĞ(*
p
) > 46 ) {

3105 iàĞ(*
p
) < 65 ) {

3106 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3107 
¡117
;

3108 } iàĞ(*
p
) > 90 ) {

3109 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

3110 
¡21
;

3112 
¡21
;

3114 
¡21
;

3115 
¡0
;

3116 
Œ151
:

3118 { 
	`MARK
(
m¬k
, 
p
); }

3121 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

3122 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

3125 
¡118
;

3126 
¡118
:

3127 iàĞ++
p
 =ğ
³
 )

3128 
_‹¡_eof118
;

3131  (*
p
) ) {

3132 10: 
¡113
;

3133 32: 
¡114
;

3135 iàĞ(*
p
) > 13 ) {

3136 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3137 
Œ157
;

3138 } iàĞ(*
p
) >= 9 )

3139 
¡114
;

3140 
¡0
;

3141 
Œ152
:

3143 { 
	`MARK
(
m¬k
, 
p
); }

3144 
¡119
;

3145 
¡119
:

3146 iàĞ++
p
 =ğ
³
 )

3147 
_‹¡_eof119
;

3150  (*
p
) ) {

3151 10: 
Œ158
;

3152 13: 
Œ159
;

3154 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3155 
¡119
;

3156 
¡23
;

3158 
_‹¡_eof2
: 
cs
 = 2; 
_‹¡_eof
;

3159 
_‹¡_eof120
: 
cs
 = 120; 
_‹¡_eof
;

3160 
_‹¡_eof3
: 
cs
 = 3; 
_‹¡_eof
;

3161 
_‹¡_eof4
: 
cs
 = 4; 
_‹¡_eof
;

3162 
_‹¡_eof5
: 
cs
 = 5; 
_‹¡_eof
;

3163 
_‹¡_eof6
: 
cs
 = 6; 
_‹¡_eof
;

3164 
_‹¡_eof7
: 
cs
 = 7; 
_‹¡_eof
;

3165 
_‹¡_eof8
: 
cs
 = 8; 
_‹¡_eof
;

3166 
_‹¡_eof9
: 
cs
 = 9; 
_‹¡_eof
;

3167 
_‹¡_eof10
: 
cs
 = 10; 
_‹¡_eof
;

3168 
_‹¡_eof11
: 
cs
 = 11; 
_‹¡_eof
;

3169 
_‹¡_eof12
: 
cs
 = 12; 
_‹¡_eof
;

3170 
_‹¡_eof13
: 
cs
 = 13; 
_‹¡_eof
;

3171 
_‹¡_eof14
: 
cs
 = 14; 
_‹¡_eof
;

3172 
_‹¡_eof15
: 
cs
 = 15; 
_‹¡_eof
;

3173 
_‹¡_eof16
: 
cs
 = 16; 
_‹¡_eof
;

3174 
_‹¡_eof17
: 
cs
 = 17; 
_‹¡_eof
;

3175 
_‹¡_eof18
: 
cs
 = 18; 
_‹¡_eof
;

3176 
_‹¡_eof19
: 
cs
 = 19; 
_‹¡_eof
;

3177 
_‹¡_eof20
: 
cs
 = 20; 
_‹¡_eof
;

3178 
_‹¡_eof21
: 
cs
 = 21; 
_‹¡_eof
;

3179 
_‹¡_eof22
: 
cs
 = 22; 
_‹¡_eof
;

3180 
_‹¡_eof23
: 
cs
 = 23; 
_‹¡_eof
;

3181 
_‹¡_eof24
: 
cs
 = 24; 
_‹¡_eof
;

3182 
_‹¡_eof25
: 
cs
 = 25; 
_‹¡_eof
;

3183 
_‹¡_eof26
: 
cs
 = 26; 
_‹¡_eof
;

3184 
_‹¡_eof27
: 
cs
 = 27; 
_‹¡_eof
;

3185 
_‹¡_eof28
: 
cs
 = 28; 
_‹¡_eof
;

3186 
_‹¡_eof29
: 
cs
 = 29; 
_‹¡_eof
;

3187 
_‹¡_eof30
: 
cs
 = 30; 
_‹¡_eof
;

3188 
_‹¡_eof31
: 
cs
 = 31; 
_‹¡_eof
;

3189 
_‹¡_eof32
: 
cs
 = 32; 
_‹¡_eof
;

3190 
_‹¡_eof33
: 
cs
 = 33; 
_‹¡_eof
;

3191 
_‹¡_eof34
: 
cs
 = 34; 
_‹¡_eof
;

3192 
_‹¡_eof35
: 
cs
 = 35; 
_‹¡_eof
;

3193 
_‹¡_eof36
: 
cs
 = 36; 
_‹¡_eof
;

3194 
_‹¡_eof37
: 
cs
 = 37; 
_‹¡_eof
;

3195 
_‹¡_eof38
: 
cs
 = 38; 
_‹¡_eof
;

3196 
_‹¡_eof39
: 
cs
 = 39; 
_‹¡_eof
;

3197 
_‹¡_eof40
: 
cs
 = 40; 
_‹¡_eof
;

3198 
_‹¡_eof41
: 
cs
 = 41; 
_‹¡_eof
;

3199 
_‹¡_eof42
: 
cs
 = 42; 
_‹¡_eof
;

3200 
_‹¡_eof43
: 
cs
 = 43; 
_‹¡_eof
;

3201 
_‹¡_eof44
: 
cs
 = 44; 
_‹¡_eof
;

3202 
_‹¡_eof45
: 
cs
 = 45; 
_‹¡_eof
;

3203 
_‹¡_eof46
: 
cs
 = 46; 
_‹¡_eof
;

3204 
_‹¡_eof47
: 
cs
 = 47; 
_‹¡_eof
;

3205 
_‹¡_eof48
: 
cs
 = 48; 
_‹¡_eof
;

3206 
_‹¡_eof49
: 
cs
 = 49; 
_‹¡_eof
;

3207 
_‹¡_eof50
: 
cs
 = 50; 
_‹¡_eof
;

3208 
_‹¡_eof51
: 
cs
 = 51; 
_‹¡_eof
;

3209 
_‹¡_eof52
: 
cs
 = 52; 
_‹¡_eof
;

3210 
_‹¡_eof53
: 
cs
 = 53; 
_‹¡_eof
;

3211 
_‹¡_eof54
: 
cs
 = 54; 
_‹¡_eof
;

3212 
_‹¡_eof55
: 
cs
 = 55; 
_‹¡_eof
;

3213 
_‹¡_eof56
: 
cs
 = 56; 
_‹¡_eof
;

3214 
_‹¡_eof57
: 
cs
 = 57; 
_‹¡_eof
;

3215 
_‹¡_eof58
: 
cs
 = 58; 
_‹¡_eof
;

3216 
_‹¡_eof59
: 
cs
 = 59; 
_‹¡_eof
;

3217 
_‹¡_eof60
: 
cs
 = 60; 
_‹¡_eof
;

3218 
_‹¡_eof61
: 
cs
 = 61; 
_‹¡_eof
;

3219 
_‹¡_eof62
: 
cs
 = 62; 
_‹¡_eof
;

3220 
_‹¡_eof63
: 
cs
 = 63; 
_‹¡_eof
;

3221 
_‹¡_eof64
: 
cs
 = 64; 
_‹¡_eof
;

3222 
_‹¡_eof65
: 
cs
 = 65; 
_‹¡_eof
;

3223 
_‹¡_eof66
: 
cs
 = 66; 
_‹¡_eof
;

3224 
_‹¡_eof67
: 
cs
 = 67; 
_‹¡_eof
;

3225 
_‹¡_eof68
: 
cs
 = 68; 
_‹¡_eof
;

3226 
_‹¡_eof69
: 
cs
 = 69; 
_‹¡_eof
;

3227 
_‹¡_eof70
: 
cs
 = 70; 
_‹¡_eof
;

3228 
_‹¡_eof71
: 
cs
 = 71; 
_‹¡_eof
;

3229 
_‹¡_eof121
: 
cs
 = 121; 
_‹¡_eof
;

3230 
_‹¡_eof72
: 
cs
 = 72; 
_‹¡_eof
;

3231 
_‹¡_eof73
: 
cs
 = 73; 
_‹¡_eof
;

3232 
_‹¡_eof74
: 
cs
 = 74; 
_‹¡_eof
;

3233 
_‹¡_eof75
: 
cs
 = 75; 
_‹¡_eof
;

3234 
_‹¡_eof76
: 
cs
 = 76; 
_‹¡_eof
;

3235 
_‹¡_eof77
: 
cs
 = 77; 
_‹¡_eof
;

3236 
_‹¡_eof78
: 
cs
 = 78; 
_‹¡_eof
;

3237 
_‹¡_eof79
: 
cs
 = 79; 
_‹¡_eof
;

3238 
_‹¡_eof80
: 
cs
 = 80; 
_‹¡_eof
;

3239 
_‹¡_eof81
: 
cs
 = 81; 
_‹¡_eof
;

3240 
_‹¡_eof82
: 
cs
 = 82; 
_‹¡_eof
;

3241 
_‹¡_eof83
: 
cs
 = 83; 
_‹¡_eof
;

3242 
_‹¡_eof84
: 
cs
 = 84; 
_‹¡_eof
;

3243 
_‹¡_eof85
: 
cs
 = 85; 
_‹¡_eof
;

3244 
_‹¡_eof86
: 
cs
 = 86; 
_‹¡_eof
;

3245 
_‹¡_eof87
: 
cs
 = 87; 
_‹¡_eof
;

3246 
_‹¡_eof88
: 
cs
 = 88; 
_‹¡_eof
;

3247 
_‹¡_eof122
: 
cs
 = 122; 
_‹¡_eof
;

3248 
_‹¡_eof89
: 
cs
 = 89; 
_‹¡_eof
;

3249 
_‹¡_eof90
: 
cs
 = 90; 
_‹¡_eof
;

3250 
_‹¡_eof91
: 
cs
 = 91; 
_‹¡_eof
;

3251 
_‹¡_eof92
: 
cs
 = 92; 
_‹¡_eof
;

3252 
_‹¡_eof93
: 
cs
 = 93; 
_‹¡_eof
;

3253 
_‹¡_eof94
: 
cs
 = 94; 
_‹¡_eof
;

3254 
_‹¡_eof95
: 
cs
 = 95; 
_‹¡_eof
;

3255 
_‹¡_eof96
: 
cs
 = 96; 
_‹¡_eof
;

3256 
_‹¡_eof97
: 
cs
 = 97; 
_‹¡_eof
;

3257 
_‹¡_eof98
: 
cs
 = 98; 
_‹¡_eof
;

3258 
_‹¡_eof99
: 
cs
 = 99; 
_‹¡_eof
;

3259 
_‹¡_eof100
: 
cs
 = 100; 
_‹¡_eof
;

3260 
_‹¡_eof101
: 
cs
 = 101; 
_‹¡_eof
;

3261 
_‹¡_eof102
: 
cs
 = 102; 
_‹¡_eof
;

3262 
_‹¡_eof103
: 
cs
 = 103; 
_‹¡_eof
;

3263 
_‹¡_eof104
: 
cs
 = 104; 
_‹¡_eof
;

3264 
_‹¡_eof105
: 
cs
 = 105; 
_‹¡_eof
;

3265 
_‹¡_eof106
: 
cs
 = 106; 
_‹¡_eof
;

3266 
_‹¡_eof107
: 
cs
 = 107; 
_‹¡_eof
;

3267 
_‹¡_eof108
: 
cs
 = 108; 
_‹¡_eof
;

3268 
_‹¡_eof109
: 
cs
 = 109; 
_‹¡_eof
;

3269 
_‹¡_eof110
: 
cs
 = 110; 
_‹¡_eof
;

3270 
_‹¡_eof111
: 
cs
 = 111; 
_‹¡_eof
;

3271 
_‹¡_eof112
: 
cs
 = 112; 
_‹¡_eof
;

3272 
_‹¡_eof113
: 
cs
 = 113; 
_‹¡_eof
;

3273 
_‹¡_eof114
: 
cs
 = 114; 
_‹¡_eof
;

3274 
_‹¡_eof115
: 
cs
 = 115; 
_‹¡_eof
;

3275 
_‹¡_eof123
: 
cs
 = 123; 
_‹¡_eof
;

3276 
_‹¡_eof116
: 
cs
 = 116; 
_‹¡_eof
;

3277 
_‹¡_eof117
: 
cs
 = 117; 
_‹¡_eof
;

3278 
_‹¡_eof118
: 
cs
 = 118; 
_‹¡_eof
;

3279 
_‹¡_eof119
: 
cs
 = 119; 
_‹¡_eof
;

3281 
_‹¡_eof
: {}

3282 
_out
: {}

3287 
·r£r
->
cs
 = cs;

3288 
·r£r
->
Ä—d
 +ğ
p
 - (
bufãr
 + 
off
);

3290 
	`as£¹
(
p
 <ğ
³
 && "buffer overflow‡fter…arsingƒxecute");

3291 
	`as£¹
(
·r£r
->
Ä—d
 <ğ
Ën
 && "nread†ongerhan†ength");

3292 
	`as£¹
(
·r£r
->
body_¡¬t
 <ğ
Ën
 && "body starts‡fter bufferƒnd");

3293 
	`check
(
·r£r
->
m¬k
 < 
Ën
, "mark is‡fter bufferƒnd");

3294 
	`check
(
·r£r
->
f›ld_Ën
 <ğ
Ën
, "field has†ength†ongerhan whole buffer");

3295 
	`check
(
·r£r
->
f›ld_¡¬t
 < 
Ën
, "field starts‡fter bufferƒnd");

3297 if(
·r£r
->
body_¡¬t
) {

3299 
·r£r
->
Ä—d
++;

3302 (
·r£r
->
Ä—d
);

3304 
”rÜ
:

3306 
	}
}

3308 
	$h‰pş›Á_·r£r_fšish
(
h‰pş›Á_·r£r
 *
·r£r
)

3310 
cs
 = 
·r£r
->cs;

3312 
·r£r
->
cs
 = cs;

3314 ià(
	`h‰pş›Á_·r£r_has_”rÜ
(
·r£r
) ) {

3316 } ià(
	`h‰pş›Á_·r£r_is_fšished
(
·r£r
) ) {

3321 
	}
}

3323 
	$h‰pş›Á_·r£r_has_”rÜ
(
h‰pş›Á_·r£r
 *
·r£r
) {

3324  
·r£r
->
cs
 =ğ
h‰pş›Á_·r£r_”rÜ
;

3325 
	}
}

3327 
	$h‰pş›Á_·r£r_is_fšished
(
h‰pş›Á_·r£r
 *
·r£r
) {

3328  
·r£r
->
cs
 =ğ
h‰pş›Á_·r£r_fœ¡_fš®
;

3329 
	}
}

	@src/http11/httpclient_parser.h

35 #iâdeà
h‰pş›Á_·r£r_h


36 
	#h‰pş›Á_·r£r_h


	)

38 
	~<h‰p11/h‰p11_commÚ.h
>

40 
	sh‰pş›Á_·r£r
 {

41 
	mcs
;

42 
size_t
 
	mbody_¡¬t
;

43 
	mcÚ‹Á_Ën
;

44 
	m¡©us
;

45 
	mchunked
;

46 
	mchunks_dÚe
;

47 
	mşo£
;

48 
size_t
 
	mÄ—d
;

49 
size_t
 
	mm¬k
;

50 
size_t
 
	mf›ld_¡¬t
;

51 
size_t
 
	mf›ld_Ën
;

53 *
	md©a
;

55 
f›ld_cb
 
	mh‰p_f›ld
;

56 
–em’t_cb
 
	m»asÚ_ph¿£
;

57 
–em’t_cb
 
	m¡©us_code
;

58 
–em’t_cb
 
	mchunk_size
;

59 
–em’t_cb
 
	mh‰p_v”siÚ
;

60 
–em’t_cb
 
	mh—d”_dÚe
;

61 
–em’t_cb
 
	mÏ¡_chunk
;

64 } 
	th‰pş›Á_·r£r
;

66 
h‰pş›Á_·r£r_š™
(
h‰pş›Á_·r£r
 *
·r£r
);

67 
h‰pş›Á_·r£r_fšish
(
h‰pş›Á_·r£r
 *
·r£r
);

68 
h‰pş›Á_·r£r_execu‹
(
h‰pş›Á_·r£r
 *
·r£r
, cÚ¡ *
d©a
, 
size_t
 
Ën
, size_ˆ
off
);

69 
h‰pş›Á_·r£r_has_”rÜ
(
h‰pş›Á_·r£r
 *
·r£r
);

70 
h‰pş›Á_·r£r_is_fšished
(
h‰pş›Á_·r£r
 *
·r£r
);

72 
	#h‰pş›Á_·r£r_Ä—d
(
·r£r
èÕ¬£r)->
Ä—d


	)

	@src/io.c

35 
	#_XOPEN_SOURCE
 500

	)

36 
	#_FILE_OFFSET_BITS
 64

	)

38 
	~"io.h
"

39 
	~"»gi¡”.h
"

40 
	~"mem/h®loc.h
"

41 
	~"dbg.h
"

42 
	~<¡dlib.h
>

43 
	~<as£¹.h
>

44 
	~<uni¡d.h
>

45 
	~<pŞ¬s¦/havege.h
>

46 
	~<pŞ¬s¦/s¦.h
>

47 
	~<sk/sk.h
>

49 
ssize_t
 
	$nuÎ_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

51  
Ën
;

52 
	}
}

54 
ssize_t
 
	$nuÎ_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

56  
Ën
;

57 
	}
}

59 
ssize_t
 
	$nuÎ_¡»am_fe
(
IOBuf
 *
iob
, 
fd
, 
off_t
 
Ën
)

61  
Ën
;

62 
	}
}

64 
ssize_t
 
	$¶aš‹xt_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

66  
	`fd£nd
(
iob
->
fd
, 
bufãr
, 
Ën
);

67 
	}
}

69 
ssize_t
 
	$¶aš‹xt_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

71  
	`fd»cv
(
iob
->
fd
, 
bufãr
, 
Ën
);

72 
	}
}

74 
ssize_t
 
	$fe_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

76  
	`fdwr™e
(
iob
->
fd
, 
bufãr
, 
Ën
);

77 
	}
}

79 
ssize_t
 
	$fe_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

81  
	`fd»ad
(
iob
->
fd
, 
bufãr
, 
Ën
);

82 
	}
}

84 
ssize_t
 
	$¶aš_¡»am_fe
(
IOBuf
 *
iob
, 
fd
, 
off_t
 
Ën
)

86 
off_t
 
£Á
 = 0;

87 
off_t
 
tÙ®
 = 0;

88 
off_t
 
off£t
 = 0;

89 
off_t
 
block_size
 = 
MAX_SEND_BUFFER
;

90 
cÚn_fd
 = 
	`IOBuf_fd
(
iob
);

92 
tÙ®
 = 0; 
	`fdwa™
(
cÚn_fd
, 'w'è=ğ0 &&Ù® < 
Ën
;Ù® +ğ
£Á
) {

94 
block_size
 = (
Ën
 - 
tÙ®
) > block_size ? block_size : (len -otal);

95 
£Á
 = 
	`IOBuf_£ndfe
(
cÚn_fd
, 
fd
, &
off£t
, 
block_size
);

97 
	`check
(
	`Regi¡”_wr™e
(
iob
->
fd
, 
£Á
) != -1, "Socket seemso be closed.");

99 
	`check_debug
(
£Á
 > 0, "Client closed…robably during sendfile on socket: %d from "

100 "f%d", 
cÚn_fd
, 
fd
);

103 
	`check
(
tÙ®
 <ğ
Ën
,

105 ()
tÙ®
, 
Ën
);

107 
	`check
(
tÙ®
 =ğ
Ën
,

109 ()
tÙ®
, 
Ën
);

111  
tÙ®
;

113 
”rÜ
:

115 
	}
}

117 
	$s¦_fd£nd_w¿µ”
(*
p_iob
, *
ubufãr
, 
Ën
)

119 
IOBuf
 *
iob
 = (IOBuà*è
p_iob
;

120  
	`fd£nd
(
iob
->
fd
, (*è
ubufãr
, 
Ën
);

121 
	}
}

123 
	$s¦_fd»cv_w¿µ”
(*
p_iob
, *
ubufãr
, 
Ën
)

125 
IOBuf
 *
iob
 = (IOBuà*è
p_iob
;

126  
	`fd»cv1
(
iob
->
fd
, (*è
ubufãr
, 
Ën
);

127 
	}
}

129 
	$s¦_do_hªdshake
(
IOBuf
 *
iob
)

131 
rcode
;

132 
	`check
(!
iob
->
hªdshake_³rfÜmed
, "ssl_do_handshake called unnecessarily");

133 (
rcode
 = 
	`s¦_hªdshake
(&
iob
->
s¦
)) != 0) {

134 
	`check
(
rcode
 =ğ
POLARSSL_ERR_NET_TRY_AGAIN
,

135 "hªdshakçed w™hƒ¼Ü cod%d", 
rcode
);

137 
iob
->
hªdshake_³rfÜmed
 = 1;

139 
”rÜ
:

141 
	}
}

143 
ssize_t
 
	$s¦_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

145 
ssize_t
 
£Á
 = 0;

147 
	`check
(
iob
->
u£_s¦
, "IOBuf‚ot set upo use ssl");

148 if(!
iob
->
hªdshake_³rfÜmed
) {

149 
rcode
 = 
	`s¦_do_hªdshake
(
iob
);

150 
	`check
(
rcode
 == 0, "handshake failed");

155 
£Á
 +ğ
	`s¦_wr™e
(&
iob
->
s¦
, (cÚ¡ *è(
bufãr
 + s’t), (
Ën
 - sent));

156 } 
£Á
 < 
Ën
);

158  
£Á
;

159 
”rÜ
:

161 
	}
}

163 
ssize_t
 
	$s¦_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

165 
	`check
(
iob
->
u£_s¦
, "IOBuf‚ot set upo use ssl");

166 if(!
iob
->
hªdshake_³rfÜmed
) {

167 
rcode
 = 
	`s¦_do_hªdshake
(
iob
);

168 
	`check
(
rcode
 == 0, "handshake failed");

170  
	`s¦_»ad
(&
iob
->
s¦
, (*è
bufãr
, 
Ën
);

171 
”rÜ
:

173 
	}
}

175 
ssize_t
 
	$s¦_¡»am_fe
(
IOBuf
 *
iob
, 
fd
, 
off_t
 
Ën
)

177 
ssize_t
 
£Á
 = 0;

178 
off_t
 
tÙ®
 = 0;

179 
ssize_t
 
amt
 = 0;

180 
ssize_t
 
to£nd
 = 0;

181 
cÚn_fd
 = 
	`IOBuf_fd
(
iob
);

182 
buff
[1024];

184 
tÙ®
 = 0; 
	`fdwa™
(
cÚn_fd
, 'w'è=ğ0 &&Ù® < 
Ën
;Ù® +ğ
to£nd
) {

185 
to£nd
 = 
	`´—d
(
fd
, 
buff
, (buff), 
tÙ®
);

186 
	`check_debug
(
to£nd
 > 0, "Camu°shÜˆš„—dšg f%d\n", 
fd
);

190 if(
to£nd
 + 
tÙ®
 > 
Ën
)

191 
to£nd
 = 
Ën
 - 
tÙ®
;

193 
£Á
 = 0;

194 
£Á
 < 
to£nd
) {

195 
amt
 = 
	`s¦_£nd
(
iob
, 
buff
, 
to£nd
);

196 
	`check_debug
(
amt
 > 0, "ssl_send failed in ssl_stream_file with "

197 "»tuº cod%zd", 
amt
);

198 
£Á
 +ğ
amt
;

201 
	`check
(
	`Regi¡”_wr™e
(
iob
->
fd
, 
£Á
) != -1, "Failedo„ecord write, must have died.");

204 
	`check
(
tÙ®
 <ğ
Ën
,

206 ()
tÙ®
, 
Ën
);

208 
	`check
(
tÙ®
 =ğ
Ën
,

210 ()
tÙ®
, 
Ën
);

212  
tÙ®
;

214 
”rÜ
:

216 
	}
}

218 
	$s¦_debug
(*
p
, 
Ëv–
, cÚ¡ *
msg
) {

219 if(
Ëv–
 < 2) {

220 
	`debug
("pŞ¬s¦: %s", 
msg
);

222 
	}
}

224 
IOBuf
 *
	$IOBuf_ü—‹
(
size_t
 
Ën
, 
fd
, 
IOBufTy³
 
ty³
)

226 
IOBuf
 *
buf
 = 
	`h_ÿÎoc
((IOBuf), 1);

227 
	`check_mem
(
buf
);

229 
buf
->
fd
 = fd;

230 
buf
->
Ën
 =†en;

232 
buf
->buàğ
	`h_m®loc
(
Ën
 + 1);

233 
	`check_mem
(
buf
->buf);

235 
	`h©ch
(
buf
->buf, buf);

237 
buf
->
ty³
 =ype;

239 if(
ty³
 =ğ
IOBUF_SSL
) {

240 
buf
->
u£_s¦
 = 1;

241 
buf
->
hªdshake_³rfÜmed
 = 0;

242 
	`s¦_š™
(&
buf
->
s¦
);

243 
	`s¦_£t_’dpošt
(&
buf
->
s¦
, 
SSL_IS_SERVER
);

244 
	`s¦_£t_authmode
(&
buf
->
s¦
, 
SSL_VERIFY_NONE
);

245 
	`havege_š™
(&
buf
->
hs
);

246 
	`s¦_£t_ºg
(&
buf
->
s¦
, 
havege_¿nd
, &buf->
hs
);

247 
	`s¦_£t_dbg
(&
buf
->
s¦
, 
s¦_debug
, 
NULL
);

248 
	`s¦_£t_bio
(&
buf
->
s¦
, 
s¦_fd»cv_w¿µ”
, buf,

249 
s¦_fd£nd_w¿µ”
, 
buf
);

250 
	`s¦_£t_£ssiÚ
(&
buf
->
s¦
, 1, 0, &buf->
s¢
);

251 
	`mem£t
(&
buf
->
s¢
, 0, (buf->ssn));

253 
buf
->
£nd
 = 
s¦_£nd
;

254 
buf
->
»cv
 = 
s¦_»cv
;

255 
buf
->
¡»am_fe
 = 
s¦_¡»am_fe
;

256 } if(
ty³
 =ğ
IOBUF_NULL
) {

257 
buf
->
£nd
 = 
nuÎ_£nd
;

258 
buf
->
»cv
 = 
nuÎ_»cv
;

259 
buf
->
¡»am_fe
 = 
nuÎ_¡»am_fe
;

260 } if(
ty³
 =ğ
IOBUF_FILE
) {

261 
buf
->
£nd
 = 
fe_£nd
;

262 
buf
->
»cv
 = 
fe_»cv
;

263 
buf
->
¡»am_fe
 = 
¶aš_¡»am_fe
;

264 } if(
ty³
 =ğ
IOBUF_SOCKET
) {

265 
buf
->
£nd
 = 
¶aš‹xt_£nd
;

266 
buf
->
»cv
 = 
¶aš‹xt_»cv
;

267 
buf
->
¡»am_fe
 = 
¶aš_¡»am_fe
;

269 
	`£Áš–
("Inv®id IOBufTy³ giv’: %d", 
ty³
);

272  
buf
;

274 
”rÜ
:

275 if(
buf
è
	`h_ä“
(buf);

276  
NULL
;

277 
	}
}

279 
	$IOBuf_de¡roy
(
IOBuf
 *
buf
)

281 if(
buf
) {

282 if(
buf
->
u£_s¦
) {

283 
	`s¦_şo£_nÙify
(&
buf
->
s¦
);

284 
	`s¦_ä“
(&
buf
->
s¦
);

287 
	`fdşo£
(
buf
->
fd
);

288 
	`h_ä“
(
buf
);

290 
	}
}

292 
	$IOBuf_»size
(
IOBuf
 *
buf
, 
size_t
 
Ãw_size
)

294 
buf
->buàğ
	`h_»®loc
(buf->buf, 
Ãw_size
);

295 
buf
->
Ën
 = 
Ãw_size
;

296 
	}
}

299 
šlše
 
	$IOBuf_com·ù
(
IOBuf
 *
buf
)

301 
	`memmove
(
buf
->buf, 
	`IOBuf_¡¬t
(buf), buf->
ava
);

302 
buf
->
cur
 = 0;

303 
	}
}

320 *
	$IOBuf_»ad
(
IOBuf
 *
buf
, 
Ãed
, *
out_Ën
)

322 
rc
 = 0;

323 
	`as£¹
(
buf
->
cur
 + buf->
ava
 <ğbuf->
Ën
 &&

325 
	`as£¹
(
buf
->
cur
 >= 0 && "Buffer cur can't be < 0");

326 
	`as£¹
(
buf
->
ava
 >= 0 && "Buffer‡vail can't be < 0");

327 
	`as£¹
(
Ãed
 <ğ
buf
->
Ën
 && "Request for morehan…ossible inhe buffer.");

329 if(
	`IOBuf_şo£d
(
buf
)) {

330 if(
buf
->
ava
 > 0) {

331 *
out_Ën
 = 
buf
->
ava
;

333 *
out_Ën
 = 0;

334  
NULL
;

336 } if(
buf
->
ava
 < 
Ãed
) {

337 if(
buf
->
cur
 > 0 && 
	`IOBuf_com·ù_Ãeded
(buf, 
Ãed
)) {

338 
	`IOBuf_com·ù
(
buf
);

340 
rc
 = 
buf
->
	`»cv
(buf, 
	`IOBuf_»ad_pošt
(buf), 
	`IOBuf_»maššg
(buf));

342 if(
rc
 <= 0) {

343 
	`debug
("Sock‘ wa şo£d, wÈ»tuº oÆy wh©' avaabË: %d", 
buf
->
ava
);

344 
buf
->
şo£d
 = 1;

346 
buf
->
ava
 = buf->ava + 
rc
;

349 if(
buf
->
ava
 < 
Ãed
) {

351 *
out_Ën
 = 
buf
->
ava
;

354 *
out_Ën
 = 
Ãed
;

356 } if(
buf
->
ava
 >ğ
Ãed
) {

357 *
out_Ën
 = 
Ãed
;

359 
	`£Áš–
("Invalid branch…rocessing buffer, Tell Zed.");

362  
	`IOBuf_¡¬t
(
buf
);

364 
”rÜ
:

365  
NULL
;

366 
	}
}

374 
	$IOBuf_»ad_comm™
(
IOBuf
 *
buf
, 
Ãed
)

376 
buf
->
ava
 -ğ
Ãed
;

377 
	`as£¹
(
buf
->
ava
 >= 0 && "Buffer commit„educed‡vailo < 0.");

379 
	`check
(
	`Regi¡”_»ad
(
buf
->
fd
, 
Ãed
) != -1, "Failedo„ecord„ead, must have died.");

381 
buf
->
m¬k
 = 0;

383 if(
buf
->
ava
 == 0) {

385 
buf
->
cur
 = 0;

387 
buf
->
cur
 +ğ
Ãed
;

391 
”rÜ
:

393 
	}
}

399 
	$IOBuf_£nd
(
IOBuf
 *
buf
, *
d©a
, 
Ën
)

401 
rc
 = 0;

403 
rc
 = 
buf
->
	`£nd
(buf, 
d©a
, 
Ën
);

405 if(
rc
 >= 0) {

406 
	`check
(
	`Regi¡”_wr™e
(
buf
->
fd
, 
rc
) != -1, "Failedo„ecord write, must have died.");

408 
buf
->
şo£d
 = 1;

411  
rc
;

413 
”rÜ
:

415 
	}
}

421 *
	$IOBuf_»ad_®l
(
IOBuf
 *
buf
, 
Ën
, 
»Œ›s
)

423 
Ä—d
 = 0;

424 
©‹m±s
 = 0;

426 
	`check_debug
(!
	`IOBuf_şo£d
(
buf
), "Closed when‡ttemptingo„ead from buffer.");

428 if(
Ën
 > 
buf
->len) {

430 
	`IOBuf_»size
(
buf
, 
Ën
);

433 *
d©a
 = 
	`IOBuf_»ad
(
buf
, 
Ën
, &
Ä—d
);

435 
	`debug
("INITIAL READ:†’: %d,‚»ad: %d", 
Ën
, 
Ä—d
);

436 
©‹m±s
 = 0; 
Ä—d
 < 
Ën
;‡ttempts++) {

437 
d©a
 = 
	`IOBuf_»ad
(
buf
, 
Ën
, &
Ä—d
);

439 
	`check_debug
(
d©a
, "Readƒrror from socket.");

440 
	`as£¹
(
Ä—d
 <ğ
Ën
 && "Invalid‚read size (too much) on IOBuf„ead.");

442 if(
Ä—d
 =ğ
Ën
) {

445 
	`fdwa™
(
buf
->
fd
, 'r');

449 
	`debug
("ATTEMPTS: %d, RETRIES: %d", 
©‹m±s
, 
»Œ›s
);

451 if(
©‹m±s
 > 
»Œ›s
) {

452 
	`log_w¬n
("R—d oà%d†’gth‡‰em±ed %dime which i ov” %d„‘ry†im™..", 
Ën
, 
©‹m±s
, 
»Œ›s
);

455 
	`check
(
	`IOBuf_»ad_comm™
(
buf
, 
Ën
) != -1, "Final commit failed of„ead_all.");

456  
d©a
;

458 
”rÜ
:

459 
buf
->
şo£d
 = 1;

460  
NULL
;

461 
	}
}

468 
	$IOBuf_¡»am
(
IOBuf
 *
äom
, IOBuà*
to
, 
tÙ®
)

470 
Ãed
 = 0;

471 
»maš
 = 
tÙ®
;

472 
ava
 = 0;

473 
rc
 = 0;

474 *
d©a
 = 
NULL
;

476 if(
äom
->
Ën
 > 
to
->Ënè
	`IOBuf_»size
(to, from->len);

478 
»maš
 > 0) {

479 
Ãed
 = 
»maš
 <ğ
äom
->
Ën
 ?„emain : from->len;

481 
d©a
 = 
	`IOBuf_»ad
(
äom
, 
Ãed
, &
ava
);

482 
	`check_debug
(
ava
 > 0, "Nothing in„ead buffer.");

484 
rc
 = 
	`IOBuf_£nd_®l
(
to
, 
	`IOBuf_¡¬t
(
äom
), 
ava
);

485 
	`check_debug
(
rc
 =ğ
ava
, "Failedo send‡ll ofhe data: %d of %d",„c,‡vail)

488 
	`check
(
	`IOBuf_»ad_comm™
(
äom
, 
rc
) != -1, "Final commit failed during streaming.");

491 
»maš
 -ğ
rc
;

494 
	`as£¹
(
»maš
 == 0 && "Buffer math is wrong.");

496  
tÙ®
 - 
»maš
;

498 
”rÜ
:

500 
	}
}

504 
	$IOBuf_£nd_®l
(
IOBuf
 *
buf
, *
d©a
, 
Ën
)

506 
rc
 = 0;

507 
tÙ®
 = 
Ën
;

510 
rc
 = 
	`IOBuf_£nd
(
buf
, 
d©a
, 
tÙ®
);

511 
	`check
(
rc
 > 0, "Writeƒrror when sending‡ll.");

512 
tÙ®
 -ğ
rc
;

513 } 
tÙ®
 > 0);

515 
	`as£¹
(
tÙ®
 == 0 && "Mathƒrror sending‡ll from buffer.");

517  
Ën
;

519 
”rÜ
:

521 
	}
}

523 
	$IOBuf_¡»am_fe
(
IOBuf
 *
buf
, 
fd
, 
off_t
 
Ën
)

525 
rc
 = 0;

530 
rc
 = 
buf
->
	`¡»am_fe
(buf, 
fd
, 
Ën
);

532 if(
rc
 < 0è
buf
->
şo£d
 = 1;

534  
rc
;

535 
	}
}

539 
	$debug_dump
(*
addr
, 
Ën
)

541 #ifdeà
NDEBUG


545 
tohex
[] = "0123456789ABCDEF";

546 
i
 = 0;

547 *
pc
 = 
addr
;

549 
buf0
[32] = {0};

550 
buf1
[64] = {0};

551 
buf2
[64] = {0};

553 *
pc1
 = 
NULL
;

554 *
pc2
 = 
NULL
;

558 --
Ën
 >= 0) {

560 if(
i
 % 16 == 0) {

561 
	`¥rštf
(
buf0
, "%08x", 
i
);

562 
buf1
[0] = 0;

563 
buf2
[0] = 0;

564 
pc1
 = 
buf1
;

565 
pc2
 = 
buf2
;

568 *
pc1
++ = 
tohex
[*
pc
 >> 4];

569 *
pc1
++ = 
tohex
[*
pc
 & 15];

570 *
pc1
++ = ' ';

572 if(*
pc
 >= 32 && *pc < 127) {

573 *
pc2
++ = *
pc
;

575 *
pc2
++ = '.';

578 
i
++;

579 
pc
++;

581 if(
i
 % 16 == 0) {

582 *
pc1
 = 0;

583 *
pc2
 = 0;

584 
	`debug
("%s: %  %s", 
buf0
, 
buf1
, 
buf2
);

589 if(
i
 % 16 != 0) {

590 
i
 % 16 != 0) {

591 *
pc1
++ = ' ';

592 *
pc1
++ = ' ';

593 *
pc1
++ = ' ';

594 *
pc2
++ = ' ';

595 
i
++;

598 *
pc1
 = 0;

599 *
pc2
 = 0;

600 
	`debug
("%s: %  %s", 
buf0
, 
buf1
, 
buf2
);

602 
	}
}

	@src/io.h

1 #iâdeà
_io_h


2 
	#_io_h


	)

4 #iâdeà
_FILE_OFFSET_BITS


5 
	#_FILE_OFFSET_BITS
 64

	)

8 
	~<¡dlib.h
>

9 
	~<pŞ¬s¦/x509.h
>

10 
	~<pŞ¬s¦/r§.h
>

11 
	~<pŞ¬s¦/s¦.h
>

12 
	~<pŞ¬s¦/havege.h
>

14 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

15 
	~"bsd_¥ecific.h
"

17 
	~<sys/£ndfe.h
>

20 
MAX_SEND_BUFFER
;

22 
	gIOBuf
;

24 
	$ssize_t
 (*
	tio_cb
)(
	tIOBuf
 *, *
	td©a
, 
	tËn
);

25 
	$ssize_t
 (*
	tio_¡»am_fe_cb
)(
	tIOBuf
 *, 
	tfd
, 
	toff_t
 
	tËn
);

27 
	eIOBufTy³
 {

28 
IOBUF_SSL
, 
IOBUF_SOCKET
, 
IOBUF_FILE
, 
IOBUF_NULL


29 } 
	tIOBufTy³
;

31 
	sIOBuf
 {

34 
Ën
;

37 
ava
;

40 
cur
;

43 
m¬k
;

45 
şo£d
;

46 
io_cb
 
»cv
;

47 
io_cb
 
£nd
;

48 
io_¡»am_fe_cb
 
¡»am_fe
;

49 *
buf
;

51 
ty³
;

53 
fd
;

54 
u£_s¦
;

55 
hªdshake_³rfÜmed
;

56 
s¦_cÚ‹xt
 
s¦
;

57 
s¦_£ssiÚ
 
s¢
;

58 
havege_¡©e
 
hs
;

59 } 
	tIOBuf
;

61 
IOBuf
 *
	`IOBuf_ü—‹
(
size_t
 
Ën
, 
fd
, 
IOBufTy³
 
ty³
);

63 
	`IOBuf_»size
(
IOBuf
 *
buf
, 
size_t
 
Ãw_size
);

65 
	`IOBuf_de¡roy
(
IOBuf
 *
buf
);

67 *
	`IOBuf_»ad
(
IOBuf
 *
buf
, 
Ãed
, *
out_Ën
);

68 
	`IOBuf_»ad_comm™
(
IOBuf
 *
buf
, 
Ãed
);

70 
	`IOBuf_£nd
(
IOBuf
 *
buf
, *
d©a
, 
Ën
);

72 
	`IOBuf_£nd_®l
(
IOBuf
 *
buf
, *
d©a
, 
Ën
);

74 *
	`IOBuf_»ad_®l
(
IOBuf
 *
buf
, 
Ën
, 
»Œ›s
);

76 
	`IOBuf_¡»am
(
IOBuf
 *
äom
, IOBuà*
to
, 
tÙ®
);

78 
	`IOBuf_¡»am_fe
(
IOBuf
 *
buf
, 
fd
, 
off_t
 
Ën
);

80 
	#IOBuf_»ad_some
(
I
,
A
è
	`IOBuf_»ad
((I), (I)->
Ën
, A)

	)

82 
	#IOBuf_şo£d
(
I
è((I)->
şo£d
)

	)

84 
	#IOBuf_com·ù_Ãeded
(
I
,
N
è((I)->
cur
 + (Nè> (I)->
Ën
)

	)

86 
	#IOBuf_»maššg
(
I
è((I)->
Ën
 - (I)->
ava
 - (I)->
cur
)

	)

87 
	#IOBuf_»ad_pošt
(
I
è((I)->
buf
 + (I)->
cur
 + (I)->
ava
)

	)

88 
	#IOBuf_¡¬t
(
I
è((I)->
buf
 + (I)->
cur
)

	)

90 
	#IOBuf_£t_m¬k
(
I
, 
N
è((I)->
m¬k
 = (N))

	)

91 
	#IOBuf_m¬k
(
I
è((I)->
m¬k
)

	)

93 
	#IOBuf_ava
(
I
è((I)->
ava
)

	)

95 
	#IOBuf_fd
(
I
è((I)->
fd
)

	)

97 #ià
	`defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

98 
	#IOBuf_£ndfe
 
bsd_£ndfe


	)

100 
	#IOBuf_£ndfe
 
£ndfe


	)

	@src/log.c

35 
	~"log.h
"

36 
	~"dbg.h
"

37 
	~"»que¡.h
"

38 
	~"h—d”s.h
"

39 
	~"£‰šg.h
"

40 
	~"Š‘¡ršgs.h
"

41 
	~<¡dio.h
>

42 
	~<zmq.h
>

43 
	~<±h»ad.h
>

45 *
	gLOG_SOCKET
 = 
NULL
;

46 
±h»ad_t
 
	gLOG_THREAD
;

48 
	sLogCÚfig
 {

49 
b¡ršg
 
	mfe_Çme
;

50 
b¡ršg
 
	mlog_¥ec
;

51 
FILE
 *
	mlog_fe
;

52 } 
	tLogCÚfig
;

55 
	$LogCÚfig_de¡roy
(
LogCÚfig
 *
cÚfig
)

57 if(
cÚfig
) {

58 
	`bde¡roy
(
cÚfig
->
fe_Çme
);

59 
	`bde¡roy
(
cÚfig
->
log_¥ec
);

60 if(
cÚfig
->
log_fe
è
	`fşo£
(config->log_file);

61 
	`ä“
(
cÚfig
);

63 
	}
}

65 *
	$Log_š‹º®_th»ad
(*
¥ec
)

67 
zmq_msg_t
 
msg
;

68 
rc
 = 0;

69 
LogCÚfig
 *
cÚfig
 = 
¥ec
;

71 *
sock‘
 = 
	`zmq_sock‘
(
ZMQ_CTX
, 
ZMQ_SUB
);

72 
	`check
(
sock‘
, "Could‚ot bindhe†ogging subscribe socket.");

76 
rc
 = 
	`zmq_£tsockİt
(
sock‘
, 
ZMQ_SUBSCRIBE
, "", 0);

77 
	`check
(
rc
 == 0, "Could‚ot subscribeohe†ogger.");

79 #ifdeà
ZMQ_LINGER


80 
İt
 = 0;

81 
rc
 = 
	`zmq_£tsockİt
(
sock‘
, 
ZMQ_LINGER
, &
İt
, (opt));

82 
	`check
(
rc
 == 0, "Could‚ot sethe†inger option.");

85 
rc
 = 
	`zmq_cÚÃù
(
sock‘
, 
	`bd©a
(
cÚfig
->
log_¥ec
));

86 
	`check
(
rc
 =ğ0, "Could cÚÃùØloggšgƒndpošt: %s", 
	`bd©a
(
cÚfig
->
log_¥ec
));

90 
rc
 = 
	`zmq_msg_š™
(&
msg
);

91 
	`check
(
rc
 == 0, "Failedo initialize message.");

93 
rc
 = 
	`zmq_»cv
(
sock‘
, &
msg
, 0);

94 if(
rc
 =ğ-1 && 
”ºo
 =ğ
ETERM
) {

98 
	`check
(
rc
 == 0, "Failedo„eceive fromhe zeromq†ogging socket");

99 
	`check
(
	`zmq_msg_size
(&
msg
) > 0, "Received…oison…ill,†oghreadƒxiting.");

101 
	`årštf
(
cÚfig
->
log_fe
, "%.*s", ()
	`zmq_msg_size
(&
msg
), (*)
	`zmq_msg_d©a
(&msg));

103 
rc
 = 
	`zmq_msg_şo£
(&
msg
);

104 
	`check
(
rc
 == 0, "Message close failed.");

107 
rc
 = 
	`zmq_şo£
(
sock‘
);

108 
	`check
(
rc
 == 0, "Could‚ot close socket");

110 
	`LogCÚfig_de¡roy
(
cÚfig
);

111  
NULL
;

113 
”rÜ
:

114 
	`LogCÚfig_de¡roy
(
cÚfig
);

116  
NULL
;

117 
	}
}

120 
LogCÚfig
 *
	$LogCÚfig_ü—‹
(
b¡ršg
 
acûss_log
, b¡ršg 
log_¥ec
)

122 
LogCÚfig
 *
cÚfig
 = 
	`m®loc
((LogConfig));

123 
cÚfig
->
log_¥ec
 =†og_spec;

124 
cÚfig
->
fe_Çme
 = 
acûss_log
;

126 
cÚfig
->
log_fe
 = 
	`fİ’
((*)cÚfig->
fe_Çme
->
d©a
, "a+");

127 
	`check
(
cÚfig
->
log_fe
, "FaedØİ’†og fe: % fÜ‡cûs loggšg.", 
	`bd©a
(cÚfig->
fe_Çme
));

128 
	`£tbuf
(
cÚfig
->
log_fe
, 
NULL
);

130  
cÚfig
;

132 
”rÜ
:

133 
	`LogCÚfig_de¡roy
(
cÚfig
);

134  
NULL
;

135 
	}
}

138 
	$Log_š™
(
b¡ršg
 
acûss_log
, b¡ršg 
log_¥ec
)

140 
rc
 = 0;

141 
LogCÚfig
 *
cÚfig
 = 
NULL
;

143 if(
LOG_SOCKET
 =ğ
NULL
)

145 
	`check
(
ZMQ_CTX
, "No ZMQ context, cannot start‡ccess†og.");

147 if(
	`S‘tšg_g‘_št
("disable.access_logging", 0))

149 
	`log_šfo
("Access†og is disabled‡ccordingo disable.access_logging.");

153 
cÚfig
 = 
	`LogCÚfig_ü—‹
(
acûss_log
, 
log_¥ec
);

154 
	`check
(
cÚfig
, "Failedo configure‡ccess†ogging.");

156 
LOG_SOCKET
 = 
	`zmq_sock‘
(
ZMQ_CTX
, 
ZMQ_PUB
);

157 
	`check
(
LOG_SOCKET
 !ğ
NULL
, "Failedo create‡ccess†og socket");

159 #ifdeà
ZMQ_LINGER


160 
İt
 = 0;

161 
rc
 = 
	`zmq_£tsockİt
(
LOG_SOCKET
, 
ZMQ_LINGER
, &
İt
, (opt));

162 
	`check
(
rc
 == 0, "Could‚ot sethe†inger option.");

165 
rc
 = 
	`zmq_bšd
(
LOG_SOCKET
, 
	`bd©a
(
log_¥ec
));

166 
	`check
(
rc
 == 0, "Failedo bind‡ccess_log zeromq socket.");

168 
	`±h»ad_ü—‹
(&
LOG_THREAD
, 
NULL
, 
Log_š‹º®_th»ad
, 
cÚfig
);

173 
”rÜ
:

175 
	`LogCÚfig_de¡roy
(
cÚfig
);

177 
	}
}

180 
	$Log_poisÚ_wÜk”s
()

182 
	`check
(
LOG_SOCKET
 !ğ
NULL
, "No‡ccess†og socket.");

184 
zmq_msg_t
 
msg
;

185 
rc
 = 
	`zmq_msg_š™_size
(&
msg
, 0);

186 
	`check
(
rc
 == 0, "Could‚ot create zmq message.");

188 
rc
 = 
	`zmq_£nd
(
LOG_SOCKET
, &
msg
, 0);

189 
	`check
(
rc
 == 0, "Could‚ot send message");

191 
rc
 = 
	`zmq_msg_şo£
(&
msg
);

192 
	`check
(
rc
 == 0, "Failedo close message object");

195 
”rÜ
:

196 
	`zmq_msg_şo£
(&
msg
);

198 
	}
}

200 
šlše
 
b¡ršg
 
	$make_log_mes§ge
(
Reque¡
 *
»q
, cÚ¡ *
»mÙe_addr
,

201 
»mÙe_pÜt
, 
¡©us
, 
size
)

203 
b¡ršg
 
»que¡_m‘hod
 = 
NULL
;

205 ià(
	`Reque¡_is_jsÚ
(
»q
)) {

206 
»que¡_m‘hod
 = &
JSON_METHOD
;

207 } ià(
	`Reque¡_is_xml
(
»q
)) {

208 
»que¡_m‘hod
 = &
XML_METHOD
;

210 
»que¡_m‘hod
 = 
»q
->request_method;

213 
Šs_outbuf
 
outbuf
 = {.
bufãr
 = 
NULL
};

214 
b¡ršg
 
b_‹mp
;

216 
	`check
(
	`Šs_»nd”_log_¡¬t
(&
outbuf
), "Could‚ot initialize buffer");

218 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, 
size
);

219 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, 
¡©us
);

221 
b_‹mp
 = 
	`bäomc¡r
(
	`Reque¡_is_jsÚ
(
»q
è? "" : 
	`bd©a
Ôeq->
v”siÚ
));

222 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
b_‹mp
);

223 
	`bde¡roy
(
b_‹mp
);

225 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
	`Reque¡_·th
(
»q
));

226 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
»que¡_m‘hod
);

227 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, (è
	`time
(
NULL
));

228 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, 
»mÙe_pÜt
);

230 
b_‹mp
 = 
	`bäomc¡r
(
»mÙe_addr
);

231 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
b_‹mp
);

232 
	`bde¡roy
(
b_‹mp
);

234 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
»q
->
rg‘_ho¡
->
Çme
);

236 
	`Šs_»nd”_log_’d
(&
outbuf
);

239 
b¡ršg
 
log_d©a
 = 
	`Šs_outbuf_to_b¡ršg
(&
outbuf
);

240 
	`bcÚch¬
(
log_d©a
, '\n');

242  
log_d©a
;

244 
”rÜ
:

246  
NULL
;

247 
	}
}

249 
	$ä“_log_msg
(*
d©a
, *
hšt
)

251 
	`bde¡roy
((
b¡ršg
)
hšt
);

252 
	}
}

254 
	$Log_»que¡
(
CÚÃùiÚ
 *
cÚn
, 
¡©us
, 
size
)

256 
zmq_msg_t
 
msg
;

258 if(
LOG_SOCKET
 =ğ
NULL
)

261 
b¡ršg
 
log_d©a
 = 
	`make_log_mes§ge
(
cÚn
->
»q
, cÚn->
»mÙe
, cÚn->
½Üt
, 
¡©us
, 
size
);

262 
	`check_mem
(
log_d©a
);

264 
rc
 = 
	`zmq_msg_š™_d©a
(&
msg
, 
	`bd©a
(
log_d©a
), 
	`bËngth
(log_data),

265 
ä“_log_msg
, 
log_d©a
);

266 
	`check
(
rc
 =ğ0, "Could‚Ù c¿á mes§gfÜ†og mes§g'%s'.", 
	`bd©a
(
log_d©a
));

268 
rc
 = 
	`zmq_£nd
(
LOG_SOCKET
, &
msg
, 0);

269 
	`check
(
rc
 == 0, "Could‚ot send†og messageo socket.");

271 
log_d©a
 = 
NULL
;

272 
rc
 = 
	`zmq_msg_şo£
(&
msg
);

273 
	`check
(
rc
 == 0, "Failedo close message object.");

277 
”rÜ
:

278 
	`bde¡roy
(
log_d©a
);

279 
	`zmq_msg_şo£
(&
msg
);

281 
	}
}

283 
	$Log_‹rm
()

285 if(
LOG_SOCKET
 =ğ
NULL
)

288 
rc
 = 
	`zmq_şo£
(
LOG_SOCKET
);

289 
	`check
(
rc
 == 0, "Failedo close‡ccess†og socket.");

293 
”rÜ
:

295 
	}
}

	@src/log.h

1 #iâdeà
_log_h


2 
	#_log_h


	)

4 
	~"£rv”.h
"

5 
	~"cÚÃùiÚ.h
"

7 
Log_š™
(
b¡ršg
 
acûss_log
, b¡ršg 
log_¥ec
);

9 
Log_bšd
(cÚ¡ *
’dpošt
);

11 
Log_poisÚ_wÜk”s
();

13 
Log_»que¡
(
CÚÃùiÚ
 *
cÚn
, 
¡©us
, 
size
);

15 
Log_‹rm
();

	@src/mem/align.h

15 #iâdeà
_LIBP_ALIGN_H_


16 
	#_LIBP_ALIGN_H_


	)

21 
	umax_®ign


23 
	mc
;

24 
	ms
;

25 
	ml
;

26 
	mi
;

27 
	mf
;

28 
	md
;

29 * 
	mv
;

30 (*
	mq
)();

33 
max_®ign
 
	tmax_®ign_t
;

	@src/mem/halloc.c

15 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD
)

16 
	~<¡dlib.h
>

18 
	~<m®loc.h
>

20 
	~<¡ršg.h
>

22 
	~"h®loc.h
"

23 
	~"®ign.h
"

24 
	~"hli¡.h
"

29 
	shblock


31 #iâdeà
NDEBUG


32 
	#HH_MAGIC
 0x20040518L

	)

33 
	mmagic
;

35 
hli¡_™em_t
 
	msiblšgs
;

36 
hli¡_h—d_t
 
	mchd»n
;

37 
max_®ign_t
 
	md©a
[1];

39 } 
	thblock_t
;

41 
	#sizeof_hblock
 
	`off£tof
(
hblock_t
, 
d©a
)

	)

46 
»®loc_t
 
	gh®loc_®loÿtÜ
 = 
NULL
;

48 
	#®loÿtÜ
 
h®loc_®loÿtÜ


	)

53 
_£t_®loÿtÜ
();

54 * 
_»®loc
(* 
±r
, 
size_t
 
n
);

56 #iâdeà
NDEBUG


57 
_»Ï‹
(
hblock_t
 * 
b
, hblock_ˆ* 
p
);

60 
_ä“_chd»n
(
hblock_t
 * 
p
);

65 * 
	$h®loc
(* 
±r
, 
size_t
 
Ën
)

67 
hblock_t
 * 
p
;

70 ià(! 
®loÿtÜ
)

72 
	`_£t_®loÿtÜ
();

73 
	`as£¹
(
®loÿtÜ
);

77 ià(! 
±r
)

79 ià(! 
Ën
)

80  
NULL
;

82 
p
 = 
	`®loÿtÜ
(0, 
Ën
 + 
sizeof_hblock
);

83 ià(! 
p
)

84  
NULL
;

85 #iâdeà
NDEBUG


86 
p
->
magic
 = 
HH_MAGIC
;

88 
	`hli¡_š™
(&
p
->
chd»n
);

89 
	`hli¡_š™_™em
(&
p
->
siblšgs
);

91  
p
->
d©a
;

94 
p
 = 
	`¡ruùof
(
±r
, 
hblock_t
, 
d©a
);

95 
	`as£¹
(
p
->
magic
 =ğ
HH_MAGIC
);

98 ià(
Ën
)

100 
p
 = 
	`®loÿtÜ
Õ, 
Ën
 + 
sizeof_hblock
);

101 ià(! 
p
)

102  
NULL
;

104 
	`hli¡_»lšk
(&
p
->
siblšgs
);

105 
	`hli¡_»lšk_h—d
(&
p
->
chd»n
);

107  
p
->
d©a
;

111 
	`_ä“_chd»n
(
p
);

112 
	`hli¡_d–
(&
p
->
siblšgs
);

113 
	`®loÿtÜ
(
p
, 0);

115  
NULL
;

116 
	}
}

118 
	$h©ch
(* 
block
, * 
·»Á
)

120 
hblock_t
 * 
b
, * 
p
;

122 ià(! 
block
)

124 
	`as£¹
(! 
·»Á
);

129 
b
 = 
	`¡ruùof
(
block
, 
hblock_t
, 
d©a
);

130 
	`as£¹
(
b
->
magic
 =ğ
HH_MAGIC
);

132 
	`hli¡_d–
(&
b
->
siblšgs
);

134 ià(! 
·»Á
)

138 
p
 = 
	`¡ruùof
(
·»Á
, 
hblock_t
, 
d©a
);

139 
	`as£¹
(
p
->
magic
 =ğ
HH_MAGIC
);

142 
	`as£¹
(
b
 !ğ
p
);

143 
	`as£¹
(! 
	`_»Ï‹
(
p
, 
b
));

145 
	`hli¡_add
(&
p
->
chd»n
, &
b
->
siblšgs
);

146 
	}
}

151 * 
	$h_m®loc
(
size_t
 
Ën
)

153  
	`h®loc
(0, 
Ën
);

154 
	}
}

156 * 
	$h_ÿÎoc
(
size_t
 
n
, size_ˆ
Ën
)

158 * 
±r
 = 
	`h®loc
(0, 
Ën
*=
n
);

159  
±r
 ? 
	`mem£t
ÕŒ, 0, 
Ën
è: 
NULL
;

160 
	}
}

162 * 
	$h_»®loc
(* 
±r
, 
size_t
 
Ën
)

164  
	`h®loc
(
±r
, 
Ën
);

165 
	}
}

167 
	$h_ä“
(* 
±r
)

169 
	`h®loc
(
±r
, 0);

170 
	}
}

172 * 
	$h_¡rdup
(cÚ¡ * 
¡r
)

174 
size_t
 
Ën
 = 
	`¡¾’
(
¡r
);

175 * 
±r
 = 
	`h®loc
(0, 
Ën
 + 1);

176  
±r
 ? (±r[
Ën
] = 0, 
	`memıy
ÕŒ, 
¡r
,†’)è: 
NULL
;

177 
	}
}

182 
	$_£t_®loÿtÜ
()

184 * 
p
;

185 
	`as£¹
(! 
®loÿtÜ
);

197 
®loÿtÜ
 = 
»®loc
;

198 ià(! (
p
 = 
	`m®loc
(1)))

202 ià((
p
 = 
	`»®loc
(p, 0)))

205 
®loÿtÜ
 = 
_»®loc
;

206 
	`ä“
(
p
);

208 
	}
}

210 * 
	$_»®loc
(* 
±r
, 
size_t
 
n
)

215 ià(
n
)

216  
	`»®loc
(
±r
, 
n
);

217 
	`ä“
(
±r
);

218  
NULL
;

219 
	}
}

221 #iâdeà
NDEBUG


222 
	$_»Ï‹
(
hblock_t
 * 
b
, hblock_ˆ* 
p
)

224 
hli¡_™em_t
 * 
i
;

226 ià(!
b
 || !
p
)

234 
	`hli¡_fÜ_—ch
(
i
, &
p
->
chd»n
)

236 
hblock_t
 * 
q
 = 
	`¡ruùof
(
i
, hblock_t, 
siblšgs
);

237 ià(
q
 =ğ
b
 || 
	`_»Ï‹
(b, q))

241 
	}
}

244 
	$_ä“_chd»n
(
hblock_t
 * 
p
)

246 
hli¡_™em_t
 * 
i
, * 
tmp
;

248 #iâdeà
NDEBUG


253 
	`as£¹
(
p
 &&…->
magic
 =ğ
HH_MAGIC
);

254 
p
->
magic
 = 0;

256 
	`hli¡_fÜ_—ch_§ã
(
i
, 
tmp
, &
p
->
chd»n
)

258 
hblock_t
 * 
q
 = 
	`¡ruùof
(
i
, hblock_t, 
siblšgs
);

259 
	`_ä“_chd»n
(
q
);

260 
	`®loÿtÜ
(
q
, 0);

262 
	}
}

	@src/mem/halloc.h

15 #iâdeà
_LIBP_HALLOC_H_


16 
	#_LIBP_HALLOC_H_


	)

18 
	~<¡ddef.h
>

23 * 
h®loc
 (* 
block
, 
size_t
 
Ën
);

24 
h©ch
(* 
block
, * 
·»Á
);

29 * 
h_m®loc
 (
size_t
 
Ën
);

30 * 
h_ÿÎoc
 (
size_t
 
n
, size_ˆ
Ën
);

31 * 
h_»®loc
(* 
p
, 
size_t
 
Ën
);

32 
h_ä“
 (* 
p
);

33 * 
h_¡rdup
 (cÚ¡ * 
¡r
);

38 * (* 
	t»®loc_t
)(* 
	t±r
, 
	tsize_t
 
	tËn
);

40 
»®loc_t
 
h®loc_®loÿtÜ
;

	@src/mem/hlist.h

15 #iâdeà
_LIBP_HLIST_H_


16 
	#_LIBP_HLIST_H_


	)

18 
	~<as£¹.h
>

19 
	~"maüos.h
"

24 
hli¡_h—d
 
	thli¡_h—d_t
;

25 
hli¡_™em
 
	thli¡_™em_t
;

30 
	shli¡_h—d


32 
hli¡_™em_t
 * 
	mÃxt
;

35 
	shli¡_™em


37 
hli¡_™em_t
 * 
	mÃxt
;

38 
hli¡_™em_t
 ** 
	m´ev
;

44 
hli¡_™em
 
	ghli¡_nuÎ
;

49 
	#__hli¡_š™
(
h
è{ &
hli¡_nuÎ
 }

	)

50 
	#__hli¡_š™_™em
(
i
è{ &
hli¡_nuÎ
, &(i).
Ãxt
 }

	)

52 
¡©ic_šlše
 
hli¡_š™
(
hli¡_h—d_t
 * 
h
);

53 
¡©ic_šlše
 
hli¡_š™_™em
(
hli¡_™em_t
 * 
i
);

65 
¡©ic_šlše
 
hli¡_add
(
hli¡_h—d_t
 * 
h
, 
hli¡_™em_t
 * 
i
);

70 
¡©ic_šlše
 
hli¡_d–
(
hli¡_™em_t
 * 
i
);

72 
¡©ic_šlše
 
hli¡_»lšk
(
hli¡_™em_t
 * 
i
);

73 
¡©ic_šlše
 
hli¡_»lšk_h—d
(
hli¡_h—d_t
 * 
h
);

75 
	#hli¡_fÜ_—ch
(
i
, 
h
) \

76 
i
 = (
h
)->
Ãxt
; i !ğ&
hli¡_nuÎ
; i = i->Ãxt)

	)

78 
	#hli¡_fÜ_—ch_§ã
(
i
, 
tmp
, 
h
) \

79 
i
 = (
h
)->
Ãxt
, 
tmp
 = i->next; \

80 
i
!ğ&
hli¡_nuÎ
; \

81 
i
 = 
tmp
,m°ği->
Ãxt
)

	)

86 
¡©ic_šlše
 
	$hli¡_š™
(
hli¡_h—d_t
 * 
h
)

88 
	`as£¹
(
h
);

89 
h
->
Ãxt
 = &
hli¡_nuÎ
;

90 
	}
}

92 
¡©ic_šlše
 
	$hli¡_š™_™em
(
hli¡_™em_t
 * 
i
)

94 
	`as£¹
(
i
);

95 
i
->
´ev
 = &i->
Ãxt
;

96 
i
->
Ãxt
 = &
hli¡_nuÎ
;

97 
	}
}

99 
¡©ic_šlše
 
	$hli¡_add
(
hli¡_h—d_t
 * 
h
, 
hli¡_™em_t
 * 
i
)

101 
hli¡_™em_t
 * 
Ãxt
;

102 
	`as£¹
(
h
 && 
i
);

104 
Ãxt
 = 
i
->Ãxˆğ
h
->next;

105 
Ãxt
->
´ev
 = &
i
->next;

106 
h
->
Ãxt
 = 
i
;

107 
i
->
´ev
 = &
h
->
Ãxt
;

108 
	}
}

110 
¡©ic_šlše
 
	$hli¡_d–
(
hli¡_™em_t
 * 
i
)

112 
hli¡_™em_t
 * 
Ãxt
;

113 
	`as£¹
(
i
);

115 
Ãxt
 = 
i
->next;

116 
Ãxt
->
´ev
 = 
i
->prev;

117 *
i
->
´ev
 = 
Ãxt
;

119 
	`hli¡_š™_™em
(
i
);

120 
	}
}

122 
¡©ic_šlše
 
	$hli¡_»lšk
(
hli¡_™em_t
 * 
i
)

124 
	`as£¹
(
i
);

125 *
i
->
´ev
 = i;

126 
i
->
Ãxt
->
´ev
 = &i->next;

127 
	}
}

129 
¡©ic_šlše
 
	$hli¡_»lšk_h—d
(
hli¡_h—d_t
 * 
h
)

131 
	`as£¹
(
h
);

132 
h
->
Ãxt
->
´ev
 = &h->next;

133 
	}
}

	@src/mem/macros.h

15 #iâdeà
_LIBP_MACROS_H_


16 
	#_LIBP_MACROS_H_


	)

18 
	~<¡ddef.h
>

23 
	#¡ruùof
(
p
,
t
,
f
è(Ñ*)(- 
	`off£tof
Ñ,fè+ (*)Õ)))

	)

28 
	#¡©ic_šlše
 
__šlše__


	)

	@src/mime.c

35 
	~<mime.h
>

36 
	~<adt/t¡.h
>

37 
	~<dbg.h
>

38 
	~"£‰šg.h
"

41 
t¡_t
 *
	gMIME_MAP
 = 
NULL
;

43 
	gMAX_EXT_LEN
 = 0;

45 
	$MIME_add_ty³
(cÚ¡ *
ext
, cÚ¡ *
ty³
)

47 if(!
MAX_EXT_LEN
) {

48 
MAX_EXT_LEN
 = 
	`S‘tšg_g‘_št
("limits.mime_ext_len", 128);

49 
	`log_šfo
("MAX†im™s.mime_ext_Ën=%d", 
MAX_EXT_LEN
);

52 
b¡ršg
 
ext_»v
 = 
	`bäomc¡r
(
ext
);

53 
	`bRev”£
(
ext_»v
);

54 
b¡ršg
 
ty³_¡r
 = 
	`bäomc¡r
(
ty³
);

56 
	`check
(
	`bËngth
(
ext_»v
è> 0, "NØz”ØËngth MIMEƒx‹nsiÚ ®lowed: %s:%s", 
ext
, 
ty³
);

57 
	`check
(
	`bËngth
(
ty³_¡r
è> 0, "NØz”ØËngth MIMEy³ ®lowed: %s:%s", 
ext
, 
ty³
);

58 
	`check
(
ext
[0] =ğ'.', "Ex‹nsiÚ mu¡ s¹ w™h‡ . '%s:%s'",ƒxt, 
ty³
);

60 
	`check
(
	`bËngth
(
ext_»v
è< 
MAX_EXT_LEN
, "MIMEƒx‹nsiÚ %s:% i lÚg”hª %d MAX (™' %d)", 
ext
, 
ty³
, MAX_EXT_LEN, blength(ext_rev));

62 
	`check
(!
	`t¡_£¬ch
(
MIME_MAP
, 
	`bd©a
(
ext_»v
), 
	`bËngth
(ext_rev)),

64 
ext
,ƒxt, 
ty³
);

66 
MIME_MAP
 = 
	`t¡_š£¹
(MIME_MAP, 
	`bd©a
(
ext_»v
), 
	`bËngth
Óxt_»v), 
ty³_¡r
);

68 
	`bde¡roy
(
ext_»v
);

71 
”rÜ
:

72 
	`bde¡roy
(
ext_»v
);

73 
	`bde¡roy
(
ty³_¡r
);

75 
	}
}

78 
b¡ršg
 
	$MIME_m©ch_ext
(
b¡ršg
 
·th
, b¡ršg 
def
)

80 
b¡ršg
 
ty³
 = 
	`t¡_£¬ch_suffix
(
MIME_MAP
, 
	`bd©a
(
·th
), 
	`bËngth
(path));

82  
ty³
 =ğ
NULL
 ? 
def
 :ype;

83 
	}
}

85 
	$MIME_Œav”£_de¡roy
(*
v®ue
, *
d©a
)

87 
	`bde¡roy
((
b¡ršg
)
v®ue
);

88 
	}
}

90 
	$MIME_de¡roy
()

92 if(
MIME_MAP
) {

93 
	`t¡_Œav”£
(
MIME_MAP
, 
MIME_Œav”£_de¡roy
, 
NULL
);

94 
	`t¡_de¡roy
(
MIME_MAP
);

95 
MIME_MAP
 = 
NULL
;

97 
	}
}

	@src/mime.h

35 #iâdeà
_mime_h


36 
	#_mime_h


	)

38 
	~<¡dlib.h
>

39 
	~<b¡ršg.h
>

41 
MIME_add_ty³
(cÚ¡ *
ext
, cÚ¡ *
ty³
);

43 
b¡ršg
 
MIME_m©ch_ext
(b¡ršg 
·th
, b¡ršg 
def
);

45 
MIME_de¡roy
();

	@src/mongrel2.c

35 
	~<fú.h
>

36 
	~<¡ršg.h
>

37 
	~<sigÇl.h
>

38 
	~<time.h
>

39 
	~<as£¹.h
>

41 
	~"£rv”.h
"

42 
	~"dbg.h
"

43 
	~"dœ.h
"

44 
	~"sk/sk.h
"

45 
	~"cÚfig/cÚfig.h
"

46 
	~"cÚfig/db.h
"

47 
	~"adt/li¡.h
"

48 
	~"unixy.h
"

49 
	~"mime.h
"

50 
	~"su³½Şl.h
"

51 
	~"£‰šg.h
"

52 
	~"v”siÚ.h
"

53 
	~"cÚŒŞ.h
"

54 
	~"log.h
"

55 
	~"»gi¡”.h
"

57 
RUNNING
;

58 
ušt32_t
 
THE_CURRENT_TIME_IS
;

59 
	gRELOAD
;

60 
	gMURDER
;

62 
gb¡ršg
 
	gPRIV_DIR
 = 
bsStic
("/");

64 
S”v”
 *
	gSERVER
 = 
NULL
;

67 
	$‹rmš©e
(
s
)

69 
MURDER
 = 
s
 =ğ
SIGTERM
;

70 
s
)

72 
SIGHUP
:

73 
RELOAD
 = 1;

74 
RUNNING
 = 0;

75 
	`log_šfo
("RELOAD REQUESTED, I'll do it onhe‚ext„equest.");

78 if(!
RUNNING
) {

79 
	`log_šfo
("SIGINT CAUGHT AGAIN, ASSUMING MURDER.");

80 
MURDER
 = 1;

82 
RUNNING
 = 0;

83 
	`log_šfo
("SHUTDOWN REQUESTED: %s", 
MURDER
 ? "MURDER" : "GRACEFUL (SIGINT‡gaino EXIT NOW)");

84 
	`fdşo£
(
SERVER
->
li¡’_fd
);

88 
	}
}

90 
	$¡¬t_‹rmš©Ü
()

92 
sigaùiÚ
 
§
, 
o§
;

93 
	`mem£t
(&
§
, 0,  sa);

94 
§
.
§_hªdËr
 = 
‹rmš©e
;

95 
§
.
§_æags
 = 
SA_RESTART
;

96 
	`sigaùiÚ
(
SIGINT
, &
§
, &
o§
);

97 
	`sigaùiÚ
(
SIGTERM
, &
§
, &
o§
);

98 
	`sigaùiÚ
(
SIGHUP
, &
§
, &
o§
);

101 
sig£t_t
 
x
;

102 
	`sigem±y£t
(&
x
);

103 
	`sigadd£t
(&
x
, 
SIGPIPE
);

104 
	`sig´ocmask
(
SIG_BLOCK
, &
x
, 
NULL
);

106 
	`sigem±y£t
(&
x
);

107 
	`sigadd£t
(&
x
, 
SIGPIPE
);

108 
	`±h»ad_sigmask
(
SIG_BLOCK
, &
x
, 
NULL
);

110 
§
.
§_hªdËr
 = 
SIG_IGN
;

111 
	`sigaùiÚ
(
SIGPIPE
, &
§
, &
o§
);

112 
	}
}

115 
S”v”
 *
	$lßd_£rv”
(cÚ¡ *
db_fe
, cÚ¡ *
£rv”_uuid
, 
S”v”
 *
Şd_¤v
)

117 
rc
 = 0;

118 
S”v”
 *
¤v
 = 
NULL
;

120 
rc
 = 
	`CÚfig_š™_db
(
db_fe
);

121 
	`check
(
rc
 =ğ0, "FaedØlßd cÚfig d©aba£‡ˆ%s", 
db_fe
);

123 
rc
 = 
	`CÚfig_lßd_£‰šgs
();

124 
	`check
(
rc
 != -1, "Failedo†oad global settings.");

126 
rc
 = 
	`CÚfig_lßd_mim‘y³s
();

127 
	`check
(
rc
 != -1, "Failedo†oad mimeypes.");

129 
¤v
 = 
	`CÚfig_lßd_£rv”
(
£rv”_uuid
);

130 
	`check
(
¤v
, "FaedØlßd s”v” % äom %s", 
£rv”_uuid
, 
db_fe
);

131 
	`check
(
¤v
->
deçuÉ_ho¡
, "NØdeçuÉ_ho¡ s‘ fÜ s”v”: %s, you‚“d oÃ ho¡‚amed: %s", 
£rv”_uuid
, 
	`bd©a
(¤v->
deçuÉ_ho¡Çme
));

133 if(
Şd_¤v
 =ğ
NULL
 || old_¤v->
li¡’_fd
 == -1) {

134 
¤v
->
li¡’_fd
 = 
	`ÃÂounû
(
TCP
, 
	`bd©a
(¤v->
bšd_addr
), srv->
pÜt
);

135 
	`check
(
¤v
->
li¡’_fd
 >ğ0, "Cª'ˆªnounû oÀTCP…Üˆ%d", srv->
pÜt
);

136 
	`check
(
	`fdnoblock
(
¤v
->
li¡’_fd
è=ğ0, "FaedØ£ˆli¡’šg…Üˆ%d‚Úblockšg.", srv->
pÜt
);

138 
¤v
->
li¡’_fd
 = 
	`dup
(
Şd_¤v
->listen_fd);

139 
	`check
(
¤v
->
li¡’_fd
 != -1, "Failedo duphe socket fromhe„unning server.");

140 
	`fdşo£
(
Şd_¤v
->
li¡’_fd
);

143 
	`check
(
	`S”v”_¡¬t_hªdËrs
(
¤v
, 
Şd_¤v
) == 0, "Failedo start handlers.");

145 
	`CÚfig_şo£_db
();

146  
¤v
;

147 
”rÜ
:

149 
	`S”v”_de¡roy
(
¤v
);

150 
	`CÚfig_şo£_db
();

151  
NULL
;

152 
	}
}

155 
	$ş—r_pid_fe
(
S”v”
 *
¤v
)

157 
b¡ršg
 
pid_fe
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
¤v
->
chroÙ
), bdata(srv->pid_file));

159 
rc
 = 
	`Unixy_»move_d—d_pidfe
(
pid_fe
);

160 
	`check
(
rc
 =ğ0, "FaedØ»movthd—d PID fe: %s", 
	`bd©a
(
pid_fe
));

161 
	`bde¡roy
(
pid_fe
);

164 
”rÜ
:

166 
	}
}

168 
	$tick”sk
(*
v
)

170 
	`skÇme
("ticker");

172 !
	`sk_was_sigÇËd
()) {

173 
THE_CURRENT_TIME_IS
 = 
	`time
(
NULL
);

175 
mš_wa™
 = 
	`S‘tšg_g‘_št
("limits.tick_timer", 10);

176 
	`skd–ay
(
mš_wa™
 * 1000);

179 
mš_pšg
 = 
	`S‘tšg_g‘_št
("lim™s.mš_pšg", 
DEFAULT_MIN_PING
);

180 
mš_wr™e_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_wr™e_¿‹", 
DEFAULT_MIN_READ_RATE
);

181 
mš_»ad_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_»ad_¿‹", 
DEFAULT_MIN_WRITE_RATE
);

183 if(
mš_pšg
 > 0 || 
mš_wr™e_¿‹
 > 0 || 
mš_»ad_¿‹
 > 0) {

184 
ş—»d
 = 
	`Regi¡”_ş—nout
();

186 if(
ş—»d
 > 0) {

187 
	`log_w¬n
("Timeouˆsk kËd %dasks, wa™šg %d secÚd fÜ mÜe.", 
ş—»d
, 
mš_wa™
);

189 
	`debug
("No connectionsimed out.");

193 
	}
}

195 
	$©‹m±_chroÙ_drİ
(
S”v”
 *
¤v
)

197 
rc
 = 0;

199 if(
	`Unixy_chroÙ
(
¤v
->
chroÙ
) == 0) {

200 
	`log_šfo
("All†oaded up,imeourn into‡ server.");

202 
	`check
(
	`acûss
("/run", 
F_OK
è=ğ0, "/ruÀdœeùÜy dÛ¢'ˆexi¡ iÀ% Ü i¢'ˆowÃd„ight.", 
	`bd©a
(
¤v
->
chroÙ
));

203 
	`check
(
	`acûss
("/tmp", 
F_OK
è=ğ0, "/tm°dœeùÜy dÛ¢'ˆexi¡ iÀ% Ü i¢'ˆowÃd„ight.", 
	`bd©a
(
¤v
->
chroÙ
));

205 
rc
 = 
	`Unixy_d«mÚize
();

206 
	`check
(
rc
 == 0, "Failedo daemonize,†ooks†ike you're hosed.");

208 
FILE
 *
log
 = 
	`fİ’
(
	`bd©a
(
¤v
->
”rÜ_log
), "a+");

209 
	`check
(
log
, "Couldn'ˆİ’ % log fe.", 
	`bd©a
(
¤v
->
”rÜ_log
));

210 
	`£tbuf
(
log
, 
NULL
);

212 
	`dbg_£t_log
(
log
);

214 
rc
 = 
	`Unixy_pid_fe
(
¤v
->
pid_fe
);

215 
	`check
(
rc
 =ğ0, "FaedØmakthPID f%s", 
	`bd©a
(
¤v
->
pid_fe
));

217 
rc
 = 
	`Unixy_drİ_´iv
(&
PRIV_DIR
);

218 
	`check
(
rc
 =ğ0, "FaedØdrİ…rivØthowÃ¸oà%s", 
	`bd©a
(&
PRIV_DIR
));

221 
	`log_w¬n
("Couldn'ˆchroÙoØ%s,‡ssumšg„uÂšg iÀ‹¡ mode.", 
	`bd©a
(
¤v
->
chroÙ
));

224 
b¡ršg
 
‹mp
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
¤v
->
chroÙ
), bd©a(¤v->
acûss_log
));

225 
	`bassign
(
¤v
->
acûss_log
, 
‹mp
);

226 
	`bde¡roy
(
‹mp
);

228 
‹mp
 = 
	`bfÜm©
(".%s", 
	`bd©a
(
¤v
->
pid_fe
));

229 
	`bassign
(
¤v
->
pid_fe
, 
‹mp
);

230 
	`bde¡roy
(
‹mp
);

232 
rc
 = 
	`Unixy_pid_fe
(
¤v
->
pid_fe
);

233 
	`check
(
rc
 =ğ0, "FaedØmakthPID f%s", 
	`bd©a
(
¤v
->
pid_fe
));

238 
”rÜ
:

240 
	}
}

242 
	$fš®_£tup
()

244 
	`¡¬t_‹rmš©Ü
();

245 
	`S”v”_š™
();

246 
b¡ršg
 
’d_pošt
 = 
	`bäomc¡r
("inproc://access_log");

247 
	`Log_š™
(
	`b¡rıy
(
SERVER
->
acûss_log
), 
’d_pošt
);

248 
	}
}

252 
S”v”
 *
	$»lßd_£rv”
(
S”v”
 *
Şd_¤v
, cÚ¡ *
db_fe
, cÚ¡ *
£rv”_uuid
)

254 
RUNNING
 = 1;

256 
	`log_šfo
("------------------------ RELOAD % -----------------------------------", 
£rv”_uuid
);

257 
	`MIME_de¡roy
();

258 
	`S‘tšg_de¡roy
();

260 
S”v”
 *
¤v
 = 
	`lßd_£rv”
(
db_fe
, 
£rv”_uuid
, 
Şd_¤v
);

261 
	`check
(
¤v
 !ğ
NULL
, "Failedo†oad‚ew server config.");

263 
	`S”v”_¡İ_hªdËrs
(
Şd_¤v
);

265 
RELOAD
 = 0;

266  
¤v
;

268 
”rÜ
:

269  
NULL
;

270 
	}
}

273 
	$com¶‘e_shutdown
(
S”v”
 *
¤v
)

275 
	`fdşo£
(
¤v
->
li¡’_fd
);

276 
©‹m±s
 = 0;

277 
rc
 = 0;

279 
rc
 = 
	`sk®lsigÇl
(
SIGTERM
);

280 
	`check
(
rc
 != -1, "Failedo sendhe TERM signalo‡ll internalasks.");

282 
	`log_šfo
("Shutting down‡ll„unningasks‡s gracefully‡s…ossible.");

285 
©‹m±s
 = 0; 
	`sk¤uÂšg
() > 1 &&‡ttempts < 20;‡ttempts++) {

286 
rc
 = 
	`sk®lsigÇl
(
SIGTERM
);

287 
	`check
(
rc
 !ğ-1, "FaedØ£ndhTERM sigÇÈtØš‹º®ask Ú‡‰em±: %d.", 
©‹m±s
);

290 
	`log_šfo
("Task now„uÂšg (šşudšg mašask): %d", 
	`sk¤uÂšg
());

292 
	`CÚŒŞ_pÜt_¡İ
();

293 
rc
 = 
	`Log_‹rm
();

294 
	`check
(
rc
 != -1, "Failedo shutdownhe†ogging subsystem.");

296 
	`S‘tšg_de¡roy
();

297 
	`MIME_de¡roy
();

299 
	`log_šfo
("Removšg…id f%s", 
	`bd©a
(
¤v
->
pid_fe
));

300 
rc
 = 
	`uÆšk
((cÚ¡ *)
¤v
->
pid_fe
->
d©a
);

301 
	`check
(
rc
 !ğ-1, "FaedØuÆšk…id_fe: %s", 
	`bd©a
(
¤v
->
pid_fe
));

303 
	`S”v”_de¡roy
(
¤v
);

305 
	`skex™®l
(0);

306 
”rÜ
:

307 
	`skex™®l
(1);

308 
	}
}

310 cÚ¡ 
	gTICKER_TASK_STACK
 = 16 * 1024;

312 
	$skmaš
(
¬gc
, **
¬gv
)

314 
	`dbg_£t_log
(
¡d”r
);

315 
rc
 = 0;

317 
	`check
(
¬gc
 == 3 ||‡rgc == 4, "usage: mongrel2 config.sqlite server_uuid [config_module.so]");

319 if(
¬gc
 == 4) {

320 
	`log_šfo
("Using configuration module %so†oad configs.",

321 
¬gv
[3]);

322 
rc
 = 
	`CÚfig_moduË_lßd
(
¬gv
[3]);

323 
	`check
(
rc
 !ğ-1, "FaedØlßdhcÚfig moduË: %s", 
¬gv
[3]);

326 
SERVER
 = 
	`lßd_£rv”
(
¬gv
[1],‡rgv[2], 
NULL
);

327 
	`check
(
SERVER
, "Aborting since can't†oad server.");

329 
	`Su³rPŞl_g‘_max_fd
();

331 
rc
 = 
	`ş—r_pid_fe
(
SERVER
);

332 
	`check
(
rc
 == 0, "PID file failure,‡borting„atherhanryingo start.");

334 
rc
 = 
	`©‹m±_chroÙ_drİ
(
SERVER
);

335 
	`check
(
rc
 == 0, "Major failure in chroot/droppriv,‡borting.");

337 
	`fš®_£tup
();

339 
	`CÚŒŞ_pÜt_¡¬t
();

340 
	`skü—‹
(
tick”sk
, 
NULL
, 
TICKER_TASK_STACK
);

343 
	`log_šfo
("S¹šg " 
VERSION
 ". Copyright (C) Zed A. Shaw. Licensed BSD.");

344 
	`S”v”_¡¬t
(
SERVER
);

346 if(
RELOAD
) {

347 
	`log_šfo
("R–ßd„eque¡ed, wÈlßd % äom %s", 
¬gv
[2],‡rgv[1]);

348 
S”v”
 *
Ãw_¤v
 = 
	`»lßd_£rv”
(
SERVER
, 
¬gv
[1],‡rgv[2]);

349 
	`check
(
Ãw_¤v
, "Failedo†oadhe‚ew configuration,ƒxiting.");

352 
SERVER
 = 
Ãw_¤v
;

354 
	`log_šfo
("Shutdown„equested, goodbye.");

359 
	`com¶‘e_shutdown
(
SERVER
);

362 
”rÜ
:

363 
	`log_”r
("Exiting dueoƒrror.");

364 
	`skex™®l
(1);

365 
	}
}

	@src/pattern.c

5 
	~<dbg.h
>

6 
	~<¡dlib.h
>

7 
	~<·‰”n.h
>

8 
	~<¡ršg.h
>

9 
	~<as£¹.h
>

10 
	~<ùy³.h
>

14 
	sM©chS‹
 {

15 cÚ¡ *
	m¤c_š™
;

16 cÚ¡ *
	m¤c_’d
;

17 } 
	tM©chS‹
;

20 
	#CAP_UNFINISHED
 (-1)

	)

21 
	#CAP_POSITION
 (-2)

	)

23 
	#uch¬
(
S
è(S)

	)

26 
	#L_ESC
 '\\'

	)

29 cÚ¡ *
	$şas£nd
 (
M©chS‹
 *
ms
, cÚ¡ *
p
) {

30 *
p
++) {

31 
L_ESC
: {

32 ià(*
p
 == '\0')

33 
	`log_”r
("malformed…attern (ends with '\\0')");

34  
p
+1;

37 ià(*
p
 == '^')…++;

39 ià(*
p
 == '\0')

40 
	`log_”r
("malformed…attern (missing ])");

41 ià(*(
p
++è=ğ
L_ESC
 && *p != '\0')

42 
p
++;

43 } *
p
 != ']');

44  
p
+1;

47  
p
;

50 
	}
}

53 
	$m©ch_şass
 (
c
, 
ş
) {

54 
»s
;

55 
	`tŞow”
(
ş
)) {

56 'a' : 
»s
 = 
	`i§Íha
(
c
); ;

57 'c' : 
»s
 = 
	`isúŒl
(
c
); ;

58 'd' : 
»s
 = 
	`isdig™
(
c
); ;

59 'l' : 
»s
 = 
	`i¦ow”
(
c
); ;

60 'p' : 
»s
 = 
	`i¥unù
(
c
); ;

61 's' : 
»s
 = 
	`is¥aû
(
c
); ;

62 'u' : 
»s
 = 
	`isuµ”
(
c
); ;

63 'w' : 
»s
 = 
	`i§Êum
(
c
); ;

64 'x' : 
»s
 = 
	`isxdig™
(
c
); ;

65 'z' : 
»s
 = (
c
 == 0); ;

66 :  (
ş
 =ğ
c
);

68  (
	`i¦ow”
(
ş
è? 
»s
 : !res);

69 
	}
}

72 
	$m©chb¿ck‘şass
 (
c
, cÚ¡ *
p
, cÚ¡ *
ec
) {

73 
sig
 = 1;

74 ià(*(
p
+1) == '^') {

75 
sig
 = 0;

76 
p
++;

78 ++
p
 < 
ec
) {

79 ià(*
p
 =ğ
L_ESC
) {

80 
p
++;

81 ià(
	`m©ch_şass
(
c
, 
	`uch¬
(*
p
)))

82  
sig
;

84 ià((*(
p
+1è=ğ'-'è&& (p+2 < 
ec
)) {

85 
p
+=2;

86 ià(
	`uch¬
(*(
p
-2)è<ğ
c
 && c <= uchar(*p))

87  
sig
;

89 ià(
	`uch¬
(*
p
è=ğ
c
è 
sig
;

91  !
sig
;

92 
	}
}

95 
	$sšgËm©ch
 (
c
, cÚ¡ *
p
, cÚ¡ *
•
) {

96 *
p
) {

98 
L_ESC
:  
	`m©ch_şass
(
c
, 
	`uch¬
(*(
p
+1)));

99 '[':  
	`m©chb¿ck‘şass
(
c
, 
p
, 
•
-1);

100 :  (
	`uch¬
(*
p
è=ğ
c
);

102 
	}
}

105 cÚ¡ *
m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
);

108 cÚ¡ *
	$m©chb®ªû
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

109 cÚ¡ *
p
) {

110 ià(*
p
 == 0 || *(p+1) == 0)

111 
	`log_”r
("unbalanced…attern");

112 ià(*
s
 !ğ*
p
è 
NULL
;

114 
b
 = *
p
;

115 
e
 = *(
p
+1);

116 
cÚt
 = 1;

117 ++
s
 < 
ms
->
¤c_’d
) {

118 ià(*
s
 =ğ
e
) {

119 ià(--
cÚt
 =ğ0è 
s
+1;

121 ià(*
s
 =ğ
b
è
cÚt
++;

124  
NULL
;

125 
	}
}

128 cÚ¡ *
	$max_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

129 cÚ¡ *
p
, cÚ¡ *
•
) {

130 
i
 = 0;

131 (
s
+
i
è< 
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*(s+i)), 
p
, 
•
))

132 
i
++;

134 
i
>=0) {

135 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, (
s
+
i
), 
•
+1);

136 ià(
»s
) „es;

137 
i
--;

139  
NULL
;

140 
	}
}

143 cÚ¡ *
	$mš_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

144 cÚ¡ *
p
, cÚ¡ *
•
) {

146 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, 
s
, 
•
+1);

147 ià(
»s
 !ğ
NULL
)

148  
»s
;

149 ià(
s
<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*s), 
p
, 
•
))

150 
s
++;

151  
NULL
;

153 
	}
}

156 cÚ¡ *
	$·‰”n_m©ch
(cÚ¡ *
s
, 
size_t
 
Ën
, cÚ¡ *
p
)

158 
M©chS‹
 
ms
 = {.
¤c_š™
 = 
s
, .
¤c_’d
 = s + 
Ën
};

159  
	`m©ch
(&
ms
, 
s
, 
p
);

160 
	}
}

163 cÚ¡ *
	$b¡ršg_m©ch
(
b¡ršg
 
s
, b¡ršg 
·‰”n
)

165 
M©chS‹
 
ms
 = {.
¤c_š™
 = 
	`bd©a
(
s
), .
¤c_’d
 = bd©a(sè+ 
	`bËngth
(s)};

166  
	`m©ch
(&
ms
, 
	`bd©a
(
s
), bd©a(
·‰”n
));

167 
	}
}

169 cÚ¡ *
	$m©ch
(
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
) {

171 
š™
:

172 *
p
) {

174 
p
++;

175 
š™
;

177 
p
++;

178 
š™
;

179 
L_ESC
: {

180 *(
p
+1)) {

182 
s
 = 
	`m©chb®ªû
(
ms
, s, 
p
+2);

183 ià(
s
 =ğ
NULL
)  NULL;

184 
p
+=4; 
š™
;

187 cÚ¡ *
•
; 
´evious
;

188 
p
 += 2;

189 ià(*
p
 != '[')

190 
	`log_”r
("missing '['‡fter \\\\f in…attern");

191 
•
 = 
	`şas£nd
(
ms
, 
p
);

192 
´evious
 = (
s
 =ğ
ms
->
¤c_š™
) ? '\0' : *(s-1);

193 ià(
	`m©chb¿ck‘şass
(
	`uch¬
(
´evious
), 
p
, 
•
-1) ||

194 !
	`m©chb¿ck‘şass
(
	`uch¬
(*
s
), 
p
, 
•
-1)è 
NULL
;

195 
p
=
•
; 
š™
;

198 
dæt
;

203  
s
;

206 ià(*(
p
+1) == '\0')

207  (
s
 =ğ
ms
->
¤c_’d
è? s : 
NULL
;

208 
dæt
;

210 : 
dæt
: {

211 cÚ¡ *
•
 = 
	`şas£nd
(
ms
, 
p
);

212 
m
 = 
s
<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*s), 
p
, 
•
);

213 *
•
) {

215 cÚ¡ *
»s
;

216 ià(
m
 && ((
»s
=
	`m©ch
(
ms
, 
s
+1, 
•
+1)è!ğ
NULL
))

217  
»s
;

218 
p
=
•
+1; 
š™
;

221  
	`max_ex·nd
(
ms
, 
s
, 
p
, 
•
);

224  (
m
 ? 
	`max_ex·nd
(
ms
, 
s
+1, 
p
, 
•
è: 
NULL
);

227  
	`mš_ex·nd
(
ms
, 
s
, 
p
, 
•
);

230 ià(!
m
è 
NULL
;

231 
s
++; 
p
=
•
; 
š™
;

236 
	}
}

	@src/pattern.h

35 #iâdeà
_·‰”n_h


36 
	#_·‰”n_h


	)

38 
	~<b¡ršg.h
>

40 cÚ¡ *
·‰”n_m©ch
(cÚ¡ *
s
, 
size_t
 
Ën
, cÚ¡ *
p
);

42 cÚ¡ *
b¡ršg_m©ch
(
b¡ršg
 
s
, b¡ršg 
·‰”n
);

	@src/polarssl/aes.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_AES_C
)

36 
	~"pŞ¬s¦/«s.h
"

37 
	~"pŞ¬s¦/·dlock.h
"

39 
	~<¡ršg.h
>

44 #iâdeà
GET_ULONG_LE


45 
	#GET_ULONG_LE
(
n
,
b
,
i
) \

47 (
n
èğĞ(è(
b
)[(
i
) ] ) \

48 | ( (è(
b
)[(
i
) + 1] << 8 ) \

49 | ( (è(
b
)[(
i
) + 2] << 16 ) \

50 | ( (è(
b
)[(
i
) + 3] << 24 ); \

51 }

	)

54 #iâdeà
PUT_ULONG_LE


55 
	#PUT_ULONG_LE
(
n
,
b
,
i
) \

57 (
b
)[(
i
è] = (èĞ(
n
) ); \

58 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 16 ); \

60 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 24 ); \

61 }

	)

64 #ià
defšed
(
POLARSSL_AES_ROM_TABLES
)

68 cÚ¡ 
	gFSb
[256] =

107 
	#FT
 \

109 
	`V
(
A5
,63,63,
C6
), V(84,7C,7C,
F8
), V(99,77,77,
EE
), V(8D,7B,7B,
F6
), \

110 
	`V
(0D,
F2
,F2,
FF
), V(
BD
,6B,6B,
D6
), V(
B1
,6F,6F,
DE
), V(54,
C5
,C5,91), \

111 
	`V
(50,30,30,60), V(03,01,01,02), V(
A9
,67,67,
CE
), V(7D,2B,2B,56), \

112 
	`V
(19,
FE
,FE,
E7
), V(62,
D7
,D7,
B5
), V(
E6
,
AB
,AB,4D), V(9A,76,76,
EC
), \

113 
	`V
(45,
CA
,CA,8F), V(9D,82,82,1F), V(40,
C9
,C9,89), V(87,7D,7D,
FA
), \

114 
	`V
(15,
FA
,FA,
EF
), V(
EB
,59,59,
B2
), V(
C9
,47,47,8E), V(0B,
F0
,F0,
FB
), \

115 
	`V
(
EC
,
AD
,AD,41), V(67,
D4
,D4,
B3
), V(
FD
,
A2
,A2,5F), V(
EA
,
AF
,AF,45), \

116 
	`V
(
BF
,9C,9C,23), V(
F7
,
A4
,A4,53), V(96,72,72,
E4
), V(5B,
C0
,C0,9B), \

117 
	`V
(
C2
,
B7
,B7,75), V(1C,
FD
,FD,
E1
), V(
AE
,93,93,3D), V(6A,26,26,4C), \

118 
	`V
(5A,36,36,6C), V(41,3F,3F,7E), V(02,
F7
,F7,
F5
), V(4F,
CC
,CC,83), \

119 
	`V
(5C,34,34,68), V(
F4
,
A5
,A5,51), V(34,
E5
,E5,
D1
), V(08,
F1
,F1,
F9
), \

120 
	`V
(93,71,71,
E2
), V(73,
D8
,D8,
AB
), V(53,31,31,62), V(3F,15,15,2A), \

121 
	`V
(0C,04,04,08), V(52,
C7
,C7,95), V(65,23,23,46), V(5E,
C3
,C3,9D), \

122 
	`V
(28,18,18,30), V(
A1
,96,96,37), V(0F,05,05,0A), V(
B5
,9A,9A,2F), \

123 
	`V
(09,07,07,0E), V(36,12,12,24), V(9B,80,80,1B), V(3D,
E2
,E2,
DF
), \

124 
	`V
(26,
EB
,EB,
CD
), V(69,27,27,4E), V(CD,
B2
,B2,7F), V(9F,75,75,
EA
), \

125 
	`V
(1B,09,09,12), V(9E,83,83,1D), V(74,2C,2C,58), V(2E,1A,1A,34), \

126 
	`V
(2D,1B,1B,36), V(
B2
,6E,6E,
DC
), V(
EE
,5A,5A,
B4
), V(
FB
,
A0
,A0,5B), \

127 
	`V
(
F6
,52,52,
A4
), V(4D,3B,3B,76), V(61,
D6
,D6,
B7
), V(
CE
,
B3
,B3,7D), \

128 
	`V
(7B,29,29,52), V(3E,
E3
,E3,
DD
), V(71,2F,2F,5E), V(97,84,84,13), \

129 
	`V
(
F5
,53,53,
A6
), V(68,
D1
,D1,
B9
), V(00,00,00,00), V(2C,
ED
,ED,
C1
), \

130 
	`V
(60,20,20,40), V(1F,
FC
,FC,
E3
), V(
C8
,
B1
,B1,79), V(
ED
,5B,5B,
B6
), \

131 
	`V
(
BE
,6A,6A,
D4
), V(46,
CB
,CB,8D), V(
D9
,BE,BE,67), V(4B,39,39,72), \

132 
	`V
(
DE
,4A,4A,94), V(
D4
,4C,4C,98), V(
E8
,58,58,
B0
), V(4A,
CF
,CF,85), \

133 
	`V
(6B,
D0
,D0,
BB
), V(2A,
EF
,EF,
C5
), V(
E5
,
AA
,AA,4F), V(16,
FB
,FB,
ED
), \

134 
	`V
(
C5
,43,43,86), V(
D7
,4D,4D,9A), V(55,33,33,66), V(94,85,85,11), \

135 
	`V
(
CF
,45,45,8A), V(10,
F9
,F9,
E9
), V(06,02,02,04), V(81,7F,7F,
FE
), \

136 
	`V
(
F0
,50,50,
A0
), V(44,3C,3C,78), V(
BA
,9F,9F,25), V(
E3
,
A8
,A8,4B), \

137 
	`V
(
F3
,51,51,
A2
), V(
FE
,
A3
,A3,5D), V(
C0
,40,40,80), V(8A,8F,8F,05), \

138 
	`V
(
AD
,92,92,3F), V(
BC
,9D,9D,21), V(48,38,38,70), V(04,
F5
,F5,
F1
), \

139 
	`V
(
DF
,
BC
,BC,63), V(
C1
,
B6
,B6,77), V(75,
DA
,DA,
AF
), V(63,21,21,42), \

140 
	`V
(30,10,10,20), V(1A,
FF
,FF,
E5
), V(0E,
F3
,F3,
FD
), V(6D,
D2
,D2,
BF
), \

141 
	`V
(4C,
CD
,CD,81), V(14,0C,0C,18), V(35,13,13,26), V(2F,
EC
,EC,
C3
), \

142 
	`V
(
E1
,5F,5F,
BE
), V(
A2
,97,97,35), V(
CC
,44,44,88), V(39,17,17,2E), \

143 
	`V
(57,
C4
,C4,93), V(
F2
,
A7
,A7,55), V(82,7E,7E,
FC
), V(47,3D,3D,7A), \

144 
	`V
(
AC
,64,64,
C8
), V(
E7
,5D,5D,
BA
), V(2B,19,19,32), V(95,73,73,
E6
), \

145 
	`V
(
A0
,60,60,
C0
), V(98,81,81,19), V(
D1
,4F,4F,9E), V(7F,
DC
,DC,
A3
), \

146 
	`V
(66,22,22,44), V(7E,2A,2A,54), V(
AB
,90,90,3B), V(83,88,88,0B), \

147 
	`V
(
CA
,46,46,8C), V(29,
EE
,EE,
C7
), V(
D3
,
B8
,B8,6B), V(3C,14,14,28), \

148 
	`V
(79,
DE
,DE,
A7
), V(
E2
,5E,5E,
BC
), V(1D,0B,0B,16), V(76,
DB
,DB,
AD
), \

149 
	`V
(3B,
E0
,E0,
DB
), V(56,32,32,64), V(4E,3A,3A,74), V(1E,0A,0A,14), \

150 
	`V
(
DB
,49,49,92), V(0A,06,06,0C), V(6C,24,24,48), V(
E4
,5C,5C,
B8
), \

151 
	`V
(5D,
C2
,C2,9F), V(6E,
D3
,D3,
BD
), V(
EF
,
AC
,AC,43), V(
A6
,62,62,
C4
), \

152 
	`V
(
A8
,91,91,39), V(
A4
,95,95,31), V(37,
E4
,E4,
D3
), V(8B,79,79,
F2
), \

153 
	`V
(32,
E7
,E7,
D5
), V(43,
C8
,C8,8B), V(59,37,37,6E), V(
B7
,6D,6D,
DA
), \

154 
	`V
(8C,8D,8D,01), V(64,
D5
,D5,
B1
), V(
D2
,4E,4E,9C), V(
E0
,
A9
,A9,49), \

155 
	`V
(
B4
,6C,6C,
D8
), V(
FA
,56,56,
AC
), V(07,
F4
,F4,
F3
), V(25,
EA
,EA,
CF
), \

156 
	`V
(
AF
,65,65,
CA
), V(8E,7A,7A,
F4
), V(
E9
,
AE
,AE,47), V(18,08,08,10), \

157 
	`V
(
D5
,
BA
,BA,6F), V(88,78,78,
F0
), V(6F,25,25,4A), V(72,2E,2E,5C), \

158 
	`V
(24,1C,1C,38), V(
F1
,
A6
,A6,57), V(
C7
,
B4
,B4,73), V(51,
C6
,C6,97), \

159 
	`V
(23,
E8
,E8,
CB
), V(7C,
DD
,DD,
A1
), V(9C,74,74,E8), V(21,1F,1F,3E), \

160 
	`V
(
DD
,4B,4B,96), V(
DC
,
BD
,BD,61), V(86,8B,8B,0D), V(85,8A,8A,0F), \

161 
	`V
(90,70,70,
E0
), V(42,3E,3E,7C), V(
C4
,
B5
,B5,71), V(
AA
,66,66,
CC
), \

162 
	`V
(
D8
,48,48,90), V(05,03,03,06), V(01,
F6
,F6,
F7
), V(12,0E,0E,1C), \

163 
	`V
(
A3
,61,61,
C2
), V(5F,35,35,6A), V(
F9
,57,57,
AE
), V(
D0
,
B9
,B9,69), \

164 
	`V
(91,86,86,17), V(58,
C1
,C1,99), V(27,1D,1D,3A), V(
B9
,9E,9E,27), \

165 
	`V
(38,
E1
,E1,
D9
), V(13,
F8
,F8,
EB
), V(
B3
,98,98,2B), V(33,11,11,22), \

166 
	`V
(
BB
,69,69,
D2
), V(70,
D9
,D9,
A9
), V(89,8E,8E,07), V(
A7
,94,94,33), \

167 
	`V
(
B6
,9B,9B,2D), V(22,1E,1E,3C), V(92,87,87,15), V(20,
E9
,E9,
C9
), \

168 
	`V
(49,
CE
,CE,87), V(
FF
,55,55,
AA
), V(78,28,28,50), V(7A,
DF
,DF,
A5
), \

169 
	`V
(8F,8C,8C,03), V(
F8
,
A1
,A1,59), V(80,89,89,09), V(17,0D,0D,1A), \

170 
	`V
(
DA
,
BF
,BF,65), V(31,
E6
,E6,
D7
), V(
C6
,42,42,84), V(
B8
,68,68,
D0
), \

171 
	`V
(
C3
,41,41,82), V(
B0
,99,99,29), V(77,2D,2D,5A), V(11,0F,0F,1E), \

172 
	`V
(
CB
,
B0
,B0,7B), V(
FC
,54,54,
A8
), V(
D6
,
BB
,BB,6D), V(3A,16,16,2C)

	)

174 
	#V
(
a
,
b
,
c
,
d
è0x##a##b##c##
	)
d

175 cÚ¡ 
	gFT0
[256] = { 
FT
 };

176 #undeà
V


178 
	#V
(
a
,
b
,
c
,
d
è0x##b##c##d##
	)
a

179 cÚ¡ 
	gFT1
[256] = { 
FT
 };

180 #undeà
V


182 
	#V
(
a
,
b
,
c
,
d
è0x##c##d##a##
	)
b

183 cÚ¡ 
	gFT2
[256] = { 
FT
 };

184 #undeà
V


186 
	#V
(
a
,
b
,
c
,
d
è0x##d##a##b##
	)
c

187 cÚ¡ 
	gFT3
[256] = { 
FT
 };

188 #undeà
V


190 #undeà
FT


195 cÚ¡ 
	gRSb
[256] =

234 
	#RT
 \

236 
	`V
(50,
A7
,
F4
,51), V(53,65,41,7E), V(
C3
,
A4
,17,1A), V(96,5E,27,3A), \

237 
	`V
(
CB
,6B,
AB
,3B), V(
F1
,45,9D,1F), V(AB,58,
FA
,
AC
), V(93,03,
E3
,4B), \

238 
	`V
(55,
FA
,30,20), V(
F6
,6D,76,
AD
), V(91,76,
CC
,88), V(25,4C,02,
F5
), \

239 
	`V
(
FC
,
D7
,
E5
,4F), V(D7,
CB
,2A,
C5
), V(80,44,35,26), V(8F,
A3
,62,
B5
), \

240 
	`V
(49,5A,
B1
,
DE
), V(67,1B,
BA
,25), V(98,0E,
EA
,45), V(
E1
,
C0
,
FE
,5D), \

241 
	`V
(02,75,2F,
C3
), V(12,
F0
,4C,81), V(
A3
,97,46,8D), V(
C6
,
F9
,
D3
,6B), \

242 
	`V
(
E7
,5F,8F,03), V(95,9C,92,15), V(
EB
,7A,6D,
BF
), V(
DA
,59,52,95), \

243 
	`V
(2D,83,
BE
,
D4
), V(
D3
,21,74,58), V(29,69,
E0
,49), V(44,
C8
,
C9
,8E), \

244 
	`V
(6A,89,
C2
,75), V(78,79,8E,
F4
), V(6B,3E,58,99), V(
DD
,71,
B9
,27), \

245 
	`V
(
B6
,4F,
E1
,
BE
), V(17,
AD
,88,
F0
), V(66,
AC
,20,
C9
), V(
B4
,3A,
CE
,7D), \

246 
	`V
(18,4A,
DF
,63), V(82,31,1A,
E5
), V(60,33,51,97), V(45,7F,53,62), \

247 
	`V
(
E0
,77,64,
B1
), V(84,
AE
,6B,
BB
), V(1C,
A0
,81,
FE
), V(94,2B,08,
F9
), \

248 
	`V
(58,68,48,70), V(19,
FD
,45,8F), V(87,6C,
DE
,94), V(
B7
,
F8
,7B,52), \

249 
	`V
(23,
D3
,73,
AB
), V(
E2
,02,4B,72), V(57,8F,1F,
E3
), V(2A,AB,55,66), \

250 
	`V
(07,28,
EB
,
B2
), V(03,
C2
,
B5
,2F), V(9A,7B,
C5
,86), V(
A5
,08,37,
D3
), \

251 
	`V
(
F2
,87,28,30), V(
B2
,
A5
,
BF
,23), V(
BA
,6A,03,02), V(5C,82,16,
ED
), \

252 
	`V
(2B,1C,
CF
,8A), V(92,
B4
,79,
A7
), V(
F0
,
F2
,07,
F3
), V(
A1
,
E2
,69,4E), \

253 
	`V
(
CD
,
F4
,
DA
,65), V(
D5
,
BE
,05,06), V(1F,62,34,
D1
), V(8A,
FE
,
A6
,
C4
), \

254 
	`V
(9D,53,2E,34), V(
A0
,55,
F3
,
A2
), V(32,
E1
,8A,05), V(75,
EB
,
F6
,
A4
), \

255 
	`V
(39,
EC
,83,0B), V(
AA
,
EF
,60,40), V(06,9F,71,5E), V(51,10,6E,
BD
), \

256 
	`V
(
F9
,8A,21,3E), V(3D,06,
DD
,96), V(
AE
,05,3E,DD), V(46,
BD
,
E6
,4D), \

257 
	`V
(
B5
,8D,54,91), V(05,5D,
C4
,71), V(6F,
D4
,06,04), V(
FF
,15,50,60), \

258 
	`V
(24,
FB
,98,19), V(97,
E9
,
BD
,
D6
), V(
CC
,43,40,89), V(77,9E,
D9
,67), \

259 
	`V
(
BD
,42,
E8
,
B0
), V(88,8B,89,07), V(38,5B,19,
E7
), V(
DB
,
EE
,
C8
,79), \

260 
	`V
(47,0A,7C,
A1
), V(
E9
,0F,42,7C), V(
C9
,1E,84,
F8
), V(00,00,00,00), \

261 
	`V
(83,86,80,09), V(48,
ED
,2B,32), V(
AC
,70,11,1E), V(4E,72,5A,6C), \

262 
	`V
(
FB
,
FF
,0E,
FD
), V(56,38,85,0F), V(1E,
D5
,
AE
,3D), V(27,39,2D,36), \

263 
	`V
(64,
D9
,0F,0A), V(21,
A6
,5C,68), V(
D1
,54,5B,9B), V(3A,2E,36,24), \

264 
	`V
(
B1
,67,0A,0C), V(0F,
E7
,57,93), V(
D2
,96,
EE
,
B4
), V(9E,91,9B,1B), \

265 
	`V
(4F,
C5
,
C0
,80), V(
A2
,20,
DC
,61), V(69,4B,77,5A), V(16,1A,12,1C), \

266 
	`V
(0A,
BA
,93,
E2
), V(
E5
,2A,
A0
,
C0
), V(43,
E0
,22,3C), V(1D,17,1B,12), \

267 
	`V
(0B,0D,09,0E), V(
AD
,
C7
,8B,
F2
), V(
B9
,
A8
,
B6
,2D), V(
C8
,
A9
,1E,14), \

268 
	`V
(85,19,
F1
,57), V(4C,07,75,
AF
), V(
BB
,
DD
,99,
EE
), V(
FD
,60,7F,
A3
), \

269 
	`V
(9F,26,01,
F7
), V(
BC
,
F5
,72,5C), V(
C5
,3B,66,44), V(34,7E,
FB
,5B), \

270 
	`V
(76,29,43,8B), V(
DC
,
C6
,23,
CB
), V(68,
FC
,
ED
,
B6
), V(63,
F1
,
E4
,
B8
), \

271 
	`V
(
CA
,
DC
,31,
D7
), V(10,85,63,42), V(40,22,97,13), V(20,11,
C6
,84), \

272 
	`V
(7D,24,4A,85), V(
F8
,3D,
BB
,
D2
), V(11,32,
F9
,
AE
), V(6D,
A1
,29,
C7
), \

273 
	`V
(4B,2F,9E,1D), V(
F3
,30,
B2
,
DC
), V(
EC
,52,86,0D), V(
D0
,
E3
,
C1
,77), \

274 
	`V
(6C,16,
B3
,2B), V(99,
B9
,70,
A9
), V(
FA
,48,94,11), V(22,64,
E9
,47), \

275 
	`V
(
C4
,8C,
FC
,
A8
), V(1A,3F,
F0
,
A0
), V(
D8
,2C,7D,56), V(
EF
,90,33,22), \

276 
	`V
(
C7
,4E,49,87), V(
C1
,
D1
,38,
D9
), V(
FE
,
A2
,
CA
,8C), V(36,0B,
D4
,98), \

277 
	`V
(
CF
,81,
F5
,
A6
), V(28,
DE
,7A,
A5
), V(26,8E,
B7
,
DA
), V(
A4
,
BF
,
AD
,3F), \

278 
	`V
(
E4
,9D,3A,2C), V(0D,92,78,50), V(9B,
CC
,5F,6A), V(62,46,7E,54), \

279 
	`V
(
C2
,13,8D,
F6
), V(
E8
,
B8
,
D8
,90), V(5E,
F7
,39,2E), V(
F5
,
AF
,
C3
,82), \

280 
	`V
(
BE
,80,5D,9F), V(7C,93,
D0
,69), V(
A9
,2D,
D5
,6F), V(
B3
,12,25,
CF
), \

281 
	`V
(3B,99,
AC
,
C8
), V(
A7
,7D,18,10), V(6E,63,9C,
E8
), V(7B,
BB
,3B,
DB
), \

282 
	`V
(09,78,26,
CD
), V(
F4
,18,59,6E), V(01,
B7
,9A,
EC
), V(
A8
,9A,4F,83), \

283 
	`V
(65,6E,95,
E6
), V(7E,E6,
FF
,
AA
), V(08,
CF
,
BC
,21), V(E6,
E8
,15,
EF
), \

284 
	`V
(
D9
,9B,
E7
,
BA
), V(
CE
,36,6F,4A), V(
D4
,09,9F,
EA
), V(
D6
,7C,
B0
,29), \

285 
	`V
(
AF
,
B2
,
A4
,31), V(31,23,3F,2A), V(30,94,
A5
,
C6
), V(
C0
,66,
A2
,35), \

286 
	`V
(37,
BC
,4E,74), V(
A6
,
CA
,82,
FC
), V(
B0
,
D0
,90,
E0
), V(15,
D8
,
A7
,33), \

287 
	`V
(4A,98,04,
F1
), V(
F7
,
DA
,
EC
,41), V(0E,50,
CD
,7F), V(2F,
F6
,91,17), \

288 
	`V
(8D,
D6
,4D,76), V(4D,
B0
,
EF
,43), V(54,4D,
AA
,
CC
), V(
DF
,04,96,
E4
), \

289 
	`V
(
E3
,
B5
,
D1
,9E), V(1B,88,6A,4C), V(
B8
,1F,2C,
C1
), V(7F,51,65,46), \

290 
	`V
(04,
EA
,5E,9D), V(5D,35,8C,01), V(73,74,87,
FA
), V(2E,41,0B,
FB
), \

291 
	`V
(5A,1D,67,
B3
), V(52,
D2
,
DB
,92), V(33,56,10,
E9
), V(13,47,
D6
,6D), \

292 
	`V
(8C,61,
D7
,9A), V(7A,0C,
A1
,37), V(8E,14,
F8
,59), V(89,3C,13,
EB
), \

293 
	`V
(
EE
,27,
A9
,
CE
), V(35,
C9
,61,
B7
), V(
ED
,
E5
,1C,
E1
), V(3C,
B1
,47,7A), \

294 
	`V
(59,
DF
,
D2
,9C), V(3F,73,
F2
,55), V(79,
CE
,14,18), V(
BF
,37,
C7
,73), \

295 
	`V
(
EA
,
CD
,
F7
,53), V(5B,
AA
,
FD
,5F), V(14,6F,3D,
DF
), V(86,
DB
,44,78), \

296 
	`V
(81,
F3
,
AF
,
CA
), V(3E,
C4
,68,
B9
), V(2C,34,24,38), V(5F,40,
A3
,
C2
), \

297 
	`V
(72,
C3
,1D,16), V(0C,25,
E2
,
BC
), V(8B,49,3C,28), V(41,95,0D,
FF
), \

298 
	`V
(71,01,
A8
,39), V(
DE
,
B3
,0C,08), V(9C,
E4
,
B4
,
D8
), V(90,
C1
,56,64), \

299 
	`V
(61,84,
CB
,7B), V(70,
B6
,32,
D5
), V(74,5C,6C,48), V(42,57,
B8
,
D0
)

	)

301 
	#V
(
a
,
b
,
c
,
d
è0x##a##b##c##
	)
d

302 cÚ¡ 
	gRT0
[256] = { 
RT
 };

303 #undeà
V


305 
	#V
(
a
,
b
,
c
,
d
è0x##b##c##d##
	)
a

306 cÚ¡ 
	gRT1
[256] = { 
RT
 };

307 #undeà
V


309 
	#V
(
a
,
b
,
c
,
d
è0x##c##d##a##
	)
b

310 cÚ¡ 
	gRT2
[256] = { 
RT
 };

311 #undeà
V


313 
	#V
(
a
,
b
,
c
,
d
è0x##d##a##b##
	)
c

314 cÚ¡ 
	gRT3
[256] = { 
RT
 };

315 #undeà
V


317 #undeà
RT


322 cÚ¡ 
	gRCON
[10] =

334 
	gFSb
[256];

335 
	gFT0
[256];

336 
	gFT1
[256];

337 
	gFT2
[256];

338 
	gFT3
[256];

343 
	gRSb
[256];

344 
	gRT0
[256];

345 
	gRT1
[256];

346 
	gRT2
[256];

347 
	gRT3
[256];

352 
	gRCON
[10];

357 
	#ROTL8
(
x
èĞĞx << 8 ) & 0xFFFFFFFF ) | ( x >> 24 )

	)

358 
	#XTIME
(
x
èĞĞx << 1 ) ^ ( ( x & 0x80 ) ? 0x1B : 0x00 ) )

	)

359 
	#MUL
(
x
,
y
èĞĞx && y ) ? 
pow
[(
log
[x]+log[y]è% 255] : 0 )

	)

361 
	g«s_š™_dÚe
 = 0;

363 
	$«s_g’_bËs
( )

365 
i
, 
x
, 
y
, 
z
;

366 
pow
[256];

367 
log
[256];

372  
i
 = 0, 
x
 = 1; i < 256; i++ )

374 
pow
[
i
] = 
x
;

375 
log
[
x
] = 
i
;

376 
x
 = ( x ^ 
	`XTIME
( x ) ) & 0xFF;

382  
i
 = 0, 
x
 = 1; i < 10; i++ )

384 
RCON
[
i
] = (è
x
;

385 
x
 = 
	`XTIME
( x ) & 0xFF;

391 
FSb
[0x00] = 0x63;

392 
RSb
[0x63] = 0x00;

394  
i
 = 1; i < 256; i++ )

396 
x
 = 
pow
[255 - 
log
[
i
]];

398 
y
 = 
x
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

399 
x
 ^ğ
y
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

400 
x
 ^ğ
y
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

401 
x
 ^ğ
y
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

402 
x
 ^ğ
y
 ^ 0x63;

404 
FSb
[
i
] = (è
x
;

405 
RSb
[
x
] = (è
i
;

411  
i
 = 0; i < 256; i++ )

413 
x
 = 
FSb
[
i
];

414 
y
 = 
	`XTIME
Ğ
x
 ) & 0xFF;

415 
z
 = ( 
y
 ^ 
x
 ) & 0xFF;

417 
FT0
[
i
] = ( (è
y
 ) ^

418 Ğ(è
x
 << 8 ) ^

419 Ğ(è
x
 << 16 ) ^

420 Ğ(è
z
 << 24 );

422 
FT1
[
i
] = 
	`ROTL8
Ğ
FT0
[i] );

423 
FT2
[
i
] = 
	`ROTL8
Ğ
FT1
[i] );

424 
FT3
[
i
] = 
	`ROTL8
Ğ
FT2
[i] );

426 
x
 = 
RSb
[
i
];

428 
RT0
[
i
] = ( (è
	`MUL
Ğ0x0E, 
x
 ) ) ^

429 Ğ(è
	`MUL
Ğ0x09, 
x
 ) << 8 ) ^

430 Ğ(è
	`MUL
Ğ0x0D, 
x
 ) << 16 ) ^

431 Ğ(è
	`MUL
Ğ0x0B, 
x
 ) << 24 );

433 
RT1
[
i
] = 
	`ROTL8
Ğ
RT0
[i] );

434 
RT2
[
i
] = 
	`ROTL8
Ğ
RT1
[i] );

435 
RT3
[
i
] = 
	`ROTL8
Ğ
RT2
[i] );

437 
	}
}

444 
	$«s_£tkey_’c
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

446 
i
;

447 *
RK
;

449 #ià!
	`defšed
(
POLARSSL_AES_ROM_TABLES
)

450 ifĞ
«s_š™_dÚe
 == 0 )

452 
	`«s_g’_bËs
();

453 
«s_š™_dÚe
 = 1;

457  
keysize
 )

459 128: 
ùx
->
Ä
 = 10; ;

460 192: 
ùx
->
Ä
 = 12; ;

461 256: 
ùx
->
Ä
 = 14; ;

462  : Ğ
POLARSSL_ERR_AES_INVALID_KEY_LENGTH
 );

465 #ià
	`defšed
(
PADLOCK_ALIGN16
)

466 
ùx
->
rk
 = 
RK
 = 
	`PADLOCK_ALIGN16
Ğùx->
buf
 );

468 
ùx
->
rk
 = 
RK
 = ctx->
buf
;

471  
i
 = 0; i < (
keysize
 >> 5); i++ )

473 
	`GET_ULONG_LE
Ğ
RK
[
i
], 
key
, i << 2 );

476  
ùx
->
Ä
 )

480  
i
 = 0; i < 10; i++, 
RK
 += 4 )

482 
RK
[4] = RK[0] ^ 
RCON
[
i
] ^

483 Ğ(è
FSb
[ ( 
RK
[3] >> 8 ) & 0xFF ] ) ^

484 Ğ(è
FSb
[ ( 
RK
[3] >> 16 ) & 0xFF ] << 8 ) ^

485 Ğ(è
FSb
[ ( 
RK
[3] >> 24 ) & 0xFF ] << 16 ) ^

486 Ğ(è
FSb
[ ( 
RK
[3] ) & 0xFF ] << 24 );

488 
RK
[5] = RK[1] ^ RK[4];

489 
RK
[6] = RK[2] ^ RK[5];

490 
RK
[7] = RK[3] ^ RK[6];

496  
i
 = 0; i < 8; i++, 
RK
 += 6 )

498 
RK
[6] = RK[0] ^ 
RCON
[
i
] ^

499 Ğ(è
FSb
[ ( 
RK
[5] >> 8 ) & 0xFF ] ) ^

500 Ğ(è
FSb
[ ( 
RK
[5] >> 16 ) & 0xFF ] << 8 ) ^

501 Ğ(è
FSb
[ ( 
RK
[5] >> 24 ) & 0xFF ] << 16 ) ^

502 Ğ(è
FSb
[ ( 
RK
[5] ) & 0xFF ] << 24 );

504 
RK
[7] = RK[1] ^ RK[6];

505 
RK
[8] = RK[2] ^ RK[7];

506 
RK
[9] = RK[3] ^ RK[8];

507 
RK
[10] = RK[4] ^ RK[9];

508 
RK
[11] = RK[5] ^ RK[10];

514  
i
 = 0; i < 7; i++, 
RK
 += 8 )

516 
RK
[8] = RK[0] ^ 
RCON
[
i
] ^

517 Ğ(è
FSb
[ ( 
RK
[7] >> 8 ) & 0xFF ] ) ^

518 Ğ(è
FSb
[ ( 
RK
[7] >> 16 ) & 0xFF ] << 8 ) ^

519 Ğ(è
FSb
[ ( 
RK
[7] >> 24 ) & 0xFF ] << 16 ) ^

520 Ğ(è
FSb
[ ( 
RK
[7] ) & 0xFF ] << 24 );

522 
RK
[9] = RK[1] ^ RK[8];

523 
RK
[10] = RK[2] ^ RK[9];

524 
RK
[11] = RK[3] ^ RK[10];

526 
RK
[12] = RK[4] ^

527 Ğ(è
FSb
[ ( 
RK
[11] ) & 0xFF ] ) ^

528 Ğ(è
FSb
[ ( 
RK
[11] >> 8 ) & 0xFF ] << 8 ) ^

529 Ğ(è
FSb
[ ( 
RK
[11] >> 16 ) & 0xFF ] << 16 ) ^

530 Ğ(è
FSb
[ ( 
RK
[11] >> 24 ) & 0xFF ] << 24 );

532 
RK
[13] = RK[5] ^ RK[12];

533 
RK
[14] = RK[6] ^ RK[13];

534 
RK
[15] = RK[7] ^ RK[14];

544 
	}
}

549 
	$«s_£tkey_dec
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

551 
i
, 
j
;

552 
«s_cÚ‹xt
 
ùy
;

553 *
RK
;

554 *
SK
;

555 
»t
;

557  
keysize
 )

559 128: 
ùx
->
Ä
 = 10; ;

560 192: 
ùx
->
Ä
 = 12; ;

561 256: 
ùx
->
Ä
 = 14; ;

562  : Ğ
POLARSSL_ERR_AES_INVALID_KEY_LENGTH
 );

565 #ià
	`defšed
(
PADLOCK_ALIGN16
)

566 
ùx
->
rk
 = 
RK
 = 
	`PADLOCK_ALIGN16
Ğùx->
buf
 );

568 
ùx
->
rk
 = 
RK
 = ctx->
buf
;

571 
»t
 = 
	`«s_£tkey_’c
Ğ&
ùy
, 
key
, 
keysize
 );

572 ifĞ
»t
 != 0 )

573 Ğ
»t
 );

575 
SK
 = 
ùy
.
rk
 + cty.
Ä
 * 4;

577 *
RK
++ = *
SK
++;

578 *
RK
++ = *
SK
++;

579 *
RK
++ = *
SK
++;

580 *
RK
++ = *
SK
++;

582  
i
 = 
ùx
->
Ä
 - 1, 
SK
 -= 8; i > 0; i--, SK -= 8 )

584  
j
 = 0; j < 4; j++, 
SK
++ )

586 *
RK
++ = 
RT0
[ 
FSb
[ ( *
SK
 ) & 0xFF ] ] ^

587 
RT1
[ 
FSb
[ ( *
SK
 >> 8 ) & 0xFF ] ] ^

588 
RT2
[ 
FSb
[ ( *
SK
 >> 16 ) & 0xFF ] ] ^

589 
RT3
[ 
FSb
[ ( *
SK
 >> 24 ) & 0xFF ] ];

593 *
RK
++ = *
SK
++;

594 *
RK
++ = *
SK
++;

595 *
RK
++ = *
SK
++;

596 *
RK
++ = *
SK
++;

598 
	`mem£t
Ğ&
ùy
, 0, Ğ
«s_cÚ‹xt
 ) );

601 
	}
}

603 
	#AES_FROUND
(
X0
,
X1
,
X2
,
X3
,
Y0
,
Y1
,
Y2
,
Y3
) \

605 
X0
 = *
RK
++ ^ 
FT0
[ ( 
Y0
 ) & 0xFF ] ^ \

606 
FT1
[ ( 
Y1
 >> 8 ) & 0xFF ] ^ \

607 
FT2
[ ( 
Y2
 >> 16 ) & 0xFF ] ^ \

608 
FT3
[ ( 
Y3
 >> 24 ) & 0xFF ]; \

610 
X1
 = *
RK
++ ^ 
FT0
[ ( 
Y1
 ) & 0xFF ] ^ \

611 
FT1
[ ( 
Y2
 >> 8 ) & 0xFF ] ^ \

612 
FT2
[ ( 
Y3
 >> 16 ) & 0xFF ] ^ \

613 
FT3
[ ( 
Y0
 >> 24 ) & 0xFF ]; \

615 
X2
 = *
RK
++ ^ 
FT0
[ ( 
Y2
 ) & 0xFF ] ^ \

616 
FT1
[ ( 
Y3
 >> 8 ) & 0xFF ] ^ \

617 
FT2
[ ( 
Y0
 >> 16 ) & 0xFF ] ^ \

618 
FT3
[ ( 
Y1
 >> 24 ) & 0xFF ]; \

620 
X3
 = *
RK
++ ^ 
FT0
[ ( 
Y3
 ) & 0xFF ] ^ \

621 
FT1
[ ( 
Y0
 >> 8 ) & 0xFF ] ^ \

622 
FT2
[ ( 
Y1
 >> 16 ) & 0xFF ] ^ \

623 
FT3
[ ( 
Y2
 >> 24 ) & 0xFF ]; \

624 }

	)

626 
	#AES_RROUND
(
X0
,
X1
,
X2
,
X3
,
Y0
,
Y1
,
Y2
,
Y3
) \

628 
X0
 = *
RK
++ ^ 
RT0
[ ( 
Y0
 ) & 0xFF ] ^ \

629 
RT1
[ ( 
Y3
 >> 8 ) & 0xFF ] ^ \

630 
RT2
[ ( 
Y2
 >> 16 ) & 0xFF ] ^ \

631 
RT3
[ ( 
Y1
 >> 24 ) & 0xFF ]; \

633 
X1
 = *
RK
++ ^ 
RT0
[ ( 
Y1
 ) & 0xFF ] ^ \

634 
RT1
[ ( 
Y0
 >> 8 ) & 0xFF ] ^ \

635 
RT2
[ ( 
Y3
 >> 16 ) & 0xFF ] ^ \

636 
RT3
[ ( 
Y2
 >> 24 ) & 0xFF ]; \

638 
X2
 = *
RK
++ ^ 
RT0
[ ( 
Y2
 ) & 0xFF ] ^ \

639 
RT1
[ ( 
Y1
 >> 8 ) & 0xFF ] ^ \

640 
RT2
[ ( 
Y0
 >> 16 ) & 0xFF ] ^ \

641 
RT3
[ ( 
Y3
 >> 24 ) & 0xFF ]; \

643 
X3
 = *
RK
++ ^ 
RT0
[ ( 
Y3
 ) & 0xFF ] ^ \

644 
RT1
[ ( 
Y2
 >> 8 ) & 0xFF ] ^ \

645 
RT2
[ ( 
Y1
 >> 16 ) & 0xFF ] ^ \

646 
RT3
[ ( 
Y0
 >> 24 ) & 0xFF ]; \

647 }

	)

652 
	$«s_üy±_ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

653 
mode
,

654 cÚ¡ 
šput
[16],

655 
ouut
[16] )

657 
i
;

658 *
RK
, 
X0
, 
X1
, 
X2
, 
X3
, 
Y0
, 
Y1
, 
Y2
, 
Y3
;

660 #ià
	`defšed
(
POLARSSL_PADLOCK_C
è&& defšed(
POLARSSL_HAVE_X86
)

661 ifĞ
	`·dlock_suµÜts
Ğ
PADLOCK_ACE
 ) )

663 ifĞ
	`·dlock_xüy±ecb
Ğ
ùx
, 
mode
, 
šput
, 
ouut
 ) == 0 )

672 
RK
 = 
ùx
->
rk
;

674 
	`GET_ULONG_LE
Ğ
X0
, 
šput
, 0 ); X0 ^ğ*
RK
++;

675 
	`GET_ULONG_LE
Ğ
X1
, 
šput
, 4 ); X1 ^ğ*
RK
++;

676 
	`GET_ULONG_LE
Ğ
X2
, 
šput
, 8 ); X2 ^ğ*
RK
++;

677 
	`GET_ULONG_LE
Ğ
X3
, 
šput
, 12 ); X3 ^ğ*
RK
++;

679 ifĞ
mode
 =ğ
AES_DECRYPT
 )

681  
i
 = (
ùx
->
Ä
 >> 1) - 1; i > 0; i-- )

683 
	`AES_RROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

684 
	`AES_RROUND
Ğ
X0
, 
X1
, 
X2
, 
X3
, 
Y0
, 
Y1
, 
Y2
, 
Y3
 );

687 
	`AES_RROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

689 
X0
 = *
RK
++ ^ \

690 Ğ(è
RSb
[ ( 
Y0
 ) & 0xFF ] ) ^

691 Ğ(è
RSb
[ ( 
Y3
 >> 8 ) & 0xFF ] << 8 ) ^

692 Ğ(è
RSb
[ ( 
Y2
 >> 16 ) & 0xFF ] << 16 ) ^

693 Ğ(è
RSb
[ ( 
Y1
 >> 24 ) & 0xFF ] << 24 );

695 
X1
 = *
RK
++ ^ \

696 Ğ(è
RSb
[ ( 
Y1
 ) & 0xFF ] ) ^

697 Ğ(è
RSb
[ ( 
Y0
 >> 8 ) & 0xFF ] << 8 ) ^

698 Ğ(è
RSb
[ ( 
Y3
 >> 16 ) & 0xFF ] << 16 ) ^

699 Ğ(è
RSb
[ ( 
Y2
 >> 24 ) & 0xFF ] << 24 );

701 
X2
 = *
RK
++ ^ \

702 Ğ(è
RSb
[ ( 
Y2
 ) & 0xFF ] ) ^

703 Ğ(è
RSb
[ ( 
Y1
 >> 8 ) & 0xFF ] << 8 ) ^

704 Ğ(è
RSb
[ ( 
Y0
 >> 16 ) & 0xFF ] << 16 ) ^

705 Ğ(è
RSb
[ ( 
Y3
 >> 24 ) & 0xFF ] << 24 );

707 
X3
 = *
RK
++ ^ \

708 Ğ(è
RSb
[ ( 
Y3
 ) & 0xFF ] ) ^

709 Ğ(è
RSb
[ ( 
Y2
 >> 8 ) & 0xFF ] << 8 ) ^

710 Ğ(è
RSb
[ ( 
Y1
 >> 16 ) & 0xFF ] << 16 ) ^

711 Ğ(è
RSb
[ ( 
Y0
 >> 24 ) & 0xFF ] << 24 );

715  
i
 = (
ùx
->
Ä
 >> 1) - 1; i > 0; i-- )

717 
	`AES_FROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

718 
	`AES_FROUND
Ğ
X0
, 
X1
, 
X2
, 
X3
, 
Y0
, 
Y1
, 
Y2
, 
Y3
 );

721 
	`AES_FROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

723 
X0
 = *
RK
++ ^ \

724 Ğ(è
FSb
[ ( 
Y0
 ) & 0xFF ] ) ^

725 Ğ(è
FSb
[ ( 
Y1
 >> 8 ) & 0xFF ] << 8 ) ^

726 Ğ(è
FSb
[ ( 
Y2
 >> 16 ) & 0xFF ] << 16 ) ^

727 Ğ(è
FSb
[ ( 
Y3
 >> 24 ) & 0xFF ] << 24 );

729 
X1
 = *
RK
++ ^ \

730 Ğ(è
FSb
[ ( 
Y1
 ) & 0xFF ] ) ^

731 Ğ(è
FSb
[ ( 
Y2
 >> 8 ) & 0xFF ] << 8 ) ^

732 Ğ(è
FSb
[ ( 
Y3
 >> 16 ) & 0xFF ] << 16 ) ^

733 Ğ(è
FSb
[ ( 
Y0
 >> 24 ) & 0xFF ] << 24 );

735 
X2
 = *
RK
++ ^ \

736 Ğ(è
FSb
[ ( 
Y2
 ) & 0xFF ] ) ^

737 Ğ(è
FSb
[ ( 
Y3
 >> 8 ) & 0xFF ] << 8 ) ^

738 Ğ(è
FSb
[ ( 
Y0
 >> 16 ) & 0xFF ] << 16 ) ^

739 Ğ(è
FSb
[ ( 
Y1
 >> 24 ) & 0xFF ] << 24 );

741 
X3
 = *
RK
++ ^ \

742 Ğ(è
FSb
[ ( 
Y3
 ) & 0xFF ] ) ^

743 Ğ(è
FSb
[ ( 
Y0
 >> 8 ) & 0xFF ] << 8 ) ^

744 Ğ(è
FSb
[ ( 
Y1
 >> 16 ) & 0xFF ] << 16 ) ^

745 Ğ(è
FSb
[ ( 
Y2
 >> 24 ) & 0xFF ] << 24 );

748 
	`PUT_ULONG_LE
Ğ
X0
, 
ouut
, 0 );

749 
	`PUT_ULONG_LE
Ğ
X1
, 
ouut
, 4 );

750 
	`PUT_ULONG_LE
Ğ
X2
, 
ouut
, 8 );

751 
	`PUT_ULONG_LE
Ğ
X3
, 
ouut
, 12 );

754 
	}
}

759 
	$«s_üy±_cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

760 
mode
,

761 
Ëngth
,

762 
iv
[16],

763 cÚ¡ *
šput
,

764 *
ouut
 )

766 
i
;

767 
‹mp
[16];

769 ifĞ
Ëngth
 % 16 )

770 Ğ
POLARSSL_ERR_AES_INVALID_INPUT_LENGTH
 );

772 #ià
	`defšed
(
POLARSSL_PADLOCK_C
è&& defšed(
POLARSSL_HAVE_X86
)

773 ifĞ
	`·dlock_suµÜts
Ğ
PADLOCK_ACE
 ) )

775 ifĞ
	`·dlock_xüy±cbc
Ğ
ùx
, 
mode
, 
Ëngth
, 
iv
, 
šput
, 
ouut
 ) == 0 )

784 ifĞ
mode
 =ğ
AES_DECRYPT
 )

786  
Ëngth
 > 0 )

788 
	`memıy
Ğ
‹mp
, 
šput
, 16 );

789 
	`«s_üy±_ecb
Ğ
ùx
, 
mode
, 
šput
, 
ouut
 );

791  
i
 = 0; i < 16; i++ )

792 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

794 
	`memıy
Ğ
iv
, 
‹mp
, 16 );

796 
šput
 += 16;

797 
ouut
 += 16;

798 
Ëngth
 -= 16;

803  
Ëngth
 > 0 )

805  
i
 = 0; i < 16; i++ )

806 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

808 
	`«s_üy±_ecb
Ğ
ùx
, 
mode
, 
ouut
, output );

809 
	`memıy
Ğ
iv
, 
ouut
, 16 );

811 
šput
 += 16;

812 
ouut
 += 16;

813 
Ëngth
 -= 16;

818 
	}
}

823 
	$«s_üy±_cfb128
Ğ
«s_cÚ‹xt
 *
ùx
,

824 
mode
,

825 
Ëngth
,

826 *
iv_off
,

827 
iv
[16],

828 cÚ¡ *
šput
,

829 *
ouut
 )

831 
c
, 
n
 = *
iv_off
;

833 ifĞ
mode
 =ğ
AES_DECRYPT
 )

835  
Ëngth
-- )

837 ifĞ
n
 == 0 )

838 
	`«s_üy±_ecb
Ğ
ùx
, 
AES_ENCRYPT
, 
iv
, iv );

840 
c
 = *
šput
++;

841 *
ouut
++ = ()Ğ
c
 ^ 
iv
[
n
] );

842 
iv
[
n
] = (è
c
;

844 
n
 = (n + 1) & 0x0F;

849  
Ëngth
-- )

851 ifĞ
n
 == 0 )

852 
	`«s_üy±_ecb
Ğ
ùx
, 
AES_ENCRYPT
, 
iv
, iv );

854 
iv
[
n
] = *
ouut
++ = ()Ğiv[n] ^ *
šput
++ );

856 
n
 = (n + 1) & 0x0F;

860 *
iv_off
 = 
n
;

863 
	}
}

865 #ià
defšed
(
POLARSSL_SELF_TEST
)

867 
	~<¡dio.h
>

874 cÚ¡ 
	g«s_‹¡_ecb_dec
[3][16] =

884 cÚ¡ 
	g«s_‹¡_ecb_’c
[3][16] =

894 cÚ¡ 
	g«s_‹¡_cbc_dec
[3][16] =

904 cÚ¡ 
	g«s_‹¡_cbc_’c
[3][16] =

919 cÚ¡ 
	g«s_‹¡_cfb128_key
[3][32] =

932 cÚ¡ 
	g«s_‹¡_cfb128_iv
[16] =

938 cÚ¡ 
	g«s_‹¡_cfb128_±
[64] =

950 cÚ¡ 
	g«s_‹¡_cfb128_ù
[3][64] =

981 
	$«s_£lf_‹¡
Ğ
v”bo£
 )

983 
i
, 
j
, 
u
, 
v
, 
off£t
;

984 
key
[32];

985 
buf
[64];

986 
´v
[16];

987 
iv
[16];

988 
«s_cÚ‹xt
 
ùx
;

990 
	`mem£t
Ğ
key
, 0, 32 );

995  
i
 = 0; i < 6; i++ )

997 
u
 = 
i
 >> 1;

998 
v
 = 
i
 & 1;

1000 ifĞ
v”bo£
 != 0 )

1001 
	`´štf
Ğ" AES-ECB-%3d (%s): ", 128 + 
u
 * 64,

1002 Ğ
v
 =ğ
AES_DECRYPT
 ) ? "dec" : "enc" );

1004 
	`mem£t
Ğ
buf
, 0, 16 );

1006 ifĞ
v
 =ğ
AES_DECRYPT
 )

1008 
	`«s_£tkey_dec
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1010  
j
 = 0; j < 10000; j++ )

1011 
	`«s_üy±_ecb
Ğ&
ùx
, 
v
, 
buf
, buf );

1013 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_ecb_dec
[
u
], 16 ) != 0 )

1015 ifĞ
v”bo£
 != 0 )

1016 
	`´štf
( "failed\n" );

1023 
	`«s_£tkey_’c
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1025  
j
 = 0; j < 10000; j++ )

1026 
	`«s_üy±_ecb
Ğ&
ùx
, 
v
, 
buf
, buf );

1028 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_ecb_’c
[
u
], 16 ) != 0 )

1030 ifĞ
v”bo£
 != 0 )

1031 
	`´štf
( "failed\n" );

1037 ifĞ
v”bo£
 != 0 )

1038 
	`´štf
( "passed\n" );

1041 ifĞ
v”bo£
 != 0 )

1042 
	`´štf
( "\n" );

1047  
i
 = 0; i < 6; i++ )

1049 
u
 = 
i
 >> 1;

1050 
v
 = 
i
 & 1;

1052 ifĞ
v”bo£
 != 0 )

1053 
	`´štf
Ğ" AES-CBC-%3d (%s): ", 128 + 
u
 * 64,

1054 Ğ
v
 =ğ
AES_DECRYPT
 ) ? "dec" : "enc" );

1056 
	`mem£t
Ğ
iv
 , 0, 16 );

1057 
	`mem£t
Ğ
´v
, 0, 16 );

1058 
	`mem£t
Ğ
buf
, 0, 16 );

1060 ifĞ
v
 =ğ
AES_DECRYPT
 )

1062 
	`«s_£tkey_dec
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1064  
j
 = 0; j < 10000; j++ )

1065 
	`«s_üy±_cbc
Ğ&
ùx
, 
v
, 16, 
iv
, 
buf
, buf );

1067 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_cbc_dec
[
u
], 16 ) != 0 )

1069 ifĞ
v”bo£
 != 0 )

1070 
	`´štf
( "failed\n" );

1077 
	`«s_£tkey_’c
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1079  
j
 = 0; j < 10000; j++ )

1081 
tmp
[16];

1083 
	`«s_üy±_cbc
Ğ&
ùx
, 
v
, 16, 
iv
, 
buf
, buf );

1085 
	`memıy
Ğ
tmp
, 
´v
, 16 );

1086 
	`memıy
Ğ
´v
, 
buf
, 16 );

1087 
	`memıy
Ğ
buf
, 
tmp
, 16 );

1090 ifĞ
	`memcmp
Ğ
´v
, 
«s_‹¡_cbc_’c
[
u
], 16 ) != 0 )

1092 ifĞ
v”bo£
 != 0 )

1093 
	`´štf
( "failed\n" );

1099 ifĞ
v”bo£
 != 0 )

1100 
	`´štf
( "passed\n" );

1103 ifĞ
v”bo£
 != 0 )

1104 
	`´štf
( "\n" );

1109  
i
 = 0; i < 6; i++ )

1111 
u
 = 
i
 >> 1;

1112 
v
 = 
i
 & 1;

1114 ifĞ
v”bo£
 != 0 )

1115 
	`´štf
Ğ" AES-CFB128-%3d (%s): ", 128 + 
u
 * 64,

1116 Ğ
v
 =ğ
AES_DECRYPT
 ) ? "dec" : "enc" );

1118 
	`memıy
Ğ
iv
, 
«s_‹¡_cfb128_iv
, 16 );

1119 
	`memıy
Ğ
key
, 
«s_‹¡_cfb128_key
[
u
], 16 + u * 8 );

1121 
off£t
 = 0;

1122 
	`«s_£tkey_’c
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1124 ifĞ
v
 =ğ
AES_DECRYPT
 )

1126 
	`memıy
Ğ
buf
, 
«s_‹¡_cfb128_ù
[
u
], 64 );

1127 
	`«s_üy±_cfb128
Ğ&
ùx
, 
v
, 64, &
off£t
, 
iv
, 
buf
, buf );

1129 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_cfb128_±
, 64 ) != 0 )

1131 ifĞ
v”bo£
 != 0 )

1132 
	`´štf
( "failed\n" );

1139 
	`memıy
Ğ
buf
, 
«s_‹¡_cfb128_±
, 64 );

1140 
	`«s_üy±_cfb128
Ğ&
ùx
, 
v
, 64, &
off£t
, 
iv
, 
buf
, buf );

1142 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_cfb128_ù
[
u
], 64 ) != 0 )

1144 ifĞ
v”bo£
 != 0 )

1145 
	`´štf
( "failed\n" );

1151 ifĞ
v”bo£
 != 0 )

1152 
	`´štf
( "passed\n" );

1156 ifĞ
v”bo£
 != 0 )

1157 
	`´štf
( "\n" );

1160 
	}
}

	@src/polarssl/aes.h

25 #iâdeà
POLARSSL_AES_H


26 
	#POLARSSL_AES_H


	)

28 
	#AES_ENCRYPT
 1

	)

29 
	#AES_DECRYPT
 0

	)

31 
	#POLARSSL_ERR_AES_INVALID_KEY_LENGTH
 -0x0800

	)

32 
	#POLARSSL_ERR_AES_INVALID_INPUT_LENGTH
 -0x0810

	)

39 
	mÄ
;

40 *
	mrk
;

41 
	mbuf
[68];

43 
	t«s_cÚ‹xt
;

45 #ifdeà
__ılu¥lus


58 
«s_£tkey_’c
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

69 
«s_£tkey_dec
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

81 
«s_üy±_ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

82 
mode
,

83 cÚ¡ 
šput
[16],

84 
ouut
[16] );

100 
«s_üy±_cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

101 
mode
,

102 
Ëngth
,

103 
iv
[16],

104 cÚ¡ *
šput
,

105 *
ouut
 );

120 
«s_üy±_cfb128
Ğ
«s_cÚ‹xt
 *
ùx
,

121 
mode
,

122 
Ëngth
,

123 *
iv_off
,

124 
iv
[16],

125 cÚ¡ *
šput
,

126 *
ouut
 );

133 
«s_£lf_‹¡
Ğ
v”bo£
 );

135 #ifdeà
__ılu¥lus


	@src/polarssl/arc4.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_ARC4_C
)

35 
	~"pŞ¬s¦/¬c4.h
"

40 
	$¬c4_£tup
Ğ
¬c4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

42 
i
, 
j
, 
k
, 
a
;

43 *
m
;

45 
ùx
->
x
 = 0;

46 
ùx
->
y
 = 0;

47 
m
 = 
ùx
->m;

49  
i
 = 0; i < 256; i++ )

50 
m
[
i
] = () i;

52 
j
 = 
k
 = 0;

54  
i
 = 0; i < 256; i++, 
k
++ )

56 ifĞ
k
 >ğ
keyËn
 ) k = 0;

58 
a
 = 
m
[
i
];

59 
j
 = ( j + 
a
 + 
key
[
k
] ) & 0xFF;

60 
m
[
i
] = m[
j
];

61 
m
[
j
] = (è
a
;

63 
	}
}

68 
	$¬c4_üy±
Ğ
¬c4_cÚ‹xt
 *
ùx
, 
Ëngth
, cÚ¡ *
šput
,

69 *
ouut
 )

71 
i
, 
x
, 
y
, 
a
, 
b
;

72 *
m
;

74 
x
 = 
ùx
->x;

75 
y
 = 
ùx
->y;

76 
m
 = 
ùx
->m;

78  
i
 = 0; i < 
Ëngth
; i++ )

80 
x
 = ( x + 1 ) & 0xFF; 
a
 = 
m
[x];

81 
y
 = ( y + 
a
 ) & 0xFF; 
b
 = 
m
[y];

83 
m
[
x
] = (è
b
;

84 
m
[
y
] = (è
a
;

86 
ouut
[
i
] = ()

87 Ğ
šput
[
i
] ^ 
m
[()Ğ
a
 + 
b
 )] );

90 
ùx
->
x
 = x;

91 
ùx
->
y
 = y;

94 
	}
}

96 #ià
defšed
(
POLARSSL_SELF_TEST
)

98 
	~<¡ršg.h
>

99 
	~<¡dio.h
>

106 cÚ¡ 
	g¬c4_‹¡_key
[3][8] =

113 cÚ¡ 
	g¬c4_‹¡_±
[3][8] =

120 cÚ¡ 
	g¬c4_‹¡_ù
[3][8] =

130 
	$¬c4_£lf_‹¡
Ğ
v”bo£
 )

132 
i
;

133 
ibuf
[8];

134 
obuf
[8];

135 
¬c4_cÚ‹xt
 
ùx
;

137  
i
 = 0; i < 3; i++ )

139 ifĞ
v”bo£
 != 0 )

140 
	`´štf
Ğ" ARC4e¡ #%d: ", 
i
 + 1 );

142 
	`memıy
Ğ
ibuf
, 
¬c4_‹¡_±
[
i
], 8 );

144 
	`¬c4_£tup
Ğ&
ùx
, (*è
¬c4_‹¡_key
[
i
], 8 );

145 
	`¬c4_üy±
Ğ&
ùx
, 8, 
ibuf
, 
obuf
 );

147 ifĞ
	`memcmp
Ğ
obuf
, 
¬c4_‹¡_ù
[
i
], 8 ) != 0 )

149 ifĞ
v”bo£
 != 0 )

150 
	`´štf
( "failed\n" );

155 ifĞ
v”bo£
 != 0 )

156 
	`´štf
( "passed\n" );

159 ifĞ
v”bo£
 != 0 )

160 
	`´štf
( "\n" );

163 
	}
}

	@src/polarssl/arc4.h

25 #iâdeà
POLARSSL_ARC4_H


26 
	#POLARSSL_ARC4_H


	)

33 
	mx
;

34 
	my
;

35 
	mm
[256];

37 
	t¬c4_cÚ‹xt
;

39 #ifdeà
__ılu¥lus


50 
¬c4_£tup
Ğ
¬c4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

62 
¬c4_üy±
Ğ
¬c4_cÚ‹xt
 *
ùx
, 
Ëngth
, cÚ¡ *
šput
,

63 *
ouut
 );

70 
¬c4_£lf_‹¡
Ğ
v”bo£
 );

72 #ifdeà
__ılu¥lus


	@src/polarssl/base64.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_BASE64_C
)

30 
	~"pŞ¬s¦/ba£64.h
"

32 cÚ¡ 
	gba£64_’c_m­
[64] =

43 cÚ¡ 
	gba£64_dec_m­
[128] =

63 
	$ba£64_’code
Ğ*
d¡
, *
dËn
,

64 cÚ¡ *
¤c
, 
¦’
 )

66 
i
, 
n
;

67 
C1
, 
C2
, 
C3
;

68 *
p
;

70 ifĞ
¦’
 == 0 )

73 
n
 = (
¦’
 << 3) / 6;

75  (
¦’
 << 3è- (
n
 * 6) )

77 2: 
n
 += 3; ;

78 4: 
n
 += 2; ;

82 ifĞ*
dËn
 < 
n
 + 1 )

84 *
dËn
 = 
n
 + 1;

85 Ğ
POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL
 );

88 
n
 = (
¦’
 / 3) * 3;

90  
i
 = 0, 
p
 = 
d¡
; i < 
n
; i += 3 )

92 
C1
 = *
¤c
++;

93 
C2
 = *
¤c
++;

94 
C3
 = *
¤c
++;

96 *
p
++ = 
ba£64_’c_m­
[(
C1
 >> 2) & 0x3F];

97 *
p
++ = 
ba£64_’c_m­
[(((
C1
 & 3è<< 4è+ (
C2
 >> 4)) & 0x3F];

98 *
p
++ = 
ba£64_’c_m­
[(((
C2
 & 15è<< 2è+ (
C3
 >> 6)) & 0x3F];

99 *
p
++ = 
ba£64_’c_m­
[
C3
 & 0x3F];

102 ifĞ
i
 < 
¦’
 )

104 
C1
 = *
¤c
++;

105 
C2
 = ((
i
 + 1è< 
¦’
è? *
¤c
++ : 0;

107 *
p
++ = 
ba£64_’c_m­
[(
C1
 >> 2) & 0x3F];

108 *
p
++ = 
ba£64_’c_m­
[(((
C1
 & 3è<< 4è+ (
C2
 >> 4)) & 0x3F];

110 ifĞ(
i
 + 1è< 
¦’
 )

111 *
p
++ = 
ba£64_’c_m­
[((
C2
 & 15) << 2) & 0x3F];

112 *
p
++ = '=';

114 *
p
++ = '=';

117 *
dËn
 = 
p
 - 
d¡
;

118 *
p
 = 0;

121 
	}
}

126 
	$ba£64_decode
Ğ*
d¡
, *
dËn
,

127 cÚ¡ *
¤c
, 
¦’
 )

129 
i
, 
j
, 
n
;

130 
x
;

131 *
p
;

133  
i
 = 
j
 = 
n
 = 0; i < 
¦’
; i++ )

135 ifĞĞ
¦’
 - 
i
 ) >= 2 &&

136 
¤c
[
i
] == '\r' && src[i + 1] == '\n' )

139 ifĞ
¤c
[
i
] == '\n' )

142 ifĞ
¤c
[
i
] =ğ'=' && ++
j
 > 2 )

143 Ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 );

145 ifĞ
¤c
[
i
] > 127 || 
ba£64_dec_m­
[src[i]] == 127 )

146 Ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 );

148 ifĞ
ba£64_dec_m­
[
¤c
[
i
]] < 64 && 
j
 != 0 )

149 Ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 );

151 
n
++;

154 ifĞ
n
 == 0 )

157 
n
 = ((n * 6) + 7) >> 3;

159 ifĞ*
dËn
 < 
n
 )

161 *
dËn
 = 
n
;

162 Ğ
POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL
 );

165  
j
 = 3, 
n
 = 
x
 = 0, 
p
 = 
d¡
; 
i
 > 0; i--, 
¤c
++ )

167 ifĞ*
¤c
 == '\r' || *src == '\n' )

170 
j
 -ğĞ
ba£64_dec_m­
[*
¤c
] == 64 );

171 
x
 = (x << 6è| ( 
ba£64_dec_m­
[*
¤c
] & 0x3F );

173 ifĞ++
n
 == 4 )

175 
n
 = 0;

176 ifĞ
j
 > 0 ) *
p
++ = ()Ğ
x
 >> 16 );

177 ifĞ
j
 > 1 ) *
p
++ = ()Ğ
x
 >> 8 );

178 ifĞ
j
 > 2 ) *
p
++ = ()Ğ
x
 );

182 *
dËn
 = 
p
 - 
d¡
;

185 
	}
}

187 #ià
defšed
(
POLARSSL_SELF_TEST
)

189 
	~<¡ršg.h
>

190 
	~<¡dio.h
>

192 cÚ¡ 
	gba£64_‹¡_dec
[64] =

204 cÚ¡ 
	gba£64_‹¡_’c
[] =

211 
	$ba£64_£lf_‹¡
Ğ
v”bo£
 )

213 
Ën
;

214 *
¤c
, 
bufãr
[128];

216 ifĞ
v”bo£
 != 0 )

217 
	`´štf
( " Base64ƒncodingest: " );

219 
Ën
 = Ğ
bufãr
 );

220 
¤c
 = (*è
ba£64_‹¡_dec
;

222 ifĞ
	`ba£64_’code
Ğ
bufãr
, &
Ën
, 
¤c
, 64 ) != 0 ||

223 
	`memcmp
Ğ
ba£64_‹¡_’c
, 
bufãr
, 88 ) != 0 )

225 ifĞ
v”bo£
 != 0 )

226 
	`´štf
( "failed\n" );

231 ifĞ
v”bo£
 != 0 )

232 
	`´štf
( "passed\n Base64 decodingest: " );

234 
Ën
 = Ğ
bufãr
 );

235 
¤c
 = (*è
ba£64_‹¡_’c
;

237 ifĞ
	`ba£64_decode
Ğ
bufãr
, &
Ën
, 
¤c
, 88 ) != 0 ||

238 
	`memcmp
Ğ
ba£64_‹¡_dec
, 
bufãr
, 64 ) != 0 )

240 ifĞ
v”bo£
 != 0 )

241 
	`´štf
( "failed\n" );

246 ifĞ
v”bo£
 != 0 )

247 
	`´štf
( "passed\n\n" );

250 
	}
}

	@src/polarssl/base64.h

25 #iâdeà
POLARSSL_BASE64_H


26 
	#POLARSSL_BASE64_H


	)

28 
	#POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL
 0x0010

	)

29 
	#POLARSSL_ERR_BASE64_INVALID_CHARACTER
 0x0012

	)

31 #ifdeà
__ılu¥lus


50 
ba£64_’code
Ğ*
d¡
, *
dËn
,

51 cÚ¡ *
¤c
, 
¦’
 );

69 
ba£64_decode
Ğ*
d¡
, *
dËn
,

70 cÚ¡ *
¤c
, 
¦’
 );

77 
ba£64_£lf_‹¡
Ğ
v”bo£
 );

79 #ifdeà
__ılu¥lus


	@src/polarssl/bignum.c

33 
	~"pŞ¬s¦/cÚfig.h
"

35 #ià
defšed
(
POLARSSL_BIGNUM_C
)

37 
	~"pŞ¬s¦/bignum.h
"

38 
	~"pŞ¬s¦/bn_mul.h
"

40 
	~<¡ršg.h
>

41 
	~<¡dlib.h
>

42 
	~<¡d¬g.h
>

44 
	#ciL
 ((è(
t_št
)è

	)

45 
	#biL
 (
ciL
 << 3è

	)

46 
	#biH
 (
ciL
 << 2è

	)

51 
	#BITS_TO_LIMBS
(
i
è(((iè+ 
biL
 - 1è/ biL)

	)

52 
	#CHARS_TO_LIMBS
(
i
è(((iè+ 
ciL
 - 1è/ ciL)

	)

57 
	$mpi_š™
Ğ
mpi
 *
X
, ... )

59 
va_li¡
 
¬gs
;

61 
	`va_¡¬t
Ğ
¬gs
, 
X
 );

63  
X
 !ğ
NULL
 )

65 
X
->
s
 = 1;

66 
X
->
n
 = 0;

67 
X
->
p
 = 
NULL
;

69 
X
 = 
	`va_¬g
Ğ
¬gs
, 
mpi
* );

72 
	`va_’d
Ğ
¬gs
 );

73 
	}
}

78 
	$mpi_ä“
Ğ
mpi
 *
X
, ... )

80 
va_li¡
 
¬gs
;

82 
	`va_¡¬t
Ğ
¬gs
, 
X
 );

84  
X
 !ğ
NULL
 )

86 ifĞ
X
->
p
 !ğ
NULL
 )

88 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

89 
	`ä“
Ğ
X
->
p
 );

92 
X
->
s
 = 1;

93 
X
->
n
 = 0;

94 
X
->
p
 = 
NULL
;

96 
X
 = 
	`va_¬g
Ğ
¬gs
, 
mpi
* );

99 
	`va_’d
Ğ
¬gs
 );

100 
	}
}

105 
	$mpi_grow
Ğ
mpi
 *
X
, 
nblimbs
 )

107 
t_št
 *
p
;

109 ifĞ
X
->
n
 < 
nblimbs
 )

111 ifĞĞ
p
 = (
t_št
 *è
	`m®loc
Ğ
nblimbs
 * 
ciL
 ) ) =ğ
NULL
 )

114 
	`mem£t
Ğ
p
, 0, 
nblimbs
 * 
ciL
 );

116 ifĞ
X
->
p
 !ğ
NULL
 )

118 
	`memıy
Ğ
p
, 
X
->p, X->
n
 * 
ciL
 );

119 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

120 
	`ä“
Ğ
X
->
p
 );

123 
X
->
n
 = 
nblimbs
;

124 
X
->
p
 =…;

128 
	}
}

133 
	$mpi_cİy
Ğ
mpi
 *
X
, cÚ¡ mp˜*
Y
 )

135 
»t
, 
i
;

137 ifĞ
X
 =ğ
Y
 )

140  
i
 = 
Y
->
n
 - 1; i > 0; i-- )

141 ifĞ
Y
->
p
[
i
] != 0 )

143 
i
++;

145 
X
->
s
 = 
Y
->s;

147 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
i
 ) );

149 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

150 
	`memıy
Ğ
X
->
p
, 
Y
->p, 
i
 * 
ciL
 );

152 
ş—nup
:

154 Ğ
»t
 );

155 
	}
}

160 
	$mpi_sw­
Ğ
mpi
 *
X
, mp˜*
Y
 )

162 
mpi
 
T
;

164 
	`memıy
Ğ&
T
, 
X
, Ğ
mpi
 ) );

165 
	`memıy
Ğ
X
, 
Y
, Ğ
mpi
 ) );

166 
	`memıy
Ğ
Y
, &
T
, Ğ
mpi
 ) );

167 
	}
}

172 
	$mpi_l£t
Ğ
mpi
 *
X
, 
z
 )

174 
»t
;

176 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 1 ) );

177 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

179 
X
->
p
[0] = ( 
z
 < 0 ) ? -z : z;

180 
X
->
s
 = ( 
z
 < 0 ) ? -1 : 1;

182 
ş—nup
:

184 Ğ
»t
 );

185 
	}
}

190 
	$mpi_lsb
ĞcÚ¡ 
mpi
 *
X
 )

192 
i
, 
j
, 
couÁ
 = 0;

194  
i
 = 0; i < 
X
->
n
; i++ )

195  
j
 = 0; j < (è
biL
; j++, 
couÁ
++ )

196 ifĞĞĞ
X
->
p
[
i
] >> 
j
 ) & 1 ) != 0 )

197 Ğ
couÁ
 );

200 
	}
}

205 
	$mpi_msb
ĞcÚ¡ 
mpi
 *
X
 )

207 
i
, 
j
;

209  
i
 = 
X
->
n
 - 1; i > 0; i-- )

210 ifĞ
X
->
p
[
i
] != 0 )

213  
j
 = 
biL
 - 1; j >= 0; j-- )

214 ifĞĞĞ
X
->
p
[
i
] >> 
j
 ) & 1 ) != 0 )

217 ĞĞ
i
 * 
biL
 ) + 
j
 + 1 );

218 
	}
}

223 
	$mpi_size
ĞcÚ¡ 
mpi
 *
X
 )

225 ĞĞ
	`mpi_msb
Ğ
X
 ) + 7 ) >> 3 );

226 
	}
}

231 
	$mpi_g‘_dig™
Ğ
t_št
 *
d
, 
¿dix
, 
c
 )

233 *
d
 = 255;

235 ifĞ
c
 >ğ0x30 && c <ğ0x39 ) *
d
 = c - 0x30;

236 ifĞ
c
 >ğ0x41 && c <ğ0x46 ) *
d
 = c - 0x37;

237 ifĞ
c
 >ğ0x61 && c <ğ0x66 ) *
d
 = c - 0x57;

239 ifĞ*
d
 >ğ(
t_št
è
¿dix
 )

240 Ğ
POLARSSL_ERR_MPI_INVALID_CHARACTER
 );

243 
	}
}

248 
	$mpi_»ad_¡ršg
Ğ
mpi
 *
X
, 
¿dix
, cÚ¡ *
s
 )

250 
»t
, 
i
, 
j
, 
n
, 
¦’
;

251 
t_št
 
d
;

252 
mpi
 
T
;

254 ifĞ
¿dix
 < 2 ||„adix > 16 )

255 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

257 
	`mpi_š™
Ğ&
T
, 
NULL
 );

259 
¦’
 = 
	`¡¾’
Ğ
s
 );

261 ifĞ
¿dix
 == 16 )

263 
n
 = 
	`BITS_TO_LIMBS
Ğ
¦’
 << 2 );

265 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
n
 ) );

266 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

268  
i
 = 
¦’
 - 1, 
j
 = 0; i >= 0; i--, j++ )

270 ifĞ
i
 =ğ0 && 
s
[i] == '-' )

272 
X
->
s
 = -1;

276 
	`MPI_CHK
Ğ
	`mpi_g‘_dig™
Ğ&
d
, 
¿dix
, 
s
[
i
] ) );

277 
X
->
p
[
j
 / (2 * 
ciL
)] |ğ
d
 << ( (j % (2 * ciL)) << 2 );

282 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

284  
i
 = 0; i < 
¦’
; i++ )

286 ifĞ
i
 =ğ0 && 
s
[i] == '-' )

288 
X
->
s
 = -1;

292 
	`MPI_CHK
Ğ
	`mpi_g‘_dig™
Ğ&
d
, 
¿dix
, 
s
[
i
] ) );

293 
	`MPI_CHK
Ğ
	`mpi_mul_št
Ğ&
T
, 
X
, 
¿dix
 ) );

295 ifĞ
X
->
s
 == 1 )

297 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ
X
, &
T
, 
d
 ) );

301 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ
X
, &
T
, 
d
 ) );

306 
ş—nup
:

308 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

310 Ğ
»t
 );

311 
	}
}

316 
	$mpi_wr™e_hÍ
Ğ
mpi
 *
X
, 
¿dix
, **
p
 )

318 
»t
;

319 
t_št
 
r
;

321 ifĞ
¿dix
 < 2 ||„adix > 16 )

322 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

324 
	`MPI_CHK
Ğ
	`mpi_mod_št
Ğ&
r
, 
X
, 
¿dix
 ) );

325 
	`MPI_CHK
Ğ
	`mpi_div_št
Ğ
X
, 
NULL
, X, 
¿dix
 ) );

327 ifĞ
	`mpi_cmp_št
Ğ
X
, 0 ) != 0 )

328 
	`MPI_CHK
Ğ
	`mpi_wr™e_hÍ
Ğ
X
, 
¿dix
, 
p
 ) );

330 ifĞ
r
 < 10 )

331 *(*
p
)++ = ()Ğ
r
 + 0x30 );

333 *(*
p
)++ = ()Ğ
r
 + 0x37 );

335 
ş—nup
:

337 Ğ
»t
 );

338 
	}
}

343 
	$mpi_wr™e_¡ršg
ĞcÚ¡ 
mpi
 *
X
, 
¿dix
, *
s
, *
¦’
 )

345 
»t
 = 0, 
n
;

346 *
p
;

347 
mpi
 
T
;

349 ifĞ
¿dix
 < 2 ||„adix > 16 )

350 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

352 
n
 = 
	`mpi_msb
Ğ
X
 );

353 ifĞ
¿dix
 >ğ4 ) 
n
 >>= 1;

354 ifĞ
¿dix
 >ğ16 ) 
n
 >>= 1;

355 
n
 += 3;

357 ifĞ*
¦’
 < 
n
 )

359 *
¦’
 = 
n
;

360 Ğ
POLARSSL_ERR_MPI_BUFFER_TOO_SMALL
 );

363 
p
 = 
s
;

364 
	`mpi_š™
Ğ&
T
, 
NULL
 );

366 ifĞ
X
->
s
 == -1 )

367 *
p
++ = '-';

369 ifĞ
¿dix
 == 16 )

371 
c
, 
i
, 
j
, 
k
;

373  
i
 = 
X
->
n
 - 1, 
k
 = 0; i >= 0; i-- )

375  
j
 = 
ciL
 - 1; j >= 0; j-- )

377 
c
 = ( 
X
->
p
[
i
] >> (
j
 << 3) ) & 0xFF;

379 ifĞ
c
 =ğ0 && 
k
 =ğ0 && (
i
 + 
j
) != 0 )

382 
p
 +ğ
	`¥rštf
Ğp, "%02X", 
c
 );

383 
k
 = 1;

389 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
T
, 
X
 ) );

391 ifĞ
T
.
s
 == -1 )

392 
T
.
s
 = 1;

394 
	`MPI_CHK
Ğ
	`mpi_wr™e_hÍ
Ğ&
T
, 
¿dix
, &
p
 ) );

397 *
p
++ = '\0';

398 *
¦’
 = 
p
 - 
s
;

400 
ş—nup
:

402 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

404 Ğ
»t
 );

405 
	}
}

410 
	$mpi_»ad_fe
Ğ
mpi
 *
X
, 
¿dix
, 
FILE
 *
fš
 )

412 
t_št
 
d
;

413 
¦’
;

414 *
p
;

415 
s
[1024];

417 
	`mem£t
Ğ
s
, 0, ( s ) );

418 ifĞ
	`fg‘s
Ğ
s
, Ğ è- 1, 
fš
 ) =ğ
NULL
 )

419 Ğ
POLARSSL_ERR_MPI_FILE_IO_ERROR
 );

421 
¦’
 = 
	`¡¾’
Ğ
s
 );

422 ifĞ
s
[
¦’
 - 1] == '\n' ) { slen--; s[slen] = '\0'; }

423 ifĞ
s
[
¦’
 - 1] == '\r' ) { slen--; s[slen] = '\0'; }

425 
p
 = 
s
 + 
¦’
;

426  --
p
 >ğ
s
 )

427 ifĞ
	`mpi_g‘_dig™
Ğ&
d
, 
¿dix
, *
p
 ) != 0 )

430 Ğ
	`mpi_»ad_¡ršg
Ğ
X
, 
¿dix
, 
p
 + 1 ) );

431 
	}
}

436 
	$mpi_wr™e_fe
ĞcÚ¡ *
p
, cÚ¡ 
mpi
 *
X
, 
¿dix
, 
FILE
 *
fout
 )

438 
n
, 
»t
;

439 
size_t
 
¦’
;

440 
size_t
 
¶’
;

441 
s
[2048];

443 
n
 = Ğ
s
 );

444 
	`mem£t
Ğ
s
, 0, 
n
 );

445 
n
 -= 2;

447 
	`MPI_CHK
Ğ
	`mpi_wr™e_¡ršg
Ğ
X
, 
¿dix
, 
s
, (*è&
n
 ) );

449 ifĞ
p
 =ğ
NULL
 )… = "";

451 
¶’
 = 
	`¡¾’
Ğ
p
 );

452 
¦’
 = 
	`¡¾’
Ğ
s
 );

453 
s
[
¦’
++] = '\r';

454 
s
[
¦’
++] = '\n';

456 ifĞ
fout
 !ğ
NULL
 )

458 ifĞ
	`fwr™e
Ğ
p
, 1, 
¶’
, 
fout
 ) !=…len ||

459 
	`fwr™e
Ğ
s
, 1, 
¦’
, 
fout
 ) != slen )

460 Ğ
POLARSSL_ERR_MPI_FILE_IO_ERROR
 );

463 
	`´štf
Ğ"%s%s", 
p
, 
s
 );

465 
ş—nup
:

467 Ğ
»t
 );

468 
	}
}

473 
	$mpi_»ad_bš¬y
Ğ
mpi
 *
X
, cÚ¡ *
buf
, 
buæ’
 )

475 
»t
, 
i
, 
j
, 
n
;

477  
n
 = 0;‚ < 
buæ’
;‚++ )

478 ifĞ
buf
[
n
] != 0 )

481 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
	`CHARS_TO_LIMBS
Ğ
buæ’
 - 
n
 ) ) );

482 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

484  
i
 = 
buæ’
 - 1, 
j
 = 0; i >ğ
n
; i--, j++ )

485 
X
->
p
[
j
 / 
ciL
] |ğ((
t_št
è
buf
[
i
]) << ((j % ciL) << 3);

487 
ş—nup
:

489 Ğ
»t
 );

490 
	}
}

495 
	$mpi_wr™e_bš¬y
ĞcÚ¡ 
mpi
 *
X
, *
buf
, 
buæ’
 )

497 
i
, 
j
, 
n
;

499 
n
 = 
	`mpi_size
Ğ
X
 );

501 ifĞ
buæ’
 < 
n
 )

502 Ğ
POLARSSL_ERR_MPI_BUFFER_TOO_SMALL
 );

504 
	`mem£t
Ğ
buf
, 0, 
buæ’
 );

506  
i
 = 
buæ’
 - 1, 
j
 = 0; 
n
 > 0; i--, j++,‚-- )

507 
buf
[
i
] = ()Ğ
X
->
p
[
j
 / 
ciL
] >> ((j % ciL) << 3) );

510 
	}
}

515 
	$mpi_shiá_l
Ğ
mpi
 *
X
, 
couÁ
 )

517 
»t
, 
i
, 
v0
, 
t1
;

518 
t_št
 
r0
 = 0, 
r1
;

520 
v0
 = 
couÁ
 / (
biL
 );

521 
t1
 = 
couÁ
 & (
biL
 - 1);

523 
i
 = 
	`mpi_msb
Ğ
X
 ) + 
couÁ
;

525 ifĞ
X
->
n
 * (è
biL
 < 
i
 )

526 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
	`BITS_TO_LIMBS
Ğ
i
 ) ) );

528 
»t
 = 0;

533 ifĞ
v0
 > 0 )

535  
i
 = 
X
->
n
 - 1; i >ğ
v0
; i-- )

536 
X
->
p
[
i
] = X->p[˜- 
v0
];

538  ; 
i
 >= 0; i-- )

539 
X
->
p
[
i
] = 0;

545 ifĞ
t1
 > 0 )

547  
i
 = 
v0
; i < 
X
->
n
; i++ )

549 
r1
 = 
X
->
p
[
i
] >> (
biL
 - 
t1
);

550 
X
->
p
[
i
] <<ğ
t1
;

551 
X
->
p
[
i
] |ğ
r0
;

552 
r0
 = 
r1
;

556 
ş—nup
:

558 Ğ
»t
 );

559 
	}
}

564 
	$mpi_shiá_r
Ğ
mpi
 *
X
, 
couÁ
 )

566 
i
, 
v0
, 
v1
;

567 
t_št
 
r0
 = 0, 
r1
;

569 
v0
 = 
couÁ
 / 
biL
;

570 
v1
 = 
couÁ
 & (
biL
 - 1);

575 ifĞ
v0
 > 0 )

577  
i
 = 0; i < 
X
->
n
 - 
v0
; i++ )

578 
X
->
p
[
i
] = X->p[˜+ 
v0
];

580  ; 
i
 < 
X
->
n
; i++ )

581 
X
->
p
[
i
] = 0;

587 ifĞ
v1
 > 0 )

589  
i
 = 
X
->
n
 - 1; i >= 0; i-- )

591 
r1
 = 
X
->
p
[
i
] << (
biL
 - 
v1
);

592 
X
->
p
[
i
] >>ğ
v1
;

593 
X
->
p
[
i
] |ğ
r0
;

594 
r0
 = 
r1
;

599 
	}
}

604 
	$mpi_cmp_abs
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 )

606 
i
, 
j
;

608  
i
 = 
X
->
n
 - 1; i >= 0; i-- )

609 ifĞ
X
->
p
[
i
] != 0 )

612  
j
 = 
Y
->
n
 - 1; j >= 0; j-- )

613 ifĞ
Y
->
p
[
j
] != 0 )

616 ifĞ
i
 < 0 && 
j
 < 0 )

619 ifĞ
i
 > 
j
 ) ( 1 );

620 ifĞ
j
 > 
i
 ) ( -1 );

622  ; 
i
 >= 0; i-- )

624 ifĞ
X
->
p
[
i
] > 
Y
->p[i] ) ( 1 );

625 ifĞ
X
->
p
[
i
] < 
Y
->p[i] ) ( -1 );

629 
	}
}

634 
	$mpi_cmp_mpi
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 )

636 
i
, 
j
;

638  
i
 = 
X
->
n
 - 1; i >= 0; i-- )

639 ifĞ
X
->
p
[
i
] != 0 )

642  
j
 = 
Y
->
n
 - 1; j >= 0; j-- )

643 ifĞ
Y
->
p
[
j
] != 0 )

646 ifĞ
i
 < 0 && 
j
 < 0 )

649 ifĞ
i
 > 
j
 ) Ğ
X
->
s
 );

650 ifĞ
j
 > 
i
 ) Ğ-
X
->
s
 );

652 ifĞ
X
->
s
 > 0 && 
Y
->s < 0 ) ( 1 );

653 ifĞ
Y
->
s
 > 0 && 
X
->s < 0 ) ( -1 );

655  ; 
i
 >= 0; i-- )

657 ifĞ
X
->
p
[
i
] > 
Y
->p[i] ) ĞX->
s
 );

658 ifĞ
X
->
p
[
i
] < 
Y
->p[i] ) Ğ-X->
s
 );

662 
	}
}

667 
	$mpi_cmp_št
ĞcÚ¡ 
mpi
 *
X
, 
z
 )

669 
mpi
 
Y
;

670 
t_št
 
p
[1];

672 *
p
 = ( 
z
 < 0 ) ? -z : z;

673 
Y
.
s
 = ( 
z
 < 0 ) ? -1 : 1;

674 
Y
.
n
 = 1;

675 
Y
.
p
 =…;

677 Ğ
	`mpi_cmp_mpi
Ğ
X
, &
Y
 ) );

678 
	}
}

683 
	$mpi_add_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

685 
»t
, 
i
, 
j
;

686 
t_št
 *
o
, *
p
, 
c
;

688 ifĞ
X
 =ğ
B
 )

690 cÚ¡ 
mpi
 *
T
 = 
A
; A = 
X
; 
B
 = T;

693 ifĞ
X
 !ğ
A
 )

694 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, 
A
 ) );

699 
X
->
s
 = 1;

701  
j
 = 
B
->
n
 - 1; j >= 0; j-- )

702 ifĞ
B
->
p
[
j
] != 0 )

705 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
j
 + 1 ) );

707 
o
 = 
B
->
p
;… = 
X
->p; 
c
 = 0;

709  
i
 = 0; i <ğ
j
; i++, 
o
++, 
p
++ )

711 *
p
 +ğ
c
; c = ( *p < c );

712 *
p
 +ğ*
o
; 
c
 += ( *p < *o );

715  
c
 != 0 )

717 ifĞ
i
 >ğ
X
->
n
 )

719 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
i
 + 1 ) );

720 
p
 = 
X
->°+ 
i
;

723 *
p
 +ğ
c
; c = ( *°< c ); 
i
++;

726 
ş—nup
:

728 Ğ
»t
 );

729 
	}
}

734 
	$mpi_sub_hÍ
Ğ
n
, 
t_št
 *
s
,_šˆ*
d
 )

736 
i
;

737 
t_št
 
c
, 
z
;

739  
i
 = 
c
 = 0; i < 
n
; i++, 
s
++, 
d
++ )

741 
z
 = ( *
d
 < 
c
 ); *d -= c;

742 
c
 = ( *
d
 < *
s
 ) + 
z
; *d -= *s;

745  
c
 != 0 )

747 
z
 = ( *
d
 < 
c
 ); *d -= c;

748 
c
 = 
z
; 
i
++; 
d
++;

750 
	}
}

755 
	$mpi_sub_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

757 
mpi
 
TB
;

758 
»t
, 
n
;

760 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) < 0 )

761 Ğ
POLARSSL_ERR_MPI_NEGATIVE_VALUE
 );

763 
	`mpi_š™
Ğ&
TB
, 
NULL
 );

765 ifĞ
X
 =ğ
B
 )

767 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, 
B
 ) );

768 
B
 = &
TB
;

771 ifĞ
X
 !ğ
A
 )

772 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, 
A
 ) );

777 
X
->
s
 = 1;

779 
»t
 = 0;

781  
n
 = 
B
->n - 1;‚ >= 0;‚-- )

782 ifĞ
B
->
p
[
n
] != 0 )

785 
	`mpi_sub_hÍ
Ğ
n
 + 1, 
B
->
p
, 
X
->p );

787 
ş—nup
:

789 
	`mpi_ä“
Ğ&
TB
, 
NULL
 );

791 Ğ
»t
 );

792 
	}
}

797 
	$mpi_add_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

799 
»t
, 
s
 = 
A
->s;

801 ifĞ
A
->
s
 * 
B
->s < 0 )

803 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) >= 0 )

805 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
A
, 
B
 ) );

806 
X
->
s
 = s;

810 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
B
, 
A
 ) );

811 
X
->
s
 = -s;

816 
	`MPI_CHK
Ğ
	`mpi_add_abs
Ğ
X
, 
A
, 
B
 ) );

817 
X
->
s
 = s;

820 
ş—nup
:

822 Ğ
»t
 );

823 
	}
}

828 
	$mpi_sub_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

830 
»t
, 
s
 = 
A
->s;

832 ifĞ
A
->
s
 * 
B
->s > 0 )

834 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) >= 0 )

836 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
A
, 
B
 ) );

837 
X
->
s
 = s;

841 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
B
, 
A
 ) );

842 
X
->
s
 = -s;

847 
	`MPI_CHK
Ğ
	`mpi_add_abs
Ğ
X
, 
A
, 
B
 ) );

848 
X
->
s
 = s;

851 
ş—nup
:

853 Ğ
»t
 );

854 
	}
}

859 
	$mpi_add_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 )

861 
mpi
 
_B
;

862 
t_št
 
p
[1];

864 
p
[0] = ( 
b
 < 0 ) ? -b : b;

865 
_B
.
s
 = ( 
b
 < 0 ) ? -1 : 1;

866 
_B
.
n
 = 1;

867 
_B
.
p
 =…;

869 Ğ
	`mpi_add_mpi
Ğ
X
, 
A
, &
_B
 ) );

870 
	}
}

875 
	$mpi_sub_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 )

877 
mpi
 
_B
;

878 
t_št
 
p
[1];

880 
p
[0] = ( 
b
 < 0 ) ? -b : b;

881 
_B
.
s
 = ( 
b
 < 0 ) ? -1 : 1;

882 
_B
.
n
 = 1;

883 
_B
.
p
 =…;

885 Ğ
	`mpi_sub_mpi
Ğ
X
, 
A
, &
_B
 ) );

886 
	}
}

891 
	$mpi_mul_hÍ
Ğ
i
, 
t_št
 *
s
,_šˆ*
d
,_šˆ
b
 )

893 
t_št
 
c
 = 0, 
t
 = 0;

895 #ià
	`defšed
(
MULADDC_HUIT
)

896  ; 
i
 >= 8; i -= 8 )

898 
MULADDC_INIT


899 
MULADDC_HUIT


900 
MULADDC_STOP


903  ; 
i
 > 0; i-- )

905 
MULADDC_INIT


906 
MULADDC_CORE


907 
MULADDC_STOP


910  ; 
i
 >= 16; i -= 16 )

912 
MULADDC_INIT


913 
MULADDC_CORE
 MULADDC_CORE

914 
MULADDC_CORE
 MULADDC_CORE

915 
MULADDC_CORE
 MULADDC_CORE

916 
MULADDC_CORE
 MULADDC_CORE

918 
MULADDC_CORE
 MULADDC_CORE

919 
MULADDC_CORE
 MULADDC_CORE

920 
MULADDC_CORE
 MULADDC_CORE

921 
MULADDC_CORE
 MULADDC_CORE

922 
MULADDC_STOP


925  ; 
i
 >= 8; i -= 8 )

927 
MULADDC_INIT


928 
MULADDC_CORE
 MULADDC_CORE

929 
MULADDC_CORE
 MULADDC_CORE

931 
MULADDC_CORE
 MULADDC_CORE

932 
MULADDC_CORE
 MULADDC_CORE

933 
MULADDC_STOP


936  ; 
i
 > 0; i-- )

938 
MULADDC_INIT


939 
MULADDC_CORE


940 
MULADDC_STOP


944 
t
++;

947 *
d
 +ğ
c
; c = ( *d < c ); d++;

949  
c
 != 0 );

950 
	}
}

955 
	$mpi_mul_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

957 
»t
, 
i
, 
j
;

958 
mpi
 
TA
, 
TB
;

960 
	`mpi_š™
Ğ&
TA
, &
TB
, 
NULL
 );

962 ifĞ
X
 =ğ
A
 ) { 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TA
, A ) ); A = &TA; }

963 ifĞ
X
 =ğ
B
 ) { 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, B ) ); B = &TB; }

965  
i
 = 
A
->
n
 - 1; i >= 0; i-- )

966 ifĞ
A
->
p
[
i
] != 0 )

969  
j
 = 
B
->
n
 - 1; j >= 0; j-- )

970 ifĞ
B
->
p
[
j
] != 0 )

973 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
i
 + 
j
 + 2 ) );

974 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

976  
i
++; 
j
 >= 0; j-- )

977 
	`mpi_mul_hÍ
Ğ
i
, 
A
->
p
, 
X
->°+ 
j
, 
B
->p[j] );

979 
X
->
s
 = 
A
-> * 
B
->s;

981 
ş—nup
:

983 
	`mpi_ä“
Ğ&
TB
, &
TA
, 
NULL
 );

985 Ğ
»t
 );

986 
	}
}

991 
	$mpi_mul_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
t_št
 
b
 )

993 
mpi
 
_B
;

994 
t_št
 
p
[1];

996 
_B
.
s
 = 1;

997 
_B
.
n
 = 1;

998 
_B
.
p
 =…;

999 
p
[0] = 
b
;

1001 Ğ
	`mpi_mul_mpi
Ğ
X
, 
A
, &
_B
 ) );

1002 
	}
}

1007 
	$mpi_div_mpi
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

1009 
»t
, 
i
, 
n
, 
t
, 
k
;

1010 
mpi
 
X
, 
Y
, 
Z
, 
T1
, 
T2
;

1012 ifĞ
	`mpi_cmp_št
Ğ
B
, 0 ) == 0 )

1013 Ğ
POLARSSL_ERR_MPI_DIVISION_BY_ZERO
 );

1015 
	`mpi_š™
Ğ&
X
, &
Y
, &
Z
, &
T1
, &
T2
, 
NULL
 );

1017 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) < 0 )

1019 ifĞ
Q
 !ğ
NULL
 ) 
	`MPI_CHK
Ğ
	`mpi_l£t
( Q, 0 ) );

1020 ifĞ
R
 !ğ
NULL
 ) 
	`MPI_CHK
Ğ
	`mpi_cİy
ĞR, 
A
 ) );

1024 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
X
, 
A
 ) );

1025 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
Y
, 
B
 ) );

1026 
X
.
s
 = 
Y
.s = 1;

1028 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
Z
, 
A
->
n
 + 2 ) );

1029 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
Z
, 0 ) );

1030 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
T1
, 2 ) );

1031 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
T2
, 3 ) );

1033 
k
 = 
	`mpi_msb
Ğ&
Y
 ) % 
biL
;

1034 ifĞ
k
 < (è
biL
 - 1 )

1036 
k
 = 
biL
 - 1 - k;

1037 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
X
, 
k
 ) );

1038 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
Y
, 
k
 ) );

1040 
k
 = 0;

1042 
n
 = 
X
.n - 1;

1043 
t
 = 
Y
.
n
 - 1;

1044 
	`mpi_shiá_l
Ğ&
Y
, 
biL
 * (
n
 - 
t
) );

1046  
	`mpi_cmp_mpi
Ğ&
X
, &
Y
 ) >= 0 )

1048 
Z
.
p
[
n
 - 
t
]++;

1049 
	`mpi_sub_mpi
Ğ&
X
, &X, &
Y
 );

1051 
	`mpi_shiá_r
Ğ&
Y
, 
biL
 * (
n
 - 
t
) );

1053  
i
 = 
n
; i > 
t
 ; i-- )

1055 ifĞ
X
.
p
[
i
] >ğ
Y
.p[
t
] )

1056 
Z
.
p
[
i
 - 
t
 - 1] = ~0;

1059 #ià
	`defšed
(
POLARSSL_HAVE_LONGLONG
)

1060 
t_dbl
 
r
;

1062 
r
 = (
t_dbl
è
X
.
p
[
i
] << 
biL
;

1063 
r
 |ğ(
t_dbl
è
X
.
p
[
i
 - 1];

1064 
r
 /ğ
Y
.
p
[
t
];

1065 ifĞ
r
 > ((
t_dbl
è1 << 
biL
) - 1)

1066 
r
 = ((
t_dbl
è1 << 
biL
) - 1;

1068 
Z
.
p
[
i
 - 
t
 - 1] = (
t_št
è
r
;

1073 
t_št
 
q0
, 
q1
, 
r0
, 
r1
;

1074 
t_št
 
d0
, 
d1
, 
d
, 
m
;

1076 
d
 = 
Y
.
p
[
t
];

1077 
d0
 = ( 
d
 << 
biH
 ) >> biH;

1078 
d1
 = ( 
d
 >> 
biH
 );

1080 
q1
 = 
X
.
p
[
i
] / 
d1
;

1081 
r1
 = 
X
.
p
[
i
] - 
d1
 * 
q1
;

1082 
r1
 <<ğ
biH
;

1083 
r1
 |ğĞ
X
.
p
[
i
 - 1] >> 
biH
 );

1085 
m
 = 
q1
 * 
d0
;

1086 ifĞ
r1
 < 
m
 )

1088 
q1
--, 
r1
 +ğ
d
;

1089  
r1
 >ğ
d
 &&„1 < 
m
 )

1090 
q1
--, 
r1
 +ğ
d
;

1092 
r1
 -ğ
m
;

1094 
q0
 = 
r1
 / 
d1
;

1095 
r0
 = 
r1
 - 
d1
 * 
q0
;

1096 
r0
 <<ğ
biH
;

1097 
r0
 |ğĞ
X
.
p
[
i
 - 1] << 
biH
 ) >> biH;

1099 
m
 = 
q0
 * 
d0
;

1100 ifĞ
r0
 < 
m
 )

1102 
q0
--, 
r0
 +ğ
d
;

1103  
r0
 >ğ
d
 &&„0 < 
m
 )

1104 
q0
--, 
r0
 +ğ
d
;

1106 
r0
 -ğ
m
;

1108 
Z
.
p
[
i
 - 
t
 - 1] = ( 
q1
 << 
biH
 ) | 
q0
;

1112 
Z
.
p
[
i
 - 
t
 - 1]++;

1115 
Z
.
p
[
i
 - 
t
 - 1]--;

1117 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
T1
, 0 ) );

1118 
T1
.
p
[0] = (
t
 < 1è? 0 : 
Y
.p[t - 1];

1119 
T1
.
p
[1] = 
Y
.p[
t
];

1120 
	`MPI_CHK
Ğ
	`mpi_mul_št
Ğ&
T1
, &T1, 
Z
.
p
[
i
 - 
t
 - 1] ) );

1122 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
T2
, 0 ) );

1123 
T2
.
p
[0] = (
i
 < 2è? 0 : 
X
.p[i - 2];

1124 
T2
.
p
[1] = (
i
 < 1è? 0 : 
X
.p[i - 1];

1125 
T2
.
p
[2] = 
X
.p[
i
];

1127  
	`mpi_cmp_mpi
Ğ&
T1
, &
T2
 ) > 0 );

1129 
	`MPI_CHK
Ğ
	`mpi_mul_št
Ğ&
T1
, &
Y
, 
Z
.
p
[
i
 - 
t
 - 1] ) );

1130 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
T1
, 
biL
 * (
i
 - 
t
 - 1) ) );

1131 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
X
, &X, &
T1
 ) );

1133 ifĞ
	`mpi_cmp_št
Ğ&
X
, 0 ) < 0 )

1135 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
T1
, &
Y
 ) );

1136 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
T1
, 
biL
 * (
i
 - 
t
 - 1) ) );

1137 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
X
, &X, &
T1
 ) );

1138 
Z
.
p
[
i
 - 
t
 - 1]--;

1142 ifĞ
Q
 !ğ
NULL
 )

1144 
	`mpi_cİy
Ğ
Q
, &
Z
 );

1145 
Q
->
s
 = 
A
-> * 
B
->s;

1148 ifĞ
R
 !ğ
NULL
 )

1150 
	`mpi_shiá_r
Ğ&
X
, 
k
 );

1151 
	`mpi_cİy
Ğ
R
, &
X
 );

1153 
R
->
s
 = 
A
->s;

1154 ifĞ
	`mpi_cmp_št
Ğ
R
, 0 ) == 0 )

1155 
R
->
s
 = 1;

1158 
ş—nup
:

1160 
	`mpi_ä“
Ğ&
X
, &
Y
, &
Z
, &
T1
, &
T2
, 
NULL
 );

1162 Ğ
»t
 );

1163 
	}
}

1172 
	$mpi_div_št
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, 
b
 )

1174 
mpi
 
_B
;

1175 
t_št
 
p
[1];

1177 
p
[0] = ( 
b
 < 0 ) ? -b : b;

1178 
_B
.
s
 = ( 
b
 < 0 ) ? -1 : 1;

1179 
_B
.
n
 = 1;

1180 
_B
.
p
 =…;

1182 Ğ
	`mpi_div_mpi
Ğ
Q
, 
R
, 
A
, &
_B
 ) );

1183 
	}
}

1188 
	$mpi_mod_mpi
Ğ
mpi
 *
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

1190 
»t
;

1192 ifĞ
	`mpi_cmp_št
Ğ
B
, 0 ) < 0 )

1193  
POLARSSL_ERR_MPI_NEGATIVE_VALUE
;

1195 
	`MPI_CHK
Ğ
	`mpi_div_mpi
Ğ
NULL
, 
R
, 
A
, 
B
 ) );

1197  
	`mpi_cmp_št
Ğ
R
, 0 ) < 0 )

1198 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ
R
, R, 
B
 ) );

1200  
	`mpi_cmp_mpi
Ğ
R
, 
B
 ) >= 0 )

1201 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ
R
, R, 
B
 ) );

1203 
ş—nup
:

1205 Ğ
»t
 );

1206 
	}
}

1211 
	$mpi_mod_št
Ğ
t_št
 *
r
, cÚ¡ 
mpi
 *
A
, 
b
 )

1213 
i
;

1214 
t_št
 
x
, 
y
, 
z
;

1216 ifĞ
b
 == 0 )

1217 Ğ
POLARSSL_ERR_MPI_DIVISION_BY_ZERO
 );

1219 ifĞ
b
 < 0 )

1220  
POLARSSL_ERR_MPI_NEGATIVE_VALUE
;

1225 ifĞ
b
 == 1 )

1227 *
r
 = 0;

1231 ifĞ
b
 == 2 )

1233 *
r
 = 
A
->
p
[0] & 1;

1240  
i
 = 
A
->
n
 - 1, 
y
 = 0; i >= 0; i-- )

1242 
x
 = 
A
->
p
[
i
];

1243 
y
 = ( y << 
biH
 ) | ( 
x
 >> biH );

1244 
z
 = 
y
 / 
b
;

1245 
y
 -ğ
z
 * 
b
;

1247 
x
 <<ğ
biH
;

1248 
y
 = ( y << 
biH
 ) | ( 
x
 >> biH );

1249 
z
 = 
y
 / 
b
;

1250 
y
 -ğ
z
 * 
b
;

1257 ifĞ
A
->
s
 < 0 && 
y
 != 0 )

1258 
y
 = 
b
 - y;

1260 *
r
 = 
y
;

1263 
	}
}

1268 
	$mpi_mÚtg_š™
Ğ
t_št
 *
mm
, cÚ¡ 
mpi
 *
N
 )

1270 
t_št
 
x
, 
m0
 = 
N
->
p
[0];

1272 
x
 = 
m0
;

1273 
x
 +ğĞĞ
m0
 + 2 ) & 4 ) << 1;

1274 
x
 *ğĞ2 - ( 
m0
 * x ) );

1276 ifĞ
biL
 >ğ16 ) 
x
 *ğĞ2 - ( 
m0
 * x ) );

1277 ifĞ
biL
 >ğ32 ) 
x
 *ğĞ2 - ( 
m0
 * x ) );

1278 ifĞ
biL
 >ğ64 ) 
x
 *ğĞ2 - ( 
m0
 * x ) );

1280 *
mm
 = ~
x
 + 1;

1281 
	}
}

1286 
	$mpi_mÚtmul
Ğ
mpi
 *
A
, cÚ¡ mp˜*
B
, cÚ¡ mp˜*
N
, 
t_št
 
mm
, cÚ¡ mp˜*
T
 )

1288 
i
, 
n
, 
m
;

1289 
t_št
 
u0
, 
u1
, *
d
;

1291 
	`mem£t
Ğ
T
->
p
, 0, T->
n
 * 
ciL
 );

1293 
d
 = 
T
->
p
;

1294 
n
 = 
N
->n;

1295 
m
 = ( 
B
->
n
 <‚ ) ? B->n :‚;

1297  
i
 = 0; i < 
n
; i++ )

1302 
u0
 = 
A
->
p
[
i
];

1303 
u1
 = ( 
d
[0] + 
u0
 * 
B
->
p
[0] ) * 
mm
;

1305 
	`mpi_mul_hÍ
Ğ
m
, 
B
->
p
, 
d
, 
u0
 );

1306 
	`mpi_mul_hÍ
Ğ
n
, 
N
->
p
, 
d
, 
u1
 );

1308 *
d
++ = 
u0
; d[
n
 + 1] = 0;

1311 
	`memıy
Ğ
A
->
p
, 
d
, (
n
 + 1è* 
ciL
 );

1313 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
N
 ) >= 0 )

1314 
	`mpi_sub_hÍ
Ğ
n
, 
N
->
p
, 
A
->p );

1317 
	`mpi_sub_hÍ
Ğ
n
, 
A
->
p
, 
T
->p );

1318 
	}
}

1323 
	$mpi_mÚŒed
Ğ
mpi
 *
A
, cÚ¡ mp˜*
N
, 
t_št
 
mm
, cÚ¡ mp˜*
T
 )

1325 
t_št
 
z
 = 1;

1326 
mpi
 
U
;

1328 
U
.
n
 = U.
s
 = 
z
;

1329 
U
.
p
 = &
z
;

1331 
	`mpi_mÚtmul
Ğ
A
, &
U
, 
N
, 
mm
, 
T
 );

1332 
	}
}

1337 
	$mpi_exp_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
E
, cÚ¡ mp˜*
N
, mp˜*
_RR
 )

1339 
»t
, 
i
, 
j
, 
wsize
, 
wb™s
;

1340 
bufsize
, 
nblimbs
, 
nb™s
;

1341 
t_št
 
ei
, 
mm
, 
¡©e
;

1342 
mpi
 
RR
, 
T
, 
W
[64];

1344 ifĞ
	`mpi_cmp_št
Ğ
N
, 0 ) < 0 || ( N->
p
[0] & 1 ) == 0 )

1345 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

1350 
	`mpi_mÚtg_š™
Ğ&
mm
, 
N
 );

1351 
	`mpi_š™
Ğ&
RR
, &
T
, 
NULL
 );

1352 
	`mem£t
Ğ
W
, 0, ( W ) );

1354 
i
 = 
	`mpi_msb
Ğ
E
 );

1356 
wsize
 = ( 
i
 > 671 ) ? 6 : ( i > 239 ) ? 5 :

1357 Ğ
i
 > 79 ) ? 4 : ( i > 23 ) ? 3 : 1;

1359 
j
 = 
N
->
n
 + 1;

1360 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
j
 ) );

1361 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
W
[1], 
j
 ) );

1362 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
T
, 
j
 * 2 ) );

1367 ifĞ
_RR
 =ğ
NULL
 || _RR->
p
 == NULL )

1369 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
RR
, 1 ) );

1370 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
RR
, 
N
->
n
 * 2 * 
biL
 ) );

1371 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
RR
, &RR, 
N
 ) );

1373 ifĞ
_RR
 !ğ
NULL
 )

1374 
	`memıy
Ğ
_RR
, &
RR
, Ğ
mpi
 ) );

1377 
	`memıy
Ğ&
RR
, 
_RR
, Ğ
mpi
 ) );

1382 ifĞ
	`mpi_cmp_mpi
Ğ
A
, 
N
 ) >= 0 )

1383 
	`mpi_mod_mpi
Ğ&
W
[1], 
A
, 
N
 );

1384 
	`mpi_cİy
Ğ&
W
[1], 
A
 );

1386 
	`mpi_mÚtmul
Ğ&
W
[1], &
RR
, 
N
, 
mm
, &
T
 );

1391 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, &
RR
 ) );

1392 
	`mpi_mÚŒed
Ğ
X
, 
N
, 
mm
, &
T
 );

1394 ifĞ
wsize
 > 1 )

1399 
j
 = 1 << (
wsize
 - 1);

1401 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
W
[
j
], 
N
->
n
 + 1 ) );

1402 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
W
[
j
], &W[1] ) );

1404  
i
 = 0; i < 
wsize
 - 1; i++ )

1405 
	`mpi_mÚtmul
Ğ&
W
[
j
], &W[j], 
N
, 
mm
, &
T
 );

1410  
i
 = 
j
 + 1; i < (1 << 
wsize
); i++ )

1412 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
W
[
i
], 
N
->
n
 + 1 ) );

1413 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
W
[
i
], &W[i - 1] ) );

1415 
	`mpi_mÚtmul
Ğ&
W
[
i
], &W[1], 
N
, 
mm
, &
T
 );

1419 
nblimbs
 = 
E
->
n
;

1420 
bufsize
 = 0;

1421 
nb™s
 = 0;

1422 
wb™s
 = 0;

1423 
¡©e
 = 0;

1427 ifĞ
bufsize
 == 0 )

1429 ifĞ
nblimbs
-- == 0 )

1432 
bufsize
 = Ğ
t_št
 ) << 3;

1435 
bufsize
--;

1437 
ei
 = (
E
->
p
[
nblimbs
] >> 
bufsize
) & 1;

1442 ifĞ
ei
 =ğ0 && 
¡©e
 == 0 )

1445 ifĞ
ei
 =ğ0 && 
¡©e
 == 1 )

1450 
	`mpi_mÚtmul
Ğ
X
, X, 
N
, 
mm
, &
T
 );

1457 
¡©e
 = 2;

1459 
nb™s
++;

1460 
wb™s
 |ğ(
ei
 << (
wsize
 - 
nb™s
));

1462 ifĞ
nb™s
 =ğ
wsize
 )

1467  
i
 = 0; i < 
wsize
; i++ )

1468 
	`mpi_mÚtmul
Ğ
X
, X, 
N
, 
mm
, &
T
 );

1473 
	`mpi_mÚtmul
Ğ
X
, &
W
[
wb™s
], 
N
, 
mm
, &
T
 );

1475 
¡©e
--;

1476 
nb™s
 = 0;

1477 
wb™s
 = 0;

1484  
i
 = 0; i < 
nb™s
; i++ )

1486 
	`mpi_mÚtmul
Ğ
X
, X, 
N
, 
mm
, &
T
 );

1488 
wb™s
 <<= 1;

1490 ifĞ(
wb™s
 & (1 << 
wsize
)) != 0 )

1491 
	`mpi_mÚtmul
Ğ
X
, &
W
[1], 
N
, 
mm
, &
T
 );

1497 
	`mpi_mÚŒed
Ğ
X
, 
N
, 
mm
, &
T
 );

1499 
ş—nup
:

1501  
i
 = (1 << (
wsize
 - 1)); i < (1 << wsize); i++ )

1502 
	`mpi_ä“
Ğ&
W
[
i
], 
NULL
 );

1504 ifĞ
_RR
 !ğ
NULL
 )

1505 
	`mpi_ä“
Ğ&
W
[1], &
T
, 
NULL
 );

1506 
	`mpi_ä“
Ğ&
W
[1], &
T
, &
RR
, 
NULL
 );

1508 Ğ
»t
 );

1509 
	}
}

1514 
	$mpi_gcd
Ğ
mpi
 *
G
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

1516 
»t
, 
lz
, 
lzt
;

1517 
mpi
 
TG
, 
TA
, 
TB
;

1519 
	`mpi_š™
Ğ&
TG
, &
TA
, &
TB
, 
NULL
 );

1521 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TA
, 
A
 ) );

1522 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, 
B
 ) );

1524 
lz
 = 
	`mpi_lsb
Ğ&
TA
 );

1525 
lzt
 = 
	`mpi_lsb
Ğ&
TB
 );

1527 iàĞ
lzt
 < 
lz
 )

1528 
lz
 = 
lzt
;

1530 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TA
, 
lz
 ) );

1531 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TB
, 
lz
 ) );

1533 
TA
.
s
 = 
TB
.s = 1;

1535  
	`mpi_cmp_št
Ğ&
TA
, 0 ) != 0 )

1537 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TA
, 
	`mpi_lsb
( &TA ) ) );

1538 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TB
, 
	`mpi_lsb
( &TB ) ) );

1540 ifĞ
	`mpi_cmp_mpi
Ğ&
TA
, &
TB
 ) >= 0 )

1542 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ&
TA
, &TA, &
TB
 ) );

1543 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TA
, 1 ) );

1547 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ&
TB
, &TB, &
TA
 ) );

1548 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TB
, 1 ) );

1552 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
TB
, 
lz
 ) );

1553 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
G
, &
TB
 ) );

1555 
ş—nup
:

1557 
	`mpi_ä“
Ğ&
TB
, &
TA
, &
TG
, 
NULL
 );

1559 Ğ
»t
 );

1560 
	}
}

1562 #ià
defšed
(
POLARSSL_GENPRIME
)

1567 
	$mpi_šv_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
N
 )

1569 
»t
;

1570 
mpi
 
G
, 
TA
, 
TU
, 
U1
, 
U2
, 
TB
, 
TV
, 
V1
, 
V2
;

1572 ifĞ
	`mpi_cmp_št
Ğ
N
, 0 ) <= 0 )

1573 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

1575 
	`mpi_š™
Ğ&
TA
, &
TU
, &
U1
, &
U2
, &
G
,

1576 &
TB
, &
TV
, &
V1
, &
V2
, 
NULL
 );

1578 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G
, 
A
, 
N
 ) );

1580 ifĞ
	`mpi_cmp_št
Ğ&
G
, 1 ) != 0 )

1582 
»t
 = 
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
;

1583 
ş—nup
;

1586 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
TA
, 
A
, 
N
 ) );

1587 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TU
, &
TA
 ) );

1588 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, 
N
 ) );

1589 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TV
, 
N
 ) );

1591 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
U1
, 1 ) );

1592 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
U2
, 0 ) );

1593 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
V1
, 0 ) );

1594 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
V2
, 1 ) );

1598  ( 
TU
.
p
[0] & 1 ) == 0 )

1600 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TU
, 1 ) );

1602 ifĞĞ
U1
.
p
[0] & 1 ) !ğ0 || ( 
U2
.p[0] & 1 ) != 0 )

1604 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
U1
, &U1, &
TB
 ) );

1605 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
U2
, &U2, &
TA
 ) );

1608 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
U1
, 1 ) );

1609 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
U2
, 1 ) );

1612  ( 
TV
.
p
[0] & 1 ) == 0 )

1614 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TV
, 1 ) );

1616 ifĞĞ
V1
.
p
[0] & 1 ) !ğ0 || ( 
V2
.p[0] & 1 ) != 0 )

1618 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
V1
, &V1, &
TB
 ) );

1619 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V2
, &V2, &
TA
 ) );

1622 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
V1
, 1 ) );

1623 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
V2
, 1 ) );

1626 ifĞ
	`mpi_cmp_mpi
Ğ&
TU
, &
TV
 ) >= 0 )

1628 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
TU
, &TU, &
TV
 ) );

1629 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
U1
, &U1, &
V1
 ) );

1630 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
U2
, &U2, &
V2
 ) );

1634 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
TV
, &TV, &
TU
 ) );

1635 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V1
, &V1, &
U1
 ) );

1636 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V2
, &V2, &
U2
 ) );

1639  
	`mpi_cmp_št
Ğ&
TU
, 0 ) != 0 );

1641  
	`mpi_cmp_št
Ğ&
V1
, 0 ) < 0 )

1642 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
V1
, &V1, 
N
 ) );

1644  
	`mpi_cmp_mpi
Ğ&
V1
, 
N
 ) >= 0 )

1645 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V1
, &V1, 
N
 ) );

1647 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, &
V1
 ) );

1649 
ş—nup
:

1651 
	`mpi_ä“
Ğ&
V2
, &
V1
, &
TV
, &
TB
, &
G
,

1652 &
U2
, &
U1
, &
TU
, &
TA
, 
NULL
 );

1654 Ğ
»t
 );

1655 
	}
}

1657 cÚ¡ 
	gsm®l_´ime
[] =

1685 
mpi_is_´ime
Ğ
mpi
 *
X
, (*
f_ºg
)(*), *
p_ºg
 )

1687 
»t
, 
i
, 
j
, 
n
, 
s
, 
xs
;

1688 
mpi
 
W
, 
R
, 
T
, 
A
, 
RR
;

1689 *
p
;

1691 ifĞ
	`mpi_cmp_št
Ğ
X
, 0 ) == 0 ||

1692 
	`mpi_cmp_št
Ğ
X
, 1 ) == 0 )

1693 Ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 );

1695 ifĞ
	`mpi_cmp_št
Ğ
X
, 2 ) == 0 )

1698 
	`mpi_š™
Ğ&
W
, &
R
, &
T
, &
A
, &
RR
, 
NULL
 );

1700 
xs
 = 
X
->
s
; X->s = 1;

1705 ifĞĞ
X
->
p
[0] & 1 ) == 0 )

1706 Ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 );

1708  
i
 = 0; 
sm®l_´ime
[i] > 0; i++ )

1710 
t_št
 
r
;

1712 ifĞ
	`mpi_cmp_št
Ğ
X
, 
sm®l_´ime
[
i
] ) <= 0 )

1715 
	`MPI_CHK
Ğ
	`mpi_mod_št
Ğ&
r
, 
X
, 
sm®l_´ime
[
i
] ) );

1717 ifĞ
r
 == 0 )

1718 Ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 );

1725 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
W
, 
X
, 1 ) );

1726 
s
 = 
	`mpi_lsb
Ğ&
W
 );

1727 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
R
, &
W
 ) );

1728 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
R
, 
s
 ) );

1730 
i
 = 
	`mpi_msb
Ğ
X
 );

1734 
n
 = ( ( 
i
 >= 1300 ) ? 2 : ( i >= 850 ) ? 3 :

1735 Ğ
i
 >= 650 ) ? 4 : ( i >= 350 ) ? 8 :

1736 Ğ
i
 >= 250 ) ? 12 : ( i >= 150 ) ? 18 : 27 );

1738  
i
 = 0; i < 
n
; i++ )

1743 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
A
, 
X
->
n
 ) );

1745 
p
 = (*è
A
.p;

1746  
j
 = 0; j < 
A
.
n
 * 
ciL
; j++ )

1747 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

1749 
j
 = 
	`mpi_msb
Ğ&
A
 ) - mpi_msbĞ&
W
 );

1750 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
A
, 
j
 + 1 ) );

1751 
A
.
p
[0] |= 3;

1756 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
A
, &A, &
R
, 
X
, &
RR
 ) );

1758 ifĞ
	`mpi_cmp_mpi
Ğ&
A
, &
W
 ) == 0 ||

1759 
	`mpi_cmp_št
Ğ&
A
, 1 ) == 0 )

1762 
j
 = 1;

1763  
j
 < 
s
 && 
	`mpi_cmp_mpi
Ğ&
A
, &
W
 ) != 0 )

1768 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
T
, &
A
, &A ) );

1769 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
A
, &
T
, 
X
 ) );

1771 ifĞ
	`mpi_cmp_št
Ğ&
A
, 1 ) == 0 )

1774 
j
++;

1780 ifĞ
	`mpi_cmp_mpi
Ğ&
A
, &
W
 ) != 0 ||

1781 
	`mpi_cmp_št
Ğ&
A
, 1 ) == 0 )

1783 
»t
 = 
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
;

1788 
ş—nup
:

1790 
X
->
s
 = 
xs
;

1792 
	`mpi_ä“
Ğ&
RR
, &
A
, &
T
, &
R
, &
W
, 
NULL
 );

1794 Ğ
»t
 );

1795 
	}
}

1800 
mpi_g’_´ime
Ğ
mpi
 *
X
, 
nb™s
, 
dh_æag
,

1801 (*
f_ºg
)(*), *
p_ºg
 )

1803 
»t
, 
k
, 
n
;

1804 *
p
;

1805 
mpi
 
Y
;

1807 ifĞ
nb™s
 < 3 )

1808 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

1810 
	`mpi_š™
Ğ&
Y
, 
NULL
 );

1812 
n
 = 
	`BITS_TO_LIMBS
Ğ
nb™s
 );

1814 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
n
 ) );

1815 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

1817 
p
 = (*è
X
->p;

1818  
k
 = 0; k < 
X
->
n
 * 
ciL
; k++ )

1819 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

1821 
k
 = 
	`mpi_msb
Ğ
X
 );

1822 ifĞ
k
 < 
nb™s
 ) 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ
X
,‚bits - k ) );

1823 ifĞ
k
 > 
nb™s
 ) 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ
X
, k -‚bits ) );

1825 
X
->
p
[0] |= 3;

1827 ifĞ
dh_æag
 == 0 )

1829  ( 
»t
 = 
	`mpi_is_´ime
Ğ
X
, 
f_ºg
, 
p_ºg
 ) ) != 0 )

1831 ifĞ
»t
 !ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 )

1832 
ş—nup
;

1834 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ
X
, X, 2 ) );

1839 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
Y
, 
X
, 1 ) );

1840 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
Y
, 1 ) );

1844 ifĞĞ
»t
 = 
	`mpi_is_´ime
Ğ
X
, 
f_ºg
, 
p_ºg
 ) ) == 0 )

1846 ifĞĞ
»t
 = 
	`mpi_is_´ime
Ğ&
Y
, 
f_ºg
, 
p_ºg
 ) ) == 0 )

1849 ifĞ
»t
 !ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 )

1850 
ş—nup
;

1853 ifĞ
»t
 !ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 )

1854 
ş—nup
;

1856 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ&
Y
, 
X
, 1 ) );

1857 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ
X
, X, 2 ) );

1858 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
Y
, 1 ) );

1862 
ş—nup
:

1864 
	`mpi_ä“
Ğ&
Y
, 
NULL
 );

1866 Ğ
»t
 );

1867 
	}
}

1871 #ià
defšed
(
POLARSSL_SELF_TEST
)

1873 
	#GCD_PAIR_COUNT
 3

	)

1875 cÚ¡ 
	ggcd_·œs
[
GCD_PAIR_COUNT
][3] =

1885 
	$mpi_£lf_‹¡
Ğ
v”bo£
 )

1887 
»t
, 
i
;

1888 
mpi
 
A
, 
E
, 
N
, 
X
, 
Y
, 
U
, 
V
;

1890 
	`mpi_š™
Ğ&
A
, &
E
, &
N
, &
X
, &
Y
, &
U
, &
V
, 
NULL
 );

1892 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
A
, 16,

1898 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
E
, 16,

1904 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
N
, 16,

1909 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
X
, &
A
, &
N
 ) );

1911 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1920 ifĞ
v”bo£
 != 0 )

1921 
	`´štf
( " MPIest #1 (mul_mpi): " );

1923 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 )

1925 ifĞ
v”bo£
 != 0 )

1926 
	`´štf
( "failed\n" );

1931 ifĞ
v”bo£
 != 0 )

1932 
	`´štf
( "passed\n" );

1934 
	`MPI_CHK
Ğ
	`mpi_div_mpi
Ğ&
X
, &
Y
, &
A
, &
N
 ) );

1936 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1939 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
V
, 16,

1944 ifĞ
v”bo£
 != 0 )

1945 
	`´štf
( " MPIest #2 (div_mpi): " );

1947 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 ||

1948 
	`mpi_cmp_mpi
Ğ&
Y
, &
V
 ) != 0 )

1950 ifĞ
v”bo£
 != 0 )

1951 
	`´štf
( "failed\n" );

1956 ifĞ
v”bo£
 != 0 )

1957 
	`´štf
( "passed\n" );

1959 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
X
, &
A
, &
E
, &
N
, 
NULL
 ) );

1961 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1966 ifĞ
v”bo£
 != 0 )

1967 
	`´štf
( " MPIest #3 (exp_mod): " );

1969 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 )

1971 ifĞ
v”bo£
 != 0 )

1972 
	`´štf
( "failed\n" );

1977 ifĞ
v”bo£
 != 0 )

1978 
	`´štf
( "passed\n" );

1980 
	`MPI_CHK
Ğ
	`mpi_šv_mod
Ğ&
X
, &
A
, &
N
 ) );

1982 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1987 ifĞ
v”bo£
 != 0 )

1988 
	`´štf
( " MPIest #4 (inv_mod): " );

1990 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 )

1992 ifĞ
v”bo£
 != 0 )

1993 
	`´štf
( "failed\n" );

1998 ifĞ
v”bo£
 != 0 )

1999 
	`´štf
( "passed\n" );

2001 ifĞ
v”bo£
 != 0 )

2002 
	`´štf
( " MPIest #5 (simple gcd): " );

2004  
i
 = 0; i < 
GCD_PAIR_COUNT
; i++)

2006 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
X
, 
gcd_·œs
[
i
][0] ) );

2007 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
Y
, 
gcd_·œs
[
i
][1] ) );

2009 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
A
, &
X
, &
Y
 ) );

2011 ifĞ
	`mpi_cmp_št
Ğ&
A
, 
gcd_·œs
[
i
][2] ) != 0 )

2013 ifĞ
v”bo£
 != 0 )

2014 
	`´štf
Ğ"çed‡ˆ%d\n", 
i
 );

2020 ifĞ
v”bo£
 != 0 )

2021 
	`´štf
( "passed\n" );

2023 
ş—nup
:

2025 ifĞ
»t
 !ğ0 && 
v”bo£
 != 0 )

2026 
	`´štf
Ğ"UÃx³ùedƒ¼Ü,„‘uº codğ%08X\n", 
»t
 );

2028 
	`mpi_ä“
Ğ&
V
, &
U
, &
Y
, &
X
, &
N
, &
E
, &
A
, 
NULL
 );

2030 ifĞ
v”bo£
 != 0 )

2031 
	`´štf
( "\n" );

2033 Ğ
»t
 );

2034 
	}
}

	@src/polarssl/bignum.h

25 #iâdeà
POLARSSL_BIGNUM_H


26 
	#POLARSSL_BIGNUM_H


	)

28 
	~<¡dio.h
>

30 
	#POLARSSL_ERR_MPI_FILE_IO_ERROR
 0x0002

	)

31 
	#POLARSSL_ERR_MPI_BAD_INPUT_DATA
 0x0004

	)

32 
	#POLARSSL_ERR_MPI_INVALID_CHARACTER
 0x0006

	)

33 
	#POLARSSL_ERR_MPI_BUFFER_TOO_SMALL
 0x0008

	)

34 
	#POLARSSL_ERR_MPI_NEGATIVE_VALUE
 0x000A

	)

35 
	#POLARSSL_ERR_MPI_DIVISION_BY_ZERO
 0x000C

	)

36 
	#POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 0x000E

	)

38 
	#MPI_CHK
(
f
èifĞĞ
»t
 = f ) !ğ0 ) 
ş—nup


	)

43 #ià
defšed
(
POLARSSL_HAVE_INT8
)

44 
	tt_št
;

45 
	tt_dbl
;

47 #ià
defšed
(
POLARSSL_HAVE_INT16
)

48 
	tt_št
;

49 
	tt_dbl
;

51 
	tt_št
;

52 #ià
defšed
(
_MSC_VER
è&& defšed(
_M_IX86
)

53 
	t__št64
 
	tt_dbl
;

55 #ià
defšed
(
__amd64__
è|| defšed(
__x86_64__
) || \

56 
defšed
(
__µc64__
è|| defšed(
__pow”pc64__
) || \

57 
defšed
(
__Ÿ64__
è|| 
	$defšed
(
__®pha__
)

58 
	tt_dbl
 
	t__©Œibu‹__
((
	tmode
(
	tTI
)));

60 #ià
	`defšed
(
POLARSSL_HAVE_LONGLONG
)

61 
	tt_dbl
;

73 
s
;

74 
n
;

75 
t_št
 *
p
;

77 
	tmpi
;

79 #ifdeà
__ılu¥lus


86 
	`mpi_š™
Ğ
mpi
 *
X
, ... );

91 
	`mpi_ä“
Ğ
mpi
 *
X
, ... );

102 
	`mpi_grow
Ğ
mpi
 *
X
, 
nblimbs
 );

113 
	`mpi_cİy
Ğ
mpi
 *
X
, cÚ¡ mp˜*
Y
 );

121 
	`mpi_sw­
Ğ
mpi
 *
X
, mp˜*
Y
 );

132 
	`mpi_l£t
Ğ
mpi
 *
X
, 
z
 );

139 
	`mpi_lsb
ĞcÚ¡ 
mpi
 *
X
 );

146 
	`mpi_msb
ĞcÚ¡ 
mpi
 *
X
 );

153 
	`mpi_size
ĞcÚ¡ 
mpi
 *
X
 );

164 
	`mpi_»ad_¡ršg
Ğ
mpi
 *
X
, 
¿dix
, cÚ¡ *
s
 );

181 
	`mpi_wr™e_¡ršg
ĞcÚ¡ 
mpi
 *
X
, 
¿dix
, *
s
, *
¦’
 );

192 
	`mpi_»ad_fe
Ğ
mpi
 *
X
, 
¿dix
, 
FILE
 *
fš
 );

206 
	`mpi_wr™e_fe
ĞcÚ¡ *
p
, cÚ¡ 
mpi
 *
X
, 
¿dix
, 
FILE
 *
fout
 );

218 
	`mpi_»ad_bš¬y
Ğ
mpi
 *
X
, cÚ¡ *
buf
, 
buæ’
 );

230 
	`mpi_wr™e_bš¬y
ĞcÚ¡ 
mpi
 *
X
, *
buf
, 
buæ’
 );

241 
	`mpi_shiá_l
Ğ
mpi
 *
X
, 
couÁ
 );

252 
	`mpi_shiá_r
Ğ
mpi
 *
X
, 
couÁ
 );

264 
	`mpi_cmp_abs
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 );

276 
	`mpi_cmp_mpi
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 );

288 
	`mpi_cmp_št
ĞcÚ¡ 
mpi
 *
X
, 
z
 );

300 
	`mpi_add_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

312 
	`mpi_sub_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

324 
	`mpi_add_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

336 
	`mpi_sub_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

348 
	`mpi_add_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 );

360 
	`mpi_sub_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 );

372 
	`mpi_mul_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

386 
	`mpi_mul_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
t_št
 
b
 );

402 
	`mpi_div_mpi
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

418 
	`mpi_div_št
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, 
b
 );

432 
	`mpi_mod_mpi
Ğ
mpi
 *
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

446 
	`mpi_mod_št
Ğ
t_št
 *
r
, cÚ¡ 
mpi
 *
A
, 
b
 );

465 
	`mpi_exp_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
E
, cÚ¡ mp˜*
N
, mp˜*
_RR
 );

477 
	`mpi_gcd
Ğ
mpi
 *
G
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

491 
	`mpi_šv_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
N
 );

504 
	`mpi_is_´ime
Ğ
mpi
 *
X
, (*
f_ºg
)(*), *
p_ºg
 );

519 
	`mpi_g’_´ime
Ğ
mpi
 *
X
, 
nb™s
, 
dh_æag
,

520 (*
f_ºg
)(*), *
p_ºg
 );

527 
	`mpi_£lf_‹¡
Ğ
v”bo£
 );

529 #ifdeà
__ılu¥lus


530 
	}
}

	@src/polarssl/bn_mul.h

39 #iâdeà
POLARSSL_BN_MUL_H


40 
	#POLARSSL_BN_MUL_H


	)

42 
	~"pŞ¬s¦/cÚfig.h
"

44 #ià
defšed
(
POLARSSL_HAVE_ASM
)

46 #ià
defšed
(
__GNUC__
)

47 #ià
defšed
(
__i386__
)

49 
	#MULADDC_INIT
 \

50 
	`asm
Ğ" \
 %%ebx, %0; \
 %5, %%esi; \
 %6, %%edi; \
 %7, %%ecx; \
 %8, %%ebx; \
"

	)

58 
	#MULADDC_CORE
 \

59 " \
; \
 %%ebx; \
 %%ecx, %%—x; \
 $0, %%edx; \
 (%%edi), %%—x; \
 $0, %%edx; \
 %%edx, %%ecx; \
; \
"

	)

70 #ià
defšed
(
POLARSSL_HAVE_SSE2
)

72 
	#MULADDC_HUIT
 \

73 " \
 %%ecx, %%mm1; \
 %%ebx, %%mm0; \
 (%%edi), %%mm3; \
 %%mm3, %%mm1; \
 (%%esi), %%mm2; \
 %%mm0, %%mm2; \
 4(%%esi), %%mm4; \
 %%mm0, %%mm4; \
 8(%%esi), %%mm6; \
 %%mm0, %%mm6; \
 12(%%esi), %%mm7; \
 %%mm0, %%mm7; \
 %%mm2, %%mm1; \
 4(%%edi), %%mm3; \
 %%mm4, %%mm3; \
 8(%%edi), %%mm5; \
 %%mm6, %%mm5; \
 12(%%edi), %%mm4; \
 %%mm4, %%mm7; \
 %%mm1, (%%edi); \
 16(%%esi), %%mm2; \
 %%mm0, %%mm2; \
 $32, %%mm1; \
 20(%%esi), %%mm4; \
 %%mm0, %%mm4; \
 %%mm3, %%mm1; \
 24(%%esi), %%mm6; \
 %%mm0, %%mm6; \
 %%mm1, 4(%%edi); \
 $32, %%mm1; \
 28(%%esi), %%mm3; \
 %%mm0, %%mm3; \
 %%mm5, %%mm1; \
 16(%%edi), %%mm5; \
 %%mm5, %%mm2; \
 %%mm1, 8(%%edi); \
 $32, %%mm1; \
 %%mm7, %%mm1; \
 20(%%edi), %%mm5; \
 %%mm5, %%mm4; \
 %%mm1, 12(%%edi); \
 $32, %%mm1; \
 %%mm2, %%mm1; \
 24(%%edi), %%mm5; \
 %%mm5, %%mm6; \
 %%mm1, 16(%%edi); \
 $32, %%mm1; \
 %%mm4, %%mm1; \
 28(%%edi), %%mm5; \
 %%mm5, %%mm3; \
 %%mm1, 20(%%edi); \
 $32, %%mm1; \
 %%mm6, %%mm1; \
 %%mm1, 24(%%edi); \
 $32, %%mm1; \
 %%mm3, %%mm1; \
 %%mm1, 28(%%edi); \
 $32, %%edi; \
 $32, %%esi; \
 $32, %%mm1; \
 %%mm1, %%ecx; \
"

	)

137 
	#MULADDC_STOP
 \

145 : "=m" (
t
), "=m" (
c
), "=m" (
d
), "=m" (
s
) \

146 : "m" (
t
), "m" (
s
), "m" (
d
), "m" (
c
), "m" (
b
) \

148 );

	)

152 
	#MULADDC_STOP
 \

159 : "=m" (
t
), "=m" (
c
), "=m" (
d
), "=m" (
s
) \

160 : "m" (
t
), "m" (
s
), "m" (
d
), "m" (
c
), "m" (
b
) \

162 );

	)

166 #ià
defšed
(
__amd64__
è|| defšed (
__x86_64__
)

168 
	#MULADDC_INIT
 \

169 
	`asm
Ğ"movq %0, %%rs˜ " :: "m" (
s
)); \

170 
	`asm
Ğ"movq %0, %%rd˜ " :: "m" (
d
)); \

171 
	`asm
Ğ"movq %0, %%rcx " :: "m" (
c
)); \

172 
	`asm
Ğ"movq %0, %%rbx " :: "m" (
b
)); \

173 
	`asm
Ğ"xÜq %r8, %r8 " );

	)

175 
	#MULADDC_CORE
 \

176 
	`asm
( "movq (%rsi),%rax " ); \

177 
	`asm
( "mulq %rbx " ); \

178 
	`asm
( "addq $8, %rsi " ); \

179 
	`asm
( "addq %rcx, %rax " ); \

180 
	`asm
( "movq %r8, %rcx " ); \

181 
	`asm
( "adcq $0, %rdx " ); \

182 
	`asm
( "nop " ); \

183 
	`asm
( "addq %rax, (%rdi) " ); \

184 
	`asm
( "adcq %rdx, %rcx " ); \

185 
	`asm
Ğ"addq $8, %rd˜ " );

	)

187 
	#MULADDC_STOP
 \

188 
	`asm
Ğ"movq %%rcx, %0 " : "=m" (
c
)); \

189 
	`asm
Ğ"movq %%rdi, %0 " : "=m" (
d
)); \

190 
	`asm
Ğ"movq %%rsi, %0 " : "=m" (
s
) :: \

191 "¿x", "rcx", "rdx", "rbx", "rsi", "rdi", "r8" );

	)

195 #ià
defšed
(
__mc68020__
è|| defšed(
__mıu32__
)

197 
	#MULADDC_INIT
 \

198 
	`asm
Ğ"movÈ %0, %%a2 " :: "m" (
s
)); \

199 
	`asm
Ğ"movÈ %0, %%a3 " :: "m" (
d
)); \

200 
	`asm
Ğ"movÈ %0, %%d3 " :: "m" (
c
)); \

201 
	`asm
Ğ"movÈ %0, %%d2 " :: "m" (
b
)); \

202 
	`asm
Ğ"moveq #0, %d0 " );

	)

204 
	#MULADDC_CORE
 \

205 
	`asm
( "movel %a2@+, %d1 " ); \

206 
	`asm
( "mulul %d2, %d4:%d1 " ); \

207 
	`asm
( "addl %d3, %d1 " ); \

208 
	`asm
( "addxl %d0, %d4 " ); \

209 
	`asm
( "moveq #0, %d3 " ); \

210 
	`asm
( "addl %d1, %a3@+ " ); \

211 
	`asm
Ğ"addxÈ %d4, %d3 " );

	)

213 
	#MULADDC_STOP
 \

214 
	`asm
Ğ"movÈ %%d3, %0 " : "=m" (
c
)); \

215 
	`asm
Ğ"movÈ %%a3, %0 " : "=m" (
d
)); \

216 
	`asm
Ğ"movÈ %%a2, %0 " : "=m" (
s
) :: \

217 "d0", "d1", "d2", "d3", "d4", "a2", "a3" );

	)

219 
	#MULADDC_HUIT
 \

220 
	`asm
( "movel %a2@+, %d1 " ); \

221 
	`asm
( "mulul %d2, %d4:%d1 " ); \

222 
	`asm
( "addxl %d3, %d1 " ); \

223 
	`asm
( "addxl %d0, %d4 " ); \

224 
	`asm
( "addl %d1, %a3@+ " ); \

225 
	`asm
( "movel %a2@+, %d1 " ); \

226 
	`asm
( "mulul %d2, %d3:%d1 " ); \

227 
	`asm
( "addxl %d4, %d1 " ); \

228 
	`asm
( "addxl %d0, %d3 " ); \

229 
	`asm
( "addl %d1, %a3@+ " ); \

230 
	`asm
( "movel %a2@+, %d1 " ); \

231 
	`asm
( "mulul %d2, %d4:%d1 " ); \

232 
	`asm
( "addxl %d3, %d1 " ); \

233 
	`asm
( "addxl %d0, %d4 " ); \

234 
	`asm
( "addl %d1, %a3@+ " ); \

235 
	`asm
( "movel %a2@+, %d1 " ); \

236 
	`asm
( "mulul %d2, %d3:%d1 " ); \

237 
	`asm
( "addxl %d4, %d1 " ); \

238 
	`asm
( "addxl %d0, %d3 " ); \

239 
	`asm
( "addl %d1, %a3@+ " ); \

240 
	`asm
( "movel %a2@+, %d1 " ); \

241 
	`asm
( "mulul %d2, %d4:%d1 " ); \

242 
	`asm
( "addxl %d3, %d1 " ); \

243 
	`asm
( "addxl %d0, %d4 " ); \

244 
	`asm
( "addl %d1, %a3@+ " ); \

245 
	`asm
( "movel %a2@+, %d1 " ); \

246 
	`asm
( "mulul %d2, %d3:%d1 " ); \

247 
	`asm
( "addxl %d4, %d1 " ); \

248 
	`asm
( "addxl %d0, %d3 " ); \

249 
	`asm
( "addl %d1, %a3@+ " ); \

250 
	`asm
( "movel %a2@+, %d1 " ); \

251 
	`asm
( "mulul %d2, %d4:%d1 " ); \

252 
	`asm
( "addxl %d3, %d1 " ); \

253 
	`asm
( "addxl %d0, %d4 " ); \

254 
	`asm
( "addl %d1, %a3@+ " ); \

255 
	`asm
( "movel %a2@+, %d1 " ); \

256 
	`asm
( "mulul %d2, %d3:%d1 " ); \

257 
	`asm
( "addxl %d4, %d1 " ); \

258 
	`asm
( "addxl %d0, %d3 " ); \

259 
	`asm
( "addl %d1, %a3@+ " ); \

260 
	`asm
Ğ"addxÈ %d0, %d3 " );

	)

264 #ià
defšed
(
__pow”pc__
è|| defšed(
__µc__
)

265 #ià
defšed
(
__pow”pc64__
è|| defšed(
__µc64__
)

267 #ià
defšed
(
__MACH__
è&& defšed(
__APPLE__
)

269 
	#MULADDC_INIT
 \

270 
	`asm
Ğ"ld„3, %0 " :: "m" (
s
)); \

271 
	`asm
Ğ"ld„4, %0 " :: "m" (
d
)); \

272 
	`asm
Ğ"ld„5, %0 " :: "m" (
c
)); \

273 
	`asm
Ğ"ld„6, %0 " :: "m" (
b
)); \

274 
	`asm
( "addi„3,„3, -8 " ); \

275 
	`asm
( "addi„4,„4, -8 " ); \

276 
	`asm
Ğ"addiø„5,„5, 0 " );

	)

278 
	#MULADDC_CORE
 \

279 
	`asm
( "ldu„7, 8(r3) " ); \

280 
	`asm
( "mulld„8,„7,„6 " ); \

281 
	`asm
( "mulhdu„9,„7,„6 " ); \

282 
	`asm
( "adde„8,„8,„5 " ); \

283 
	`asm
( "ld„7, 8(r4) " ); \

284 
	`asm
( "addze„5,„9 " ); \

285 
	`asm
( "addc„8,„8,„7 " ); \

286 
	`asm
Ğ"¡du„8, 8Ô4è " );

	)

288 
	#MULADDC_STOP
 \

289 
	`asm
( "addze„5,„5 " ); \

290 
	`asm
( "addi„4,„4, 8 " ); \

291 
	`asm
( "addi„3,„3, 8 " ); \

292 
	`asm
Ğ"¡d„5, %0 " : "=m" (
c
)); \

293 
	`asm
Ğ"¡d„4, %0 " : "=m" (
d
)); \

294 
	`asm
Ğ"¡d„3, %0 " : "=m" (
s
) :: \

295 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

299 
	#MULADDC_INIT
 \

300 
	`asm
Ğ"ld %%r3, %0 " :: "m" (
s
)); \

301 
	`asm
Ğ"ld %%r4, %0 " :: "m" (
d
)); \

302 
	`asm
Ğ"ld %%r5, %0 " :: "m" (
c
)); \

303 
	`asm
Ğ"ld %%r6, %0 " :: "m" (
b
)); \

304 
	`asm
( "addi %r3, %r3, -8 " ); \

305 
	`asm
( "addi %r4, %r4, -8 " ); \

306 
	`asm
Ğ"addiø %r5, %r5, 0 " );

	)

308 
	#MULADDC_CORE
 \

309 
	`asm
( "ldu %r7, 8(%r3) " ); \

310 
	`asm
( "mulld %r8, %r7, %r6 " ); \

311 
	`asm
( "mulhdu %r9, %r7, %r6 " ); \

312 
	`asm
( "adde %r8, %r8, %r5 " ); \

313 
	`asm
( "ld %r7, 8(%r4) " ); \

314 
	`asm
( "addze %r5, %r9 " ); \

315 
	`asm
( "addc %r8, %r8, %r7 " ); \

316 
	`asm
Ğ"¡du %r8, 8(%r4è " );

	)

318 
	#MULADDC_STOP
 \

319 
	`asm
( "addze %r5, %r5 " ); \

320 
	`asm
( "addi %r4, %r4, 8 " ); \

321 
	`asm
( "addi %r3, %r3, 8 " ); \

322 
	`asm
Ğ"¡d %%r5, %0 " : "=m" (
c
)); \

323 
	`asm
Ğ"¡d %%r4, %0 " : "=m" (
d
)); \

324 
	`asm
Ğ"¡d %%r3, %0 " : "=m" (
s
) :: \

325 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

331 #ià
defšed
(
__MACH__
è&& defšed(
__APPLE__
)

333 
	#MULADDC_INIT
 \

334 
	`asm
Ğ"lwz„3, %0 " :: "m" (
s
)); \

335 
	`asm
Ğ"lwz„4, %0 " :: "m" (
d
)); \

336 
	`asm
Ğ"lwz„5, %0 " :: "m" (
c
)); \

337 
	`asm
Ğ"lwz„6, %0 " :: "m" (
b
)); \

338 
	`asm
( "addi„3,„3, -4 " ); \

339 
	`asm
( "addi„4,„4, -4 " ); \

340 
	`asm
Ğ"addiø„5,„5, 0 " );

	)

342 
	#MULADDC_CORE
 \

343 
	`asm
( "lwzu„7, 4(r3) " ); \

344 
	`asm
( "mullw„8,„7,„6 " ); \

345 
	`asm
( "mulhwu„9,„7,„6 " ); \

346 
	`asm
( "adde„8,„8,„5 " ); \

347 
	`asm
( "lwz„7, 4(r4) " ); \

348 
	`asm
( "addze„5,„9 " ); \

349 
	`asm
( "addc„8,„8,„7 " ); \

350 
	`asm
Ğ"¡wu„8, 4Ô4è " );

	)

352 
	#MULADDC_STOP
 \

353 
	`asm
( "addze„5,„5 " ); \

354 
	`asm
( "addi„4,„4, 4 " ); \

355 
	`asm
( "addi„3,„3, 4 " ); \

356 
	`asm
Ğ"¡w„5, %0 " : "=m" (
c
)); \

357 
	`asm
Ğ"¡w„4, %0 " : "=m" (
d
)); \

358 
	`asm
Ğ"¡w„3, %0 " : "=m" (
s
) :: \

359 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

363 
	#MULADDC_INIT
 \

364 
	`asm
Ğ"lwz %%r3, %0 " :: "m" (
s
)); \

365 
	`asm
Ğ"lwz %%r4, %0 " :: "m" (
d
)); \

366 
	`asm
Ğ"lwz %%r5, %0 " :: "m" (
c
)); \

367 
	`asm
Ğ"lwz %%r6, %0 " :: "m" (
b
)); \

368 
	`asm
( "addi %r3, %r3, -4 " ); \

369 
	`asm
( "addi %r4, %r4, -4 " ); \

370 
	`asm
Ğ"addiø %r5, %r5, 0 " );

	)

372 
	#MULADDC_CORE
 \

373 
	`asm
( "lwzu %r7, 4(%r3) " ); \

374 
	`asm
( "mullw %r8, %r7, %r6 " ); \

375 
	`asm
( "mulhwu %r9, %r7, %r6 " ); \

376 
	`asm
( "adde %r8, %r8, %r5 " ); \

377 
	`asm
( "lwz %r7, 4(%r4) " ); \

378 
	`asm
( "addze %r5, %r9 " ); \

379 
	`asm
( "addc %r8, %r8, %r7 " ); \

380 
	`asm
Ğ"¡wu %r8, 4(%r4è " );

	)

382 
	#MULADDC_STOP
 \

383 
	`asm
( "addze %r5, %r5 " ); \

384 
	`asm
( "addi %r4, %r4, 4 " ); \

385 
	`asm
( "addi %r3, %r3, 4 " ); \

386 
	`asm
Ğ"¡w %%r5, %0 " : "=m" (
c
)); \

387 
	`asm
Ğ"¡w %%r4, %0 " : "=m" (
d
)); \

388 
	`asm
Ğ"¡w %%r3, %0 " : "=m" (
s
) :: \

389 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

396 #ià
defšed
(
__¥¬c__
)

398 
	#MULADDC_INIT
 \

399 
	`asm
Ğ"ld %0, %%o0 " :: "m" (
s
)); \

400 
	`asm
Ğ"ld %0, %%o1 " :: "m" (
d
)); \

401 
	`asm
Ğ"ld %0, %%o2 " :: "m" (
c
)); \

402 
	`asm
Ğ"ld %0, %%o3 " :: "m" (
b
));

	)

404 
	#MULADDC_CORE
 \

405 
	`asm
( "ld [%o0], %o4 " ); \

406 
	`asm
( "inc 4, %o0 " ); \

407 
	`asm
( "ld [%o1], %o5 " ); \

408 
	`asm
( "umul %o3, %o4, %o4 " ); \

409 
	`asm
( "addcc %o4, %o2, %o4 " ); \

410 
	`asm
( "rd %y, %g1 " ); \

411 
	`asm
( "addx %g1, 0, %g1 " ); \

412 
	`asm
( "addcc %o4, %o5, %o4 " ); \

413 
	`asm
( "st %o4, [%o1] " ); \

414 
	`asm
( "addx %g1, 0, %o2 " ); \

415 
	`asm
Ğ"šø 4, %o1 " );

	)

417 
	#MULADDC_STOP
 \

418 
	`asm
Ğ"¡ %%o2, %0 " : "=m" (
c
)); \

419 
	`asm
Ğ"¡ %%o1, %0 " : "=m" (
d
)); \

420 
	`asm
Ğ"¡ %%o0, %0 " : "=m" (
s
) :: \

421 "g1", "o0", "o1", "o2", "o3", "o4", "o5" );

	)

425 #ià
defšed
(
__miüobÏze__
è|| defšed(
miüobÏze
)

427 
	#MULADDC_INIT
 \

428 
	`asm
Ğ"lw˜„3, %0 " :: "m" (
s
)); \

429 
	`asm
Ğ"lw˜„4, %0 " :: "m" (
d
)); \

430 
	`asm
Ğ"lw˜„5, %0 " :: "m" (
c
)); \

431 
	`asm
Ğ"lw˜„6, %0 " :: "m" (
b
)); \

432 
	`asm
( "andi„7,„6, 0xffff" ); \

433 
	`asm
Ğ"b¤l˜r6,„6, 16 " );

	)

435 
	#MULADDC_CORE
 \

436 
	`asm
( "lhui„8,„3, 0 " ); \

437 
	`asm
( "addi„3,„3, 2 " ); \

438 
	`asm
( "lhui„9,„3, 0 " ); \

439 
	`asm
( "addi„3,„3, 2 " ); \

440 
	`asm
( "mul„10,„9,„6 " ); \

441 
	`asm
( "mul„11,„8,„7 " ); \

442 
	`asm
( "mul„12,„9,„7 " ); \

443 
	`asm
( "mul„13,„8,„6 " ); \

444 
	`asm
( "bsrli„8,„10, 16 " ); \

445 
	`asm
( "bsrli„9,„11, 16 " ); \

446 
	`asm
( "add„13,„13,„8 " ); \

447 
	`asm
( "add„13,„13,„9 " ); \

448 
	`asm
( "bslli„10,„10, 16 " ); \

449 
	`asm
( "bslli„11,„11, 16 " ); \

450 
	`asm
( "add„12,„12,„10 " ); \

451 
	`asm
( "addc„13,„13,„0 " ); \

452 
	`asm
( "add„12,„12,„11 " ); \

453 
	`asm
( "addc„13,„13,„0 " ); \

454 
	`asm
( "lwi„10,„4, 0 " ); \

455 
	`asm
( "add„12,„12,„10 " ); \

456 
	`asm
( "addc„13,„13,„0 " ); \

457 
	`asm
( "add„12,„12,„5 " ); \

458 
	`asm
( "addc„5,„13,„0 " ); \

459 
	`asm
( "swi„12,„4, 0 " ); \

460 
	`asm
Ğ"add˜„4,„4, 4 " );

	)

462 
	#MULADDC_STOP
 \

463 
	`asm
Ğ"sw˜„5, %0 " : "=m" (
c
)); \

464 
	`asm
Ğ"sw˜„4, %0 " : "=m" (
d
)); \

465 
	`asm
Ğ"sw˜„3, %0 " : "=m" (
s
) :: \

467 "r9", "r10", "r11", "r12", "r13" );

	)

471 #ià
defšed
(
__ŒicÜe__
)

473 
	#MULADDC_INIT
 \

474 
	`asm
Ğ"ld.¨ %%a2, %0 " :: "m" (
s
)); \

475 
	`asm
Ğ"ld.¨ %%a3, %0 " :: "m" (
d
)); \

476 
	`asm
Ğ"ld.w %%d4, %0 " :: "m" (
c
)); \

477 
	`asm
Ğ"ld.w %%d1, %0 " :: "m" (
b
)); \

478 
	`asm
Ğ"xÜ %d5, %d5 " );

	)

480 
	#MULADDC_CORE
 \

481 
	`asm
( "ld.w %d0, [%a2+] " ); \

482 
	`asm
( "madd.u %e2, %e4, %d0, %d1 " ); \

483 
	`asm
( "ld.w %d0, [%a3] " ); \

484 
	`asm
( "addx %d2, %d2, %d0 " ); \

485 
	`asm
( "addc %d3, %d3, 0 " ); \

486 
	`asm
( "mov %d4, %d3 " ); \

487 
	`asm
Ğ"¡.w [%a3+], %d2 " );

	)

489 
	#MULADDC_STOP
 \

490 
	`asm
Ğ"¡.w %0, %%d4 " : "=m" (
c
)); \

491 
	`asm
Ğ"¡.¨ %0, %%a3 " : "=m" (
d
)); \

492 
	`asm
Ğ"¡.¨ %0, %%a2 " : "=m" (
s
) :: \

493 "d0", "d1", "e2", "d4", "a2", "a3" );

	)

497 #ià
defšed
(
__¬m__
)

499 
	#MULADDC_INIT
 \

500 
	`asm
Ğ"ld¸„0, %0 " :: "m" (
s
)); \

501 
	`asm
Ğ"ld¸„1, %0 " :: "m" (
d
)); \

502 
	`asm
Ğ"ld¸„2, %0 " :: "m" (
c
)); \

503 
	`asm
Ğ"ld¸„3, %0 " :: "m" (
b
));

	)

505 
	#MULADDC_CORE
 \

506 
	`asm
( "ldr„4, [r0], #4 " ); \

507 
	`asm
( "mov„5, #0 " ); \

508 
	`asm
( "ldr„6, [r1] " ); \

509 
	`asm
( "umlal„2,„5,„3,„4 " ); \

510 
	`asm
( "adds„7,„6,„2 " ); \

511 
	`asm
( "adc„2,„5, #0 " ); \

512 
	`asm
Ğ"¡¸„7, [r1], #4 " );

	)

514 
	#MULADDC_STOP
 \

515 
	`asm
Ğ"¡¸„2, %0 " : "=m" (
c
)); \

516 
	`asm
Ğ"¡¸„1, %0 " : "=m" (
d
)); \

517 
	`asm
Ğ"¡¸„0, %0 " : "=m" (
s
) :: \

518 "r0", "r1", "r2", "r3", "r4", "r5", "r6", "r7" );

	)

522 #ià
defšed
(
__®pha__
)

524 
	#MULADDC_INIT
 \

525 
	`asm
Ğ"ldq $1, %0 " :: "m" (
s
)); \

526 
	`asm
Ğ"ldq $2, %0 " :: "m" (
d
)); \

527 
	`asm
Ğ"ldq $3, %0 " :: "m" (
c
)); \

528 
	`asm
Ğ"ldq $4, %0 " :: "m" (
b
));

	)

530 
	#MULADDC_CORE
 \

531 
	`asm
( "ldq $6, 0($1) " ); \

532 
	`asm
( "addq $1, 8, $1 " ); \

533 
	`asm
( "mulq $6, $4, $7 " ); \

534 
	`asm
( "umulh $6, $4, $6 " ); \

535 
	`asm
( "addq $7, $3, $7 " ); \

536 
	`asm
( "cmpult $7, $3, $3 " ); \

537 
	`asm
( "ldq $5, 0($2) " ); \

538 
	`asm
( "addq $7, $5, $7 " ); \

539 
	`asm
( "cmpult $7, $5, $5 " ); \

540 
	`asm
( "stq $7, 0($2) " ); \

541 
	`asm
( "addq $2, 8, $2 " ); \

542 
	`asm
( "addq $6, $3, $3 " ); \

543 
	`asm
Ğ"addq $5, $3, $3 " );

	)

545 
	#MULADDC_STOP
 \

546 
	`asm
Ğ"¡q $3, %0 " : "=m" (
c
)); \

547 
	`asm
Ğ"¡q $2, %0 " : "=m" (
d
)); \

548 
	`asm
Ğ"¡q $1, %0 " : "=m" (
s
) :: \

549 "$1", "$2", "$3", "$4", "$5", "$6", "$7" );

	)

553 #ià
defšed
(
__ms__
)

555 
	#MULADDC_INIT
 \

556 
	`asm
Ğ"lw $10, %0 " :: "m" (
s
)); \

557 
	`asm
Ğ"lw $11, %0 " :: "m" (
d
)); \

558 
	`asm
Ğ"lw $12, %0 " :: "m" (
c
)); \

559 
	`asm
Ğ"lw $13, %0 " :: "m" (
b
));

	)

561 
	#MULADDC_CORE
 \

562 
	`asm
( "lw $14, 0($10) " ); \

563 
	`asm
( "multu $13, $14 " ); \

564 
	`asm
( "addi $10, $10, 4 " ); \

565 
	`asm
( "mflo $14 " ); \

566 
	`asm
( "mfhi $9 " ); \

567 
	`asm
( "addu $14, $12, $14 " ); \

568 
	`asm
( "lw $15, 0($11) " ); \

569 
	`asm
( "sltu $12, $14, $12 " ); \

570 
	`asm
( "addu $15, $14, $15 " ); \

571 
	`asm
( "sltu $14, $15, $14 " ); \

572 
	`asm
( "addu $12, $12, $9 " ); \

573 
	`asm
( "sw $15, 0($11) " ); \

574 
	`asm
( "addu $12, $12, $14 " ); \

575 
	`asm
Ğ"add˜ $11, $11, 4 " );

	)

577 
	#MULADDC_STOP
 \

578 
	`asm
Ğ"sw $12, %0 " : "=m" (
c
)); \

579 
	`asm
Ğ"sw $11, %0 " : "=m" (
d
)); \

580 
	`asm
Ğ"sw $10, %0 " : "=m" (
s
) :: \

581 "$9", "$10", "$11", "$12", "$13", "$14", "$15" );

	)

586 #ià(
defšed
(
_MSC_VER
è&& defšed(
_M_IX86
)è|| defšed(
__WATCOMC__
)

588 
	#MULADDC_INIT
 \

589 
__asm
 
mov
 
esi
, 
s
 \

590 
__asm
 
mov
 
edi
, 
d
 \

591 
__asm
 
mov
 
ecx
, 
c
 \

592 
__asm
 
mov
 
ebx
, 
b


	)

594 
	#MULADDC_CORE
 \

595 
__asm
 
lodsd
 \

596 
__asm
 
mul
 
ebx
 \

597 
__asm
 
add
 
—x
, 
ecx
 \

598 
__asm
 
adc
 
edx
, 0 \

599 
__asm
 
add
 
—x
, [
edi
] \

600 
__asm
 
adc
 
edx
, 0 \

601 
__asm
 
mov
 
ecx
, 
edx
 \

602 
__asm
 
¡osd


	)

604 #ià
defšed
(
POLARSSL_HAVE_SSE2
)

606 
	#EMIT
 
__asm
 
_em™


	)

608 
	#MULADDC_HUIT
 \

609 
EMIT
 0x0F EMIT 0x6E EMIT 0xC9 \

610 
EMIT
 0x0F EMIT 0x6E EMIT 0xC3 \

611 
EMIT
 0x0F EMIT 0x6E EMIT 0x1F \

612 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCB \

613 
EMIT
 0x0F EMIT 0x6E EMIT 0x16 \

614 
EMIT
 0x0F EMIT 0xF4 EMIT 0xD0 \

615 
EMIT
 0x0F EMIT 0x6E EMIT 0x66 EMIT 0x04 \

616 
EMIT
 0x0F EMIT 0xF4 EMIT 0xE0 \

617 
EMIT
 0x0F EMIT 0x6E EMIT 0x76 EMIT 0x08 \

618 
EMIT
 0x0F EMIT 0xF4 EMIT 0xF0 \

619 
EMIT
 0x0F EMIT 0x6E EMIT 0x7E EMIT 0x0C \

620 
EMIT
 0x0F EMIT 0xF4 EMIT 0xF8 \

621 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCA \

622 
EMIT
 0x0F EMIT 0x6E EMIT 0x5F EMIT 0x04 \

623 
EMIT
 0x0F EMIT 0xD4 EMIT 0xDC \

624 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x08 \

625 
EMIT
 0x0F EMIT 0xD4 EMIT 0xEE \

626 
EMIT
 0x0F EMIT 0x6E EMIT 0x67 EMIT 0x0C \

627 
EMIT
 0x0F EMIT 0xD4 EMIT 0xFC \

628 
EMIT
 0x0F EMIT 0x7E EMIT 0x0F \

629 
EMIT
 0x0F EMIT 0x6E EMIT 0x56 EMIT 0x10 \

630 
EMIT
 0x0F EMIT 0xF4 EMIT 0xD0 \

631 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

632 
EMIT
 0x0F EMIT 0x6E EMIT 0x66 EMIT 0x14 \

633 
EMIT
 0x0F EMIT 0xF4 EMIT 0xE0 \

634 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCB \

635 
EMIT
 0x0F EMIT 0x6E EMIT 0x76 EMIT 0x18 \

636 
EMIT
 0x0F EMIT 0xF4 EMIT 0xF0 \

637 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x04 \

638 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

639 
EMIT
 0x0F EMIT 0x6E EMIT 0x5E EMIT 0x1C \

640 
EMIT
 0x0F EMIT 0xF4 EMIT 0xD8 \

641 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCD \

642 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x10 \

643 
EMIT
 0x0F EMIT 0xD4 EMIT 0xD5 \

644 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x08 \

645 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

646 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCF \

647 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x14 \

648 
EMIT
 0x0F EMIT 0xD4 EMIT 0xE5 \

649 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x0C \

650 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

651 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCA \

652 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x18 \

653 
EMIT
 0x0F EMIT 0xD4 EMIT 0xF5 \

654 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x10 \

655 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

656 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCC \

657 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x1C \

658 
EMIT
 0x0F EMIT 0xD4 EMIT 0xDD \

659 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x14 \

660 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

661 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCE \

662 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x18 \

663 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

664 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCB \

665 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x1C \

666 
EMIT
 0x83 EMIT 0xC7 EMIT 0x20 \

667 
EMIT
 0x83 EMIT 0xC6 EMIT 0x20 \

668 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

669 
EMIT
 0x0F EMIT 0x7E EMIT 0xC9

	)

671 
	#MULADDC_STOP
 \

672 
EMIT
 0x0F EMIT 0x77 \

673 
__asm
 
mov
 
c
, 
ecx
 \

674 
__asm
 
mov
 
d
, 
edi
 \

675 
__asm
 
mov
 
s
, 
esi
 \

676 

	)

679 
	#MULADDC_STOP
 \

680 
__asm
 
mov
 
c
, 
ecx
 \

681 
__asm
 
mov
 
d
, 
edi
 \

682 
__asm
 
mov
 
s
, 
esi
 \

683 

	)

689 #ià!
defšed
(
MULADDC_CORE
)

690 #ià
defšed
(
POLARSSL_HAVE_LONGLONG
)

692 
	#MULADDC_INIT
 \

694 
t_dbl
 
r
; \

695 
t_št
 
r0
, 
r1
;

	)

697 
	#MULADDC_CORE
 \

698 
r
 = *(
s
++è* (
t_dbl
è
b
; \

699 
r0
 = 
r
; \

700 
r1
 = 
r
 >> 
biL
; \

701 
r0
 +ğ
c
; 
r1
 += (r0 < c); \

702 
r0
 +ğ*
d
; 
r1
 += (r0 < *d); \

703 
c
 = 
r1
; *(
d
++èğ
r0
;

	)

705 
	#MULADDC_STOP
 \

706 }

	)

709 
	#MULADDC_INIT
 \

711 
t_št
 
s0
, 
s1
, 
b0
, 
b1
; \

712 
t_št
 
r0
, 
r1
, 
rx
, 
ry
; \

713 
b0
 = ( 
b
 << 
biH
 ) >> biH; \

714 
b1
 = ( 
b
 >> 
biH
 );

	)

716 
	#MULADDC_CORE
 \

717 
s0
 = ( *
s
 << 
biH
 ) >> biH; \

718 
s1
 = ( *
s
 >> 
biH
 ); s++; \

719 
rx
 = 
s0
 * 
b1
; 
r0
 = s0 * 
b0
; \

720 
ry
 = 
s1
 * 
b0
; 
r1
 = s1 * 
b1
; \

721 
r1
 +ğĞ
rx
 >> 
biH
 ); \

722 
r1
 +ğĞ
ry
 >> 
biH
 ); \

723 
rx
 <<ğ
biH
; 
ry
 <<= biH; \

724 
r0
 +ğ
rx
; 
r1
 += (r0 <„x); \

725 
r0
 +ğ
ry
; 
r1
 += (r0 <„y); \

726 
r0
 +ğ
c
; 
r1
 += (r0 < c); \

727 
r0
 +ğ*
d
; 
r1
 += (r0 < *d); \

728 
c
 = 
r1
; *(
d
++èğ
r0
;

	)

730 
	#MULADDC_STOP
 \

731 }

	)

	@src/polarssl/camellia.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

36 
	~"pŞ¬s¦/ÿm–lŸ.h
"

38 
	~<¡ršg.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

63 cÚ¡ 
	gSIGMA_CHARS
[6][8] =

73 #ifdeà
POLARSSL_CAMELLIA_SMALL_MEMORY


75 cÚ¡ 
	gFSb
[256] =

95 
	#SBOX1
(
n
è
FSb
[Ò)]

	)

96 
	#SBOX2
(
n
è()((
FSb
[Ò)] >> 7 ^ FSb[Ò)] << 1è& 0xff)

	)

97 
	#SBOX3
(
n
è()((
FSb
[Ò)] >> 1 ^ FSb[Ò)] << 7è& 0xff)

	)

98 
	#SBOX4
(
n
è
FSb
[(Òè<< 1 ^ (nè>> 7è&0xff]

	)

102 cÚ¡ 
	gFSb
[256] =

122 cÚ¡ 
	gFSb2
[256] =

142 cÚ¡ 
	gFSb3
[256] =

162 cÚ¡ 
	gFSb4
[256] =

182 
	#SBOX1
(
n
è
FSb
[Ò)]

	)

183 
	#SBOX2
(
n
è
FSb2
[Ò)]

	)

184 
	#SBOX3
(
n
è
FSb3
[Ò)]

	)

185 
	#SBOX4
(
n
è
FSb4
[Ò)]

	)

189 cÚ¡ 
	gshiás
[2][4][4] =

205 cÚ¡ sigÃd 
	gšdexes
[2][4][20] =

229 cÚ¡ sigÃd 
	gŒª¥o£s
[2][20] =

248 
	#ROTL
(
DEST
, 
SRC
, 
SHIFT
) \

250 (
DEST
)[0] = (
SRC
)[0] << (
SHIFT
) ^ (SRC)[1] >> (32 - (SHIFT)); \

251 (
DEST
)[1] = (
SRC
)[1] << (
SHIFT
) ^ (SRC)[2] >> (32 - (SHIFT)); \

252 (
DEST
)[2] = (
SRC
)[2] << (
SHIFT
) ^ (SRC)[3] >> (32 - (SHIFT)); \

253 (
DEST
)[3] = (
SRC
)[3] << (
SHIFT
) ^ (SRC)[0] >> (32 - (SHIFT)); \

254 }

	)

256 
	#FL
(
XL
, 
XR
, 
KL
, 
KR
) \

258 (
XR
èğ((((
XL
è& (
KL
)) << 1) | (((XL) & (KL)) >> 31)) ^ (XR); \

259 (
XL
èğ((
XR
è| (
KR
)) ^ (XL); \

260 }

	)

262 
	#FLInv
(
YL
, 
YR
, 
KL
, 
KR
) \

264 (
YL
èğ((
YR
è| (
KR
)) ^ (YL); \

265 (
YR
èğ((((
YL
è& (
KL
)) << 1) | (((YL) & (KL)) >> 31)) ^ (YR); \

266 }

	)

268 
	#SHIFT_AND_PLACE
(
INDEX
, 
OFFSET
) \

270 
TK
[0] = 
KC
[(
OFFSET
) * 4 + 0]; \

271 
TK
[1] = 
KC
[(
OFFSET
) * 4 + 1]; \

272 
TK
[2] = 
KC
[(
OFFSET
) * 4 + 2]; \

273 
TK
[3] = 
KC
[(
OFFSET
) * 4 + 3]; \

275  
i
 = 1; i <= 4; i++ ) \

276 ià(
shiás
[(
INDEX
)][(
OFFSET
)][
i
 -1]) \

277 
	`ROTL
(
TK
 + 
i
 * 4, TK, (15 * i) % 32); \

279  
i
 = 0; i < 20; i++ ) \

280 ià(
šdexes
[(
INDEX
)][(
OFFSET
)][
i
] != -1) { \

281 
RK
[
šdexes
[(
INDEX
)][(
OFFSET
)][
i
]] = 
TK
[ i ]; \

283 }

	)

285 
	$ÿm–lŸ_ãi¡–
(cÚ¡ 
ušt32_t
 
x
[2], cÚ¡ ušt32_ˆ
k
[2], ušt32_ˆ
z
[2])

287 
ušt32_t
 
I0
, 
I1
;

288 
I0
 = 
x
[0] ^ 
k
[0];

289 
I1
 = 
x
[1] ^ 
k
[1];

291 
I0
 = (
	`SBOX1
((I0 >> 24) & 0xFF) << 24) |

292 (
	`SBOX2
((
I0
 >> 16) & 0xFF) << 16) |

293 (
	`SBOX3
((
I0
 >> 8) & 0xFF) << 8) |

294 (
	`SBOX4
((
I0
 ) & 0xFF) );

295 
I1
 = (
	`SBOX2
((I1 >> 24) & 0xFF) << 24) |

296 (
	`SBOX3
((
I1
 >> 16) & 0xFF) << 16) |

297 (
	`SBOX4
((
I1
 >> 8) & 0xFF) << 8) |

298 (
	`SBOX1
((
I1
 ) & 0xFF) );

300 
I0
 ^ğ(
I1
 << 8) | (I1 >> 24);

301 
I1
 ^ğ(
I0
 << 16) | (I0 >> 16);

302 
I0
 ^ğ(
I1
 >> 8) | (I1 << 24);

303 
I1
 ^ğ(
I0
 >> 8) | (I0 << 24);

305 
z
[0] ^ğ
I1
;

306 
z
[1] ^ğ
I0
;

307 
	}
}

312 
	$ÿm–lŸ_£tkey_’c
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

314 
i
, 
idx
;

315 
ušt32_t
 *
RK
;

316 
t
[64];

317 
ušt32_t
 
SIGMA
[6][2];

318 
ušt32_t
 
KC
[16];

319 
ušt32_t
 
TK
[20];

321 
RK
 = 
ùx
->
rk
;

323 
	`mem£t
(
t
, 0, 64);

324 
	`mem£t
(
RK
, 0, (
ùx
->
rk
));

326  
keysize
 )

328 128: 
ùx
->
Ä
 = 3; 
idx
 = 0; ;

330 256: 
ùx
->
Ä
 = 4; 
idx
 = 1; ;

331  : Ğ
POLARSSL_ERR_CAMELLIA_INVALID_KEY_LENGTH
 );

334  
i
 = 0; i < 
keysize
 / 8; ++i)

335 
t
[
i
] = 
key
[i];

337 ià(
keysize
 == 192) {

338 
i
 = 0; i < 8; i++)

339 
t
[24 + 
i
] = ~t[16 + i];

345 
i
 = 0; i < 6; i++) {

346 
	`GET_ULONG_BE
(
SIGMA
[
i
][0], 
SIGMA_CHARS
[i], 0);

347 
	`GET_ULONG_BE
(
SIGMA
[
i
][1], 
SIGMA_CHARS
[i], 4);

354 
	`mem£t
(
KC
, 0, (KC));

357 
i
 = 0; i < 8; i++)

358 
	`GET_ULONG_BE
(
KC
[
i
], 
t
, i * 4);

361  
i
 = 0; i < 4; ++i)

362 
KC
[8 + 
i
] = KC[i] ^ KC[4 + i];

364 
	`ÿm–lŸ_ãi¡–
(
KC
 + 8, 
SIGMA
[0], KC + 10);

365 
	`ÿm–lŸ_ãi¡–
(
KC
 + 10, 
SIGMA
[1], KC + 8);

367  
i
 = 0; i < 4; ++i)

368 
KC
[8 + 
i
] ^= KC[i];

370 
	`ÿm–lŸ_ãi¡–
(
KC
 + 8, 
SIGMA
[2], KC + 10);

371 
	`ÿm–lŸ_ãi¡–
(
KC
 + 10, 
SIGMA
[3], KC + 8);

373 ià(
keysize
 > 128) {

375  
i
 = 0; i < 4; ++i)

376 
KC
[12 + 
i
] = KC[4 + i] ^ KC[8 + i];

378 
	`ÿm–lŸ_ãi¡–
(
KC
 + 12, 
SIGMA
[4], KC + 14);

379 
	`ÿm–lŸ_ãi¡–
(
KC
 + 14, 
SIGMA
[5], KC + 12);

387 
	`SHIFT_AND_PLACE
(
idx
, 0);

390 ià(
keysize
 > 128) {

391 
	`SHIFT_AND_PLACE
(
idx
, 1);

395 
	`SHIFT_AND_PLACE
(
idx
, 2);

398 ià(
keysize
 > 128) {

399 
	`SHIFT_AND_PLACE
(
idx
, 3);

403  
i
 = 0; i < 20; i++ ) {

404 ià(
Œª¥o£s
[
idx
][
i
] != -1) {

405 
RK
[32 + 12 * 
idx
 + 
i
] = RK[
Œª¥o£s
[idx][i]];

410 
	}
}

415 
	$ÿm–lŸ_£tkey_dec
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

417 
i
, 
idx
;

418 
ÿm–lŸ_cÚ‹xt
 
ùy
;

419 
ušt32_t
 *
RK
;

420 
ušt32_t
 *
SK
;

421 
»t
;

423  
keysize
 )

425 128: 
ùx
->
Ä
 = 3; 
idx
 = 0; ;

427 256: 
ùx
->
Ä
 = 4; 
idx
 = 1; ;

428  : Ğ
POLARSSL_ERR_CAMELLIA_INVALID_KEY_LENGTH
 );

431 
RK
 = 
ùx
->
rk
;

433 
»t
 = 
	`ÿm–lŸ_£tkey_’c
(&
ùy
, 
key
, 
keysize
);

434 ifĞ
»t
 != 0 )

435 Ğ
»t
 );

437 
SK
 = 
ùy
.
rk
 + 24 * 2 + 8 * 
idx
 * 2;

439 *
RK
++ = *
SK
++;

440 *
RK
++ = *
SK
++;

441 *
RK
++ = *
SK
++;

442 *
RK
++ = *
SK
++;

444 
i
 = 22 + 8 * 
idx
, 
SK
 -= 6; i > 0; i--, SK -= 4)

446 *
RK
++ = *
SK
++;

447 *
RK
++ = *
SK
++;

450 
SK
 -= 2;

452 *
RK
++ = *
SK
++;

453 *
RK
++ = *
SK
++;

454 *
RK
++ = *
SK
++;

455 *
RK
++ = *
SK
++;

457 
	`mem£t
Ğ&
ùy
, 0, Ğ
ÿm–lŸ_cÚ‹xt
 ) );

460 
	}
}

465 
	$ÿm–lŸ_üy±_ecb
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

466 
mode
,

467 cÚ¡ 
šput
[16],

468 
ouut
[16] )

470 
NR
;

471 
ušt32_t
 *
RK
, 
X
[4];

473 Ğ(è
mode
 );

475 
NR
 = 
ùx
->
Ä
;

476 
RK
 = 
ùx
->
rk
;

478 
	`GET_ULONG_BE
Ğ
X
[0], 
šput
, 0 );

479 
	`GET_ULONG_BE
Ğ
X
[1], 
šput
, 4 );

480 
	`GET_ULONG_BE
Ğ
X
[2], 
šput
, 8 );

481 
	`GET_ULONG_BE
Ğ
X
[3], 
šput
, 12 );

483 
X
[0] ^ğ*
RK
++;

484 
X
[1] ^ğ*
RK
++;

485 
X
[2] ^ğ*
RK
++;

486 
X
[3] ^ğ*
RK
++;

488 
NR
) {

489 --
NR
;

490 
	`ÿm–lŸ_ãi¡–
(
X
, 
RK
, X + 2);

491 
RK
 += 2;

492 
	`ÿm–lŸ_ãi¡–
(
X
 + 2, 
RK
, X);

493 
RK
 += 2;

494 
	`ÿm–lŸ_ãi¡–
(
X
, 
RK
, X + 2);

495 
RK
 += 2;

496 
	`ÿm–lŸ_ãi¡–
(
X
 + 2, 
RK
, X);

497 
RK
 += 2;

498 
	`ÿm–lŸ_ãi¡–
(
X
, 
RK
, X + 2);

499 
RK
 += 2;

500 
	`ÿm–lŸ_ãi¡–
(
X
 + 2, 
RK
, X);

501 
RK
 += 2;

503 ià(
NR
) {

504 
	`FL
(
X
[0], X[1], 
RK
[0], RK[1]);

505 
RK
 += 2;

506 
	`FLInv
(
X
[2], X[3], 
RK
[0], RK[1]);

507 
RK
 += 2;

511 
X
[2] ^ğ*
RK
++;

512 
X
[3] ^ğ*
RK
++;

513 
X
[0] ^ğ*
RK
++;

514 
X
[1] ^ğ*
RK
++;

516 
	`PUT_ULONG_BE
Ğ
X
[2], 
ouut
, 0 );

517 
	`PUT_ULONG_BE
Ğ
X
[3], 
ouut
, 4 );

518 
	`PUT_ULONG_BE
Ğ
X
[0], 
ouut
, 8 );

519 
	`PUT_ULONG_BE
Ğ
X
[1], 
ouut
, 12 );

522 
	}
}

527 
	$ÿm–lŸ_üy±_cbc
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

528 
mode
,

529 
Ëngth
,

530 
iv
[16],

531 cÚ¡ *
šput
,

532 *
ouut
 )

534 
i
;

535 
‹mp
[16];

537 ifĞ
Ëngth
 % 16 )

538 Ğ
POLARSSL_ERR_CAMELLIA_INVALID_INPUT_LENGTH
 );

540 ifĞ
mode
 =ğ
CAMELLIA_DECRYPT
 )

542  
Ëngth
 > 0 )

544 
	`memıy
Ğ
‹mp
, 
šput
, 16 );

545 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
mode
, 
šput
, 
ouut
 );

547  
i
 = 0; i < 16; i++ )

548 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

550 
	`memıy
Ğ
iv
, 
‹mp
, 16 );

552 
šput
 += 16;

553 
ouut
 += 16;

554 
Ëngth
 -= 16;

559  
Ëngth
 > 0 )

561  
i
 = 0; i < 16; i++ )

562 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

564 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
mode
, 
ouut
, output );

565 
	`memıy
Ğ
iv
, 
ouut
, 16 );

567 
šput
 += 16;

568 
ouut
 += 16;

569 
Ëngth
 -= 16;

574 
	}
}

579 
	$ÿm–lŸ_üy±_cfb128
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

580 
mode
,

581 
Ëngth
,

582 *
iv_off
,

583 
iv
[16],

584 cÚ¡ *
šput
,

585 *
ouut
 )

587 
c
, 
n
 = *
iv_off
;

589 ifĞ
mode
 =ğ
CAMELLIA_DECRYPT
 )

591  
Ëngth
-- )

593 ifĞ
n
 == 0 )

594 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
CAMELLIA_ENCRYPT
, 
iv
, iv );

596 
c
 = *
šput
++;

597 *
ouut
++ = ()Ğ
c
 ^ 
iv
[
n
] );

598 
iv
[
n
] = (è
c
;

600 
n
 = (n + 1) & 0x0F;

605  
Ëngth
-- )

607 ifĞ
n
 == 0 )

608 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
CAMELLIA_ENCRYPT
, 
iv
, iv );

610 
iv
[
n
] = *
ouut
++ = ()Ğiv[n] ^ *
šput
++ );

612 
n
 = (n + 1) & 0x0F;

616 *
iv_off
 = 
n
;

619 
	}
}

621 #ià
defšed
(
POLARSSL_SELF_TEST
)

623 
	~<¡dio.h
>

633 
	#CAMELLIA_TESTS_ECB
 2

	)

635 cÚ¡ 
	gÿm–lŸ_‹¡_ecb_key
[3][
CAMELLIA_TESTS_ECB
][32] =

663 cÚ¡ 
	gÿm–lŸ_‹¡_ecb_¶aš
[
CAMELLIA_TESTS_ECB
][16] =

671 cÚ¡ 
	gÿm–lŸ_‹¡_ecb_ch”
[3][
CAMELLIA_TESTS_ECB
][16] =

693 
	#CAMELLIA_TESTS_CBC
 3

	)

695 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_key
[3][32] =

710 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_iv
[16] =

716 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_¶aš
[
CAMELLIA_TESTS_CBC
][16] =

727 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_ch”
[3][
CAMELLIA_TESTS_CBC
][16] =

759 
	$ÿm–lŸ_£lf_‹¡
Ğ
v”bo£
 )

761 
i
, 
j
, 
u
, 
v
;

762 
key
[32];

763 
buf
[64];

764 
¤c
[16];

765 
d¡
[16];

766 
iv
[16];

767 
ÿm–lŸ_cÚ‹xt
 
ùx
;

769 
	`mem£t
Ğ
key
, 0, 32 );

771 
j
 = 0; j < 6; j++) {

772 
u
 = 
j
 >> 1;

773 
v
 = 
j
 & 1;

775 ifĞ
v”bo£
 != 0 )

776 
	`´štf
Ğ" CAMELLIA-ECB-%3d (%s): ", 128 + 
u
 * 64,

777 (
v
 =ğ
CAMELLIA_DECRYPT
) ? "dec" : "enc");

779 
i
 = 0; i < 
CAMELLIA_TESTS_ECB
; i++ ) {

780 
	`memıy
Ğ
key
, 
ÿm–lŸ_‹¡_ecb_key
[
u
][
i
], 16 + 8 * u);

782 ià(
v
 =ğ
CAMELLIA_DECRYPT
) {

783 
	`ÿm–lŸ_£tkey_dec
(&
ùx
, 
key
, 128 + 
u
 * 64);

784 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_ecb_ch”
[
u
][
i
], 16);

785 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_ecb_¶aš
[
i
], 16);

787 
	`ÿm–lŸ_£tkey_’c
(&
ùx
, 
key
, 128 + 
u
 * 64);

788 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_ecb_¶aš
[
i
], 16);

789 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_ecb_ch”
[
u
][
i
], 16);

792 
	`ÿm–lŸ_üy±_ecb
(&
ùx
, 
v
, 
¤c
, 
buf
);

794 ifĞ
	`memcmp
Ğ
buf
, 
d¡
, 16 ) != 0 )

796 ifĞ
v”bo£
 != 0 )

797 
	`´štf
( "failed\n" );

803 ifĞ
v”bo£
 != 0 )

804 
	`´štf
( "passed\n" );

807 ifĞ
v”bo£
 != 0 )

808 
	`´štf
( "\n" );

813  
j
 = 0; j < 6; j++ )

815 
u
 = 
j
 >> 1;

816 
v
 = 
j
 & 1;

818 ifĞ
v”bo£
 != 0 )

819 
	`´štf
Ğ" CAMELLIA-CBC-%3d (%s): ", 128 + 
u
 * 64,

820 Ğ
v
 =ğ
CAMELLIA_DECRYPT
 ) ? "dec" : "enc" );

822 
	`memıy
Ğ
¤c
, 
ÿm–lŸ_‹¡_cbc_iv
, 16);

823 
	`memıy
Ğ
d¡
, 
ÿm–lŸ_‹¡_cbc_iv
, 16);

824 
	`memıy
Ğ
key
, 
ÿm–lŸ_‹¡_cbc_key
[
u
], 16 + 8 * u);

826 ià(
v
 =ğ
CAMELLIA_DECRYPT
) {

827 
	`ÿm–lŸ_£tkey_dec
(&
ùx
, 
key
, 128 + 
u
 * 64);

829 
	`ÿm–lŸ_£tkey_’c
(&
ùx
, 
key
, 128 + 
u
 * 64);

832 
i
 = 0; i < 
CAMELLIA_TESTS_CBC
; i++ ) {

834 ià(
v
 =ğ
CAMELLIA_DECRYPT
) {

835 
	`memıy
Ğ
iv
 , 
¤c
, 16 );

836 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_cbc_ch”
[
u
][
i
], 16);

837 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_cbc_¶aš
[
i
], 16);

839 
	`memıy
Ğ
iv
 , 
d¡
, 16 );

840 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_cbc_¶aš
[
i
], 16);

841 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_cbc_ch”
[
u
][
i
], 16);

844 
	`ÿm–lŸ_üy±_cbc
(&
ùx
, 
v
, 16, 
iv
, 
¤c
, 
buf
);

846 ifĞ
	`memcmp
Ğ
buf
, 
d¡
, 16 ) != 0 )

848 ifĞ
v”bo£
 != 0 )

849 
	`´štf
( "failed\n" );

855 ifĞ
v”bo£
 != 0 )

856 
	`´štf
( "passed\n" );

859 ifĞ
v”bo£
 != 0 )

860 
	`´štf
( "\n" );

863 
	}
}

	@src/polarssl/camellia.h

25 #iâdeà
POLARSSL_CAMELLIA_H


26 
	#POLARSSL_CAMELLIA_H


	)

28 #ifdeà
_MSC_VER


29 
	~<ba£tsd.h
>

30 
UINT32
 
	tušt32_t
;

32 
	~<š‰y³s.h
>

35 
	#CAMELLIA_ENCRYPT
 1

	)

36 
	#CAMELLIA_DECRYPT
 0

	)

38 
	#POLARSSL_ERR_CAMELLIA_INVALID_KEY_LENGTH
 -0x0a00

	)

39 
	#POLARSSL_ERR_CAMELLIA_INVALID_INPUT_LENGTH
 -0x0a10

	)

46 
	mÄ
;

47 
ušt32_t
 
	mrk
[68];

49 
	tÿm–lŸ_cÚ‹xt
;

51 #ifdeà
__ılu¥lus


64 
ÿm–lŸ_£tkey_’c
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

75 
ÿm–lŸ_£tkey_dec
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

87 
ÿm–lŸ_üy±_ecb
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

88 
mode
,

89 cÚ¡ 
šput
[16],

90 
ouut
[16] );

106 
ÿm–lŸ_üy±_cbc
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

107 
mode
,

108 
Ëngth
,

109 
iv
[16],

110 cÚ¡ *
šput
,

111 *
ouut
 );

126 
ÿm–lŸ_üy±_cfb128
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

127 
mode
,

128 
Ëngth
,

129 *
iv_off
,

130 
iv
[16],

131 cÚ¡ *
šput
,

132 *
ouut
 );

139 
ÿm–lŸ_£lf_‹¡
Ğ
v”bo£
 );

141 #ifdeà
__ılu¥lus


	@src/polarssl/certs.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_CERTS_C
)

30 cÚ¡ 
	g‹¡_ÿ_üt
[] =

53 cÚ¡ 
	g‹¡_ÿ_key
[] =

85 cÚ¡ 
	g‹¡_ÿ_pwd
[] = "PolarSSLTest";

87 cÚ¡ 
	g‹¡_¤v_üt
[] =

109 cÚ¡ 
	g‹¡_¤v_key
[] =

138 cÚ¡ 
	g‹¡_şi_üt
[] =

160 cÚ¡ 
	g‹¡_şi_key
[] =

	@src/polarssl/certs.h

25 #iâdeà
POLARSSL_CERTS_H


26 
	#POLARSSL_CERTS_H


	)

28 #ifdeà
__ılu¥lus


32 cÚ¡ 
‹¡_ÿ_üt
[];

33 cÚ¡ 
‹¡_ÿ_key
[];

34 cÚ¡ 
‹¡_ÿ_pwd
[];

35 cÚ¡ 
‹¡_¤v_üt
[];

36 cÚ¡ 
‹¡_¤v_key
[];

37 cÚ¡ 
‹¡_şi_üt
[];

38 cÚ¡ 
‹¡_şi_key
[];

40 #ifdeà
__ılu¥lus


	@src/polarssl/config.h

29 #iâdeà
POLARSSL_CONFIG_H


30 
	#POLARSSL_CONFIG_H


	)

32 #iâdeà
_CRT_SECURE_NO_DEPRECATE


33 
	#_CRT_SECURE_NO_DEPRECATE
 1

	)

65 
	#POLARSSL_HAVE_ASM


	)

76 
	#POLARSSL_DEBUG_MSG


	)

81 
	#POLARSSL_SELF_TEST


	)

86 
	#POLARSSL_VERSION_C


	)

91 
	#POLARSSL_GENPRIME


	)

108 
	#POLARSSL_AES_C


	)

118 
	#POLARSSL_ARC4_C


	)

126 
	#POLARSSL_BASE64_C


	)

137 
	#POLARSSL_BIGNUM_C


	)

148 
	#POLARSSL_CAMELLIA_C


	)

156 
	#POLARSSL_CERTS_C


	)

166 
	#POLARSSL_DEBUG_C


	)

176 
	#POLARSSL_DES_C


	)

188 
	#POLARSSL_DHM_C


	)

196 
	#POLARSSL_HAVEGE_C


	)

223 
	#POLARSSL_MD5_C


	)

231 
	#POLARSSL_NET_C


	)

239 
	#POLARSSL_PADLOCK_C


	)

250 
	#POLARSSL_RSA_C


	)

261 
	#POLARSSL_SHA1_C


	)

269 
	#POLARSSL_SHA2_C


	)

277 
	#POLARSSL_SHA4_C


	)

285 
	#POLARSSL_SSL_CLI_C


	)

293 
	#POLARSSL_SSL_SRV_C


	)

302 
	#POLARSSL_SSL_TLS_C


	)

310 
	#POLARSSL_TIMING_C


	)

320 
	#POLARSSL_X509_PARSE_C


	)

328 
	#POLARSSL_X509_WRITE_C


	)

334 
	#POLARSSL_XTEA_C


	)

	@src/polarssl/debug.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_DEBUG_C
)

30 
	~"pŞ¬s¦/debug.h
"

32 
	~<¡d¬g.h
>

33 
	~<¡dlib.h
>

35 #ià
defšed
 
_MSC_VER
 && !defšed 
¢´štf


36 
	#¢´štf
 
_¢´štf


	)

39 #ià
defšed
 
_MSC_VER
 && !defšed 
v¢´štf


40 
	#v¢´štf
 
_v¢´štf


	)

43 *
	$debug_fmt
ĞcÚ¡ *
fÜm©
, ... )

45 
va_li¡
 
¬gp
;

46 
¡r
[512];

47 
maxËn
 = Ğ
¡r
 ) - 1;

49 
	`va_¡¬t
Ğ
¬gp
, 
fÜm©
 );

50 
	`v¢´štf
Ğ
¡r
, 
maxËn
, 
fÜm©
, 
¬gp
 );

51 
	`va_’d
Ğ
¬gp
 );

53 
¡r
[
maxËn
] = '\0';

54 Ğ
¡r
 );

55 
	}
}

57 
	$debug_´št_msg
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

58 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
 )

60 
¡r
[512];

61 
maxËn
 = Ğ
¡r
 ) - 1;

63 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 )

66 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %s\n", 
fe
, 
lše
, 
‹xt
 );

67 
¡r
[
maxËn
] = '\0';

68 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

69 
	}
}

71 
	$debug_´št_»t
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

72 cÚ¡ *
fe
, 
lše
,

73 cÚ¡ *
‹xt
, 
»t
 )

75 
¡r
[512];

76 
maxËn
 = Ğ
¡r
 ) - 1;

78 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 )

81 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %s()„eturned %d (0x%x)\n",

82 
fe
, 
lše
, 
‹xt
, 
»t
,„et );

84 
¡r
[
maxËn
] = '\0';

85 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

86 
	}
}

88 
	$debug_´št_buf
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

89 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
,

90 *
buf
, 
Ën
 )

92 
¡r
[512];

93 
i
, 
maxËn
 = Ğ
¡r
 ) - 1;

95 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 || 
Ën
 < 0 )

98 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): dumping '%s' (%d bytes)\n",

99 
fe
, 
lše
, 
‹xt
, 
Ën
 );

101 
¡r
[
maxËn
] = '\0';

102 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

104  
i
 = 0; i < 
Ën
; i++ )

106 ifĞ
i
 >= 4096 )

109 ifĞ
i
 % 16 == 0 )

111 ifĞ
i
 > 0 )

112 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

114 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %04x: ", 
fe
, 
lše
, 
i
 );

116 
¡r
[
maxËn
] = '\0';

117 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

120 
	`¢´štf
Ğ
¡r
, 
maxËn
, " %02x", (è
buf
[
i
] );

122 
¡r
[
maxËn
] = '\0';

123 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

126 ifĞ
Ën
 > 0 )

127 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

128 
	}
}

130 
	$debug_´št_mpi
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

131 cÚ¡ *
fe
, 
lše
,

132 cÚ¡ *
‹xt
, cÚ¡ 
mpi
 *
X
 )

134 
¡r
[512];

135 
i
, 
j
, 
k
, 
n
, 
maxËn
 = Ğ
¡r
 ) - 1;

137 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 || 
X
 == NULL )

140  
n
 = 
X
->n - 1;‚ >= 0;‚-- )

141 ifĞ
X
->
p
[
n
] != 0 )

144 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): value of '%s' (%lu bits) is:\n",

145 
fe
, 
lše
, 
‹xt
,

146 (è((
n
 + 1è* Ğ
t_št
 )) << 3 );

148 
¡r
[
maxËn
] = '\0';

149 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

151  
i
 = 
n
, 
j
 = 0; i >= 0; i--, j++ )

153 ifĞ
j
 % ( 16 / Ğ
t_št
 ) ) == 0 )

155 ifĞ
j
 > 0 )

156 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

158 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): ", 
fe
, 
lše
 );

160 
¡r
[
maxËn
] = '\0';

161 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

164  
k
 = Ğ
t_št
 ) - 1; k >= 0; k-- )

166 
	`¢´štf
Ğ
¡r
, 
maxËn
, " %02x", ()

167 Ğ
X
->
p
[
i
] >> (
k
 << 3) ) & 0xFF );

169 
¡r
[
maxËn
] = '\0';

170 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

174 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

175 
	}
}

177 
	$debug_´št_üt
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

178 cÚ¡ *
fe
, 
lše
,

179 cÚ¡ *
‹xt
, cÚ¡ 
x509_û¹
 *
üt
 )

181 
¡r
[1024], 
´efix
[64];

182 
i
 = 0, 
maxËn
 = Ğ
´efix
 ) - 1;

184 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 || 
üt
 == NULL )

187 
	`¢´štf
Ğ
´efix
, 
maxËn
, "%s(%04d): ", 
fe
, 
lše
 );

188 
´efix
[
maxËn
] = '\0';

189 
maxËn
 = Ğ
¡r
 ) - 1;

191  
üt
 !ğ
NULL
 )

193 
buf
[1024];

194 
	`x509·r£_û¹_šfo
Ğ
buf
, Ğbuàè- 1, 
´efix
, 
üt
 );

196 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %s #%d:\n%s",

197 
fe
, 
lše
, 
‹xt
, ++
i
, 
buf
 );

199 
¡r
[
maxËn
] = '\0';

200 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

202 
	`debug_´št_mpi
Ğ
s¦
, 
Ëv–
, 
fe
, 
lše
,

203 "üt->r§.N", &
üt
->
r§
.
N
 );

205 
	`debug_´št_mpi
Ğ
s¦
, 
Ëv–
, 
fe
, 
lše
,

206 "üt->r§.E", &
üt
->
r§
.
E
 );

208 
üt
 = c¹->
Ãxt
;

210 
	}
}

	@src/polarssl/debug.h

25 #iâdeà
SSL_DEBUG_H


26 
	#SSL_DEBUG_H


	)

28 
	~"pŞ¬s¦/cÚfig.h
"

29 
	~"pŞ¬s¦/s¦.h
"

31 #ià
defšed
(
POLARSSL_DEBUG_MSG
)

33 
	#SSL_DEBUG_MSG
Ğ
Ëv–
, 
¬gs
 ) \

34 
	`debug_´št_msg
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
debug_fmt
 
¬gs
 );

	)

36 
	#SSL_DEBUG_RET
Ğ
Ëv–
, 
‹xt
, 
»t
 ) \

37 
	`debug_´št_»t
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
»t
 );

	)

39 
	#SSL_DEBUG_BUF
Ğ
Ëv–
, 
‹xt
, 
buf
, 
Ën
 ) \

40 
	`debug_´št_buf
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
buf
, 
Ën
 );

	)

42 
	#SSL_DEBUG_MPI
Ğ
Ëv–
, 
‹xt
, 
X
 ) \

43 
	`debug_´št_mpi
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
X
 );

	)

45 
	#SSL_DEBUG_CRT
Ğ
Ëv–
, 
‹xt
, 
üt
 ) \

46 
	`debug_´št_üt
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
üt
 );

	)

50 
	#SSL_DEBUG_MSG
Ğ
Ëv–
, 
¬gs
 ) dØ{ }  0 )

	)

51 
	#SSL_DEBUG_RET
Ğ
Ëv–
, 
‹xt
, 
»t
 ) dØ{ }  0 )

	)

52 
	#SSL_DEBUG_BUF
Ğ
Ëv–
, 
‹xt
, 
buf
, 
Ën
 ) dØ{ }  0 )

	)

53 
	#SSL_DEBUG_MPI
Ğ
Ëv–
, 
‹xt
, 
X
 ) dØ{ }  0 )

	)

54 
	#SSL_DEBUG_CRT
Ğ
Ëv–
, 
‹xt
, 
üt
 ) dØ{ }  0 )

	)

58 #ifdeà
__ılu¥lus


62 *
debug_fmt
ĞcÚ¡ *
fÜm©
, ... );

64 
debug_´št_msg
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

65 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
 );

67 
debug_´št_»t
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

68 cÚ¡ *
fe
, 
lše
,

69 cÚ¡ *
‹xt
, 
»t
 );

71 
debug_´št_buf
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

72 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
,

73 *
buf
, 
Ën
 );

75 
debug_´št_mpi
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

76 cÚ¡ *
fe
, 
lše
,

77 cÚ¡ *
‹xt
, cÚ¡ 
mpi
 *
X
 );

79 
debug_´št_üt
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

80 cÚ¡ *
fe
, 
lše
,

81 cÚ¡ *
‹xt
, cÚ¡ 
x509_û¹
 *
üt
 );

83 #ifdeà
__ılu¥lus


	@src/polarssl/des.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_DES_C
)

36 
	~"pŞ¬s¦/des.h
"

38 
	~<¡ršg.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

66 cÚ¡ 
	gSB1
[64] =

86 cÚ¡ 
	gSB2
[64] =

106 cÚ¡ 
	gSB3
[64] =

126 cÚ¡ 
	gSB4
[64] =

146 cÚ¡ 
	gSB5
[64] =

166 cÚ¡ 
	gSB6
[64] =

186 cÚ¡ 
	gSB7
[64] =

206 cÚ¡ 
	gSB8
[64] =

229 cÚ¡ 
	gLHs
[16] =

237 cÚ¡ 
	gRHs
[16] =

248 
	#DES_IP
(
X
,
Y
) \

250 
T
 = ((
X
 >> 4è^ 
Y
) & 0x0F0F0F0F; Y ^= T; X ^= (T << 4); \

251 
T
 = ((
X
 >> 16è^ 
Y
) & 0x0000FFFF; Y ^= T; X ^= (T << 16); \

252 
T
 = ((
Y
 >> 2è^ 
X
) & 0x33333333; X ^= T; Y ^= (T << 2); \

253 
T
 = ((
Y
 >> 8è^ 
X
) & 0x00FF00FF; X ^= T; Y ^= (T << 8); \

254 
Y
 = ((Y << 1) | (Y >> 31)) & 0xFFFFFFFF; \

255 
T
 = (
X
 ^ 
Y
) & 0xAAAAAAAA; Y ^= T; X ^= T; \

256 
X
 = ((X << 1) | (X >> 31)) & 0xFFFFFFFF; \

257 }

	)

262 
	#DES_FP
(
X
,
Y
) \

264 
X
 = ((X << 31) | (X >> 1)) & 0xFFFFFFFF; \

265 
T
 = (
X
 ^ 
Y
) & 0xAAAAAAAA; X ^= T; Y ^= T; \

266 
Y
 = ((Y << 31) | (Y >> 1)) & 0xFFFFFFFF; \

267 
T
 = ((
Y
 >> 8è^ 
X
) & 0x00FF00FF; X ^= T; Y ^= (T << 8); \

268 
T
 = ((
Y
 >> 2è^ 
X
) & 0x33333333; X ^= T; Y ^= (T << 2); \

269 
T
 = ((
X
 >> 16è^ 
Y
) & 0x0000FFFF; Y ^= T; X ^= (T << 16); \

270 
T
 = ((
X
 >> 4è^ 
Y
) & 0x0F0F0F0F; Y ^= T; X ^= (T << 4); \

271 }

	)

276 
	#DES_ROUND
(
X
,
Y
) \

278 
T
 = *
SK
++ ^ 
X
; \

279 
Y
 ^ğ
SB8
[ (
T
 ) & 0x3F ] ^ \

280 
SB6
[ (
T
 >> 8) & 0x3F ] ^ \

281 
SB4
[ (
T
 >> 16) & 0x3F ] ^ \

282 
SB2
[ (
T
 >> 24) & 0x3F ]; \

284 
T
 = *
SK
++ ^ ((
X
 << 28) | (X >> 4)); \

285 
Y
 ^ğ
SB7
[ (
T
 ) & 0x3F ] ^ \

286 
SB5
[ (
T
 >> 8) & 0x3F ] ^ \

287 
SB3
[ (
T
 >> 16) & 0x3F ] ^ \

288 
SB1
[ (
T
 >> 24) & 0x3F ]; \

289 }

	)

291 
	#SWAP
(
a
,
b
è{ 
t
 =‡;‡ = b; b =; = 0; }

	)

293 
	$des_£tkey
Ğ
SK
[32], cÚ¡ 
key
[8] )

295 
i
;

296 
X
, 
Y
, 
T
;

298 
	`GET_ULONG_BE
Ğ
X
, 
key
, 0 );

299 
	`GET_ULONG_BE
Ğ
Y
, 
key
, 4 );

304 
T
 = ((
Y
 >> 4è^ 
X
) & 0x0F0F0F0F; X ^= T; Y ^= (T << 4);

305 
T
 = ((
Y
 ) ^ 
X
) & 0x10101010; X ^= T; Y ^= (T );

307 
X
 = (
LHs
[ (X ) & 0xF] << 3) | (LHs[ (X >> 8) & 0xF ] << 2)

308 | (
LHs
[ (
X
 >> 16) & 0xF] << 1) | (LHs[ (X >> 24) & 0xF ] )

309 | (
LHs
[ (
X
 >> 5) & 0xF] << 7) | (LHs[ (X >> 13) & 0xF ] << 6)

310 | (
LHs
[ (
X
 >> 21) & 0xF] << 5) | (LHs[ (X >> 29) & 0xF ] << 4);

312 
Y
 = (
RHs
[ (Y >> 1) & 0xF] << 3) | (RHs[ (Y >> 9) & 0xF ] << 2)

313 | (
RHs
[ (
Y
 >> 17) & 0xF] << 1) | (RHs[ (Y >> 25) & 0xF ] )

314 | (
RHs
[ (
Y
 >> 4) & 0xF] << 7) | (RHs[ (Y >> 12) & 0xF ] << 6)

315 | (
RHs
[ (
Y
 >> 20) & 0xF] << 5) | (RHs[ (Y >> 28) & 0xF ] << 4);

317 
X
 &= 0x0FFFFFFF;

318 
Y
 &= 0x0FFFFFFF;

323  
i
 = 0; i < 16; i++ )

325 ifĞ
i
 < 2 || i == 8 || i == 15 )

327 
X
 = ((X << 1) | (X >> 27)) & 0x0FFFFFFF;

328 
Y
 = ((Y << 1) | (Y >> 27)) & 0x0FFFFFFF;

332 
X
 = ((X << 2) | (X >> 26)) & 0x0FFFFFFF;

333 
Y
 = ((Y << 2) | (Y >> 26)) & 0x0FFFFFFF;

336 *
SK
++ = ((
X
 << 4) & 0x24000000) | ((X << 28) & 0x10000000)

337 | ((
X
 << 14) & 0x08000000) | ((X << 18) & 0x02080000)

338 | ((
X
 << 6) & 0x01000000) | ((X << 9) & 0x00200000)

339 | ((
X
 >> 1) & 0x00100000) | ((X << 10) & 0x00040000)

340 | ((
X
 << 2) & 0x00020000) | ((X >> 10) & 0x00010000)

341 | ((
Y
 >> 13) & 0x00002000) | ((Y >> 4) & 0x00001000)

342 | ((
Y
 << 6) & 0x00000800) | ((Y >> 1) & 0x00000400)

343 | ((
Y
 >> 14) & 0x00000200) | ((Y ) & 0x00000100)

344 | ((
Y
 >> 5) & 0x00000020) | ((Y >> 10) & 0x00000010)

345 | ((
Y
 >> 3) & 0x00000008) | ((Y >> 18) & 0x00000004)

346 | ((
Y
 >> 26) & 0x00000002) | ((Y >> 24) & 0x00000001);

348 *
SK
++ = ((
X
 << 15) & 0x20000000) | ((X << 17) & 0x10000000)

349 | ((
X
 << 10) & 0x08000000) | ((X << 22) & 0x04000000)

350 | ((
X
 >> 2) & 0x02000000) | ((X << 1) & 0x01000000)

351 | ((
X
 << 16) & 0x00200000) | ((X << 11) & 0x00100000)

352 | ((
X
 << 3) & 0x00080000) | ((X >> 6) & 0x00040000)

353 | ((
X
 << 15) & 0x00020000) | ((X >> 4) & 0x00010000)

354 | ((
Y
 >> 2) & 0x00002000) | ((Y << 8) & 0x00001000)

355 | ((
Y
 >> 14) & 0x00000808) | ((Y >> 9) & 0x00000400)

356 | ((
Y
 ) & 0x00000200) | ((Y << 7) & 0x00000100)

357 | ((
Y
 >> 7) & 0x00000020) | ((Y >> 3) & 0x00000011)

358 | ((
Y
 << 2) & 0x00000004) | ((Y >> 21) & 0x00000002);

360 
	}
}

365 
	$des_£tkey_’c
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] )

367 
	`des_£tkey
Ğ
ùx
->
sk
, 
key
 );

368 
	}
}

373 
	$des_£tkey_dec
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] )

375 
i
;

377 
	`des_£tkey
Ğ
ùx
->
sk
, 
key
 );

379  
i
 = 0; i < 16; i += 2 )

381 
	`SWAP
Ğ
ùx
->
sk
[
i
 ], ctx->sk[30 - i] );

382 
	`SWAP
Ğ
ùx
->
sk
[
i
 + 1], ctx->sk[31 - i] );

384 
	}
}

386 
	$des3_£t2key
Ğ
esk
[96],

387 
dsk
[96],

388 cÚ¡ 
key
[16] )

390 
i
;

392 
	`des_£tkey
Ğ
esk
, 
key
 );

393 
	`des_£tkey
Ğ
dsk
 + 32, 
key
 + 8 );

395  
i
 = 0; i < 32; i += 2 )

397 
dsk
[
i
 ] = 
esk
[30 - i];

398 
dsk
[
i
 + 1] = 
esk
[31 - i];

400 
esk
[
i
 + 32] = 
dsk
[62 - i];

401 
esk
[
i
 + 33] = 
dsk
[63 - i];

403 
esk
[
i
 + 64] =ƒsk[i ];

404 
esk
[
i
 + 65] =ƒsk[i + 1];

406 
dsk
[
i
 + 64] = dsk[i ];

407 
dsk
[
i
 + 65] = dsk[i + 1];

409 
	}
}

414 
	$des3_£t2key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] )

416 
sk
[96];

418 
	`des3_£t2key
Ğ
ùx
->
sk
, sk, 
key
 );

419 
	`mem£t
Ğ
sk
, 0, ( sk ) );

420 
	}
}

425 
	$des3_£t2key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] )

427 
sk
[96];

429 
	`des3_£t2key
Ğ
sk
, 
ùx
->sk, 
key
 );

430 
	`mem£t
Ğ
sk
, 0, ( sk ) );

431 
	}
}

433 
	$des3_£t3key
Ğ
esk
[96],

434 
dsk
[96],

435 cÚ¡ 
key
[24] )

437 
i
;

439 
	`des_£tkey
Ğ
esk
, 
key
 );

440 
	`des_£tkey
Ğ
dsk
 + 32, 
key
 + 8 );

441 
	`des_£tkey
Ğ
esk
 + 64, 
key
 + 16 );

443  
i
 = 0; i < 32; i += 2 )

445 
dsk
[
i
 ] = 
esk
[94 - i];

446 
dsk
[
i
 + 1] = 
esk
[95 - i];

448 
esk
[
i
 + 32] = 
dsk
[62 - i];

449 
esk
[
i
 + 33] = 
dsk
[63 - i];

451 
dsk
[
i
 + 64] = 
esk
[30 - i];

452 
dsk
[
i
 + 65] = 
esk
[31 - i];

454 
	}
}

459 
	$des3_£t3key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] )

461 
sk
[96];

463 
	`des3_£t3key
Ğ
ùx
->
sk
, sk, 
key
 );

464 
	`mem£t
Ğ
sk
, 0, ( sk ) );

465 
	}
}

470 
	$des3_£t3key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] )

472 
sk
[96];

474 
	`des3_£t3key
Ğ
sk
, 
ùx
->sk, 
key
 );

475 
	`mem£t
Ğ
sk
, 0, ( sk ) );

476 
	}
}

481 
	$des_üy±_ecb
Ğ
des_cÚ‹xt
 *
ùx
,

482 cÚ¡ 
šput
[8],

483 
ouut
[8] )

485 
i
;

486 
X
, 
Y
, 
T
, *
SK
;

488 
SK
 = 
ùx
->
sk
;

490 
	`GET_ULONG_BE
Ğ
X
, 
šput
, 0 );

491 
	`GET_ULONG_BE
Ğ
Y
, 
šput
, 4 );

493 
	`DES_IP
Ğ
X
, 
Y
 );

495  
i
 = 0; i < 8; i++ )

497 
	`DES_ROUND
Ğ
Y
, 
X
 );

498 
	`DES_ROUND
Ğ
X
, 
Y
 );

501 
	`DES_FP
Ğ
Y
, 
X
 );

503 
	`PUT_ULONG_BE
Ğ
Y
, 
ouut
, 0 );

504 
	`PUT_ULONG_BE
Ğ
X
, 
ouut
, 4 );

507 
	}
}

512 
	$des_üy±_cbc
Ğ
des_cÚ‹xt
 *
ùx
,

513 
mode
,

514 
Ëngth
,

515 
iv
[8],

516 cÚ¡ *
šput
,

517 *
ouut
 )

519 
i
;

520 
‹mp
[8];

522 ifĞ
Ëngth
 % 8 )

523 Ğ
POLARSSL_ERR_DES_INVALID_INPUT_LENGTH
 );

525 ifĞ
mode
 =ğ
DES_ENCRYPT
 )

527  
Ëngth
 > 0 )

529  
i
 = 0; i < 8; i++ )

530 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

532 
	`des_üy±_ecb
Ğ
ùx
, 
ouut
, output );

533 
	`memıy
Ğ
iv
, 
ouut
, 8 );

535 
šput
 += 8;

536 
ouut
 += 8;

537 
Ëngth
 -= 8;

542  
Ëngth
 > 0 )

544 
	`memıy
Ğ
‹mp
, 
šput
, 8 );

545 
	`des_üy±_ecb
Ğ
ùx
, 
šput
, 
ouut
 );

547  
i
 = 0; i < 8; i++ )

548 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

550 
	`memıy
Ğ
iv
, 
‹mp
, 8 );

552 
šput
 += 8;

553 
ouut
 += 8;

554 
Ëngth
 -= 8;

559 
	}
}

564 
	$des3_üy±_ecb
Ğ
des3_cÚ‹xt
 *
ùx
,

565 cÚ¡ 
šput
[8],

566 
ouut
[8] )

568 
i
;

569 
X
, 
Y
, 
T
, *
SK
;

571 
SK
 = 
ùx
->
sk
;

573 
	`GET_ULONG_BE
Ğ
X
, 
šput
, 0 );

574 
	`GET_ULONG_BE
Ğ
Y
, 
šput
, 4 );

576 
	`DES_IP
Ğ
X
, 
Y
 );

578  
i
 = 0; i < 8; i++ )

580 
	`DES_ROUND
Ğ
Y
, 
X
 );

581 
	`DES_ROUND
Ğ
X
, 
Y
 );

584  
i
 = 0; i < 8; i++ )

586 
	`DES_ROUND
Ğ
X
, 
Y
 );

587 
	`DES_ROUND
Ğ
Y
, 
X
 );

590  
i
 = 0; i < 8; i++ )

592 
	`DES_ROUND
Ğ
Y
, 
X
 );

593 
	`DES_ROUND
Ğ
X
, 
Y
 );

596 
	`DES_FP
Ğ
Y
, 
X
 );

598 
	`PUT_ULONG_BE
Ğ
Y
, 
ouut
, 0 );

599 
	`PUT_ULONG_BE
Ğ
X
, 
ouut
, 4 );

602 
	}
}

607 
	$des3_üy±_cbc
Ğ
des3_cÚ‹xt
 *
ùx
,

608 
mode
,

609 
Ëngth
,

610 
iv
[8],

611 cÚ¡ *
šput
,

612 *
ouut
 )

614 
i
;

615 
‹mp
[8];

617 ifĞ
Ëngth
 % 8 )

618 Ğ
POLARSSL_ERR_DES_INVALID_INPUT_LENGTH
 );

620 ifĞ
mode
 =ğ
DES_ENCRYPT
 )

622  
Ëngth
 > 0 )

624  
i
 = 0; i < 8; i++ )

625 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

627 
	`des3_üy±_ecb
Ğ
ùx
, 
ouut
, output );

628 
	`memıy
Ğ
iv
, 
ouut
, 8 );

630 
šput
 += 8;

631 
ouut
 += 8;

632 
Ëngth
 -= 8;

637  
Ëngth
 > 0 )

639 
	`memıy
Ğ
‹mp
, 
šput
, 8 );

640 
	`des3_üy±_ecb
Ğ
ùx
, 
šput
, 
ouut
 );

642  
i
 = 0; i < 8; i++ )

643 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

645 
	`memıy
Ğ
iv
, 
‹mp
, 8 );

647 
šput
 += 8;

648 
ouut
 += 8;

649 
Ëngth
 -= 8;

654 
	}
}

656 #ià
defšed
(
POLARSSL_SELF_TEST
)

658 
	~<¡dio.h
>

665 cÚ¡ 
	gdes3_‹¡_keys
[24] =

672 cÚ¡ 
	gdes3_‹¡_iv
[8] =

677 cÚ¡ 
	gdes3_‹¡_buf
[8] =

682 cÚ¡ 
	gdes3_‹¡_ecb_dec
[3][8] =

689 cÚ¡ 
	gdes3_‹¡_ecb_’c
[3][8] =

696 cÚ¡ 
	gdes3_‹¡_cbc_dec
[3][8] =

703 cÚ¡ 
	gdes3_‹¡_cbc_’c
[3][8] =

713 
	$des_£lf_‹¡
Ğ
v”bo£
 )

715 
i
, 
j
, 
u
, 
v
;

716 
des_cÚ‹xt
 
ùx
;

717 
des3_cÚ‹xt
 
ùx3
;

718 
key
[24];

719 
buf
[8];

720 
´v
[8];

721 
iv
[8];

723 
	`mem£t
Ğ
key
, 0, 24 );

728  
i
 = 0; i < 6; i++ )

730 
u
 = 
i
 >> 1;

731 
v
 = 
i
 & 1;

733 ifĞ
v”bo£
 != 0 )

734 
	`´štf
( " DES%c-ECB-%3d (%s): ",

735 Ğ
u
 == 0 ) ? ' ' : '3', 56 + u * 56,

736 Ğ
v
 =ğ
DES_DECRYPT
 ) ? "dec" : "enc" );

738 
	`memıy
Ğ
buf
, 
des3_‹¡_buf
, 8 );

740  
i
 )

743 
	`des_£tkey_dec
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

747 
	`des_£tkey_’c
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

751 
	`des3_£t2key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

755 
	`des3_£t2key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

759 
	`des3_£t3key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

763 
	`des3_£t3key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

770  
j
 = 0; j < 10000; j++ )

772 ifĞ
u
 == 0 )

773 
	`des_üy±_ecb
Ğ&
ùx
, 
buf
, buf );

775 
	`des3_üy±_ecb
Ğ&
ùx3
, 
buf
, buf );

778 ifĞĞ
v
 =ğ
DES_DECRYPT
 &&

779 
	`memcmp
Ğ
buf
, 
des3_‹¡_ecb_dec
[
u
], 8 ) != 0 ) ||

780 Ğ
v
 !ğ
DES_DECRYPT
 &&

781 
	`memcmp
Ğ
buf
, 
des3_‹¡_ecb_’c
[
u
], 8 ) != 0 ) )

783 ifĞ
v”bo£
 != 0 )

784 
	`´štf
( "failed\n" );

789 ifĞ
v”bo£
 != 0 )

790 
	`´štf
( "passed\n" );

793 ifĞ
v”bo£
 != 0 )

794 
	`´štf
( "\n" );

799  
i
 = 0; i < 6; i++ )

801 
u
 = 
i
 >> 1;

802 
v
 = 
i
 & 1;

804 ifĞ
v”bo£
 != 0 )

805 
	`´štf
( " DES%c-CBC-%3d (%s): ",

806 Ğ
u
 == 0 ) ? ' ' : '3', 56 + u * 56,

807 Ğ
v
 =ğ
DES_DECRYPT
 ) ? "dec" : "enc" );

809 
	`memıy
Ğ
iv
, 
des3_‹¡_iv
, 8 );

810 
	`memıy
Ğ
´v
, 
des3_‹¡_iv
, 8 );

811 
	`memıy
Ğ
buf
, 
des3_‹¡_buf
, 8 );

813  
i
 )

816 
	`des_£tkey_dec
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

820 
	`des_£tkey_’c
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

824 
	`des3_£t2key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

828 
	`des3_£t2key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

832 
	`des3_£t3key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

836 
	`des3_£t3key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

843 ifĞ
v
 =ğ
DES_DECRYPT
 )

845  
j
 = 0; j < 10000; j++ )

847 ifĞ
u
 == 0 )

848 
	`des_üy±_cbc
Ğ&
ùx
, 
v
, 8, 
iv
, 
buf
, buf );

850 
	`des3_üy±_cbc
Ğ&
ùx3
, 
v
, 8, 
iv
, 
buf
, buf );

855  
j
 = 0; j < 10000; j++ )

857 
tmp
[8];

859 ifĞ
u
 == 0 )

860 
	`des_üy±_cbc
Ğ&
ùx
, 
v
, 8, 
iv
, 
buf
, buf );

862 
	`des3_üy±_cbc
Ğ&
ùx3
, 
v
, 8, 
iv
, 
buf
, buf );

864 
	`memıy
Ğ
tmp
, 
´v
, 8 );

865 
	`memıy
Ğ
´v
, 
buf
, 8 );

866 
	`memıy
Ğ
buf
, 
tmp
, 8 );

869 
	`memıy
Ğ
buf
, 
´v
, 8 );

872 ifĞĞ
v
 =ğ
DES_DECRYPT
 &&

873 
	`memcmp
Ğ
buf
, 
des3_‹¡_cbc_dec
[
u
], 8 ) != 0 ) ||

874 Ğ
v
 !ğ
DES_DECRYPT
 &&

875 
	`memcmp
Ğ
buf
, 
des3_‹¡_cbc_’c
[
u
], 8 ) != 0 ) )

877 ifĞ
v”bo£
 != 0 )

878 
	`´štf
( "failed\n" );

883 ifĞ
v”bo£
 != 0 )

884 
	`´štf
( "passed\n" );

887 ifĞ
v”bo£
 != 0 )

888 
	`´štf
( "\n" );

891 
	}
}

	@src/polarssl/des.h

25 #iâdeà
POLARSSL_DES_H


26 
	#POLARSSL_DES_H


	)

28 
	#DES_ENCRYPT
 1

	)

29 
	#DES_DECRYPT
 0

	)

31 
	#POLARSSL_ERR_DES_INVALID_INPUT_LENGTH
 -0x0C00

	)

38 
	mmode
;

39 
	msk
[32];

41 
	tdes_cÚ‹xt
;

48 
	mmode
;

49 
	msk
[96];

51 
	tdes3_cÚ‹xt
;

53 #ifdeà
__ılu¥lus


63 
des_£tkey_’c
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] );

71 
des_£tkey_dec
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] );

79 
des3_£t2key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] );

87 
des3_£t2key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] );

95 
des3_£t3key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] );

103 
des3_£t3key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] );

114 
des_üy±_ecb
Ğ
des_cÚ‹xt
 *
ùx
,

115 cÚ¡ 
šput
[8],

116 
ouut
[8] );

128 
des_üy±_cbc
Ğ
des_cÚ‹xt
 *
ùx
,

129 
mode
,

130 
Ëngth
,

131 
iv
[8],

132 cÚ¡ *
šput
,

133 *
ouut
 );

144 
des3_üy±_ecb
Ğ
des3_cÚ‹xt
 *
ùx
,

145 cÚ¡ 
šput
[8],

146 
ouut
[8] );

160 
des3_üy±_cbc
Ğ
des3_cÚ‹xt
 *
ùx
,

161 
mode
,

162 
Ëngth
,

163 
iv
[8],

164 cÚ¡ *
šput
,

165 *
ouut
 );

172 
des_£lf_‹¡
Ğ
v”bo£
 );

174 #ifdeà
__ılu¥lus


	@src/polarssl/dhm.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_DHM_C
)

35 
	~"pŞ¬s¦/dhm.h
"

37 
	~<¡ršg.h
>

42 
	$dhm_»ad_bignum
Ğ
mpi
 *
X
,

43 **
p
,

44 cÚ¡ *
’d
 )

46 
»t
, 
n
;

48 ifĞ
’d
 - *
p
 < 2 )

49 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

51 
n
 = ( (*
p
)[0] << 8 ) | (*p)[1];

52 (*
p
) += 2;

54 ifĞ()Ğ
’d
 - *
p
 ) < 
n
 )

55 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

57 ifĞĞ
»t
 = 
	`mpi_»ad_bš¬y
Ğ
X
, *
p
, 
n
 ) ) != 0 )

58 Ğ
POLARSSL_ERR_DHM_READ_PARAMS_FAILED
 | 
»t
 );

60 (*
p
è+ğ
n
;

63 
	}
}

74 
	$dhm_check_¿nge
ĞcÚ¡ 
mpi
 *
public_·¿m
, cÚ¡ mp˜*
P
 )

76 
mpi
 
L
, 
U
;

77 
»t
 = 
POLARSSL_ERR_DHM_BAD_INPUT_DATA
;

79 
	`mpi_š™
Ğ&
L
, &
U
, 
NULL
 );

80 
	`mpi_l£t
Ğ&
L
, 2 );

81 
	`mpi_sub_št
Ğ&
U
, 
P
, 2 );

83 ifĞ
	`mpi_cmp_mpi
Ğ
public_·¿m
, &
L
 ) >= 0 &&

84 
	`mpi_cmp_mpi
Ğ
public_·¿m
, &
U
 ) <= 0 )

86 
»t
 = 0;

89 
	`mpi_ä“
Ğ&
L
, &
U
, 
NULL
 );

91 Ğ
»t
 );

92 
	}
}

97 
	$dhm_»ad_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
,

98 **
p
,

99 cÚ¡ *
’d
 )

101 
»t
, 
n
;

103 
	`mem£t
Ğ
ùx
, 0, Ğ
dhm_cÚ‹xt
 ) );

105 ifĞĞ
»t
 = 
	`dhm_»ad_bignum
Ğ&
ùx
->
P
, 
p
, 
’d
 ) ) != 0 ||

106 Ğ
»t
 = 
	`dhm_»ad_bignum
Ğ&
ùx
->
G
, 
p
, 
’d
 ) ) != 0 ||

107 Ğ
»t
 = 
	`dhm_»ad_bignum
Ğ&
ùx
->
GY
, 
p
, 
’d
 ) ) != 0 )

108 Ğ
»t
 );

110 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GY
, &ùx->
P
 ) ) != 0 )

111 Ğ
»t
 );

113 
ùx
->
Ën
 = 
	`mpi_size
Ğ&ùx->
P
 );

115 ifĞ
’d
 - *
p
 < 2 )

116 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

118 
n
 = ( (*
p
)[0] << 8 ) | (*p)[1];

119 (*
p
) += 2;

121 ifĞ
’d
 !ğ*
p
 + 
n
 )

122 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

125 
	}
}

130 
dhm_make_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
, 
x_size
,

131 *
ouut
, *
Ş’
,

132 (*
f_ºg
)(*), *
p_ºg
 )

134 
i
, 
»t
, 
n
, 
n1
, 
n2
, 
n3
;

135 *
p
;

140 
n
 = 
x_size
 / Ğ
t_št
 ) + 1;

141 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
ùx
->
X
, 
n
 ) );

142 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
ùx
->
X
, 0 ) );

144 
p
 = (*è
ùx
->
X
.p;

145  
i
 = 0; i < 
x_size
; i++ )

146 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

148  
	`mpi_cmp_mpi
Ğ&
ùx
->
X
, &ùx->
P
 ) >= 0 )

149 
	`mpi_shiá_r
Ğ&
ùx
->
X
, 1 );

154 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
ùx
->
GX
, &ùx->
G
, &ùx->
X
,

155 &
ùx
->
P
 , &ùx->
RP
 ) );

157 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GX
, &ùx->
P
 ) ) != 0 )

158 Ğ
»t
 );

163 
	#DHM_MPI_EXPORT
(
X
,
n
) \

164 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ
X
, 
p
 + 2, 
n
 ) ); \

165 *
p
++ = ()Ğ
n
 >> 8 ); \

166 *
p
++ = ()Ğ
n
 );… +ğn;

	)

168 
n1
 = 
	`mpi_size
Ğ&
ùx
->
P
 );

169 
n2
 = 
	`mpi_size
Ğ&
ùx
->
G
 );

170 
n3
 = 
	`mpi_size
Ğ&
ùx
->
GX
 );

172 
p
 = 
ouut
;

173 
	`DHM_MPI_EXPORT
Ğ&
ùx
->
P
 , 
n1
 );

174 
	`DHM_MPI_EXPORT
Ğ&
ùx
->
G
 , 
n2
 );

175 
	`DHM_MPI_EXPORT
Ğ&
ùx
->
GX
, 
n3
 );

177 *
Ş’
 = 
p
 - 
ouut
;

179 
ùx
->
Ën
 = 
n1
;

181 
ş—nup
:

183 ifĞ
»t
 != 0 )

184 Ğ
»t
 | 
POLARSSL_ERR_DHM_MAKE_PARAMS_FAILED
 );

187 
	}
}

192 
	$dhm_»ad_public
Ğ
dhm_cÚ‹xt
 *
ùx
,

193 cÚ¡ *
šput
, 
’
 )

195 
»t
;

197 ifĞ
ùx
 =ğ
NULL
 || 
’
 < 1 || iËÀ> ctx->
Ën
 )

198 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

200 ifĞĞ
»t
 = 
	`mpi_»ad_bš¬y
Ğ&
ùx
->
GY
, 
šput
, 
’
 ) ) != 0 )

201 Ğ
POLARSSL_ERR_DHM_READ_PUBLIC_FAILED
 | 
»t
 );

204 
	}
}

209 
dhm_make_public
Ğ
dhm_cÚ‹xt
 *
ùx
, 
x_size
,

210 *
ouut
, 
Ş’
,

211 (*
f_ºg
)(*), *
p_ºg
 )

213 
»t
, 
i
, 
n
;

214 *
p
;

216 ifĞ
ùx
 =ğ
NULL
 || 
Ş’
 < 1 || oËÀ> ctx->
Ën
 )

217 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

222 
n
 = 
x_size
 / Ğ
t_št
 ) + 1;

223 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
ùx
->
X
, 
n
 ) );

224 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
ùx
->
X
, 0 ) );

226 
p
 = (*è
ùx
->
X
.p;

227  
i
 = 0; i < 
x_size
; i++ )

228 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

230  
	`mpi_cmp_mpi
Ğ&
ùx
->
X
, &ùx->
P
 ) >= 0 )

231 
	`mpi_shiá_r
Ğ&
ùx
->
X
, 1 );

233 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
ùx
->
GX
, &ùx->
G
, &ùx->
X
,

234 &
ùx
->
P
 , &ùx->
RP
 ) );

236 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GX
, &ùx->
P
 ) ) != 0 )

237 Ğ
»t
 );

239 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
ùx
->
GX
, 
ouut
, 
Ş’
 ) );

241 
ş—nup
:

243 ifĞ
»t
 != 0 )

244 Ğ
POLARSSL_ERR_DHM_MAKE_PUBLIC_FAILED
 | 
»t
 );

247 
	}
}

252 
	$dhm_ÿlc_£ü‘
Ğ
dhm_cÚ‹xt
 *
ùx
,

253 *
ouut
, *
Ş’
 )

255 
»t
;

257 ifĞ
ùx
 =ğ
NULL
 || *
Ş’
 < ctx->
Ën
 )

258 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

260 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
ùx
->
K
, &ùx->
GY
, &ùx->
X
,

261 &
ùx
->
P
, &ùx->
RP
 ) );

263 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GY
, &ùx->
P
 ) ) != 0 )

264 Ğ
»t
 );

266 *
Ş’
 = 
	`mpi_size
Ğ&
ùx
->
K
 );

268 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
ùx
->
K
, 
ouut
, *
Ş’
 ) );

270 
ş—nup
:

272 ifĞ
»t
 != 0 )

273 Ğ
POLARSSL_ERR_DHM_CALC_SECRET_FAILED
 | 
»t
 );

276 
	}
}

281 
	$dhm_ä“
Ğ
dhm_cÚ‹xt
 *
ùx
 )

283 
	`mpi_ä“
Ğ&
ùx
->
RP
, &ùx->
K
, &ùx->
GY
,

284 &
ùx
->
GX
, &ùx->
X
, &ùx->
G
,

285 &
ùx
->
P
, 
NULL
 );

286 
	}
}

288 #ià
defšed
(
POLARSSL_SELF_TEST
)

293 
	$dhm_£lf_‹¡
Ğ
v”bo£
 )

295 Ğ
v”bo£
++ );

296 
	}
}

	@src/polarssl/dhm.h

25 #iâdeà
POLARSSL_DHM_H


26 
	#POLARSSL_DHM_H


	)

28 
	~"pŞ¬s¦/bignum.h
"

30 
	#POLARSSL_ERR_DHM_BAD_INPUT_DATA
 0x0480

	)

31 
	#POLARSSL_ERR_DHM_READ_PARAMS_FAILED
 0x0490

	)

32 
	#POLARSSL_ERR_DHM_MAKE_PARAMS_FAILED
 0x04A0

	)

33 
	#POLARSSL_ERR_DHM_READ_PUBLIC_FAILED
 0x04B0

	)

34 
	#POLARSSL_ERR_DHM_MAKE_PUBLIC_FAILED
 0x04C0

	)

35 
	#POLARSSL_ERR_DHM_CALC_SECRET_FAILED
 0x04D0

	)

39 
	mËn
;

40 
mpi
 
	mP
;

41 
mpi
 
	mG
;

42 
mpi
 
	mX
;

43 
mpi
 
	mGX
;

44 
mpi
 
	mGY
;

45 
mpi
 
	mK
;

46 
mpi
 
	mRP
;

48 
	tdhm_cÚ‹xt
;

50 #ifdeà
__ılu¥lus


63 
dhm_»ad_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
,

64 **
p
,

65 cÚ¡ *
’d
 );

83 
dhm_make_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
, 
x_size
,

84 *
ouut
, *
Ş’
,

85 (*
f_ºg
)(*), *
p_ºg
 );

96 
dhm_»ad_public
Ğ
dhm_cÚ‹xt
 *
ùx
,

97 cÚ¡ *
šput
, 
’
 );

111 
dhm_make_public
Ğ
dhm_cÚ‹xt
 *
ùx
, 
s_size
,

112 *
ouut
, 
Ş’
,

113 (*
f_ºg
)(*), *
p_ºg
 );

124 
dhm_ÿlc_£ü‘
Ğ
dhm_cÚ‹xt
 *
ùx
,

125 *
ouut
, *
Ş’
 );

130 
dhm_ä“
Ğ
dhm_cÚ‹xt
 *
ùx
 );

137 
dhm_£lf_‹¡
Ğ
v”bo£
 );

139 #ifdeà
__ılu¥lus


	@src/polarssl/havege.c

33 
	~<¡ršg.h
>

34 
	~<time.h
>

36 
	~"pŞ¬s¦/cÚfig.h
"

38 #ià
defšed
(
POLARSSL_HAVEGE_C
)

40 
	~"pŞ¬s¦/havege.h
"

41 
	~"pŞ¬s¦/timšg.h
"

57 
	#SWAP
(
X
,
Y
è{ *
T
 = X; X = Y; Y = T; }

	)

59 
	#TST1_ENTER
 ifĞ
PTEST
 & 1 ) { PTEST ^ğ3; PTEST >>ğ1;

	)

60 
	#TST2_ENTER
 ifĞ
PTEST
 & 1 ) { PTEST ^ğ3; PTEST >>ğ1;

	)

62 
	#TST1_LEAVE
 
U1
++; }

	)

63 
	#TST2_LEAVE
 
U2
++; }

	)

65 
	#ONE_ITERATION
 \

67 
PTEST
 = 
PT1
 >> 20; \

69 
TST1_ENTER
 TST1_ENTER TST1_ENTER TST1_ENTER \

70 
TST1_ENTER
 TST1_ENTER TST1_ENTER TST1_ENTER \

71 
TST1_ENTER
 TST1_ENTER TST1_ENTER TST1_ENTER \

73 
TST1_LEAVE
 TST1_LEAVE TST1_LEAVE TST1_LEAVE \

74 
TST1_LEAVE
 TST1_LEAVE TST1_LEAVE TST1_LEAVE \

75 
TST1_LEAVE
 TST1_LEAVE TST1_LEAVE TST1_LEAVE \

77 
PTX
 = (
PT1
 >> 18) & 7; \

78 
PT1
 &= 0x1FFF; \

79 
PT2
 &= 0x1FFF; \

80 
CLK
 = (è
	`h¬dşock
(); \

82 
i
 = 0; \

83 
A
 = &
WALK
[
PT1
 ]; 
RES
[
i
++] ^= *A; \

84 
B
 = &
WALK
[
PT2
 ]; 
RES
[
i
++] ^= *B; \

85 
C
 = &
WALK
[
PT1
 ^ 1]; 
RES
[
i
++] ^= *C; \

86 
D
 = &
WALK
[
PT2
 ^ 4]; 
RES
[
i
++] ^= *D; \

88 
IN
 = (*
A
 >> (1)è^ (*A << (31)è^ 
CLK
; \

89 *
A
 = (*
B
 >> (2)è^ (*B << (30)è^ 
CLK
; \

90 *
B
 = 
IN
 ^ 
U1
; \

91 *
C
 = (*C >> (3)è^ (*C << (29)è^ 
CLK
; \

92 *
D
 = (*D >> (4)è^ (*D << (28)è^ 
CLK
; \

94 
A
 = &
WALK
[
PT1
 ^ 2]; 
RES
[
i
++] ^= *A; \

95 
B
 = &
WALK
[
PT2
 ^ 2]; 
RES
[
i
++] ^= *B; \

96 
C
 = &
WALK
[
PT1
 ^ 3]; 
RES
[
i
++] ^= *C; \

97 
D
 = &
WALK
[
PT2
 ^ 6]; 
RES
[
i
++] ^= *D; \

99 ifĞ
PTEST
 & 1 ) 
	`SWAP
Ğ
A
, 
C
 ); \

101 
IN
 = (*
A
 >> (5)è^ (*A << (27)è^ 
CLK
; \

102 *
A
 = (*
B
 >> (6)è^ (*B << (26)è^ 
CLK
; \

103 *
B
 = 
IN
; 
CLK
 = (è
	`h¬dşock
(); \

104 *
C
 = (*C >> (7)è^ (*C << (25)è^ 
CLK
; \

105 *
D
 = (*D >> (8)è^ (*D << (24)è^ 
CLK
; \

107 
A
 = &
WALK
[
PT1
 ^ 4]; \

108 
B
 = &
WALK
[
PT2
 ^ 1]; \

110 
PTEST
 = 
PT2
 >> 1; \

112 
PT2
 = (
RES
[(
i
 - 8è^ 
PTY
] ^ 
WALK
[PT2 ^ PTY ^ 7]); \

113 
PT2
 = ((PT2 & 0x1FFFè& (~8)è^ ((
PT1
 ^ 8) & 0x8); \

114 
PTY
 = (
PT2
 >> 10) & 7; \

116 
TST2_ENTER
 TST2_ENTER TST2_ENTER TST2_ENTER \

117 
TST2_ENTER
 TST2_ENTER TST2_ENTER TST2_ENTER \

118 
TST2_ENTER
 TST2_ENTER TST2_ENTER TST2_ENTER \

120 
TST2_LEAVE
 TST2_LEAVE TST2_LEAVE TST2_LEAVE \

121 
TST2_LEAVE
 TST2_LEAVE TST2_LEAVE TST2_LEAVE \

122 
TST2_LEAVE
 TST2_LEAVE TST2_LEAVE TST2_LEAVE \

124 
C
 = &
WALK
[
PT1
 ^ 5]; \

125 
D
 = &
WALK
[
PT2
 ^ 5]; \

127 
RES
[
i
++] ^ğ*
A
; \

128 
RES
[
i
++] ^ğ*
B
; \

129 
RES
[
i
++] ^ğ*
C
; \

130 
RES
[
i
++] ^ğ*
D
; \

132 
IN
 = (*
A
 >> ( 9)è^ (*A << (23)è^ 
CLK
; \

133 *
A
 = (*
B
 >> (10)è^ (*B << (22)è^ 
CLK
; \

134 *
B
 = 
IN
 ^ 
U2
; \

135 *
C
 = (*C >> (11)è^ (*C << (21)è^ 
CLK
; \

136 *
D
 = (*D >> (12)è^ (*D << (20)è^ 
CLK
; \

138 
A
 = &
WALK
[
PT1
 ^ 6]; 
RES
[
i
++] ^= *A; \

139 
B
 = &
WALK
[
PT2
 ^ 3]; 
RES
[
i
++] ^= *B; \

140 
C
 = &
WALK
[
PT1
 ^ 7]; 
RES
[
i
++] ^= *C; \

141 
D
 = &
WALK
[
PT2
 ^ 7]; 
RES
[
i
++] ^= *D; \

143 
IN
 = (*
A
 >> (13)è^ (*A << (19)è^ 
CLK
; \

144 *
A
 = (*
B
 >> (14)è^ (*B << (18)è^ 
CLK
; \

145 *
B
 = 
IN
; \

146 *
C
 = (*C >> (15)è^ (*C << (17)è^ 
CLK
; \

147 *
D
 = (*D >> (16)è^ (*D << (16)è^ 
CLK
; \

149 
PT1
 = ( 
RES
[(
i
 - 8è^ 
PTX
] ^ \

150 
WALK
[
PT1
 ^ 
PTX
 ^ 7] ) & (~1); \

151 
PT1
 ^ğ(
PT2
 ^ 0x10) & 0x10; \

153  
n
++, 
i
 = 0; i < 16; i++ ) \

154 
hs
->
poŞ
[
n
 % 
COLLECT_SIZE
] ^ğ
RES
[
i
];

	)

159 
	$havege_fl
Ğ
havege_¡©e
 *
hs
 )

161 
i
, 
n
 = 0;

162 
U1
, 
U2
, *
A
, *
B
, *
C
, *
D
;

163 
PT1
, 
PT2
, *
WALK
, 
RES
[16];

164 
PTX
, 
PTY
, 
CLK
, 
PTEST
, 
IN
;

166 
WALK
 = 
hs
->WALK;

167 
PT1
 = 
hs
->PT1;

168 
PT2
 = 
hs
->PT2;

170 
PTX
 = 
U1
 = 0;

171 
PTY
 = 
U2
 = 0;

173 
	`mem£t
Ğ
RES
, 0, ( RES ) );

175  
n
 < 
COLLECT_SIZE
 * 4 )

177 
ONE_ITERATION


178 
ONE_ITERATION


179 
ONE_ITERATION


180 
ONE_ITERATION


183 
hs
->
PT1
 = PT1;

184 
hs
->
PT2
 = PT2;

186 
hs
->
off£t
[0] = 0;

187 
hs
->
off£t
[1] = 
COLLECT_SIZE
 / 2;

188 
	}
}

193 
	$havege_š™
Ğ
havege_¡©e
 *
hs
 )

195 
	`mem£t
Ğ
hs
, 0, Ğ
havege_¡©e
 ) );

197 
	`havege_fl
Ğ
hs
 );

198 
	}
}

203 
	$havege_¿nd
Ğ*
p_ºg
 )

205 
»t
;

206 
havege_¡©e
 *
hs
 = (havege_¡©*è
p_ºg
;

208 ifĞ
hs
->
off£t
[1] >ğ
COLLECT_SIZE
 )

209 
	`havege_fl
Ğ
hs
 );

211 
»t
 = 
hs
->
poŞ
[hs->
off£t
[0]++];

212 
»t
 ^ğ
hs
->
poŞ
[hs->
off£t
[1]++];

214 Ğ
»t
 );

215 
	}
}

217 #ià
defšed
(
POLARSSL_RAND_TEST
)

219 
	~<¡dio.h
>

221 
	$maš
Ğ
¬gc
, *
¬gv
[] )

223 
FILE
 *
f
;

224 
time_t
 
t
;

225 
i
, 
j
, 
k
;

226 
havege_¡©e
 
hs
;

227 
buf
[1024];

229 ifĞ
¬gc
 < 2 )

231 
	`årštf
Ğ
¡d”r
, "u§ge: % <ouuˆf’ame>\n", 
¬gv
[0] );

235 ifĞĞ
f
 = 
	`fİ’
Ğ
¬gv
[1], "wb+" ) ) =ğ
NULL
 )

237 
	`´štf
Ğ"çedØİ’ '%s' fÜ wr™šg.\n", 
¬gv
[0] );

241 
	`havege_š™
Ğ&
hs
 );

243 
t
 = 
	`time
Ğ
NULL
 );

245  
i
 = 0, 
k
 = 32768; i < k; i++ )

247  
j
 = 0; j < Ğ
buf
 ); j++ )

248 
buf
[
j
] = 
	`havege_¿nd
Ğ&
hs
 );

250 
	`fwr™e
Ğ
buf
, Ğbuà), 1, 
f
 );

252 
	`´štf
( "Generating 32Mb of data in file '%s'... %04.1f" \

253 "%% dÚe\r", 
¬gv
[1], (100 * (è(
i
 + 1)è/ 
k
 );

254 
	`fæush
Ğ
¡dout
 );

257 ifĞ
t
 =ğ
	`time
Ğ
NULL
 ) )

258 
t
--;

260 
	`fşo£
Ğ
f
 );

262 
	}
}

	@src/polarssl/havege.h

25 #iâdeà
POLARSSL_HAVEGE_H


26 
	#POLARSSL_HAVEGE_H


	)

28 
	#COLLECT_SIZE
 1024

	)

35 
	mPT1
, 
	mPT2
, 
	moff£t
[2];

36 
	mpoŞ
[
COLLECT_SIZE
];

37 
	mWALK
[8192];

39 
	thavege_¡©e
;

41 #ifdeà
__ılu¥lus


50 
havege_š™
Ğ
havege_¡©e
 *
hs
 );

59 
havege_¿nd
Ğ*
p_ºg
 );

61 #ifdeà
__ılu¥lus


	@src/polarssl/md2.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_MD2_C
)

36 
	~"pŞ¬s¦/md2.h
"

38 
	~<¡ršg.h
>

39 
	~<¡dio.h
>

41 cÚ¡ 
	gPI_SUBST
[256] =

74 
	$md2_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
 )

76 
	`mem£t
Ğ
ùx
->
cksum
, 0, 16 );

77 
	`mem£t
Ğ
ùx
->
¡©e
, 0, 46 );

78 
	`mem£t
Ğ
ùx
->
bufãr
, 0, 16 );

79 
ùx
->
Ëá
 = 0;

80 
	}
}

82 
	$md2_´oûss
Ğ
md2_cÚ‹xt
 *
ùx
 )

84 
i
, 
j
;

85 
t
 = 0;

87  
i
 = 0; i < 16; i++ )

89 
ùx
->
¡©e
[
i
 + 16] = ctx->
bufãr
[i];

90 
ùx
->
¡©e
[
i
 + 32] =

91 ()Ğ
ùx
->
bufãr
[
i
] ^ ctx->
¡©e
[i]);

94  
i
 = 0; i < 18; i++ )

96  
j
 = 0; j < 48; j++ )

98 
ùx
->
¡©e
[
j
] = ()

99 Ğ
ùx
->
¡©e
[
j
] ^ 
PI_SUBST
[
t
] );

100 
t
 = 
ùx
->
¡©e
[
j
];

103 
t
 = ()Ğˆ+ 
i
 );

106 
t
 = 
ùx
->
cksum
[15];

108  
i
 = 0; i < 16; i++ )

110 
ùx
->
cksum
[
i
] = ()

111 Ğ
ùx
->
cksum
[
i
] ^ 
PI_SUBST
[ùx->
bufãr
[i] ^ 
t
] );

112 
t
 = 
ùx
->
cksum
[
i
];

114 
	}
}

119 
	$md2_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

121 
fl
;

123  
’
 > 0 )

125 ifĞ
ùx
->
Ëá
 + 
’
 > 16 )

126 
fl
 = 16 - 
ùx
->
Ëá
;

128 
fl
 = 
’
;

130 
	`memıy
Ğ
ùx
->
bufãr
 + ctx->
Ëá
, 
šput
, 
fl
 );

132 
ùx
->
Ëá
 +ğ
fl
;

133 
šput
 +ğ
fl
;

134 
’
 -ğ
fl
;

136 ifĞ
ùx
->
Ëá
 == 16 )

138 
ùx
->
Ëá
 = 0;

139 
	`md2_´oûss
Ğ
ùx
 );

142 
	}
}

147 
	$md2_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] )

149 
i
;

150 
x
;

152 
x
 = ()Ğ16 - 
ùx
->
Ëá
 );

154  
i
 = 
ùx
->
Ëá
; i < 16; i++ )

155 
ùx
->
bufãr
[
i
] = 
x
;

157 
	`md2_´oûss
Ğ
ùx
 );

159 
	`memıy
Ğ
ùx
->
bufãr
, ctx->
cksum
, 16 );

160 
	`md2_´oûss
Ğ
ùx
 );

162 
	`memıy
Ğ
ouut
, 
ùx
->
¡©e
, 16 );

163 
	}
}

168 
	$md2
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] )

170 
md2_cÚ‹xt
 
ùx
;

172 
	`md2_¡¬ts
Ğ&
ùx
 );

173 
	`md2_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

174 
	`md2_fšish
Ğ&
ùx
, 
ouut
 );

176 
	`mem£t
Ğ&
ùx
, 0, Ğ
md2_cÚ‹xt
 ) );

177 
	}
}

182 
	$md2_fe
ĞcÚ¡ *
·th
, 
ouut
[16] )

184 
FILE
 *
f
;

185 
size_t
 
n
;

186 
md2_cÚ‹xt
 
ùx
;

187 
buf
[1024];

189 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

192 
	`md2_¡¬ts
Ğ&
ùx
 );

194  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

195 
	`md2_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

197 
	`md2_fšish
Ğ&
ùx
, 
ouut
 );

199 
	`mem£t
Ğ&
ùx
, 0, Ğ
md2_cÚ‹xt
 ) );

201 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

203 
	`fşo£
Ğ
f
 );

207 
	`fşo£
Ğ
f
 );

209 
	}
}

214 
	$md2_hmac_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

216 
i
;

217 
sum
[16];

219 ifĞ
keyËn
 > 64 )

221 
	`md2
Ğ
key
, 
keyËn
, 
sum
 );

222 
keyËn
 = 16;

223 
key
 = 
sum
;

226 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

227 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

229  
i
 = 0; i < 
keyËn
; i++ )

231 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

232 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

235 
	`md2_¡¬ts
Ğ
ùx
 );

236 
	`md2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

238 
	`mem£t
Ğ
sum
, 0, ( sum ) );

239 
	}
}

244 
	$md2_hmac_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

246 
	`md2_upd©e
Ğ
ùx
, 
šput
, 
’
 );

247 
	}
}

252 
	$md2_hmac_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] )

254 
tmpbuf
[16];

256 
	`md2_fšish
Ğ
ùx
, 
tmpbuf
 );

257 
	`md2_¡¬ts
Ğ
ùx
 );

258 
	`md2_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

259 
	`md2_upd©e
Ğ
ùx
, 
tmpbuf
, 16 );

260 
	`md2_fšish
Ğ
ùx
, 
ouut
 );

262 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

263 
	}
}

268 
	$md2_hmac_»£t
Ğ
md2_cÚ‹xt
 *
ùx
 )

270 
	`md2_¡¬ts
Ğ
ùx
 );

271 
	`md2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

272 
	}
}

277 
	$md2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

278 cÚ¡ *
šput
, 
’
,

279 
ouut
[16] )

281 
md2_cÚ‹xt
 
ùx
;

283 
	`md2_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

284 
	`md2_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

285 
	`md2_hmac_fšish
Ğ&
ùx
, 
ouut
 );

287 
	`mem£t
Ğ&
ùx
, 0, Ğ
md2_cÚ‹xt
 ) );

288 
	}
}

290 #ià
defšed
(
POLARSSL_SELF_TEST
)

295 cÚ¡ 
	gmd2_‹¡_¡r
[7][81] =

307 cÚ¡ 
	gmd2_‹¡_sum
[7][16] =

328 
	$md2_£lf_‹¡
Ğ
v”bo£
 )

330 
i
;

331 
md2sum
[16];

333  
i
 = 0; i < 7; i++ )

335 ifĞ
v”bo£
 != 0 )

336 
	`´štf
Ğ" MD2e¡ #%d: ", 
i
 + 1 );

338 
	`md2
Ğ(*è
md2_‹¡_¡r
[
i
],

339 
	`¡¾’
Ğ
md2_‹¡_¡r
[
i
] ), 
md2sum
 );

341 ifĞ
	`memcmp
Ğ
md2sum
, 
md2_‹¡_sum
[
i
], 16 ) != 0 )

343 ifĞ
v”bo£
 != 0 )

344 
	`´štf
( "failed\n" );

349 ifĞ
v”bo£
 != 0 )

350 
	`´štf
( "passed\n" );

353 ifĞ
v”bo£
 != 0 )

354 
	`´štf
( "\n" );

357 
	}
}

	@src/polarssl/md2.h

25 #iâdeà
POLARSSL_MD2_H


26 
	#POLARSSL_MD2_H


	)

33 
	mcksum
[16];

34 
	m¡©e
[48];

35 
	mbufãr
[16];

37 
	mad
[64];

38 
	mİad
[64];

39 
	mËá
;

41 
	tmd2_cÚ‹xt
;

43 #ifdeà
__ılu¥lus


52 
md2_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
 );

61 
md2_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

69 
md2_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] );

78 
md2
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] );

89 
md2_fe
ĞcÚ¡ *
·th
, 
ouut
[16] );

98 
md2_hmac_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

107 
md2_hmac_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

115 
md2_hmac_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] );

122 
md2_hmac_»£t
Ğ
md2_cÚ‹xt
 *
ùx
 );

133 
md2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

134 cÚ¡ *
šput
, 
’
,

135 
ouut
[16] );

142 
md2_£lf_‹¡
Ğ
v”bo£
 );

144 #ifdeà
__ılu¥lus


	@src/polarssl/md4.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_MD4_C
)

36 
	~"pŞ¬s¦/md4.h
"

38 
	~<¡ršg.h
>

39 
	~<¡dio.h
>

44 #iâdeà
GET_ULONG_LE


45 
	#GET_ULONG_LE
(
n
,
b
,
i
) \

47 (
n
èğĞ(è(
b
)[(
i
) ] ) \

48 | ( (è(
b
)[(
i
) + 1] << 8 ) \

49 | ( (è(
b
)[(
i
) + 2] << 16 ) \

50 | ( (è(
b
)[(
i
) + 3] << 24 ); \

51 }

	)

54 #iâdeà
PUT_ULONG_LE


55 
	#PUT_ULONG_LE
(
n
,
b
,
i
) \

57 (
b
)[(
i
è] = (èĞ(
n
) ); \

58 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 16 ); \

60 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 24 ); \

61 }

	)

67 
	$md4_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
 )

69 
ùx
->
tÙ®
[0] = 0;

70 
ùx
->
tÙ®
[1] = 0;

72 
ùx
->
¡©e
[0] = 0x67452301;

73 
ùx
->
¡©e
[1] = 0xEFCDAB89;

74 
ùx
->
¡©e
[2] = 0x98BADCFE;

75 
ùx
->
¡©e
[3] = 0x10325476;

76 
	}
}

78 
	$md4_´oûss
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

80 
X
[16], 
A
, 
B
, 
C
, 
D
;

82 
	`GET_ULONG_LE
Ğ
X
[ 0], 
d©a
, 0 );

83 
	`GET_ULONG_LE
Ğ
X
[ 1], 
d©a
, 4 );

84 
	`GET_ULONG_LE
Ğ
X
[ 2], 
d©a
, 8 );

85 
	`GET_ULONG_LE
Ğ
X
[ 3], 
d©a
, 12 );

86 
	`GET_ULONG_LE
Ğ
X
[ 4], 
d©a
, 16 );

87 
	`GET_ULONG_LE
Ğ
X
[ 5], 
d©a
, 20 );

88 
	`GET_ULONG_LE
Ğ
X
[ 6], 
d©a
, 24 );

89 
	`GET_ULONG_LE
Ğ
X
[ 7], 
d©a
, 28 );

90 
	`GET_ULONG_LE
Ğ
X
[ 8], 
d©a
, 32 );

91 
	`GET_ULONG_LE
Ğ
X
[ 9], 
d©a
, 36 );

92 
	`GET_ULONG_LE
Ğ
X
[10], 
d©a
, 40 );

93 
	`GET_ULONG_LE
Ğ
X
[11], 
d©a
, 44 );

94 
	`GET_ULONG_LE
Ğ
X
[12], 
d©a
, 48 );

95 
	`GET_ULONG_LE
Ğ
X
[13], 
d©a
, 52 );

96 
	`GET_ULONG_LE
Ğ
X
[14], 
d©a
, 56 );

97 
	`GET_ULONG_LE
Ğ
X
[15], 
d©a
, 60 );

99 
	#S
(
x
,
n
è((x <<‚è| ((x & 0xFFFFFFFFè>> (32 -‚)))

	)

101 
A
 = 
ùx
->
¡©e
[0];

102 
B
 = 
ùx
->
¡©e
[1];

103 
C
 = 
ùx
->
¡©e
[2];

104 
D
 = 
ùx
->
¡©e
[3];

106 
	#F
(
x
, 
y
, 
z
è((x & yè| ((~xè& z))

	)

107 
	#P
(
a
,
b
,
c
,
d
,
x
,
s
è{‡ +ğ
	`F
(b,c,dè+ x;‡ = 
	`S
×,s); }

	)

109 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 0], 3 );

110 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 1], 7 );

111 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 2], 11 );

112 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[ 3], 19 );

113 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 4], 3 );

114 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 5], 7 );

115 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 6], 11 );

116 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[ 7], 19 );

117 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 8], 3 );

118 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 9], 7 );

119 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[10], 11 );

120 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[11], 19 );

121 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[12], 3 );

122 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[13], 7 );

123 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[14], 11 );

124 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[15], 19 );

126 #undeà
P


127 #undeà
F


129 
	#F
(
x
,
y
,
z
è((x & yè| (x & zè| (y & z))

	)

130 
	#P
(
a
,
b
,
c
,
d
,
x
,
s
è{‡ +ğ
	`F
(b,c,dè+ x + 0x5A827999;‡ = 
	`S
×,s); }

	)

132 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 0], 3 );

133 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 4], 5 );

134 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 8], 9 );

135 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[12], 13 );

136 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 1], 3 );

137 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 5], 5 );

138 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 9], 9 );

139 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[13], 13 );

140 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 2], 3 );

141 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 6], 5 );

142 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[10], 9 );

143 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[14], 13 );

144 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 3], 3 );

145 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 7], 5 );

146 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[11], 9 );

147 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[15], 13 );

149 #undeà
P


150 #undeà
F


152 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

153 
	#P
(
a
,
b
,
c
,
d
,
x
,
s
è{‡ +ğ
	`F
(b,c,dè+ x + 0x6ED9EBA1;‡ = 
	`S
×,s); }

	)

155 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 0], 3 );

156 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 8], 9 );

157 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 4], 11 );

158 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[12], 15 );

159 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 2], 3 );

160 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[10], 9 );

161 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 6], 11 );

162 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[14], 15 );

163 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 1], 3 );

164 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 9], 9 );

165 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 5], 11 );

166 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[13], 15 );

167 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 3], 3 );

168 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[11], 9 );

169 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 7], 11 );

170 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[15], 15 );

172 #undeà
F


173 #undeà
P


175 
ùx
->
¡©e
[0] +ğ
A
;

176 
ùx
->
¡©e
[1] +ğ
B
;

177 
ùx
->
¡©e
[2] +ğ
C
;

178 
ùx
->
¡©e
[3] +ğ
D
;

179 
	}
}

184 
	$md4_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

186 
fl
;

187 
Ëá
;

189 ifĞ
’
 <= 0 )

192 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

193 
fl
 = 64 - 
Ëá
;

195 
ùx
->
tÙ®
[0] +ğ
’
;

196 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

198 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

199 
ùx
->
tÙ®
[1]++;

201 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

203 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

204 (*è
šput
, 
fl
 );

205 
	`md4_´oûss
Ğ
ùx
, ctx->
bufãr
 );

206 
šput
 +ğ
fl
;

207 
’
 -ğ
fl
;

208 
Ëá
 = 0;

211  
’
 >= 64 )

213 
	`md4_´oûss
Ğ
ùx
, 
šput
 );

214 
šput
 += 64;

215 
’
 -= 64;

218 ifĞ
’
 > 0 )

220 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

221 (*è
šput
, 
’
 );

223 
	}
}

225 cÚ¡ 
	gmd4_·ddšg
[64] =

236 
	$md4_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] )

238 
Ï¡
, 
·dn
;

239 
high
, 
low
;

240 
msgËn
[8];

242 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

243 | ( 
ùx
->
tÙ®
[1] << 3 );

244 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

246 
	`PUT_ULONG_LE
Ğ
low
, 
msgËn
, 0 );

247 
	`PUT_ULONG_LE
Ğ
high
, 
msgËn
, 4 );

249 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

250 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

252 
	`md4_upd©e
Ğ
ùx
, (*è
md4_·ddšg
, 
·dn
 );

253 
	`md4_upd©e
Ğ
ùx
, 
msgËn
, 8 );

255 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

256 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

257 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

258 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

259 
	}
}

264 
	$md4
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] )

266 
md4_cÚ‹xt
 
ùx
;

268 
	`md4_¡¬ts
Ğ&
ùx
 );

269 
	`md4_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

270 
	`md4_fšish
Ğ&
ùx
, 
ouut
 );

272 
	`mem£t
Ğ&
ùx
, 0, Ğ
md4_cÚ‹xt
 ) );

273 
	}
}

278 
	$md4_fe
ĞcÚ¡ *
·th
, 
ouut
[16] )

280 
FILE
 *
f
;

281 
size_t
 
n
;

282 
md4_cÚ‹xt
 
ùx
;

283 
buf
[1024];

285 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

288 
	`md4_¡¬ts
Ğ&
ùx
 );

290  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

291 
	`md4_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

293 
	`md4_fšish
Ğ&
ùx
, 
ouut
 );

295 
	`mem£t
Ğ&
ùx
, 0, Ğ
md4_cÚ‹xt
 ) );

297 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

299 
	`fşo£
Ğ
f
 );

303 
	`fşo£
Ğ
f
 );

305 
	}
}

310 
	$md4_hmac_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

312 
i
;

313 
sum
[16];

315 ifĞ
keyËn
 > 64 )

317 
	`md4
Ğ
key
, 
keyËn
, 
sum
 );

318 
keyËn
 = 16;

319 
key
 = 
sum
;

322 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

323 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

325  
i
 = 0; i < 
keyËn
; i++ )

327 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

328 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

331 
	`md4_¡¬ts
Ğ
ùx
 );

332 
	`md4_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

334 
	`mem£t
Ğ
sum
, 0, ( sum ) );

335 
	}
}

340 
	$md4_hmac_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

342 
	`md4_upd©e
Ğ
ùx
, 
šput
, 
’
 );

343 
	}
}

348 
	$md4_hmac_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] )

350 
tmpbuf
[16];

352 
	`md4_fšish
Ğ
ùx
, 
tmpbuf
 );

353 
	`md4_¡¬ts
Ğ
ùx
 );

354 
	`md4_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

355 
	`md4_upd©e
Ğ
ùx
, 
tmpbuf
, 16 );

356 
	`md4_fšish
Ğ
ùx
, 
ouut
 );

358 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

359 
	}
}

364 
	$md4_hmac_»£t
Ğ
md4_cÚ‹xt
 *
ùx
 )

366 
	`md4_¡¬ts
Ğ
ùx
 );

367 
	`md4_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

368 
	}
}

373 
	$md4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

374 cÚ¡ *
šput
, 
’
,

375 
ouut
[16] )

377 
md4_cÚ‹xt
 
ùx
;

379 
	`md4_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

380 
	`md4_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

381 
	`md4_hmac_fšish
Ğ&
ùx
, 
ouut
 );

383 
	`mem£t
Ğ&
ùx
, 0, Ğ
md4_cÚ‹xt
 ) );

384 
	}
}

386 #ià
defšed
(
POLARSSL_SELF_TEST
)

391 cÚ¡ 
	gmd4_‹¡_¡r
[7][81] =

403 cÚ¡ 
	gmd4_‹¡_sum
[7][16] =

424 
	$md4_£lf_‹¡
Ğ
v”bo£
 )

426 
i
;

427 
md4sum
[16];

429  
i
 = 0; i < 7; i++ )

431 ifĞ
v”bo£
 != 0 )

432 
	`´štf
Ğ" MD4e¡ #%d: ", 
i
 + 1 );

434 
	`md4
Ğ(*è
md4_‹¡_¡r
[
i
],

435 
	`¡¾’
Ğ
md4_‹¡_¡r
[
i
] ), 
md4sum
 );

437 ifĞ
	`memcmp
Ğ
md4sum
, 
md4_‹¡_sum
[
i
], 16 ) != 0 )

439 ifĞ
v”bo£
 != 0 )

440 
	`´štf
( "failed\n" );

445 ifĞ
v”bo£
 != 0 )

446 
	`´štf
( "passed\n" );

449 ifĞ
v”bo£
 != 0 )

450 
	`´štf
( "\n" );

453 
	}
}

	@src/polarssl/md4.h

25 #iâdeà
POLARSSL_MD4_H


26 
	#POLARSSL_MD4_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[4];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

40 
	tmd4_cÚ‹xt
;

42 #ifdeà
__ılu¥lus


51 
md4_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
 );

60 
md4_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

68 
md4_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] );

77 
md4
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] );

88 
md4_fe
ĞcÚ¡ *
·th
, 
ouut
[16] );

97 
md4_hmac_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

106 
md4_hmac_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

114 
md4_hmac_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] );

121 
md4_hmac_»£t
Ğ
md4_cÚ‹xt
 *
ùx
 );

132 
md4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

133 cÚ¡ *
šput
, 
’
,

134 
ouut
[16] );

141 
md4_£lf_‹¡
Ğ
v”bo£
 );

143 #ifdeà
__ılu¥lus


	@src/polarssl/md5.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_MD5_C
)

35 
	~"pŞ¬s¦/md5.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_ULONG_LE


44 
	#GET_ULONG_LE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] ) \

47 | ( (è(
b
)[(
i
) + 1] << 8 ) \

48 | ( (è(
b
)[(
i
) + 2] << 16 ) \

49 | ( (è(
b
)[(
i
) + 3] << 24 ); \

50 }

	)

53 #iâdeà
PUT_ULONG_LE


54 
	#PUT_ULONG_LE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 8 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 16 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 24 ); \

60 }

	)

66 
	$md5_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
 )

68 
ùx
->
tÙ®
[0] = 0;

69 
ùx
->
tÙ®
[1] = 0;

71 
ùx
->
¡©e
[0] = 0x67452301;

72 
ùx
->
¡©e
[1] = 0xEFCDAB89;

73 
ùx
->
¡©e
[2] = 0x98BADCFE;

74 
ùx
->
¡©e
[3] = 0x10325476;

75 
	}
}

77 
	$md5_´oûss
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

79 
X
[16], 
A
, 
B
, 
C
, 
D
;

81 
	`GET_ULONG_LE
Ğ
X
[ 0], 
d©a
, 0 );

82 
	`GET_ULONG_LE
Ğ
X
[ 1], 
d©a
, 4 );

83 
	`GET_ULONG_LE
Ğ
X
[ 2], 
d©a
, 8 );

84 
	`GET_ULONG_LE
Ğ
X
[ 3], 
d©a
, 12 );

85 
	`GET_ULONG_LE
Ğ
X
[ 4], 
d©a
, 16 );

86 
	`GET_ULONG_LE
Ğ
X
[ 5], 
d©a
, 20 );

87 
	`GET_ULONG_LE
Ğ
X
[ 6], 
d©a
, 24 );

88 
	`GET_ULONG_LE
Ğ
X
[ 7], 
d©a
, 28 );

89 
	`GET_ULONG_LE
Ğ
X
[ 8], 
d©a
, 32 );

90 
	`GET_ULONG_LE
Ğ
X
[ 9], 
d©a
, 36 );

91 
	`GET_ULONG_LE
Ğ
X
[10], 
d©a
, 40 );

92 
	`GET_ULONG_LE
Ğ
X
[11], 
d©a
, 44 );

93 
	`GET_ULONG_LE
Ğ
X
[12], 
d©a
, 48 );

94 
	`GET_ULONG_LE
Ğ
X
[13], 
d©a
, 52 );

95 
	`GET_ULONG_LE
Ğ
X
[14], 
d©a
, 56 );

96 
	`GET_ULONG_LE
Ğ
X
[15], 
d©a
, 60 );

98 
	#S
(
x
,
n
è((x <<‚è| ((x & 0xFFFFFFFFè>> (32 -‚)))

	)

100 
	#P
(
a
,
b
,
c
,
d
,
k
,
s
,
t
) \

102 
a
 +ğ
	`F
(
b
,
c
,
d
è+ 
X
[
k
] + 
t
;‡ = 
	`S
×,
s
) + b; \

103 }

	)

105 
A
 = 
ùx
->
¡©e
[0];

106 
B
 = 
ùx
->
¡©e
[1];

107 
C
 = 
ùx
->
¡©e
[2];

108 
D
 = 
ùx
->
¡©e
[3];

110 
	#F
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

112 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 0, 7, 0xD76AA478 );

113 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 1, 12, 0xE8C7B756 );

114 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 2, 17, 0x242070DB );

115 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 3, 22, 0xC1BDCEEE );

116 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 4, 7, 0xF57C0FAF );

117 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 5, 12, 0x4787C62A );

118 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 6, 17, 0xA8304613 );

119 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 7, 22, 0xFD469501 );

120 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 8, 7, 0x698098D8 );

121 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 9, 12, 0x8B44F7AF );

122 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 10, 17, 0xFFFF5BB1 );

123 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 11, 22, 0x895CD7BE );

124 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 12, 7, 0x6B901122 );

125 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 13, 12, 0xFD987193 );

126 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 14, 17, 0xA679438E );

127 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 15, 22, 0x49B40821 );

129 #undeà
F


131 
	#F
(
x
,
y
,
z
è(y ^ (z & (x ^ y)))

	)

133 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 1, 5, 0xF61E2562 );

134 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 6, 9, 0xC040B340 );

135 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 11, 14, 0x265E5A51 );

136 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 0, 20, 0xE9B6C7AA );

137 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 5, 5, 0xD62F105D );

138 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 10, 9, 0x02441453 );

139 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 15, 14, 0xD8A1E681 );

140 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 4, 20, 0xE7D3FBC8 );

141 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 9, 5, 0x21E1CDE6 );

142 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 14, 9, 0xC33707D6 );

143 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 3, 14, 0xF4D50D87 );

144 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 8, 20, 0x455A14ED );

145 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 13, 5, 0xA9E3E905 );

146 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 2, 9, 0xFCEFA3F8 );

147 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 7, 14, 0x676F02D9 );

148 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 12, 20, 0x8D2A4C8A );

150 #undeà
F


152 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

154 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 5, 4, 0xFFFA3942 );

155 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 8, 11, 0x8771F681 );

156 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 11, 16, 0x6D9D6122 );

157 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 14, 23, 0xFDE5380C );

158 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 1, 4, 0xA4BEEA44 );

159 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 4, 11, 0x4BDECFA9 );

160 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 7, 16, 0xF6BB4B60 );

161 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 10, 23, 0xBEBFBC70 );

162 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 13, 4, 0x289B7EC6 );

163 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 0, 11, 0xEAA127FA );

164 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 3, 16, 0xD4EF3085 );

165 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 6, 23, 0x04881D05 );

166 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 9, 4, 0xD9D4D039 );

167 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 12, 11, 0xE6DB99E5 );

168 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 15, 16, 0x1FA27CF8 );

169 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 2, 23, 0xC4AC5665 );

171 #undeà
F


173 
	#F
(
x
,
y
,
z
è(y ^ (x | ~z))

	)

175 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 0, 6, 0xF4292244 );

176 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 7, 10, 0x432AFF97 );

177 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 14, 15, 0xAB9423A7 );

178 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 5, 21, 0xFC93A039 );

179 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 12, 6, 0x655B59C3 );

180 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 3, 10, 0x8F0CCC92 );

181 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 10, 15, 0xFFEFF47D );

182 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 1, 21, 0x85845DD1 );

183 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 8, 6, 0x6FA87E4F );

184 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 15, 10, 0xFE2CE6E0 );

185 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 6, 15, 0xA3014314 );

186 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 13, 21, 0x4E0811A1 );

187 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 4, 6, 0xF7537E82 );

188 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 11, 10, 0xBD3AF235 );

189 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 2, 15, 0x2AD7D2BB );

190 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 9, 21, 0xEB86D391 );

192 #undeà
F


194 
ùx
->
¡©e
[0] +ğ
A
;

195 
ùx
->
¡©e
[1] +ğ
B
;

196 
ùx
->
¡©e
[2] +ğ
C
;

197 
ùx
->
¡©e
[3] +ğ
D
;

198 
	}
}

203 
	$md5_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

205 
fl
;

206 
Ëá
;

208 ifĞ
’
 <= 0 )

211 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

212 
fl
 = 64 - 
Ëá
;

214 
ùx
->
tÙ®
[0] +ğ
’
;

215 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

217 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

218 
ùx
->
tÙ®
[1]++;

220 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

222 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

223 (*è
šput
, 
fl
 );

224 
	`md5_´oûss
Ğ
ùx
, ctx->
bufãr
 );

225 
šput
 +ğ
fl
;

226 
’
 -ğ
fl
;

227 
Ëá
 = 0;

230  
’
 >= 64 )

232 
	`md5_´oûss
Ğ
ùx
, 
šput
 );

233 
šput
 += 64;

234 
’
 -= 64;

237 ifĞ
’
 > 0 )

239 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

240 (*è
šput
, 
’
 );

242 
	}
}

244 cÚ¡ 
	gmd5_·ddšg
[64] =

255 
	$md5_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] )

257 
Ï¡
, 
·dn
;

258 
high
, 
low
;

259 
msgËn
[8];

261 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

262 | ( 
ùx
->
tÙ®
[1] << 3 );

263 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

265 
	`PUT_ULONG_LE
Ğ
low
, 
msgËn
, 0 );

266 
	`PUT_ULONG_LE
Ğ
high
, 
msgËn
, 4 );

268 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

269 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

271 
	`md5_upd©e
Ğ
ùx
, (*è
md5_·ddšg
, 
·dn
 );

272 
	`md5_upd©e
Ğ
ùx
, 
msgËn
, 8 );

274 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

275 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

276 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

277 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

278 
	}
}

283 
	$md5
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] )

285 
md5_cÚ‹xt
 
ùx
;

287 
	`md5_¡¬ts
Ğ&
ùx
 );

288 
	`md5_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

289 
	`md5_fšish
Ğ&
ùx
, 
ouut
 );

291 
	`mem£t
Ğ&
ùx
, 0, Ğ
md5_cÚ‹xt
 ) );

292 
	}
}

297 
	$md5_fe
ĞcÚ¡ *
·th
, 
ouut
[16] )

299 
FILE
 *
f
;

300 
size_t
 
n
;

301 
md5_cÚ‹xt
 
ùx
;

302 
buf
[1024];

304 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

307 
	`md5_¡¬ts
Ğ&
ùx
 );

309  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

310 
	`md5_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

312 
	`md5_fšish
Ğ&
ùx
, 
ouut
 );

314 
	`mem£t
Ğ&
ùx
, 0, Ğ
md5_cÚ‹xt
 ) );

316 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

318 
	`fşo£
Ğ
f
 );

322 
	`fşo£
Ğ
f
 );

324 
	}
}

329 
	$md5_hmac_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

331 
i
;

332 
sum
[16];

334 ifĞ
keyËn
 > 64 )

336 
	`md5
Ğ
key
, 
keyËn
, 
sum
 );

337 
keyËn
 = 16;

338 
key
 = 
sum
;

341 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

342 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

344  
i
 = 0; i < 
keyËn
; i++ )

346 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

347 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

350 
	`md5_¡¬ts
Ğ
ùx
 );

351 
	`md5_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

353 
	`mem£t
Ğ
sum
, 0, ( sum ) );

354 
	}
}

359 
	$md5_hmac_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

361 
	`md5_upd©e
Ğ
ùx
, 
šput
, 
’
 );

362 
	}
}

367 
	$md5_hmac_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] )

369 
tmpbuf
[16];

371 
	`md5_fšish
Ğ
ùx
, 
tmpbuf
 );

372 
	`md5_¡¬ts
Ğ
ùx
 );

373 
	`md5_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

374 
	`md5_upd©e
Ğ
ùx
, 
tmpbuf
, 16 );

375 
	`md5_fšish
Ğ
ùx
, 
ouut
 );

377 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

378 
	}
}

383 
	$md5_hmac_»£t
Ğ
md5_cÚ‹xt
 *
ùx
 )

385 
	`md5_¡¬ts
Ğ
ùx
 );

386 
	`md5_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

387 
	}
}

392 
	$md5_hmac
ĞcÚ¡ *
key
, 
keyËn
,

393 cÚ¡ *
šput
, 
’
,

394 
ouut
[16] )

396 
md5_cÚ‹xt
 
ùx
;

398 
	`md5_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

399 
	`md5_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

400 
	`md5_hmac_fšish
Ğ&
ùx
, 
ouut
 );

402 
	`mem£t
Ğ&
ùx
, 0, Ğ
md5_cÚ‹xt
 ) );

403 
	}
}

405 #ià
defšed
(
POLARSSL_SELF_TEST
)

409 
	gmd5_‹¡_buf
[7][81] =

421 cÚ¡ 
	gmd5_‹¡_buæ’
[7] =

426 cÚ¡ 
	gmd5_‹¡_sum
[7][16] =

447 
	gmd5_hmac_‹¡_key
[7][26] =

459 cÚ¡ 
	gmd5_hmac_‹¡_keyËn
[7] =

464 
	gmd5_hmac_‹¡_buf
[7][74] =

484 cÚ¡ 
	gmd5_hmac_‹¡_buæ’
[7] =

489 cÚ¡ 
	gmd5_hmac_‹¡_sum
[7][16] =

510 
	$md5_£lf_‹¡
Ğ
v”bo£
 )

512 
i
, 
buæ’
;

513 
buf
[1024];

514 
md5sum
[16];

515 
md5_cÚ‹xt
 
ùx
;

517  
i
 = 0; i < 7; i++ )

519 ifĞ
v”bo£
 != 0 )

520 
	`´štf
Ğ" MD5e¡ #%d: ", 
i
 + 1 );

522 
	`md5
Ğ
md5_‹¡_buf
[
i
], 
md5_‹¡_buæ’
[i], 
md5sum
 );

524 ifĞ
	`memcmp
Ğ
md5sum
, 
md5_‹¡_sum
[
i
], 16 ) != 0 )

526 ifĞ
v”bo£
 != 0 )

527 
	`´štf
( "failed\n" );

532 ifĞ
v”bo£
 != 0 )

533 
	`´štf
( "passed\n" );

536 ifĞ
v”bo£
 != 0 )

537 
	`´štf
( "\n" );

539  
i
 = 0; i < 7; i++ )

541 ifĞ
v”bo£
 != 0 )

542 
	`´štf
Ğ" HMAC-MD5e¡ #%d: ", 
i
 + 1 );

544 ifĞ
i
 == 5 || i == 6 )

546 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 80 );

547 
	`md5_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
 );

550 
	`md5_hmac_¡¬ts
Ğ&
ùx
, 
md5_hmac_‹¡_key
[
i
],

551 
md5_hmac_‹¡_keyËn
[
i
] );

553 
	`md5_hmac_upd©e
Ğ&
ùx
, 
md5_hmac_‹¡_buf
[
i
],

554 
md5_hmac_‹¡_buæ’
[
i
] );

556 
	`md5_hmac_fšish
Ğ&
ùx
, 
md5sum
 );

558 
buæ’
 = ( 
i
 == 4 ) ? 12 : 16;

560 ifĞ
	`memcmp
Ğ
md5sum
, 
md5_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

562 ifĞ
v”bo£
 != 0 )

563 
	`´štf
( "failed\n" );

568 ifĞ
v”bo£
 != 0 )

569 
	`´štf
( "passed\n" );

572 ifĞ
v”bo£
 != 0 )

573 
	`´štf
( "\n" );

576 
	}
}

	@src/polarssl/md5.h

25 #iâdeà
POLARSSL_MD5_H


26 
	#POLARSSL_MD5_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[4];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

40 
	tmd5_cÚ‹xt
;

42 #ifdeà
__ılu¥lus


51 
md5_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
 );

60 
md5_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

68 
md5_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] );

77 
md5
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] );

88 
md5_fe
ĞcÚ¡ *
·th
, 
ouut
[16] );

97 
md5_hmac_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
,

98 cÚ¡ *
key
, 
keyËn
 );

107 
md5_hmac_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
,

108 cÚ¡ *
šput
, 
’
 );

116 
md5_hmac_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] );

123 
md5_hmac_»£t
Ğ
md5_cÚ‹xt
 *
ùx
 );

134 
md5_hmac
ĞcÚ¡ *
key
, 
keyËn
,

135 cÚ¡ *
šput
, 
’
,

136 
ouut
[16] );

143 
md5_£lf_‹¡
Ğ
v”bo£
 );

145 #ifdeà
__ılu¥lus


	@src/polarssl/net.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_NET_C
)

30 
	~"pŞ¬s¦/Ãt.h
"

32 #ià
defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

34 
	~<wšsock2.h
>

35 
	~<wšdows.h
>

37 #ià
defšed
(
_WIN32_WCE
)

38 #´agm¨
comm’t
Ğ
lib
, "ws2.lib" )

40 #´agm¨
comm’t
Ğ
lib
, "ws2_32.lib" )

43 
	#»ad
(
fd
,
buf
,
Ën
è
	`»cv
(fd,buf,Ën,0)

	)

44 
	#wr™e
(
fd
,
buf
,
Ën
è
	`£nd
(fd,buf,Ën,0)

	)

45 
	#şo£
(
fd
è
	`şo£sock‘
(fd)

	)

47 
	gw§_š™_dÚe
 = 0;

51 
	~<sys/ty³s.h
>

52 
	~<sys/sock‘.h
>

53 
	~<Ãtš‘/š.h
>

54 
	~<¬·/š‘.h
>

55 
	~<sys/time.h
>

56 
	~<uni¡d.h
>

57 
	~<sigÇl.h
>

58 
	~<fú.h
>

59 
	~<Ãtdb.h
>

60 
	~<”ºo.h
>

62 #ià
defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

63 
	~<sys/’dŸn.h
>

64 #–ià
defšed
(
__APPLE__
)

65 
	~<machše/’dŸn.h
>

67 
	~<’dŸn.h
>

72 
	~<¡ršg.h
>

73 
	~<¡dlib.h
>

74 
	~<¡dio.h
>

75 
	~<time.h
>

82 #ià
defšed
(
__BYTE_ORDER
è&& defšed(
__BIG_ENDIAN
) && __BYTE_ORDER == __BIG_ENDIAN

83 
	#POLARSSL_HTONS
(
n
èÒ)

	)

85 
	#POLARSSL_HTONS
(
n
è((((()Òè& 0xFF)è<< 8è| ((()Òè& 0xFF00è>> 8))

	)

88 
Ãt_htÚs
(
n
);

89 
	#Ãt_htÚs
(
n
è
	`POLARSSL_HTONS
Ò)

	)

94 
	$Ãt_cÚÃù
Ğ*
fd
, cÚ¡ *
ho¡
, 
pÜt
 )

96 
sockaddr_š
 
£rv”_addr
;

97 
ho¡’t
 *
£rv”_ho¡
;

99 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

100 
WSADATA
 
w§D©a
;

102 ifĞ
w§_š™_dÚe
 == 0 )

104 ifĞ
	`WSAS¹up
Ğ
	`MAKEWORD
(2,0), &
w§D©a
 ) =ğ
SOCKET_ERROR
 )

105 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

107 
w§_š™_dÚe
 = 1;

110 
	`sigÇl
Ğ
SIGPIPE
, 
SIG_IGN
 );

113 ifĞĞ
£rv”_ho¡
 = 
	`g‘ho¡byÇme
Ğ
ho¡
 ) ) =ğ
NULL
 )

114 Ğ
POLARSSL_ERR_NET_UNKNOWN_HOST
 );

116 ifĞĞ*
fd
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_IP
 ) ) < 0 )

117 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

119 
	`memıy
Ğ(*è&
£rv”_addr
.
sš_addr
,

120 (*è
£rv”_ho¡
->
h_addr
,

121 
£rv”_ho¡
->
h_Ëngth
 );

123 
£rv”_addr
.
sš_çmy
 = 
AF_INET
;

124 
£rv”_addr
.
sš_pÜt
 = 
	`Ãt_htÚs
Ğ
pÜt
 );

126 ifĞ
	`cÚÃù
Ğ*
fd
, (
sockaddr
 *è&
£rv”_addr
,

127 Ğ
£rv”_addr
 ) ) < 0 )

129 
	`şo£
Ğ*
fd
 );

130 Ğ
POLARSSL_ERR_NET_CONNECT_FAILED
 );

134 
	}
}

139 
	$Ãt_bšd
Ğ*
fd
, cÚ¡ *
bšd_
, 
pÜt
 )

141 
n
, 
c
[4];

142 
sockaddr_š
 
£rv”_addr
;

144 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

145 
WSADATA
 
w§D©a
;

147 ifĞ
w§_š™_dÚe
 == 0 )

149 ifĞ
	`WSAS¹up
Ğ
	`MAKEWORD
(2,0), &
w§D©a
 ) =ğ
SOCKET_ERROR
 )

150 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

152 
w§_š™_dÚe
 = 1;

155 
	`sigÇl
Ğ
SIGPIPE
, 
SIG_IGN
 );

158 ifĞĞ*
fd
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_IP
 ) ) < 0 )

159 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

161 
n
 = 1;

162 
	`£tsockİt
Ğ*
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

163 (cÚ¡ *è&
n
, (‚ ) );

165 
£rv”_addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

166 
£rv”_addr
.
sš_çmy
 = 
AF_INET
;

167 
£rv”_addr
.
sš_pÜt
 = 
	`Ãt_htÚs
Ğ
pÜt
 );

169 ifĞ
bšd_
 !ğ
NULL
 )

171 
	`mem£t
Ğ
c
, 0, ( c ) );

172 
	`ssÿnf
Ğ
bšd_
, "%d.%d.%d.%d", &
c
[0], &c[1], &c[2], &c[3] );

174  
n
 = 0;‚ < 4;‚++ )

175 ifĞ
c
[
n
] < 0 || c[n] > 255 )

178 ifĞ
n
 == 4 )

179 
£rv”_addr
.
sš_addr
.
s_addr
 =

180 Ğ(è
c
[0] << 24 ) |

181 Ğ(è
c
[1] << 16 ) |

182 Ğ(è
c
[2] << 8 ) |

183 Ğ(è
c
[3] );

186 ifĞ
	`bšd
Ğ*
fd
, (
sockaddr
 *è&
£rv”_addr
,

187 Ğ
£rv”_addr
 ) ) < 0 )

189 
	`şo£
Ğ*
fd
 );

190 Ğ
POLARSSL_ERR_NET_BIND_FAILED
 );

193 ifĞ
	`li¡’
Ğ*
fd
, 10 ) != 0 )

195 
	`şo£
Ğ*
fd
 );

196 Ğ
POLARSSL_ERR_NET_LISTEN_FAILED
 );

200 
	}
}

205 
	$Ãt_is_blockšg
( )

207 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

208 Ğ
	`WSAG‘La¡E¼Ü
(è=ğ
WSAEWOULDBLOCK
 );

210  
”ºo
 )

212 #ià
defšed
 
EAGAIN


213 
EAGAIN
:

215 #ià
defšed
 
EWOULDBLOCK
 && EWOULDBLOCK !ğ
EAGAIN


216 
EWOULDBLOCK
:

222 
	}
}

227 
	$Ãt_acû±
Ğ
bšd_fd
, *
ş›Á_fd
, *
ş›Á_
 )

229 
sockaddr_š
 
ş›Á_addr
;

231 #ià
	`defšed
(
__sockËn_t_defšed
è|| defšed(
_SOCKLEN_T
)

232 
sockËn_t
 
n
 = (sockËn_tèĞ
ş›Á_addr
 );

234 
n
 = (èĞ
ş›Á_addr
 );

237 *
ş›Á_fd
 = 
	`acû±
Ğ
bšd_fd
, (
sockaddr
 *)

238 &
ş›Á_addr
, &
n
 );

240 ifĞ*
ş›Á_fd
 < 0 )

242 ifĞ
	`Ãt_is_blockšg
() != 0 )

243 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

245 Ğ
POLARSSL_ERR_NET_ACCEPT_FAILED
 );

248 ifĞ
ş›Á_
 !ğ
NULL
 )

249 
	`memıy
Ğ
ş›Á_
, &
ş›Á_addr
.
sš_addr
.
s_addr
,

250 Ğ
ş›Á_addr
.
sš_addr
.
s_addr
 ) );

253 
	}
}

258 
	$Ãt_£t_block
Ğ
fd
 )

260 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

261 
n
 = 0;

262 Ğ
	`ioùlsock‘
Ğ
fd
, 
FIONBIO
, &
n
 ) );

264 Ğ
	`fú
Ğ
fd
, 
F_SETFL
, fúĞfd, 
F_GETFL
 ) & ~
O_NONBLOCK
 ) );

266 
	}
}

268 
	$Ãt_£t_nÚblock
Ğ
fd
 )

270 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

271 
n
 = 1;

272 Ğ
	`ioùlsock‘
Ğ
fd
, 
FIONBIO
, &
n
 ) );

274 Ğ
	`fú
Ğ
fd
, 
F_SETFL
, fúĞfd, 
F_GETFL
 ) | 
O_NONBLOCK
 ) );

276 
	}
}

281 
	$Ãt_u¦“p
Ğ
u£c
 )

283 
timev®
 
tv
;

284 
tv
.
tv_£c
 = 0;

285 
tv
.
tv_u£c
 = 
u£c
;

286 
	`£Ëù
Ğ0, 
NULL
, NULL, NULL, &
tv
 );

287 
	}
}

292 
	$Ãt_»cv
Ğ*
ùx
, *
buf
, 
Ën
 )

294 
»t
 = 
	`»ad
Ğ*((*è
ùx
), 
buf
, 
Ën
 );

296 ifĞ
Ën
 > 0 && 
»t
 == 0 )

297 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

299 ifĞ
»t
 < 0 )

301 ifĞ
	`Ãt_is_blockšg
() != 0 )

302 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

304 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

305 ifĞ
	`WSAG‘La¡E¼Ü
(è=ğ
WSAECONNRESET
 )

306 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

308 ifĞ
”ºo
 =ğ
EPIPE
 ||ƒ¼nØ=ğ
ECONNRESET
 )

309 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

311 ifĞ
”ºo
 =ğ
EINTR
 )

312 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

315 Ğ
POLARSSL_ERR_NET_RECV_FAILED
 );

318 Ğ
»t
 );

319 
	}
}

324 
	$Ãt_£nd
Ğ*
ùx
, *
buf
, 
Ën
 )

326 
»t
 = 
	`wr™e
Ğ*((*è
ùx
), 
buf
, 
Ën
 );

328 ifĞ
»t
 < 0 )

330 ifĞ
	`Ãt_is_blockšg
() != 0 )

331 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

333 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

334 ifĞ
	`WSAG‘La¡E¼Ü
(è=ğ
WSAECONNRESET
 )

335 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

337 ifĞ
”ºo
 =ğ
EPIPE
 ||ƒ¼nØ=ğ
ECONNRESET
 )

338 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

340 ifĞ
”ºo
 =ğ
EINTR
 )

341 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

344 Ğ
POLARSSL_ERR_NET_SEND_FAILED
 );

347 Ğ
»t
 );

348 
	}
}

353 
	$Ãt_şo£
Ğ
fd
 )

355 
	`shutdown
Ğ
fd
, 2 );

356 
	`şo£
Ğ
fd
 );

357 
	}
}

	@src/polarssl/net.h

25 #iâdeà
POLARSSL_NET_H


26 
	#POLARSSL_NET_H


	)

28 
	#POLARSSL_ERR_NET_UNKNOWN_HOST
 -0x0F00

	)

29 
	#POLARSSL_ERR_NET_SOCKET_FAILED
 -0x0F10

	)

30 
	#POLARSSL_ERR_NET_CONNECT_FAILED
 -0x0F20

	)

31 
	#POLARSSL_ERR_NET_BIND_FAILED
 -0x0F30

	)

32 
	#POLARSSL_ERR_NET_LISTEN_FAILED
 -0x0F40

	)

33 
	#POLARSSL_ERR_NET_ACCEPT_FAILED
 -0x0F50

	)

34 
	#POLARSSL_ERR_NET_RECV_FAILED
 -0x0F60

	)

35 
	#POLARSSL_ERR_NET_SEND_FAILED
 -0x0F70

	)

36 
	#POLARSSL_ERR_NET_CONN_RESET
 -0x0F80

	)

37 
	#POLARSSL_ERR_NET_TRY_AGAIN
 -0x0F90

	)

39 #ifdeà
__ılu¥lus


55 
Ãt_cÚÃù
Ğ*
fd
, cÚ¡ *
ho¡
, 
pÜt
 );

70 
Ãt_bšd
Ğ*
fd
, cÚ¡ *
bšd_
, 
pÜt
 );

83 
Ãt_acû±
Ğ
bšd_fd
, *
ş›Á_fd
, *
ş›Á_
 );

92 
Ãt_£t_block
Ğ
fd
 );

101 
Ãt_£t_nÚblock
Ğ
fd
 );

111 
Ãt_u¦“p
Ğ
u£c
 );

125 
Ãt_»cv
Ğ*
ùx
, *
buf
, 
Ën
 );

139 
Ãt_£nd
Ğ*
ùx
, *
buf
, 
Ën
 );

146 
Ãt_şo£
Ğ
fd
 );

148 #ifdeà
__ılu¥lus


	@src/polarssl/openssl.h

28 #iâdeà
POLARSSL_OPENSSL_H


29 
	#POLARSSL_OPENSSL_H


	)

31 
	~"pŞ¬s¦/«s.h
"

32 
	~"pŞ¬s¦/md5.h
"

33 
	~"pŞ¬s¦/r§.h
"

34 
	~"pŞ¬s¦/sha1.h
"

36 
	#AES_SIZE
 16

	)

37 
	#AES_BLOCK_SIZE
 16

	)

38 
	#AES_KEY
 
«s_cÚ‹xt


	)

39 
	#MD5_CTX
 
md5_cÚ‹xt


	)

40 
	#SHA_CTX
 
sha1_cÚ‹xt


	)

42 
	#SHA1_In™
Ğ
CTX
 ) \

43 
	`sha1_¡¬ts
Ğ(
CTX
è)

	)

44 
	#SHA1_Upd©e
Ğ
CTX
, 
BUF
, 
LEN
 ) \

45 
	`sha1_upd©e
Ğ(
CTX
), (*)(
BUF
), (
LEN
è)

	)

46 
	#SHA1_Fš®
Ğ
OUT
, 
CTX
 ) \

47 
	`sha1_fšish
Ğ(
CTX
), (
OUT
è)

	)

49 
	#MD5_In™
Ğ
CTX
 ) \

50 
	`md5_¡¬ts
Ğ(
CTX
è)

	)

51 
	#MD5_Upd©e
Ğ
CTX
, 
BUF
, 
LEN
 ) \

52 
	`md5_upd©e
Ğ(
CTX
), (*)(
BUF
), (
LEN
è)

	)

53 
	#MD5_Fš®
Ğ
OUT
, 
CTX
 ) \

54 
	`md5_fšish
Ğ(
CTX
), (
OUT
è)

	)

56 
	#AES_£t_’üy±_key
Ğ
KEY
, 
KEYSIZE
, 
CTX
 ) \

57 
	`«s_£tkey_’c
Ğ(
CTX
), (
KEY
), (
KEYSIZE
è)

	)

58 
	#AES_£t_deüy±_key
Ğ
KEY
, 
KEYSIZE
, 
CTX
 ) \

59 
	`«s_£tkey_dec
Ğ(
CTX
), (
KEY
), (
KEYSIZE
è)

	)

60 
	#AES_cbc_’üy±
Ğ
INPUT
, 
OUTPUT
, 
LEN
, 
CTX
, 
IV
, 
MODE
 ) \

61 
	`«s_üy±_cbc
Ğ(
CTX
), (
MODE
), (
LEN
), (
IV
), (
INPUT
), (
OUTPUT
è)

	)

66 
šlše
 
	$__RSA_Pas¡hrough
Ğ*
ouut
, *
šput
, 
size
 )

68 
	`memıy
Ğ
ouut
, 
šput
, 
size
 );

69  
size
;

70 
	}
}

72 
šlše
 
r§_cÚ‹xt
* 
	$d2i_RSA_PUBKEY
Ğ*
ignÜe
, **
buåŒ
,

73 
Ën
 )

75 *
bufãr
 = *(**è
buåŒ
;

76 
r§_cÚ‹xt
 *
r§
;

86 ifĞ
ignÜe
 !ğ0 || ( 
Ën
 != 94 &&†en != 162 ) )

89 
r§
 = (
r§_cÚ‹xt
 *è
	`m®loc
ĞĞ
r§_r§
 ) );

90 ifĞ
r§
 =ğ
NULL
 )

93 
	`mem£t
Ğ
r§
, 0, Ğ
r§_cÚ‹xt
 ) );

95 ifĞĞ
Ën
 == 94 &&

96 
	`mpi_»ad_bš¬y
Ğ&
r§
->
N
, &
bufãr
[ 25], 64 ) == 0 &&

97 
	`mpi_»ad_bš¬y
Ğ&
r§
->
E
, &
bufãr
[ 91], 3 ) == 0 ) ||

98 Ğ
Ën
 == 162 &&

99 
	`mpi_»ad_bš¬y
Ğ&
r§
->
N
, &
bufãr
[ 29], 128 ) == 0 ) &&

100 
	`mpi_»ad_bš¬y
Ğ&
r§
->
E
, &
bufãr
[159], 3 ) == 0 )

105 
r§
->
Ën
 = ( 
	`mpi_msb
Ğ&r§->
N
 ) + 7 ) >> 3;

106 Ğ
r§
 );

110 
	`mem£t
Ğ
r§
, 0, Ğ
r§_cÚ‹xt
 ) );

111 
	`ä“
Ğ
r§
 );

114 
	}
}

116 
	#RSA
 
r§_cÚ‹xt


	)

117 
	#RSA_PKCS1_PADDING
 1

	)

118 
	#RSA_size
Ğ
CTX
 ) (CTX)->
Ën


	)

119 
	#RSA_ä“
Ğ
CTX
 ) 
	`r§_ä“
ĞCTX )

	)

120 
	#ERR_g‘_”rÜ
Ğè"ERR_g‘_”rÜ(ènÙ suµÜ‹d"

	)

121 
	#RSA_blšdšg_off
Ğ
IGNORE
 )

	)

123 
	#d2i_RSAPriv©eKey
Ğ
a
, 
b
, 
c
 ) 
Ãw
 
r§_cÚ‹xt


	)

125 
šlše
 
	$RSA_public_deüy±
 ( 
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { 
outsize
=size; ifĞ!
	`r§_pkcs1_deüy±
Ğkey, 
RSA_PUBLIC
, &outsize, iÅut, ouuˆèè outsize;  -1; 
	}
}

126 
šlše
 
	$RSA_´iv©e_deüy±
Ğ
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { 
outsize
=size; ifĞ!
	`r§_pkcs1_deüy±
Ğkey, 
RSA_PRIVATE
, &outsize, iÅut, ouuˆèè outsize;  -1; 
	}
}

127 
šlše
 
	$RSA_public_’üy±
 ( 
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { ifĞ!
	`r§_pkcs1_’üy±
Ğkey, 
RSA_PUBLIC
, size, iÅut, ouuˆèè 
	`RSA_size
(key);  -1; 
	}
}

128 
šlše
 
	$RSA_´iv©e_’üy±
Ğ
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { ifĞ!
	`r§_pkcs1_’üy±
Ğkey, 
RSA_PRIVATE
, size, iÅut, ouuˆèè 
	`RSA_size
(key);  -1; 
	}
}

130 #ifdeà
__ılu¥lus


	@src/polarssl/padlock.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_PADLOCK_C
)

36 
	~"pŞ¬s¦/«s.h
"

37 
	~"pŞ¬s¦/·dlock.h
"

39 #ià
defšed
(
POLARSSL_HAVE_X86
)

41 
	~<¡ršg.h
>

46 
	$·dlock_suµÜts
Ğ
ã©u»
 )

48 
æags
 = -1;

49 
ebx
, 
edx
;

51 ifĞ
æags
 == -1 )

53 
	`asm
( "movl %%ebx, %0 \n" \

64 : "=m" (
ebx
), "=m" (
edx
)

65 : "m" (
ebx
)

68 
æags
 = 
edx
;

71 Ğ
æags
 & 
ã©u»
 );

72 
	}
}

77 
	$·dlock_xüy±ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

78 
mode
,

79 cÚ¡ 
šput
[16],

80 
ouut
[16] )

82 
ebx
;

83 *
rk
;

84 *
blk
;

85 *
ù¾
;

86 
buf
[256];

88 
rk
 = 
ùx
->rk;

89 
blk
 = 
	`PADLOCK_ALIGN16
Ğ
buf
 );

90 
	`memıy
Ğ
blk
, 
šput
, 16 );

92 
ù¾
 = 
blk
 + 4;

93 *
ù¾
 = 0x80 | 
ùx
->
Ä
 | ( ( ctx->Ä + ( 
mode
^1 ) - 10 ) << 9 );

95 
	`asm
( "pushfl;…opfl \n" \

104 : "=m" (
ebx
)

105 : "m" (
ebx
), "m" (
ù¾
), "m" (
rk
), "m" (
blk
)

108 
	`memıy
Ğ
ouut
, 
blk
, 16 );

111 
	}
}

116 
	$·dlock_xüy±cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

117 
mode
,

118 
Ëngth
,

119 
iv
[16],

120 cÚ¡ *
šput
,

121 *
ouut
 )

123 
ebx
, 
couÁ
;

124 *
rk
;

125 *
iw
;

126 *
ù¾
;

127 
buf
[256];

129 ifĞĞ(è
šput
 & 15 ) != 0 ||

130 Ğ(è
ouut
 & 15 ) != 0 )

131 Ğ
POLARSSL_ERR_PADLOCK_DATA_MISALIGNED
 );

133 
rk
 = 
ùx
->rk;

134 
iw
 = 
	`PADLOCK_ALIGN16
Ğ
buf
 );

135 
	`memıy
Ğ
iw
, 
iv
, 16 );

137 
ù¾
 = 
iw
 + 4;

138 *
ù¾
 = 0x80 | 
ùx
->
Ä
 | ( ( ctx->Ä + (
mode
^1) - 10 ) << 9 );

140 
couÁ
 = (
Ëngth
 + 15) >> 4;

142 
	`asm
( "pushfl;…opfl \n" \

152 : "=m" (
ebx
)

153 : "m" (
ebx
), "m" (
couÁ
), "m" (
ù¾
),

154 "m" (
rk
), "m" (
šput
), "m" (
ouut
), "m" (
iw
)

157 
	`memıy
Ğ
iv
, 
iw
, 16 );

160 
	}
}

	@src/polarssl/padlock.h

25 #iâdeà
POLARSSL_PADLOCK_H


26 
	#POLARSSL_PADLOCK_H


	)

28 
	~"pŞ¬s¦/«s.h
"

30 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__i386__
)

32 #iâdeà
POLARSSL_HAVE_X86


33 
	#POLARSSL_HAVE_X86


	)

36 
	#PADLOCK_RNG
 0x000C

	)

37 
	#PADLOCK_ACE
 0x00C0

	)

38 
	#PADLOCK_PHE
 0x0C00

	)

39 
	#PADLOCK_PMM
 0x3000

	)

41 
	#PADLOCK_ALIGN16
(
x
è(*è(16 + ((èx & ~15))

	)

43 
	#POLARSSL_ERR_PADLOCK_DATA_MISALIGNED
 -0x08E0

	)

45 #ifdeà
__ılu¥lus


56 
·dlock_suµÜts
Ğ
ã©u»
 );

68 
·dlock_xüy±ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

69 
mode
,

70 cÚ¡ 
šput
[16],

71 
ouut
[16] );

85 
·dlock_xüy±cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

86 
mode
,

87 
Ëngth
,

88 
iv
[16],

89 cÚ¡ *
šput
,

90 *
ouut
 );

92 #ifdeà
__ılu¥lus


	@src/polarssl/rsa.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_RSA_C
)

36 
	~"pŞ¬s¦/r§.h
"

38 
	~<¡dlib.h
>

39 
	~<¡ršg.h
>

40 
	~<¡dio.h
>

45 
	$r§_š™
Ğ
r§_cÚ‹xt
 *
ùx
,

46 
·ddšg
,

47 
hash_id
 )

49 
	`mem£t
Ğ
ùx
, 0, Ğ
r§_cÚ‹xt
 ) );

51 
ùx
->
·ddšg
 =…adding;

52 
ùx
->
hash_id
 = hash_id;

53 
	}
}

55 #ià
defšed
(
POLARSSL_GENPRIME
)

60 
r§_g’_key
Ğ
r§_cÚ‹xt
 *
ùx
,

61 (*
f_ºg
)(*),

62 *
p_ºg
,

63 
nb™s
, 
expÚ’t
 )

65 
»t
;

66 
mpi
 
P1
, 
Q1
, 
H
, 
G
;

68 ifĞ
f_ºg
 =ğ
NULL
 || 
nb™s
 < 128 || 
expÚ’t
 < 3 )

69 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

71 
	`mpi_š™
Ğ&
P1
, &
Q1
, &
H
, &
G
, 
NULL
 );

77 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
ùx
->
E
, 
expÚ’t
 ) );

81 
	`MPI_CHK
Ğ
	`mpi_g’_´ime
Ğ&
ùx
->
P
, ( 
nb™s
 + 1 ) >> 1, 0,

82 
f_ºg
, 
p_ºg
 ) );

84 
	`MPI_CHK
Ğ
	`mpi_g’_´ime
Ğ&
ùx
->
Q
, ( 
nb™s
 + 1 ) >> 1, 0,

85 
f_ºg
, 
p_ºg
 ) );

87 ifĞ
	`mpi_cmp_mpi
Ğ&
ùx
->
P
, &ùx->
Q
 ) < 0 )

88 
	`mpi_sw­
Ğ&
ùx
->
P
, &ùx->
Q
 );

90 ifĞ
	`mpi_cmp_mpi
Ğ&
ùx
->
P
, &ùx->
Q
 ) == 0 )

93 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
ùx
->
N
, &ùx->
P
, &ùx->
Q
 ) );

94 ifĞ
	`mpi_msb
Ğ&
ùx
->
N
 ) !ğ
nb™s
 )

97 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
P1
, &
ùx
->
P
, 1 ) );

98 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
Q1
, &
ùx
->
Q
, 1 ) );

99 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
H
, &
P1
, &
Q1
 ) );

100 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G
, &
ùx
->
E
, &
H
 ) );

102  
	`mpi_cmp_št
Ğ&
G
, 1 ) != 0 );

110 
	`MPI_CHK
Ğ
	`mpi_šv_mod
Ğ&
ùx
->
D
 , &ùx->
E
, &
H
 ) );

111 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
ùx
->
DP
, &ùx->
D
, &
P1
 ) );

112 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
ùx
->
DQ
, &ùx->
D
, &
Q1
 ) );

113 
	`MPI_CHK
Ğ
	`mpi_šv_mod
Ğ&
ùx
->
QP
, &ùx->
Q
, &ùx->
P
 ) );

115 
ùx
->
Ën
 = ( 
	`mpi_msb
Ğ&ùx->
N
 ) + 7 ) >> 3;

117 
ş—nup
:

119 
	`mpi_ä“
Ğ&
G
, &
H
, &
Q1
, &
P1
, 
NULL
 );

121 ifĞ
»t
 != 0 )

123 
	`r§_ä“
Ğ
ùx
 );

124 Ğ
POLARSSL_ERR_RSA_KEY_GEN_FAILED
 | 
»t
 );

128 
	}
}

135 
	$r§_check_pubkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 )

137 ifĞ!
ùx
->
N
.
p
 || !ùx->
E
.p )

138 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

140 ifĞĞ
ùx
->
N
.
p
[0] & 1 ) == 0 ||

141 Ğ
ùx
->
E
.
p
[0] & 1 ) == 0 )

142 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

144 ifĞ
	`mpi_msb
Ğ&
ùx
->
N
 ) < 128 ||

145 
	`mpi_msb
Ğ&
ùx
->
N
 ) > 4096 )

146 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

148 ifĞ
	`mpi_msb
Ğ&
ùx
->
E
 ) < 2 ||

149 
	`mpi_msb
Ğ&
ùx
->
E
 ) > 64 )

150 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

153 
	}
}

158 
	$r§_check_´ivkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 )

160 
»t
;

161 
mpi
 
PQ
, 
DE
, 
P1
, 
Q1
, 
H
, 
I
, 
G
, 
G2
, 
L1
, 
L2
;

163 ifĞĞ
»t
 = 
	`r§_check_pubkey
Ğ
ùx
 ) ) != 0 )

164 Ğ
»t
 );

166 ifĞ!
ùx
->
P
.
p
 || !ùx->
Q
.°|| !ùx->
D
.p )

167 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

169 
	`mpi_š™
Ğ&
PQ
, &
DE
, &
P1
, &
Q1
, &
H
, &
I
, &
G
, &
G2
, &
L1
, &
L2
, 
NULL
 );

171 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
PQ
, &
ùx
->
P
, &ùx->
Q
 ) );

172 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
DE
, &
ùx
->
D
, &ùx->
E
 ) );

173 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
P1
, &
ùx
->
P
, 1 ) );

174 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
Q1
, &
ùx
->
Q
, 1 ) );

175 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
H
, &
P1
, &
Q1
 ) );

176 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G
, &
ùx
->
E
, &
H
 ) );

178 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G2
, &
P1
, &
Q1
 ) );

179 
	`MPI_CHK
Ğ
	`mpi_div_mpi
Ğ&
L1
, &
L2
, &
H
, &
G2
 ) );

180 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
I
, &
DE
, &
L1
 ) );

185 ifĞ
	`mpi_cmp_mpi
Ğ&
PQ
, &
ùx
->
N
 ) == 0 &&

186 
	`mpi_cmp_št
Ğ&
L2
, 0 ) == 0 &&

187 
	`mpi_cmp_št
Ğ&
I
, 1 ) == 0 &&

188 
	`mpi_cmp_št
Ğ&
G
, 1 ) == 0 )

190 
	`mpi_ä“
Ğ&
G
, &
I
, &
H
, &
Q1
, &
P1
, &
DE
, &
PQ
, &
G2
, &
L1
, &
L2
, 
NULL
 );

195 
ş—nup
:

197 
	`mpi_ä“
Ğ&
G
, &
I
, &
H
, &
Q1
, &
P1
, &
DE
, &
PQ
, &
G2
, &
L1
, &
L2
, 
NULL
 );

198 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 | 
»t
 );

199 
	}
}

204 
	$r§_public
Ğ
r§_cÚ‹xt
 *
ùx
,

205 cÚ¡ *
šput
,

206 *
ouut
 )

208 
»t
, 
Ş’
;

209 
mpi
 
T
;

211 
	`mpi_š™
Ğ&
T
, 
NULL
 );

213 
	`MPI_CHK
Ğ
	`mpi_»ad_bš¬y
Ğ&
T
, 
šput
, 
ùx
->
Ën
 ) );

215 ifĞ
	`mpi_cmp_mpi
Ğ&
T
, &
ùx
->
N
 ) >= 0 )

217 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

218 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

221 
Ş’
 = 
ùx
->
Ën
;

222 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T
, &T, &
ùx
->
E
, &ùx->
N
, &ùx->
RN
 ) );

223 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
T
, 
ouut
, 
Ş’
 ) );

225 
ş—nup
:

227 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

229 ifĞ
»t
 != 0 )

230 Ğ
POLARSSL_ERR_RSA_PUBLIC_FAILED
 | 
»t
 );

233 
	}
}

238 
	$r§_´iv©e
Ğ
r§_cÚ‹xt
 *
ùx
,

239 cÚ¡ *
šput
,

240 *
ouut
 )

242 
»t
, 
Ş’
;

243 
mpi
 
T
, 
T1
, 
T2
;

245 
	`mpi_š™
Ğ&
T
, &
T1
, &
T2
, 
NULL
 );

247 
	`MPI_CHK
Ğ
	`mpi_»ad_bš¬y
Ğ&
T
, 
šput
, 
ùx
->
Ën
 ) );

249 ifĞ
	`mpi_cmp_mpi
Ğ&
T
, &
ùx
->
N
 ) >= 0 )

251 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

252 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

256 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T
, &T, &
ùx
->
D
, &ùx->
N
, &ùx->
RN
 ) );

264 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T1
, &
T
, &
ùx
->
DP
, &ùx->
P
, &ùx->
RP
 ) );

265 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T2
, &
T
, &
ùx
->
DQ
, &ùx->
Q
, &ùx->
RQ
 ) );

270 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
T
, &
T1
, &
T2
 ) );

271 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
T1
, &
T
, &
ùx
->
QP
 ) );

272 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
T
, &
T1
, &
ùx
->
P
 ) );

277 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
T1
, &
T
, &
ùx
->
Q
 ) );

278 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
T
, &
T2
, &
T1
 ) );

281 
Ş’
 = 
ùx
->
Ën
;

282 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
T
, 
ouut
, 
Ş’
 ) );

284 
ş—nup
:

286 
	`mpi_ä“
Ğ&
T
, &
T1
, &
T2
, 
NULL
 );

288 ifĞ
»t
 != 0 )

289 Ğ
POLARSSL_ERR_RSA_PRIVATE_FAILED
 | 
»t
 );

292 
	}
}

297 
r§_pkcs1_’üy±
Ğ
r§_cÚ‹xt
 *
ùx
,

298 (*
f_ºg
)(*),

299 *
p_ºg
,

300 
mode
, 
’
,

301 cÚ¡ *
šput
,

302 *
ouut
 )

304 
nb_·d
, 
Ş’
;

305 *
p
 = 
ouut
;

307 
Ş’
 = 
ùx
->
Ën
;

309  
ùx
->
·ddšg
 )

311 
RSA_PKCS_V15
:

313 ifĞ
’
 < 0 || 
Ş’
 < iËÀ+ 11 || 
f_ºg
 =ğ
NULL
 )

314 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

316 
nb_·d
 = 
Ş’
 - 3 - 
’
;

318 *
p
++ = 0;

319 *
p
++ = 
RSA_CRYPT
;

321  
nb_·d
-- > 0 )

323 
ºg_dl
 = 100;

326 *
p
 = (è
	`f_ºg
Ğ
p_ºg
 );

327 }  *
p
 =ğ0 && --
ºg_dl
 );

331 ifĞ
ºg_dl
 == 0 )

332  
POLARSSL_ERR_RSA_RNG_FAILED
;

334 
p
++;

336 *
p
++ = 0;

337 
	`memıy
Ğ
p
, 
šput
, 
’
 );

342 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

345 ĞĞ
mode
 =ğ
RSA_PUBLIC
 )

346 ? 
	`r§_public
Ğ
ùx
, 
ouut
, output )

347 : 
	`r§_´iv©e
Ğ
ùx
, 
ouut
, output ) );

348 
	}
}

353 
	$r§_pkcs1_deüy±
Ğ
r§_cÚ‹xt
 *
ùx
,

354 
mode
, *
Ş’
,

355 cÚ¡ *
šput
,

356 *
ouut
,

357 
ouut_max_Ën
)

359 
»t
, 
’
;

360 *
p
;

361 
buf
[1024];

363 
’
 = 
ùx
->
Ën
;

365 ifĞ
’
 < 16 || iËÀ> (èĞ
buf
 ) )

366 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

368 
»t
 = ( 
mode
 =ğ
RSA_PUBLIC
 )

369 ? 
	`r§_public
Ğ
ùx
, 
šput
, 
buf
 )

370 : 
	`r§_´iv©e
Ğ
ùx
, 
šput
, 
buf
 );

372 ifĞ
»t
 != 0 )

373 Ğ
»t
 );

375 
p
 = 
buf
;

377  
ùx
->
·ddšg
 )

379 
RSA_PKCS_V15
:

381 ifĞ*
p
++ !ğ0 || *p++ !ğ
RSA_CRYPT
 )

382 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

384  *
p
 != 0 )

386 ifĞ
p
 >ğ
buf
 + 
’
 - 1 )

387 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

388 
p
++;

390 
p
++;

395 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

398 ià(
’
 - ()(
p
 - 
buf
è> 
ouut_max_Ën
)

399 Ğ
POLARSSL_ERR_RSA_OUTPUT_TOO_LARGE
 );

401 *
Ş’
 = 
’
 - ()(
p
 - 
buf
);

402 
	`memıy
Ğ
ouut
, 
p
, *
Ş’
 );

405 
	}
}

410 
	$r§_pkcs1_sign
Ğ
r§_cÚ‹xt
 *
ùx
,

411 
mode
,

412 
hash_id
,

413 
hashËn
,

414 cÚ¡ *
hash
,

415 *
sig
 )

417 
nb_·d
, 
Ş’
;

418 *
p
 = 
sig
;

420 
Ş’
 = 
ùx
->
Ën
;

422  
ùx
->
·ddšg
 )

424 
RSA_PKCS_V15
:

426  
hash_id
 )

428 
SIG_RSA_RAW
:

429 
nb_·d
 = 
Ş’
 - 3 - 
hashËn
;

432 
SIG_RSA_MD2
:

433 
SIG_RSA_MD4
:

434 
SIG_RSA_MD5
:

435 
nb_·d
 = 
Ş’
 - 3 - 34;

438 
SIG_RSA_SHA1
:

439 
nb_·d
 = 
Ş’
 - 3 - 35;

442 
SIG_RSA_SHA224
:

443 
nb_·d
 = 
Ş’
 - 3 - 47;

446 
SIG_RSA_SHA256
:

447 
nb_·d
 = 
Ş’
 - 3 - 51;

450 
SIG_RSA_SHA384
:

451 
nb_·d
 = 
Ş’
 - 3 - 67;

454 
SIG_RSA_SHA512
:

455 
nb_·d
 = 
Ş’
 - 3 - 83;

460 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

463 ifĞ
nb_·d
 < 8 )

464 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

466 *
p
++ = 0;

467 *
p
++ = 
RSA_SIGN
;

468 
	`mem£t
Ğ
p
, 0xFF, 
nb_·d
 );

469 
p
 +ğ
nb_·d
;

470 *
p
++ = 0;

475 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

478  
hash_id
 )

480 
SIG_RSA_RAW
:

481 
	`memıy
Ğ
p
, 
hash
, 
hashËn
 );

484 
SIG_RSA_MD2
:

485 
	`memıy
Ğ
p
, 
ASN1_HASH_MDX
, 18 );

486 
	`memıy
Ğ
p
 + 18, 
hash
, 16 );

487 
p
[13] = 2; ;

489 
SIG_RSA_MD4
:

490 
	`memıy
Ğ
p
, 
ASN1_HASH_MDX
, 18 );

491 
	`memıy
Ğ
p
 + 18, 
hash
, 16 );

492 
p
[13] = 4; ;

494 
SIG_RSA_MD5
:

495 
	`memıy
Ğ
p
, 
ASN1_HASH_MDX
, 18 );

496 
	`memıy
Ğ
p
 + 18, 
hash
, 16 );

497 
p
[13] = 5; ;

499 
SIG_RSA_SHA1
:

500 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA1
, 15 );

501 
	`memıy
Ğ
p
 + 15, 
hash
, 20 );

504 
SIG_RSA_SHA224
:

505 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

506 
	`memıy
Ğ
p
 + 19, 
hash
, 28 );

507 
p
[1] += 28;…[14] = 4;…[18] += 28; ;

509 
SIG_RSA_SHA256
:

510 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

511 
	`memıy
Ğ
p
 + 19, 
hash
, 32 );

512 
p
[1] += 32;…[14] = 1;…[18] += 32; ;

514 
SIG_RSA_SHA384
:

515 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

516 
	`memıy
Ğ
p
 + 19, 
hash
, 48 );

517 
p
[1] += 48;…[14] = 2;…[18] += 48; ;

519 
SIG_RSA_SHA512
:

520 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

521 
	`memıy
Ğ
p
 + 19, 
hash
, 64 );

522 
p
[1] += 64;…[14] = 3;…[18] += 64; ;

525 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

528 ĞĞ
mode
 =ğ
RSA_PUBLIC
 )

529 ? 
	`r§_public
Ğ
ùx
, 
sig
, sig )

530 : 
	`r§_´iv©e
Ğ
ùx
, 
sig
, sig ) );

531 
	}
}

536 
	$r§_pkcs1_v”ify
Ğ
r§_cÚ‹xt
 *
ùx
,

537 
mode
,

538 
hash_id
,

539 
hashËn
,

540 cÚ¡ *
hash
,

541 *
sig
 )

543 
»t
, 
Ën
, 
sigËn
;

544 *
p
, 
c
;

545 
buf
[1024];

547 
sigËn
 = 
ùx
->
Ën
;

549 ifĞ
sigËn
 < 16 || sigËÀ> (èĞ
buf
 ) )

550 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

552 
»t
 = ( 
mode
 =ğ
RSA_PUBLIC
 )

553 ? 
	`r§_public
Ğ
ùx
, 
sig
, 
buf
 )

554 : 
	`r§_´iv©e
Ğ
ùx
, 
sig
, 
buf
 );

556 ifĞ
»t
 != 0 )

557 Ğ
»t
 );

559 
p
 = 
buf
;

561  
ùx
->
·ddšg
 )

563 
RSA_PKCS_V15
:

565 ifĞ*
p
++ !ğ0 || *p++ !ğ
RSA_SIGN
 )

566 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

568  *
p
 != 0 )

570 ifĞ
p
 >ğ
buf
 + 
sigËn
 - 1 || *p != 0xFF )

571 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

572 
p
++;

574 
p
++;

579 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

582 
Ën
 = 
sigËn
 - ()Ğ
p
 - 
buf
 );

584 ifĞ
Ën
 == 34 )

586 
c
 = 
p
[13];

587 
p
[13] = 0;

589 ifĞ
	`memcmp
Ğ
p
, 
ASN1_HASH_MDX
, 18 ) != 0 )

590 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

592 ifĞĞ
c
 =ğ2 && 
hash_id
 =ğ
SIG_RSA_MD2
 ) ||

593 Ğ
c
 =ğ4 && 
hash_id
 =ğ
SIG_RSA_MD4
 ) ||

594 Ğ
c
 =ğ5 && 
hash_id
 =ğ
SIG_RSA_MD5
 ) )

596 ifĞ
	`memcmp
Ğ
p
 + 18, 
hash
, 16 ) == 0 )

599 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

603 ifĞ
Ën
 =ğ35 && 
hash_id
 =ğ
SIG_RSA_SHA1
 )

605 ifĞ
	`memcmp
Ğ
p
, 
ASN1_HASH_SHA1
, 15 ) == 0 &&

606 
	`memcmp
Ğ
p
 + 15, 
hash
, 20 ) == 0 )

609 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

611 ifĞĞ
Ën
 =ğ19 + 28 && 
p
[14] =ğ4 && 
hash_id
 =ğ
SIG_RSA_SHA224
 ) ||

612 Ğ
Ën
 =ğ19 + 32 && 
p
[14] =ğ1 && 
hash_id
 =ğ
SIG_RSA_SHA256
 ) ||

613 Ğ
Ën
 =ğ19 + 48 && 
p
[14] =ğ2 && 
hash_id
 =ğ
SIG_RSA_SHA384
 ) ||

614 Ğ
Ën
 =ğ19 + 64 && 
p
[14] =ğ3 && 
hash_id
 =ğ
SIG_RSA_SHA512
 ) )

616 
c
 = 
p
[1] - 17;

617 
p
[1] = 17;

618 
p
[14] = 0;

620 ifĞ
p
[18] =ğ
c
 &&

621 
	`memcmp
Ğ
p
, 
ASN1_HASH_SHA2X
, 18 ) == 0 &&

622 
	`memcmp
Ğ
p
 + 19, 
hash
, 
c
 ) == 0 )

625 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

628 ifĞ
Ën
 =ğ
hashËn
 && 
hash_id
 =ğ
SIG_RSA_RAW
 )

630 ifĞ
	`memcmp
Ğ
p
, 
hash
, 
hashËn
 ) == 0 )

633 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

636 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

637 
	}
}

642 
	$r§_ä“
Ğ
r§_cÚ‹xt
 *
ùx
 )

644 
	`mpi_ä“
Ğ&
ùx
->
RQ
, &ùx->
RP
, &ùx->
RN
,

645 &
ùx
->
QP
, &ùx->
DQ
, &ùx->
DP
,

646 &
ùx
->
Q
, &ùx->
P
, &ùx->
D
,

647 &
ùx
->
E
, &ùx->
N
, 
NULL
 );

648 
	}
}

650 #ià
defšed
(
POLARSSL_SELF_TEST
)

652 
	~"pŞ¬s¦/sha1.h
"

657 
	#KEY_LEN
 128

	)

659 
	#RSA_N
 "9292758453063D803DD603D5E777D788" \

666 "5E94BB77B07507233A0BC7BAC8F90F79"

	)

668 
	#RSA_E
 "10001"

	)

670 
	#RSA_D
 "24BF6185468786FDD303083D25E64EFC" \

677 "071513A1E85B5DFA031F21ECAE91A34D"

	)

679 
	#RSA_P
 "C36D0EB7FCD285223CFB5AABA5BDA3D8" \

682 "C3D9E75E1EFC42488BB4F1D13AC30A57"

	)

684 
	#RSA_Q
 "C000DF51A7C77AE8D7C7370C1FF55B69" \

687 "8452DD96A9A5EA5D9DCA68DA636032AF"

	)

689 
	#RSA_DP
 "C1ACF567564274FB07A0BBAD5D26E298" \

692 "3CC559CD27BC2D1CA488811730BB5725"

	)

694 
	#RSA_DQ
 "4959CBF6F8FEF750AEE6977C155579C7" \

697 "407A1BD76C164B93DA2D32A383E58357"

	)

699 
	#RSA_QP
 "9AE7FBC99546432DF71896FC239EADAE" \

702 "A74206CEC169D74BF5A8C50D6F48EA08"

	)

704 
	#PT_LEN
 24

	)

705 
	#RSA_PT
 "\xAA\xBB\xCC\x03\x02\x01\x00\xFF\xFF\xFF\xFF\xFF" \

706 "\x11\x22\x33\x0A\x0B\x0C\xCC\xDD\xDD\xDD\xDD\xDD"

	)

708 
	$my¿nd
Ğ*
ºg_¡©e
 )

710 ifĞ
ºg_¡©e
 !ğ
NULL
 )

711 
ºg_¡©e
 = 
NULL
;

713 Ğ
	`¿nd
() );

714 
	}
}

719 
	$r§_£lf_‹¡
Ğ
v”bo£
 )

721 
Ën
;

722 
r§_cÚ‹xt
 
r§
;

723 
sha1sum
[20];

724 
r§_¶aš‹xt
[
PT_LEN
];

725 
r§_deüy±ed
[
PT_LEN
];

726 
r§_ch”‹xt
[
KEY_LEN
];

728 
	`r§_š™
Ğ&
r§
, 
RSA_PKCS_V15
, 0 );

730 
r§
.
Ën
 = 
KEY_LEN
;

731 
	`mpi_»ad_¡ršg
Ğ&
r§
.
N
 , 16, 
RSA_N
 );

732 
	`mpi_»ad_¡ršg
Ğ&
r§
.
E
 , 16, 
RSA_E
 );

733 
	`mpi_»ad_¡ršg
Ğ&
r§
.
D
 , 16, 
RSA_D
 );

734 
	`mpi_»ad_¡ršg
Ğ&
r§
.
P
 , 16, 
RSA_P
 );

735 
	`mpi_»ad_¡ršg
Ğ&
r§
.
Q
 , 16, 
RSA_Q
 );

736 
	`mpi_»ad_¡ršg
Ğ&
r§
.
DP
, 16, 
RSA_DP
 );

737 
	`mpi_»ad_¡ršg
Ğ&
r§
.
DQ
, 16, 
RSA_DQ
 );

738 
	`mpi_»ad_¡ršg
Ğ&
r§
.
QP
, 16, 
RSA_QP
 );

740 ifĞ
v”bo£
 != 0 )

741 
	`´štf
( " RSA key validation: " );

743 ifĞ
	`r§_check_pubkey
Ğ&
r§
 ) != 0 ||

744 
	`r§_check_´ivkey
Ğ&
r§
 ) != 0 )

746 ifĞ
v”bo£
 != 0 )

747 
	`´štf
( "failed\n" );

752 ifĞ
v”bo£
 != 0 )

753 
	`´štf
( "passed\n PKCS#1ƒncryption : " );

755 
	`memıy
Ğ
r§_¶aš‹xt
, 
RSA_PT
, 
PT_LEN
 );

757 ifĞ
	`r§_pkcs1_’üy±
Ğ&
r§
, &
my¿nd
, 
NULL
, 
RSA_PUBLIC
, 
PT_LEN
,

758 
r§_¶aš‹xt
, 
r§_ch”‹xt
 ) != 0 )

760 ifĞ
v”bo£
 != 0 )

761 
	`´štf
( "failed\n" );

766 ifĞ
v”bo£
 != 0 )

767 
	`´štf
( "passed\n PKCS#1 decryption : " );

769 ifĞ
	`r§_pkcs1_deüy±
Ğ&
r§
, 
RSA_PRIVATE
, &
Ën
,

770 
r§_ch”‹xt
, 
r§_deüy±ed
,

771 (
r§_deüy±ed
) ) != 0 )

773 ifĞ
v”bo£
 != 0 )

774 
	`´štf
( "failed\n" );

779 ifĞ
	`memcmp
Ğ
r§_deüy±ed
, 
r§_¶aš‹xt
, 
Ën
 ) != 0 )

781 ifĞ
v”bo£
 != 0 )

782 
	`´štf
( "failed\n" );

787 ifĞ
v”bo£
 != 0 )

788 
	`´štf
( "passed\n PKCS#1 data sign : " );

790 
	`sha1
Ğ
r§_¶aš‹xt
, 
PT_LEN
, 
sha1sum
 );

792 ifĞ
	`r§_pkcs1_sign
Ğ&
r§
, 
RSA_PRIVATE
, 
SIG_RSA_SHA1
, 20,

793 
sha1sum
, 
r§_ch”‹xt
 ) != 0 )

795 ifĞ
v”bo£
 != 0 )

796 
	`´štf
( "failed\n" );

801 ifĞ
v”bo£
 != 0 )

802 
	`´štf
( "passed\n PKCS#1 sig. verify: " );

804 ifĞ
	`r§_pkcs1_v”ify
Ğ&
r§
, 
RSA_PUBLIC
, 
SIG_RSA_SHA1
, 20,

805 
sha1sum
, 
r§_ch”‹xt
 ) != 0 )

807 ifĞ
v”bo£
 != 0 )

808 
	`´štf
( "failed\n" );

813 ifĞ
v”bo£
 != 0 )

814 
	`´štf
( "passed\n\n" );

816 
	`r§_ä“
Ğ&
r§
 );

819 
	}
}

	@src/polarssl/rsa.h

25 #iâdeà
POLARSSL_RSA_H


26 
	#POLARSSL_RSA_H


	)

28 
	~"pŞ¬s¦/bignum.h
"

33 
	#POLARSSL_ERR_RSA_BAD_INPUT_DATA
 -0x0400

	)

34 
	#POLARSSL_ERR_RSA_INVALID_PADDING
 -0x0410

	)

35 
	#POLARSSL_ERR_RSA_KEY_GEN_FAILED
 -0x0420

	)

36 
	#POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 -0x0430

	)

37 
	#POLARSSL_ERR_RSA_PUBLIC_FAILED
 -0x0440

	)

38 
	#POLARSSL_ERR_RSA_PRIVATE_FAILED
 -0x0450

	)

39 
	#POLARSSL_ERR_RSA_VERIFY_FAILED
 -0x0460

	)

40 
	#POLARSSL_ERR_RSA_OUTPUT_TOO_LARGE
 -0x0470

	)

41 
	#POLARSSL_ERR_RSA_RNG_FAILED
 -0x0480

	)

46 
	#SIG_RSA_RAW
 0

	)

47 
	#SIG_RSA_MD2
 2

	)

48 
	#SIG_RSA_MD4
 3

	)

49 
	#SIG_RSA_MD5
 4

	)

50 
	#SIG_RSA_SHA1
 5

	)

51 
	#SIG_RSA_SHA224
 14

	)

52 
	#SIG_RSA_SHA256
 11

	)

53 
	#SIG_RSA_SHA384
 12

	)

54 
	#SIG_RSA_SHA512
 13

	)

56 
	#RSA_PUBLIC
 0

	)

57 
	#RSA_PRIVATE
 1

	)

59 
	#RSA_PKCS_V15
 0

	)

60 
	#RSA_PKCS_V21
 1

	)

62 
	#RSA_SIGN
 1

	)

63 
	#RSA_CRYPT
 2

	)

65 
	#ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x30"

	)

66 
	#ASN1_STR_NULL
 "\x05"

	)

67 
	#ASN1_STR_OID
 "\x06"

	)

68 
	#ASN1_STR_OCTET_STRING
 "\x04"

	)

70 
	#OID_DIGEST_ALG_MDX
 "\x2A\x86\x48\x86\xF7\x0D\x02\x00"

	)

71 
	#OID_HASH_ALG_SHA1
 "\x2b\x0e\x03\x02\x1a"

	)

72 
	#OID_HASH_ALG_SHA2X
 "\x60\x86\x48\x01\x65\x03\x04\x02\x00"

	)

74 
	#OID_ISO_MEMBER_BODIES
 "\x2a"

	)

75 
	#OID_ISO_IDENTIFIED_ORG
 "\x2b"

	)

80 
	#OID_COUNTRY_US
 "\x86\x48"

	)

81 
	#OID_RSA_DATA_SECURITY
 "\x86\xf7\x0d"

	)

86 
	#OID_OIW_SECSIG_SHA1
 "\x0e\x03\x02\x1a"

	)

97 
	#ASN1_HASH_MDX
 \

99 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x20" \

100 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x0C" \

101 
ASN1_STR_OID
 "\x08" \

102 
OID_DIGEST_ALG_MDX
 \

103 
ASN1_STR_NULL
 "\x00" \

104 
ASN1_STR_OCTET_STRING
 "\x10" \

105 )

	)

107 
	#ASN1_HASH_SHA1
 \

108 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x21" \

109 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x09" \

110 
ASN1_STR_OID
 "\x05" \

111 
OID_HASH_ALG_SHA1
 \

112 
ASN1_STR_NULL
 "\x00" \

113 
ASN1_STR_OCTET_STRING
 "\x14"

	)

115 
	#ASN1_HASH_SHA2X
 \

116 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x11" \

117 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x0d" \

118 
ASN1_STR_OID
 "\x09" \

119 
OID_HASH_ALG_SHA2X
 \

120 
ASN1_STR_NULL
 "\x00" \

121 
ASN1_STR_OCTET_STRING
 "\x00"

	)

128 
	mv”
;

129 
	mËn
;

131 
mpi
 
	mN
;

132 
mpi
 
	mE
;

134 
mpi
 
	mD
;

135 
mpi
 
	mP
;

136 
mpi
 
	mQ
;

137 
mpi
 
	mDP
;

138 
mpi
 
	mDQ
;

139 
mpi
 
	mQP
;

141 
mpi
 
	mRN
;

142 
mpi
 
	mRP
;

143 
mpi
 
	mRQ
;

145 
	m·ddšg
;

146 
	mhash_id
;

148 
	tr§_cÚ‹xt
;

150 #ifdeà
__ılu¥lus


167 
r§_š™
Ğ
r§_cÚ‹xt
 *
ùx
,

168 
·ddšg
,

169 
hash_id
);

185 
r§_g’_key
Ğ
r§_cÚ‹xt
 *
ùx
,

186 (*
f_ºg
)(*),

187 *
p_ºg
,

188 
nb™s
, 
expÚ’t
 );

197 
r§_check_pubkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 );

206 
r§_check_´ivkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 );

224 
r§_public
Ğ
r§_cÚ‹xt
 *
ùx
,

225 cÚ¡ *
šput
,

226 *
ouut
 );

240 
r§_´iv©e
Ğ
r§_cÚ‹xt
 *
ùx
,

241 cÚ¡ *
šput
,

242 *
ouut
 );

260 
r§_pkcs1_’üy±
Ğ
r§_cÚ‹xt
 *
ùx
,

261 (*
f_ºg
)(*),

262 *
p_ºg
,

263 
mode
, 
’
,

264 cÚ¡ *
šput
,

265 *
ouut
 );

283 
r§_pkcs1_deüy±
Ğ
r§_cÚ‹xt
 *
ùx
,

284 
mode
, *
Ş’
,

285 cÚ¡ *
šput
,

286 *
ouut
,

287 
ouut_max_Ën
 );

305 
r§_pkcs1_sign
Ğ
r§_cÚ‹xt
 *
ùx
,

306 
mode
,

307 
hash_id
,

308 
hashËn
,

309 cÚ¡ *
hash
,

310 *
sig
 );

328 
r§_pkcs1_v”ify
Ğ
r§_cÚ‹xt
 *
ùx
,

329 
mode
,

330 
hash_id
,

331 
hashËn
,

332 cÚ¡ *
hash
,

333 *
sig
 );

340 
r§_ä“
Ğ
r§_cÚ‹xt
 *
ùx
 );

347 
r§_£lf_‹¡
Ğ
v”bo£
 );

349 #ifdeà
__ılu¥lus


	@src/polarssl/sha1.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_SHA1_C
)

35 
	~"pŞ¬s¦/sha1.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

66 
	$sha1_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
 )

68 
ùx
->
tÙ®
[0] = 0;

69 
ùx
->
tÙ®
[1] = 0;

71 
ùx
->
¡©e
[0] = 0x67452301;

72 
ùx
->
¡©e
[1] = 0xEFCDAB89;

73 
ùx
->
¡©e
[2] = 0x98BADCFE;

74 
ùx
->
¡©e
[3] = 0x10325476;

75 
ùx
->
¡©e
[4] = 0xC3D2E1F0;

76 
	}
}

78 
	$sha1_´oûss
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

80 
‹mp
, 
W
[16], 
A
, 
B
, 
C
, 
D
, 
E
;

82 
	`GET_ULONG_BE
Ğ
W
[ 0], 
d©a
, 0 );

83 
	`GET_ULONG_BE
Ğ
W
[ 1], 
d©a
, 4 );

84 
	`GET_ULONG_BE
Ğ
W
[ 2], 
d©a
, 8 );

85 
	`GET_ULONG_BE
Ğ
W
[ 3], 
d©a
, 12 );

86 
	`GET_ULONG_BE
Ğ
W
[ 4], 
d©a
, 16 );

87 
	`GET_ULONG_BE
Ğ
W
[ 5], 
d©a
, 20 );

88 
	`GET_ULONG_BE
Ğ
W
[ 6], 
d©a
, 24 );

89 
	`GET_ULONG_BE
Ğ
W
[ 7], 
d©a
, 28 );

90 
	`GET_ULONG_BE
Ğ
W
[ 8], 
d©a
, 32 );

91 
	`GET_ULONG_BE
Ğ
W
[ 9], 
d©a
, 36 );

92 
	`GET_ULONG_BE
Ğ
W
[10], 
d©a
, 40 );

93 
	`GET_ULONG_BE
Ğ
W
[11], 
d©a
, 44 );

94 
	`GET_ULONG_BE
Ğ
W
[12], 
d©a
, 48 );

95 
	`GET_ULONG_BE
Ğ
W
[13], 
d©a
, 52 );

96 
	`GET_ULONG_BE
Ğ
W
[14], 
d©a
, 56 );

97 
	`GET_ULONG_BE
Ğ
W
[15], 
d©a
, 60 );

99 
	#S
(
x
,
n
è((x <<‚è| ((x & 0xFFFFFFFFè>> (32 -‚)))

	)

101 
	#R
(
t
) \

103 
‹mp
 = 
W
[(
t
 - 3) & 0x0F] ^ W[(t - 8) & 0x0F] ^ \

104 
W
[(
t
 - 14) & 0x0F] ^ W[ & 0x0F], \

105 Ğ
W
[
t
 & 0x0F] = 
	`S
(
‹mp
,1) ) \

106 )

	)

108 
	#P
(
a
,
b
,
c
,
d
,
e
,
x
) \

110 
e
 +ğ
	`S
(
a
,5è+ 
	`F
(
b
,
c
,
d
è+ 
K
 + 
x
; b = S(b,30); \

111 }

	)

113 
A
 = 
ùx
->
¡©e
[0];

114 
B
 = 
ùx
->
¡©e
[1];

115 
C
 = 
ùx
->
¡©e
[2];

116 
D
 = 
ùx
->
¡©e
[3];

117 
E
 = 
ùx
->
¡©e
[4];

119 
	#F
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

120 
	#K
 0x5A827999

	)

122 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[0] );

123 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
W
[1] );

124 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
W
[2] );

125 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
W
[3] );

126 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
W
[4] );

127 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[5] );

128 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
W
[6] );

129 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
W
[7] );

130 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
W
[8] );

131 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
W
[9] );

132 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[10] );

133 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
W
[11] );

134 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
W
[12] );

135 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
W
[13] );

136 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
W
[14] );

137 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[15] );

138 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(16) );

139 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(17) );

140 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(18) );

141 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(19) );

143 #undeà
K


144 #undeà
F


146 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

147 
	#K
 0x6ED9EBA1

	)

149 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(20) );

150 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(21) );

151 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(22) );

152 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(23) );

153 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(24) );

154 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(25) );

155 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(26) );

156 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(27) );

157 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(28) );

158 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(29) );

159 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(30) );

160 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(31) );

161 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(32) );

162 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(33) );

163 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(34) );

164 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(35) );

165 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(36) );

166 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(37) );

167 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(38) );

168 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(39) );

170 #undeà
K


171 #undeà
F


173 
	#F
(
x
,
y
,
z
è((x & yè| (z & (x | y)))

	)

174 
	#K
 0x8F1BBCDC

	)

176 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(40) );

177 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(41) );

178 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(42) );

179 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(43) );

180 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(44) );

181 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(45) );

182 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(46) );

183 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(47) );

184 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(48) );

185 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(49) );

186 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(50) );

187 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(51) );

188 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(52) );

189 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(53) );

190 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(54) );

191 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(55) );

192 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(56) );

193 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(57) );

194 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(58) );

195 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(59) );

197 #undeà
K


198 #undeà
F


200 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

201 
	#K
 0xCA62C1D6

	)

203 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(60) );

204 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(61) );

205 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(62) );

206 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(63) );

207 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(64) );

208 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(65) );

209 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(66) );

210 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(67) );

211 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(68) );

212 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(69) );

213 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(70) );

214 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(71) );

215 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(72) );

216 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(73) );

217 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(74) );

218 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(75) );

219 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(76) );

220 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(77) );

221 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(78) );

222 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(79) );

224 #undeà
K


225 #undeà
F


227 
ùx
->
¡©e
[0] +ğ
A
;

228 
ùx
->
¡©e
[1] +ğ
B
;

229 
ùx
->
¡©e
[2] +ğ
C
;

230 
ùx
->
¡©e
[3] +ğ
D
;

231 
ùx
->
¡©e
[4] +ğ
E
;

232 
	}
}

237 
	$sha1_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

239 
fl
;

240 
Ëá
;

242 ifĞ
’
 <= 0 )

245 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

246 
fl
 = 64 - 
Ëá
;

248 
ùx
->
tÙ®
[0] +ğ
’
;

249 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

251 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

252 
ùx
->
tÙ®
[1]++;

254 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

256 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

257 (*è
šput
, 
fl
 );

258 
	`sha1_´oûss
Ğ
ùx
, ctx->
bufãr
 );

259 
šput
 +ğ
fl
;

260 
’
 -ğ
fl
;

261 
Ëá
 = 0;

264  
’
 >= 64 )

266 
	`sha1_´oûss
Ğ
ùx
, 
šput
 );

267 
šput
 += 64;

268 
’
 -= 64;

271 ifĞ
’
 > 0 )

273 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

274 (*è
šput
, 
’
 );

276 
	}
}

278 cÚ¡ 
	gsha1_·ddšg
[64] =

289 
	$sha1_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] )

291 
Ï¡
, 
·dn
;

292 
high
, 
low
;

293 
msgËn
[8];

295 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

296 | ( 
ùx
->
tÙ®
[1] << 3 );

297 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

299 
	`PUT_ULONG_BE
Ğ
high
, 
msgËn
, 0 );

300 
	`PUT_ULONG_BE
Ğ
low
, 
msgËn
, 4 );

302 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

303 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

305 
	`sha1_upd©e
Ğ
ùx
, (*è
sha1_·ddšg
, 
·dn
 );

306 
	`sha1_upd©e
Ğ
ùx
, 
msgËn
, 8 );

308 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

309 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

310 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

311 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

312 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[4], 
ouut
, 16 );

313 
	}
}

318 
	$sha1
ĞcÚ¡ *
šput
, 
’
, 
ouut
[20] )

320 
sha1_cÚ‹xt
 
ùx
;

322 
	`sha1_¡¬ts
Ğ&
ùx
 );

323 
	`sha1_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

324 
	`sha1_fšish
Ğ&
ùx
, 
ouut
 );

326 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha1_cÚ‹xt
 ) );

327 
	}
}

332 
	$sha1_fe
ĞcÚ¡ *
·th
, 
ouut
[20] )

334 
FILE
 *
f
;

335 
size_t
 
n
;

336 
sha1_cÚ‹xt
 
ùx
;

337 
buf
[1024];

339 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

342 
	`sha1_¡¬ts
Ğ&
ùx
 );

344  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

345 
	`sha1_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

347 
	`sha1_fšish
Ğ&
ùx
, 
ouut
 );

349 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha1_cÚ‹xt
 ) );

351 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

353 
	`fşo£
Ğ
f
 );

357 
	`fşo£
Ğ
f
 );

359 
	}
}

364 
	$sha1_hmac_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

366 
i
;

367 
sum
[20];

369 ifĞ
keyËn
 > 64 )

371 
	`sha1
Ğ
key
, 
keyËn
, 
sum
 );

372 
keyËn
 = 20;

373 
key
 = 
sum
;

376 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

377 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

379  
i
 = 0; i < 
keyËn
; i++ )

381 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

382 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

385 
	`sha1_¡¬ts
Ğ
ùx
 );

386 
	`sha1_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

388 
	`mem£t
Ğ
sum
, 0, ( sum ) );

389 
	}
}

394 
	$sha1_hmac_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

396 
	`sha1_upd©e
Ğ
ùx
, 
šput
, 
’
 );

397 
	}
}

402 
	$sha1_hmac_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] )

404 
tmpbuf
[20];

406 
	`sha1_fšish
Ğ
ùx
, 
tmpbuf
 );

407 
	`sha1_¡¬ts
Ğ
ùx
 );

408 
	`sha1_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

409 
	`sha1_upd©e
Ğ
ùx
, 
tmpbuf
, 20 );

410 
	`sha1_fšish
Ğ
ùx
, 
ouut
 );

412 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

413 
	}
}

418 
	$sha1_hmac_»£t
Ğ
sha1_cÚ‹xt
 *
ùx
 )

420 
	`sha1_¡¬ts
Ğ
ùx
 );

421 
	`sha1_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

422 
	}
}

427 
	$sha1_hmac
ĞcÚ¡ *
key
, 
keyËn
,

428 cÚ¡ *
šput
, 
’
,

429 
ouut
[20] )

431 
sha1_cÚ‹xt
 
ùx
;

433 
	`sha1_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

434 
	`sha1_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

435 
	`sha1_hmac_fšish
Ğ&
ùx
, 
ouut
 );

437 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha1_cÚ‹xt
 ) );

438 
	}
}

440 #ià
defšed
(
POLARSSL_SELF_TEST
)

444 
	gsha1_‹¡_buf
[3][57] =

451 cÚ¡ 
	gsha1_‹¡_buæ’
[3] =

456 cÚ¡ 
	gsha1_‹¡_sum
[3][20] =

469 
	gsha1_hmac_‹¡_key
[7][26] =

484 cÚ¡ 
	gsha1_hmac_‹¡_keyËn
[7] =

489 
	gsha1_hmac_‹¡_buf
[7][74] =

509 cÚ¡ 
	gsha1_hmac_‹¡_buæ’
[7] =

514 cÚ¡ 
	gsha1_hmac_‹¡_sum
[7][20] =

535 
	$sha1_£lf_‹¡
Ğ
v”bo£
 )

537 
i
, 
j
, 
buæ’
;

538 
buf
[1024];

539 
sha1sum
[20];

540 
sha1_cÚ‹xt
 
ùx
;

545  
i
 = 0; i < 3; i++ )

547 ifĞ
v”bo£
 != 0 )

548 
	`´štf
Ğ" SHA-1e¡ #%d: ", 
i
 + 1 );

550 
	`sha1_¡¬ts
Ğ&
ùx
 );

552 ifĞ
i
 == 2 )

554 
	`mem£t
Ğ
buf
, 'a', 
buæ’
 = 1000 );

556  
j
 = 0; j < 1000; j++ )

557 
	`sha1_upd©e
Ğ&
ùx
, 
buf
, 
buæ’
 );

560 
	`sha1_upd©e
Ğ&
ùx
, 
sha1_‹¡_buf
[
i
],

561 
sha1_‹¡_buæ’
[
i
] );

563 
	`sha1_fšish
Ğ&
ùx
, 
sha1sum
 );

565 ifĞ
	`memcmp
Ğ
sha1sum
, 
sha1_‹¡_sum
[
i
], 20 ) != 0 )

567 ifĞ
v”bo£
 != 0 )

568 
	`´štf
( "failed\n" );

573 ifĞ
v”bo£
 != 0 )

574 
	`´štf
( "passed\n" );

577 ifĞ
v”bo£
 != 0 )

578 
	`´štf
( "\n" );

580  
i
 = 0; i < 7; i++ )

582 ifĞ
v”bo£
 != 0 )

583 
	`´štf
Ğ" HMAC-SHA-1e¡ #%d: ", 
i
 + 1 );

585 ifĞ
i
 == 5 || i == 6 )

587 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 80 );

588 
	`sha1_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
 );

591 
	`sha1_hmac_¡¬ts
Ğ&
ùx
, 
sha1_hmac_‹¡_key
[
i
],

592 
sha1_hmac_‹¡_keyËn
[
i
] );

594 
	`sha1_hmac_upd©e
Ğ&
ùx
, 
sha1_hmac_‹¡_buf
[
i
],

595 
sha1_hmac_‹¡_buæ’
[
i
] );

597 
	`sha1_hmac_fšish
Ğ&
ùx
, 
sha1sum
 );

599 
buæ’
 = ( 
i
 == 4 ) ? 12 : 20;

601 ifĞ
	`memcmp
Ğ
sha1sum
, 
sha1_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

603 ifĞ
v”bo£
 != 0 )

604 
	`´štf
( "failed\n" );

609 ifĞ
v”bo£
 != 0 )

610 
	`´štf
( "passed\n" );

613 ifĞ
v”bo£
 != 0 )

614 
	`´štf
( "\n" );

617 
	}
}

	@src/polarssl/sha1.h

25 #iâdeà
POLARSSL_SHA1_H


26 
	#POLARSSL_SHA1_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[5];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

40 
	tsha1_cÚ‹xt
;

42 #ifdeà
__ılu¥lus


51 
sha1_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
 );

60 
sha1_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

68 
sha1_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] );

77 
sha1
ĞcÚ¡ *
šput
, 
’
, 
ouut
[20] );

88 
sha1_fe
ĞcÚ¡ *
·th
, 
ouut
[20] );

97 
sha1_hmac_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

106 
sha1_hmac_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

114 
sha1_hmac_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] );

121 
sha1_hmac_»£t
Ğ
sha1_cÚ‹xt
 *
ùx
 );

132 
sha1_hmac
ĞcÚ¡ *
key
, 
keyËn
,

133 cÚ¡ *
šput
, 
’
,

134 
ouut
[20] );

141 
sha1_£lf_‹¡
Ğ
v”bo£
 );

143 #ifdeà
__ılu¥lus


	@src/polarssl/sha2.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_SHA2_C
)

35 
	~"pŞ¬s¦/sha2.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

66 
	$sha2_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, 
is224
 )

68 
ùx
->
tÙ®
[0] = 0;

69 
ùx
->
tÙ®
[1] = 0;

71 ifĞ
is224
 == 0 )

74 
ùx
->
¡©e
[0] = 0x6A09E667;

75 
ùx
->
¡©e
[1] = 0xBB67AE85;

76 
ùx
->
¡©e
[2] = 0x3C6EF372;

77 
ùx
->
¡©e
[3] = 0xA54FF53A;

78 
ùx
->
¡©e
[4] = 0x510E527F;

79 
ùx
->
¡©e
[5] = 0x9B05688C;

80 
ùx
->
¡©e
[6] = 0x1F83D9AB;

81 
ùx
->
¡©e
[7] = 0x5BE0CD19;

86 
ùx
->
¡©e
[0] = 0xC1059ED8;

87 
ùx
->
¡©e
[1] = 0x367CD507;

88 
ùx
->
¡©e
[2] = 0x3070DD17;

89 
ùx
->
¡©e
[3] = 0xF70E5939;

90 
ùx
->
¡©e
[4] = 0xFFC00B31;

91 
ùx
->
¡©e
[5] = 0x68581511;

92 
ùx
->
¡©e
[6] = 0x64F98FA7;

93 
ùx
->
¡©e
[7] = 0xBEFA4FA4;

96 
ùx
->
is224
 = is224;

97 
	}
}

99 
	$sha2_´oûss
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

101 
‹mp1
, 
‹mp2
, 
W
[64];

102 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
;

104 
	`GET_ULONG_BE
Ğ
W
[ 0], 
d©a
, 0 );

105 
	`GET_ULONG_BE
Ğ
W
[ 1], 
d©a
, 4 );

106 
	`GET_ULONG_BE
Ğ
W
[ 2], 
d©a
, 8 );

107 
	`GET_ULONG_BE
Ğ
W
[ 3], 
d©a
, 12 );

108 
	`GET_ULONG_BE
Ğ
W
[ 4], 
d©a
, 16 );

109 
	`GET_ULONG_BE
Ğ
W
[ 5], 
d©a
, 20 );

110 
	`GET_ULONG_BE
Ğ
W
[ 6], 
d©a
, 24 );

111 
	`GET_ULONG_BE
Ğ
W
[ 7], 
d©a
, 28 );

112 
	`GET_ULONG_BE
Ğ
W
[ 8], 
d©a
, 32 );

113 
	`GET_ULONG_BE
Ğ
W
[ 9], 
d©a
, 36 );

114 
	`GET_ULONG_BE
Ğ
W
[10], 
d©a
, 40 );

115 
	`GET_ULONG_BE
Ğ
W
[11], 
d©a
, 44 );

116 
	`GET_ULONG_BE
Ğ
W
[12], 
d©a
, 48 );

117 
	`GET_ULONG_BE
Ğ
W
[13], 
d©a
, 52 );

118 
	`GET_ULONG_BE
Ğ
W
[14], 
d©a
, 56 );

119 
	`GET_ULONG_BE
Ğ
W
[15], 
d©a
, 60 );

121 
	#SHR
(
x
,
n
è((x & 0xFFFFFFFFè>>‚)

	)

122 
	#ROTR
(
x
,
n
è(
	`SHR
(x,nè| (x << (32 -‚)))

	)

124 
	#S0
(
x
è(
	`ROTR
(x, 7è^ ROTR(x,18è^ 
	`SHR
(x, 3))

	)

125 
	#S1
(
x
è(
	`ROTR
(x,17è^ ROTR(x,19è^ 
	`SHR
(x,10))

	)

127 
	#S2
(
x
è(
	`ROTR
(x, 2è^ ROTR(x,13è^ ROTR(x,22))

	)

128 
	#S3
(
x
è(
	`ROTR
(x, 6è^ ROTR(x,11è^ ROTR(x,25))

	)

130 
	#F0
(
x
,
y
,
z
è((x & yè| (z & (x | y)))

	)

131 
	#F1
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

133 
	#R
(
t
) \

135 
W
[
t
] = 
	`S1
(W[t - 2]) + W[t - 7] + \

136 
	`S0
(
W
[
t
 - 15]) + W[t - 16] \

137 )

	)

139 
	#P
(
a
,
b
,
c
,
d
,
e
,
f
,
g
,
h
,
x
,
K
) \

141 
‹mp1
 = 
h
 + 
	`S3
(
e
è+ 
	`F1
Ó,
f
,
g
è+ 
K
 + 
x
; \

142 
‹mp2
 = 
	`S2
(
a
è+ 
	`F0
×,
b
,
c
); \

143 
d
 +ğ
‹mp1
; 
h
 =emp1 + 
‹mp2
; \

144 }

	)

146 
A
 = 
ùx
->
¡©e
[0];

147 
B
 = 
ùx
->
¡©e
[1];

148 
C
 = 
ùx
->
¡©e
[2];

149 
D
 = 
ùx
->
¡©e
[3];

150 
E
 = 
ùx
->
¡©e
[4];

151 
F
 = 
ùx
->
¡©e
[5];

152 
G
 = 
ùx
->
¡©e
[6];

153 
H
 = 
ùx
->
¡©e
[7];

155 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
W
[ 0], 0x428A2F98 );

156 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
W
[ 1], 0x71374491 );

157 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
W
[ 2], 0xB5C0FBCF );

158 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
W
[ 3], 0xE9B5DBA5 );

159 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
W
[ 4], 0x3956C25B );

160 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
W
[ 5], 0x59F111F1 );

161 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
W
[ 6], 0x923F82A4 );

162 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
W
[ 7], 0xAB1C5ED5 );

163 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
W
[ 8], 0xD807AA98 );

164 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
W
[ 9], 0x12835B01 );

165 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
W
[10], 0x243185BE );

166 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
W
[11], 0x550C7DC3 );

167 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
W
[12], 0x72BE5D74 );

168 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
W
[13], 0x80DEB1FE );

169 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
W
[14], 0x9BDC06A7 );

170 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
W
[15], 0xC19BF174 );

171 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(16), 0xE49B69C1 );

172 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(17), 0xEFBE4786 );

173 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(18), 0x0FC19DC6 );

174 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(19), 0x240CA1CC );

175 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(20), 0x2DE92C6F );

176 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(21), 0x4A7484AA );

177 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(22), 0x5CB0A9DC );

178 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(23), 0x76F988DA );

179 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(24), 0x983E5152 );

180 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(25), 0xA831C66D );

181 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(26), 0xB00327C8 );

182 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(27), 0xBF597FC7 );

183 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(28), 0xC6E00BF3 );

184 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(29), 0xD5A79147 );

185 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(30), 0x06CA6351 );

186 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(31), 0x14292967 );

187 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(32), 0x27B70A85 );

188 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(33), 0x2E1B2138 );

189 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(34), 0x4D2C6DFC );

190 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(35), 0x53380D13 );

191 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(36), 0x650A7354 );

192 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(37), 0x766A0ABB );

193 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(38), 0x81C2C92E );

194 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(39), 0x92722C85 );

195 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(40), 0xA2BFE8A1 );

196 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(41), 0xA81A664B );

197 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(42), 0xC24B8B70 );

198 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(43), 0xC76C51A3 );

199 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(44), 0xD192E819 );

200 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(45), 0xD6990624 );

201 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(46), 0xF40E3585 );

202 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(47), 0x106AA070 );

203 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(48), 0x19A4C116 );

204 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(49), 0x1E376C08 );

205 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(50), 0x2748774C );

206 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(51), 0x34B0BCB5 );

207 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(52), 0x391C0CB3 );

208 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(53), 0x4ED8AA4A );

209 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(54), 0x5B9CCA4F );

210 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(55), 0x682E6FF3 );

211 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(56), 0x748F82EE );

212 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(57), 0x78A5636F );

213 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(58), 0x84C87814 );

214 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(59), 0x8CC70208 );

215 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(60), 0x90BEFFFA );

216 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(61), 0xA4506CEB );

217 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(62), 0xBEF9A3F7 );

218 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(63), 0xC67178F2 );

220 
ùx
->
¡©e
[0] +ğ
A
;

221 
ùx
->
¡©e
[1] +ğ
B
;

222 
ùx
->
¡©e
[2] +ğ
C
;

223 
ùx
->
¡©e
[3] +ğ
D
;

224 
ùx
->
¡©e
[4] +ğ
E
;

225 
ùx
->
¡©e
[5] +ğ
F
;

226 
ùx
->
¡©e
[6] +ğ
G
;

227 
ùx
->
¡©e
[7] +ğ
H
;

228 
	}
}

233 
	$sha2_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

235 
fl
;

236 
Ëá
;

238 ifĞ
’
 <= 0 )

241 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

242 
fl
 = 64 - 
Ëá
;

244 
ùx
->
tÙ®
[0] +ğ
’
;

245 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

247 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

248 
ùx
->
tÙ®
[1]++;

250 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

252 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

253 (*è
šput
, 
fl
 );

254 
	`sha2_´oûss
Ğ
ùx
, ctx->
bufãr
 );

255 
šput
 +ğ
fl
;

256 
’
 -ğ
fl
;

257 
Ëá
 = 0;

260  
’
 >= 64 )

262 
	`sha2_´oûss
Ğ
ùx
, 
šput
 );

263 
šput
 += 64;

264 
’
 -= 64;

267 ifĞ
’
 > 0 )

269 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

270 (*è
šput
, 
’
 );

272 
	}
}

274 cÚ¡ 
	gsha2_·ddšg
[64] =

285 
	$sha2_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] )

287 
Ï¡
, 
·dn
;

288 
high
, 
low
;

289 
msgËn
[8];

291 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

292 | ( 
ùx
->
tÙ®
[1] << 3 );

293 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

295 
	`PUT_ULONG_BE
Ğ
high
, 
msgËn
, 0 );

296 
	`PUT_ULONG_BE
Ğ
low
, 
msgËn
, 4 );

298 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

299 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

301 
	`sha2_upd©e
Ğ
ùx
, (*è
sha2_·ddšg
, 
·dn
 );

302 
	`sha2_upd©e
Ğ
ùx
, 
msgËn
, 8 );

304 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

305 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

306 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

307 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

308 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[4], 
ouut
, 16 );

309 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[5], 
ouut
, 20 );

310 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[6], 
ouut
, 24 );

312 ifĞ
ùx
->
is224
 == 0 )

313 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[7], 
ouut
, 28 );

314 
	}
}

319 
	$sha2
ĞcÚ¡ *
šput
, 
’
,

320 
ouut
[32], 
is224
 )

322 
sha2_cÚ‹xt
 
ùx
;

324 
	`sha2_¡¬ts
Ğ&
ùx
, 
is224
 );

325 
	`sha2_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

326 
	`sha2_fšish
Ğ&
ùx
, 
ouut
 );

328 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha2_cÚ‹xt
 ) );

329 
	}
}

334 
	$sha2_fe
ĞcÚ¡ *
·th
, 
ouut
[32], 
is224
 )

336 
FILE
 *
f
;

337 
size_t
 
n
;

338 
sha2_cÚ‹xt
 
ùx
;

339 
buf
[1024];

341 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

344 
	`sha2_¡¬ts
Ğ&
ùx
, 
is224
 );

346  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

347 
	`sha2_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

349 
	`sha2_fšish
Ğ&
ùx
, 
ouut
 );

351 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha2_cÚ‹xt
 ) );

353 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

355 
	`fşo£
Ğ
f
 );

359 
	`fşo£
Ğ
f
 );

361 
	}
}

366 
	$sha2_hmac_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

367 
is224
 )

369 
i
;

370 
sum
[32];

372 ifĞ
keyËn
 > 64 )

374 
	`sha2
Ğ
key
, 
keyËn
, 
sum
, 
is224
 );

375 
keyËn
 = ( 
is224
 ) ? 28 : 32;

376 
key
 = 
sum
;

379 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

380 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

382  
i
 = 0; i < 
keyËn
; i++ )

384 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

385 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

388 
	`sha2_¡¬ts
Ğ
ùx
, 
is224
 );

389 
	`sha2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

391 
	`mem£t
Ğ
sum
, 0, ( sum ) );

392 
	}
}

397 
	$sha2_hmac_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

399 
	`sha2_upd©e
Ğ
ùx
, 
šput
, 
’
 );

400 
	}
}

405 
	$sha2_hmac_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] )

407 
is224
, 
hËn
;

408 
tmpbuf
[32];

410 
is224
 = 
ùx
->is224;

411 
hËn
 = ( 
is224
 == 0 ) ? 32 : 28;

413 
	`sha2_fšish
Ğ
ùx
, 
tmpbuf
 );

414 
	`sha2_¡¬ts
Ğ
ùx
, 
is224
 );

415 
	`sha2_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

416 
	`sha2_upd©e
Ğ
ùx
, 
tmpbuf
, 
hËn
 );

417 
	`sha2_fšish
Ğ
ùx
, 
ouut
 );

419 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

420 
	}
}

425 
	$sha2_hmac_»£t
Ğ
sha2_cÚ‹xt
 *
ùx
 )

427 
	`sha2_¡¬ts
Ğ
ùx
, ctx->
is224
 );

428 
	`sha2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

429 
	}
}

434 
	$sha2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

435 cÚ¡ *
šput
, 
’
,

436 
ouut
[32], 
is224
 )

438 
sha2_cÚ‹xt
 
ùx
;

440 
	`sha2_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
, 
is224
 );

441 
	`sha2_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

442 
	`sha2_hmac_fšish
Ğ&
ùx
, 
ouut
 );

444 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha2_cÚ‹xt
 ) );

445 
	}
}

447 #ià
defšed
(
POLARSSL_SELF_TEST
)

451 
	gsha2_‹¡_buf
[3][57] =

458 cÚ¡ 
	gsha2_‹¡_buæ’
[3] =

463 cÚ¡ 
	gsha2_‹¡_sum
[6][32] =

501 
	gsha2_hmac_‹¡_key
[7][26] =

516 cÚ¡ 
	gsha2_hmac_‹¡_keyËn
[7] =

521 
	gsha2_hmac_‹¡_buf
[7][153] =

542 cÚ¡ 
	gsha2_hmac_‹¡_buæ’
[7] =

547 cÚ¡ 
	gsha2_hmac_‹¡_sum
[14][32] =

613 
	$sha2_£lf_‹¡
Ğ
v”bo£
 )

615 
i
, 
j
, 
k
, 
buæ’
;

616 
buf
[1024];

617 
sha2sum
[32];

618 
sha2_cÚ‹xt
 
ùx
;

620  
i
 = 0; i < 6; i++ )

622 
j
 = 
i
 % 3;

623 
k
 = 
i
 < 3;

625 ifĞ
v”bo£
 != 0 )

626 
	`´štf
Ğ" SHA-%de¡ #%d: ", 256 - 
k
 * 32, 
j
 + 1 );

628 
	`sha2_¡¬ts
Ğ&
ùx
, 
k
 );

630 ifĞ
j
 == 2 )

632 
	`mem£t
Ğ
buf
, 'a', 
buæ’
 = 1000 );

634  
j
 = 0; j < 1000; j++ )

635 
	`sha2_upd©e
Ğ&
ùx
, 
buf
, 
buæ’
 );

638 
	`sha2_upd©e
Ğ&
ùx
, 
sha2_‹¡_buf
[
j
],

639 
sha2_‹¡_buæ’
[
j
] );

641 
	`sha2_fšish
Ğ&
ùx
, 
sha2sum
 );

643 ifĞ
	`memcmp
Ğ
sha2sum
, 
sha2_‹¡_sum
[
i
], 32 - 
k
 * 4 ) != 0 )

645 ifĞ
v”bo£
 != 0 )

646 
	`´štf
( "failed\n" );

651 ifĞ
v”bo£
 != 0 )

652 
	`´štf
( "passed\n" );

655 ifĞ
v”bo£
 != 0 )

656 
	`´štf
( "\n" );

658  
i
 = 0; i < 14; i++ )

660 
j
 = 
i
 % 7;

661 
k
 = 
i
 < 7;

663 ifĞ
v”bo£
 != 0 )

664 
	`´štf
Ğ" HMAC-SHA-%de¡ #%d: ", 256 - 
k
 * 32, 
j
 + 1 );

666 ifĞ
j
 == 5 || j == 6 )

668 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 131 );

669 
	`sha2_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
, 
k
 );

672 
	`sha2_hmac_¡¬ts
Ğ&
ùx
, 
sha2_hmac_‹¡_key
[
j
],

673 
sha2_hmac_‹¡_keyËn
[
j
], 
k
 );

675 
	`sha2_hmac_upd©e
Ğ&
ùx
, 
sha2_hmac_‹¡_buf
[
j
],

676 
sha2_hmac_‹¡_buæ’
[
j
] );

678 
	`sha2_hmac_fšish
Ğ&
ùx
, 
sha2sum
 );

680 
buæ’
 = ( 
j
 =ğ4 ) ? 16 : 32 - 
k
 * 4;

682 ifĞ
	`memcmp
Ğ
sha2sum
, 
sha2_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

684 ifĞ
v”bo£
 != 0 )

685 
	`´štf
( "failed\n" );

690 ifĞ
v”bo£
 != 0 )

691 
	`´štf
( "passed\n" );

694 ifĞ
v”bo£
 != 0 )

695 
	`´štf
( "\n" );

698 
	}
}

	@src/polarssl/sha2.h

25 #iâdeà
POLARSSL_SHA2_H


26 
	#POLARSSL_SHA2_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[8];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

39 
	mis224
;

41 
	tsha2_cÚ‹xt
;

43 #ifdeà
__ılu¥lus


53 
sha2_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, 
is224
 );

62 
sha2_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

70 
sha2_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] );

80 
sha2
ĞcÚ¡ *
šput
, 
’
,

81 
ouut
[32], 
is224
 );

93 
sha2_fe
ĞcÚ¡ *
·th
, 
ouut
[32], 
is224
 );

103 
sha2_hmac_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

104 
is224
 );

113 
sha2_hmac_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

121 
sha2_hmac_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] );

128 
sha2_hmac_»£t
Ğ
sha2_cÚ‹xt
 *
ùx
 );

140 
sha2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

141 cÚ¡ *
šput
, 
’
,

142 
ouut
[32], 
is224
 );

149 
sha2_£lf_‹¡
Ğ
v”bo£
 );

151 #ifdeà
__ılu¥lus


	@src/polarssl/sha4.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_SHA4_C
)

35 
	~"pŞ¬s¦/sha4.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_UINT64_BE


44 
	#GET_UINT64_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(
št64
è(
b
)[(
i
) ] << 56 ) \

47 | ( (
št64
è(
b
)[(
i
) + 1] << 48 ) \

48 | ( (
št64
è(
b
)[(
i
) + 2] << 40 ) \

49 | ( (
št64
è(
b
)[(
i
) + 3] << 32 ) \

50 | ( (
št64
è(
b
)[(
i
) + 4] << 24 ) \

51 | ( (
št64
è(
b
)[(
i
) + 5] << 16 ) \

52 | ( (
št64
è(
b
)[(
i
) + 6] << 8 ) \

53 | ( (
št64
è(
b
)[(
i
) + 7] ); \

54 }

	)

57 #iâdeà
PUT_UINT64_BE


58 
	#PUT_UINT64_BE
(
n
,
b
,
i
) \

60 (
b
)[(
i
è] = (èĞ(
n
) >> 56 ); \

61 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 48 ); \

62 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 40 ); \

63 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 32 ); \

64 (
b
)[(
i
è+ 4] = (èĞ(
n
) >> 24 ); \

65 (
b
)[(
i
è+ 5] = (èĞ(
n
) >> 16 ); \

66 (
b
)[(
i
è+ 6] = (èĞ(
n
) >> 8 ); \

67 (
b
)[(
i
è+ 7] = (èĞ(
n
) ); \

68 }

	)

74 cÚ¡ 
št64
 
	gK
[80] =

76 
UL64
(0x428A2F98D728AE22), UL64(0x7137449123EF65CD),

77 
UL64
(0xB5C0FBCFEC4D3B2F), UL64(0xE9B5DBA58189DBBC),

78 
UL64
(0x3956C25BF348B538), UL64(0x59F111F1B605D019),

79 
UL64
(0x923F82A4AF194F9B), UL64(0xAB1C5ED5DA6D8118),

80 
UL64
(0xD807AA98A3030242), UL64(0x12835B0145706FBE),

81 
UL64
(0x243185BE4EE4B28C), UL64(0x550C7DC3D5FFB4E2),

82 
UL64
(0x72BE5D74F27B896F), UL64(0x80DEB1FE3B1696B1),

83 
UL64
(0x9BDC06A725C71235), UL64(0xC19BF174CF692694),

84 
UL64
(0xE49B69C19EF14AD2), UL64(0xEFBE4786384F25E3),

85 
UL64
(0x0FC19DC68B8CD5B5), UL64(0x240CA1CC77AC9C65),

86 
UL64
(0x2DE92C6F592B0275), UL64(0x4A7484AA6EA6E483),

87 
UL64
(0x5CB0A9DCBD41FBD4), UL64(0x76F988DA831153B5),

88 
UL64
(0x983E5152EE66DFAB), UL64(0xA831C66D2DB43210),

89 
UL64
(0xB00327C898FB213F), UL64(0xBF597FC7BEEF0EE4),

90 
UL64
(0xC6E00BF33DA88FC2), UL64(0xD5A79147930AA725),

91 
UL64
(0x06CA6351E003826F), UL64(0x142929670A0E6E70),

92 
UL64
(0x27B70A8546D22FFC), UL64(0x2E1B21385C26C926),

93 
UL64
(0x4D2C6DFC5AC42AED), UL64(0x53380D139D95B3DF),

94 
UL64
(0x650A73548BAF63DE), UL64(0x766A0ABB3C77B2A8),

95 
UL64
(0x81C2C92E47EDAEE6), UL64(0x92722C851482353B),

96 
UL64
(0xA2BFE8A14CF10364), UL64(0xA81A664BBC423001),

97 
UL64
(0xC24B8B70D0F89791), UL64(0xC76C51A30654BE30),

98 
UL64
(0xD192E819D6EF5218), UL64(0xD69906245565A910),

99 
UL64
(0xF40E35855771202A), UL64(0x106AA07032BBD1B8),

100 
UL64
(0x19A4C116B8D2D0C8), UL64(0x1E376C085141AB53),

101 
UL64
(0x2748774CDF8EEB99), UL64(0x34B0BCB5E19B48A8),

102 
UL64
(0x391C0CB3C5C95A63), UL64(0x4ED8AA4AE3418ACB),

103 
UL64
(0x5B9CCA4F7763E373), UL64(0x682E6FF3D6B2B8A3),

104 
UL64
(0x748F82EE5DEFB2FC), UL64(0x78A5636F43172F60),

105 
UL64
(0x84C87814A1F0AB72), UL64(0x8CC702081A6439EC),

106 
UL64
(0x90BEFFFA23631E28), UL64(0xA4506CEBDE82BDE9),

107 
UL64
(0xBEF9A3F7B2C67915), UL64(0xC67178F2E372532B),

108 
UL64
(0xCA273ECEEA26619C), UL64(0xD186B8C721C0C207),

109 
UL64
(0xEADA7DD6CDE0EB1E), UL64(0xF57D4F7FEE6ED178),

110 
UL64
(0x06F067AA72176FBA), UL64(0x0A637DC5A2C898A6),

111 
UL64
(0x113F9804BEF90DAE), UL64(0x1B710B35131C471B),

112 
UL64
(0x28DB77F523047D84), UL64(0x32CAAB7B40C72493),

113 
UL64
(0x3C9EBE0A15C9BEBC), UL64(0x431D67C49C100D4C),

114 
UL64
(0x4CC5D4BECB3E42B6), UL64(0x597F299CFC657E2A),

115 
UL64
(0x5FCB6FAB3AD6FAEC), UL64(0x6C44198C4A475817)

121 
	$sha4_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, 
is384
 )

123 
ùx
->
tÙ®
[0] = 0;

124 
ùx
->
tÙ®
[1] = 0;

126 ifĞ
is384
 == 0 )

129 
ùx
->
¡©e
[0] = 
	`UL64
(0x6A09E667F3BCC908);

130 
ùx
->
¡©e
[1] = 
	`UL64
(0xBB67AE8584CAA73B);

131 
ùx
->
¡©e
[2] = 
	`UL64
(0x3C6EF372FE94F82B);

132 
ùx
->
¡©e
[3] = 
	`UL64
(0xA54FF53A5F1D36F1);

133 
ùx
->
¡©e
[4] = 
	`UL64
(0x510E527FADE682D1);

134 
ùx
->
¡©e
[5] = 
	`UL64
(0x9B05688C2B3E6C1F);

135 
ùx
->
¡©e
[6] = 
	`UL64
(0x1F83D9ABFB41BD6B);

136 
ùx
->
¡©e
[7] = 
	`UL64
(0x5BE0CD19137E2179);

141 
ùx
->
¡©e
[0] = 
	`UL64
(0xCBBB9D5DC1059ED8);

142 
ùx
->
¡©e
[1] = 
	`UL64
(0x629A292A367CD507);

143 
ùx
->
¡©e
[2] = 
	`UL64
(0x9159015A3070DD17);

144 
ùx
->
¡©e
[3] = 
	`UL64
(0x152FECD8F70E5939);

145 
ùx
->
¡©e
[4] = 
	`UL64
(0x67332667FFC00B31);

146 
ùx
->
¡©e
[5] = 
	`UL64
(0x8EB44A8768581511);

147 
ùx
->
¡©e
[6] = 
	`UL64
(0xDB0C2E0D64F98FA7);

148 
ùx
->
¡©e
[7] = 
	`UL64
(0x47B5481DBEFA4FA4);

151 
ùx
->
is384
 = is384;

152 
	}
}

154 
	$sha4_´oûss
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[128] )

156 
i
;

157 
št64
 
‹mp1
, 
‹mp2
, 
W
[80];

158 
št64
 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
;

160 
	#SHR
(
x
,
n
è(x >>‚)

	)

161 
	#ROTR
(
x
,
n
è(
	`SHR
(x,nè| (x << (64 -‚)))

	)

163 
	#S0
(
x
è(
	`ROTR
(x, 1è^ ROTR(x, 8è^ 
	`SHR
(x, 7))

	)

164 
	#S1
(
x
è(
	`ROTR
(x,19è^ ROTR(x,61è^ 
	`SHR
(x, 6))

	)

166 
	#S2
(
x
è(
	`ROTR
(x,28è^ ROTR(x,34è^ ROTR(x,39))

	)

167 
	#S3
(
x
è(
	`ROTR
(x,14è^ ROTR(x,18è^ ROTR(x,41))

	)

169 
	#F0
(
x
,
y
,
z
è((x & yè| (z & (x | y)))

	)

170 
	#F1
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

172 
	#P
(
a
,
b
,
c
,
d
,
e
,
f
,
g
,
h
,
x
,
K
) \

174 
‹mp1
 = 
h
 + 
	`S3
(
e
è+ 
	`F1
Ó,
f
,
g
è+ 
K
 + 
x
; \

175 
‹mp2
 = 
	`S2
(
a
è+ 
	`F0
×,
b
,
c
); \

176 
d
 +ğ
‹mp1
; 
h
 =emp1 + 
‹mp2
; \

177 }

	)

179  
i
 = 0; i < 16; i++ )

181 
	`GET_UINT64_BE
Ğ
W
[
i
], 
d©a
, i << 3 );

184  ; 
i
 < 80; i++ )

186 
W
[
i
] = 
	`S1
(W[i - 2]) + W[i - 7] +

187 
	`S0
(
W
[
i
 - 15]) + W[i - 16];

190 
A
 = 
ùx
->
¡©e
[0];

191 
B
 = 
ùx
->
¡©e
[1];

192 
C
 = 
ùx
->
¡©e
[2];

193 
D
 = 
ùx
->
¡©e
[3];

194 
E
 = 
ùx
->
¡©e
[4];

195 
F
 = 
ùx
->
¡©e
[5];

196 
G
 = 
ùx
->
¡©e
[6];

197 
H
 = 
ùx
->
¡©e
[7];

198 
i
 = 0;

202 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
W
[
i
], 
K
[i] ); i++;

203 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
W
[
i
], 
K
[i] ); i++;

204 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
W
[
i
], 
K
[i] ); i++;

205 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
W
[
i
], 
K
[i] ); i++;

206 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
W
[
i
], 
K
[i] ); i++;

207 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
W
[
i
], 
K
[i] ); i++;

208 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
W
[
i
], 
K
[i] ); i++;

209 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
W
[
i
], 
K
[i] ); i++;

211  
i
 < 80 );

213 
ùx
->
¡©e
[0] +ğ
A
;

214 
ùx
->
¡©e
[1] +ğ
B
;

215 
ùx
->
¡©e
[2] +ğ
C
;

216 
ùx
->
¡©e
[3] +ğ
D
;

217 
ùx
->
¡©e
[4] +ğ
E
;

218 
ùx
->
¡©e
[5] +ğ
F
;

219 
ùx
->
¡©e
[6] +ğ
G
;

220 
ùx
->
¡©e
[7] +ğ
H
;

221 
	}
}

226 
	$sha4_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

228 
fl
;

229 
št64
 
Ëá
;

231 ifĞ
’
 <= 0 )

234 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x7F;

235 
fl
 = ()Ğ128 - 
Ëá
 );

237 
ùx
->
tÙ®
[0] +ğ
’
;

239 ifĞ
ùx
->
tÙ®
[0] < (
št64
è
’
 )

240 
ùx
->
tÙ®
[1]++;

242 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

244 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

245 (*è
šput
, 
fl
 );

246 
	`sha4_´oûss
Ğ
ùx
, ctx->
bufãr
 );

247 
šput
 +ğ
fl
;

248 
’
 -ğ
fl
;

249 
Ëá
 = 0;

252  
’
 >= 128 )

254 
	`sha4_´oûss
Ğ
ùx
, 
šput
 );

255 
šput
 += 128;

256 
’
 -= 128;

259 ifĞ
’
 > 0 )

261 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

262 (*è
šput
, 
’
 );

264 
	}
}

266 cÚ¡ 
	gsha4_·ddšg
[128] =

281 
	$sha4_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] )

283 
Ï¡
, 
·dn
;

284 
št64
 
high
, 
low
;

285 
msgËn
[16];

287 
high
 = ( 
ùx
->
tÙ®
[0] >> 61 )

288 | ( 
ùx
->
tÙ®
[1] << 3 );

289 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

291 
	`PUT_UINT64_BE
Ğ
high
, 
msgËn
, 0 );

292 
	`PUT_UINT64_BE
Ğ
low
, 
msgËn
, 8 );

294 
Ï¡
 = ()Ğ
ùx
->
tÙ®
[0] & 0x7F );

295 
·dn
 = ( 
Ï¡
 < 112 ) ? ( 112 -†ast ) : ( 240 -†ast );

297 
	`sha4_upd©e
Ğ
ùx
, (*è
sha4_·ddšg
, 
·dn
 );

298 
	`sha4_upd©e
Ğ
ùx
, 
msgËn
, 16 );

300 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

301 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[1], 
ouut
, 8 );

302 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[2], 
ouut
, 16 );

303 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[3], 
ouut
, 24 );

304 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[4], 
ouut
, 32 );

305 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[5], 
ouut
, 40 );

307 ifĞ
ùx
->
is384
 == 0 )

309 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[6], 
ouut
, 48 );

310 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[7], 
ouut
, 56 );

312 
	}
}

317 
	$sha4
ĞcÚ¡ *
šput
, 
’
,

318 
ouut
[64], 
is384
 )

320 
sha4_cÚ‹xt
 
ùx
;

322 
	`sha4_¡¬ts
Ğ&
ùx
, 
is384
 );

323 
	`sha4_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

324 
	`sha4_fšish
Ğ&
ùx
, 
ouut
 );

326 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha4_cÚ‹xt
 ) );

327 
	}
}

332 
	$sha4_fe
ĞcÚ¡ *
·th
, 
ouut
[64], 
is384
 )

334 
FILE
 *
f
;

335 
size_t
 
n
;

336 
sha4_cÚ‹xt
 
ùx
;

337 
buf
[1024];

339 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

342 
	`sha4_¡¬ts
Ğ&
ùx
, 
is384
 );

344  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

345 
	`sha4_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

347 
	`sha4_fšish
Ğ&
ùx
, 
ouut
 );

349 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha4_cÚ‹xt
 ) );

351 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

353 
	`fşo£
Ğ
f
 );

357 
	`fşo£
Ğ
f
 );

359 
	}
}

364 
	$sha4_hmac_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

365 
is384
 )

367 
i
;

368 
sum
[64];

370 ifĞ
keyËn
 > 128 )

372 
	`sha4
Ğ
key
, 
keyËn
, 
sum
, 
is384
 );

373 
keyËn
 = ( 
is384
 ) ? 48 : 64;

374 
key
 = 
sum
;

377 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 128 );

378 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 128 );

380  
i
 = 0; i < 
keyËn
; i++ )

382 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

383 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

386 
	`sha4_¡¬ts
Ğ
ùx
, 
is384
 );

387 
	`sha4_upd©e
Ğ
ùx
, ctx->
ad
, 128 );

389 
	`mem£t
Ğ
sum
, 0, ( sum ) );

390 
	}
}

395 
	$sha4_hmac_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
,

396 cÚ¡ *
šput
, 
’
 )

398 
	`sha4_upd©e
Ğ
ùx
, 
šput
, 
’
 );

399 
	}
}

404 
	$sha4_hmac_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] )

406 
is384
, 
hËn
;

407 
tmpbuf
[64];

409 
is384
 = 
ùx
->is384;

410 
hËn
 = ( 
is384
 == 0 ) ? 64 : 48;

412 
	`sha4_fšish
Ğ
ùx
, 
tmpbuf
 );

413 
	`sha4_¡¬ts
Ğ
ùx
, 
is384
 );

414 
	`sha4_upd©e
Ğ
ùx
, ctx->
İad
, 128 );

415 
	`sha4_upd©e
Ğ
ùx
, 
tmpbuf
, 
hËn
 );

416 
	`sha4_fšish
Ğ
ùx
, 
ouut
 );

418 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

419 
	}
}

424 
	$sha4_hmac_»£t
Ğ
sha4_cÚ‹xt
 *
ùx
 )

426 
	`sha4_¡¬ts
Ğ
ùx
, ctx->
is384
 );

427 
	`sha4_upd©e
Ğ
ùx
, ctx->
ad
, 128 );

428 
	}
}

433 
	$sha4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

434 cÚ¡ *
šput
, 
’
,

435 
ouut
[64], 
is384
 )

437 
sha4_cÚ‹xt
 
ùx
;

439 
	`sha4_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
, 
is384
 );

440 
	`sha4_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

441 
	`sha4_hmac_fšish
Ğ&
ùx
, 
ouut
 );

443 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha4_cÚ‹xt
 ) );

444 
	}
}

446 #ià
defšed
(
POLARSSL_SELF_TEST
)

451 
	gsha4_‹¡_buf
[3][113] =

459 cÚ¡ 
	gsha4_‹¡_buæ’
[3] =

464 cÚ¡ 
	gsha4_‹¡_sum
[6][64] =

520 
	gsha4_hmac_‹¡_key
[7][26] =

535 cÚ¡ 
	gsha4_hmac_‹¡_keyËn
[7] =

540 
	gsha4_hmac_‹¡_buf
[7][153] =

561 cÚ¡ 
	gsha4_hmac_‹¡_buæ’
[7] =

566 cÚ¡ 
	gsha4_hmac_‹¡_sum
[14][64] =

668 
	$sha4_£lf_‹¡
Ğ
v”bo£
 )

670 
i
, 
j
, 
k
, 
buæ’
;

671 
buf
[1024];

672 
sha4sum
[64];

673 
sha4_cÚ‹xt
 
ùx
;

675  
i
 = 0; i < 6; i++ )

677 
j
 = 
i
 % 3;

678 
k
 = 
i
 < 3;

680 ifĞ
v”bo£
 != 0 )

681 
	`´štf
Ğ" SHA-%de¡ #%d: ", 512 - 
k
 * 128, 
j
 + 1 );

683 
	`sha4_¡¬ts
Ğ&
ùx
, 
k
 );

685 ifĞ
j
 == 2 )

687 
	`mem£t
Ğ
buf
, 'a', 
buæ’
 = 1000 );

689  
j
 = 0; j < 1000; j++ )

690 
	`sha4_upd©e
Ğ&
ùx
, 
buf
, 
buæ’
 );

693 
	`sha4_upd©e
Ğ&
ùx
, 
sha4_‹¡_buf
[
j
],

694 
sha4_‹¡_buæ’
[
j
] );

696 
	`sha4_fšish
Ğ&
ùx
, 
sha4sum
 );

698 ifĞ
	`memcmp
Ğ
sha4sum
, 
sha4_‹¡_sum
[
i
], 64 - 
k
 * 16 ) != 0 )

700 ifĞ
v”bo£
 != 0 )

701 
	`´štf
( "failed\n" );

706 ifĞ
v”bo£
 != 0 )

707 
	`´štf
( "passed\n" );

710 ifĞ
v”bo£
 != 0 )

711 
	`´štf
( "\n" );

713  
i
 = 0; i < 14; i++ )

715 
j
 = 
i
 % 7;

716 
k
 = 
i
 < 7;

718 ifĞ
v”bo£
 != 0 )

719 
	`´štf
Ğ" HMAC-SHA-%de¡ #%d: ", 512 - 
k
 * 128, 
j
 + 1 );

721 ifĞ
j
 == 5 || j == 6 )

723 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 131 );

724 
	`sha4_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
, 
k
 );

727 
	`sha4_hmac_¡¬ts
Ğ&
ùx
, 
sha4_hmac_‹¡_key
[
j
],

728 
sha4_hmac_‹¡_keyËn
[
j
], 
k
 );

730 
	`sha4_hmac_upd©e
Ğ&
ùx
, 
sha4_hmac_‹¡_buf
[
j
],

731 
sha4_hmac_‹¡_buæ’
[
j
] );

733 
	`sha4_hmac_fšish
Ğ&
ùx
, 
sha4sum
 );

735 
buæ’
 = ( 
j
 =ğ4 ) ? 16 : 64 - 
k
 * 16;

737 ifĞ
	`memcmp
Ğ
sha4sum
, 
sha4_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

739 ifĞ
v”bo£
 != 0 )

740 
	`´štf
( "failed\n" );

745 ifĞ
v”bo£
 != 0 )

746 
	`´štf
( "passed\n" );

749 ifĞ
v”bo£
 != 0 )

750 
	`´štf
( "\n" );

753 
	}
}

	@src/polarssl/sha4.h

25 #iâdeà
POLARSSL_SHA4_H


26 
	#POLARSSL_SHA4_H


	)

28 #ià
defšed
(
_MSC_VER
è|| defšed(
__WATCOMC__
)

29 
	#UL64
(
x
èx##
ui64


	)

30 
	#št64
 
__št64


	)

32 
	#UL64
(
x
èx##
ULL


	)

33 
	#št64
 

	)

41 
št64
 
	mtÙ®
[2];

42 
št64
 
	m¡©e
[8];

43 
	mbufãr
[128];

45 
	mad
[128];

46 
	mİad
[128];

47 
	mis384
;

49 
	tsha4_cÚ‹xt
;

51 #ifdeà
__ılu¥lus


61 
sha4_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, 
is384
 );

70 
sha4_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

78 
sha4_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] );

88 
sha4
ĞcÚ¡ *
šput
, 
’
,

89 
ouut
[64], 
is384
 );

101 
sha4_fe
ĞcÚ¡ *
·th
, 
ouut
[64], 
is384
 );

111 
sha4_hmac_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

112 
is384
 );

121 
sha4_hmac_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

129 
sha4_hmac_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] );

136 
sha4_hmac_»£t
Ğ
sha4_cÚ‹xt
 *
ùx
 );

148 
sha4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

149 cÚ¡ *
šput
, 
’
,

150 
ouut
[64], 
is384
 );

157 
sha4_£lf_‹¡
Ğ
v”bo£
 );

159 #ifdeà
__ılu¥lus


	@src/polarssl/ssl.h

25 #iâdeà
POLARSSL_SSL_H


26 
	#POLARSSL_SSL_H


	)

28 
	~<time.h
>

30 
	~"pŞ¬s¦/Ãt.h
"

31 
	~"pŞ¬s¦/dhm.h
"

32 
	~"pŞ¬s¦/r§.h
"

33 
	~"pŞ¬s¦/md5.h
"

34 
	~"pŞ¬s¦/sha1.h
"

35 
	~"pŞ¬s¦/x509.h
"

40 
	#POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 -0x1000

	)

41 
	#POLARSSL_ERR_SSL_BAD_INPUT_DATA
 -0x1800

	)

42 
	#POLARSSL_ERR_SSL_INVALID_MAC
 -0x2000

	)

43 
	#POLARSSL_ERR_SSL_INVALID_RECORD
 -0x2800

	)

44 
	#POLARSSL_ERR_SSL_INVALID_MODULUS_SIZE
 -0x3000

	)

45 
	#POLARSSL_ERR_SSL_UNKNOWN_CIPHER
 -0x3800

	)

46 
	#POLARSSL_ERR_SSL_NO_CIPHER_CHOSEN
 -0x4000

	)

47 
	#POLARSSL_ERR_SSL_NO_SESSION_FOUND
 -0x4800

	)

48 
	#POLARSSL_ERR_SSL_NO_CLIENT_CERTIFICATE
 -0x5000

	)

49 
	#POLARSSL_ERR_SSL_CERTIFICATE_TOO_LARGE
 -0x5800

	)

50 
	#POLARSSL_ERR_SSL_CERTIFICATE_REQUIRED
 -0x6000

	)

51 
	#POLARSSL_ERR_SSL_PRIVATE_KEY_REQUIRED
 -0x6800

	)

52 
	#POLARSSL_ERR_SSL_CA_CHAIN_REQUIRED
 -0x7000

	)

53 
	#POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 -0x7800

	)

54 
	#POLARSSL_ERR_SSL_FATAL_ALERT_MESSAGE
 -0x8000

	)

55 
	#POLARSSL_ERR_SSL_PEER_VERIFY_FAILED
 -0x8800

	)

56 
	#POLARSSL_ERR_SSL_PEER_CLOSE_NOTIFY
 -0x9000

	)

57 
	#POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 -0x9800

	)

58 
	#POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 -0xA000

	)

59 
	#POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 -0xA800

	)

60 
	#POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_REQUEST
 -0xB000

	)

61 
	#POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 -0xB800

	)

62 
	#POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO_DONE
 -0xC000

	)

63 
	#POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 -0xC800

	)

64 
	#POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 -0xD000

	)

65 
	#POLARSSL_ERR_SSL_BAD_HS_CHANGE_CIPHER_SPEC
 -0xD800

	)

66 
	#POLARSSL_ERR_SSL_BAD_HS_FINISHED
 -0xE000

	)

71 
	#SSL_MAJOR_VERSION_3
 3

	)

72 
	#SSL_MINOR_VERSION_0
 0

	)

73 
	#SSL_MINOR_VERSION_1
 1

	)

74 
	#SSL_MINOR_VERSION_2
 2

	)

76 
	#SSL_IS_CLIENT
 0

	)

77 
	#SSL_IS_SERVER
 1

	)

78 
	#SSL_COMPRESS_NULL
 0

	)

80 
	#SSL_VERIFY_NONE
 0

	)

81 
	#SSL_VERIFY_OPTIONAL
 1

	)

82 
	#SSL_VERIFY_REQUIRED
 2

	)

84 
	#SSL_MAX_CONTENT_LEN
 16384

	)

90 
	#SSL_BUFFER_LEN
 (
SSL_MAX_CONTENT_LEN
 + 512)

	)

95 
	#SSL_RSA_RC4_128_MD5
 0x04

	)

96 
	#SSL_RSA_RC4_128_SHA
 0x05

	)

97 
	#SSL_RSA_DES_168_SHA
 0x0A

	)

98 
	#SSL_EDH_RSA_DES_168_SHA
 0x16

	)

99 
	#SSL_RSA_AES_128_SHA
 0x2F

	)

100 
	#SSL_EDH_RSA_AES_128_SHA
 0x33

	)

101 
	#SSL_RSA_AES_256_SHA
 0x35

	)

102 
	#SSL_EDH_RSA_AES_256_SHA
 0x39

	)

104 
	#SSL_RSA_CAMELLIA_128_SHA
 0x41

	)

105 
	#SSL_EDH_RSA_CAMELLIA_128_SHA
 0x45

	)

106 
	#SSL_RSA_CAMELLIA_256_SHA
 0x84

	)

107 
	#SSL_EDH_RSA_CAMELLIA_256_SHA
 0x88

	)

112 
	#SSL_MSG_CHANGE_CIPHER_SPEC
 20

	)

113 
	#SSL_MSG_ALERT
 21

	)

114 
	#SSL_MSG_HANDSHAKE
 22

	)

115 
	#SSL_MSG_APPLICATION_DATA
 23

	)

117 
	#SSL_ALERT_LEVEL_WARNING
 1

	)

118 
	#SSL_ALERT_LEVEL_FATAL
 2

	)

120 
	#SSL_ALERT_MSG_CLOSE_NOTIFY
 0

	)

121 
	#SSL_ALERT_MSG_UNEXPECTED_MESSAGE
 10

	)

122 
	#SSL_ALERT_MSG_BAD_RECORD_MAD
 20

	)

123 
	#SSL_ALERT_MSG_DECRYPTION_FAILED
 21

	)

124 
	#SSL_ALERT_MSG_RECORD_OVERFLOW
 22

	)

125 
	#SSL_ALERT_MSG_DECOMPRESSION_FAILURE
 30

	)

126 
	#SSL_ALERT_MSG_HANDSHAKE_FAILURE
 40

	)

127 
	#SSL_ALERT_MSG_NO_CERT
 41

	)

128 
	#SSL_ALERT_MSG_BAD_CERT
 42

	)

129 
	#SSL_ALERT_MSG_UNSUPPORTED_CERT
 43

	)

130 
	#SSL_ALERT_MSG_CERT_REVOKED
 44

	)

131 
	#SSL_ALERT_MSG_CERT_EXPIRED
 45

	)

132 
	#SSL_ALERT_MSG_CERT_UNKNOWN
 46

	)

133 
	#SSL_ALERT_MSG_ILLEGAL_PARAMETER
 47

	)

134 
	#SSL_ALERT_MSG_UNKNOWN_CA
 48

	)

135 
	#SSL_ALERT_MSG_ACCESS_DENIED
 49

	)

136 
	#SSL_ALERT_MSG_DECODE_ERROR
 50

	)

137 
	#SSL_ALERT_MSG_DECRYPT_ERROR
 51

	)

138 
	#SSL_ALERT_MSG_EXPORT_RESTRICTION
 60

	)

139 
	#SSL_ALERT_MSG_PROTOCOL_VERSION
 70

	)

140 
	#SSL_ALERT_MSG_INSUFFICIENT_SECURITY
 71

	)

141 
	#SSL_ALERT_MSG_INTERNAL_ERROR
 80

	)

142 
	#SSL_ALERT_MSG_USER_CANCELED
 90

	)

143 
	#SSL_ALERT_MSG_NO_RENEGOTIATION
 100

	)

145 
	#SSL_HS_HELLO_REQUEST
 0

	)

146 
	#SSL_HS_CLIENT_HELLO
 1

	)

147 
	#SSL_HS_SERVER_HELLO
 2

	)

148 
	#SSL_HS_CERTIFICATE
 11

	)

149 
	#SSL_HS_SERVER_KEY_EXCHANGE
 12

	)

150 
	#SSL_HS_CERTIFICATE_REQUEST
 13

	)

151 
	#SSL_HS_SERVER_HELLO_DONE
 14

	)

152 
	#SSL_HS_CERTIFICATE_VERIFY
 15

	)

153 
	#SSL_HS_CLIENT_KEY_EXCHANGE
 16

	)

154 
	#SSL_HS_FINISHED
 20

	)

159 
	#TLS_EXT_SERVERNAME
 0

	)

160 
	#TLS_EXT_SERVERNAME_HOSTNAME
 0

	)

167 
	mSSL_HELLO_REQUEST
,

168 
	mSSL_CLIENT_HELLO
,

169 
	mSSL_SERVER_HELLO
,

170 
	mSSL_SERVER_CERTIFICATE
,

171 
	mSSL_SERVER_KEY_EXCHANGE
,

172 
	mSSL_CERTIFICATE_REQUEST
,

173 
	mSSL_SERVER_HELLO_DONE
,

174 
	mSSL_CLIENT_CERTIFICATE
,

175 
	mSSL_CLIENT_KEY_EXCHANGE
,

176 
	mSSL_CERTIFICATE_VERIFY
,

177 
	mSSL_CLIENT_CHANGE_CIPHER_SPEC
,

178 
	mSSL_CLIENT_FINISHED
,

179 
	mSSL_SERVER_CHANGE_CIPHER_SPEC
,

180 
	mSSL_SERVER_FINISHED
,

181 
	mSSL_FLUSH_BUFFERS
,

182 
	mSSL_HANDSHAKE_OVER


184 
	ts¦_¡©es
;

186 
_s¦_£ssiÚ
 
	ts¦_£ssiÚ
;

187 
_s¦_cÚ‹xt
 
	ts¦_cÚ‹xt
;

192 
	s_s¦_£ssiÚ


194 
time_t
 
	m¡¬t
;

195 
	mch”
;

196 
	mËngth
;

197 
	mid
[32];

198 
	mma¡”
[48];

199 
s¦_£ssiÚ
 *
	mÃxt
;

202 
	s_s¦_cÚ‹xt


207 
	m¡©e
;

209 
	mmajÜ_v”
;

210 
	mmšÜ_v”
;

212 
	mmax_majÜ_v”
;

213 
	mmax_mšÜ_v”
;

218 (*
	mf_ºg
)(*);

219 (*
	mf_dbg
)(*, , const *);

220 (*
	mf_»cv
)(*, *, );

221 (*
	mf_£nd
)(*, *, );

223 *
	mp_ºg
;

224 *
	mp_dbg
;

225 *
	mp_»cv
;

226 *
	mp_£nd
;

231 
	m»sume
;

232 
	mtimeout
;

233 
s¦_£ssiÚ
 *
	m£ssiÚ
;

234 (*
	ms_g‘
)(
	ms¦_cÚ‹xt
 *);

235 (*
	ms_£t
)(
	ms¦_cÚ‹xt
 *);

240 *
	mš_ùr
;

241 *
	mš_hdr
;

242 *
	mš_msg
;

243 *
	mš_ofá
;

245 
	mš_msgty³
;

246 
	mš_msgËn
;

247 
	mš_Ëá
;

249 
	mš_h¦’
;

250 
	mnb_z”o
;

255 *
	mout_ùr
;

256 *
	mout_hdr
;

257 *
	mout_msg
;

259 
	mout_msgty³
;

260 
	mout_msgËn
;

261 
	mout_Ëá
;

266 
r§_cÚ‹xt
 *
	mr§_key
;

267 
x509_û¹
 *
	mown_û¹
;

268 
x509_û¹
 *
	mÿ_chaš
;

269 
x509_ül
 *
	mÿ_ül
;

270 
x509_û¹
 *
	m³”_û¹
;

271 cÚ¡ *
	m³”_ú
;

273 
	m’dpošt
;

274 
	mauthmode
;

275 
	mş›Á_auth
;

276 
	mv”ify_»suÉ
;

281 
dhm_cÚ‹xt
 
	mdhm_ùx
;

282 
md5_cÚ‹xt
 
	mfš_md5
;

283 
sha1_cÚ‹xt
 
	mfš_sha1
;

285 
	mdo_üy±
;

286 *
	mch”s
;

287 
	mpm¦’
;

288 
	mkeyËn
;

289 
	mmšËn
;

290 
	mivËn
;

291 
	mmaş’
;

293 
	m¿ndby‹s
[64];

294 
	m´ema¡”
[256];

296 
	miv_’c
[16];

297 
	miv_dec
[16];

299 
	mmac_’c
[32];

300 
	mmac_dec
[32];

302 
	mùx_’c
[128];

303 
	mùx_dec
[128];

308 *
	mho¡Çme
;

309 
	mho¡Çme_Ën
;

312 #ifdeà
__ılu¥lus


316 
s¦_deçuÉ_ch”s
[];

325 
s¦_š™
Ğ
s¦_cÚ‹xt
 *
s¦
 );

333 
s¦_£t_’dpošt
Ğ
s¦_cÚ‹xt
 *
s¦
, 
’dpošt
 );

352 
s¦_£t_authmode
Ğ
s¦_cÚ‹xt
 *
s¦
, 
authmode
 );

361 
s¦_£t_ºg
Ğ
s¦_cÚ‹xt
 *
s¦
,

362 (*
f_ºg
)(*),

363 *
p_ºg
 );

372 
s¦_£t_dbg
Ğ
s¦_cÚ‹xt
 *
s¦
,

373 (*
f_dbg
)(*, , const *),

374 *
p_dbg
 );

385 
s¦_£t_bio
Ğ
s¦_cÚ‹xt
 *
s¦
,

386 (*
f_»cv
)(*, *, ), *
p_»cv
,

387 (*
f_£nd
)(*, *, ), *
p_£nd
 );

396 
s¦_£t_scb
Ğ
s¦_cÚ‹xt
 *
s¦
,

397 (*
s_g‘
)(
s¦_cÚ‹xt
 *),

398 (*
s_£t
)(
s¦_cÚ‹xt
 *) );

408 
s¦_£t_£ssiÚ
Ğ
s¦_cÚ‹xt
 *
s¦
, 
»sume
, 
timeout
,

409 
s¦_£ssiÚ
 *
£ssiÚ
 );

417 
s¦_£t_ch”s
Ğ
s¦_cÚ‹xt
 *
s¦
, *
ch”s
 );

429 
s¦_£t_ÿ_chaš
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
ÿ_chaš
,

430 
x509_ül
 *
ÿ_ül
, cÚ¡ *
³”_ú
 );

439 
s¦_£t_own_û¹
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
own_û¹
,

440 
r§_cÚ‹xt
 *
r§_key
 );

452 
s¦_£t_dh_·¿m
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
dhm_P
, cÚ¡ *
dhm_G
 );

463 
s¦_£t_ho¡Çme
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
ho¡Çme
 );

472 
s¦_g‘_by‹s_ava
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 );

485 
s¦_g‘_v”ify_»suÉ
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 );

494 cÚ¡ *
s¦_g‘_ch”
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 );

504 
s¦_hªdshake
Ğ
s¦_cÚ‹xt
 *
s¦
 );

516 
s¦_»ad
Ğ
s¦_cÚ‹xt
 *
s¦
, *
buf
, 
Ën
 );

532 
s¦_wr™e
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
buf
, 
Ën
 );

539 
s¦_şo£_nÙify
Ğ
s¦_cÚ‹xt
 *
s¦
 );

546 
s¦_ä“
Ğ
s¦_cÚ‹xt
 *
s¦
 );

551 
s¦_hªdshake_ş›Á
Ğ
s¦_cÚ‹xt
 *
s¦
 );

552 
s¦_hªdshake_£rv”
Ğ
s¦_cÚ‹xt
 *
s¦
 );

554 
s¦_d”ive_keys
Ğ
s¦_cÚ‹xt
 *
s¦
 );

555 
s¦_ÿlc_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
, 
hash
[36] );

557 
s¦_»ad_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 );

558 
s¦_ãtch_šput
Ğ
s¦_cÚ‹xt
 *
s¦
, 
nb_wªt
 );

560 
s¦_wr™e_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 );

561 
s¦_æush_ouut
Ğ
s¦_cÚ‹xt
 *
s¦
 );

563 
s¦_·r£_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 );

564 
s¦_wr™e_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 );

566 
s¦_·r£_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 );

567 
s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 );

569 
s¦_·r£_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 );

570 
s¦_wr™e_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 );

572 #ifdeà
__ılu¥lus


	@src/polarssl/ssl_cli.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_SSL_CLI_C
)

30 
	~"pŞ¬s¦/debug.h
"

31 
	~"pŞ¬s¦/s¦.h
"

33 
	~<¡ršg.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

36 
	~<time.h
>

38 
	$s¦_wr™e_ş›Á_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

40 
»t
, 
i
, 
n
;

41 *
buf
;

42 *
p
;

43 
time_t
 
t
;

45 
	`SSL_DEBUG_MSG
( 2, ( "=> write client hello" ) );

47 
s¦
->
majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

48 
s¦
->
mšÜ_v”
 = 
SSL_MINOR_VERSION_0
;

50 
s¦
->
max_majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

51 
s¦
->
max_mšÜ_v”
 = 
SSL_MINOR_VERSION_2
;

60 
buf
 = 
s¦
->
out_msg
;

61 
p
 = 
buf
 + 4;

63 *
p
++ = (è
s¦
->
max_majÜ_v”
;

64 *
p
++ = (è
s¦
->
max_mšÜ_v”
;

66 
	`SSL_DEBUG_MSG
( 3, ( "client hello, max version: [%d:%d]",

67 
buf
[4], buf[5] ) );

69 
t
 = 
	`time
Ğ
NULL
 );

70 *
p
++ = ()Ğ
t
 >> 24 );

71 *
p
++ = ()Ğ
t
 >> 16 );

72 *
p
++ = ()Ğ
t
 >> 8 );

73 *
p
++ = ()Ğ
t
 );

75 
	`SSL_DEBUG_MSG
Ğ3, ( "ş›Á h–lo, cu¼’ˆtime: %lu", 
t
 ) );

77  
i
 = 28; i > 0; i-- )

78 *
p
++ = (è
s¦
->
	`f_ºg
Ğs¦->
p_ºg
 );

80 
	`memıy
Ğ
s¦
->
¿ndby‹s
, 
buf
 + 6, 32 );

82 
	`SSL_DEBUG_BUF
Ğ3, "ş›Á h–lo,„ªdom by‹s", 
buf
 + 6, 32 );

92 
n
 = 
s¦
->
£ssiÚ
->
Ëngth
;

94 ifĞ
n
 < 16 ||‚ > 32 || 
s¦
->
»sume
 == 0 ||

95 Ğ
s¦
->
timeout
 !ğ0 && 
t
 - s¦->
£ssiÚ
->
¡¬t
 > ssl->timeout ) )

96 
n
 = 0;

98 *
p
++ = (è
n
;

100  
i
 = 0; i < 
n
; i++ )

101 *
p
++ = 
s¦
->
£ssiÚ
->
id
[
i
];

103 
	`SSL_DEBUG_MSG
Ğ3, ( "ş›Á h–lo, sessiÚ id†’.: %d", 
n
 ) );

104 
	`SSL_DEBUG_BUF
Ğ3, "ş›Á h–lo, sessiÚ id", 
buf
 + 39, 
n
 );

106  
n
 = 0; 
s¦
->
ch”s
[n] != 0;‚++ );

107 *
p
++ = ()Ğ
n
 >> 7 );

108 *
p
++ = ()Ğ
n
 << 1 );

110 
	`SSL_DEBUG_MSG
Ğ3, ( "ş›Á h–lo, gÙ %d ch”s", 
n
 ) );

112  
i
 = 0; i < 
n
; i++ )

114 
	`SSL_DEBUG_MSG
( 3, ( "client hello,‡dd cipher: %2d",

115 
s¦
->
ch”s
[
i
] ) );

117 *
p
++ = ()Ğ
s¦
->
ch”s
[
i
] >> 8 );

118 *
p
++ = ()Ğ
s¦
->
ch”s
[
i
] );

121 
	`SSL_DEBUG_MSG
( 3, ( "client hello, compress†en.: %d", 1 ) );

122 
	`SSL_DEBUG_MSG
( 3, ( "client hello, compress‡lg.: %d", 0 ) );

124 *
p
++ = 1;

125 *
p
++ = 
SSL_COMPRESS_NULL
;

127 iàĞ
s¦
->
ho¡Çme
 !ğ
NULL
 )

129 
	`SSL_DEBUG_MSG
( 3, ( "client hello, server‚ameƒxtension: %s",

130 
s¦
->
ho¡Çme
 ) );

132 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 9) >> 8 ) & 0xFF );

133 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 9) ) & 0xFF );

135 *
p
++ = ()ĞĞ
TLS_EXT_SERVERNAME
 >> 8 ) & 0xFF );

136 *
p
++ = ()ĞĞ
TLS_EXT_SERVERNAME
 ) & 0xFF );

138 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 5) >> 8 ) & 0xFF );

139 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 5) ) & 0xFF );

141 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 3) >> 8 ) & 0xFF );

142 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 3) ) & 0xFF );

144 *
p
++ = ()ĞĞ
TLS_EXT_SERVERNAME_HOSTNAME
 ) & 0xFF );

145 *
p
++ = ()ĞĞ
s¦
->
ho¡Çme_Ën
 >> 8 ) & 0xFF );

146 *
p
++ = ()ĞĞ
s¦
->
ho¡Çme_Ën
 ) & 0xFF );

148 
	`memıy
Ğ
p
, 
s¦
->
ho¡Çme
, s¦->
ho¡Çme_Ën
 );

150 
p
 +ğ
s¦
->
ho¡Çme_Ën
;

153 
s¦
->
out_msgËn
 = 
p
 - 
buf
;

154 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

155 
s¦
->
out_msg
[0] = 
SSL_HS_CLIENT_HELLO
;

157 
s¦
->
¡©e
++;

159 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

161 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

162 Ğ
»t
 );

165 
	`SSL_DEBUG_MSG
( 2, ( "<= write client hello" ) );

168 
	}
}

170 
	$s¦_·r£_£rv”_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

172 
time_t
 
t
;

173 
»t
, 
i
, 
n
;

174 
ext_Ën
;

175 *
buf
;

177 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse server hello" ) );

186 
buf
 = 
s¦
->
š_msg
;

188 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

190 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

191 Ğ
»t
 );

194 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

196 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

197 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

200 
	`SSL_DEBUG_MSG
( 3, ( "server hello, chosen version: [%d:%d]",

201 
buf
[4], buf[5] ) );

203 ifĞ
s¦
->
š_h¦’
 < 42 ||

204 
buf
[0] !ğ
SSL_HS_SERVER_HELLO
 ||

205 
buf
[4] !ğ
SSL_MAJOR_VERSION_3
 )

207 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

208 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

211 ifĞ
buf
[5] > 
s¦
->
max_mšÜ_v”
 )

213 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

214 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

217 
s¦
->
mšÜ_v”
 = 
buf
[5];

219 
t
 = ( (
time_t
è
buf
[6] << 24 )

220 | ( (
time_t
è
buf
[7] << 16 )

221 | ( (
time_t
è
buf
[8] << 8 )

222 | ( (
time_t
è
buf
[9] );

224 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32, 
buf
 + 6, 32 );

226 
n
 = 
buf
[38];

228 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, cu¼’ˆtime: %lu", 
t
 ) );

229 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo,„ªdom by‹s", 
buf
 + 6, 32 );

239 ifĞ
n
 < 0 ||‚ > 32 || 
s¦
->
š_h¦’
 > 42 +‚ )

241 
ext_Ën
 = ( ( 
buf
[42 + 
n
] << 8 )

242 | ( 
buf
[43 + 
n
] ) ) + 2;

246 
ext_Ën
 = 0;

249 ifĞ
n
 < 0 ||‚ > 32 || 
s¦
->
š_h¦’
 !ğ42 +‚ + 
ext_Ën
 )

251 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

252 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

255 
i
 = ( 
buf
[39 + 
n
] << 8 ) | buf[40 +‚];

257 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, sessiÚ id†’.: %d", 
n
 ) );

258 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo, sessiÚ id", 
buf
 + 39, 
n
 );

263 ifĞ
s¦
->
»sume
 =ğ0 || 
n
 == 0 ||

264 
s¦
->
£ssiÚ
->
ch”
 !ğ
i
 ||

265 
s¦
->
£ssiÚ
->
Ëngth
 !ğ
n
 ||

266 
	`memcmp
Ğ
s¦
->
£ssiÚ
->
id
, 
buf
 + 39, 
n
 ) != 0 )

268 
s¦
->
¡©e
++;

269 
s¦
->
»sume
 = 0;

270 
s¦
->
£ssiÚ
->
¡¬t
 = 
	`time
Ğ
NULL
 );

271 
s¦
->
£ssiÚ
->
ch”
 = 
i
;

272 
s¦
->
£ssiÚ
->
Ëngth
 = 
n
;

273 
	`memıy
Ğ
s¦
->
£ssiÚ
->
id
, 
buf
 + 39, 
n
 );

277 
s¦
->
¡©e
 = 
SSL_SERVER_CHANGE_CIPHER_SPEC
;

279 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

281 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

282 Ğ
»t
 );

286 
	`SSL_DEBUG_MSG
( 3, ( "%s session has been„esumed",

287 
s¦
->
»sume
 ? "a" : "no" ) );

289 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, cho£Àch”: %d", 
i
 ) );

290 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, com´es ®g.: %d", 
buf
[41 + 
n
] ) );

292 
i
 = 0;

295 ifĞ
s¦
->
ch”s
[
i
] == 0 )

297 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

298 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

301 ifĞ
s¦
->
ch”s
[
i
++] =ğs¦->
£ssiÚ
->
ch”
 )

305 ifĞ
buf
[41 + 
n
] !ğ
SSL_COMPRESS_NULL
 )

307 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

308 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

313 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse server hello" ) );

316 
	}
}

318 
	$s¦_·r£_£rv”_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

320 
»t
, 
n
;

321 *
p
, *
’d
;

322 
hash
[36];

323 
md5_cÚ‹xt
 
md5
;

324 
sha1_cÚ‹xt
 
sha1
;

326 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse server keyƒxchange" ) );

328 ifĞ
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_DES_168_SHA
 &&

329 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_128_SHA
 &&

330 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_256_SHA
 &&

331 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 &&

332 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

334 
	`SSL_DEBUG_MSG
( 2, ( "<= skip…arse server keyƒxchange" ) );

335 
s¦
->
¡©e
++;

339 #ià!
	`defšed
(
POLARSSL_DHM_C
)

340 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm in‚ot‡vailable" ) );

341 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

343 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

345 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

346 Ğ
»t
 );

349 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

351 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

352 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

355 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_SERVER_KEY_EXCHANGE
 )

357 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

358 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

370 
p
 = 
s¦
->
š_msg
 + 4;

371 
’d
 = 
s¦
->
š_msg
 + s¦->
š_h¦’
;

373 ifĞĞ
»t
 = 
	`dhm_»ad_·¿ms
Ğ&
s¦
->
dhm_ùx
, &
p
, 
’d
 ) ) != 0 )

375 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

376 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

379 ifĞ()Ğ
’d
 - 
p
 ) !ğ
s¦
->
³”_û¹
->
r§
.
Ën
 )

381 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

382 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

385 ifĞ
s¦
->
dhm_ùx
.
Ën
 < 64 || ssl->dhm_ctx.len > 256 )

387 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

388 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

391 
	`SSL_DEBUG_MPI
Ğ3, "DHM: P ", &
s¦
->
dhm_ùx
.
P
 );

392 
	`SSL_DEBUG_MPI
Ğ3, "DHM: G ", &
s¦
->
dhm_ùx
.
G
 );

393 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GY", &
s¦
->
dhm_ùx
.
GY
 );

408 
n
 = 
s¦
->
š_h¦’
 - ( 
’d
 - 
p
 ) - 6;

410 
	`md5_¡¬ts
Ğ&
md5
 );

411 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
¿ndby‹s
, 64 );

412 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
š_msg
 + 4, 
n
 );

413 
	`md5_fšish
Ğ&
md5
, 
hash
 );

415 
	`sha1_¡¬ts
Ğ&
sha1
 );

416 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

417 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
š_msg
 + 4, 
n
 );

418 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

420 
	`SSL_DEBUG_BUF
Ğ3, "·¿m‘” hash", 
hash
, 36 );

422 ifĞĞ
»t
 = 
	`r§_pkcs1_v”ify
Ğ&
s¦
->
³”_û¹
->
r§
, 
RSA_PUBLIC
,

423 
SIG_RSA_RAW
, 36, 
hash
, 
p
 ) ) != 0 )

425 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_v”ify", 
»t
 );

426 Ğ
»t
 );

429 
s¦
->
¡©e
++;

431 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse server keyƒxchange" ) );

435 
	}
}

437 
	$s¦_·r£_û¹ifiÿ‹_»que¡
Ğ
s¦_cÚ‹xt
 *
s¦
 )

439 
»t
;

441 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse certificate„equest" ) );

454 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

456 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

457 Ğ
»t
 );

460 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

462 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate„equest message" ) );

463 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

466 
s¦
->
ş›Á_auth
 = 0;

467 
s¦
->
¡©e
++;

469 ifĞ
s¦
->
š_msg
[0] =ğ
SSL_HS_CERTIFICATE_REQUEST
 )

470 
s¦
->
ş›Á_auth
++;

472 
	`SSL_DEBUG_MSG
( 3, ( "got %s certificate„equest",

473 
s¦
->
ş›Á_auth
 ? "a" : "no" ) );

475 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse certificate„equest" ) );

478 
	}
}

480 
	$s¦_·r£_£rv”_h–lo_dÚe
Ğ
s¦_cÚ‹xt
 *
s¦
 )

482 
»t
;

484 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse server hello done" ) );

486 ifĞ
s¦
->
ş›Á_auth
 != 0 )

488 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

490 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

491 Ğ
»t
 );

494 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

496 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello done message" ) );

497 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

501 ifĞ
s¦
->
š_h¦’
 != 4 ||

502 
s¦
->
š_msg
[0] !ğ
SSL_HS_SERVER_HELLO_DONE
 )

504 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello done message" ) );

505 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO_DONE
 );

508 
s¦
->
¡©e
++;

510 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse server hello done" ) );

513 
	}
}

515 
	$s¦_wr™e_ş›Á_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

517 
»t
, 
i
, 
n
;

519 
	`SSL_DEBUG_MSG
( 2, ( "=> write client keyƒxchange" ) );

521 ifĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_DES_168_SHA
 ||

522 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

523 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
 ||

524 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

525 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

527 #ià!
	`defšed
(
POLARSSL_DHM_C
)

528 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm in‚ot‡vailable" ) );

529 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

534 
n
 = 
s¦
->
dhm_ùx
.
Ën
;

536 
s¦
->
out_msg
[4] = ()Ğ
n
 >> 8 );

537 
s¦
->
out_msg
[5] = ()Ğ
n
 );

538 
i
 = 6;

540 
»t
 = 
	`dhm_make_public
Ğ&
s¦
->
dhm_ùx
, 256,

541 &
s¦
->
out_msg
[
i
], 
n
,

542 
s¦
->
f_ºg
, s¦->
p_ºg
 );

543 ifĞ
»t
 != 0 )

545 
	`SSL_DEBUG_RET
Ğ1, "dhm_make_public", 
»t
 );

546 Ğ
»t
 );

549 
	`SSL_DEBUG_MPI
Ğ3, "DHM: X ", &
s¦
->
dhm_ùx
.
X
 );

550 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GX", &
s¦
->
dhm_ùx
.
GX
 );

552 
s¦
->
pm¦’
 = s¦->
dhm_ùx
.
Ën
;

554 ifĞĞ
»t
 = 
	`dhm_ÿlc_£ü‘
Ğ&
s¦
->
dhm_ùx
,

555 
s¦
->
´ema¡”
,

556 &
s¦
->
pm¦’
 ) ) != 0 )

558 
	`SSL_DEBUG_RET
Ğ1, "dhm_ÿlc_£ü‘", 
»t
 );

559 Ğ
»t
 );

562 
	`SSL_DEBUG_MPI
Ğ3, "DHM: K ", &
s¦
->
dhm_ùx
.
K
 );

570 
s¦
->
´ema¡”
[0] = (ès¦->
max_majÜ_v”
;

571 
s¦
->
´ema¡”
[1] = (ès¦->
max_mšÜ_v”
;

572 
s¦
->
pm¦’
 = 48;

574  
i
 = 2; i < 
s¦
->
pm¦’
; i++ )

575 
s¦
->
´ema¡”
[
i
] = (ès¦->
	`f_ºg
Ğs¦->
p_ºg
 );

577 
i
 = 4;

578 
n
 = 
s¦
->
³”_û¹
->
r§
.
Ën
;

580 ifĞ
s¦
->
mšÜ_v”
 !ğ
SSL_MINOR_VERSION_0
 )

582 
i
 += 2;

583 
s¦
->
out_msg
[4] = ()Ğ
n
 >> 8 );

584 
s¦
->
out_msg
[5] = ()Ğ
n
 );

587 
»t
 = 
	`r§_pkcs1_’üy±
Ğ&
s¦
->
³”_û¹
->
r§
,

588 
s¦
->
f_ºg
, s¦->
p_ºg
,

589 
RSA_PUBLIC
,

590 
s¦
->
pm¦’
, s¦->
´ema¡”
,

591 
s¦
->
out_msg
 + 
i
 );

592 ifĞ
»t
 != 0 )

594 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_’üy±", 
»t
 );

595 Ğ
»t
 );

599 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

601 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

602 Ğ
»t
 );

605 
s¦
->
out_msgËn
 = 
i
 + 
n
;

606 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

607 
s¦
->
out_msg
[0] = 
SSL_HS_CLIENT_KEY_EXCHANGE
;

609 
s¦
->
¡©e
++;

611 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

613 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

614 Ğ
»t
 );

617 
	`SSL_DEBUG_MSG
( 2, ( "<= write client keyƒxchange" ) );

620 
	}
}

622 
	$s¦_wr™e_û¹ifiÿ‹_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
 )

624 
»t
, 
n
;

625 
hash
[36];

627 
	`SSL_DEBUG_MSG
( 2, ( "=> write certificate verify" ) );

629 ifĞ
s¦
->
ş›Á_auth
 =ğ0 || s¦->
own_û¹
 =ğ
NULL
 )

631 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write certificate verify" ) );

632 
s¦
->
¡©e
++;

636 ifĞ
s¦
->
r§_key
 =ğ
NULL
 )

638 
	`SSL_DEBUG_MSG
( 1, ( "got‚o…rivate key" ) );

639 Ğ
POLARSSL_ERR_SSL_PRIVATE_KEY_REQUIRED
 );

645 
	`s¦_ÿlc_v”ify
Ğ
s¦
, 
hash
 );

647 
n
 = 
s¦
->
r§_key
->
Ën
;

648 
s¦
->
out_msg
[4] = ()Ğ
n
 >> 8 );

649 
s¦
->
out_msg
[5] = ()Ğ
n
 );

651 ifĞĞ
»t
 = 
	`r§_pkcs1_sign
Ğ
s¦
->
r§_key
, 
RSA_PRIVATE
, 
SIG_RSA_RAW
,

652 36, 
hash
, 
s¦
->
out_msg
 + 6 ) ) != 0 )

654 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_sign", 
»t
 );

655 Ğ
»t
 );

658 
s¦
->
out_msgËn
 = 6 + 
n
;

659 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

660 
s¦
->
out_msg
[0] = 
SSL_HS_CERTIFICATE_VERIFY
;

662 
s¦
->
¡©e
++;

664 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

666 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

667 Ğ
»t
 );

670 
	`SSL_DEBUG_MSG
( 2, ( "<= write certificate verify" ) );

673 
	}
}

678 
	$s¦_hªdshake_ş›Á
Ğ
s¦_cÚ‹xt
 *
s¦
 )

680 
»t
 = 0;

682 
	`SSL_DEBUG_MSG
( 2, ( "=> handshake client" ) );

684  
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

686 
	`SSL_DEBUG_MSG
Ğ2, ( "ş›Á s‹: %d", 
s¦
->
¡©e
 ) );

688 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

691  
s¦
->
¡©e
 )

693 
SSL_HELLO_REQUEST
:

694 
s¦
->
¡©e
 = 
SSL_CLIENT_HELLO
;

700 
SSL_CLIENT_HELLO
:

701 
»t
 = 
	`s¦_wr™e_ş›Á_h–lo
Ğ
s¦
 );

711 
SSL_SERVER_HELLO
:

712 
»t
 = 
	`s¦_·r£_£rv”_h–lo
Ğ
s¦
 );

715 
SSL_SERVER_CERTIFICATE
:

716 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹
Ğ
s¦
 );

719 
SSL_SERVER_KEY_EXCHANGE
:

720 
»t
 = 
	`s¦_·r£_£rv”_key_exchªge
Ğ
s¦
 );

723 
SSL_CERTIFICATE_REQUEST
:

724 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹_»que¡
Ğ
s¦
 );

727 
SSL_SERVER_HELLO_DONE
:

728 
»t
 = 
	`s¦_·r£_£rv”_h–lo_dÚe
Ğ
s¦
 );

738 
SSL_CLIENT_CERTIFICATE
:

739 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹
Ğ
s¦
 );

742 
SSL_CLIENT_KEY_EXCHANGE
:

743 
»t
 = 
	`s¦_wr™e_ş›Á_key_exchªge
Ğ
s¦
 );

746 
SSL_CERTIFICATE_VERIFY
:

747 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹_v”ify
Ğ
s¦
 );

750 
SSL_CLIENT_CHANGE_CIPHER_SPEC
:

751 
»t
 = 
	`s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦
 );

754 
SSL_CLIENT_FINISHED
:

755 
»t
 = 
	`s¦_wr™e_fšished
Ğ
s¦
 );

762 
SSL_SERVER_CHANGE_CIPHER_SPEC
:

763 
»t
 = 
	`s¦_·r£_chªge_ch”_¥ec
Ğ
s¦
 );

766 
SSL_SERVER_FINISHED
:

767 
»t
 = 
	`s¦_·r£_fšished
Ğ
s¦
 );

770 
SSL_FLUSH_BUFFERS
:

771 
	`SSL_DEBUG_MSG
( 2, ( "handshake: done" ) );

772 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

776 
	`SSL_DEBUG_MSG
Ğ1, ( "šv®id s‹ %d", 
s¦
->
¡©e
 ) );

777 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

780 ifĞ
»t
 != 0 )

784 
	`SSL_DEBUG_MSG
( 2, ( "<= handshake client" ) );

786 Ğ
»t
 );

787 
	}
}

	@src/polarssl/ssl_srv.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_SSL_SRV_C
)

30 
	~"pŞ¬s¦/debug.h
"

31 
	~"pŞ¬s¦/s¦.h
"

33 
	~<¡ršg.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

36 
	~<time.h
>

38 
	$s¦_·r£_ş›Á_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

40 
»t
, 
i
, 
j
, 
n
;

41 
ch_Ën
, 
£ss_Ën
;

42 
ch®_Ën
, 
comp_Ën
;

43 *
buf
, *
p
;

45 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse client hello" ) );

47 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 ) ) != 0 )

49 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

50 Ğ
»t
 );

53 
buf
 = 
s¦
->
š_hdr
;

55 ifĞĞ
buf
[0] & 0x80 ) != 0 )

57 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd h—d”", 
buf
, 5 );

59 
	`SSL_DEBUG_MSG
( 3, ( "client hello v2, messageype: %d",

60 
buf
[2] ) );

61 
	`SSL_DEBUG_MSG
( 3, ( "client hello v2, message†en.: %d",

62 ĞĞ
buf
[0] & 0x7F ) << 8 ) | buf[1] ) );

63 
	`SSL_DEBUG_MSG
( 3, ( "client hello v2, max. version: [%d:%d]",

64 
buf
[3], buf[4] ) );

76 ifĞ
buf
[2] !ğ
SSL_HS_CLIENT_HELLO
 ||

77 
buf
[3] !ğ
SSL_MAJOR_VERSION_3
 )

79 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

80 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

83 
n
 = ( ( 
buf
[0] << 8 ) | buf[1] ) & 0x7FFF;

85 ifĞ
n
 < 17 ||‚ > 512 )

87 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

88 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

91 
s¦
->
max_majÜ_v”
 = 
buf
[3];

92 
s¦
->
max_mšÜ_v”
 = 
buf
[4];

94 
s¦
->
majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

95 
s¦
->
mšÜ_v”
 = ( 
buf
[4] <ğ
SSL_MINOR_VERSION_2
 )

96 ? 
buf
[4] : 
SSL_MINOR_VERSION_2
;

98 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 2 + 
n
 ) ) != 0 )

100 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

101 Ğ
»t
 );

104 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , 
buf
 + 2, 
n
 );

105 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, 
buf
 + 2, 
n
 );

107 
buf
 = 
s¦
->
š_msg
;

108 
n
 = 
s¦
->
š_Ëá
 - 5;

118 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd cÚ‹Ás", 
buf
, 
n
 );

120 
ch_Ën
 = ( 
buf
[0] << 8 ) | buf[1];

121 
£ss_Ën
 = ( 
buf
[2] << 8 ) | buf[3];

122 
ch®_Ën
 = ( 
buf
[4] << 8 ) | buf[5];

124 
	`SSL_DEBUG_MSG
( 3, ( "ciph_len: %d, sess_len: %d, chal_len: %d",

125 
ch_Ën
, 
£ss_Ën
, 
ch®_Ën
 ) );

130 ifĞ
ch_Ën
 < 3 || ( ciph_len % 3 ) != 0 )

132 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

133 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

136 ifĞ
£ss_Ën
 < 0 || sess_len > 32 )

138 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

139 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

142 ifĞ
ch®_Ën
 < 8 || chal_len > 32 )

144 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

145 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

148 ifĞ
n
 !ğ6 + 
ch_Ën
 + 
£ss_Ën
 + 
ch®_Ën
 )

150 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

151 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

154 
	`SSL_DEBUG_BUF
( 3, "client hello, cipherlist",

155 
buf
 + 6, 
ch_Ën
 );

156 
	`SSL_DEBUG_BUF
( 3, "client hello, session id",

157 
buf
 + 6 + 
ch_Ën
, 
£ss_Ën
 );

158 
	`SSL_DEBUG_BUF
( 3, "client hello, challenge",

159 
buf
 + 6 + 
ch_Ën
 + 
£ss_Ën
, 
ch®_Ën
 );

161 
p
 = 
buf
 + 6 + 
ch_Ën
;

162 
s¦
->
£ssiÚ
->
Ëngth
 = 
£ss_Ën
;

163 
	`mem£t
Ğ
s¦
->
£ssiÚ
->
id
, 0, ( ssl->session->id ) );

164 
	`memıy
Ğ
s¦
->
£ssiÚ
->
id
, 
p
, s¦->£ssiÚ->
Ëngth
 );

166 
p
 +ğ
£ss_Ën
;

167 
	`mem£t
Ğ
s¦
->
¿ndby‹s
, 0, 64 );

168 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32 - 
ch®_Ën
, 
p
, chal_len );

170  
i
 = 0; 
s¦
->
ch”s
[i] != 0; i++ )

172  
j
 = 0, 
p
 = 
buf
 + 6; j < 
ch_Ën
; j += 3,… += 3 )

174 ifĞ
p
[0] == 0 &&

175 
p
[1] == 0 &&

176 
p
[2] =ğ
s¦
->
ch”s
[
i
] )

177 
have_ch”
;

183 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd h—d”", 
buf
, 5 );

185 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, messageype: %d",

186 
buf
[0] ) );

187 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, message†en.: %d",

188 Ğ
buf
[3] << 8 ) | buf[4] ) );

189 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3,…rotocol ver: [%d:%d]",

190 
buf
[1], buf[2] ) );

200 ifĞ
buf
[0] !ğ
SSL_MSG_HANDSHAKE
 ||

201 
buf
[1] !ğ
SSL_MAJOR_VERSION_3
 )

203 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

204 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

207 
n
 = ( 
buf
[3] << 8 ) | buf[4];

209 ifĞ
n
 < 45 ||‚ > 512 )

211 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

212 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

215 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 + 
n
 ) ) != 0 )

217 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

218 Ğ
»t
 );

221 
buf
 = 
s¦
->
š_msg
;

222 
n
 = 
s¦
->
š_Ëá
 - 5;

224 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , 
buf
, 
n
 );

225 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, 
buf
, 
n
 );

241 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd cÚ‹Ás", 
buf
, 
n
 );

243 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, handshakeype: %d",

244 
buf
[0] ) );

245 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, handshake†en.: %d",

246 Ğ
buf
[1] << 16 ) | ( buf[2] << 8 ) | buf[3] ) );

247 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, max. version: [%d:%d]",

248 
buf
[4], buf[5] ) );

253 ifĞ
buf
[0] !ğ
SSL_HS_CLIENT_HELLO
 ||

254 
buf
[4] !ğ
SSL_MAJOR_VERSION_3
 )

256 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

257 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

260 
s¦
->
majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

261 
s¦
->
mšÜ_v”
 = ( 
buf
[5] <ğ
SSL_MINOR_VERSION_2
 )

262 ? 
buf
[5] : 
SSL_MINOR_VERSION_2
;

264 
s¦
->
max_majÜ_v”
 = 
buf
[4];

265 
s¦
->
max_mšÜ_v”
 = 
buf
[5];

267 
	`memıy
Ğ
s¦
->
¿ndby‹s
, 
buf
 + 6, 32 );

272 ifĞ
buf
[1] !ğ0 || 
n
 != 4 + ( ( buf[2] << 8 ) | buf[3] ) )

274 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

275 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

281 
£ss_Ën
 = 
buf
[38];

283 ifĞ
£ss_Ën
 < 0 || sess_len > 32 )

285 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

286 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

289 
s¦
->
£ssiÚ
->
Ëngth
 = 
£ss_Ën
;

290 
	`mem£t
Ğ
s¦
->
£ssiÚ
->
id
, 0, ( ssl->session->id ) );

291 
	`memıy
Ğ
s¦
->
£ssiÚ
->
id
, 
buf
 + 39 , s¦->£ssiÚ->
Ëngth
 );

296 
ch_Ën
 = ( 
buf
[39 + 
£ss_Ën
] << 8 )

297 | ( 
buf
[40 + 
£ss_Ën
] );

299 ifĞ
ch_Ën
 < 2 || ciph_len > 256 || ( ciph_len % 2 ) != 0 )

301 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

302 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

308 
comp_Ën
 = 
buf
[41 + 
£ss_Ën
 + 
ch_Ën
];

310 ifĞ
comp_Ën
 < 1 || comp_len > 16 )

312 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

313 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

316 
	`SSL_DEBUG_BUF
( 3, "client hello,„andom bytes",

317 
buf
 + 6, 32 );

318 
	`SSL_DEBUG_BUF
( 3, "client hello, session id",

319 
buf
 + 38, 
£ss_Ën
 );

320 
	`SSL_DEBUG_BUF
( 3, "client hello, cipherlist",

321 
buf
 + 41 + 
£ss_Ën
, 
ch_Ën
 );

322 
	`SSL_DEBUG_BUF
( 3, "client hello, compression",

323 
buf
 + 42 + 
£ss_Ën
 + 
ch_Ën
, 
comp_Ën
 );

328  
i
 = 0; 
s¦
->
ch”s
[i] != 0; i++ )

330  
j
 = 0, 
p
 = 
buf
 + 41 + 
£ss_Ën
; j < 
ch_Ën
;

331 
j
 +ğ2, 
p
 += 2 )

333 ifĞ
p
[0] =ğ0 &&…[1] =ğ
s¦
->
ch”s
[
i
] )

334 
have_ch”
;

339 
	`SSL_DEBUG_MSG
( 1, ( "got‚o ciphers in common" ) );

341 Ğ
POLARSSL_ERR_SSL_NO_CIPHER_CHOSEN
 );

343 
have_ch”
:

345 
s¦
->
£ssiÚ
->
ch”
 = s¦->
ch”s
[
i
];

346 
s¦
->
š_Ëá
 = 0;

347 
s¦
->
¡©e
++;

349 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse client hello" ) );

352 
	}
}

354 
	$s¦_wr™e_£rv”_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

356 
time_t
 
t
;

357 
»t
, 
i
, 
n
;

358 *
buf
, *
p
;

360 
	`SSL_DEBUG_MSG
( 2, ( "=> write server hello" ) );

369 
buf
 = 
s¦
->
out_msg
;

370 
p
 = 
buf
 + 4;

372 *
p
++ = (è
s¦
->
majÜ_v”
;

373 *
p
++ = (è
s¦
->
mšÜ_v”
;

375 
	`SSL_DEBUG_MSG
( 3, ( "server hello, chosen version: [%d:%d]",

376 
buf
[4], buf[5] ) );

378 
t
 = 
	`time
Ğ
NULL
 );

379 *
p
++ = ()Ğ
t
 >> 24 );

380 *
p
++ = ()Ğ
t
 >> 16 );

381 *
p
++ = ()Ğ
t
 >> 8 );

382 *
p
++ = ()Ğ
t
 );

384 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, cu¼’ˆtime: %lu", 
t
 ) );

386  
i
 = 28; i > 0; i-- )

387 *
p
++ = (è
s¦
->
	`f_ºg
Ğs¦->
p_ºg
 );

389 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32, 
buf
 + 6, 32 );

391 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo,„ªdom by‹s", 
buf
 + 6, 32 );

399 
s¦
->
£ssiÚ
->
Ëngth
 = 
n
 = 32;

400 *
p
++ = (è
s¦
->
£ssiÚ
->
Ëngth
;

402 ifĞ
s¦
->
s_g‘
 =ğ
NULL
 ||

403 
s¦
->
	`s_g‘
( ssl ) != 0 )

408 
s¦
->
»sume
 = 0;

409 
s¦
->
¡©e
++;

411  
i
 = 0; i < 
n
; i++ )

412 
s¦
->
£ssiÚ
->
id
[
i
] =

413 (è
s¦
->
	`f_ºg
Ğs¦->
p_ºg
 );

420 
s¦
->
»sume
 = 1;

421 
s¦
->
¡©e
 = 
SSL_SERVER_CHANGE_CIPHER_SPEC
;

423 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

425 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

426 Ğ
»t
 );

430 
	`memıy
Ğ
p
, 
s¦
->
£ssiÚ
->
id
, s¦->£ssiÚ->
Ëngth
 );

431 
p
 +ğ
s¦
->
£ssiÚ
->
Ëngth
;

433 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, sessiÚ id†’.: %d", 
n
 ) );

434 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo, sessiÚ id", 
buf
 + 39, 
n
 );

435 
	`SSL_DEBUG_MSG
( 3, ( "%s session has been„esumed",

436 
s¦
->
»sume
 ? "a" : "no" ) );

438 *
p
++ = ()Ğ
s¦
->
£ssiÚ
->
ch”
 >> 8 );

439 *
p
++ = ()Ğ
s¦
->
£ssiÚ
->
ch”
 );

440 *
p
++ = 
SSL_COMPRESS_NULL
;

442 
	`SSL_DEBUG_MSG
( 3, ( "server hello, chosen cipher: %d",

443 
s¦
->
£ssiÚ
->
ch”
 ) );

444 
	`SSL_DEBUG_MSG
( 3, ( "server hello, compress‡lg.: %d", 0 ) );

446 
s¦
->
out_msgËn
 = 
p
 - 
buf
;

447 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

448 
s¦
->
out_msg
[0] = 
SSL_HS_SERVER_HELLO
;

450 
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 );

452 
	`SSL_DEBUG_MSG
( 2, ( "<= write server hello" ) );

454 Ğ
»t
 );

455 
	}
}

457 
	$s¦_wr™e_û¹ifiÿ‹_»que¡
Ğ
s¦_cÚ‹xt
 *
s¦
 )

459 
»t
, 
n
;

460 *
buf
, *
p
;

461 cÚ¡ 
x509_û¹
 *
üt
;

463 
	`SSL_DEBUG_MSG
( 2, ( "=> write certificate„equest" ) );

465 
s¦
->
¡©e
++;

467 ifĞ
s¦
->
authmode
 =ğ
SSL_VERIFY_NONE
 )

469 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write certificate„equest" ) );

483 
buf
 = 
s¦
->
out_msg
;

484 
p
 = 
buf
 + 4;

489 *
p
++ = 1;

490 *
p
++ = 1;

492 
p
 += 2;

493 
üt
 = 
s¦
->
ÿ_chaš
;

495  
üt
 !ğ
NULL
 )

497 ifĞ
p
 - 
buf
 > 4096 )

500 
n
 = 
üt
->
subjeù_¿w
.
Ën
;

501 *
p
++ = ()Ğ
n
 >> 8 );

502 *
p
++ = ()Ğ
n
 );

503 
	`memıy
Ğ
p
, 
üt
->
subjeù_¿w
.p, 
n
 );

505 
	`SSL_DEBUG_BUF
Ğ3, "»que¡ed DN", 
p
, 
n
 );

506 
p
 +ğ
n
; 
üt
 = c¹->
Ãxt
;

509 
s¦
->
out_msgËn
 = 
n
 = 
p
 - 
buf
;

510 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

511 
s¦
->
out_msg
[0] = 
SSL_HS_CERTIFICATE_REQUEST
;

512 
s¦
->
out_msg
[6] = ()ĞĞ
n
 - 8 ) >> 8 );

513 
s¦
->
out_msg
[7] = ()ĞĞ
n
 - 8 ) );

515 
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 );

517 
	`SSL_DEBUG_MSG
( 2, ( "<= write certificate„equest" ) );

519 Ğ
»t
 );

520 
	}
}

522 
	$s¦_wr™e_£rv”_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

524 
»t
, 
n
;

525 
hash
[36];

526 
md5_cÚ‹xt
 
md5
;

527 
sha1_cÚ‹xt
 
sha1
;

529 
	`SSL_DEBUG_MSG
( 2, ( "=> write server keyƒxchange" ) );

531 ifĞ
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_DES_168_SHA
 &&

532 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_128_SHA
 &&

533 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_256_SHA
 &&

534 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 &&

535 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

537 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write server keyƒxchange" ) );

538 
s¦
->
¡©e
++;

542 #ià!
	`defšed
(
POLARSSL_DHM_C
)

543 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm is‚ot‡vailable" ) );

544 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

555 ifĞĞ
»t
 = 
	`dhm_make_·¿ms
Ğ&
s¦
->
dhm_ùx
, 256, s¦->
out_msg
 + 4,

556 &
n
, 
s¦
->
f_ºg
, s¦->
p_ºg
 ) ) != 0 )

558 
	`SSL_DEBUG_RET
Ğ1, "dhm_make_·¿ms", 
»t
 );

559 Ğ
»t
 );

562 
	`SSL_DEBUG_MPI
Ğ3, "DHM: X ", &
s¦
->
dhm_ùx
.
X
 );

563 
	`SSL_DEBUG_MPI
Ğ3, "DHM: P ", &
s¦
->
dhm_ùx
.
P
 );

564 
	`SSL_DEBUG_MPI
Ğ3, "DHM: G ", &
s¦
->
dhm_ùx
.
G
 );

565 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GX", &
s¦
->
dhm_ùx
.
GX
 );

580 
	`md5_¡¬ts
Ğ&
md5
 );

581 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
¿ndby‹s
, 64 );

582 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
out_msg
 + 4, 
n
 );

583 
	`md5_fšish
Ğ&
md5
, 
hash
 );

585 
	`sha1_¡¬ts
Ğ&
sha1
 );

586 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

587 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
out_msg
 + 4, 
n
 );

588 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

590 
	`SSL_DEBUG_BUF
Ğ3, "·¿m‘” hash", 
hash
, 36 );

592 
s¦
->
out_msg
[4 + 
n
] = ()Ğs¦->
r§_key
->
Ën
 >> 8 );

593 
s¦
->
out_msg
[5 + 
n
] = ()Ğs¦->
r§_key
->
Ën
 );

595 
»t
 = 
	`r§_pkcs1_sign
Ğ
s¦
->
r§_key
, 
RSA_PRIVATE
,

596 
SIG_RSA_RAW
, 36, 
hash
, 
s¦
->
out_msg
 + 6 + 
n
 );

597 ifĞ
»t
 != 0 )

599 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_sign", 
»t
 );

600 Ğ
»t
 );

603 
	`SSL_DEBUG_BUF
Ğ3, "my RSA sig", 
s¦
->
out_msg
 + 6 + 
n
,

604 
s¦
->
r§_key
->
Ën
 );

606 
s¦
->
out_msgËn
 = 6 + 
n
 + s¦->
r§_key
->
Ën
;

607 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

608 
s¦
->
out_msg
[0] = 
SSL_HS_SERVER_KEY_EXCHANGE
;

610 
s¦
->
¡©e
++;

612 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

614 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

615 Ğ
»t
 );

618 
	`SSL_DEBUG_MSG
( 2, ( "<= write server keyƒxchange" ) );

622 
	}
}

624 
	$s¦_wr™e_£rv”_h–lo_dÚe
Ğ
s¦_cÚ‹xt
 *
s¦
 )

626 
»t
;

628 
	`SSL_DEBUG_MSG
( 2, ( "=> write server hello done" ) );

630 
s¦
->
out_msgËn
 = 4;

631 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

632 
s¦
->
out_msg
[0] = 
SSL_HS_SERVER_HELLO_DONE
;

634 
s¦
->
¡©e
++;

636 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

638 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

639 Ğ
»t
 );

642 
	`SSL_DEBUG_MSG
( 2, ( "<= write server hello done" ) );

645 
	}
}

647 
	$s¦_·r£_ş›Á_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

649 
»t
, 
i
, 
n
;

651 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse client keyƒxchange" ) );

653 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

655 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

656 Ğ
»t
 );

659 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

661 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

662 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

665 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_CLIENT_KEY_EXCHANGE
 )

667 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

668 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

671 ifĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_DES_168_SHA
 ||

672 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

673 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
 ||

674 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

675 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

677 #ià!
	`defšed
(
POLARSSL_DHM_C
)

678 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm is‚ot‡vailable" ) );

679 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

684 
n
 = ( 
s¦
->
š_msg
[4] << 8 ) | ssl->in_msg[5];

686 ifĞ
n
 < 1 ||‚ > 
s¦
->
dhm_ùx
.
Ën
 ||

687 
n
 + 6 !ğ
s¦
->
š_h¦’
 )

689 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

690 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

693 ifĞĞ
»t
 = 
	`dhm_»ad_public
Ğ&
s¦
->
dhm_ùx
,

694 
s¦
->
š_msg
 + 6, 
n
 ) ) != 0 )

696 
	`SSL_DEBUG_RET
Ğ1, "dhm_»ad_public", 
»t
 );

697 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 | 
»t
 );

700 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GY", &
s¦
->
dhm_ùx
.
GY
 );

702 
s¦
->
pm¦’
 = s¦->
dhm_ùx
.
Ën
;

704 ifĞĞ
»t
 = 
	`dhm_ÿlc_£ü‘
Ğ&
s¦
->
dhm_ùx
,

705 
s¦
->
´ema¡”
, &s¦->
pm¦’
 ) ) != 0 )

707 
	`SSL_DEBUG_RET
Ğ1, "dhm_ÿlc_£ü‘", 
»t
 );

708 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 | 
»t
 );

711 
	`SSL_DEBUG_MPI
Ğ3, "DHM: K ", &
s¦
->
dhm_ùx
.
K
 );

719 
i
 = 4;

720 
n
 = 
s¦
->
r§_key
->
Ën
;

721 
s¦
->
pm¦’
 = 48;

723 ifĞ
s¦
->
mšÜ_v”
 !ğ
SSL_MINOR_VERSION_0
 )

725 
i
 += 2;

726 ifĞ
s¦
->
š_msg
[4] !ğĞĞ
n
 >> 8 ) & 0xFF ) ||

727 
s¦
->
š_msg
[5] !ğĞĞ
n
 ) & 0xFF ) )

729 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

730 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

734 ifĞ
s¦
->
š_h¦’
 !ğ
i
 + 
n
 )

736 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

737 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

740 
»t
 = 
	`r§_pkcs1_deüy±
Ğ
s¦
->
r§_key
, 
RSA_PRIVATE
, &s¦->
pm¦’
,

741 
s¦
->
š_msg
 + 
i
, s¦->
´ema¡”
,

742 (
s¦
->
´ema¡”
) );

744 ifĞ
»t
 !ğ0 || 
s¦
->
pm¦’
 != 48 ||

745 
s¦
->
´ema¡”
[0] !ğs¦->
max_majÜ_v”
 ||

746 
s¦
->
´ema¡”
[1] !ğs¦->
max_mšÜ_v”
 )

748 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

756 
s¦
->
pm¦’
 = 48;

758  
i
 = 0; i < 
s¦
->
pm¦’
; i++ )

759 
s¦
->
´ema¡”
[
i
] = (ès¦->
	`f_ºg
Ğs¦->
p_ºg
 );

763 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

765 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

766 Ğ
»t
 );

769 ifĞ
s¦
->
s_£t
 !ğ
NULL
 )

770 
s¦
->
	`s_£t
( ssl );

772 
s¦
->
¡©e
++;

774 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse client keyƒxchange" ) );

777 
	}
}

779 
	$s¦_·r£_û¹ifiÿ‹_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
 )

781 
n1
, 
n2
, 
»t
;

782 
hash
[36];

784 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse certificate verify" ) );

786 ifĞ
s¦
->
³”_û¹
 =ğ
NULL
 )

788 
	`SSL_DEBUG_MSG
( 2, ( "<= skip…arse certificate verify" ) );

789 
s¦
->
¡©e
++;

793 
	`s¦_ÿlc_v”ify
Ğ
s¦
, 
hash
 );

795 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

797 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

798 Ğ
»t
 );

801 
s¦
->
¡©e
++;

803 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

805 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate verify message" ) );

806 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 );

809 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_CERTIFICATE_VERIFY
 )

811 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate verify message" ) );

812 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 );

815 
n1
 = 
s¦
->
³”_û¹
->
r§
.
Ën
;

816 
n2
 = ( 
s¦
->
š_msg
[4] << 8 ) | ssl->in_msg[5];

818 ifĞ
n1
 + 6 !ğ
s¦
->
š_h¦’
 ||‚1 !ğ
n2
 )

820 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate verify message" ) );

821 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 );

824 
»t
 = 
	`r§_pkcs1_v”ify
Ğ&
s¦
->
³”_û¹
->
r§
, 
RSA_PUBLIC
,

825 
SIG_RSA_RAW
, 36, 
hash
, 
s¦
->
š_msg
 + 6 );

826 ifĞ
»t
 != 0 )

828 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_v”ify", 
»t
 );

829 Ğ
»t
 );

832 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse certificate verify" ) );

835 
	}
}

840 
	$s¦_hªdshake_£rv”
Ğ
s¦_cÚ‹xt
 *
s¦
 )

842 
»t
 = 0;

844 
	`SSL_DEBUG_MSG
( 2, ( "=> handshake server" ) );

846  
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

848 
	`SSL_DEBUG_MSG
Ğ2, ( "£rv” s‹: %d", 
s¦
->
¡©e
 ) );

850 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

853  
s¦
->
¡©e
 )

855 
SSL_HELLO_REQUEST
:

856 
s¦
->
¡©e
 = 
SSL_CLIENT_HELLO
;

862 
SSL_CLIENT_HELLO
:

863 
»t
 = 
	`s¦_·r£_ş›Á_h–lo
Ğ
s¦
 );

873 
SSL_SERVER_HELLO
:

874 
»t
 = 
	`s¦_wr™e_£rv”_h–lo
Ğ
s¦
 );

877 
SSL_SERVER_CERTIFICATE
:

878 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹
Ğ
s¦
 );

881 
SSL_SERVER_KEY_EXCHANGE
:

882 
»t
 = 
	`s¦_wr™e_£rv”_key_exchªge
Ğ
s¦
 );

885 
SSL_CERTIFICATE_REQUEST
:

886 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹_»que¡
Ğ
s¦
 );

889 
SSL_SERVER_HELLO_DONE
:

890 
»t
 = 
	`s¦_wr™e_£rv”_h–lo_dÚe
Ğ
s¦
 );

900 
SSL_CLIENT_CERTIFICATE
:

901 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹
Ğ
s¦
 );

904 
SSL_CLIENT_KEY_EXCHANGE
:

905 
»t
 = 
	`s¦_·r£_ş›Á_key_exchªge
Ğ
s¦
 );

908 
SSL_CERTIFICATE_VERIFY
:

909 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹_v”ify
Ğ
s¦
 );

912 
SSL_CLIENT_CHANGE_CIPHER_SPEC
:

913 
»t
 = 
	`s¦_·r£_chªge_ch”_¥ec
Ğ
s¦
 );

916 
SSL_CLIENT_FINISHED
:

917 
»t
 = 
	`s¦_·r£_fšished
Ğ
s¦
 );

924 
SSL_SERVER_CHANGE_CIPHER_SPEC
:

925 
»t
 = 
	`s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦
 );

928 
SSL_SERVER_FINISHED
:

929 
»t
 = 
	`s¦_wr™e_fšished
Ğ
s¦
 );

932 
SSL_FLUSH_BUFFERS
:

933 
	`SSL_DEBUG_MSG
( 2, ( "handshake: done" ) );

934 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

938 
	`SSL_DEBUG_MSG
Ğ1, ( "šv®id s‹ %d", 
s¦
->
¡©e
 ) );

939 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

942 ifĞ
»t
 != 0 )

946 
	`SSL_DEBUG_MSG
( 2, ( "<= handshake server" ) );

948 Ğ
»t
 );

949 
	}
}

	@src/polarssl/ssl_tls.c

34 
	~"pŞ¬s¦/cÚfig.h
"

36 #ià
defšed
(
POLARSSL_SSL_TLS_C
)

38 
	~"pŞ¬s¦/«s.h
"

39 
	~"pŞ¬s¦/¬c4.h
"

40 
	~"pŞ¬s¦/ÿm–lŸ.h
"

41 
	~"pŞ¬s¦/des.h
"

42 
	~"pŞ¬s¦/debug.h
"

43 
	~"pŞ¬s¦/s¦.h
"

45 
	~<¡ršg.h
>

46 
	~<¡dlib.h
>

47 
	~<time.h
>

52 
	$s1_´f
Ğ*
£ü‘
, 
¦’
, *
Ïb–
,

53 *
¿ndom
, 
¾’
,

54 *
d¡buf
, 
dËn
 )

56 
nb
, 
hs
;

57 
i
, 
j
, 
k
;

58 *
S1
, *
S2
;

59 
tmp
[128];

60 
h_i
[20];

62 ifĞĞ
tmp
 ) < 20 + 
	`¡¾’
Ğ
Ïb–
 ) + 
¾’
 )

63 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

65 
hs
 = ( 
¦’
 + 1 ) / 2;

66 
S1
 = 
£ü‘
;

67 
S2
 = 
£ü‘
 + 
¦’
 - 
hs
;

69 
nb
 = 
	`¡¾’
Ğ
Ïb–
 );

70 
	`memıy
Ğ
tmp
 + 20, 
Ïb–
, 
nb
 );

71 
	`memıy
Ğ
tmp
 + 20 + 
nb
, 
¿ndom
, 
¾’
 );

72 
nb
 +ğ
¾’
;

77 
	`md5_hmac
Ğ
S1
, 
hs
, 
tmp
 + 20, 
nb
, 4 +mp );

79  
i
 = 0; i < 
dËn
; i += 16 )

81 
	`md5_hmac
Ğ
S1
, 
hs
, 4 + 
tmp
, 16 + 
nb
, 
h_i
 );

82 
	`md5_hmac
Ğ
S1
, 
hs
, 4 + 
tmp
, 16, 4 +mp );

84 
k
 = ( 
i
 + 16 > 
dËn
 ) ? dlen % 16 : 16;

86  
j
 = 0; j < 
k
; j++ )

87 
d¡buf
[
i
 + 
j
] = 
h_i
[j];

93 
	`sha1_hmac
Ğ
S2
, 
hs
, 
tmp
 + 20, 
nb
,mp );

95  
i
 = 0; i < 
dËn
; i += 20 )

97 
	`sha1_hmac
Ğ
S2
, 
hs
, 
tmp
, 20 + 
nb
, 
h_i
 );

98 
	`sha1_hmac
Ğ
S2
, 
hs
, 
tmp
, 20,mp );

100 
k
 = ( 
i
 + 20 > 
dËn
 ) ? dlen % 20 : 20;

102  
j
 = 0; j < 
k
; j++ )

103 
d¡buf
[
i
 + 
j
] = ()Ğd¡buf[˜+ j] ^ 
h_i
[j] );

106 
	`mem£t
Ğ
tmp
, 0, (mp ) );

107 
	`mem£t
Ğ
h_i
, 0, ( h_i ) );

110 
	}
}

112 
	$s¦_d”ive_keys
Ğ
s¦_cÚ‹xt
 *
s¦
 )

114 
i
;

115 
md5_cÚ‹xt
 
md5
;

116 
sha1_cÚ‹xt
 
sha1
;

117 
tmp
[64];

118 
·ddšg
[16];

119 
sha1sum
[20];

120 
keyblk
[256];

121 *
key1
;

122 *
key2
;

124 
	`SSL_DEBUG_MSG
( 2, ( "=> derive keys" ) );

136 ifĞ
s¦
->
»sume
 == 0 )

138 
Ën
 = 
s¦
->
pm¦’
;

140 
	`SSL_DEBUG_BUF
Ğ3, "´ema¡” seü‘", 
s¦
->
´ema¡”
, 
Ën
 );

142 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

144  
i
 = 0; i < 3; i++ )

146 
	`mem£t
Ğ
·ddšg
, 'A' + 
i
, 1 + i );

148 
	`sha1_¡¬ts
Ğ&
sha1
 );

149 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 1 + 
i
 );

150 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
´ema¡”
, 
Ën
 );

151 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

152 
	`sha1_fšish
Ğ&
sha1
, 
sha1sum
 );

154 
	`md5_¡¬ts
Ğ&
md5
 );

155 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
´ema¡”
, 
Ën
 );

156 
	`md5_upd©e
Ğ&
md5
, 
sha1sum
, 20 );

157 
	`md5_fšish
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
 + 
i
 * 16 );

161 
	`s1_´f
Ğ
s¦
->
´ema¡”
, 
Ën
, "master secret",

162 
s¦
->
¿ndby‹s
, 64, s¦->
£ssiÚ
->
ma¡”
, 48 );

164 
	`mem£t
Ğ
s¦
->
´ema¡”
, 0, ( ssl->premaster ) );

167 
	`SSL_DEBUG_MSG
( 3, ( "no…remaster (session„esumed)" ) );

172 
	`memıy
Ğ
tmp
, 
s¦
->
¿ndby‹s
, 64 );

173 
	`memıy
Ğ
s¦
->
¿ndby‹s
, 
tmp
 + 32, 32 );

174 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32, 
tmp
, 32 );

175 
	`mem£t
Ğ
tmp
, 0, (mp ) );

189 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

191  
i
 = 0; i < 16; i++ )

193 
	`mem£t
Ğ
·ddšg
, 'A' + 
i
, 1 + i );

195 
	`sha1_¡¬ts
Ğ&
sha1
 );

196 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 1 + 
i
 );

197 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

198 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

199 
	`sha1_fšish
Ğ&
sha1
, 
sha1sum
 );

201 
	`md5_¡¬ts
Ğ&
md5
 );

202 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

203 
	`md5_upd©e
Ğ&
md5
, 
sha1sum
, 20 );

204 
	`md5_fšish
Ğ&
md5
, 
keyblk
 + 
i
 * 16 );

207 
	`mem£t
Ğ&
md5
, 0, ( md5 ) );

208 
	`mem£t
Ğ&
sha1
, 0, ( sha1 ) );

210 
	`mem£t
Ğ
·ddšg
, 0, (…adding ) );

211 
	`mem£t
Ğ
sha1sum
, 0, ( sha1sum ) );

214 
	`s1_´f
Ğ
s¦
->
£ssiÚ
->
ma¡”
, 48, "keyƒxpansion",

215 
s¦
->
¿ndby‹s
, 64, 
keyblk
, 256 );

217 
	`SSL_DEBUG_MSG
Ğ3, ( "ch” = %s", 
	`s¦_g‘_ch”
Ğ
s¦
 ) ) );

218 
	`SSL_DEBUG_BUF
Ğ3, "ma¡” seü‘", 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

219 
	`SSL_DEBUG_BUF
Ğ4, "¿ndom by‹s", 
s¦
->
¿ndby‹s
, 64 );

220 
	`SSL_DEBUG_BUF
Ğ4, "key block", 
keyblk
, 256 );

222 
	`mem£t
Ğ
s¦
->
¿ndby‹s
, 0, ( ssl->randbytes ) );

227  
s¦
->
£ssiÚ
->
ch”
 )

229 #ià
	`defšed
(
POLARSSL_ARC4_C
)

230 
SSL_RSA_RC4_128_MD5
:

231 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 16;

232 
s¦
->
ivËn
 = 0; s¦->
maş’
 = 16;

235 
SSL_RSA_RC4_128_SHA
:

236 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 20;

237 
s¦
->
ivËn
 = 0; s¦->
maş’
 = 20;

241 #ià
	`defšed
(
POLARSSL_DES_C
)

242 
SSL_RSA_DES_168_SHA
:

243 
SSL_EDH_RSA_DES_168_SHA
:

244 
s¦
->
keyËn
 = 24; s¦->
mšËn
 = 24;

245 
s¦
->
ivËn
 = 8; s¦->
maş’
 = 20;

249 #ià
	`defšed
(
POLARSSL_AES_C
)

250 
SSL_RSA_AES_128_SHA
:

251 
SSL_EDH_RSA_AES_128_SHA
:

252 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 32;

253 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

256 
SSL_RSA_AES_256_SHA
:

257 
SSL_EDH_RSA_AES_256_SHA
:

258 
s¦
->
keyËn
 = 32; s¦->
mšËn
 = 32;

259 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

263 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

264 
SSL_RSA_CAMELLIA_128_SHA
:

265 
SSL_EDH_RSA_CAMELLIA_128_SHA
:

266 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 32;

267 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

270 
SSL_RSA_CAMELLIA_256_SHA
:

271 
SSL_EDH_RSA_CAMELLIA_256_SHA
:

272 
s¦
->
keyËn
 = 32; s¦->
mšËn
 = 32;

273 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

278 
	`SSL_DEBUG_MSG
( 1, ( "cipher %s is‚ot‡vailable",

279 
	`s¦_g‘_ch”
Ğ
s¦
 ) ) );

280 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

283 
	`SSL_DEBUG_MSG
( 3, ( "keylen: %d, minlen: %d, ivlen: %d, maclen: %d",

284 
s¦
->
keyËn
, s¦->
mšËn
, s¦->
ivËn
, s¦->
maş’
 ) );

289 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

291 
key1
 = 
keyblk
 + 
s¦
->
maş’
 * 2;

292 
key2
 = 
keyblk
 + 
s¦
->
maş’
 * 2 + s¦->
keyËn
;

294 
	`memıy
Ğ
s¦
->
mac_’c
, 
keyblk
, s¦->
maş’
 );

295 
	`memıy
Ğ
s¦
->
mac_dec
, 
keyblk
 + s¦->
maş’
, ssl->maclen );

300 
	`memıy
Ğ
s¦
->
iv_’c
, 
key2
 + s¦->
keyËn
, s¦->
ivËn
 );

301 
	`memıy
Ğ
s¦
->
iv_dec
, 
key2
 + s¦->
keyËn
 + s¦->
ivËn
,

302 
s¦
->
ivËn
 );

306 
key1
 = 
keyblk
 + 
s¦
->
maş’
 * 2 + s¦->
keyËn
;

307 
key2
 = 
keyblk
 + 
s¦
->
maş’
 * 2;

309 
	`memıy
Ğ
s¦
->
mac_dec
, 
keyblk
, s¦->
maş’
 );

310 
	`memıy
Ğ
s¦
->
mac_’c
, 
keyblk
 + s¦->
maş’
, ssl->maclen );

315 
	`memıy
Ğ
s¦
->
iv_dec
, 
key1
 + s¦->
keyËn
, s¦->
ivËn
 );

316 
	`memıy
Ğ
s¦
->
iv_’c
, 
key1
 + s¦->
keyËn
 + s¦->
ivËn
,

317 
s¦
->
ivËn
 );

320  
s¦
->
£ssiÚ
->
ch”
 )

322 #ià
	`defšed
(
POLARSSL_ARC4_C
)

323 
SSL_RSA_RC4_128_MD5
:

324 
SSL_RSA_RC4_128_SHA
:

325 
	`¬c4_£tup
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, s¦->
keyËn
 );

326 
	`¬c4_£tup
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, s¦->
keyËn
 );

330 #ià
	`defšed
(
POLARSSL_DES_C
)

331 
SSL_RSA_DES_168_SHA
:

332 
SSL_EDH_RSA_DES_168_SHA
:

333 
	`des3_£t3key_’c
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
 );

334 
	`des3_£t3key_dec
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
 );

338 #ià
	`defšed
(
POLARSSL_AES_C
)

339 
SSL_RSA_AES_128_SHA
:

340 
SSL_EDH_RSA_AES_128_SHA
:

341 
	`«s_£tkey_’c
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 128 );

342 
	`«s_£tkey_dec
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 128 );

345 
SSL_RSA_AES_256_SHA
:

346 
SSL_EDH_RSA_AES_256_SHA
:

347 
	`«s_£tkey_’c
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 256 );

348 
	`«s_£tkey_dec
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 256 );

352 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

353 
SSL_RSA_CAMELLIA_128_SHA
:

354 
SSL_EDH_RSA_CAMELLIA_128_SHA
:

355 
	`ÿm–lŸ_£tkey_’c
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 128 );

356 
	`ÿm–lŸ_£tkey_dec
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 128 );

359 
SSL_RSA_CAMELLIA_256_SHA
:

360 
SSL_EDH_RSA_CAMELLIA_256_SHA
:

361 
	`ÿm–lŸ_£tkey_’c
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 256 );

362 
	`ÿm–lŸ_£tkey_dec
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 256 );

367 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

370 
	`mem£t
Ğ
keyblk
, 0, ( keyblk ) );

372 
	`SSL_DEBUG_MSG
( 2, ( "<= derive keys" ) );

375 
	}
}

377 
	$s¦_ÿlc_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
, 
hash
[36] )

379 
md5_cÚ‹xt
 
md5
;

380 
sha1_cÚ‹xt
 
sha1
;

381 
·d_1
[48];

382 
·d_2
[48];

384 
	`SSL_DEBUG_MSG
( 2, ( "=> calc verify" ) );

386 
	`memıy
Ğ&
md5
 , &
s¦
->
fš_md5
 , Ğ
md5_cÚ‹xt
 ) );

387 
	`memıy
Ğ&
sha1
, &
s¦
->
fš_sha1
, Ğ
sha1_cÚ‹xt
 ) );

389 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

391 
	`mem£t
Ğ
·d_1
, 0x36, 48 );

392 
	`mem£t
Ğ
·d_2
, 0x5C, 48 );

394 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

395 
	`md5_upd©e
Ğ&
md5
, 
·d_1
, 48 );

396 
	`md5_fšish
Ğ&
md5
, 
hash
 );

398 
	`md5_¡¬ts
Ğ&
md5
 );

399 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

400 
	`md5_upd©e
Ğ&
md5
, 
·d_2
, 48 );

401 
	`md5_upd©e
Ğ&
md5
, 
hash
, 16 );

402 
	`md5_fšish
Ğ&
md5
, 
hash
 );

404 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

405 
	`sha1_upd©e
Ğ&
sha1
, 
·d_1
, 40 );

406 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

408 
	`sha1_¡¬ts
Ğ&
sha1
 );

409 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

410 
	`sha1_upd©e
Ğ&
sha1
, 
·d_2
, 40 );

411 
	`sha1_upd©e
Ğ&
sha1
, 
hash
 + 16, 20 );

412 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

416 
	`md5_fšish
Ğ&
md5
, 
hash
 );

417 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

420 
	`SSL_DEBUG_BUF
Ğ3, "ÿlcuÏ‹d v”ify„esuÉ", 
hash
, 36 );

421 
	`SSL_DEBUG_MSG
( 2, ( "<= calc verify" ) );

424 
	}
}

429 
	$s¦_mac_md5
Ğ*
£ü‘
,

430 *
buf
, 
Ën
,

431 *
ùr
, 
ty³
 )

433 
h—d”
[11];

434 
·ddšg
[48];

435 
md5_cÚ‹xt
 
md5
;

437 
	`memıy
Ğ
h—d”
, 
ùr
, 8 );

438 
h—d”
[ 8] = (è
ty³
;

439 
h—d”
[ 9] = ()Ğ
Ën
 >> 8 );

440 
h—d”
[10] = ()Ğ
Ën
 );

442 
	`mem£t
Ğ
·ddšg
, 0x36, 48 );

443 
	`md5_¡¬ts
Ğ&
md5
 );

444 
	`md5_upd©e
Ğ&
md5
, 
£ü‘
, 16 );

445 
	`md5_upd©e
Ğ&
md5
, 
·ddšg
, 48 );

446 
	`md5_upd©e
Ğ&
md5
, 
h—d”
, 11 );

447 
	`md5_upd©e
Ğ&
md5
, 
buf
, 
Ën
 );

448 
	`md5_fšish
Ğ&
md5
, 
buf
 + 
Ën
 );

450 
	`mem£t
Ğ
·ddšg
, 0x5C, 48 );

451 
	`md5_¡¬ts
Ğ&
md5
 );

452 
	`md5_upd©e
Ğ&
md5
, 
£ü‘
, 16 );

453 
	`md5_upd©e
Ğ&
md5
, 
·ddšg
, 48 );

454 
	`md5_upd©e
Ğ&
md5
, 
buf
 + 
Ën
, 16 );

455 
	`md5_fšish
Ğ&
md5
, 
buf
 + 
Ën
 );

456 
	}
}

458 
	$s¦_mac_sha1
Ğ*
£ü‘
,

459 *
buf
, 
Ën
,

460 *
ùr
, 
ty³
 )

462 
h—d”
[11];

463 
·ddšg
[40];

464 
sha1_cÚ‹xt
 
sha1
;

466 
	`memıy
Ğ
h—d”
, 
ùr
, 8 );

467 
h—d”
[ 8] = (è
ty³
;

468 
h—d”
[ 9] = ()Ğ
Ën
 >> 8 );

469 
h—d”
[10] = ()Ğ
Ën
 );

471 
	`mem£t
Ğ
·ddšg
, 0x36, 40 );

472 
	`sha1_¡¬ts
Ğ&
sha1
 );

473 
	`sha1_upd©e
Ğ&
sha1
, 
£ü‘
, 20 );

474 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 40 );

475 
	`sha1_upd©e
Ğ&
sha1
, 
h—d”
, 11 );

476 
	`sha1_upd©e
Ğ&
sha1
, 
buf
, 
Ën
 );

477 
	`sha1_fšish
Ğ&
sha1
, 
buf
 + 
Ën
 );

479 
	`mem£t
Ğ
·ddšg
, 0x5C, 40 );

480 
	`sha1_¡¬ts
Ğ&
sha1
 );

481 
	`sha1_upd©e
Ğ&
sha1
, 
£ü‘
, 20 );

482 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 40 );

483 
	`sha1_upd©e
Ğ&
sha1
, 
buf
 + 
Ën
, 20 );

484 
	`sha1_fšish
Ğ&
sha1
, 
buf
 + 
Ën
 );

485 
	}
}

490 
	$s¦_’üy±_buf
Ğ
s¦_cÚ‹xt
 *
s¦
 )

492 
i
, 
·dËn
;

494 
	`SSL_DEBUG_MSG
( 2, ( "=>ƒncrypt buf" ) );

499 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

501 ifĞ
s¦
->
maş’
 == 16 )

502 
	`s¦_mac_md5
Ğ
s¦
->
mac_’c
,

503 
s¦
->
out_msg
, s¦->
out_msgËn
,

504 
s¦
->
out_ùr
, s¦->
out_msgty³
 );

506 ifĞ
s¦
->
maş’
 == 20 )

507 
	`s¦_mac_sha1
Ğ
s¦
->
mac_’c
,

508 
s¦
->
out_msg
, s¦->
out_msgËn
,

509 
s¦
->
out_ùr
, s¦->
out_msgty³
 );

513 ifĞ
s¦
->
maş’
 == 16 )

514 
	`md5_hmac
Ğ
s¦
->
mac_’c
, 16,

515 
s¦
->
out_ùr
, s¦->
out_msgËn
 + 13,

516 
s¦
->
out_msg
 + s¦->
out_msgËn
 );

518 ifĞ
s¦
->
maş’
 == 20 )

519 
	`sha1_hmac
Ğ
s¦
->
mac_’c
, 20,

520 
s¦
->
out_ùr
, s¦->
out_msgËn
 + 13,

521 
s¦
->
out_msg
 + s¦->
out_msgËn
 );

524 
	`SSL_DEBUG_BUF
( 4, "computed mac",

525 
s¦
->
out_msg
 + s¦->
out_msgËn
, s¦->
maş’
 );

527 
s¦
->
out_msgËn
 +ğs¦->
maş’
;

529  
i
 = 7; i >= 0; i-- )

530 ifĞ++
s¦
->
out_ùr
[
i
] != 0 )

533 ifĞ
s¦
->
ivËn
 == 0 )

535 #ià
	`defšed
(
POLARSSL_ARC4_C
)

536 
·dËn
 = 0;

538 
	`SSL_DEBUG_MSG
( 3, ( "beforeƒncrypt: msglen = %d, "

540 
s¦
->
out_msgËn
, 0 ) );

542 
	`SSL_DEBUG_BUF
( 4, "beforeƒncrypt: output…ayload",

543 
s¦
->
out_msg
, s¦->
out_msgËn
 );

545 
	`¬c4_üy±
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_’c
,

546 
s¦
->
out_msgËn
, s¦->
out_msg
,

547 
s¦
->
out_msg
 );

549 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

554 *
’c_msg
;

555 
’c_msgËn
;

557 
·dËn
 = 
s¦
->
ivËn
 - ( s¦->
out_msgËn
 + 1 ) % ssl->ivlen;

558 ifĞ
·dËn
 =ğ
s¦
->
ivËn
 )

559 
·dËn
 = 0;

561  
i
 = 0; i <ğ
·dËn
; i++ )

562 
s¦
->
out_msg
[s¦->
out_msgËn
 + 
i
] = (è
·dËn
;

564 
s¦
->
out_msgËn
 +ğ
·dËn
 + 1;

566 
’c_msgËn
 = 
s¦
->
out_msgËn
;

567 
’c_msg
 = 
s¦
->
out_msg
;

573 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_2
 )

578  
i
 = 0; i < 
s¦
->
ivËn
; i++ )

579 
s¦
->
iv_’c
[
i
] = s¦->
	`f_ºg
Ğs¦->
p_ºg
 );

584 
	`memmove
Ğ
s¦
->
out_msg
 + s¦->
ivËn
, s¦->out_msg, s¦->
out_msgËn
 );

585 
	`memıy
Ğ
s¦
->
out_msg
, s¦->
iv_’c
, s¦->
ivËn
 );

590 
’c_msg
 = 
s¦
->
out_msg
 + s¦->
ivËn
;

591 
’c_msgËn
 = 
s¦
->
out_msgËn
;

592 
s¦
->
out_msgËn
 +ğs¦->
ivËn
;

595 
	`SSL_DEBUG_MSG
( 3, ( "beforeƒncrypt: msglen = %d, "

597 
s¦
->
out_msgËn
, s¦->
ivËn
, 
·dËn
 + 1 ) );

599 
	`SSL_DEBUG_BUF
( 4, "beforeƒncrypt: output…ayload",

600 
s¦
->
out_msg
, s¦->
out_msgËn
 );

602  
s¦
->
ivËn
 )

605 #ià
	`defšed
(
POLARSSL_DES_C
)

606 
	`des3_üy±_cbc
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_’c
,

607 
DES_ENCRYPT
, 
’c_msgËn
,

608 
s¦
->
iv_’c
, 
’c_msg
,ƒnc_msg );

613 #ià
	`defšed
(
POLARSSL_AES_C
)

614 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_128_SHA
 ||

615 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

616 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_256_SHA
 ||

617 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
)

619 
	`«s_üy±_cbc
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_’c
,

620 
AES_ENCRYPT
, 
’c_msgËn
,

621 
s¦
->
iv_’c
, 
’c_msg
,ƒnc_msg);

626 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

627 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_128_SHA
 ||

628 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

629 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_256_SHA
 ||

630 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

632 
	`ÿm–lŸ_üy±_cbc
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_’c
,

633 
CAMELLIA_ENCRYPT
, 
’c_msgËn
,

634 
s¦
->
iv_’c
, 
’c_msg
,ƒnc_msg );

640 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

644 
	`SSL_DEBUG_MSG
( 2, ( "<=ƒncrypt buf" ) );

647 
	}
}

649 
	$s¦_deüy±_buf
Ğ
s¦_cÚ‹xt
 *
s¦
 )

651 
i
, 
·dËn
;

652 
tmp
[20];

654 
	`SSL_DEBUG_MSG
( 2, ( "=> decrypt buf" ) );

656 ifĞ
s¦
->
š_msgËn
 < s¦->
mšËn
 )

658 
	`SSL_DEBUG_MSG
( 1, ( "in_msglen (%d) < minlen (%d)",

659 
s¦
->
š_msgËn
, s¦->
mšËn
 ) );

660 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

663 ifĞ
s¦
->
ivËn
 == 0 )

665 #ià
	`defšed
(
POLARSSL_ARC4_C
)

666 
·dËn
 = 0;

667 
	`¬c4_üy±
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_dec
,

668 
s¦
->
š_msgËn
, s¦->
š_msg
,

669 
s¦
->
š_msg
 );

671 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

676 *
dec_msg
;

677 *
dec_msg_»suÉ
;

678 
dec_msgËn
;

683 ifĞ
s¦
->
š_msgËn
 % s¦->
ivËn
 != 0 )

685 
	`SSL_DEBUG_MSG
( 1, ( "msglen (%d) %% ivlen (%d) != 0",

686 
s¦
->
š_msgËn
, s¦->
ivËn
 ) );

687 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

690 
dec_msgËn
 = 
s¦
->
š_msgËn
;

691 
dec_msg
 = 
s¦
->
š_msg
;

692 
dec_msg_»suÉ
 = 
s¦
->
š_msg
;

697 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_2
 )

699 
dec_msg
 +ğ
s¦
->
ivËn
;

700 
dec_msgËn
 -ğ
s¦
->
ivËn
;

701 
s¦
->
š_msgËn
 -ğs¦->
ivËn
;

703  
i
 = 0; i < 
s¦
->
ivËn
; i++ )

704 
s¦
->
iv_dec
[
i
] = s¦->
š_msg
[i];

707  
s¦
->
ivËn
 )

709 #ià
	`defšed
(
POLARSSL_DES_C
)

711 
	`des3_üy±_cbc
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_dec
,

712 
DES_DECRYPT
, 
dec_msgËn
,

713 
s¦
->
iv_dec
, 
dec_msg
, 
dec_msg_»suÉ
 );

718 #ià
	`defšed
(
POLARSSL_AES_C
)

719 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_128_SHA
 ||

720 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

721 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_256_SHA
 ||

722 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
)

724 
	`«s_üy±_cbc
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_dec
,

725 
AES_DECRYPT
, 
dec_msgËn
,

726 
s¦
->
iv_dec
, 
dec_msg
, 
dec_msg_»suÉ
 );

731 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

732 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_128_SHA
 ||

733 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

734 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_256_SHA
 ||

735 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

737 
	`ÿm–lŸ_üy±_cbc
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_dec
,

738 
CAMELLIA_DECRYPT
, 
dec_msgËn
,

739 
s¦
->
iv_dec
, 
dec_msg
, 
dec_msg_»suÉ
 );

745 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

748 
·dËn
 = 1 + 
s¦
->
š_msg
[s¦->
š_msgËn
 - 1];

750 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

752 ifĞ
·dËn
 > 
s¦
->
ivËn
 )

754 
	`SSL_DEBUG_MSG
( 1, ( "bad…adding†ength: is %d, "

756 
·dËn
, 
s¦
->
ivËn
 ) );

757 
·dËn
 = 0;

765  
i
 = 1; i <ğ
·dËn
; i++ )

767 ifĞ
s¦
->
š_msg
[s¦->
š_msgËn
 - 
i
] !ğ
·dËn
 - 1 )

769 
	`SSL_DEBUG_MSG
( 1, ( "bad…adding byte: should be "

770 "%02x, buˆi %02x", 
·dËn
 - 1,

771 
s¦
->
š_msg
[s¦->
š_msgËn
 - 
i
] ) );

772 
·dËn
 = 0;

778 
	`SSL_DEBUG_BUF
( 4, "raw buffer‡fter decryption",

779 
s¦
->
š_msg
, s¦->
š_msgËn
 );

784 
s¦
->
š_msgËn
 -ğĞs¦->
maş’
 + 
·dËn
 );

786 
s¦
->
š_hdr
[3] = ()Ğs¦->
š_msgËn
 >> 8 );

787 
s¦
->
š_hdr
[4] = ()Ğs¦->
š_msgËn
 );

789 
	`memıy
Ğ
tmp
, 
s¦
->
š_msg
 + s¦->
š_msgËn
, 20 );

791 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

793 ifĞ
s¦
->
maş’
 == 16 )

794 
	`s¦_mac_md5
Ğ
s¦
->
mac_dec
,

795 
s¦
->
š_msg
, s¦->
š_msgËn
,

796 
s¦
->
š_ùr
, s¦->
š_msgty³
 );

798 
	`s¦_mac_sha1
Ğ
s¦
->
mac_dec
,

799 
s¦
->
š_msg
, s¦->
š_msgËn
,

800 
s¦
->
š_ùr
, s¦->
š_msgty³
 );

804 ifĞ
s¦
->
maş’
 == 16 )

805 
	`md5_hmac
Ğ
s¦
->
mac_dec
, 16,

806 
s¦
->
š_ùr
, s¦->
š_msgËn
 + 13,

807 
s¦
->
š_msg
 + s¦->
š_msgËn
 );

809 
	`sha1_hmac
Ğ
s¦
->
mac_dec
, 20,

810 
s¦
->
š_ùr
, s¦->
š_msgËn
 + 13,

811 
s¦
->
š_msg
 + s¦->
š_msgËn
 );

814 
	`SSL_DEBUG_BUF
Ğ4, "mes§g mac", 
tmp
, 
s¦
->
maş’
 );

815 
	`SSL_DEBUG_BUF
Ğ4, "compu‹d mac", 
s¦
->
š_msg
 + s¦->
š_msgËn
,

816 
s¦
->
maş’
 );

818 ifĞ
	`memcmp
Ğ
tmp
, 
s¦
->
š_msg
 + s¦->
š_msgËn
,

819 
s¦
->
maş’
 ) != 0 )

821 
	`SSL_DEBUG_MSG
( 1, ( "message mac does‚ot match" ) );

822 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

829 ifĞ
s¦
->
ivËn
 !ğ0 && 
·dËn
 == 0 )

830 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

832 ifĞ
s¦
->
š_msgËn
 == 0 )

834 
s¦
->
nb_z”o
++;

840 ifĞ
s¦
->
nb_z”o
 > 3 )

842 
	`SSL_DEBUG_MSG
( 1, ( "received four consecutiveƒmpty "

844 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

848 
s¦
->
nb_z”o
 = 0;

850  
i
 = 7; i >= 0; i-- )

851 ifĞ++
s¦
->
š_ùr
[
i
] != 0 )

854 
	`SSL_DEBUG_MSG
( 2, ( "<= decrypt buf" ) );

857 
	}
}

862 
	$s¦_ãtch_šput
Ğ
s¦_cÚ‹xt
 *
s¦
, 
nb_wªt
 )

864 
»t
, 
Ën
;

866 
	`SSL_DEBUG_MSG
( 2, ( "=> fetch input" ) );

868  
s¦
->
š_Ëá
 < 
nb_wªt
 )

870 
Ën
 = 
nb_wªt
 - 
s¦
->
š_Ëá
;

871 
»t
 = 
s¦
->
	`f_»cv
Ğs¦->
p_»cv
, s¦->
š_hdr
 + s¦->
š_Ëá
, 
Ën
 );

873 
	`SSL_DEBUG_MSG
( 2, ( "in_left: %d,‚b_want: %d",

874 
s¦
->
š_Ëá
, 
nb_wªt
 ) );

875 
	`SSL_DEBUG_RET
Ğ2, "s¦->f_»cv", 
»t
 );

877 ifĞ
»t
 < 0 )

878 Ğ
»t
 );

880 
s¦
->
š_Ëá
 +ğ
»t
;

883 
	`SSL_DEBUG_MSG
( 2, ( "<= fetch input" ) );

886 
	}
}

891 
	$s¦_æush_ouut
Ğ
s¦_cÚ‹xt
 *
s¦
 )

893 
»t
;

894 *
buf
;

896 
	`SSL_DEBUG_MSG
( 2, ( "=> flush output" ) );

898  
s¦
->
out_Ëá
 > 0 )

900 
	`SSL_DEBUG_MSG
( 2, ( "message†ength: %d, out_left: %d",

901 5 + 
s¦
->
out_msgËn
, s¦->
out_Ëá
 ) );

903 
buf
 = 
s¦
->
out_hdr
 + 5 + s¦->
out_msgËn
 - s¦->
out_Ëá
;

904 
»t
 = 
s¦
->
	`f_£nd
Ğs¦->
p_£nd
, 
buf
, s¦->
out_Ëá
 );

905 
	`SSL_DEBUG_RET
Ğ2, "s¦->f_£nd", 
»t
 );

907 ifĞ
»t
 <= 0 )

908 Ğ
»t
 );

910 
s¦
->
out_Ëá
 -ğ
»t
;

913 
	`SSL_DEBUG_MSG
( 2, ( "<= flush output" ) );

916 
	}
}

921 
	$s¦_wr™e_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 )

923 
»t
, 
Ën
 = 
s¦
->
out_msgËn
;

925 
	`SSL_DEBUG_MSG
( 2, ( "=> write„ecord" ) );

927 
s¦
->
out_hdr
[0] = (ès¦->
out_msgty³
;

928 
s¦
->
out_hdr
[1] = (ès¦->
majÜ_v”
;

929 
s¦
->
out_hdr
[2] = (ès¦->
mšÜ_v”
;

930 
s¦
->
out_hdr
[3] = ()Ğ
Ën
 >> 8 );

931 
s¦
->
out_hdr
[4] = ()Ğ
Ën
 );

933 ifĞ
s¦
->
out_msgty³
 =ğ
SSL_MSG_HANDSHAKE
 )

935 
s¦
->
out_msg
[1] = ()ĞĞ
Ën
 - 4 ) >> 16 );

936 
s¦
->
out_msg
[2] = ()ĞĞ
Ën
 - 4 ) >> 8 );

937 
s¦
->
out_msg
[3] = ()ĞĞ
Ën
 - 4 ) );

939 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , s¦->
out_msg
, 
Ën
 );

940 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, s¦->
out_msg
, 
Ën
 );

943 ifĞ
s¦
->
do_üy±
 != 0 )

945 ifĞĞ
»t
 = 
	`s¦_’üy±_buf
Ğ
s¦
 ) ) != 0 )

947 
	`SSL_DEBUG_RET
Ğ1, "s¦_’üy±_buf", 
»t
 );

948 Ğ
»t
 );

951 
Ën
 = 
s¦
->
out_msgËn
;

952 
s¦
->
out_hdr
[3] = ()Ğ
Ën
 >> 8 );

953 
s¦
->
out_hdr
[4] = ()Ğ
Ën
 );

956 
s¦
->
out_Ëá
 = 5 + s¦->
out_msgËn
;

958 
	`SSL_DEBUG_MSG
( 3, ( "output„ecord: msgtype = %d, "

960 
s¦
->
out_hdr
[0], ssl->out_hdr[1], ssl->out_hdr[2],

961 Ğ
s¦
->
out_hdr
[3] << 8 ) | ssl->out_hdr[4] ) );

963 
	`SSL_DEBUG_BUF
( 4, "output„ecord sento‚etwork",

964 
s¦
->
out_hdr
, 5 + s¦->
out_msgËn
 );

966 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

968 
	`SSL_DEBUG_RET
Ğ1, "s¦_æush_ouut", 
»t
 );

969 Ğ
»t
 );

972 
	`SSL_DEBUG_MSG
( 2, ( "<= write„ecord" ) );

975 
	}
}

977 
	$s¦_»ad_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 )

979 
»t
;

981 
	`SSL_DEBUG_MSG
( 2, ( "=>„ead„ecord" ) );

983 ifĞ
s¦
->
š_h¦’
 != 0 &&

984 
s¦
->
š_h¦’
 < s¦->
š_msgËn
 )

989 
s¦
->
š_msgËn
 -ğs¦->
š_h¦’
;

991 
	`memıy
Ğ
s¦
->
š_msg
, s¦->š_msg + s¦->
š_h¦’
,

992 
s¦
->
š_msgËn
 );

994 
s¦
->
š_h¦’
 = 4;

995 
s¦
->
š_h¦’
 +ğĞs¦->
š_msg
[2] << 8 ) | ssl->in_msg[3];

997 
	`SSL_DEBUG_MSG
( 3, ( "handshake message: msglen ="

999 
s¦
->
š_msgËn
, s¦->
š_msg
[0], s¦->
š_h¦’
 ) );

1001 ifĞ
s¦
->
š_msgËn
 < 4 || s¦->
š_msg
[1] != 0 )

1003 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1004 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1007 ifĞ
s¦
->
š_msgËn
 < s¦->
š_h¦’
 )

1009 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1010 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1013 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , s¦->
š_msg
, s¦->
š_h¦’
 );

1014 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, s¦->
š_msg
, s¦->
š_h¦’
 );

1019 
s¦
->
š_h¦’
 = 0;

1024 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 ) ) != 0 )

1026 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

1027 Ğ
»t
 );

1030 
s¦
->
š_msgty³
 = s¦->
š_hdr
[0];

1031 
s¦
->
š_msgËn
 = ( s¦->
š_hdr
[3] << 8 ) | ssl->in_hdr[4];

1033 
	`SSL_DEBUG_MSG
( 3, ( "input„ecord: msgtype = %d, "

1035 
s¦
->
š_hdr
[0], ssl->in_hdr[1], ssl->in_hdr[2],

1036 Ğ
s¦
->
š_hdr
[3] << 8 ) | ssl->in_hdr[4] ) );

1038 ifĞ
s¦
->
š_hdr
[1] !ğs¦->
majÜ_v”
 )

1040 
	`SSL_DEBUG_MSG
( 1, ( "major version mismatch" ) );

1041 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1044 ifĞ
s¦
->
š_hdr
[2] > s¦->
max_mšÜ_v”
 )

1046 
	`SSL_DEBUG_MSG
( 1, ( "minor version mismatch" ) );

1047 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1053 ifĞ
s¦
->
do_üy±
 == 0 )

1055 ifĞ
s¦
->
š_msgËn
 < 1 ||

1056 
s¦
->
š_msgËn
 > 
SSL_MAX_CONTENT_LEN
 )

1058 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1059 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1064 ifĞ
s¦
->
š_msgËn
 < s¦->
mšËn
 )

1066 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1067 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1070 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 &&

1071 
s¦
->
š_msgËn
 > s¦->
mšËn
 + 
SSL_MAX_CONTENT_LEN
 )

1073 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1074 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1080 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_1
 &&

1081 
s¦
->
š_msgËn
 > s¦->
mšËn
 + 
SSL_MAX_CONTENT_LEN
 + 256 )

1083 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1084 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1091 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 + s¦->
š_msgËn
 ) ) != 0 )

1093 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

1094 Ğ
»t
 );

1097 
	`SSL_DEBUG_BUF
( 4, "input„ecord from‚etwork",

1098 
s¦
->
š_hdr
, 5 + s¦->
š_msgËn
 );

1100 ifĞ
s¦
->
do_üy±
 != 0 )

1102 ifĞĞ
»t
 = 
	`s¦_deüy±_buf
Ğ
s¦
 ) ) != 0 )

1104 
	`SSL_DEBUG_RET
Ğ1, "s¦_deüy±_buf", 
»t
 );

1105 Ğ
»t
 );

1108 
	`SSL_DEBUG_BUF
( 4, "input…ayload‡fter decrypt",

1109 
s¦
->
š_msg
, s¦->
š_msgËn
 );

1111 ifĞ
s¦
->
š_msgËn
 > 
SSL_MAX_CONTENT_LEN
 )

1113 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1114 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1118 ifĞ
s¦
->
š_msgty³
 =ğ
SSL_MSG_HANDSHAKE
 )

1120 
s¦
->
š_h¦’
 = 4;

1121 
s¦
->
š_h¦’
 +ğĞs¦->
š_msg
[2] << 8 ) | ssl->in_msg[3];

1123 
	`SSL_DEBUG_MSG
( 3, ( "handshake message: msglen ="

1125 
s¦
->
š_msgËn
, s¦->
š_msg
[0], s¦->
š_h¦’
 ) );

1130 ifĞ
s¦
->
š_msgËn
 < 4 || s¦->
š_msg
[1] != 0 )

1132 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1133 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1136 ifĞ
s¦
->
š_msgËn
 < s¦->
š_h¦’
 )

1138 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1139 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1142 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , s¦->
š_msg
, s¦->
š_h¦’
 );

1143 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, s¦->
š_msg
, s¦->
š_h¦’
 );

1146 ifĞ
s¦
->
š_msgty³
 =ğ
SSL_MSG_ALERT
 )

1148 
	`SSL_DEBUG_MSG
( 2, ( "got‡n‡lert message,ype: [%d:%d]",

1149 
s¦
->
š_msg
[0], ssl->in_msg[1] ) );

1154 ifĞ
s¦
->
š_msg
[0] =ğ
SSL_ALERT_LEVEL_FATAL
 )

1156 
	`SSL_DEBUG_MSG
( 1, ( "is‡ fatal‡lert message" ) );

1157 Ğ
POLARSSL_ERR_SSL_FATAL_ALERT_MESSAGE
 | 
s¦
->
š_msg
[1] );

1160 ifĞ
s¦
->
š_msg
[0] =ğ
SSL_ALERT_LEVEL_WARNING
 &&

1161 
s¦
->
š_msg
[1] =ğ
SSL_ALERT_MSG_CLOSE_NOTIFY
 )

1163 
	`SSL_DEBUG_MSG
( 2, ( "is‡ close‚otify message" ) );

1164 Ğ
POLARSSL_ERR_SSL_PEER_CLOSE_NOTIFY
 );

1168 
s¦
->
š_Ëá
 = 0;

1170 
	`SSL_DEBUG_MSG
( 2, ( "<=„ead„ecord" ) );

1173 
	}
}

1178 
	$s¦_wr™e_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1180 
»t
, 
i
, 
n
;

1181 cÚ¡ 
x509_û¹
 *
üt
;

1183 
	`SSL_DEBUG_MSG
( 2, ( "=> write certificate" ) );

1185 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1187 ifĞ
s¦
->
ş›Á_auth
 == 0 )

1189 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write certificate" ) );

1190 
s¦
->
¡©e
++;

1198 ifĞ
s¦
->
own_û¹
 =ğ
NULL
 &&

1199 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

1201 
s¦
->
out_msgËn
 = 2;

1202 
s¦
->
out_msgty³
 = 
SSL_MSG_ALERT
;

1203 
s¦
->
out_msg
[0] = 
SSL_ALERT_LEVEL_WARNING
;

1204 
s¦
->
out_msg
[1] = 
SSL_ALERT_MSG_NO_CERT
;

1206 
	`SSL_DEBUG_MSG
( 2, ( "got‚o certificateo send" ) );

1207 
wr™e_msg
;

1212 ifĞ
s¦
->
own_û¹
 =ğ
NULL
 )

1214 
	`SSL_DEBUG_MSG
( 1, ( "got‚o certificateo send" ) );

1215 Ğ
POLARSSL_ERR_SSL_CERTIFICATE_REQUIRED
 );

1219 
	`SSL_DEBUG_CRT
Ğ3, "owÀû¹ifiÿ‹", 
s¦
->
own_û¹
 );

1230 
i
 = 7;

1231 
üt
 = 
s¦
->
own_û¹
;

1233  
üt
 !ğ
NULL
 )

1235 
n
 = 
üt
->
¿w
.
Ën
;

1236 ifĞ
i
 + 3 + 
n
 > 
SSL_MAX_CONTENT_LEN
 )

1238 
	`SSL_DEBUG_MSG
( 1, ( "certificateoo†arge, %d > %d",

1239 
i
 + 3 + 
n
, 
SSL_MAX_CONTENT_LEN
 ) );

1240 Ğ
POLARSSL_ERR_SSL_CERTIFICATE_TOO_LARGE
 );

1243 
s¦
->
out_msg
[
i
 ] = ()Ğ
n
 >> 16 );

1244 
s¦
->
out_msg
[
i
 + 1] = ()Ğ
n
 >> 8 );

1245 
s¦
->
out_msg
[
i
 + 2] = ()Ğ
n
 );

1247 
i
 +ğ3; 
	`memıy
Ğ
s¦
->
out_msg
 + i, 
üt
->
¿w
.
p
, 
n
 );

1248 
i
 +ğ
n
; 
üt
 = c¹->
Ãxt
;

1251 
s¦
->
out_msg
[4] = ()ĞĞ
i
 - 7 ) >> 16 );

1252 
s¦
->
out_msg
[5] = ()ĞĞ
i
 - 7 ) >> 8 );

1253 
s¦
->
out_msg
[6] = ()ĞĞ
i
 - 7 ) );

1255 
s¦
->
out_msgËn
 = 
i
;

1256 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

1257 
s¦
->
out_msg
[0] = 
SSL_HS_CERTIFICATE
;

1259 
wr™e_msg
:

1261 
s¦
->
¡©e
++;

1263 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

1265 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

1266 Ğ
»t
 );

1269 
	`SSL_DEBUG_MSG
( 2, ( "<= write certificate" ) );

1272 
	}
}

1274 
	$s¦_·r£_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1276 
»t
, 
i
, 
n
;

1278 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse certificate" ) );

1280 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 &&

1281 
s¦
->
authmode
 =ğ
SSL_VERIFY_NONE
 )

1283 
	`SSL_DEBUG_MSG
( 2, ( "<= skip…arse certificate" ) );

1284 
s¦
->
¡©e
++;

1288 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1290 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1291 Ğ
»t
 );

1294 
s¦
->
¡©e
++;

1299 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 &&

1300 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

1302 ifĞ
s¦
->
š_msgËn
 == 2 &&

1303 
s¦
->
š_msgty³
 =ğ
SSL_MSG_ALERT
 &&

1304 
s¦
->
š_msg
[0] =ğ
SSL_ALERT_LEVEL_WARNING
 &&

1305 
s¦
->
š_msg
[1] =ğ
SSL_ALERT_MSG_NO_CERT
 )

1307 
	`SSL_DEBUG_MSG
( 1, ( "SSLv3 client has‚o certificate" ) );

1309 ifĞ
s¦
->
authmode
 =ğ
SSL_VERIFY_OPTIONAL
 )

1312 Ğ
POLARSSL_ERR_SSL_NO_CLIENT_CERTIFICATE
 );

1316 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 &&

1317 
s¦
->
mšÜ_v”
 !ğ
SSL_MINOR_VERSION_0
 )

1319 ifĞ
s¦
->
š_h¦’
 == 7 &&

1320 
s¦
->
š_msgty³
 =ğ
SSL_MSG_HANDSHAKE
 &&

1321 
s¦
->
š_msg
[0] =ğ
SSL_HS_CERTIFICATE
 &&

1322 
	`memcmp
Ğ
s¦
->
š_msg
 + 4, "\0\0\0", 3 ) == 0 )

1324 
	`SSL_DEBUG_MSG
( 1, ( "TLSv1 client has‚o certificate" ) );

1326 ifĞ
s¦
->
authmode
 =ğ
SSL_VERIFY_REQUIRED
 )

1327 Ğ
POLARSSL_ERR_SSL_NO_CLIENT_CERTIFICATE
 );

1333 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

1335 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1336 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

1339 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_CERTIFICATE
 || s¦->
š_h¦’
 < 10 )

1341 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1342 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1348 
n
 = ( 
s¦
->
š_msg
[5] << 8 ) | ssl->in_msg[6];

1350 ifĞ
s¦
->
š_msg
[4] !ğ0 || s¦->
š_h¦’
 !ğ7 + 
n
 )

1352 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1353 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1356 ifĞĞ
s¦
->
³”_û¹
 = (
x509_û¹
 *è
	`m®loc
(

1357 Ğ
x509_û¹
 ) ) ) =ğ
NULL
 )

1359 
	`SSL_DEBUG_MSG
( 1, ( "malloc(%d bytes) failed",

1360 Ğ
x509_û¹
 ) ) );

1364 
	`mem£t
Ğ
s¦
->
³”_û¹
, 0, Ğ
x509_û¹
 ) );

1366 
i
 = 7;

1368  
i
 < 
s¦
->
š_h¦’
 )

1370 ifĞ
s¦
->
š_msg
[
i
] != 0 )

1372 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1373 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1376 
n
 = ( (è
s¦
->
š_msg
[
i
 + 1] << 8 )

1377 | (è
s¦
->
š_msg
[
i
 + 2];

1378 
i
 += 3;

1380 ifĞ
n
 < 128 || 
i
 +‚ > 
s¦
->
š_h¦’
 )

1382 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1383 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1386 
»t
 = 
	`x509·r£_üt
Ğ
s¦
->
³”_û¹
, s¦->
š_msg
 + 
i
, 
n
 );

1387 ifĞ
»t
 != 0 )

1389 
	`SSL_DEBUG_RET
Ğ1, " x509·r£_üt", 
»t
 );

1390 Ğ
»t
 );

1393 
i
 +ğ
n
;

1396 
	`SSL_DEBUG_CRT
Ğ3, "³” c”tifiÿ‹", 
s¦
->
³”_û¹
 );

1398 ifĞ
s¦
->
authmode
 !ğ
SSL_VERIFY_NONE
 )

1400 ifĞ
s¦
->
ÿ_chaš
 =ğ
NULL
 )

1402 
	`SSL_DEBUG_MSG
( 1, ( "got‚o CA chain" ) );

1403 Ğ
POLARSSL_ERR_SSL_CA_CHAIN_REQUIRED
 );

1406 
»t
 = 
	`x509·r£_v”ify
Ğ
s¦
->
³”_û¹
, s¦->
ÿ_chaš
, s¦->
ÿ_ül
,

1407 
s¦
->
³”_ú
, &s¦->
v”ify_»suÉ
 );

1409 ifĞ
»t
 != 0 )

1410 
	`SSL_DEBUG_RET
Ğ1, "x509_v”ify_û¹", 
»t
 );

1412 ifĞ
s¦
->
authmode
 !ğ
SSL_VERIFY_REQUIRED
 )

1413 
»t
 = 0;

1416 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse certificate" ) );

1418 Ğ
»t
 );

1419 
	}
}

1421 
	$s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1423 
»t
;

1425 
	`SSL_DEBUG_MSG
( 2, ( "=> write change cipher spec" ) );

1427 
s¦
->
out_msgty³
 = 
SSL_MSG_CHANGE_CIPHER_SPEC
;

1428 
s¦
->
out_msgËn
 = 1;

1429 
s¦
->
out_msg
[0] = 1;

1431 
s¦
->
do_üy±
 = 0;

1432 
s¦
->
¡©e
++;

1434 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

1436 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

1437 Ğ
»t
 );

1440 
	`SSL_DEBUG_MSG
( 2, ( "<= write change cipher spec" ) );

1443 
	}
}

1445 
	$s¦_·r£_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1447 
»t
;

1449 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse change cipher spec" ) );

1451 
s¦
->
do_üy±
 = 0;

1453 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1455 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1456 Ğ
»t
 );

1459 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_CHANGE_CIPHER_SPEC
 )

1461 
	`SSL_DEBUG_MSG
( 1, ( "bad change cipher spec message" ) );

1462 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

1465 ifĞ
s¦
->
š_msgËn
 !ğ1 || s¦->
š_msg
[0] != 1 )

1467 
	`SSL_DEBUG_MSG
( 1, ( "bad change cipher spec message" ) );

1468 Ğ
POLARSSL_ERR_SSL_BAD_HS_CHANGE_CIPHER_SPEC
 );

1471 
s¦
->
¡©e
++;

1473 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse change cipher spec" ) );

1476 
	}
}

1478 
	$s¦_ÿlc_fšished
(

1479 
s¦_cÚ‹xt
 *
s¦
, *
buf
, 
äom
,

1480 
md5_cÚ‹xt
 *
md5
, 
sha1_cÚ‹xt
 *
sha1
 )

1482 
Ën
 = 12;

1483 *
£nd”
;

1484 
·dbuf
[48];

1485 
md5sum
[16];

1486 
sha1sum
[20];

1488 
	`SSL_DEBUG_MSG
( 2, ( "=> calc finished" ) );

1503 
	`SSL_DEBUG_BUF
( 4, "finished md5 state", (*)

1504 
md5
->
¡©e
, ( md5->state ) );

1506 
	`SSL_DEBUG_BUF
( 4, "finished sha1 state", (*)

1507 
sha1
->
¡©e
, ( sha1->state ) );

1509 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

1511 
£nd”
 = ( 
äom
 =ğ
SSL_IS_CLIENT
 ) ? (*) "CLNT"

1514 
	`mem£t
Ğ
·dbuf
, 0x36, 48 );

1516 
	`md5_upd©e
Ğ
md5
, (*è
£nd”
, 4 );

1517 
	`md5_upd©e
Ğ
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1518 
	`md5_upd©e
Ğ
md5
, 
·dbuf
, 48 );

1519 
	`md5_fšish
Ğ
md5
, 
md5sum
 );

1521 
	`sha1_upd©e
Ğ
sha1
, (*è
£nd”
, 4 );

1522 
	`sha1_upd©e
Ğ
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1523 
	`sha1_upd©e
Ğ
sha1
, 
·dbuf
, 40 );

1524 
	`sha1_fšish
Ğ
sha1
, 
sha1sum
 );

1526 
	`mem£t
Ğ
·dbuf
, 0x5C, 48 );

1528 
	`md5_¡¬ts
Ğ
md5
 );

1529 
	`md5_upd©e
Ğ
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1530 
	`md5_upd©e
Ğ
md5
, 
·dbuf
, 48 );

1531 
	`md5_upd©e
Ğ
md5
, 
md5sum
, 16 );

1532 
	`md5_fšish
Ğ
md5
, 
buf
 );

1534 
	`sha1_¡¬ts
Ğ
sha1
 );

1535 
	`sha1_upd©e
Ğ
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1536 
	`sha1_upd©e
Ğ
sha1
, 
·dbuf
 , 40 );

1537 
	`sha1_upd©e
Ğ
sha1
, 
sha1sum
, 20 );

1538 
	`sha1_fšish
Ğ
sha1
, 
buf
 + 16 );

1540 
Ën
 += 24;

1544 
£nd”
 = ( 
äom
 =ğ
SSL_IS_CLIENT
 )

1548 
	`md5_fšish
Ğ
md5
, 
·dbuf
 );

1549 
	`sha1_fšish
Ğ
sha1
, 
·dbuf
 + 16 );

1551 
	`s1_´f
Ğ
s¦
->
£ssiÚ
->
ma¡”
, 48, 
£nd”
,

1552 
·dbuf
, 36, 
buf
, 
Ën
 );

1555 
	`SSL_DEBUG_BUF
Ğ3, "ÿløfšished„esuÉ", 
buf
, 
Ën
 );

1557 
	`mem£t
Ğ
md5
, 0, Ğ
md5_cÚ‹xt
 ) );

1558 
	`mem£t
Ğ
sha1
, 0, Ğ
sha1_cÚ‹xt
 ) );

1560 
	`mem£t
Ğ
·dbuf
, 0, (…adbuf ) );

1561 
	`mem£t
Ğ
md5sum
, 0, ( md5sum ) );

1562 
	`mem£t
Ğ
sha1sum
, 0, ( sha1sum ) );

1564 
	`SSL_DEBUG_MSG
( 2, ( "<= calc finished" ) );

1565 
	}
}

1567 
	$s¦_wr™e_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1569 
»t
, 
hash_Ën
;

1570 
md5_cÚ‹xt
 
md5
;

1571 
sha1_cÚ‹xt
 
sha1
;

1573 
	`SSL_DEBUG_MSG
( 2, ( "=> write finished" ) );

1575 
	`memıy
Ğ&
md5
 , &
s¦
->
fš_md5
 , Ğ
md5_cÚ‹xt
 ) );

1576 
	`memıy
Ğ&
sha1
, &
s¦
->
fš_sha1
, Ğ
sha1_cÚ‹xt
 ) );

1578 
	`s¦_ÿlc_fšished
Ğ
s¦
, s¦->
out_msg
 + 4,

1579 
s¦
->
’dpošt
, &
md5
, &
sha1
 );

1581 
hash_Ën
 = ( 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 ) ? 36 : 12;

1583 
s¦
->
out_msgËn
 = 4 + 
hash_Ën
;

1584 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

1585 
s¦
->
out_msg
[0] = 
SSL_HS_FINISHED
;

1591 ifĞ
s¦
->
»sume
 != 0 )

1593 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1594 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

1596 
s¦
->
¡©e
 = 
SSL_CLIENT_CHANGE_CIPHER_SPEC
;

1599 
s¦
->
¡©e
++;

1601 
s¦
->
do_üy±
 = 1;

1603 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

1605 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

1606 Ğ
»t
 );

1609 
	`SSL_DEBUG_MSG
( 2, ( "<= write finished" ) );

1612 
	}
}

1614 
	$s¦_·r£_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1616 
»t
, 
hash_Ën
;

1617 
md5_cÚ‹xt
 
md5
;

1618 
sha1_cÚ‹xt
 
sha1
;

1619 
buf
[36];

1621 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse finished" ) );

1623 
	`memıy
Ğ&
md5
 , &
s¦
->
fš_md5
 , Ğ
md5_cÚ‹xt
 ) );

1624 
	`memıy
Ğ&
sha1
, &
s¦
->
fš_sha1
, Ğ
sha1_cÚ‹xt
 ) );

1626 
s¦
->
do_üy±
 = 1;

1628 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1630 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1631 Ğ
»t
 );

1634 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

1636 
	`SSL_DEBUG_MSG
( 1, ( "bad finished message" ) );

1637 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

1640 
hash_Ën
 = ( 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 ) ? 36 : 12;

1642 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_FINISHED
 ||

1643 
s¦
->
š_h¦’
 !ğ4 + 
hash_Ën
 )

1645 
	`SSL_DEBUG_MSG
( 1, ( "bad finished message" ) );

1646 Ğ
POLARSSL_ERR_SSL_BAD_HS_FINISHED
 );

1649 
	`s¦_ÿlc_fšished
Ğ
s¦
, 
buf
, s¦->
’dpošt
 ^ 1, &
md5
, &
sha1
 );

1651 ifĞ
	`memcmp
Ğ
s¦
->
š_msg
 + 4, 
buf
, 
hash_Ën
 ) != 0 )

1653 
	`SSL_DEBUG_MSG
( 1, ( "bad finished message" ) );

1654 Ğ
POLARSSL_ERR_SSL_BAD_HS_FINISHED
 );

1657 ifĞ
s¦
->
»sume
 != 0 )

1659 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1660 
s¦
->
¡©e
 = 
SSL_CLIENT_CHANGE_CIPHER_SPEC
;

1662 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 )

1663 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

1666 
s¦
->
¡©e
++;

1668 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse finished" ) );

1671 
	}
}

1676 
	$s¦_š™
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1678 
Ën
 = 
SSL_BUFFER_LEN
;

1680 
	`mem£t
Ğ
s¦
, 0, Ğ
s¦_cÚ‹xt
 ) );

1682 
s¦
->
š_ùr
 = (*è
	`m®loc
Ğ
Ën
 );

1683 
s¦
->
š_hdr
 = s¦->
š_ùr
 + 8;

1684 
s¦
->
š_msg
 = s¦->
š_ùr
 + 13;

1686 ifĞ
s¦
->
š_ùr
 =ğ
NULL
 )

1688 
	`SSL_DEBUG_MSG
Ğ1, ( "m®loc(%d by‹sèçed", 
Ën
 ) );

1692 
s¦
->
out_ùr
 = (*è
	`m®loc
Ğ
Ën
 );

1693 
s¦
->
out_hdr
 = s¦->
out_ùr
 + 8;

1694 
s¦
->
out_msg
 = s¦->
out_ùr
 + 13;

1696 ifĞ
s¦
->
out_ùr
 =ğ
NULL
 )

1698 
	`SSL_DEBUG_MSG
Ğ1, ( "m®loc(%d by‹sèçed", 
Ën
 ) );

1699 
	`ä“
Ğ
s¦
-> 
š_ùr
 );

1703 
	`mem£t
Ğ
s¦
-> 
š_ùr
, 0, 
SSL_BUFFER_LEN
 );

1704 
	`mem£t
Ğ
s¦
->
out_ùr
, 0, 
SSL_BUFFER_LEN
 );

1706 
s¦
->
ho¡Çme
 = 
NULL
;

1707 
s¦
->
ho¡Çme_Ën
 = 0;

1709 
	`md5_¡¬ts
Ğ&
s¦
->
fš_md5
 );

1710 
	`sha1_¡¬ts
Ğ&
s¦
->
fš_sha1
 );

1713 
	}
}

1718 
	$s¦_£t_’dpošt
Ğ
s¦_cÚ‹xt
 *
s¦
, 
’dpošt
 )

1720 
s¦
->
’dpošt
 =ƒndpoint;

1721 
	}
}

1723 
	$s¦_£t_authmode
Ğ
s¦_cÚ‹xt
 *
s¦
, 
authmode
 )

1725 
s¦
->
authmode
 =‡uthmode;

1726 
	}
}

1728 
s¦_£t_ºg
Ğ
s¦_cÚ‹xt
 *
s¦
,

1729 (*
f_ºg
)(*),

1730 *
p_ºg
 )

1732 
s¦
->
f_ºg
 = f_rng;

1733 
s¦
->
p_ºg
 =…_rng;

1734 
	}
}

1736 
s¦_£t_dbg
Ğ
s¦_cÚ‹xt
 *
s¦
,

1737 (*
f_dbg
)(*, , const *),

1738 *
p_dbg
 )

1740 
s¦
->
f_dbg
 = f_dbg;

1741 
s¦
->
p_dbg
 =…_dbg;

1742 
	}
}

1744 
s¦_£t_bio
Ğ
s¦_cÚ‹xt
 *
s¦
,

1745 (*
f_»cv
)(*, *, ), *
p_»cv
,

1746 (*
f_£nd
)(*, *, ), *
p_£nd
 )

1748 
s¦
->
f_»cv
 = f_recv;

1749 
s¦
->
f_£nd
 = f_send;

1750 
s¦
->
p_»cv
 =…_recv;

1751 
s¦
->
p_£nd
 =…_send;

1752 
	}
}

1754 
s¦_£t_scb
Ğ
s¦_cÚ‹xt
 *
s¦
,

1755 (*
s_g‘
)(
s¦_cÚ‹xt
 *),

1756 (*
s_£t
)(
s¦_cÚ‹xt
 *) )

1758 
s¦
->
s_g‘
 = s_get;

1759 
s¦
->
s_£t
 = s_set;

1760 
	}
}

1762 
	$s¦_£t_£ssiÚ
Ğ
s¦_cÚ‹xt
 *
s¦
, 
»sume
, 
timeout
,

1763 
s¦_£ssiÚ
 *
£ssiÚ
 )

1765 
s¦
->
»sume
 =„esume;

1766 
s¦
->
timeout
 =imeout;

1767 
s¦
->
£ssiÚ
 = session;

1768 
	}
}

1770 
	$s¦_£t_ch”s
Ğ
s¦_cÚ‹xt
 *
s¦
, *
ch”s
 )

1772 
s¦
->
ch”s
 = ciphers;

1773 
	}
}

1775 
	$s¦_£t_ÿ_chaš
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
ÿ_chaš
,

1776 
x509_ül
 *
ÿ_ül
, cÚ¡ *
³”_ú
 )

1778 
s¦
->
ÿ_chaš
 = ca_chain;

1779 
s¦
->
ÿ_ül
 = ca_crl;

1780 
s¦
->
³”_ú
 =…eer_cn;

1781 
	}
}

1783 
	$s¦_£t_own_û¹
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
own_û¹
,

1784 
r§_cÚ‹xt
 *
r§_key
 )

1786 
s¦
->
own_û¹
 = own_cert;

1787 
s¦
->
r§_key
 =„sa_key;

1788 
	}
}

1790 
	$s¦_£t_dh_·¿m
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
dhm_P
, cÚ¡ *
dhm_G
 )

1792 
»t
;

1794 ifĞĞ
»t
 = 
	`mpi_»ad_¡ršg
Ğ&
s¦
->
dhm_ùx
.
P
, 16, 
dhm_P
 ) ) != 0 )

1796 
	`SSL_DEBUG_RET
Ğ1, "mpi_»ad_¡ršg", 
»t
 );

1797 Ğ
»t
 );

1800 ifĞĞ
»t
 = 
	`mpi_»ad_¡ršg
Ğ&
s¦
->
dhm_ùx
.
G
, 16, 
dhm_G
 ) ) != 0 )

1802 
	`SSL_DEBUG_RET
Ğ1, "mpi_»ad_¡ršg", 
»t
 );

1803 Ğ
»t
 );

1807 
	}
}

1809 
	$s¦_£t_ho¡Çme
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
ho¡Çme
 )

1811 ifĞ
ho¡Çme
 =ğ
NULL
 )

1812 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

1814 
s¦
->
ho¡Çme_Ën
 = 
	`¡¾’
Ğ
ho¡Çme
 );

1815 
s¦
->
ho¡Çme
 = (*è
	`m®loc
Ğs¦->
ho¡Çme_Ën
 + 1 );

1817 
	`memıy
Ğ
s¦
->
ho¡Çme
, (*) hostname,

1818 
s¦
->
ho¡Çme_Ën
 );

1820 
s¦
->
ho¡Çme
[s¦->
ho¡Çme_Ën
] = '\0';

1823 
	}
}

1828 
	$s¦_g‘_by‹s_ava
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 )

1830 Ğ
s¦
->
š_ofá
 =ğ
NULL
 ? 0 : s¦->
š_msgËn
 );

1831 
	}
}

1833 
	$s¦_g‘_v”ify_»suÉ
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 )

1835 Ğ
s¦
->
v”ify_»suÉ
 );

1836 
	}
}

1838 cÚ¡ *
	$s¦_g‘_ch”
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 )

1840  
s¦
->
£ssiÚ
->
ch”
 )

1842 #ià
	`defšed
(
POLARSSL_ARC4_C
)

1843 
SSL_RSA_RC4_128_MD5
:

1846 
SSL_RSA_RC4_128_SHA
:

1850 #ià
	`defšed
(
POLARSSL_DES_C
)

1851 
SSL_RSA_DES_168_SHA
:

1854 
SSL_EDH_RSA_DES_168_SHA
:

1858 #ià
	`defšed
(
POLARSSL_AES_C
)

1859 
SSL_RSA_AES_128_SHA
:

1862 
SSL_EDH_RSA_AES_128_SHA
:

1865 
SSL_RSA_AES_256_SHA
:

1868 
SSL_EDH_RSA_AES_256_SHA
:

1872 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

1873 
SSL_RSA_CAMELLIA_128_SHA
:

1876 
SSL_EDH_RSA_CAMELLIA_128_SHA
:

1879 
SSL_RSA_CAMELLIA_256_SHA
:

1882 
SSL_EDH_RSA_CAMELLIA_256_SHA
:

1891 
	}
}

1893 
	gs¦_deçuÉ_ch”s
[] =

1895 #ià
defšed
(
POLARSSL_DHM_C
)

1896 #ià
defšed
(
POLARSSL_AES_C
)

1897 
SSL_EDH_RSA_AES_128_SHA
,

1898 
SSL_EDH_RSA_AES_256_SHA
,

1900 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

1901 
SSL_EDH_RSA_CAMELLIA_128_SHA
,

1902 
SSL_EDH_RSA_CAMELLIA_256_SHA
,

1904 #ià
defšed
(
POLARSSL_DES_C
)

1905 
SSL_EDH_RSA_DES_168_SHA
,

1909 #ià
defšed
(
POLARSSL_AES_C
)

1910 
SSL_RSA_AES_256_SHA
,

1912 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

1913 
SSL_RSA_CAMELLIA_256_SHA
,

1915 #ià
defšed
(
POLARSSL_AES_C
)

1916 
SSL_RSA_AES_128_SHA
,

1918 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

1919 
SSL_RSA_CAMELLIA_128_SHA
,

1921 #ià
defšed
(
POLARSSL_DES_C
)

1922 
SSL_RSA_DES_168_SHA
,

1924 #ià
defšed
(
POLARSSL_ARC4_C
)

1925 
SSL_RSA_RC4_128_SHA
,

1926 
SSL_RSA_RC4_128_MD5
,

1934 
	$s¦_hªdshake
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1936 
»t
 = 
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
;

1938 
	`SSL_DEBUG_MSG
( 2, ( "=> handshake" ) );

1940 #ià
	`defšed
(
POLARSSL_SSL_CLI_C
)

1941 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1942 
»t
 = 
	`s¦_hªdshake_ş›Á
Ğ
s¦
 );

1945 #ià
	`defšed
(
POLARSSL_SSL_SRV_C
)

1946 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 )

1947 
»t
 = 
	`s¦_hªdshake_£rv”
Ğ
s¦
 );

1950 
	`SSL_DEBUG_MSG
( 2, ( "<= handshake" ) );

1952 Ğ
»t
 );

1953 
	}
}

1958 
	$s¦_»ad
Ğ
s¦_cÚ‹xt
 *
s¦
, *
buf
, 
Ën
 )

1960 
»t
, 
n
;

1962 
	`SSL_DEBUG_MSG
( 2, ( "=>„ead" ) );

1964 ifĞ
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

1966 ifĞĞ
»t
 = 
	`s¦_hªdshake
Ğ
s¦
 ) ) != 0 )

1968 
	`SSL_DEBUG_RET
Ğ1, "s¦_hªdshake", 
»t
 );

1969 Ğ
»t
 );

1973 ifĞ
s¦
->
š_ofá
 =ğ
NULL
 )

1975 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1977 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1978 Ğ
»t
 );

1981 ifĞ
s¦
->
š_msgËn
 == 0 &&

1982 
s¦
->
š_msgty³
 =ğ
SSL_MSG_APPLICATION_DATA
 )

1987 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1989 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1990 Ğ
»t
 );

1994 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_APPLICATION_DATA
 )

1996 
	`SSL_DEBUG_MSG
( 1, ( "bad‡pplication data message" ) );

1997 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

2000 
s¦
->
š_ofá
 = s¦->
š_msg
;

2003 
n
 = ( 
Ën
 < 
s¦
->
š_msgËn
 )

2004 ? 
Ën
 : 
s¦
->
š_msgËn
;

2006 
	`memıy
Ğ
buf
, 
s¦
->
š_ofá
, 
n
 );

2007 
s¦
->
š_msgËn
 -ğ
n
;

2009 ifĞ
s¦
->
š_msgËn
 == 0 )

2011 
s¦
->
š_ofá
 = 
NULL
;

2014 
s¦
->
š_ofá
 +ğ
n
;

2016 
	`SSL_DEBUG_MSG
( 2, ( "<=„ead" ) );

2018 Ğ
n
 );

2019 
	}
}

2024 
	$s¦_wr™e
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
buf
, 
Ën
 )

2026 
»t
, 
n
;

2028 
	`SSL_DEBUG_MSG
( 2, ( "=> write" ) );

2030 ifĞ
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

2032 ifĞĞ
»t
 = 
	`s¦_hªdshake
Ğ
s¦
 ) ) != 0 )

2034 
	`SSL_DEBUG_RET
Ğ1, "s¦_hªdshake", 
»t
 );

2035 Ğ
»t
 );

2039 
n
 = ( 
Ën
 < 
SSL_MAX_CONTENT_LEN
 )

2040 ? 
Ën
 : 
SSL_MAX_CONTENT_LEN
;

2042 ifĞ
s¦
->
out_Ëá
 != 0 )

2044 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

2046 
	`SSL_DEBUG_RET
Ğ1, "s¦_æush_ouut", 
»t
 );

2047 Ğ
»t
 );

2052 
s¦
->
out_msgËn
 = 
n
;

2053 
s¦
->
out_msgty³
 = 
SSL_MSG_APPLICATION_DATA
;

2054 
	`memıy
Ğ
s¦
->
out_msg
, 
buf
, 
n
 );

2056 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

2058 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

2059 Ğ
»t
 );

2063 
	`SSL_DEBUG_MSG
( 2, ( "<= write" ) );

2065 Ğ
n
 );

2066 
	}
}

2071 
	$s¦_şo£_nÙify
Ğ
s¦_cÚ‹xt
 *
s¦
 )

2073 
»t
;

2075 
	`SSL_DEBUG_MSG
( 2, ( "=> write close‚otify" ) );

2077 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

2079 
	`SSL_DEBUG_RET
Ğ1, "s¦_æush_ouut", 
»t
 );

2080 Ğ
»t
 );

2083 ifĞ
s¦
->
¡©e
 =ğ
SSL_HANDSHAKE_OVER
 )

2085 
s¦
->
out_msgty³
 = 
SSL_MSG_ALERT
;

2086 
s¦
->
out_msgËn
 = 2;

2087 
s¦
->
out_msg
[0] = 
SSL_ALERT_LEVEL_WARNING
;

2088 
s¦
->
out_msg
[1] = 
SSL_ALERT_MSG_CLOSE_NOTIFY
;

2090 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

2092 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

2093 Ğ
»t
 );

2097 
	`SSL_DEBUG_MSG
( 2, ( "<= write close‚otify" ) );

2099 Ğ
»t
 );

2100 
	}
}

2105 
	$s¦_ä“
Ğ
s¦_cÚ‹xt
 *
s¦
 )

2107 
	`SSL_DEBUG_MSG
( 2, ( "=> free" ) );

2109 ifĞ
s¦
->
³”_û¹
 !ğ
NULL
 )

2111 
	`x509_ä“
Ğ
s¦
->
³”_û¹
 );

2112 
	`mem£t
Ğ
s¦
->
³”_û¹
, 0, Ğ
x509_û¹
 ) );

2113 
	`ä“
Ğ
s¦
->
³”_û¹
 );

2116 ifĞ
s¦
->
out_ùr
 !ğ
NULL
 )

2118 
	`mem£t
Ğ
s¦
->
out_ùr
, 0, 
SSL_BUFFER_LEN
 );

2119 
	`ä“
Ğ
s¦
->
out_ùr
 );

2122 ifĞ
s¦
->
š_ùr
 !ğ
NULL
 )

2124 
	`mem£t
Ğ
s¦
->
š_ùr
, 0, 
SSL_BUFFER_LEN
 );

2125 
	`ä“
Ğ
s¦
->
š_ùr
 );

2128 #ià
	`defšed
(
POLARSSL_DHM_C
)

2129 
	`dhm_ä“
Ğ&
s¦
->
dhm_ùx
 );

2132 iàĞ
s¦
->
ho¡Çme
 !ğ
NULL
)

2134 
	`mem£t
Ğ
s¦
->
ho¡Çme
, 0, s¦->
ho¡Çme_Ën
 );

2135 
	`ä“
Ğ
s¦
->
ho¡Çme
 );

2136 
s¦
->
ho¡Çme_Ën
 = 0;

2139 
	`SSL_DEBUG_MSG
( 2, ( "<= free" ) );

2142 
	`mem£t
Ğ
s¦
, 0, Ğ
s¦_cÚ‹xt
 ) );

2143 
	}
}

	@src/polarssl/timing.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_TIMING_C
)

30 
	~"pŞ¬s¦/timšg.h
"

32 #ià
defšed
(
_WIN32
)

34 
	~<wšdows.h
>

35 
	~<wšba£.h
>

37 
	s_hr_time


39 
LARGE_INTEGER
 
	m¡¬t
;

44 
	~<uni¡d.h
>

45 
	~<sys/ty³s.h
>

46 
	~<sys/time.h
>

47 
	~<sigÇl.h
>

48 
	~<time.h
>

50 
	s_hr_time


52 
timev®
 
	m¡¬t
;

57 #ià
defšed
(
POLARSSL_HAVE_ASM
) && \

58 (
defšed
(
_MSC_VER
è&& defšed(
_M_IX86
)è|| 
	$defšed
(
__WATCOMC__
)

60 
	$h¬dşock
( )

62 
tsc
;

63 
__asm
 
rdtsc


64 
__asm
 
mov
 [
tsc
], 
—x


65 Ğ
tsc
 );

66 
	}
}

69 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__i386__
)

71 
	$h¬dşock
( )

73 
tsc
;

74 
	`asm
Ğ"rdtsc" : "÷" (
tsc
) );

75 Ğ
tsc
 );

76 
	}
}

79 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
) && \

80 (
defšed
(
__amd64__
è|| 
	$defšed
(
__x86_64__
))

82 
	$h¬dşock
( )

84 
lo
, 
hi
;

85 
	`asm
Ğ"rdtsc" : "÷" (
lo
), "=d" (
hi
) );

86 Ğ
lo
 | (
hi
 << 32) );

87 
	}
}

90 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
) && \

91 (
defšed
(
__pow”pc__
è|| 
	$defšed
(
__µc__
))

93 
	$h¬dşock
( )

95 
tbl
, 
tbu0
, 
tbu1
;

99 
	`asm
Ğ"mábu %0" : "ô" (
tbu0
) );

100 
	`asm
Ğ"máb %0" : "ô" (
tbl
 ) );

101 
	`asm
Ğ"mábu %0" : "ô" (
tbu1
) );

103  
tbu0
 !ğ
tbu1
 );

105 Ğ
tbl
 );

106 
	}
}

109 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__¥¬c__
)

111 
	$h¬dşock
( )

113 
tick
;

114 
	`asm
( ".byte 0x83, 0x41, 0x00, 0x00" );

115 
	`asm
Ğ"mov %%g1, %0" : "ô" (
tick
) );

116 Ğ
tick
 );

117 
	}
}

120 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__®pha__
)

122 
	$h¬dşock
( )

124 
cc
;

125 
	`asm
Ğ"½cø%0" : "ô" (
cc
) );

126 Ğ
cc
 & 0xFFFFFFFF );

127 
	}
}

130 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__Ÿ64__
)

132 
	$h¬dşock
( )

134 
™c
;

135 
	`asm
Ğ"mov %0 =‡r.™c" : "ô" (
™c
) );

136 Ğ
™c
 );

137 
	}
}

141 
	gh¬dşock_š™
 = 0;

142 
timev®
 
	gtv_š™
;

144 
	$h¬dşock
( )

146 
timev®
 
tv_cur
;

148 ifĞ
h¬dşock_š™
 == 0 )

150 
	`g‘timeofday
Ğ&
tv_š™
, 
NULL
 );

151 
h¬dşock_š™
 = 1;

154 
	`g‘timeofday
Ğ&
tv_cur
, 
NULL
 );

155 ĞĞ
tv_cur
.
tv_£c
 - 
tv_š™
.tv_sec ) * 1000000

156 + ( 
tv_cur
.
tv_u£c
 - 
tv_š™
.tv_usec ) );

157 
	}
}

167 
	g®¬med
 = 0;

169 #ià
defšed
(
_WIN32
)

171 
	$g‘_tim”
Ğ
hr_time
 *
v®
, 
»£t
 )

173 
d–
;

174 
LARGE_INTEGER
 
off£t
, 
häeq
;

175 
_hr_time
 *
t
 = (_hr_tim*è
v®
;

177 
	`Qu”yP”fÜmªûCouÁ”
Ğ&
off£t
 );

178 
	`Qu”yP”fÜmªûF»qu’cy
Ğ&
häeq
 );

180 
d–
 = ()( ( 1000 *

181 Ğ
off£t
.
QuadP¬t
 - 
t
->
¡¬t
.QuadPart ) ) /

182 
häeq
.
QuadP¬t
 );

184 ifĞ
»£t
 )

185 
	`Qu”yP”fÜmªûCouÁ”
Ğ&
t
->
¡¬t
 );

187 Ğ
d–
 );

188 
	}
}

190 
DWORD
 
WINAPI
 
	$Tim”Proc
Ğ
LPVOID
 
uEÏp£
 )

192 
	`SË•
Ğ(
DWORD
è
uEÏp£
 );

193 
®¬med
 = 1;

194 Ğ
TRUE
 );

195 
	}
}

197 
	$£t_®¬m
Ğ
£cÚds
 )

199 
DWORD
 
Th»adId
;

201 
®¬med
 = 0;

202 
	`Clo£HªdË
Ğ
	`C»©eTh»ad
Ğ
NULL
, 0, 
Tim”Proc
,

203 (
LPVOID
èĞ
£cÚds
 * 1000 ), 0, &
Th»adId
 ) );

204 
	}
}

206 
	$m_¦“p
Ğ
mli£cÚds
 )

208 
	`SË•
Ğ
mli£cÚds
 );

209 
	}
}

213 
	$g‘_tim”
Ğ
hr_time
 *
v®
, 
»£t
 )

215 
d–
;

216 
timev®
 
off£t
;

217 
_hr_time
 *
t
 = (_hr_tim*è
v®
;

219 
	`g‘timeofday
Ğ&
off£t
, 
NULL
 );

221 
d–
 = ( 
off£t
.
tv_£c
 - 
t
->
¡¬t
.tv_sec ) * 1000

222 + ( 
off£t
.
tv_u£c
 - 
t
->
¡¬t
.tv_usec ) / 1000;

224 ifĞ
»£t
 )

226 
t
->
¡¬t
.
tv_£c
 = 
off£t
.tv_sec;

227 
t
->
¡¬t
.
tv_u£c
 = 
off£t
.tv_usec;

230 Ğ
d–
 );

231 
	}
}

233 
	$sighªdËr
Ğ
signum
 )

235 
®¬med
 = 1;

236 
	`sigÇl
Ğ
signum
, 
sighªdËr
 );

237 
	}
}

239 
	$£t_®¬m
Ğ
£cÚds
 )

241 
®¬med
 = 0;

242 
	`sigÇl
Ğ
SIGALRM
, 
sighªdËr
 );

243 
	`®¬m
Ğ
£cÚds
 );

244 
	}
}

246 
	$m_¦“p
Ğ
mli£cÚds
 )

248 
timev®
 
tv
;

250 
tv
.
tv_£c
 = 
mli£cÚds
 / 1000;

251 
tv
.
tv_u£c
 = 
mli£cÚds
 * 1000;

253 
	`£Ëù
Ğ0, 
NULL
, NULL, NULL, &
tv
 );

254 
	}
}

	@src/polarssl/timing.h

25 #iâdeà
POLARSSL_TIMING_H


26 
	#POLARSSL_TIMING_H


	)

31 
	shr_time


33 
	mİaque
[32];

36 #ifdeà
__ılu¥lus


40 
®¬med
;

45 
h¬dşock
( );

53 
g‘_tim”
Ğ
hr_time
 *
v®
, 
»£t
 );

60 
£t_®¬m
Ğ
£cÚds
 );

67 
m_¦“p
Ğ
mli£cÚds
 );

69 #ifdeà
__ılu¥lus


	@src/polarssl/version.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_VERSION_C
)

30 
	~"pŞ¬s¦/v”siÚ.h
"

31 
	~<¡ršg.h
>

33 cÚ¡ 
	gv”siÚ
[] = 
POLARSSL_VERSION_STRING
;

35 
	$v”siÚ_g‘_numb”
()

37  
POLARSSL_VERSION_NUMBER
;

38 
	}
}

40 
	$v”siÚ_g‘_¡ršg
Ğ*
¡ršg
 )

42 
	`memıy
Ğ
¡ršg
, 
POLARSSL_VERSION_STRING
, ( POLARSSL_VERSION_STRING ) );

43 
	}
}

45 
	$v”siÚ_g‘_¡ršg_fuÎ
Ğ*
¡ršg
 )

47 
	`memıy
Ğ
¡ršg
, 
POLARSSL_VERSION_STRING_FULL
, ( POLARSSL_VERSION_STRING_FULL ) );

48 
	}
}

	@src/polarssl/version.h

28 #iâdeà
POLARSSL_VERSION_H


29 
	#POLARSSL_VERSION_H


	)

31 
	~"pŞ¬s¦/cÚfig.h
"

37 
	#POLARSSL_VERSION_MAJOR
 0

	)

38 
	#POLARSSL_VERSION_MINOR
 14

	)

39 
	#POLARSSL_VERSION_PATCH
 3

	)

46 
	#POLARSSL_VERSION_NUMBER
 0x000E0300

	)

47 
	#POLARSSL_VERSION_STRING
 "0.14.3"

	)

48 
	#POLARSSL_VERSION_STRING_FULL
 "PŞ¬SSL 0.14.3"

	)

50 #ià
defšed
(
POLARSSL_VERSION_C
)

58 
v”siÚ_g‘_numb”
();

66 
v”siÚ_g‘_¡ršg
Ğ*
¡ršg
 );

74 
v”siÚ_g‘_¡ršg_fuÎ
Ğ*
¡ršg
 );

	@src/polarssl/x509.h

25 #iâdeà
POLARSSL_X509_H


26 
	#POLARSSL_X509_H


	)

28 
	~"pŞ¬s¦/r§.h
"

36 
	#POLARSSL_ERR_ASN1_OUT_OF_DATA
 0x0014

	)

37 
	#POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 0x0016

	)

38 
	#POLARSSL_ERR_ASN1_INVALID_LENGTH
 0x0018

	)

39 
	#POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 0x001A

	)

40 
	#POLARSSL_ERR_ASN1_INVALID_DATA
 0x001C

	)

45 
	#POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 -0x0020

	)

46 
	#POLARSSL_ERR_X509_CERT_INVALID_PEM
 -0x0040

	)

47 
	#POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 -0x0060

	)

48 
	#POLARSSL_ERR_X509_CERT_INVALID_VERSION
 -0x0080

	)

49 
	#POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 -0x00A0

	)

50 
	#POLARSSL_ERR_X509_CERT_INVALID_ALG
 -0x00C0

	)

51 
	#POLARSSL_ERR_X509_CERT_INVALID_NAME
 -0x00E0

	)

52 
	#POLARSSL_ERR_X509_CERT_INVALID_DATE
 -0x0100

	)

53 
	#POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 -0x0120

	)

54 
	#POLARSSL_ERR_X509_CERT_INVALID_SIGNATURE
 -0x0140

	)

55 
	#POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 -0x0160

	)

56 
	#POLARSSL_ERR_X509_CERT_UNKNOWN_VERSION
 -0x0180

	)

57 
	#POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 -0x01A0

	)

58 
	#POLARSSL_ERR_X509_CERT_UNKNOWN_PK_ALG
 -0x01C0

	)

59 
	#POLARSSL_ERR_X509_CERT_SIG_MISMATCH
 -0x01E0

	)

60 
	#POLARSSL_ERR_X509_CERT_VERIFY_FAILED
 -0x0200

	)

61 
	#POLARSSL_ERR_X509_KEY_INVALID_PEM
 -0x0220

	)

62 
	#POLARSSL_ERR_X509_KEY_INVALID_VERSION
 -0x0240

	)

63 
	#POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 -0x0260

	)

64 
	#POLARSSL_ERR_X509_KEY_INVALID_ENC_IV
 -0x0280

	)

65 
	#POLARSSL_ERR_X509_KEY_UNKNOWN_ENC_ALG
 -0x02A0

	)

66 
	#POLARSSL_ERR_X509_KEY_PASSWORD_REQUIRED
 -0x02C0

	)

67 
	#POLARSSL_ERR_X509_KEY_PASSWORD_MISMATCH
 -0x02E0

	)

68 
	#POLARSSL_ERR_X509_POINT_ERROR
 -0x0300

	)

69 
	#POLARSSL_ERR_X509_VALUE_TO_LENGTH
 -0x0320

	)

74 
	#BADCERT_EXPIRED
 1

	)

75 
	#BADCERT_REVOKED
 2

	)

76 
	#BADCERT_CN_MISMATCH
 4

	)

77 
	#BADCERT_NOT_TRUSTED
 8

	)

78 
	#BADCRL_NOT_TRUSTED
 16

	)

79 
	#BADCRL_EXPIRED
 32

	)

84 
	#ASN1_BOOLEAN
 0x01

	)

85 
	#ASN1_INTEGER
 0x02

	)

86 
	#ASN1_BIT_STRING
 0x03

	)

87 
	#ASN1_OCTET_STRING
 0x04

	)

88 
	#ASN1_NULL
 0x05

	)

89 
	#ASN1_OID
 0x06

	)

90 
	#ASN1_UTF8_STRING
 0x0C

	)

91 
	#ASN1_SEQUENCE
 0x10

	)

92 
	#ASN1_SET
 0x11

	)

93 
	#ASN1_PRINTABLE_STRING
 0x13

	)

94 
	#ASN1_T61_STRING
 0x14

	)

95 
	#ASN1_IA5_STRING
 0x16

	)

96 
	#ASN1_UTC_TIME
 0x17

	)

97 
	#ASN1_GENERALIZED_TIME
 0x18

	)

98 
	#ASN1_UNIVERSAL_STRING
 0x1C

	)

99 
	#ASN1_BMP_STRING
 0x1E

	)

100 
	#ASN1_PRIMITIVE
 0x00

	)

101 
	#ASN1_CONSTRUCTED
 0x20

	)

102 
	#ASN1_CONTEXT_SPECIFIC
 0x80

	)

107 
	#X520_COMMON_NAME
 3

	)

108 
	#X520_COUNTRY
 6

	)

109 
	#X520_LOCALITY
 7

	)

110 
	#X520_STATE
 8

	)

111 
	#X520_ORGANIZATION
 10

	)

112 
	#X520_ORG_UNIT
 11

	)

113 
	#PKCS9_EMAIL
 1

	)

115 
	#X509_OUTPUT_DER
 0x01

	)

116 
	#X509_OUTPUT_PEM
 0x02

	)

117 
	#PEM_LINE_LENGTH
 72

	)

118 
	#X509_ISSUER
 0x01

	)

119 
	#X509_SUBJECT
 0x02

	)

121 
	#OID_X520
 "\x55\x04"

	)

122 
	#OID_CN
 "\x55\x04\x03"

	)

123 
	#OID_PKCS1
 "\x2A\x86\x48\x86\xF7\x0D\x01\x01"

	)

124 
	#OID_PKCS1_RSA
 "\x2A\x86\x48\x86\xF7\x0D\x01\x01\x01"

	)

125 
	#OID_RSA_SHA_OBS
 "\x2B\x0E\x03\x02\x1D"

	)

126 
	#OID_PKCS9
 "\x2A\x86\x48\x86\xF7\x0D\x01\x09"

	)

127 
	#OID_PKCS9_EMAIL
 "\x2A\x86\x48\x86\xF7\x0D\x01\x09\x01"

	)

132 
	s_x509_buf


134 
	mg
;

135 
	mËn
;

136 *
	mp
;

138 
	tx509_buf
;

140 
	s_x509_Çme


142 
x509_buf
 
	moid
;

143 
x509_buf
 
	mv®
;

144 
_x509_Çme
 *
	mÃxt
;

146 
	tx509_Çme
;

148 
	s_x509_time


150 
	my—r
, 
	mmÚ
, 
	mday
;

151 
	mhour
, 
	mmš
, 
	m£c
;

153 
	tx509_time
;

155 
	s_x509_û¹


157 
x509_buf
 
	m¿w
;

158 
x509_buf
 
	mtbs
;

160 
	mv”siÚ
;

161 
x509_buf
 
	m£rŸl
;

162 
x509_buf
 
	msig_oid1
;

164 
x509_buf
 
	missu”_¿w
;

165 
x509_buf
 
	msubjeù_¿w
;

167 
x509_Çme
 
	missu”
;

168 
x509_Çme
 
	msubjeù
;

170 
x509_time
 
	mv®id_äom
;

171 
x509_time
 
	mv®id_to
;

173 
x509_buf
 
	mpk_oid
;

174 
r§_cÚ‹xt
 
	mr§
;

176 
x509_buf
 
	missu”_id
;

177 
x509_buf
 
	msubjeù_id
;

178 
x509_buf
 
	mv3_ext
;

180 
	mÿ_i¡rue
;

181 
	mmax_·thËn
;

183 
x509_buf
 
	msig_oid2
;

184 
x509_buf
 
	msig
;

185 
	msig_®g
;

187 
_x509_û¹
 *
	mÃxt
;

189 
	tx509_û¹
;

191 
	s_x509_ül_’Œy


193 
x509_buf
 
	m¿w
;

195 
x509_buf
 
	m£rŸl
;

197 
x509_time
 
	m»voÿtiÚ_d©e
;

199 
x509_buf
 
	m’Œy_ext
;

201 
_x509_ül_’Œy
 *
	mÃxt
;

203 
	tx509_ül_’Œy
;

205 
	s_x509_ül


207 
x509_buf
 
	m¿w
;

208 
x509_buf
 
	mtbs
;

210 
	mv”siÚ
;

211 
x509_buf
 
	msig_oid1
;

213 
x509_buf
 
	missu”_¿w
;

215 
x509_Çme
 
	missu”
;

217 
x509_time
 
	mthis_upd©e
;

218 
x509_time
 
	mÃxt_upd©e
;

220 
x509_ül_’Œy
 
	m’Œy
;

222 
x509_buf
 
	mül_ext
;

224 
x509_buf
 
	msig_oid2
;

225 
x509_buf
 
	msig
;

226 
	msig_®g
;

228 
_x509_ül
 *
	mÃxt
;

230 
	tx509_ül
;

235 
	s_x509_node


237 *
	md©a
;

238 *
	mp
;

239 *
	m’d
;

241 
size_t
 
	mËn
;

243 
	tx509_node
;

245 
	s_x509_¿w


247 
x509_node
 
	m¿w
;

248 
x509_node
 
	mtbs
;

250 
x509_node
 
	mv”siÚ
;

251 
x509_node
 
	m£rŸl
;

252 
x509_node
 
	mtbs_sigÇlg
;

253 
x509_node
 
	missu”
;

254 
x509_node
 
	mv®id™y
;

255 
x509_node
 
	msubjeù
;

256 
x509_node
 
	msubpubkey
;

258 
x509_node
 
	msigÇlg
;

259 
x509_node
 
	msign
;

261 
	tx509_¿w
;

263 #ifdeà
__ılu¥lus


277 
x509·r£_üt
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 );

288 
x509·r£_ütfe
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
·th
 );

300 
x509·r£_ül
Ğ
x509_ül
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 );

311 
x509·r£_ülfe
Ğ
x509_ül
 *
chaš
, cÚ¡ *
·th
 );

324 
x509·r£_key
Ğ
r§_cÚ‹xt
 *
r§
,

325 cÚ¡ *
key
, 
keyËn
,

326 cÚ¡ *
pwd
, 
pwdËn
 );

337 
x509·r£_keyfe
Ğ
r§_cÚ‹xt
 *
r§
, cÚ¡ *
·th
,

338 cÚ¡ *
·sswÜd
 );

351 
x509·r£_dn_g‘s
Ğ*
buf
, 
size_t
 
size
, cÚ¡ 
x509_Çme
 *
dn
 );

365 
x509·r£_û¹_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

366 cÚ¡ 
x509_û¹
 *
üt
 );

380 
x509·r£_ül_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

381 cÚ¡ 
x509_ül
 *
ül
 );

392 
x509·r£_time_expœed
ĞcÚ¡ 
x509_time
 *
time
 );

414 
x509·r£_v”ify
Ğ
x509_û¹
 *
üt
,

415 
x509_û¹
 *
Œu¡_ÿ
,

416 
x509_ül
 *
ÿ_ül
,

417 cÚ¡ *
ú
, *
æags
 );

424 
x509_ä“
Ğ
x509_û¹
 *
üt
 );

431 
x509_ül_ä“
Ğ
x509_ül
 *
ül
 );

438 
x509_£lf_‹¡
Ğ
v”bo£
 );

440 #ifdeà
__ılu¥lus


	@src/polarssl/x509parse.c

37 
	~"pŞ¬s¦/cÚfig.h
"

39 #ià
defšed
(
POLARSSL_X509_PARSE_C
)

41 
	~"pŞ¬s¦/x509.h
"

42 
	~"pŞ¬s¦/ba£64.h
"

43 
	~"pŞ¬s¦/des.h
"

44 
	~"pŞ¬s¦/md2.h
"

45 
	~"pŞ¬s¦/md4.h
"

46 
	~"pŞ¬s¦/md5.h
"

47 
	~"pŞ¬s¦/sha1.h
"

48 
	~"pŞ¬s¦/sha2.h
"

49 
	~"pŞ¬s¦/sha4.h
"

51 
	~<¡ršg.h
>

52 
	~<¡dlib.h
>

53 
	~<¡dio.h
>

54 
	~<time.h
>

59 
	$a¢1_g‘_Ën
Ğ**
p
,

60 cÚ¡ *
’d
,

61 *
Ën
 )

63 ifĞĞ
’d
 - *
p
 ) < 1 )

64 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

66 ifĞĞ**
p
 & 0x80 ) == 0 )

67 *
Ën
 = *(*
p
)++;

70  **
p
 & 0x7F )

73 ifĞĞ
’d
 - *
p
 ) < 2 )

74 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

76 *
Ën
 = (*
p
)[1];

77 (*
p
) += 2;

81 ifĞĞ
’d
 - *
p
 ) < 3 )

82 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

84 *
Ën
 = ( (*
p
)[1] << 8 ) | (*p)[2];

85 (*
p
) += 3;

89 Ğ
POLARSSL_ERR_ASN1_INVALID_LENGTH
 );

94 ifĞ*
Ën
 > (èĞ
’d
 - *
p
 ) )

95 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

98 
	}
}

100 
	$a¢1_g‘_g
Ğ**
p
,

101 cÚ¡ *
’d
,

102 *
Ën
, 
g
 )

104 ifĞĞ
’d
 - *
p
 ) < 1 )

105 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

107 ifĞ**
p
 !ğ
g
 )

108 Ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

110 (*
p
)++;

112 Ğ
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, 
Ën
 ) );

113 
	}
}

115 
	$a¢1_g‘_boŞ
Ğ**
p
,

116 cÚ¡ *
’d
,

117 *
v®
 )

119 
»t
, 
Ën
;

121 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_BOOLEAN
 ) ) != 0 )

122 Ğ
»t
 );

124 ifĞ
Ën
 != 1 )

125 Ğ
POLARSSL_ERR_ASN1_INVALID_LENGTH
 );

127 *
v®
 = ( **
p
 != 0 ) ? 1 : 0;

128 (*
p
)++;

131 
	}
}

133 
	$a¢1_g‘_št
Ğ**
p
,

134 cÚ¡ *
’d
,

135 *
v®
 )

137 
»t
, 
Ën
;

139 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_INTEGER
 ) ) != 0 )

140 Ğ
»t
 );

142 ifĞ
Ën
 > (èĞè|| ( **
p
 & 0x80 ) != 0 )

143 Ğ
POLARSSL_ERR_ASN1_INVALID_LENGTH
 );

145 *
v®
 = 0;

147  
Ën
-- > 0 )

149 *
v®
 = ( *v® << 8 ) | **
p
;

150 (*
p
)++;

154 
	}
}

156 
	$a¢1_g‘_mpi
Ğ**
p
,

157 cÚ¡ *
’d
,

158 
mpi
 *
X
 )

160 
»t
, 
Ën
;

162 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_INTEGER
 ) ) != 0 )

163 Ğ
»t
 );

165 
»t
 = 
	`mpi_»ad_bš¬y
Ğ
X
, *
p
, 
Ën
 );

167 *
p
 +ğ
Ën
;

169 Ğ
»t
 );

170 
	}
}

175 
	$x509_g‘_v”siÚ
Ğ**
p
,

176 cÚ¡ *
’d
,

177 *
v”
 )

179 
»t
, 
Ën
;

181 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

182 
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_CONSTRUCTED
 | 0 ) ) != 0 )

184 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

185 Ğ*
v”
 = 0 );

187 Ğ
»t
 );

190 
’d
 = *
p
 + 
Ën
;

192 ifĞĞ
»t
 = 
	`a¢1_g‘_št
Ğ
p
, 
’d
, 
v”
 ) ) != 0 )

193 Ğ
POLARSSL_ERR_X509_CERT_INVALID_VERSION
 | 
»t
 );

195 ifĞ*
p
 !ğ
’d
 )

196 Ğ
POLARSSL_ERR_X509_CERT_INVALID_VERSION
 |

197 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

200 
	}
}

205 
	$x509_g‘_£rŸl
Ğ**
p
,

206 cÚ¡ *
’d
,

207 
x509_buf
 *
£rŸl
 )

209 
»t
;

211 ifĞĞ
’d
 - *
p
 ) < 1 )

212 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 |

213 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

215 ifĞ**
p
 !ğĞ
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_PRIMITIVE
 | 2 ) &&

216 **
p
 !ğ
ASN1_INTEGER
 )

217 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 |

218 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

220 
£rŸl
->
g
 = *(*
p
)++;

222 ifĞĞ
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
£rŸl
->
Ën
 ) ) != 0 )

223 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 | 
»t
 );

225 
£rŸl
->
p
 = *p;

226 *
p
 +ğ
£rŸl
->
Ën
;

229 
	}
}

236 
	$x509_g‘_®g
Ğ**
p
,

237 cÚ¡ *
’d
,

238 
x509_buf
 *
®g
 )

240 
»t
, 
Ën
;

242 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

243 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

244 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 | 
»t
 );

246 
’d
 = *
p
 + 
Ën
;

247 
®g
->
g
 = **
p
;

249 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
®g
->
Ën
, 
ASN1_OID
 ) ) != 0 )

250 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 | 
»t
 );

252 
®g
->
p
 = *p;

253 *
p
 +ğ
®g
->
Ën
;

255 ifĞ*
p
 =ğ
’d
 )

261 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_NULL
 ) ) != 0 )

262 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 | 
»t
 );

264 ifĞ*
p
 !ğ
’d
 )

265 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 |

266 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

269 
	}
}

280 
	$x509_g‘_©Œ_ty³_v®ue
Ğ**
p
,

281 cÚ¡ *
’d
,

282 
x509_Çme
 *
cur
 )

284 
»t
, 
Ën
;

285 
x509_buf
 *
oid
;

286 
x509_buf
 *
v®
;

288 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

289 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

290 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

292 
oid
 = &
cur
->oid;

293 
oid
->
g
 = **
p
;

295 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
oid
->
Ën
, 
ASN1_OID
 ) ) != 0 )

296 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

298 
oid
->
p
 = *p;

299 *
p
 +ğ
oid
->
Ën
;

301 ifĞĞ
’d
 - *
p
 ) < 1 )

302 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 |

303 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

305 ifĞ**
p
 !ğ
ASN1_BMP_STRING
 && **°!ğ
ASN1_UTF8_STRING
 &&

306 **
p
 !ğ
ASN1_T61_STRING
 && **°!ğ
ASN1_PRINTABLE_STRING
 &&

307 **
p
 !ğ
ASN1_IA5_STRING
 && **°!ğ
ASN1_UNIVERSAL_STRING
 )

308 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 |

309 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

311 
v®
 = &
cur
->val;

312 
v®
->
g
 = *(*
p
)++;

314 ifĞĞ
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
v®
->
Ën
 ) ) != 0 )

315 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

317 
v®
->
p
 = *p;

318 *
p
 +ğ
v®
->
Ën
;

320 
cur
->
Ãxt
 = 
NULL
;

323 
	}
}

337 
	$x509_g‘_Çme
Ğ**
p
,

338 cÚ¡ *
’d
,

339 
x509_Çme
 *
cur
 )

341 
»t
, 
Ën
;

342 cÚ¡ *
’d2
;

343 
x509_Çme
 *
u£
;

345 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

346 
ASN1_CONSTRUCTED
 | 
ASN1_SET
 ) ) != 0 )

347 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

349 
’d2
 = 
’d
;

350 
’d
 = *
p
 + 
Ën
;

351 
u£
 = 
cur
;

355 ifĞĞ
»t
 = 
	`x509_g‘_©Œ_ty³_v®ue
Ğ
p
, 
’d
, 
u£
 ) ) != 0 )

356 Ğ
»t
 );

358 ifĞ*
p
 !ğ
’d
 )

360 
u£
->
Ãxt
 = (
x509_Çme
 *è
	`m®loc
(

361 Ğ
x509_Çme
 ) );

363 ifĞ
u£
->
Ãxt
 =ğ
NULL
 )

366 
	`mem£t
Ğ
u£
->
Ãxt
, 0, Ğ
x509_Çme
 ) );

368 
u£
 = u£->
Ãxt
;

371  *
p
 !ğ
’d
 );

376 ifĞ*
p
 =ğ
’d2
 )

379 
cur
->
Ãxt
 = (
x509_Çme
 *è
	`m®loc
(

380 Ğ
x509_Çme
 ) );

382 ifĞ
cur
->
Ãxt
 =ğ
NULL
 )

385 Ğ
	`x509_g‘_Çme
Ğ
p
, 
’d2
, 
cur
->
Ãxt
 ) );

386 
	}
}

393 
	$x509_g‘_time
Ğ**
p
,

394 cÚ¡ *
’d
,

395 
x509_time
 *
time
 )

397 
»t
, 
Ën
;

398 
d©e
[64];

399 
g
;

401 ifĞĞ
’d
 - *
p
 ) < 1 )

402 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

404 
g
 = **
p
;

406 iàĞ
g
 =ğ
ASN1_UTC_TIME
 )

408 (*
p
)++;

409 
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
Ën
 );

411 ifĞ
»t
 != 0 )

412 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
»t
 );

414 
	`mem£t
Ğ
d©e
, 0, ( date ) );

415 
	`memıy
Ğ
d©e
, *
p
, ( 
Ën
 < () ( date ) - 1 ) ?

416 
Ën
 : (èĞ
d©e
 ) - 1 );

418 ifĞ
	`ssÿnf
Ğ
d©e
, "%2d%2d%2d%2d%2d%2d",

419 &
time
->
y—r
, &time->
mÚ
, &time->
day
,

420 &
time
->
hour
, &time->
mš
, &time->
£c
 ) < 5 )

421 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 );

423 
time
->
y—r
 += 100 * (ime->year < 50 );

424 
time
->
y—r
 += 1900;

426 *
p
 +ğ
Ën
;

430 iàĞ
g
 =ğ
ASN1_GENERALIZED_TIME
 )

432 (*
p
)++;

433 
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
Ën
 );

435 ifĞ
»t
 != 0 )

436 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
»t
 );

438 
	`mem£t
Ğ
d©e
, 0, ( date ) );

439 
	`memıy
Ğ
d©e
, *
p
, ( 
Ën
 < () ( date ) - 1 ) ?

440 
Ën
 : (èĞ
d©e
 ) - 1 );

442 ifĞ
	`ssÿnf
Ğ
d©e
, "%4d%2d%2d%2d%2d%2d",

443 &
time
->
y—r
, &time->
mÚ
, &time->
day
,

444 &
time
->
hour
, &time->
mš
, &time->
£c
 ) < 5 )

445 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 );

447 *
p
 +ğ
Ën
;

452 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

453 
	}
}

461 
	$x509_g‘_d©es
Ğ**
p
,

462 cÚ¡ *
’d
,

463 
x509_time
 *
äom
,

464 
x509_time
 *
to
 )

466 
»t
, 
Ën
;

468 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

469 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

470 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
»t
 );

472 
’d
 = *
p
 + 
Ën
;

474 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ
p
, 
’d
, 
äom
 ) ) != 0 )

475 Ğ
»t
 );

477 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ
p
, 
’d
, 
to
 ) ) != 0 )

478 Ğ
»t
 );

480 ifĞ*
p
 !ğ
’d
 )

481 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 |

482 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

485 
	}
}

492 
	$x509_g‘_pubkey
Ğ**
p
,

493 cÚ¡ *
’d
,

494 
x509_buf
 *
pk_®g_oid
,

495 
mpi
 *
N
, mp˜*
E
 )

497 
»t
, 
Ën
, 
ÿn_hªdË
;

498 *
’d2
;

500 ifĞĞ
»t
 = 
	`x509_g‘_®g
Ğ
p
, 
’d
, 
pk_®g_oid
 ) ) != 0 )

501 Ğ
»t
 );

506 
ÿn_hªdË
 = 0;

508 ifĞ
pk_®g_oid
->
Ën
 == 9 &&

509 
	`memcmp
Ğ
pk_®g_oid
->
p
, 
OID_PKCS1_RSA
, 9 ) == 0 )

510 
ÿn_hªdË
 = 1;

512 ifĞ
pk_®g_oid
->
Ën
 == 9 &&

513 
	`memcmp
Ğ
pk_®g_oid
->
p
, 
OID_PKCS1
, 8 ) == 0 )

515 ifĞ
pk_®g_oid
->
p
[8] >= 2 &&…k_alg_oid->p[8] <= 5 )

516 
ÿn_hªdË
 = 1;

518 iàĞ
pk_®g_oid
->
p
[8] >= 11 &&…k_alg_oid->p[8] <= 14 )

519 
ÿn_hªdË
 = 1;

522 ifĞ
pk_®g_oid
->
Ën
 == 5 &&

523 
	`memcmp
Ğ
pk_®g_oid
->
p
, 
OID_RSA_SHA_OBS
, 5 ) == 0 )

524 
ÿn_hªdË
 = 1;

526 ifĞ
ÿn_hªdË
 == 0 )

527 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_PK_ALG
 );

529 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_BIT_STRING
 ) ) != 0 )

530 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 | 
»t
 );

532 ifĞĞ
’d
 - *
p
 ) < 1 )

533 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 |

534 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

536 
’d2
 = *
p
 + 
Ën
;

538 ifĞ*(*
p
)++ != 0 )

539 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 );

547 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d2
, &
Ën
,

548 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

549 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 | 
»t
 );

551 ifĞ*
p
 + 
Ën
 !ğ
’d2
 )

552 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 |

553 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

555 ifĞĞ
»t
 = 
	`a¢1_g‘_mpi
Ğ
p
, 
’d2
, 
N
 ) ) != 0 ||

556 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ
p
, 
’d2
, 
E
 ) ) != 0 )

557 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 | 
»t
 );

559 ifĞ*
p
 !ğ
’d
 )

560 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 |

561 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

564 
	}
}

566 
	$x509_g‘_sig
Ğ**
p
,

567 cÚ¡ *
’d
,

568 
x509_buf
 *
sig
 )

570 
»t
, 
Ën
;

572 
sig
->
g
 = **
p
;

574 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_BIT_STRING
 ) ) != 0 )

575 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SIGNATURE
 | 
»t
 );

577 ifĞ--
Ën
 < 1 || *(*
p
)++ != 0 )

578 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SIGNATURE
 );

580 
sig
->
Ën
 =†en;

581 
sig
->
p
 = *p;

583 *
p
 +ğ
Ën
;

586 
	}
}

591 
	$x509_g‘_uid
Ğ**
p
,

592 cÚ¡ *
’d
,

593 
x509_buf
 *
uid
, 
n
 )

595 
»t
;

597 ifĞ*
p
 =ğ
’d
 )

600 
uid
->
g
 = **
p
;

602 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
uid
->
Ën
,

603 
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_CONSTRUCTED
 | 
n
 ) ) != 0 )

605 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

608 Ğ
»t
 );

611 
uid
->
p
 = *p;

612 *
p
 +ğ
uid
->
Ën
;

615 
	}
}

621 
	$x509_g‘_ext
Ğ**
p
,

622 cÚ¡ *
’d
,

623 
x509_buf
 *
ext
 )

625 
»t
, 
Ën
;

627 ifĞ*
p
 =ğ
’d
 )

630 
ext
->
g
 = **
p
;

632 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
ext
->
Ën
,

633 
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_CONSTRUCTED
 | 3 ) ) != 0 )

634 Ğ
»t
 );

636 
ext
->
p
 = *p;

637 
’d
 = *
p
 + 
ext
->
Ën
;

647 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

648 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

649 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

651 ifĞ
’d
 !ğ*
p
 + 
Ën
 )

652 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

653 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

656 
	}
}

661 
	$x509_g‘_ül_ext
Ğ**
p
,

662 cÚ¡ *
’d
,

663 
x509_buf
 *
ext
 )

665 
»t
, 
Ën
;

667 ifĞĞ
»t
 = 
	`x509_g‘_ext
Ğ
p
, 
’d
, 
ext
 ) ) != 0 )

669 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

672 Ğ
»t
 );

675  *
p
 < 
’d
 )

677 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

678 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

679 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

681 *
p
 +ğ
Ën
;

684 ifĞ*
p
 !ğ
’d
 )

685 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

686 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

689 
	}
}

694 
	$x509_g‘_üt_ext
Ğ**
p
,

695 cÚ¡ *
’d
,

696 
x509_buf
 *
ext
,

697 *
ÿ_i¡rue
,

698 *
max_·thËn
 )

700 
»t
, 
Ën
;

701 
is_ü™iÿl
 = 1;

702 
is_ÿû¹
 = 0;

703 *
’d_ext_d©a
, *
’d_ext_où‘
;

705 ifĞĞ
»t
 = 
	`x509_g‘_ext
Ğ
p
, 
’d
, 
ext
 ) ) != 0 )

707 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

710 Ğ
»t
 );

713  *
p
 < 
’d
 )

715 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

716 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

717 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

719 
’d_ext_d©a
 = *
p
 + 
Ën
;

721 ifĞ
	`memcmp
Ğ*
p
, "\x06\x03\x55\x1D\x13", 5 ) != 0 )

723 *
p
 +ğ
Ën
;

727 *
p
 += 5;

729 ifĞĞ
»t
 = 
	`a¢1_g‘_boŞ
Ğ
p
, 
’d_ext_d©a
, &
is_ü™iÿl
 ) ) != 0 &&

730 Ğ
»t
 !ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 ) )

731 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

733 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d_ext_d©a
, &
Ën
,

734 
ASN1_OCTET_STRING
 ) ) != 0 )

735 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

742 
’d_ext_où‘
 = *
p
 + 
Ën
;

744 ifĞ
’d_ext_où‘
 !ğ
’d_ext_d©a
 )

745 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

746 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

748 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d_ext_où‘
, &
Ën
,

749 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

750 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

752 ifĞ*
p
 =ğ
’d_ext_où‘
 )

755 ifĞĞ
»t
 = 
	`a¢1_g‘_boŞ
Ğ
p
, 
’d_ext_où‘
, &
is_ÿû¹
 ) ) != 0 )

757 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

758 
»t
 = 
	`a¢1_g‘_št
Ğ
p
, 
’d_ext_où‘
, &
is_ÿû¹
 );

760 ifĞ
»t
 != 0 )

761 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

763 ifĞ
is_ÿû¹
 != 0 )

764 
is_ÿû¹
 = 1;

767 ifĞ*
p
 =ğ
’d_ext_où‘
 )

770 ifĞĞ
»t
 = 
	`a¢1_g‘_št
Ğ
p
, 
’d_ext_où‘
, 
max_·thËn
 ) ) != 0 )

771 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

773 ifĞ*
p
 !ğ
’d_ext_où‘
 )

774 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

775 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

777 
max_·thËn
++;

780 ifĞ*
p
 !ğ
’d
 )

781 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

782 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

784 *
ÿ_i¡rue
 = 
is_ü™iÿl
 & 
is_ÿû¹
;

787 
	}
}

792 
	$x509_g‘_’Œ›s
Ğ**
p
,

793 cÚ¡ *
’d
,

794 
x509_ül_’Œy
 *
’Œy
 )

796 
»t
, 
’Œy_Ën
;

797 
x509_ül_’Œy
 *
cur_’Œy
 = 
’Œy
;

799 ifĞ*
p
 =ğ
’d
 )

802 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
’Œy_Ën
,

803 
ASN1_SEQUENCE
 | 
ASN1_CONSTRUCTED
 ) ) != 0 )

805 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

808 Ğ
»t
 );

811 
’d
 = *
p
 + 
’Œy_Ën
;

813  *
p
 < 
’d
 )

815 
Ën2
;

817 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën2
,

818 
ASN1_SEQUENCE
 | 
ASN1_CONSTRUCTED
 ) ) != 0 )

820 Ğ
»t
 );

823 
cur_’Œy
->
¿w
.
g
 = **
p
;

824 
cur_’Œy
->
¿w
.
p
 = *p;

825 
cur_’Œy
->
¿w
.
Ën
 = 
Ën2
;

827 ifĞĞ
»t
 = 
	`x509_g‘_£rŸl
Ğ
p
, 
’d
, &
cur_’Œy
->
£rŸl
 ) ) != 0 )

828 Ğ
»t
 );

830 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ
p
, 
’d
, &
cur_’Œy
->
»voÿtiÚ_d©e
 ) ) != 0 )

831 Ğ
»t
 );

833 ifĞĞ
»t
 = 
	`x509_g‘_ül_ext
Ğ
p
, 
’d
, &
cur_’Œy
->
’Œy_ext
 ) ) != 0 )

834 Ğ
»t
 );

836 iàĞ*
p
 < 
’d
 ) {

837 
cur_’Œy
->
Ãxt
 = 
	`m®loc
ĞĞ
x509_ül_’Œy
 ) );

838 
cur_’Œy
 = cur_’Œy->
Ãxt
;

839 
	`mem£t
Ğ
cur_’Œy
, 0, Ğ
x509_ül_’Œy
 ) );

844 
	}
}

846 
	$x509_g‘_sig_®g
ĞcÚ¡ 
x509_buf
 *
sig_oid
, *
sig_®g
 )

848 ifĞ
sig_oid
->
Ën
 == 9 &&

849 
	`memcmp
Ğ
sig_oid
->
p
, 
OID_PKCS1
, 8 ) == 0 )

851 ifĞ
sig_oid
->
p
[8] >= 2 && sig_oid->p[8] <= 5 )

853 *
sig_®g
 = 
sig_oid
->
p
[8];

857 iàĞ
sig_oid
->
p
[8] >= 11 && sig_oid->p[8] <= 14 )

859 *
sig_®g
 = 
sig_oid
->
p
[8];

863 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 );

865 ifĞ
sig_oid
->
Ën
 == 5 &&

866 
	`memcmp
Ğ
sig_oid
->
p
, 
OID_RSA_SHA_OBS
, 5 ) == 0 )

868 *
sig_®g
 = 
SIG_RSA_SHA1
;

872 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 );

873 
	}
}

878 
	$x509·r£_üt
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 )

880 
»t
, 
Ën
;

881 cÚ¡ *
s1
, *
s2
;

882 *
p
, *
’d
;

883 
x509_û¹
 *
üt
;

885 
üt
 = 
chaš
;

890 ifĞ
üt
 =ğ
NULL
 || 
buf
 == NULL )

893  
üt
->
v”siÚ
 !ğ0 && c¹->
Ãxt
 !ğ
NULL
 )

894 
üt
 = c¹->
Ãxt
;

899 iàĞ
üt
->
v”siÚ
 !ğ0 && c¹->
Ãxt
 =ğ
NULL
)

901 
üt
->
Ãxt
 = (
x509_û¹
 *è
	`m®loc
( ( x509_cert ) );

903 ifĞ
üt
->
Ãxt
 =ğ
NULL
 )

905 
	`x509_ä“
Ğ
üt
 );

909 
üt
 = c¹->
Ãxt
;

910 
	`mem£t
Ğ
üt
, 0, Ğ
x509_û¹
 ) );

916 
s1
 = (*è
	`¡r¡r
Ğ(*è
buf
,

919 ifĞ
s1
 !ğ
NULL
 )

921 
s2
 = (*è
	`¡r¡r
Ğ(*è
buf
,

924 ifĞ
s2
 =ğ
NULL
 || s2 <ğ
s1
 )

925 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

927 
s1
 += 27;

928 ifĞ*
s1
 == '\r' ) s1++;

929 ifĞ*
s1
 == '\n' ) s1++;

930 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

935 
Ën
 = 0;

936 
»t
 = 
	`ba£64_decode
Ğ
NULL
, &
Ën
, 
s1
, 
s2
 - s1 );

938 ifĞ
»t
 =ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 )

939 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

941 ifĞĞ
p
 = (*è
	`m®loc
Ğ
Ën
 ) ) =ğ
NULL
 )

944 ifĞĞ
»t
 = 
	`ba£64_decode
Ğ
p
, &
Ën
, 
s1
, 
s2
 - s1 ) ) != 0 )

946 
	`ä“
Ğ
p
 );

947 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

953 
s2
 += 25;

954 ifĞ*
s2
 == '\r' ) s2++;

955 ifĞ*
s2
 == '\n' ) s2++;

958 
	`ä“
Ğ
p
 );

959 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

962 
buæ’
 -ğ
s2
 - 
buf
;

963 
buf
 = 
s2
;

970 
p
 = (*è
	`m®loc
Ğ
Ën
 = 
buæ’
 );

972 ifĞ
p
 =ğ
NULL
 )

975 
	`memıy
Ğ
p
, 
buf
, 
buæ’
 );

977 
buæ’
 = 0;

980 
üt
->
¿w
.
p
 =…;

981 
üt
->
¿w
.
Ën
 =†en;

982 
’d
 = 
p
 + 
Ën
;

990 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

991 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

993 
	`x509_ä“
Ğ
üt
 );

994 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 );

997 ifĞ
Ën
 !ğ(èĞ
’d
 - 
p
 ) )

999 
	`x509_ä“
Ğ
üt
 );

1000 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1001 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1007 
üt
->
tbs
.
p
 =…;

1009 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1010 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1012 
	`x509_ä“
Ğ
üt
 );

1013 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1016 
’d
 = 
p
 + 
Ën
;

1017 
üt
->
tbs
.
Ën
 = 
’d
 - c¹->tbs.
p
;

1026 ifĞĞ
»t
 = 
	`x509_g‘_v”siÚ
Ğ&
p
, 
’d
, &
üt
->
v”siÚ
 ) ) != 0 ||

1027 Ğ
»t
 = 
	`x509_g‘_£rŸl
Ğ&
p
, 
’d
, &
üt
->
£rŸl
 ) ) != 0 ||

1028 Ğ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
üt
->
sig_oid1
 ) ) != 0 )

1030 
	`x509_ä“
Ğ
üt
 );

1031 Ğ
»t
 );

1034 
üt
->
v”siÚ
++;

1036 ifĞ
üt
->
v”siÚ
 > 3 )

1038 
	`x509_ä“
Ğ
üt
 );

1039 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_VERSION
 );

1042 ifĞĞ
»t
 = 
	`x509_g‘_sig_®g
Ğ&
üt
->
sig_oid1
, &üt->
sig_®g
 ) ) != 0 )

1044 
	`x509_ä“
Ğ
üt
 );

1045 Ğ
»t
 );

1051 
üt
->
issu”_¿w
.
p
 =…;

1053 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1054 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1056 
	`x509_ä“
Ğ
üt
 );

1057 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1060 ifĞĞ
»t
 = 
	`x509_g‘_Çme
Ğ&
p
,… + 
Ën
, &
üt
->
issu”
 ) ) != 0 )

1062 
	`x509_ä“
Ğ
üt
 );

1063 Ğ
»t
 );

1066 
üt
->
issu”_¿w
.
Ën
 = 
p
 - crt->issuer_raw.p;

1074 ifĞĞ
»t
 = 
	`x509_g‘_d©es
Ğ&
p
, 
’d
, &
üt
->
v®id_äom
,

1075 &
üt
->
v®id_to
 ) ) != 0 )

1077 
	`x509_ä“
Ğ
üt
 );

1078 Ğ
»t
 );

1084 
üt
->
subjeù_¿w
.
p
 =…;

1086 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1087 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1089 
	`x509_ä“
Ğ
üt
 );

1090 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1093 ifĞĞ
»t
 = 
	`x509_g‘_Çme
Ğ&
p
,… + 
Ën
, &
üt
->
subjeù
 ) ) != 0 )

1095 
	`x509_ä“
Ğ
üt
 );

1096 Ğ
»t
 );

1099 
üt
->
subjeù_¿w
.
Ën
 = 
p
 - crt->subject_raw.p;

1106 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1107 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1109 
	`x509_ä“
Ğ
üt
 );

1110 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1113 ifĞĞ
»t
 = 
	`x509_g‘_pubkey
Ğ&
p
,… + 
Ën
, &
üt
->
pk_oid
,

1114 &
üt
->
r§
.
N
, &üt->r§.
E
 ) ) != 0 )

1116 
	`x509_ä“
Ğ
üt
 );

1117 Ğ
»t
 );

1120 ifĞĞ
»t
 = 
	`r§_check_pubkey
Ğ&
üt
->
r§
 ) ) != 0 )

1122 
	`x509_ä“
Ğ
üt
 );

1123 Ğ
»t
 );

1126 
üt
->
r§
.
Ën
 = 
	`mpi_size
Ğ&üt->r§.
N
 );

1136 ifĞ
üt
->
v”siÚ
 == 2 || crt->version == 3 )

1138 
»t
 = 
	`x509_g‘_uid
Ğ&
p
, 
’d
, &
üt
->
issu”_id
, 1 );

1139 ifĞ
»t
 != 0 )

1141 
	`x509_ä“
Ğ
üt
 );

1142 Ğ
»t
 );

1146 ifĞ
üt
->
v”siÚ
 == 2 || crt->version == 3 )

1148 
»t
 = 
	`x509_g‘_uid
Ğ&
p
, 
’d
, &
üt
->
subjeù_id
, 2 );

1149 ifĞ
»t
 != 0 )

1151 
	`x509_ä“
Ğ
üt
 );

1152 Ğ
»t
 );

1156 ifĞ
üt
->
v”siÚ
 == 3 )

1158 
»t
 = 
	`x509_g‘_üt_ext
Ğ&
p
, 
’d
, &
üt
->
v3_ext
,

1159 &
üt
->
ÿ_i¡rue
, &üt->
max_·thËn
 );

1160 ifĞ
»t
 != 0 )

1162 
	`x509_ä“
Ğ
üt
 );

1163 Ğ
»t
 );

1167 ifĞ
p
 !ğ
’d
 )

1169 
	`x509_ä“
Ğ
üt
 );

1170 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1171 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1174 
’d
 = 
üt
->
¿w
.
p
 + c¹->¿w.
Ën
;

1180 ifĞĞ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
üt
->
sig_oid2
 ) ) != 0 )

1182 
	`x509_ä“
Ğ
üt
 );

1183 Ğ
»t
 );

1186 ifĞ
	`memcmp
Ğ
üt
->
sig_oid1
.
p
, c¹->
sig_oid2
.p, c¹->sig_oid1.
Ën
 ) != 0 )

1188 
	`x509_ä“
Ğ
üt
 );

1189 Ğ
POLARSSL_ERR_X509_CERT_SIG_MISMATCH
 );

1192 ifĞĞ
»t
 = 
	`x509_g‘_sig
Ğ&
p
, 
’d
, &
üt
->
sig
 ) ) != 0 )

1194 
	`x509_ä“
Ğ
üt
 );

1195 Ğ
»t
 );

1198 ifĞ
p
 !ğ
’d
 )

1200 
	`x509_ä“
Ğ
üt
 );

1201 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1202 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1205 ifĞ
buæ’
 > 0 )

1207 
üt
->
Ãxt
 = (
x509_û¹
 *è
	`m®loc
( ( x509_cert ) );

1209 ifĞ
üt
->
Ãxt
 =ğ
NULL
 )

1211 
	`x509_ä“
Ğ
üt
 );

1215 
üt
 = c¹->
Ãxt
;

1216 
	`mem£t
Ğ
üt
, 0, Ğ
x509_û¹
 ) );

1218 Ğ
	`x509·r£_üt
Ğ
üt
, 
buf
, 
buæ’
 ) );

1222 
	}
}

1227 
	$x509·r£_ül
Ğ
x509_ül
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 )

1229 
»t
, 
Ën
;

1230 *
s1
, *
s2
;

1231 *
p
, *
’d
;

1232 
x509_ül
 *
ül
;

1234 
ül
 = 
chaš
;

1239 ifĞ
ül
 =ğ
NULL
 || 
buf
 == NULL )

1242  
ül
->
v”siÚ
 !ğ0 && c¾->
Ãxt
 !ğ
NULL
 )

1243 
ül
 = c¾->
Ãxt
;

1248 iàĞ
ül
->
v”siÚ
 !ğ0 && c¾->
Ãxt
 =ğ
NULL
)

1250 
ül
->
Ãxt
 = (
x509_ül
 *è
	`m®loc
( ( x509_crl ) );

1252 ifĞ
ül
->
Ãxt
 =ğ
NULL
 )

1254 
	`x509_ül_ä“
Ğ
ül
 );

1258 
ül
 = c¾->
Ãxt
;

1259 
	`mem£t
Ğ
ül
, 0, Ğ
x509_ül
 ) );

1265 
s1
 = (*è
	`¡r¡r
Ğ(*è
buf
,

1268 ifĞ
s1
 !ğ
NULL
 )

1270 
s2
 = (*è
	`¡r¡r
Ğ(*è
buf
,

1273 ifĞ
s2
 =ğ
NULL
 || s2 <ğ
s1
 )

1274 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

1276 
s1
 += 24;

1277 ifĞ*
s1
 == '\r' ) s1++;

1278 ifĞ*
s1
 == '\n' ) s1++;

1279 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

1284 
Ën
 = 0;

1285 
»t
 = 
	`ba£64_decode
Ğ
NULL
, &
Ën
, 
s1
, 
s2
 - s1 );

1287 ifĞ
»t
 =ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 )

1288 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

1290 ifĞĞ
p
 = (*è
	`m®loc
Ğ
Ën
 ) ) =ğ
NULL
 )

1293 ifĞĞ
»t
 = 
	`ba£64_decode
Ğ
p
, &
Ën
, 
s1
, 
s2
 - s1 ) ) != 0 )

1295 
	`ä“
Ğ
p
 );

1296 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

1302 
s2
 += 22;

1303 ifĞ*
s2
 == '\r' ) s2++;

1304 ifĞ*
s2
 == '\n' ) s2++;

1307 
	`ä“
Ğ
p
 );

1308 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

1311 
buæ’
 -ğ
s2
 - 
buf
;

1312 
buf
 = 
s2
;

1319 
p
 = (*è
	`m®loc
Ğ
Ën
 = 
buæ’
 );

1321 ifĞ
p
 =ğ
NULL
 )

1324 
	`memıy
Ğ
p
, 
buf
, 
buæ’
 );

1326 
buæ’
 = 0;

1329 
ül
->
¿w
.
p
 =…;

1330 
ül
->
¿w
.
Ën
 =†en;

1331 
’d
 = 
p
 + 
Ën
;

1339 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1340 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1342 
	`x509_ül_ä“
Ğ
ül
 );

1343 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 );

1346 ifĞ
Ën
 !ğ(èĞ
’d
 - 
p
 ) )

1348 
	`x509_ül_ä“
Ğ
ül
 );

1349 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1350 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1356 
ül
->
tbs
.
p
 =…;

1358 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1359 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1361 
	`x509_ül_ä“
Ğ
ül
 );

1362 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1365 
’d
 = 
p
 + 
Ën
;

1366 
ül
->
tbs
.
Ën
 = 
’d
 - c¾->tbs.
p
;

1374 ifĞĞ
»t
 = 
	`x509_g‘_v”siÚ
Ğ&
p
, 
’d
, &
ül
->
v”siÚ
 ) ) != 0 ||

1375 Ğ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
ül
->
sig_oid1
 ) ) != 0 )

1377 
	`x509_ül_ä“
Ğ
ül
 );

1378 Ğ
»t
 );

1381 
ül
->
v”siÚ
++;

1383 ifĞ
ül
->
v”siÚ
 > 2 )

1385 
	`x509_ül_ä“
Ğ
ül
 );

1386 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_VERSION
 );

1389 ifĞĞ
»t
 = 
	`x509_g‘_sig_®g
Ğ&
ül
->
sig_oid1
, &ül->
sig_®g
 ) ) != 0 )

1391 
	`x509_ül_ä“
Ğ
ül
 );

1392 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 );

1398 
ül
->
issu”_¿w
.
p
 =…;

1400 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1401 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1403 
	`x509_ül_ä“
Ğ
ül
 );

1404 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1407 ifĞĞ
»t
 = 
	`x509_g‘_Çme
Ğ&
p
,… + 
Ën
, &
ül
->
issu”
 ) ) != 0 )

1409 
	`x509_ül_ä“
Ğ
ül
 );

1410 Ğ
»t
 );

1413 
ül
->
issu”_¿w
.
Ën
 = 
p
 - crl->issuer_raw.p;

1419 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ&
p
, 
’d
, &
ül
->
this_upd©e
 ) ) != 0 )

1421 
	`x509_ül_ä“
Ğ
ül
 );

1422 Ğ
»t
 );

1425 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ&
p
, 
’d
, &
ül
->
Ãxt_upd©e
 ) ) != 0 )

1427 iàĞ
»t
 !ğĞ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 |

1428 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 ) &&

1429 
»t
 !ğĞ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 |

1430 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 ) )

1432 
	`x509_ül_ä“
Ğ
ül
 );

1433 Ğ
»t
 );

1445 ifĞĞ
»t
 = 
	`x509_g‘_’Œ›s
Ğ&
p
, 
’d
, &
ül
->
’Œy
 ) ) != 0 )

1447 
	`x509_ül_ä“
Ğ
ül
 );

1448 Ğ
»t
 );

1455 ifĞ
ül
->
v”siÚ
 == 2 )

1457 
»t
 = 
	`x509_g‘_ül_ext
Ğ&
p
, 
’d
, &
ül
->
ül_ext
 );

1459 ifĞ
»t
 != 0 )

1461 
	`x509_ül_ä“
Ğ
ül
 );

1462 Ğ
»t
 );

1466 ifĞ
p
 !ğ
’d
 )

1468 
	`x509_ül_ä“
Ğ
ül
 );

1469 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1470 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1473 
’d
 = 
ül
->
¿w
.
p
 + c¾->¿w.
Ën
;

1479 ifĞĞ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
ül
->
sig_oid2
 ) ) != 0 )

1481 
	`x509_ül_ä“
Ğ
ül
 );

1482 Ğ
»t
 );

1485 ifĞ
	`memcmp
Ğ
ül
->
sig_oid1
.
p
, c¾->
sig_oid2
.p, c¾->sig_oid1.
Ën
 ) != 0 )

1487 
	`x509_ül_ä“
Ğ
ül
 );

1488 Ğ
POLARSSL_ERR_X509_CERT_SIG_MISMATCH
 );

1491 ifĞĞ
»t
 = 
	`x509_g‘_sig
Ğ&
p
, 
’d
, &
ül
->
sig
 ) ) != 0 )

1493 
	`x509_ül_ä“
Ğ
ül
 );

1494 Ğ
»t
 );

1497 ifĞ
p
 !ğ
’d
 )

1499 
	`x509_ül_ä“
Ğ
ül
 );

1500 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1501 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1504 ifĞ
buæ’
 > 0 )

1506 
ül
->
Ãxt
 = (
x509_ül
 *è
	`m®loc
( ( x509_crl ) );

1508 ifĞ
ül
->
Ãxt
 =ğ
NULL
 )

1510 
	`x509_ül_ä“
Ğ
ül
 );

1514 
ül
 = c¾->
Ãxt
;

1515 
	`mem£t
Ğ
ül
, 0, Ğ
x509_ül
 ) );

1517 Ğ
	`x509·r£_ül
Ğ
ül
, 
buf
, 
buæ’
 ) );

1521 
	}
}

1526 
	$lßd_fe
ĞcÚ¡ *
·th
, **
buf
, 
size_t
 *
n
 )

1528 
FILE
 *
f
;

1530 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

1533 
	`f£ek
Ğ
f
, 0, 
SEEK_END
 );

1534 *
n
 = (
size_t
è
	`á–l
Ğ
f
 );

1535 
	`f£ek
Ğ
f
, 0, 
SEEK_SET
 );

1537 ifĞĞ*
buf
 = (*è
	`m®loc
Ğ*
n
 + 1 ) ) =ğ
NULL
 )

1540 ifĞ
	`ä—d
Ğ*
buf
, 1, *
n
, 
f
 ) != *n )

1542 
	`fşo£
Ğ
f
 );

1543 
	`ä“
Ğ*
buf
 );

1547 
	`fşo£
Ğ
f
 );

1549 (*
buf
)[*
n
] = '\0';

1552 
	}
}

1557 
	$x509·r£_ütfe
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
·th
 )

1559 
»t
;

1560 
size_t
 
n
;

1561 *
buf
;

1563 iàĞ
	`lßd_fe
Ğ
·th
, &
buf
, &
n
 ) )

1566 
»t
 = 
	`x509·r£_üt
Ğ
chaš
, 
buf
, (è
n
 );

1568 
	`mem£t
Ğ
buf
, 0, 
n
 + 1 );

1569 
	`ä“
Ğ
buf
 );

1571 Ğ
»t
 );

1572 
	}
}

1577 
	$x509·r£_ülfe
Ğ
x509_ül
 *
chaš
, cÚ¡ *
·th
 )

1579 
»t
;

1580 
size_t
 
n
;

1581 *
buf
;

1583 iàĞ
	`lßd_fe
Ğ
·th
, &
buf
, &
n
 ) )

1586 
»t
 = 
	`x509·r£_ül
Ğ
chaš
, 
buf
, (è
n
 );

1588 
	`mem£t
Ğ
buf
, 0, 
n
 + 1 );

1589 
	`ä“
Ğ
buf
 );

1591 Ğ
»t
 );

1592 
	}
}

1594 #ià
defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1598 
	$x509_g‘_iv
ĞcÚ¡ *
s
, 
iv
[8] )

1600 
i
, 
j
, 
k
;

1602 
	`mem£t
Ğ
iv
, 0, 8 );

1604  
i
 = 0; i < 16; i++, 
s
++ )

1606 ifĞ*
s
 >ğ'0' && * <ğ'9' ) 
j
 = *s - '0'; 

1607 ifĞ*
s
 >ğ'A' && * <ğ'F' ) 
j
 = *s - '7'; 

1608 ifĞ*
s
 >ğ'a' && * <ğ'f' ) 
j
 = *s - 'W'; 

1609 Ğ
POLARSSL_ERR_X509_KEY_INVALID_ENC_IV
 );

1611 
k
 = ( ( 
i
 & 1 ) !ğ0 ) ? 
j
 : j << 4;

1613 
iv
[
i
 >> 1] = ()Ğiv[˜>> 1] | 
k
 );

1617 
	}
}

1622 
	$x509_des3_deüy±
Ğ
des3_iv
[8],

1623 *
buf
, 
buæ’
,

1624 cÚ¡ *
pwd
, 
pwdËn
 )

1626 
md5_cÚ‹xt
 
md5_ùx
;

1627 
des3_cÚ‹xt
 
des3_ùx
;

1628 
md5sum
[16];

1629 
des3_key
[24];

1635 
	`md5_¡¬ts
Ğ&
md5_ùx
 );

1636 
	`md5_upd©e
Ğ&
md5_ùx
, 
pwd
, 
pwdËn
 );

1637 
	`md5_upd©e
Ğ&
md5_ùx
, 
des3_iv
, 8 );

1638 
	`md5_fšish
Ğ&
md5_ùx
, 
md5sum
 );

1639 
	`memıy
Ğ
des3_key
, 
md5sum
, 16 );

1641 
	`md5_¡¬ts
Ğ&
md5_ùx
 );

1642 
	`md5_upd©e
Ğ&
md5_ùx
, 
md5sum
, 16 );

1643 
	`md5_upd©e
Ğ&
md5_ùx
, 
pwd
, 
pwdËn
 );

1644 
	`md5_upd©e
Ğ&
md5_ùx
, 
des3_iv
, 8 );

1645 
	`md5_fšish
Ğ&
md5_ùx
, 
md5sum
 );

1646 
	`memıy
Ğ
des3_key
 + 16, 
md5sum
, 8 );

1648 
	`des3_£t3key_dec
Ğ&
des3_ùx
, 
des3_key
 );

1649 
	`des3_üy±_cbc
Ğ&
des3_ùx
, 
DES_DECRYPT
, 
buæ’
,

1650 
des3_iv
, 
buf
, buf );

1652 
	`mem£t
Ğ&
md5_ùx
, 0, ( md5_ctx ) );

1653 
	`mem£t
Ğ&
des3_ùx
, 0, ( des3_ctx ) );

1654 
	`mem£t
Ğ
md5sum
, 0, 16 );

1655 
	`mem£t
Ğ
des3_key
, 0, 24 );

1656 
	}
}

1662 
	$x509·r£_key
Ğ
r§_cÚ‹xt
 *
r§
, cÚ¡ *
key
, 
keyËn
,

1663 cÚ¡ *
pwd
, 
pwdËn
 )

1665 
»t
, 
Ën
, 
’c
;

1666 *
buf
, *
s1
, *
s2
;

1667 *
p
, *
’d
;

1668 #ià
	`defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1669 
des3_iv
[8];

1671 ((è
pwd
);

1672 ((è
pwdËn
);

1675 
s1
 = (*è
	`¡r¡r
Ğ(*è
key
,

1678 ifĞ
s1
 !ğ
NULL
 )

1680 
s2
 = (*è
	`¡r¡r
Ğ(*è
key
,

1683 ifĞ
s2
 =ğ
NULL
 || s2 <ğ
s1
 )

1684 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1686 
s1
 += 31;

1687 ifĞ*
s1
 == '\r' ) s1++;

1688 ifĞ*
s1
 == '\n' ) s1++;

1689 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1691 
’c
 = 0;

1693 ifĞ
	`memcmp
Ğ
s1
, "Proc-Type: 4,ENCRYPTED", 22 ) == 0 )

1695 #ià
	`defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1696 
’c
++;

1698 
s1
 += 22;

1699 ifĞ*
s1
 == '\r' ) s1++;

1700 ifĞ*
s1
 == '\n' ) s1++;

1701 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1703 ifĞ
	`memcmp
Ğ
s1
, "DEK-Info: DES-EDE3-CBC,", 23 ) != 0 )

1704 Ğ
POLARSSL_ERR_X509_KEY_UNKNOWN_ENC_ALG
 );

1706 
s1
 += 23;

1707 ifĞ
	`x509_g‘_iv
Ğ
s1
, 
des3_iv
 ) != 0 )

1708 Ğ
POLARSSL_ERR_X509_KEY_INVALID_ENC_IV
 );

1710 
s1
 += 16;

1711 ifĞ*
s1
 == '\r' ) s1++;

1712 ifĞ*
s1
 == '\n' ) s1++;

1713 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1715 Ğ
POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 );

1719 
Ën
 = 0;

1720 
»t
 = 
	`ba£64_decode
Ğ
NULL
, &
Ën
, 
s1
, 
s2
 - s1 );

1722 ifĞ
»t
 =ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 )

1723 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1725 ifĞĞ
buf
 = (*è
	`m®loc
Ğ
Ën
 ) ) =ğ
NULL
 )

1728 ifĞĞ
»t
 = 
	`ba£64_decode
Ğ
buf
, &
Ën
, 
s1
, 
s2
 - s1 ) ) != 0 )

1730 
	`ä“
Ğ
buf
 );

1731 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1734 
keyËn
 = 
Ën
;

1736 ifĞ
’c
 != 0 )

1738 #ià
	`defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1739 ifĞ
pwd
 =ğ
NULL
 )

1741 
	`ä“
Ğ
buf
 );

1742 Ğ
POLARSSL_ERR_X509_KEY_PASSWORD_REQUIRED
 );

1745 
	`x509_des3_deüy±
Ğ
des3_iv
, 
buf
, 
keyËn
, 
pwd
, 
pwdËn
 );

1747 ifĞ
buf
[0] != 0x30 || buf[1] != 0x82 ||

1748 
buf
[4] != 0x02 || buf[5] != 0x01 )

1750 
	`ä“
Ğ
buf
 );

1751 Ğ
POLARSSL_ERR_X509_KEY_PASSWORD_MISMATCH
 );

1754 Ğ
POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 );

1760 
buf
 = 
NULL
;

1763 
	`mem£t
Ğ
r§
, 0, Ğ
r§_cÚ‹xt
 ) );

1765 
p
 = ( 
s1
 !ğ
NULL
 ) ? 
buf
 : (*è
key
;

1766 
’d
 = 
p
 + 
keyËn
;

1782 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1783 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1785 ifĞ
s1
 !ğ
NULL
 )

1786 
	`ä“
Ğ
buf
 );

1788 
	`r§_ä“
Ğ
r§
 );

1789 Ğ
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 | 
»t
 );

1792 
’d
 = 
p
 + 
Ën
;

1794 ifĞĞ
»t
 = 
	`a¢1_g‘_št
Ğ&
p
, 
’d
, &
r§
->
v”
 ) ) != 0 )

1796 ifĞ
s1
 !ğ
NULL
 )

1797 
	`ä“
Ğ
buf
 );

1799 
	`r§_ä“
Ğ
r§
 );

1800 Ğ
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 | 
»t
 );

1803 ifĞ
r§
->
v”
 != 0 )

1805 ifĞ
s1
 !ğ
NULL
 )

1806 
	`ä“
Ğ
buf
 );

1808 
	`r§_ä“
Ğ
r§
 );

1809 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_VERSION
 );

1812 ifĞĞ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
N
 ) ) != 0 ||

1813 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
E
 ) ) != 0 ||

1814 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
D
 ) ) != 0 ||

1815 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
P
 ) ) != 0 ||

1816 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
Q
 ) ) != 0 ||

1817 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
DP
 ) ) != 0 ||

1818 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
DQ
 ) ) != 0 ||

1819 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
QP
 ) ) != 0 )

1821 ifĞ
s1
 !ğ
NULL
 )

1822 
	`ä“
Ğ
buf
 );

1824 
	`r§_ä“
Ğ
r§
 );

1825 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 );

1828 
r§
->
Ën
 = 
	`mpi_size
Ğ&r§->
N
 );

1830 ifĞ
p
 !ğ
’d
 )

1832 ifĞ
s1
 !ğ
NULL
 )

1833 
	`ä“
Ğ
buf
 );

1835 
	`r§_ä“
Ğ
r§
 );

1836 Ğ
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 |

1837 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1840 ifĞĞ
»t
 = 
	`r§_check_´ivkey
Ğ
r§
 ) ) != 0 )

1842 ifĞ
s1
 !ğ
NULL
 )

1843 
	`ä“
Ğ
buf
 );

1845 
	`r§_ä“
Ğ
r§
 );

1846 Ğ
»t
 );

1849 ifĞ
s1
 !ğ
NULL
 )

1850 
	`ä“
Ğ
buf
 );

1853 
	}
}

1858 
	$x509·r£_keyfe
Ğ
r§_cÚ‹xt
 *
r§
, cÚ¡ *
·th
, cÚ¡ *
pwd
 )

1860 
»t
;

1861 
size_t
 
n
;

1862 *
buf
;

1864 iàĞ
	`lßd_fe
Ğ
·th
, &
buf
, &
n
 ) )

1867 ifĞ
pwd
 =ğ
NULL
 )

1868 
»t
 = 
	`x509·r£_key
Ğ
r§
, 
buf
, (è
n
, 
NULL
, 0 );

1870 
»t
 = 
	`x509·r£_key
Ğ
r§
, 
buf
, (è
n
,

1871 (*è
pwd
, 
	`¡¾’
(…wd ) );

1873 
	`mem£t
Ğ
buf
, 0, 
n
 + 1 );

1874 
	`ä“
Ğ
buf
 );

1876 Ğ
»t
 );

1877 
	}
}

1879 #ià
defšed
 
_MSC_VER
 && !defšed 
¢´štf


1880 
	~<¡d¬g.h
>

1882 #ià!
defšed
 
v¢´štf


1883 
	#v¢´štf
 
_v¢´štf


	)

1893 
	$com·t_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

1895 
va_li¡
 
­
;

1896 
»s
 = -1;

1898 
	`va_¡¬t
Ğ
­
, 
fÜm©
 );

1900 
»s
 = 
	`v¢´štf
Ğ
¡r
, 
size
, 
fÜm©
, 
­
 );

1902 
	`va_’d
Ğ
­
 );

1905 iàĞ
»s
 < 0 )

1906 Ğ
size
 + 20 );

1908  
»s
;

1909 
	}
}

1911 
	#¢´štf
 
com·t_¢´štf


	)

1914 
	#POLARSSL_ERR_DEBUG_BUF_TOO_SMALL
 -2

	)

1916 
	#SAFE_SNPRINTF
() \

1918 ifĞ
»t
 == -1 ) \

1921 iàĞ
»t
 > 
n
 ) { \

1922 
p
[
n
 - 1] = '\0'; \

1923  
POLARSSL_ERR_DEBUG_BUF_TOO_SMALL
;\

1926 
n
 -ğ
»t
; \

1927 
p
 +ğ
»t
; \

1928 }

	)

1934 
	$x509·r£_dn_g‘s
Ğ*
buf
, 
size_t
 
size
, cÚ¡ 
x509_Çme
 *
dn
 )

1936 
i
, 
»t
, 
n
;

1937 
c
;

1938 cÚ¡ 
x509_Çme
 *
Çme
;

1939 
s
[128], *
p
;

1941 
	`mem£t
Ğ
s
, 0, ( s ) );

1943 
Çme
 = 
dn
;

1944 
p
 = 
buf
;

1945 
n
 = 
size
;

1947  
Çme
 !ğ
NULL
 )

1949 ifĞ
Çme
 !ğ
dn
 ) {

1950 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, ", " );

1951 
	`SAFE_SNPRINTF
();

1954 ifĞ
	`memcmp
Ğ
Çme
->
oid
.
p
, 
OID_X520
, 2 ) == 0 )

1956  
Çme
->
oid
.
p
[2] )

1958 
X520_COMMON_NAME
:

1959 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "CN=" ); ;

1961 
X520_COUNTRY
:

1962 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "C=" ); ;

1964 
X520_LOCALITY
:

1965 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "L=" ); ;

1967 
X520_STATE
:

1968 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "ST=" ); ;

1970 
X520_ORGANIZATION
:

1971 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "O=" ); ;

1973 
X520_ORG_UNIT
:

1974 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "OU=" ); ;

1977 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "0x%02X=",

1978 
Çme
->
oid
.
p
[2] );

1981 
	`SAFE_SNPRINTF
();

1983 ifĞ
	`memcmp
Ğ
Çme
->
oid
.
p
, 
OID_PKCS9
, 8 ) == 0 )

1985  
Çme
->
oid
.
p
[8] )

1987 
PKCS9_EMAIL
:

1988 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "emailAddress=" ); ;

1991 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "0x%02X=",

1992 
Çme
->
oid
.
p
[8] );

1995 
	`SAFE_SNPRINTF
();

1999 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\?\?=" );

2000 
	`SAFE_SNPRINTF
();

2003  
i
 = 0; i < 
Çme
->
v®
.
Ën
; i++ )

2005 ifĞ
i
 >ğ(èĞ
s
 ) - 1 )

2008 
c
 = 
Çme
->
v®
.
p
[
i
];

2009 ifĞ
c
 < 32 || c == 127 || ( c > 128 && c < 160 ) )

2010 
s
[
i
] = '?';

2011 
s
[
i
] = 
c
;

2013 
s
[
i
] = '\0';

2014 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%s", 
s
 );

2015 
	`SAFE_SNPRINTF
();

2016 
Çme
 =‚ame->
Ãxt
;

2019 Ğ
size
 - 
n
 );

2020 
	}
}

2025 
	$x509·r£_û¹_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

2026 cÚ¡ 
x509_û¹
 *
üt
 )

2028 
i
, 
n
, 
Ä
, 
»t
;

2029 *
p
;

2031 
p
 = 
buf
;

2032 
n
 = 
size
;

2034 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%scert. version : %d\n",

2035 
´efix
, 
üt
->
v”siÚ
 );

2036 
	`SAFE_SNPRINTF
();

2037 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%sserial‚umber : ",

2038 
´efix
 );

2039 
	`SAFE_SNPRINTF
();

2041 
Ä
 = ( 
üt
->
£rŸl
.
Ën
 <= 32 )

2042 ? 
üt
->
£rŸl
.
Ën
 : 32;

2044  
i
 = 0; i < 
Ä
; i++ )

2046 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%02X%s",

2047 
üt
->
£rŸl
.
p
[
i
], ( i < 
Ä
 - 1 ) ? ":" : "" );

2048 
	`SAFE_SNPRINTF
();

2051 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sissu”‚am : ", 
´efix
 );

2052 
	`SAFE_SNPRINTF
();

2053 
»t
 = 
	`x509·r£_dn_g‘s
Ğ
p
, 
n
, &
üt
->
issu”
 );

2054 
	`SAFE_SNPRINTF
();

2056 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%ssubjeù‚am : ", 
´efix
 );

2057 
	`SAFE_SNPRINTF
();

2058 
»t
 = 
	`x509·r£_dn_g‘s
Ğ
p
, 
n
, &
üt
->
subjeù
 );

2059 
	`SAFE_SNPRINTF
();

2061 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sissued on : " \

2062 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2063 
üt
->
v®id_äom
.
y—r
, c¹->v®id_äom.
mÚ
,

2064 
üt
->
v®id_äom
.
day
, c¹->v®id_äom.
hour
,

2065 
üt
->
v®id_äom
.
mš
, c¹->v®id_äom.
£c
 );

2066 
	`SAFE_SNPRINTF
();

2068 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sexpires on : " \

2069 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2070 
üt
->
v®id_to
.
y—r
, c¹->v®id_to.
mÚ
,

2071 
üt
->
v®id_to
.
day
, c¹->v®id_to.
hour
,

2072 
üt
->
v®id_to
.
mš
, c¹->v®id_to.
£c
 );

2073 
	`SAFE_SNPRINTF
();

2075 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%ssigÃd usšg : RSA+", 
´efix
 );

2076 
	`SAFE_SNPRINTF
();

2078  
üt
->
sig_®g
 )

2080 
SIG_RSA_MD2
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD2" ); ;

2081 
SIG_RSA_MD4
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD4" ); ;

2082 
SIG_RSA_MD5
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD5" ); ;

2083 
SIG_RSA_SHA1
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA1" ); ;

2084 
SIG_RSA_SHA224
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA224" ); ;

2085 
SIG_RSA_SHA256
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA256" ); ;

2086 
SIG_RSA_SHA384
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA384" ); ;

2087 
SIG_RSA_SHA512
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA512" ); ;

2088 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "???" ); ;

2090 
	`SAFE_SNPRINTF
();

2092 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sRSA key siz : %d b™s\n", 
´efix
,

2093 
üt
->
r§
.
N
.
n
 * () ( ) * 8 );

2094 
	`SAFE_SNPRINTF
();

2096 Ğ
size
 - 
n
 );

2097 
	}
}

2102 
	$x509·r£_ül_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

2103 cÚ¡ 
x509_ül
 *
ül
 )

2105 
i
, 
n
, 
Ä
, 
»t
;

2106 *
p
;

2107 cÚ¡ 
x509_ül_’Œy
 *
’Œy
;

2109 
p
 = 
buf
;

2110 
n
 = 
size
;

2112 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%sCRL version : %d",

2113 
´efix
, 
ül
->
v”siÚ
 );

2114 
	`SAFE_SNPRINTF
();

2116 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sissu”‚am : ", 
´efix
 );

2117 
	`SAFE_SNPRINTF
();

2118 
»t
 = 
	`x509·r£_dn_g‘s
Ğ
p
, 
n
, &
ül
->
issu”
 );

2119 
	`SAFE_SNPRINTF
();

2121 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sthis update : " \

2122 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2123 
ül
->
this_upd©e
.
y—r
, c¾->this_upd©e.
mÚ
,

2124 
ül
->
this_upd©e
.
day
, c¾->this_upd©e.
hour
,

2125 
ül
->
this_upd©e
.
mš
, c¾->this_upd©e.
£c
 );

2126 
	`SAFE_SNPRINTF
();

2128 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%snext update : " \

2129 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2130 
ül
->
Ãxt_upd©e
.
y—r
, c¾->Ãxt_upd©e.
mÚ
,

2131 
ül
->
Ãxt_upd©e
.
day
, c¾->Ãxt_upd©e.
hour
,

2132 
ül
->
Ãxt_upd©e
.
mš
, c¾->Ãxt_upd©e.
£c
 );

2133 
	`SAFE_SNPRINTF
();

2135 
’Œy
 = &
ül
->entry;

2137 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sRevoked certificates:",

2138 
´efix
 );

2139 
	`SAFE_SNPRINTF
();

2141  
’Œy
 !ğ
NULL
 &&ƒÁry->
¿w
.
Ën
 != 0 )

2143 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sserial‚umber: ",

2144 
´efix
 );

2145 
	`SAFE_SNPRINTF
();

2147 
Ä
 = ( 
’Œy
->
£rŸl
.
Ën
 <= 32 )

2148 ? 
’Œy
->
£rŸl
.
Ën
 : 32;

2150  
i
 = 0; i < 
Ä
; i++ ) {

2151 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%02X%s",

2152 
’Œy
->
£rŸl
.
p
[
i
], ( i < 
Ä
 - 1 ) ? ":" : "" );

2153 
	`SAFE_SNPRINTF
();

2156 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "„evocation date: " \

2158 
’Œy
->
»voÿtiÚ_d©e
.
y—r
,ƒÁry->»voÿtiÚ_d©e.
mÚ
,

2159 
’Œy
->
»voÿtiÚ_d©e
.
day
,ƒÁry->»voÿtiÚ_d©e.
hour
,

2160 
’Œy
->
»voÿtiÚ_d©e
.
mš
,ƒÁry->»voÿtiÚ_d©e.
£c
 );

2161 
	`SAFE_SNPRINTF
();

2163 
’Œy
 =ƒÁry->
Ãxt
;

2166 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%ssigÃd usšg : RSA+", 
´efix
 );

2167 
	`SAFE_SNPRINTF
();

2169  
ül
->
sig_®g
 )

2171 
SIG_RSA_MD2
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD2" ); ;

2172 
SIG_RSA_MD4
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD4" ); ;

2173 
SIG_RSA_MD5
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD5" ); ;

2174 
SIG_RSA_SHA1
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA1" ); ;

2175 
SIG_RSA_SHA224
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA224" ); ;

2176 
SIG_RSA_SHA256
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA256" ); ;

2177 
SIG_RSA_SHA384
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA384" ); ;

2178 
SIG_RSA_SHA512
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA512" ); ;

2179 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "???" ); ;

2181 
	`SAFE_SNPRINTF
();

2183 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n" );

2184 
	`SAFE_SNPRINTF
();

2186 Ğ
size
 - 
n
 );

2187 
	}
}

2192 
	$x509·r£_time_expœed
ĞcÚ¡ 
x509_time
 *
to
 )

2194 
tm
 *
É
;

2195 
time_t
 
‰
;

2197 
‰
 = 
	`time
Ğ
NULL
 );

2198 
É
 = 
	`loÿÉime
Ğ&
‰
 );

2200 ifĞ
É
->
tm_y—r
 > 
to
->
y—r
 - 1900 )

2203 ifĞ
É
->
tm_y—r
 =ğ
to
->
y—r
 - 1900 &&

2204 
É
->
tm_mÚ
 > 
to
->
mÚ
 - 1 )

2207 ifĞ
É
->
tm_y—r
 =ğ
to
->
y—r
 - 1900 &&

2208 
É
->
tm_mÚ
 =ğ
to
->
mÚ
 - 1 &&

2209 
É
->
tm_mday
 > 
to
->
day
 )

2213 
	}
}

2218 
	$x509·r£_»voked
ĞcÚ¡ 
x509_û¹
 *
üt
, cÚ¡ 
x509_ül
 *
ül
 )

2220 cÚ¡ 
x509_ül_’Œy
 *
cur
 = &
ül
->
’Œy
;

2222  
cur
 !ğ
NULL
 && cur->
£rŸl
.
Ën
 != 0 )

2224 ifĞ
	`memcmp
Ğ
üt
->
£rŸl
.
p
, 
cur
->£rŸl.p, c¹->£rŸl.
Ën
 ) == 0 )

2226 ifĞ
	`x509·r£_time_expœed
Ğ&
cur
->
»voÿtiÚ_d©e
 ) )

2230 
cur
 = cur->
Ãxt
;

2234 
	}
}

2241 
	$x509_hash
ĞcÚ¡ *
š
, 
Ën
, 
®g
,

2242 *
out
 )

2244  
®g
 )

2246 #ià
	`defšed
(
POLARSSL_MD2_C
)

2247 
SIG_RSA_MD2
 : 
	`md2
Ğ
š
, 
Ën
, 
out
 ); ;

2249 #ià
	`defšed
(
POLARSSL_MD4_C
)

2250 
SIG_RSA_MD4
 : 
	`md4
Ğ
š
, 
Ën
, 
out
 ); ;

2252 #ià
	`defšed
(
POLARSSL_MD5_C
)

2253 
SIG_RSA_MD5
 : 
	`md5
Ğ
š
, 
Ën
, 
out
 ); ;

2255 #ià
	`defšed
(
POLARSSL_SHA1_C
)

2256 
SIG_RSA_SHA1
 : 
	`sha1
Ğ
š
, 
Ën
, 
out
 ); ;

2258 #ià
	`defšed
(
POLARSSL_SHA2_C
)

2259 
SIG_RSA_SHA224
 : 
	`sha2
Ğ
š
, 
Ën
, 
out
, 1 ); ;

2260 
SIG_RSA_SHA256
 : 
	`sha2
Ğ
š
, 
Ën
, 
out
, 0 ); ;

2262 #ià
	`defšed
(
POLARSSL_SHA4_C
)

2263 
SIG_RSA_SHA384
 : 
	`sha4
Ğ
š
, 
Ën
, 
out
, 1 ); ;

2264 
SIG_RSA_SHA512
 : 
	`sha4
Ğ
š
, 
Ën
, 
out
, 0 ); ;

2267 
	`mem£t
Ğ
out
, '\xFF', 64 );

2270 
	}
}

2275 
	$x509·r£_v”ify
Ğ
x509_û¹
 *
üt
,

2276 
x509_û¹
 *
Œu¡_ÿ
,

2277 
x509_ül
 *
ÿ_ül
,

2278 cÚ¡ *
ú
, *
æags
 )

2280 
ú_Ën
;

2281 
hash_id
;

2282 
·thËn
;

2283 
x509_û¹
 *
cur
;

2284 
x509_Çme
 *
Çme
;

2285 
hash
[64];

2287 *
æags
 = 0;

2289 ifĞ
	`x509·r£_time_expœed
Ğ&
üt
->
v®id_to
 ) )

2290 *
æags
 = 
BADCERT_EXPIRED
;

2292 ifĞ
ú
 !ğ
NULL
 )

2294 
Çme
 = &
üt
->
subjeù
;

2295 
ú_Ën
 = 
	`¡¾’
Ğ
ú
 );

2297  
Çme
 !ğ
NULL
 )

2299 ifĞ
	`memcmp
Ğ
Çme
->
oid
.
p
, 
OID_CN
, 3 ) == 0 &&

2300 
	`memcmp
Ğ
Çme
->
v®
.
p
, 
ú
, 
ú_Ën
 ) == 0 &&

2301 
Çme
->
v®
.
Ën
 =ğ
ú_Ën
 )

2304 
Çme
 =‚ame->
Ãxt
;

2307 ifĞ
Çme
 =ğ
NULL
 )

2308 *
æags
 |ğ
BADCERT_CN_MISMATCH
;

2311 *
æags
 |ğ
BADCERT_NOT_TRUSTED
;

2317 
cur
 = 
üt
->
Ãxt
;

2319 
·thËn
 = 1;

2321  
cur
 !ğ
NULL
 && cur->
v”siÚ
 != 0 )

2323 ifĞ
cur
->
ÿ_i¡rue
 == 0 ||

2324 
üt
->
issu”_¿w
.
Ën
 !ğ
cur
->
subjeù_¿w
.len ||

2325 
	`memcmp
Ğ
üt
->
issu”_¿w
.
p
, 
cur
->
subjeù_¿w
.p,

2326 
üt
->
issu”_¿w
.
Ën
 ) != 0 )

2328 
cur
 = cur->
Ãxt
;

2332 
hash_id
 = 
üt
->
sig_®g
;

2334 
	`x509_hash
Ğ
üt
->
tbs
.
p
, c¹->tbs.
Ën
, 
hash_id
, 
hash
 );

2336 ifĞ
	`r§_pkcs1_v”ify
Ğ&
cur
->
r§
, 
RSA_PUBLIC
, 
hash_id
,

2337 0, 
hash
, 
üt
->
sig
.
p
 ) != 0 )

2338 Ğ
POLARSSL_ERR_X509_CERT_VERIFY_FAILED
 );

2340 
·thËn
++;

2342 
üt
 = 
cur
;

2343 
cur
 = 
üt
->
Ãxt
;

2349  
Œu¡_ÿ
 !ğ
NULL
 &&ru¡_ÿ->
v”siÚ
 != 0 )

2351 ifĞ
üt
->
issu”_¿w
.
Ën
 !ğ
Œu¡_ÿ
->
subjeù_¿w
.len ||

2352 
	`memcmp
Ğ
üt
->
issu”_¿w
.
p
, 
Œu¡_ÿ
->
subjeù_¿w
.p,

2353 
üt
->
issu”_¿w
.
Ën
 ) != 0 )

2355 
Œu¡_ÿ
 =ru¡_ÿ->
Ãxt
;

2359 ifĞ
Œu¡_ÿ
->
max_·thËn
 > 0 &&

2360 
Œu¡_ÿ
->
max_·thËn
 < 
·thËn
 )

2363 
hash_id
 = 
üt
->
sig_®g
;

2365 
	`x509_hash
Ğ
üt
->
tbs
.
p
, c¹->tbs.
Ën
, 
hash_id
, 
hash
 );

2367 ifĞ
	`r§_pkcs1_v”ify
Ğ&
Œu¡_ÿ
->
r§
, 
RSA_PUBLIC
, 
hash_id
,

2368 0, 
hash
, 
üt
->
sig
.
p
 ) == 0 )

2373 *
æags
 &ğ~
BADCERT_NOT_TRUSTED
;

2377 
Œu¡_ÿ
 =ru¡_ÿ->
Ãxt
;

2390  
Œu¡_ÿ
 !ğ
NULL
 && 
ÿ_ül
 !ğNULL && ca_ül->
v”siÚ
 != 0 )

2392 ifĞ
ÿ_ül
->
issu”_¿w
.
Ën
 !ğ
Œu¡_ÿ
->
subjeù_¿w
.len ||

2393 
	`memcmp
Ğ
ÿ_ül
->
issu”_¿w
.
p
, 
Œu¡_ÿ
->
subjeù_¿w
.p,

2394 
ÿ_ül
->
issu”_¿w
.
Ën
 ) != 0 )

2396 
ÿ_ül
 = ca_ül->
Ãxt
;

2403 
hash_id
 = 
ÿ_ül
->
sig_®g
;

2405 
	`x509_hash
Ğ
ÿ_ül
->
tbs
.
p
, ca_ül->tbs.
Ën
, 
hash_id
, 
hash
 );

2407 ifĞ!
	`r§_pkcs1_v”ify
Ğ&
Œu¡_ÿ
->
r§
, 
RSA_PUBLIC
, 
hash_id
,

2408 0, 
hash
, 
ÿ_ül
->
sig
.
p
 ) == 0 )

2413 *
æags
 |ğ
BADCRL_NOT_TRUSTED
;

2420 ifĞ
	`x509·r£_time_expœed
Ğ&
ÿ_ül
->
Ãxt_upd©e
 ) )

2421 *
æags
 |ğ
BADCRL_EXPIRED
;

2426 ifĞ
	`x509·r£_»voked
(
üt
, 
ÿ_ül
) )

2428 *
æags
 |ğ
BADCERT_REVOKED
;

2432 
ÿ_ül
 = ca_ül->
Ãxt
;

2435 ifĞ*
æags
 != 0 )

2436 Ğ
POLARSSL_ERR_X509_CERT_VERIFY_FAILED
 );

2439 
	}
}

2444 
	$x509_ä“
Ğ
x509_û¹
 *
üt
 )

2446 
x509_û¹
 *
û¹_cur
 = 
üt
;

2447 
x509_û¹
 *
û¹_´v
;

2448 
x509_Çme
 *
Çme_cur
;

2449 
x509_Çme
 *
Çme_´v
;

2451 ifĞ
üt
 =ğ
NULL
 )

2456 
	`r§_ä“
Ğ&
û¹_cur
->
r§
 );

2458 
Çme_cur
 = 
û¹_cur
->
issu”
.
Ãxt
;

2459  
Çme_cur
 !ğ
NULL
 )

2461 
Çme_´v
 = 
Çme_cur
;

2462 
Çme_cur
 =‚ame_cur->
Ãxt
;

2463 
	`mem£t
Ğ
Çme_´v
, 0, Ğ
x509_Çme
 ) );

2464 
	`ä“
Ğ
Çme_´v
 );

2467 
Çme_cur
 = 
û¹_cur
->
subjeù
.
Ãxt
;

2468  
Çme_cur
 !ğ
NULL
 )

2470 
Çme_´v
 = 
Çme_cur
;

2471 
Çme_cur
 =‚ame_cur->
Ãxt
;

2472 
	`mem£t
Ğ
Çme_´v
, 0, Ğ
x509_Çme
 ) );

2473 
	`ä“
Ğ
Çme_´v
 );

2476 ifĞ
û¹_cur
->
¿w
.
p
 !ğ
NULL
 )

2478 
	`mem£t
Ğ
û¹_cur
->
¿w
.
p
, 0, c”t_cur->¿w.
Ën
 );

2479 
	`ä“
Ğ
û¹_cur
->
¿w
.
p
 );

2482 
û¹_cur
 = c”t_cur->
Ãxt
;

2484  
û¹_cur
 !ğ
NULL
 );

2486 
û¹_cur
 = 
üt
;

2489 
û¹_´v
 = 
û¹_cur
;

2490 
û¹_cur
 = c”t_cur->
Ãxt
;

2492 
	`mem£t
Ğ
û¹_´v
, 0, Ğ
x509_û¹
 ) );

2493 ifĞ
û¹_´v
 !ğ
üt
 )

2494 
	`ä“
Ğ
û¹_´v
 );

2496  
û¹_cur
 !ğ
NULL
 );

2497 
	}
}

2502 
	$x509_ül_ä“
Ğ
x509_ül
 *
ül
 )

2504 
x509_ül
 *
ül_cur
 = 
ül
;

2505 
x509_ül
 *
ül_´v
;

2506 
x509_Çme
 *
Çme_cur
;

2507 
x509_Çme
 *
Çme_´v
;

2508 
x509_ül_’Œy
 *
’Œy_cur
;

2509 
x509_ül_’Œy
 *
’Œy_´v
;

2511 ifĞ
ül
 =ğ
NULL
 )

2516 
Çme_cur
 = 
ül_cur
->
issu”
.
Ãxt
;

2517  
Çme_cur
 !ğ
NULL
 )

2519 
Çme_´v
 = 
Çme_cur
;

2520 
Çme_cur
 =‚ame_cur->
Ãxt
;

2521 
	`mem£t
Ğ
Çme_´v
, 0, Ğ
x509_Çme
 ) );

2522 
	`ä“
Ğ
Çme_´v
 );

2525 
’Œy_cur
 = 
ül_cur
->
’Œy
.
Ãxt
;

2526  
’Œy_cur
 !ğ
NULL
 )

2528 
’Œy_´v
 = 
’Œy_cur
;

2529 
’Œy_cur
 =ƒÁry_cur->
Ãxt
;

2530 
	`mem£t
Ğ
’Œy_´v
, 0, Ğ
x509_ül_’Œy
 ) );

2531 
	`ä“
Ğ
’Œy_´v
 );

2534 ifĞ
ül_cur
->
¿w
.
p
 !ğ
NULL
 )

2536 
	`mem£t
Ğ
ül_cur
->
¿w
.
p
, 0, c¾_cur->¿w.
Ën
 );

2537 
	`ä“
Ğ
ül_cur
->
¿w
.
p
 );

2540 
ül_cur
 = c¾_cur->
Ãxt
;

2542  
ül_cur
 !ğ
NULL
 );

2544 
ül_cur
 = 
ül
;

2547 
ül_´v
 = 
ül_cur
;

2548 
ül_cur
 = c¾_cur->
Ãxt
;

2550 
	`mem£t
Ğ
ül_´v
, 0, Ğ
x509_ül
 ) );

2551 ifĞ
ül_´v
 !ğ
ül
 )

2552 
	`ä“
Ğ
ül_´v
 );

2554  
ül_cur
 !ğ
NULL
 );

2555 
	}
}

2557 #ià
defšed
(
POLARSSL_SELF_TEST
)

2559 
	~"pŞ¬s¦/û¹s.h
"

2564 
	$x509_£lf_‹¡
Ğ
v”bo£
 )

2566 #ià
	`defšed
(
POLARSSL_MD5_C
)

2567 
»t
, 
i
, 
j
;

2568 
x509_û¹
 
ÿû¹
;

2569 
x509_û¹
 
şiû¹
;

2570 
r§_cÚ‹xt
 
r§
;

2572 ifĞ
v”bo£
 != 0 )

2573 
	`´štf
( " X.509 certificate†oad: " );

2575 
	`mem£t
Ğ&
şiû¹
, 0, Ğ
x509_û¹
 ) );

2577 
»t
 = 
	`x509·r£_üt
Ğ&
şiû¹
, (*è
‹¡_şi_üt
,

2578 
	`¡¾’
Ğ
‹¡_şi_üt
 ) );

2579 ifĞ
»t
 != 0 )

2581 ifĞ
v”bo£
 != 0 )

2582 
	`´štf
( "failed\n" );

2584 Ğ
»t
 );

2587 
	`mem£t
Ğ&
ÿû¹
, 0, Ğ
x509_û¹
 ) );

2589 
»t
 = 
	`x509·r£_üt
Ğ&
ÿû¹
, (*è
‹¡_ÿ_üt
,

2590 
	`¡¾’
Ğ
‹¡_ÿ_üt
 ) );

2591 ifĞ
»t
 != 0 )

2593 ifĞ
v”bo£
 != 0 )

2594 
	`´štf
( "failed\n" );

2596 Ğ
»t
 );

2599 ifĞ
v”bo£
 != 0 )

2600 
	`´štf
( "passed\n X.509…rivate key†oad: " );

2602 
i
 = 
	`¡¾’
Ğ
‹¡_ÿ_key
 );

2603 
j
 = 
	`¡¾’
Ğ
‹¡_ÿ_pwd
 );

2605 ifĞĞ
»t
 = 
	`x509·r£_key
Ğ&
r§
,

2606 (*è
‹¡_ÿ_key
, 
i
,

2607 (*è
‹¡_ÿ_pwd
, 
j
 ) ) != 0 )

2609 ifĞ
v”bo£
 != 0 )

2610 
	`´štf
( "failed\n" );

2612 Ğ
»t
 );

2615 ifĞ
v”bo£
 != 0 )

2616 
	`´štf
( "passed\n X.509 signature verify: ");

2618 
»t
 = 
	`x509·r£_v”ify
Ğ&
şiû¹
, &
ÿû¹
, 
NULL
, "PŞ¬SSL Cl›Á 2", &
i
 );

2619 ifĞ
»t
 != 0 )

2621 
	`´štf
("%02x", 
i
);

2622 ifĞ
v”bo£
 != 0 )

2623 
	`´štf
( "failed\n" );

2625 Ğ
»t
 );

2628 ifĞ
v”bo£
 != 0 )

2629 
	`´štf
( "passed\n\n" );

2631 
	`x509_ä“
Ğ&
ÿû¹
 );

2632 
	`x509_ä“
Ğ&
şiû¹
 );

2633 
	`r§_ä“
Ğ&
r§
 );

2637 ((è
v”bo£
);

2638 Ğ
POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 );

2640 
	}
}

	@src/polarssl/xtea.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_XTEA_C
)

30 
	~"pŞ¬s¦/x‹a.h
"

32 
	~<¡ršg.h
>

37 #iâdeà
GET_ULONG_BE


38 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

40 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

41 | ( (è(
b
)[(
i
) + 1] << 16 ) \

42 | ( (è(
b
)[(
i
) + 2] << 8 ) \

43 | ( (è(
b
)[(
i
) + 3] ); \

44 }

	)

47 #iâdeà
PUT_ULONG_BE


48 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

50 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

51 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

52 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

53 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

54 }

	)

60 
	$x‹a_£tup
Ğ
x‹a_cÚ‹xt
 *
ùx
, 
key
[16] )

62 
i
;

64 
	`mem£t
(
ùx
, 0, (
x‹a_cÚ‹xt
));

66  
i
 = 0; i < 4; i++ )

68 
	`GET_ULONG_BE
Ğ
ùx
->
k
[
i
], 
key
, i << 2 );

70 
	}
}

75 
	$x‹a_üy±_ecb
Ğ
x‹a_cÚ‹xt
 *
ùx
, 
mode
, 
šput
[8],

76 
ouut
[8])

78 
ušt32_t
 *
k
, 
v0
, 
v1
, 
i
;

80 
k
 = 
ùx
->k;

82 
	`GET_ULONG_BE
Ğ
v0
, 
šput
, 0 );

83 
	`GET_ULONG_BE
Ğ
v1
, 
šput
, 4 );

85 ifĞ
mode
 =ğ
XTEA_ENCRYPT
 )

87 
ušt32_t
 
sum
 = 0, 
d–
 = 0x9E3779B9;

89  
i
 = 0; i < 32; i++ )

91 
v0
 +ğ(((
v1
 << 4è^ (v1 >> 5)è+ v1è^ (
sum
 + 
k
[sum & 3]);

92 
sum
 +ğ
d–
;

93 
v1
 +ğ(((
v0
 << 4è^ (v0 >> 5)è+ v0è^ (
sum
 + 
k
[(sum>>11) & 3]);

98 
ušt32_t
 
d–
 = 0x9E3779B9, 
sum
 = delta * 32;

100  
i
 = 0; i < 32; i++ )

102 
v1
 -ğ(((
v0
 << 4è^ (v0 >> 5)è+ v0è^ (
sum
 + 
k
[(sum>>11) & 3]);

103 
sum
 -ğ
d–
;

104 
v0
 -ğ(((
v1
 << 4è^ (v1 >> 5)è+ v1è^ (
sum
 + 
k
[sum & 3]);

108 
	`PUT_ULONG_BE
Ğ
v0
, 
ouut
, 0 );

109 
	`PUT_ULONG_BE
Ğ
v1
, 
ouut
, 4 );

112 
	}
}

114 #ià
defšed
(
POLARSSL_SELF_TEST
)

116 
	~<¡ršg.h
>

117 
	~<¡dio.h
>

123 cÚ¡ 
	gx‹a_‹¡_key
[6][16] =

139 cÚ¡ 
	gx‹a_‹¡_±
[6][8] =

149 cÚ¡ 
	gx‹a_‹¡_ù
[6][8] =

162 
	$x‹a_£lf_‹¡
Ğ
v”bo£
 )

164 
i
;

165 
buf
[8];

166 
x‹a_cÚ‹xt
 
ùx
;

168  
i
 = 0; i < 6; i++ )

170 ifĞ
v”bo£
 != 0 )

171 
	`´štf
Ğ" XTEAe¡ #%d: ", 
i
 + 1 );

173 
	`memıy
Ğ
buf
, 
x‹a_‹¡_±
[
i
], 8 );

175 
	`x‹a_£tup
Ğ&
ùx
, (*è
x‹a_‹¡_key
[
i
] );

176 
	`x‹a_üy±_ecb
Ğ&
ùx
, 
XTEA_ENCRYPT
, 
buf
, buf );

178 ifĞ
	`memcmp
Ğ
buf
, 
x‹a_‹¡_ù
[
i
], 8 ) != 0 )

180 ifĞ
v”bo£
 != 0 )

181 
	`´štf
( "failed\n" );

186 ifĞ
v”bo£
 != 0 )

187 
	`´štf
( "passed\n" );

190 ifĞ
v”bo£
 != 0 )

191 
	`´štf
( "\n" );

194 
	}
}

	@src/polarssl/xtea.h

25 #iâdeà
POLARSSL_XTEA_H


26 
	#POLARSSL_XTEA_H


	)

28 #ifdeà
_MSC_VER


29 
	~<ba£tsd.h
>

30 
UINT32
 
	tušt32_t
;

32 
	~<š‰y³s.h
>

35 
	#XTEA_ENCRYPT
 1

	)

36 
	#XTEA_DECRYPT
 0

	)

44 
ušt32_t
 
	mk
[4];

46 
	tx‹a_cÚ‹xt
;

48 #ifdeà
__ılu¥lus


58 
x‹a_£tup
Ğ
x‹a_cÚ‹xt
 *
ùx
, 
key
[16] );

70 
x‹a_üy±_ecb
Ğ
x‹a_cÚ‹xt
 *
ùx
,

71 
mode
,

72 
šput
[8],

73 
ouut
[8] );

80 
x‹a_£lf_‹¡
Ğ
v”bo£
 );

82 #ifdeà
__ılu¥lus


	@src/proxy.c

35 
	~<¡dio.h
>

36 
	~<¡ršg.h
>

37 
	~<”ºo.h
>

38 
	~<uni¡d.h
>

39 
	~<¡dlib.h
>

40 
	~<sys/sock‘.h
>

41 
	~<dbg.h
>

42 
	~<´oxy.h
>

43 
	~<as£¹.h
>

44 
	~<¡dlib.h
>

45 
	~<mem/h®loc.h
>

46 
	~<cÚÃùiÚ.h
>

47 
	~<h‰p11/h‰pş›Á_·r£r.h
>

49 
	gPROXY_READ_RETRIES
 = 100;

50 
	gPROXY_READ_RETRY_WARN
 = 10;

52 
	$Proxy_de¡roy
(
Proxy
 *
´oxy
)

54 if(
´oxy
) {

55 if(
´oxy
->
£rv”
è
	`bde¡roy
(proxy->server);

56 
	`h_ä“
(
´oxy
);

58 
	}
}

60 
Proxy
 *
	$Proxy_ü—‹
(
b¡ršg
 
£rv”
, 
pÜt
)

62 
Proxy
 *
´oxy
 = 
	`h_ÿÎoc
((Proxy), 1);

63 
	`check_mem
(
´oxy
);

65 
´oxy
->
£rv”
 = 
	`b¡rıy
(server);

66 
´oxy
->
pÜt
 =…ort;

67 
´oxy
->
ruÂšg
 = 1;

69  
´oxy
;

71 
”rÜ
:

72 
	`Proxy_de¡roy
(
´oxy
);

73  
NULL
;

74 
	}
}

76 
	$Proxy_»ad_ªd_·r£
(
CÚÃùiÚ
 *
cÚn
)

78 
ava
 = 0;

79 
Å¬£d
 = 0;

80 *
d©a
 = 
NULL
;

81 
Œ›s
 = 0;

83 
	`as£¹
(
cÚn
->
ş›Á
 && "httpclient_parser‚ot configured.");

84 
	`as£¹
(
cÚn
->
´oxy_iob
 && "conn->proxy_iob‚ot configured.");

86 
	`h‰pş›Á_·r£r_š™
(
cÚn
->
ş›Á
);

88 
Œ›s
 = 0;r› < 
PROXY_READ_RETRIES
;ries++) {

89 
d©a
 = 
	`IOBuf_»ad_some
(
cÚn
->
´oxy_iob
, &
ava
);

90 
	`check
(
d©a
 !ğ
NULL
, "Failedo„ead from…roxy.");

91 
	`check
(
ava
 > 0, "Proxy„ead„eturned %d bytes.",‡vail);

93 
d©a
[
ava
] = '\0';

94 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(
cÚn
->
ş›Á
, 
d©a
, 
ava
,‚parsed);

95 
	`check
(
Å¬£d
 != -1, "Major…arsing failure from…roxy backend, Tell Zed.");

96 
	`check
(!
	`h‰pş›Á_·r£r_has_”rÜ
(
cÚn
->
ş›Á
), "Parsingƒrror from server.");

98 if(
	`h‰pş›Á_·r£r_fšish
(
cÚn
->
ş›Á
) == 0) {

99 
	`fdwa™
(
cÚn
->
´oxy_iob
->
fd
, 'r');

105 if(
Œ›s
 > 
PROXY_READ_RETRY_WARN
) {

106 
	`log_w¬n
("Th´oxy back’d ha ¨bad I/O…©‹ºh©„equœed %d„—d befÜ¨h—d” wa com¶‘ed. You should wÜry‡bouˆ™ ³rfÜmªû.", 
Œ›s
);

109 
	`check
(
Œ›s
 < 
PROXY_READ_RETRIES
, "Backend…roxy sendsoo many small…ackets,ried %dimeso„ead from it.",ries);

110 
	`check
(()
cÚn
->
ş›Á
->
body_¡¬t
 <ğ
ava
, "Readoo much.");

113  
Å¬£d
;

115 
”rÜ
:

117 
	}
}

120 
šlše
 
	$·r£_chunks
(*
d©a
, 
h‰pş›Á_·r£r
 *
ş›Á
, 
ava
)

123 
d©a
[
ava
] = '\0';

124 
	`h‰pş›Á_·r£r_š™
(
ş›Á
);

125 
rc
 = 
	`h‰pş›Á_·r£r_execu‹
(
ş›Á
, 
d©a
, 
ava
, 0);

126 
	`check
(
rc
 != -1, "Fatal…arsingƒrror from…roxy, Tell Zed.");

127 
	`check
(!
	`h‰pş›Á_·r£r_has_”rÜ
(
ş›Á
), "Parsingƒrror from server.");

128 
	`check
(
	`h‰pş›Á_·r£r_fšish
(
ş›Á
), "Parser didn't get‡ full„esponse.");

130  
rc
;

131 
”rÜ
:

133 
	}
}

136 
	$Proxy_¡»am_chunks
(
CÚÃùiÚ
 *
cÚn
)

138 
rc
 = 0;

139 
IOBuf
 *
´oxy_iob
 = 
cÚn
->proxy_iob;

140 
	`as£¹
(
´oxy_iob
 && "proxy IOBuf‚ot configured.");

142 
ava
 = 
	`IOBuf_ava
(
´oxy_iob
);

143 *
d©a
 = 
NULL
;

144 
h‰pş›Á_·r£r
 *
ş›Á
 = 
cÚn
->client;

146 
	`as£¹
(
ş›Á
 && "httpclient_parser‚ot configured.");

147 
	`as£¹
(
ş›Á
->
chunked
 && "parser should indicate it has chunks.");

148 
	`as£¹
(!
ş›Á
->
chunks_dÚe
 && "parser should‚ot be in chunks done state.");

149 
	`as£¹
(
ava
 >= 0 && "Can't have‡ < 0‡vail.");

151 
d©a
 = 
ava
 =ğ0 ? 
	`IOBuf_»ad_some
(
´oxy_iob
, &avaè: 
	`IOBuf_¡¬t
(proxy_iob);

154 
rc
 = 
	`·r£_chunks
(
d©a
, 
ş›Á
, 
ava
);

155 
	`check_debug
(
rc
 != -1, "Failedo…arse chunkedƒncoding from client.");

158 
rc
 = 
	`IOBuf_¡»am
(
´oxy_iob
, 
cÚn
->
iob
, 
ş›Á
->
body_¡¬t
 + cl›Á->
cÚ‹Á_Ën
 + 2);

159 
	`check_debug
(
rc
 != -1, "Failedo stream contento client.");

161  
ş›Á
->
chunks_dÚe
;

163 
”rÜ
:

165 
	}
}

168 
	$Proxy_¡»am_to_şo£
(
CÚÃùiÚ
 *
cÚn
)

170 
cÚn
->
ş›Á
->
şo£
 = 1;

172 
tÙ®
 = 
cÚn
->
iob
->
Ën
 <ğcÚn->
´oxy_iob
->len ?

173 
cÚn
->
iob
->
Ën
 : cÚn->
´oxy_iob
->len;

175 
rc
 = 
	`IOBuf_£nd_®l
(
cÚn
->
iob
, 
	`IOBuf_¡¬t
(cÚn->
´oxy_iob
),

176 
	`IOBuf_ava
(
cÚn
->
´oxy_iob
));

178 
	`check_debug
(
rc
 != -1, "Failure sending‡ll on…roxy stream.");

180 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
´oxy_iob
, 
	`IOBuf_ava
(conn->proxy_iob)) != -1, "Final commit failed…roxy streaming until closed.");

182 
rc
 = 0;„c != -1;) {

183 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
tÙ®
);

188 
”rÜ
:

190 
	}
}

	@src/proxy.h

35 #iâdeà
_´oxy_h


36 
	#_´oxy_h


	)

38 
	~<b¡ršg.h
>

40 
	sProxy
 {

41 
b¡ršg
 
	m£rv”
;

42 
	mpÜt
;

43 
	mruÂšg
;

44 } 
	tProxy
;

46 
Proxy
 *
Proxy_ü—‹
(
b¡ršg
 
£rv”
, 
pÜt
);

48 
Proxy_de¡roy
(
Proxy
 *
´oxy
);

50 
	gCÚÃùiÚ
;

51 
Proxy_¡»am_»¥Ú£
(
CÚÃùiÚ
 *
cÚn
, 
tÙ®
, 
Ä—d
);

53 
Proxy_¡»am_chunks
(
CÚÃùiÚ
 *
cÚn
);

55 
Proxy_»ad_ªd_·r£
(
CÚÃùiÚ
 *
cÚn
);

57 
Proxy_¡»am_to_şo£
(
CÚÃùiÚ
 *
cÚn
);

59 
PROXY_READ_RETRIES
;

60 
PROXY_READ_RETRY_WARN
;

	@src/register.c

35 
	~<as£¹.h
>

36 
	~<”ºo.h
>

37 
	~<¡ršg.h
>

38 
	~<uni¡d.h
>

39 
	~<sys/ty³s.h
>

40 
	~"Š‘¡ršgs.h
"

41 
	~"Š‘¡ršgs_im¶.h
"

43 
	~"»gi¡”.h
"

44 
	~"cÚÃùiÚ.h
"

45 
	~"dbg.h
"

46 
	~"sk/sk.h
"

47 
	~"adt/d¬¿y.h
"

48 
	~"£‰šg.h
"

51 
ušt32_t
 
	gTHE_CURRENT_TIME_IS
 = 0;

53 
d¬¿y_t
 *
	gREGISTRATIONS
 = 
NULL
;

54 
d¬¿y_t
 *
	gREG_ID_TO_FD
 = 
NULL
;

55 
ušt16_t
 
	gREG_COUNT
 = 0;

56 
	gNUM_REG_FD
 = 0;

58 
	$Regi¡”_š™
()

60 
THE_CURRENT_TIME_IS
 = 
	`time
(
NULL
);

61 
REGISTRATIONS
 = 
	`d¬¿y_ü—‹
((
Regi¡¿tiÚ
), 
MAX_REGISTERED_FDS
);

62 
REG_ID_TO_FD
 = 
	`d¬¿y_ü—‹
(0, 
MAX_REGISTERED_FDS
);

63 
	}
}

65 
šlše
 
	$Regi¡”_ş—r
(
Regi¡¿tiÚ
 *
»g
)

67 
»g
->
d©a
 = 
NULL
;

68 
»g
->
Ï¡_pšg
 = 0;

69 
»g
->
by‹s_»ad
 = 0;

70 
»g
->
by‹s_wr™‹n
 = 0;

71 
»g
->
Ï¡_»ad
 = 0;

72 
»g
->
Ï¡_wr™e
 = 0;

73 
	`d¬¿y_»move
(
REG_ID_TO_FD
, 
»g
->
id
);

74 
	}
}

76 
	$Regi¡”_cÚÃù
(
fd
, 
CÚÃùiÚ
* 
d©a
)

78 
rc
 = 0;

79 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

80 
	`check
(
d©a
 !ğ
NULL
, "data can't be NULL");

82 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

84 if(
»g
 =ğ
NULL
) {

85 
»g
 = 
	`d¬¿y_Ãw
(
REGISTRATIONS
);

87 
	`d¬¿y_£t
(
REGISTRATIONS
, 
fd
, 
»g
);

88 
	`check
(
»g
 !ğ
NULL
, "Failedo‡llocate‡‚ew„egistration.");

91 if(
	`Regi¡”_v®id
(
»g
)) {

92 
	`debug
("Look lik¡®»gi¡¿tiÚ iÀ%d, kÈ™ befÜ™ g‘ out.", 
fd
);

94 
rc
 = 
	`Regi¡”_discÚÃù
(
fd
);

95 
	`check
(
rc
 !ğ-1, "Weœdƒ¼Ü,r›dØdiscÚÃù som‘hšgh©ƒxi¡ th’ gÙ‡À”rÜ: %d", 
fd
);

98 
»g
->
d©a
 = data;

99 
»g
->
Ï¡_pšg
 = 
THE_CURRENT_TIME_IS
;

100 
»g
->
fd
 = fd;

103 
»g
->
id
 = 
REG_COUNT
++;

104 
	`d¬¿y_£t
(
REG_ID_TO_FD
, 
»g
->
id
,„eg);

107 
NUM_REG_FD
++;

109  
»g
->
id
;

110 
”rÜ
:

112 
	}
}

115 
	$Regi¡”_discÚÃù
(
fd
)

117 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

118 
	`check
(
fd
 >= 0, "Invalid FD given for disconnect.");

120 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

122 
	`check_debug
(
	`Regi¡”_v®id
(
»g
), "A‰em±ØuÄegi¡” FD %d which i ®»ady gÚe.", 
fd
);

123 
	`check
(
»g
->
fd
 == fd, "Askedo disconnect fd %d but„egister had %d", fd,„eg->fd);

126 ià(
»g
->
d©a
->
iob
 !ğ
NULL
) {

127 
»g
->
d©a
->
iob
->
şo£d
=1;

130 
	`Regi¡”_ş—r
(
»g
);

131 
	`şo£
(
»g
->
fd
);

134 
NUM_REG_FD
--;

135  
»g
->
id
;

137 
”rÜ
:

138 
	`fdşo£
(
fd
);

140 
	}
}

142 
	$Regi¡”_pšg
(
fd
)

144 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

145 
	`check
(
fd
 >= 0, "Invalid FD given for…ing: %d", fd);

146 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

148 
	`check_debug
(
	`Regi¡”_v®id
(
»g
), "A‰em±Øpšg‡ÀFDh© i¢'ˆ»gi¡”ed: %d", 
fd
);

150 
»g
->
Ï¡_pšg
 = 
THE_CURRENT_TIME_IS
;

151  
»g
->
Ï¡_pšg
;

153 
”rÜ
:

155 
	}
}

158 
	$Regi¡”_»ad
(
fd
, 
off_t
 
by‹s
)

160 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

161 
	`check
(
fd
 >= 0, "Invalid FD given for Register_read: %d", fd);

162 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

164 if(
	`Regi¡”_v®id
(
»g
)) {

165 
»g
->
Ï¡_»ad
 = 
THE_CURRENT_TIME_IS
;

166 
»g
->
by‹s_»ad
 +ğ
by‹s
;

167  
»g
->
Ï¡_»ad
;

172 
”rÜ
:

174 
	}
}

177 
	$Regi¡”_wr™e
(
fd
, 
off_t
 
by‹s
)

179 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

180 
	`check
(
fd
 >= 0, "Invalid FD given for Register_write: %d", fd);

181 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

183 if(
	`Regi¡”_v®id
(
»g
)) {

184 
»g
->
Ï¡_wr™e
 = 
THE_CURRENT_TIME_IS
;

185 
»g
->
by‹s_wr™‹n
 +ğ
by‹s
;

186  
»g
->
Ï¡_wr™e
;

191 
”rÜ
:

193 
	}
}

196 
CÚÃùiÚ
 *
	$Regi¡”_fd_exi¡s
(
fd
)

198 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

199 
	`check
(
fd
 >= 0, "Invalid FD given forƒxists check");

201 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

203  
»g
 !ğ
NULL
 ?„eg->
d©a
 : NULL;

204 
”rÜ
:

205  
NULL
;

206 
	}
}

209 
	$Regi¡”_fd_fÜ_id
(
id
)

211 
	`check
(
id
 < 
MAX_REGISTERED_FDS
, "Ident (id) giveno„egister is greaterhan max.");

212 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REG_ID_TO_FD
, 
id
);

214 
	`check
(
	`Regi¡”_v®id
(
»g
), "NÙhšg„egi¡”ed und” id %d.", 
id
);

216  
»g
->
fd
;

217 
”rÜ
:

219 
	}
}

221 
	$Regi¡”_id_fÜ_fd
(
fd
)

223 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

224 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

225 
	`check
(
	`Regi¡”_v®id
(
»g
), "NØID fÜ fd: %d", 
fd
);

227  
»g
->
id
;

228 
”rÜ
:

230 
	}
}

232 
	#ZERO_OR_DELTA
(
N
, 
T
è(T =ğ0 ? T : N - T)

	)

235 
gb¡ršg
 
	gREGISTER_HEADERS
 = 
bsStic
("86:2:id,2:fd,4:type,9:last_ping,9:last_read,10:last_write,10:bytes_read,13:bytes_written,]");

237 
Šs_v®ue_t
 *
	$Regi¡”_šfo
()

239 
i
 = 0;

240 
Regi¡¿tiÚ
 *
»g
;

241 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

242 
nsÿÂed
 = 0;

244 
time_t
 
now
 = 
THE_CURRENT_TIME_IS
;

246 
i
 = 0, 
nsÿÂed
 = 0; i < 
	`d¬¿y_max
(
REGISTRATIONS
è&&‚sÿÂed < 
NUM_REG_FD
; i++) {

247 
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
i
);

249 if(
	`Regi¡”_v®id
(
»g
)) {

250 
nsÿÂed
++;

252 
Šs_v®ue_t
 *
d©a
 = 
	`Šs_Ãw_li¡
();

253 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->
id
));

254 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
i
));

255 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->d©a->
ty³
));

256 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
	`ZERO_OR_DELTA
(
now
, 
»g
->
Ï¡_pšg
)));

257 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
	`ZERO_OR_DELTA
(
now
, 
»g
->
Ï¡_»ad
)));

258 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
	`ZERO_OR_DELTA
(
now
, 
»g
->
Ï¡_wr™e
)));

259 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->
by‹s_»ad
));

260 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->
by‹s_wr™‹n
));

261 
	`Šs_add_to_li¡
(
rows
, 
d©a
);

265  
	`Šs_¡ªd¬d_bË
(&
REGISTER_HEADERS
, 
rows
);

266 
	}
}

268 
	$Regi¡”_ş—nout
()

270 
i
 = 0;

271 
nkËd
 = 0;

272 
nsÿÂed
 = 0;

273 
time_t
 
now
 = 
THE_CURRENT_TIME_IS
;

274 
mš_pšg
 = 
	`S‘tšg_g‘_št
("lim™s.mš_pšg", 
DEFAULT_MIN_PING
);

275 
mš_wr™e_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_wr™e_¿‹", 
DEFAULT_MIN_READ_RATE
);

276 
mš_»ad_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_»ad_¿‹", 
DEFAULT_MIN_WRITE_RATE
);

277 
kl_lim™
 = 
	`S‘tšg_g‘_št
("lim™s.kl_lim™", 
DEFAULT_KILL_LIMIT
);

279 
i
 = 0, 
nsÿÂed
 = 0; i < 
	`d¬¿y_max
(
REGISTRATIONS
è&&‚sÿÂed < 
NUM_REG_FD
; i++) {

280 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
i
);

282 if(
	`Regi¡”_v®id
(
»g
)) {

283 
nsÿÂed
++;

285 
Ï¡_pšg
 = 
	`ZERO_OR_DELTA
(
now
, 
»g
->last_ping);

286 
off_t
 
»ad_¿‹
 = 
»g
->
by‹s_»ad
 / (
	`ZERO_OR_DELTA
(
now
,„eg->
Ï¡_»ad
) + 1);

287 
off_t
 
wr™e_¿‹
 = 
»g
->
by‹s_wr™‹n
 / (
	`ZERO_OR_DELTA
(
now
,„eg->
Ï¡_wr™e
) + 1);

288 
should_kl
 = 0;

290 
	`debug
("Checking fd=%d:conn_id=%d‡gainst†ast_ping: %d,„ead_rate: %d, write_rate: %d",

291 
i
, 
»g
->
id
, 
Ï¡_pšg
, 
»ad_¿‹
, 
wr™e_¿‹
);

294 if(
mš_pšg
 !ğ0 && 
Ï¡_pšg
 > min_ping) {

295 
	`debug
("Connection fd=%d:conn_id=%d over†imits.min_pingime: %d < %d",

296 
i
, 
»g
->
id
, 
mš_pšg
, 
Ï¡_pšg
);

297 
should_kl
++;

300 if(
mš_»ad_¿‹
 !ğ0 && 
»ad_¿‹
 < min_read_rate) {

301 
	`debug
("Connection fd=%d:conn_id=%d„ead„ate†owerhan‡llowed: %d < %d",

302 
i
, 
»g
->
id
, 
»ad_¿‹
, 
mš_»ad_¿‹
);

303 
should_kl
++;

306 if(
mš_wr™e_¿‹
 !ğ0 && 
wr™e_¿‹
 < min_write_rate) {

307 
	`debug
("Connection fd=%d:conn_id=%d write„ate†owerhan‡llowed: %d < %d",

308 
i
, 
»g
->
id
, 
wr™e_¿‹
, 
mš_wr™e_¿‹
);

309 
should_kl
++;

312 if(
should_kl
 > 
kl_lim™
) {

313 
nkËd
++;

314 
	`Regi¡”_discÚÃù
(
i
);

319 if(
nkËd
) {

320 
	`log_w¬n
("KËd %d cÚÃùiÚ accÜdšgØmš_pšg: %d, mš_wr™e_¿‹: %d, mš_»ad_¿‹: %d", 
nkËd
, 
mš_pšg
, 
mš_wr™e_¿‹
, 
mš_»ad_¿‹
);

323  
nkËd
;

324 
	}
}

	@src/register.h

35 #iâdeà
_»gi¡”_h


36 
	#_»gi¡”_h


	)

38 
	~<time.h
>

39 
	~<¡dšt.h
>

40 
	~<b¡ršg.h
>

41 
	~<sys/ty³s.h
>

43 
	#MAX_REGISTERED_FDS
 64 * 1024

	)

44 
	#DEFAULT_MIN_PING
 120

	)

45 
	#DEFAULT_MIN_READ_RATE
 300

	)

46 
	#DEFAULT_MIN_WRITE_RATE
 300

	)

47 
	#DEFAULT_KILL_LIMIT
 2

	)

50 
ušt32_t
 
THE_CURRENT_TIME_IS
;

52 
	sRegi¡¿tiÚ
 {

53 
CÚÃùiÚ
 *
	md©a
;

54 
ušt16_t
 
	mfd
;

55 
ušt16_t
 
	mid
;

56 
ušt32_t
 
	mÏ¡_pšg
;

57 
off_t
 
	mÏ¡_»ad
;

58 
off_t
 
	mÏ¡_wr™e
;

59 
off_t
 
	mby‹s_»ad
;

60 
off_t
 
	mby‹s_wr™‹n
;

61 } 
	tRegi¡¿tiÚ
;

63 
Regi¡”_cÚÃù
(
fd
, 
CÚÃùiÚ
 *
d©a
);

65 
Regi¡”_discÚÃù
(
fd
);

67 
Regi¡”_pšg
(
fd
);

69 
Regi¡”_»ad
(
fd
, 
off_t
 
by‹s
);

71 
Regi¡”_wr™e
(
fd
, 
off_t
 
by‹s
);

73 
Regi¡”_š™
();

75 
CÚÃùiÚ
 *
Regi¡”_fd_exi¡s
(
fd
);

77 
Regi¡”_id_fÜ_fd
(
fd
);

79 
Regi¡”_fd_fÜ_id
(
id
);

81 
Regi¡”_ş—nout
();

83 
Šs_v®ue_t
 *
Regi¡”_šfo
();

85 
	#Regi¡”_v®id
(
R
è((Rè!ğ
NULL
 && (R)->
d©a
 !ğNULL)

	)

	@src/request.c

35 
	#_XOPEN_SOURCE
 1

	)

37 
	~<¡dlib.h
>

38 
	~<as£¹.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

42 
	~"£‰šg.h
"

43 
	~"»gi¡”.h
"

44 
	~"h—d”s.h
"

45 
	~"adt/hash.h
"

46 
	~"dbg.h
"

47 
	~"»que¡.h
"

48 
	~"Š‘¡ršgs.h
"

50 
	gMAX_HEADER_COUNT
=0;

51 
	gMAX_DUPE_HEADERS
=5;

53 
	$Reque¡_š™
()

55 
MAX_HEADER_COUNT
 = 
	`S‘tšg_g‘_št
("limits.header_count", 128 * 10);

56 
	`log_šfo
("MAX†im™s.h—d”_couÁ=%d", 
MAX_HEADER_COUNT
);

57 
	}
}

60 
hnode_t
 *
	$»q_®loc_hash
(*
nÙu£d
)

62  (
hnode_t
 *)
	`m®loc
((hnode_t));

63 
	}
}

65 
	$»q_ä“_hash
(
hnode_t
 *
node
, *
nÙu£d
)

67 
	`b¡rLi¡De¡roy
((
b¡rLi¡
 *)
	`hnode_g‘
(
node
));

68 
	`bde¡roy
((
b¡ršg
)
	`hnode_g‘key
(
node
));

69 
	`ä“
(
node
);

70 
	}
}

73 
	$»que¡_m‘hod_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

75 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

76 
»q
->
»que¡_m‘hod
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

77 
	}
}

79 
	$äagm’t_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

81 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

82 
»q
->
äagm’t
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

83 
	}
}

85 
	$h‰p_v”siÚ_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

87 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

88 
»q
->
v”siÚ
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

89 
	}
}

92 
	$h—d”_dÚe_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

94 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

97 cÚ¡ *
ş’
 = 
	`bd©a
(
	`Reque¡_g‘
(
»q
, &
HTTP_CONTENT_LENGTH
));

98 if(
ş’
è
»q
->
·r£r
.
cÚ‹Á_Ën
 = 
	`©oi
(clen);

101 
»q
->
ho¡
 = 
	`Reque¡_g‘
Ôeq, &
HTTP_HOST
);

102 
cŞÚ
 = 
	`b¡rchr
(
»q
->
ho¡
, ':');

103 if(
»q
->
ho¡
) {

104 
»q
->
ho¡_Çme
 = 
cŞÚ
 > 0 ? 
	`bH—d
Ôeq->
ho¡
, cŞÚè: 
	`b¡rıy
(req->host);

106 
	}
}

108 
	$uri_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

110 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

111 
»q
->
uri
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

112 
	}
}

114 
	$·th_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

116 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

117 
	`as£¹
(
»q
->
·th
 =ğ
NULL
 && "This should‚ot happen, Tell Zed.");

118 
»q
->
·th
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

119 
	}
}

121 
	$qu”y_¡ršg_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

123 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

124 
»q
->
qu”y_¡ršg
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

125 
	}
}

128 
	$h—d”_f›ld_cb
(*
d©a
, cÚ¡ *
f›ld
, 
size_t
 
æ’
,

129 cÚ¡ *
v®ue
, 
size_t
 
vËn
)

131 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

133 if(
	`hash_isfuÎ
(
»q
->
h—d”s
)) {

134 
	`log_”r
("Request had morehan %d headers‡llowed by†imits.header_count.",

135 
MAX_HEADER_COUNT
);

137 
b¡ršg
 
v¡r
 = 
	`blk2b¡r
(
v®ue
, 
vËn
);

138 
b¡ršg
 
f¡r
 = 
	`blk2b¡r
(
f›ld
, 
æ’
);

139 
	`btŞow”
(
f¡r
);

141 
	`Reque¡_£t
(
»q
, 
f¡r
, 
v¡r
, 0);

143 
	}
}

146 
	$Reque¡_£t
(
Reque¡
 *
»q
, 
b¡ršg
 
key
, b¡ršg 
v®
, 
»¶aû
)

148 
hnode_t
 *
n
 = 
	`hash_lookup
(
»q
->
h—d”s
, 
key
);

149 
b¡rLi¡
 *
v®_li¡
 = 
NULL
;

150 
rc
 = 0;

151 
i
 = 0;

153 if(
n
 =ğ
NULL
) {

155 
v®_li¡
 = 
	`b¡rLi¡C»©e
();

156 
rc
 = 
	`b¡rLi¡AÎoc
(
v®_li¡
, 
MAX_DUPE_HEADERS
);

157 
	`check
(
rc
 =ğ
BSTR_OK
, "Couldn't‡llocate space for header values.");

159 
v®_li¡
->
’Œy
[0] = 
v®
;

160 
v®_li¡
->
qty
 = 1;

161 
	`hash_®loc_š£¹
(
»q
->
h—d”s
, 
key
, 
v®_li¡
);

163 
v®_li¡
 = 
	`hnode_g‘
(
n
);

164 
	`bde¡roy
(
key
);

166 if(
»¶aû
) {

168 
i
 = 0; i < 
v®_li¡
->
qty
; i++) {

169 
	`bde¡roy
(
v®_li¡
->
’Œy
[
i
]);

172 
v®_li¡
->
’Œy
[0] = 
v®
;

173 
v®_li¡
->
qty
 = 1;

175 
	`check
(
v®_li¡
->
qty
 < 
MAX_DUPE_HEADERS
,

177 
	`bd©a
(
key
), 
MAX_DUPE_HEADERS
);

179 
v®_li¡
->
’Œy
[v®_li¡->
qty
++] = 
v®
;

183 
”rÜ
: ;

184 
	}
}

186 
Reque¡
 *
	$Reque¡_ü—‹
()

188 
Reque¡
 *
»q
 = 
	`ÿÎoc
((Request), 1);

189 
	`check_mem
(
»q
);

191 
»q
->
·r£r
.
h‰p_f›ld
 = 
h—d”_f›ld_cb
;

192 
»q
->
·r£r
.
»que¡_m‘hod
 = 
»que¡_m‘hod_cb
;

193 
»q
->
·r£r
.
»que¡_uri
 = 
uri_cb
;

194 
»q
->
·r£r
.
äagm’t
 = 
äagm’t_cb
;

195 
»q
->
·r£r
.
»que¡_·th
 = 
·th_cb
;

196 
»q
->
·r£r
.
qu”y_¡ršg
 = 
qu”y_¡ršg_cb
;

197 
»q
->
·r£r
.
h‰p_v”siÚ
 = 
h‰p_v”siÚ_cb
;

198 
»q
->
·r£r
.
h—d”_dÚe
 = 
h—d”_dÚe_cb
;

200 
»q
->
h—d”s
 = 
	`hash_ü—‹
(
MAX_HEADER_COUNT
, (
hash_comp_t
)
b¡rcmp
, 
b¡r_hash_fun
);

201 
	`check_mem
(
»q
->
h—d”s
);

202 
	`hash_£t_®loÿtÜ
(
»q
->
h—d”s
, 
»q_®loc_hash
, 
»q_ä“_hash
, 
NULL
);

204 
»q
->
·r£r
.
d©a
 =„eq;

206  
»q
;

208 
”rÜ
:

209 
	`Reque¡_de¡roy
(
»q
);

210  
NULL
;

211 
	}
}

213 
šlše
 
	$Reque¡_nuke_·¹s
(
Reque¡
 *
»q
)

215 
	`bde¡roy
(
»q
->
»que¡_m‘hod
);„eq->»que¡_m‘hod = 
NULL
;

216 
	`bde¡roy
(
»q
->
v”siÚ
);„eq->v”siÚ = 
NULL
;

217 
	`bde¡roy
(
»q
->
uri
);„eq->ur˜ğ
NULL
;

218 
	`bde¡roy
(
»q
->
·th
);„eq->·th = 
NULL
;

219 
	`bde¡roy
(
»q
->
qu”y_¡ršg
);„eq->qu”y_¡ršg = 
NULL
;

220 
	`bde¡roy
(
»q
->
äagm’t
);„eq->äagm’ˆğ
NULL
;

221 
	`bde¡roy
(
»q
->
ho¡_Çme
);„eq->ho¡_Çmğ
NULL
;

224 
»q
->
·‰”n
 = 
NULL
;

225 
»q
->
´efix
 = 
NULL
;

226 
»q
->
ho¡
 = 
NULL
;

228 
»q
->
¡©us_code
 = 0;

229 
»q
->
»¥Ú£_size
 = 0;

230 
»q
->
·r£r
.
jsÚ_£Á
 = 0;

231 
»q
->
·r£r
.
xml_£Á
 = 0;

232 
	}
}

234 
	$Reque¡_de¡roy
(
Reque¡
 *
»q
)

236 if(
»q
) {

237 
	`Reque¡_nuke_·¹s
(
»q
);

238 
	`hash_ä“_nodes
(
»q
->
h—d”s
);

239 
	`hash_de¡roy
(
»q
->
h—d”s
);

240 
	`ä“
(
»q
);

242 
	}
}

245 
	$Reque¡_¡¬t
(
Reque¡
 *
»q
)

247 
	`as£¹
(
»q
 && "NULL…ointerƒrror.");

248 
	`h‰p_·r£r_š™
(&(
»q
->
·r£r
));

250 
	`Reque¡_nuke_·¹s
(
»q
);

252 if(
»q
->
h—d”s
) {

253 
	`hash_ä“_nodes
(
»q
->
h—d”s
);

255 
	}
}

257 
	$Reque¡_·r£
(
Reque¡
 *
»q
, *
buf
, 
size_t
 
Ä—d
, size_ˆ*
out_Å¬£d
)

259 
	`as£¹
(
»q
 && "NULL…ointerƒrror.");

261 *
out_Å¬£d
 = 
	`h‰p_·r£r_execu‹
(&(
»q
->
·r£r
), 
buf
, 
Ä—d
, *out_nparsed);

263 
fšished
 = 
	`h‰p_·r£r_fšish
(&(
»q
->
·r£r
));

265  
fšished
;

266 
	}
}

269 
b¡ršg
 
	$Reque¡_g‘
(
Reque¡
 *
»q
, 
b¡ršg
 
f›ld
)

271 
hnode_t
 *
node
 = 
	`hash_lookup
(
»q
->
h—d”s
, 
f›ld
);

272 
b¡rLi¡
 *
v®s
 = 
NULL
;

274 if(
node
 =ğ
NULL
) {

275  
NULL
;

277 
v®s
 = 
	`hnode_g‘
(
node
);

278  
v®s
->
’Œy
[0];

280 
	}
}

283 
	$Reque¡_g‘_d©e
(
Reque¡
 *
»q
, 
b¡ršg
 
f›ld
, cÚ¡ *
fÜm©
)

285 
tm
 
tm_v®
;

286 
b¡ršg
 
v®ue
 = 
	`Reque¡_g‘
(
»q
, 
f›ld
);

288 if(
v®ue
) {

289 
	`mem£t
(&
tm_v®
, 0, (
tm
));

290 if(
	`¡½time
(
	`bd©a
(
v®ue
), 
fÜm©
, &
tm_v®
è=ğ
NULL
) {

293  ()
	`mktime
(&
tm_v®
);

298 
	}
}

300 
šlše
 
b¡ršg
 
	$jsÚ_esÿ³
(
b¡ršg
 
š
)

302 if(
š
 =ğ
NULL
)  NULL;

305 
b¡ršg
 
v¡r
 = 
	`b¡rıy
(
š
);

307 
i
;

308 
i
 = 0; i < 
	`bËngth
(
v¡r
); i++)

310 if(
	`bd©a
(
v¡r
)[
i
] == '\\')

312 
	`bš£¹ch
(
v¡r
, 
i
, 1, '\\');

313 
i
++;

315 if(
	`bd©a
(
v¡r
)[
i
] == '"')

317 
	`bš£¹ch
(
v¡r
, 
i
, 1, '\\');

318 
i
++;

322  
v¡r
;

323 
	}
}

325 
gb¡ršg
 
	gJSON_LISTSEP
 = 
bsStic
("\",\"");

326 
gb¡ršg
 
	gJSON_OBJSEP
 = 
bsStic
("\":\"");

329 cÚ¡ 
	gPAYLOAD_GUESS
 = 256;

331 
šlše
 
	$B
(
b¡ršg
 
h—d”s
, cÚ¡ b¡ršg 
k
, cÚ¡ b¡ršg 
v
)

333 if(
v
)

335 
	`bÿtc¡r
(
h—d”s
, ",\"");

336 
	`bcÚÿt
(
h—d”s
, 
k
);

337 
	`bcÚÿt
(
h—d”s
, &
JSON_OBJSEP
);

339 
b¡ršg
 
v¡r
 = 
	`jsÚ_esÿ³
(
v
);

340 
	`bcÚÿt
(
h—d”s
, 
v¡r
);

341 
	`bÿtc¡r
(
h—d”s
, "\"");

343 
	`bde¡roy
(
v¡r
);

345 
	}
}

347 
šlše
 
b¡ršg
 
	$»que¡_d‘”mše_m‘hod
(
Reque¡
 *
»q
)

349 if(
	`Reque¡_is_jsÚ
(
»q
)) {

350  &
JSON_METHOD
;

351 } if(
	`Reque¡_is_xml
(
»q
)) {

352  &
XML_METHOD
;

354  
»q
->
»que¡_m‘hod
;

356 
	}
}

358 
b¡ršg
 
	$Reque¡_to_Š‘¡ršg
(
Reque¡
 *
»q
, 
b¡ršg
 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
)

360 
Šs_outbuf
 
outbuf
 = {.
bufãr
 = 
NULL
};

361 
b¡ršg
 
m‘hod
 = 
	`»que¡_d‘”mše_m‘hod
(
»q
);

362 
	`check
(
m‘hod
, "Impossible, got‡n invalid„equest method.");

364 
id
 = 
	`Regi¡”_id_fÜ_fd
(
fd
);

365 
	`check
(
id
 !ğ-1, "AskedØg’”©¨·ylßd fÜ‡ fdh© dÛ¢'ˆexi¡: %d", 
fd
);

367 
h—d”_¡¬t
 = 
	`Šs_»nd”_»que¡_¡¬t
(&
outbuf
);

368 
	`check
(
h—d”_¡¬t
 != -1, "Failedo initialize outbuf.");

370 
	`check
(
	`Šs_»nd”_»que¡_h—d”s
(&
outbuf
, 
»q
->
h—d”s
) == 0,

373 if(
»q
->
·th
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_PATH
,„eq->path);

374 if(
»q
->
v”siÚ
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_VERSION
,„eq->version);

375 if(
»q
->
uri
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_URI
,„eq->uri);

376 if(
»q
->
qu”y_¡ršg
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_QUERY
,„eq->query_string);

377 if(
»q
->
äagm’t
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_FRAGMENT
,„eq->fragment);

378 if(
»q
->
·‰”n
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_PATTERN
,„eq->pattern);

380 
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_METHOD
, 
m‘hod
);

382 
	`check
(
	`Šs_»nd”_»que¡_’d
(&
outbuf
, 
h—d”_¡¬t
, 
uuid
, 
id
, 
	`Reque¡_·th
(
»q
)) != -1, "Failedo finalize„equest.");

385 
b¡ršg
 
h—d”s
 = 
	`Šs_outbuf_to_b¡ršg
(&
outbuf
);

386 
	`bfÜm©a
(
h—d”s
, "%d:", 
Ën
);

387 
	`bÿtblk
(
h—d”s
, 
buf
, 
Ën
);

388 
	`bcÚch¬
(
h—d”s
, ',');

390  
h—d”s
;

391 
”rÜ
:

392 if(
outbuf
.
bufãr
è
	`ä“
(outbuf.buffer);

393  
NULL
;

394 
	}
}

396 
b¡ršg
 
	$Reque¡_to_·ylßd
(
Reque¡
 *
»q
, 
b¡ršg
 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
)

398 
b¡ršg
 
h—d”s
 = 
NULL
;

399 
b¡ršg
 
»suÉ
 = 
NULL
;

401 
id
 = 
	`Regi¡”_id_fÜ_fd
(
fd
);

402 
	`check
(
id
 !ğ-1, "AskedØg’”©¨·ylßd fÜ‡ fdh© dÛ¢'ˆexi¡: %d", 
fd
);

404 
h—d”s
 = 
	`bäomc¡¿Îoc
(
PAYLOAD_GUESS
, "{\"");

405 
	`bcÚÿt
(
h—d”s
, &
HTTP_PATH
);

406 
	`bcÚÿt
(
h—d”s
, &
JSON_OBJSEP
);

407 
	`bcÚÿt
(
h—d”s
, 
»q
->
·th
);

408 
	`bcÚch¬
(
h—d”s
, '"');

410 
hsÿn_t
 
sÿn
;

411 
hnode_t
 *
i
;

412 
	`hash_sÿn_begš
(&
sÿn
, 
»q
->
h—d”s
);

413 
i
 = 
	`hash_sÿn_Ãxt
(&
sÿn
); i !ğ
NULL
; i = hash_scan_next(&scan))

415 
b¡rLi¡
 *
v®_li¡
 = 
	`hnode_g‘
(
i
);

416 
b¡ršg
 
key
 = (b¡ršg)
	`hnode_g‘key
(
i
);

418 if(
v®_li¡
->
qty
 > 1)

420 
b¡rLi¡
 *
esÿ³d
 = 
	`b¡rLi¡C»©e
();

421 
	`b¡rLi¡AÎoc
(
esÿ³d
, 
v®_li¡
->
qty
);

422 
esÿ³d
->
qty
 = 
v®_li¡
->qty;

424 
x
 = 0;

425 
x
 = 0; x < 
v®_li¡
->
qty
; x++) {

426 
esÿ³d
->
’Œy
[
x
] = 
	`jsÚ_esÿ³
(
v®_li¡
->entry[x]);

429 
b¡ršg
 
li¡
 = 
	`bjoš
(
esÿ³d
, &
JSON_LISTSEP
);

430 
	`bÿtc¡r
(
h—d”s
, ",\"");

431 
	`bcÚÿt
(
h—d”s
, 
key
);

432 
	`bÿtc¡r
(
h—d”s
, "\":[\"");

433 
	`bcÚÿt
(
h—d”s
, 
li¡
);

434 
	`bÿtc¡r
(
h—d”s
, "\"]");

435 
	`bde¡roy
(
li¡
);

436 
	`b¡rLi¡De¡roy
(
esÿ³d
);

440 
	`B
(
h—d”s
, 
key
, 
v®_li¡
->
’Œy
[0]);

447 if(
	`Reque¡_is_jsÚ
(
»q
)) {

448 
	`B
(
h—d”s
, &
HTTP_METHOD
, &
JSON_METHOD
);

449 } if(
	`Reque¡_is_xml
(
»q
)) {

450 
	`B
(
h—d”s
, &
HTTP_METHOD
, &
XML_METHOD
);

452 
	`B
(
h—d”s
, &
HTTP_METHOD
, 
»q
->
»que¡_m‘hod
);

455 
	`B
(
h—d”s
, &
HTTP_VERSION
, 
»q
->
v”siÚ
);

456 
	`B
(
h—d”s
, &
HTTP_URI
, 
»q
->
uri
);

457 
	`B
(
h—d”s
, &
HTTP_QUERY
, 
»q
->
qu”y_¡ršg
);

458 
	`B
(
h—d”s
, &
HTTP_FRAGMENT
, 
»q
->
äagm’t
);

459 
	`B
(
h—d”s
, &
HTTP_PATTERN
, 
»q
->
·‰”n
);

461 
	`bcÚch¬
(
h—d”s
, '}');

463 
»suÉ
 = 
	`bfÜm©
("% %d % %d:%s,%d:", 
	`bd©a
(
uuid
), 
id
,

464 
	`bd©a
(
	`Reque¡_·th
(
»q
)),

465 
	`bËngth
(
h—d”s
),

466 
	`bd©a
(
h—d”s
),

467 
Ën
);

469 
	`bde¡roy
(
h—d”s
);

471 
	`bÿtblk
(
»suÉ
, 
buf
, 
Ën
);

472 
	`bcÚch¬
(
»suÉ
, ',');

474 
	`check
(
»suÉ
, "Failedo construct…ayload„esult.");

476  
»suÉ
;

478 
”rÜ
:

479 
	`bde¡roy
(
h—d”s
);

480 
	`bde¡roy
(
»suÉ
);

482  
NULL
;

483 
	}
}

	@src/request.h

35 #iâdeà
_»que¡_h


36 
	#_»que¡_h


	)

38 
	~<h‰p11/h‰p11_·r£r.h
>

39 
	~<adt/hash.h
>

40 
	~<b¡ršg.h
>

41 
	~<hªdËr.h
>

42 
	~<h—d”s.h
>

43 
	~<ho¡.h
>

46 
	mREQUEST_EXTRA_HEADERS
 = 6

49 
	sReque¡
 {

50 
b¡ršg
 
	m»que¡_m‘hod
;

51 
b¡ršg
 
	mv”siÚ
;

52 
b¡ršg
 
	muri
;

53 
b¡ršg
 
	m·th
;

54 
b¡ršg
 
	mqu”y_¡ršg
;

55 
b¡ršg
 
	mäagm’t
;

56 
b¡ršg
 
	mho¡
;

57 
b¡ršg
 
	mho¡_Çme
;

58 
b¡ršg
 
	m·‰”n
;

59 
b¡ršg
 
	m´efix
;

60 
Ho¡
 *
	mrg‘_ho¡
;

61 
hash_t
 *
	mh—d”s
;

62 
Back’d
 *
	maùiÚ
;

63 
	m¡©us_code
;

64 
	m»¥Ú£_size
;

65 
h‰p_·r£r
 
	m·r£r
;

66 } 
	tReque¡
;

68 
Reque¡
 *
Reque¡_ü—‹
();

70 
Reque¡_·r£
(
Reque¡
 *
»q
, *
buf
, 
size_t
 
Ä—d
, size_ˆ*
out_Å¬£d
);

72 
Reque¡_¡¬t
(
Reque¡
 *
»q
);

74 
Reque¡_de¡roy
(
Reque¡
 *
»q
);

76 
b¡ršg
 
Reque¡_g‘
(
Reque¡
 *
»q
, b¡ršg 
f›ld
);

78 
Reque¡_£t
(
Reque¡
 *
»q
, 
b¡ršg
 
key
, b¡ršg 
v®
, 
»¶aû
);

80 
Reque¡_g‘_d©e
(
Reque¡
 *
»q
, 
b¡ršg
 
f›ld
, cÚ¡ *
fÜm©
);

82 
	#Reque¡_·r£r
(
R
è(&((R)->
·r£r
))

	)

84 
	#Reque¡_is_jsÚ
(
R
è((R)->
·r£r
.
jsÚ_£Á
 =ğ1)

	)

86 
	#Reque¡_is_xml
(
R
è((R)->
·r£r
.
xml_£Á
 =ğ1)

	)

88 
	#Reque¡_is_h‰p
(
R
è(!(
	`Reque¡_is_jsÚ
(Rè|| 
	`Reque¡_is_xml
(R)))

	)

90 
	#Reque¡_g‘_aùiÚ
(
R
, 
T
è((R)->
aùiÚ
 ? (R)->aùiÚ->
rg‘
.T : 
NULL
)

	)

92 
	#Reque¡_£t_aùiÚ
(
R
, 
V
è((R)->
aùiÚ
 = (V))

	)

94 
	#Reque¡_·th
(
R
è((R)->
·th
)

	)

96 
	#Reque¡_cÚ‹Á_Ëngth
(
R
è((R)->
·r£r
.
cÚ‹Á_Ën
)

	)

98 
	#Reque¡_h—d”_Ëngth
(
R
è((R)->
·r£r
.
body_¡¬t
)

	)

100 
b¡ršg
 
Reque¡_to_Š‘¡ršg
(
Reque¡
 *
»q
, b¡ršg 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
);

102 
b¡ršg
 
Reque¡_to_·ylßd
(
Reque¡
 *
»q
, b¡ršg 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
);

104 
Reque¡_š™
();

	@src/response.c

36 
	~<»¥Ú£.h
>

37 
	~<sk/sk.h
>

38 
	~<dbg.h
>

39 
	~<as£¹.h
>

40 
	~"v”siÚ.h
"

45 
gb¡ršg
 
	gHTTP_400
 = 
bsStic
("HTTP/1.1 400 Bad Request\r\n"

49 "S”v”: " 
VERSION


53 
gb¡ršg
 
	gHTTP_404
 = 
bsStic
("HTTP/1.1 404 Not Found\r\n"

57 "S”v”: " 
VERSION


62 
gb¡ršg
 
	gHTTP_413
 = 
bsStic
("HTTP/1.1 413 Request Entity Too Large\r\n"

66 "S”v”: " 
VERSION


70 
gb¡ršg
 
	gHTTP_501
 = 
bsStic
("HTTP/1.1 501 Not Implemented\r\n"

74 "S”v”: " 
VERSION


78 
gb¡ršg
 
	gHTTP_502
 = 
bsStic
("HTTP/1.1 502 Bad Gateway\r\n"

82 "S”v”: " 
VERSION


86 
gb¡ršg
 
	gHTTP_500
 = 
bsStic
("HTTP/1.1 500 Internal Server Error\r\n"

90 "S”v”: " 
VERSION


94 
gb¡ršg
 
	gHTTP_405
 = 
bsStic
("HTTP/1.1 405 Method Not Allowed\r\n"

98 "S”v”: " 
VERSION


103 
gb¡ršg
 
	gHTTP_412
 = 
bsStic
("HTTP/1.1 412 Precondition Failed\r\n"

107 "S”v”: " 
VERSION


112 
gb¡ršg
 
	gHTTP_304
 = 
bsStic
("HTTP/1.1 304 Not Modified\r\n"

115 "S”v”: " 
VERSION


119 
gb¡ršg
 
	gFLASH_RESPONSE
 = 
bsStic
("<?xml version=\"1.0\"?>"

124 
	$Re¥Ú£_£nd_¡©us
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
”rÜ
)

126  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
”rÜ
), 
	`bËngth
(error));

127 
	}
}

130 
	$Re¥Ú£_£nd_sock‘_pŞicy
(
CÚÃùiÚ
 *
cÚn
)

133  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(&
FLASH_RESPONSE
),

134 
	`bËngth
(&
FLASH_RESPONSE
) + 1);

136 
	}
}

	@src/response.h

35 #iâdeà
_»¥Ú£_h


36 
	#_»¥Ú£_h


	)

38 
	~<b¡ršg.h
>

39 
	~<cÚÃùiÚ.h
>

41 
gb¡ršg
 
HTTP_304
;

42 
gb¡ršg
 
HTTP_400
;

43 
gb¡ršg
 
HTTP_404
;

44 
gb¡ršg
 
HTTP_405
;

45 
gb¡ršg
 
HTTP_412
;

46 
gb¡ršg
 
HTTP_413
;

47 
gb¡ršg
 
HTTP_500
;

48 
gb¡ršg
 
HTTP_501
;

49 
gb¡ršg
 
HTTP_502
;

51 
gb¡ršg
 
FLASH_RESPONSE
;

53 
Re¥Ú£_£nd_¡©us
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
”rÜ
);

55 
Re¥Ú£_£nd_sock‘_pŞicy
(
CÚÃùiÚ
 *
cÚn
);

	@src/routing.c

35 
	~<routšg.h
>

36 
	~<dbg.h
>

37 
	~<¡ršg.h
>

38 
	~<as£¹.h
>

39 
	~<·‰”n.h
>

40 
	~<ho¡.h
>

41 
	~<mem/h®loc.h
>

42 
	~<b¡ršg.h
>

46 
Rou‹M­
 *
	$Rou‹M­_ü—‹
(
rou‹m­_de¡roy_cb
 
de¡roy
)

48 
Rou‹M­
 *
m­
 = 
	`h_ÿÎoc
((RouteMap), 1);

49 
	`check_mem
(
m­
);

51 
m­
->
de¡roy
 = destroy;

53  
m­
;

55 
”rÜ
:

56  
NULL
;

57 
	}
}

59 
	$Rou‹M­_ş—nup
(*
v®ue
, *
d©a
)

61 
Rou‹
 *
rou‹
 = (Rou‹ *)
v®ue
;

62 
Rou‹M­
 *
m­
 = (Rou‹M­ *)
d©a
;

64 if(
m­
->
de¡roy
) {

65 
m­
->
	`de¡roy
(
rou‹
, map);

68 
	`bde¡roy
(
rou‹
->
·‰”n
);

69 
	`bde¡roy
(
rou‹
->
´efix
);

70 
	}
}

72 
	$Rou‹M­_de¡roy
(
Rou‹M­
 *
m­
)

74 if(
m­
) {

75 
	`t¡_Œav”£
(
m­
->
rou‹s
, 
Rou‹M­_ş—nup
, map);

76 
	`t¡_de¡roy
(
m­
->
rou‹s
);

77 
	`h_ä“
(
m­
);

79 
	}
}

81 
Rou‹
 *
	$Rou‹M­_š£¹_ba£
(
Rou‹M­
 *
m­
, 
b¡ršg
 
´efix
, b¡ršg 
·‰”n
)

83 
Rou‹
 *
rou‹
 = 
	`h_m®loc
((Route));

84 
	`check_mem
(
rou‹
);

86 
rou‹
->
·‰”n
 =…attern;

87 
	`check
(
rou‹
->
·‰”n
, "Pattern is„equired.");

89 
rou‹
->
´efix
 =…refix;

90 
	`check
(
rou‹
->
´efix
, "Prefix is„equired.");

92 
	`debug
("ADDING…»fix: %s,…©‹º: %s", 
	`bd©a
(
´efix
), bd©a(
·‰”n
));

94 
m­
->
rou‹s
 = 
	`t¡_š£¹
(m­->rou‹s, 
	`bd©a
(
´efix
), 
	`bËngth
Õ»fix), 
rou‹
);

96 
	`h©ch
(
rou‹
, 
m­
);

98 
	`check
(
m­
->
rou‹s
, "Failedo insert into TST.");

100  
rou‹
;

102 
”rÜ
:

103  
NULL
;

104 
	}
}

106 
	$Rou‹M­_š£¹
(
Rou‹M­
 *
m­
, 
b¡ršg
 
·‰”n
, *
d©a
)

108 
Rou‹
 *
rou‹
 = 
NULL
;

109 
fœ¡_·»n
 = 
	`b¡rchr
(
·‰”n
, '(');

110 
b¡ršg
 
´efix
 = 
NULL
;

112 if(
fœ¡_·»n
 >= 0) {

113 
´efix
 = 
	`bH—d
(
·‰”n
, 
fœ¡_·»n
);

115 
´efix
 = 
	`b¡rıy
(
·‰”n
);

118 
	`check_mem
(
´efix
);

121 
rou‹
 = 
	`Rou‹M­_š£¹_ba£
(
m­
, 
´efix
, 
·‰”n
);

122 
	`check
(
rou‹
, "FaedØš£¹„ou‹: %s", 
	`bd©a
(
·‰”n
));

125 
rou‹
->
has_·‰”n
 = 
fœ¡_·»n
 >= 0;

126 
rou‹
->
fœ¡_·»n
 = first_paren;

127 
rou‹
->
d©a
 = data;

131 
”rÜ
:

133 
	}
}

135 
	$Rou‹M­_š£¹_»v”£d
(
Rou‹M­
 *
m­
, 
b¡ršg
 
·‰”n
, *
d©a
)

137 
Rou‹
 *
rou‹
 = 
NULL
;

138 
b¡ršg
 
»v”£d_´efix
 = 
NULL
;

140 
Ï¡_·»n
 = 
	`b¡¼chr
(
·‰”n
, ')');

142 if(
Ï¡_·»n
 >= 0) {

143 
»v”£d_´efix
 = 
	`bTa
(
·‰”n
, 
	`bËngth
Õ©‹ºè- 
Ï¡_·»n
 - 1);

145 
»v”£d_´efix
 = 
	`b¡rıy
(
·‰”n
);

148 
	`check_mem
(
»v”£d_´efix
);

149 
	`bRev”£
(
»v”£d_´efix
);

152 
rou‹
 = 
	`Rou‹M­_š£¹_ba£
(
m­
, 
»v”£d_´efix
, 
·‰”n
);

153 
	`check
(
rou‹
, "Failedo‡dd host.");

155 
rou‹
->
has_·‰”n
 = 
Ï¡_·»n
 >= 0;

156 
rou‹
->
´efix
 = 
»v”£d_´efix
;

157 
rou‹
->
d©a
 = data;

161 
”rÜ
:

163 
	}
}

166 
	$Rou‹M­_cŞËù_m©ch
(*
v®ue
, cÚ¡ *
key
, 
size_t
 
Ën
)

168 
	`as£¹
(
v®ue
 && "NULL value from TST.");

169 
Rou‹
 *
rou‹
 = (Rou‹ *)
v®ue
;

171 if(
rou‹
->
has_·‰”n
) {

172  
	`·‰”n_m©ch
(
key
 + 
rou‹
->
fœ¡_·»n
,

173 
Ën
 - 
rou‹
->
fœ¡_·»n
,

174 
	`bd©aofs
(
rou‹
->
·‰”n
,„ou‹->
fœ¡_·»n
)è!ğ
NULL
;

178 
	}
}

180 
li¡_t
 *
	$Rou‹M­_m©ch
(
Rou‹M­
 *
m­
, 
b¡ršg
 
·th
)

182  
	`t¡_cŞËù
(
m­
->
rou‹s
, 
	`bd©a
(
·th
),

183 
	`bËngth
(
·th
), 
Rou‹M­_cŞËù_m©ch
);

184 
	}
}

186 
šlše
 
Rou‹
 *
	$m©ch_rou‹_·‰”n
(
b¡ršg
 
rg‘
, 
Rou‹
 *
rou‹
)

188 cÚ¡ *
sourû
 = 
	`bd©aofs
(
rg‘
, 
	`bËngth
(
rou‹
->
´efix
));

189 
sourû_Ëngth
 = 
	`bËngth
(
rg‘
è- bËngth(
rou‹
->
´efix
);

190 cÚ¡ *
·‰”n
 = 
	`bd©aofs
(
rou‹
->·‰”n,„ou‹->
fœ¡_·»n
);

192  
	`·‰”n_m©ch
(
sourû
, 
sourû_Ëngth
, 
·‰”n
è? 
rou‹
 : 
NULL
;

193 
	}
}

195 
Rou‹
 *
	$Rou‹M­_m©ch_suffix
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
)

197 
Rou‹
 *
rou‹
 = 
	`t¡_£¬ch_suffix
(
m­
->
rou‹s
, 
	`bd©a
(
rg‘
), 
	`bËngth
(target));

199 if(
rou‹
) {

200 
	`debug
("Found sim¶suffix: %s", 
	`bd©a
(
rou‹
->
·‰”n
));

202 if(
rou‹
->
has_·‰”n
) {

203  
	`m©ch_rou‹_·‰”n
(
rg‘
, 
rou‹
);

205  
rou‹
;

208  
NULL
;

210 
	}
}

213 
Rou‹
 *
	$Rou‹M­_sim¶e_´efix_m©ch
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
)

215 
	`debug
("S—rchšg fÜ„ou‹: % š m­: %p", 
	`bd©a
(
rg‘
), 
m­
);

216 
Rou‹
 *
rou‹
 = 
	`t¡_£¬ch_´efix
(
m­
->
rou‹s
, 
	`bd©a
(
rg‘
), 
	`bËngth
(target));

218 if(
rou‹
) {

219 
	`debug
("Found sim¶´efix: %s", 
	`bd©a
(
rou‹
->
·‰”n
));

221 if(
rou‹
->
has_·‰”n
) {

222  
	`m©ch_rou‹_·‰”n
(
rg‘
, 
rou‹
);

224  
rou‹
;

227  
NULL
;

229 
	}
}

	@src/routing.h

35 #iâdeà
_routšg_h


36 
	#_routšg_h


	)

38 
	~<adt/t¡.h
>

39 
	~<¡dlib.h
>

40 
	~<adt/li¡.h
>

41 
	~<b¡ršg.h
>

43 
	sRou‹
 {

44 
b¡ršg
 
	m·‰”n
;

45 
b¡ršg
 
	m´efix
;

46 *
	md©a
;

47 
	mhas_·‰”n
;

48 
	mfœ¡_·»n
;

49 } 
	tRou‹
;

51 
	gRou‹M­
;

53 (*
	trou‹m­_de¡roy_cb
)(
	tRou‹
 *
	trou‹
, 
	tRou‹M­
 *
	tm­
);

55 
	sRou‹M­
 {

56 
t¡_t
 *
rou‹s
;

57 
rou‹m­_de¡roy_cb
 
de¡roy
;

58 } 
	tRou‹M­
;

60 
Rou‹M­
 *
	`Rou‹M­_ü—‹
(
rou‹m­_de¡roy_cb
 
de¡roy
);

62 
	`Rou‹M­_de¡roy
(
Rou‹M­
 *
m­
);

64 
	`Rou‹M­_š£¹
(
Rou‹M­
 *
rou‹s
, 
b¡ršg
 
·‰”n
, *
d©a
);

66 
li¡_t
 *
	`Rou‹M­_m©ch
(
Rou‹M­
 *
rou‹s
, 
b¡ršg
 
·th
);

68 
	`Rou‹M­_š£¹_»v”£d
(
Rou‹M­
 *
rou‹s
, 
b¡ršg
 
·‰”n
, *
d©a
);

70 
Rou‹
 *
	`Rou‹M­_m©ch_suffix
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
);

72 
Rou‹
 *
	`Rou‹M­_sim¶e_´efix_m©ch
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
);

	@src/server.c

35 
	~"dbg.h
"

36 
	~"sk/sk.h
"

37 
	~"cÚÃùiÚ.h
"

38 
	~"»gi¡”.h
"

39 
	~"£rv”.h
"

40 
	~"ho¡.h
"

41 
	~<as£¹.h
>

42 
	~<¡ršg.h
>

43 
	~"mem/h®loc.h
"

44 
	~"routšg.h
"

45 
	~"£‰šg.h
"

46 
	~"·‰”n.h
"

47 
	~"cÚfig/cÚfig.h
"

48 
	~<sigÇl.h
>

50 
	gRUNNING
=1;

52 *
	gs¦_deçuÉ_dhm_P
 =

62 *
	gs¦_deçuÉ_dhm_G
 = "4";

64 
	$ho¡_de¡roy_cb
(
Rou‹
 *
r
, 
Rou‹M­
 *
m­
)

66 if(
r
->
d©a
) {

67 
	`Ho¡_de¡roy
((
Ho¡
 *)
r
->
d©a
);

68 
r
->
d©a
 = 
NULL
;

70 
	}
}

72 
	$S”v”_lßd_ch”s
(
S”v”
 *
¤v
, 
b¡ršg
 
s¦_ch”s_v®
)

74 
b¡rLi¡
 *
s¦_ch”_li¡
 = 
	`b¥l™
(
s¦_ch”s_v®
, ' ');

75 
i
 = 0;

76 
max_num_ch”s
 = 0;

77 *
ch”s
 = 
NULL
;

79 
	`check
(
s¦_ch”_li¡
 !ğ
NULL
 && s¦_ch”_li¡->
qty
 > 0,

83 
s¦_deçuÉ_ch”s
[
max_num_ch”s
] != 0) {

84 
max_num_ch”s
++;

87 
ch”s
 = 
	`h_ÿÎoc
(
max_num_ch”s
 + 1, ());

88 
	`check_mem
(
ch”s
);

90 
i
 = 0; i < 
s¦_ch”_li¡
->
qty
; i++) {

91 
b¡ršg
 
ch”
 = 
s¦_ch”_li¡
->
’Œy
[
i
];

93 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_RC4_128_MD5"))

94 
ch”s
[
i
] = 
SSL_RSA_RC4_128_MD5
;

95 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_RC4_128_SHA"))

96 
ch”s
[
i
] = 
SSL_RSA_RC4_128_SHA
;

97 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_DES_168_SHA"))

98 
ch”s
[
i
] = 
SSL_RSA_DES_168_SHA
;

99 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_DES_168_SHA"))

100 
ch”s
[
i
] = 
SSL_EDH_RSA_DES_168_SHA
;

101 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_AES_128_SHA"))

102 
ch”s
[
i
] = 
SSL_RSA_AES_128_SHA
;

103 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_AES_128_SHA"))

104 
ch”s
[
i
] = 
SSL_EDH_RSA_AES_128_SHA
;

105 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_AES_256_SHA"))

106 
ch”s
[
i
] = 
SSL_RSA_AES_256_SHA
;

107 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_AES_256_SHA"))

108 
ch”s
[
i
] = 
SSL_EDH_RSA_AES_256_SHA
;

109 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_CAMELLIA_128_SHA"))

110 
ch”s
[
i
] = 
SSL_RSA_CAMELLIA_128_SHA
;

111 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_CAMELLIA_128_SHA"))

112 
ch”s
[
i
] = 
SSL_EDH_RSA_CAMELLIA_128_SHA
;

113 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_CAMELLIA_256_SHA"))

114 
ch”s
[
i
] = 
SSL_RSA_CAMELLIA_256_SHA
;

115 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_CAMELLIA_256_SHA"))

116 
ch”s
[
i
] = 
SSL_EDH_RSA_CAMELLIA_256_SHA
;

118 
	`£Áš–
("UÄecognized ch”: %s", 
	`bd©a
(
ch”
));

121 
	`b¡rLi¡De¡roy
(
s¦_ch”_li¡
);

122 
ch”s
[
i
] = 0;

123 
¤v
->
ch”s
 = ciphers;

124 
	`h©ch
(
ch”s
, 
¤v
);

127 
”rÜ
:

128 if(
s¦_ch”_li¡
è
	`b¡rLi¡De¡roy
(ssl_cipher_list);

129 if(
ch”s
 !ğ
NULL
è
	`h_ä“
(ciphers);

131 
	}
}

134 
	$S”v”_š™_s¦
(
S”v”
 *
¤v
)

136 
rc
 = 0;

137 
b¡ršg
 
û¹·th
 = 
NULL
;

138 
b¡ršg
 
key·th
 = 
NULL
;

140 
b¡ršg
 
û¹dœ
 = 
	`S‘tšg_g‘_¡r
("û¹dœ", 
NULL
);

141 
	`check
(
û¹dœ
 !ğ
NULL
, "to use ssl, you must specify‡ certdir");

143 
û¹·th
 = 
	`bfÜm©
("%s%s.üt", 
	`bd©a
(
û¹dœ
), bd©a(
¤v
->
uuid
));

144 
	`check_mem
(
û¹·th
);

146 
key·th
 = 
	`bfÜm©
("%s%s.key", 
	`bd©a
(
û¹dœ
), bd©a(
¤v
->
uuid
));

147 
	`check_mem
(
key·th
);

149 
rc
 = 
	`x509·r£_ütfe
(&
¤v
->
own_û¹
, 
	`bd©a
(
û¹·th
));

150 
	`check
(
rc
 =ğ0, "FaedØlßd c”ˆäom %s", 
	`bd©a
(
û¹·th
));

152 
rc
 = 
	`x509·r£_keyfe
(&
¤v
->
r§_key
, 
	`bd©a
(
key·th
), 
NULL
);

153 
	`check
(
rc
 =ğ0, "FaedØlßd key from %s", 
	`bd©a
(
key·th
));

155 
b¡ršg
 
s¦_ch”s_v®
 = 
	`S‘tšg_g‘_¡r
("s¦_ch”s", 
NULL
);

157 if(
s¦_ch”s_v®
 !ğ
NULL
) {

158 
rc
 = 
	`S”v”_lßd_ch”s
(
¤v
, 
s¦_ch”s_v®
);

159 
	`check
(
rc
 == 0, "Failedo†oad„equested SSL ciphers.");

161 
¤v
->
ch”s
 = 
s¦_deçuÉ_ch”s
;

164 
¤v
->
dhm_P
 = 
s¦_deçuÉ_dhm_P
;

165 
¤v
->
dhm_G
 = 
s¦_deçuÉ_dhm_G
;

167 
	`bde¡roy
(
û¹·th
);

168 
	`bde¡roy
(
key·th
);

172 
”rÜ
:

174 if(
û¹·th
 !ğ
NULL
è
	`bde¡roy
(certpath);

175 if(
key·th
 !ğ
NULL
è
	`bde¡roy
(keypath);

177 
	}
}

179 
S”v”
 *
	$S”v”_ü—‹
(
b¡ršg
 
uuid
, b¡ršg 
deçuÉ_ho¡
,

180 
b¡ršg
 
bšd_addr
, 
pÜt
, b¡ršg 
chroÙ
, b¡ršg 
acûss_log
,

181 
b¡ršg
 
”rÜ_log
, b¡ršg 
pid_fe
, 
u£_s¦
)

183 
S”v”
 *
¤v
 = 
NULL
;

184 
rc
 = 0;

186 
¤v
 = 
	`h_ÿÎoc
((
S”v”
), 1);

187 
	`check_mem
(
¤v
);

189 
¤v
->
ho¡s
 = 
	`Rou‹M­_ü—‹
(
ho¡_de¡roy_cb
);

190 
	`check
(
¤v
->
ho¡s
 !ğ
NULL
, "Failedo create host RouteMap.");

192 
¤v
->
hªdËrs
 = 
	`d¬¿y_ü—‹
((
HªdËr
), 20);

193 
	`check_mem
(
¤v
->
hªdËrs
);

195 
	`check
(
pÜt
 > 0, "Invalid…ort given, must be > 0: %d",…ort);

196 
¤v
->
pÜt
 =…ort;

197 
¤v
->
li¡’_fd
 = 0;

199 
¤v
->
bšd_addr
 = 
	`b¡rıy
(bšd_addr); 
	`check_mem
(srv->bind_addr);

200 
¤v
->
uuid
 = 
	`b¡rıy
(uuid); 
	`check_mem
(srv->uuid);

201 
¤v
->
chroÙ
 = 
	`b¡rıy
(chroÙ); 
	`check_mem
(srv->chroot);

202 
¤v
->
acûss_log
 = 
	`b¡rıy
×cûss_log); 
	`check_mem
(srv->access_log);

203 
¤v
->
”rÜ_log
 = 
	`b¡rıy
Ó¼Ü_log); 
	`check_mem
(srv->error_log);

204 
¤v
->
pid_fe
 = 
	`b¡rıy
Õid_fe); 
	`check_mem
(srv->pid_file);

205 
¤v
->
deçuÉ_ho¡Çme
 = 
	`b¡rıy
(
deçuÉ_ho¡
);

206 
¤v
->
u£_s¦
 = use_ssl;

208 if(
¤v
->
u£_s¦
) {

209 
rc
 = 
	`S”v”_š™_s¦
(
¤v
);

210 
	`check
(
rc
 =ğ0, "FaedØš™Ÿlizs¦ fÜ s”v” %s", 
	`bd©a
(
uuid
));

213  
¤v
;

215 
”rÜ
:

216 
	`S”v”_de¡roy
(
¤v
);

217  
NULL
;

218 
	}
}

222 
	$S”v”_de¡roy
(
S”v”
 *
¤v
)

224 if(
¤v
) {

225 if(
¤v
->
u£_s¦
) {

226 
	`x509_ä“
(&
¤v
->
own_û¹
);

227 
	`r§_ä“
(&
¤v
->
r§_key
);

231 
	`Rou‹M­_de¡roy
(
¤v
->
ho¡s
);

233 if(
¤v
->
hªdËrs
è
	`h_ä“
(srv->handlers);

235 
	`bde¡roy
(
¤v
->
bšd_addr
);

236 
	`bde¡roy
(
¤v
->
uuid
);

237 
	`bde¡roy
(
¤v
->
chroÙ
);

238 
	`bde¡roy
(
¤v
->
acûss_log
);

239 
	`bde¡roy
(
¤v
->
”rÜ_log
);

240 
	`bde¡roy
(
¤v
->
pid_fe
);

241 
	`bde¡roy
(
¤v
->
deçuÉ_ho¡Çme
);

243 
	`fdşo£
(
¤v
->
li¡’_fd
);

244 
	`h_ä“
(
¤v
);

246 
	}
}

249 
	$S”v”_š™
()

251 
mq_th»ads
 = 
	`S‘tšg_g‘_št
("zeromq.threads", 1);

253 if(
mq_th»ads
 > 1) {

254 
	`log_šfo
("WARNING: Setting zeromq.threads greaterhan 1 can cause†ockups in your handlers.");

257 
	`log_šfo
("S¹šg 0MQ w™h %dh»ads.", 
mq_th»ads
);

258 
	`mqš™
(
mq_th»ads
);

259 
	`Regi¡”_š™
();

260 
	`Reque¡_š™
();

261 
	`CÚÃùiÚ_š™
();

262 
	}
}

265 
	$S”v”_¡¬t
(
S”v”
 *
¤v
)

267 
cfd
 = -1;

268 
½Üt
 = -1;

269 
»mÙe
[
IPADDR_SIZE
];

270 
	`skÇme
("SERVER");

272 
	`log_šfo
("S¹šg s”v” oÀpÜˆ%d", 
¤v
->
pÜt
);

274 
RUNNING
) {

275 
cfd
 = 
	`Ãcû±
(
¤v
->
li¡’_fd
, 
»mÙe
, &
½Üt
);

276 
acû±_good
 = 0;

278 if(
cfd
 >= 0) {

279 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
¤v
, 
cfd
, 
½Üt
, 
»mÙe
);

281 if(
	`CÚÃùiÚ_acû±
(
cÚn
) != 0) {

282 
	`log_”r
("Failedo„egister connection, overloaded.");

283 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

284 
acû±_good
 = 0;

286 
acû±_good
 = 1;

289 
acû±_good
 = 0;

292 if(!
acû±_good
) {

293 
ş—»d
 = 
	`Regi¡”_ş—nout
();

295 if(
ş—»d
 == 0) {

296 
	`skd–ay
(1000);

301 
	`debug
("SERVER EXITED w™hƒ¼Ü: % ªd„‘uº v®ue: %d", 
	`¡»¼Ü
(
”ºo
), 
cfd
);

304 
	}
}

308 
	$S”v”_add_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
)

310 
	`check
(
ho¡
->
m©chšg
 !ğ
NULL
, "Host's matching can't be NULL.");

311  
	`Rou‹M­_š£¹_»v”£d
(
¤v
->
ho¡s
, 
ho¡
->
m©chšg
, host);

313 
”rÜ
:

315 
	}
}

318 
	$S”v”_£t_deçuÉ_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
)

320 
¤v
->
deçuÉ_ho¡
 = 
ho¡
;

321 
	}
}

325 
Ho¡
 *
	$S”v”_m©ch_back’d
(
S”v”
 *
¤v
, 
b¡ršg
 
rg‘
)

327 
	`check
(
¤v
 !ğ
NULL
, "Server is NULL?!");

329 if(
¤v
->
deçuÉ_ho¡
) {

330 
	`check
(
¤v
->
deçuÉ_ho¡
->
m©chšg
 !ğ
NULL
, "Server has‡ default_host without matching.");

333 
	`debug
("Lookšg fÜ¬g‘ ho¡: %s", 
	`bd©a
(
rg‘
));

334 
Rou‹
 *
found
 = 
	`Rou‹M­_m©ch_suffix
(
¤v
->
ho¡s
, 
rg‘
);

336  
found
 !ğ
NULL
 ? found->
d©a
 : 
¤v
->
deçuÉ_ho¡
;

338 
”rÜ
:

339  
NULL
;

340 
	}
}

342 
šlše
 
	$§me_hªdËr
(
HªdËr
 *
äom
, HªdË¸*
to
)

344  
	`bi£q
(
äom
->
£nd_id’t
, 
to
->send_ident) &&

345 
	`bi£q
(
äom
->
»cv_id’t
, 
to
->recv_ident) &&

346 
	`bi£q
(
äom
->
»cv_¥ec
, 
to
->recv_spec) &&

347 
	`bi£q
(
äom
->
£nd_¥ec
, 
to
->send_spec);

348 
	}
}

350 
	sRou‹Upd©”
 {

351 
HªdËr
 *
	mÜigš®
;

352 
HªdËr
 *
	m»¶aûm’t
;

353 } 
	tRou‹Upd©”
;

355 
	$upd©e_rou‹s
(*
v®ue
, *
d©a
)

357 
Rou‹Upd©”
 *
upd©e
 = 
d©a
;

358 
Back’d
 *
back’d
 = ((
Rou‹
 *)
v®ue
)->
d©a
;

360 if(
back’d
->
ty³
 =ğ
BACKEND_HANDLER
 && back’d->
rg‘
.
hªdËr
 =ğ
upd©e
->
Üigš®
) {

361 
	`debug
("Found backendhat‚eeds„eplacing: %p„eplaced with %p",

362 
upd©e
->
Üigš®
, upd©e->
»¶aûm’t
);

363 
back’d
->
rg‘
.
hªdËr
 = 
upd©e
->
»¶aûm’t
;

365 
	}
}

367 
	$upd©e_ho¡_rou‹s
(*
v®ue
, *
d©a
)

369 
Ho¡
 *
ho¡
 = ((
Rou‹
 *)
v®ue
)->
d©a
;

370 
	`t¡_Œav”£
(
ho¡
->
rou‹s
->rou‹s, 
upd©e_rou‹s
, 
d©a
);

371 
	}
}

373 
šlše
 
	$S”v”_cİy_aùive_hªdËrs
(
S”v”
 *
¤v
, S”v” *
cİy_äom
)

375 
i
 = 0;

376 
i
 = 0; i < 
	`d¬¿y_’d
(
cİy_äom
->
hªdËrs
); i++) {

377 
HªdËr
 *
äom
 = 
	`d¬¿y_g‘
(
cİy_äom
->
hªdËrs
, 
i
);

379 
j
 = 0;

380 
j
 = 0; j < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); j++) {

381 
HªdËr
 *
to
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
j
);

383 if(
	`§me_hªdËr
(
äom
, 
to
))

385 
	`debug
("Sw­pšg %°Üigš® fÜ %°»¶aûm’t", 
to
, 
äom
);

386 
Rou‹Upd©”
 
upd©e
 = {.
Üigš®
 = 
to
, .
»¶aûm’t
 = 
äom
};

387 
	`t¡_Œav”£
(
¤v
->
ho¡s
->
rou‹s
, 
upd©e_ho¡_rou‹s
, &
upd©e
);

389 
	`d¬¿y_£t
(
¤v
->
hªdËrs
, 
j
, 
äom
);

391 
	`d¬¿y_£t
(
cİy_äom
->
hªdËrs
, 
i
, 
to
);

392 
to
->
ruÂšg
 = 0;

399 
	}
}

401 
	$S”v”_¡¬t_hªdËrs
(
S”v”
 *
¤v
, S”v” *
cİy_äom
)

403 
i
 = 0;

404 
rc
 = 0;

406 if(
cİy_äom
 !ğ
NULL
) {

407 
rc
 = 
	`S”v”_cİy_aùive_hªdËrs
(
¤v
, 
cİy_äom
);

408 
	`check
(
rc
 != -1, "Failedo copy old handlerso‚ew server config.");

411 
i
 = 0; i < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); i++) {

412 
HªdËr
 *
hªdËr
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
i
);

413 
	`check
(
hªdËr
 !ğ
NULL
, "Invalid handler, can't be NULL.");

415 if(!
hªdËr
->
ruÂšg
) {

416 
	`log_šfo
("LOADING HªdË¸%s", 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

417 
rc
 = 
	`skü—‹
(
HªdËr_sk
, 
hªdËr
, 
HANDLER_STACK
);

418 
	`check
(
rc
 != -1, "Failedo start handlerask.");

419 
hªdËr
->
ruÂšg
 = 1;

424 
”rÜ
:

426 
	}
}

429 
	$S”v”_¡İ_hªdËrs
(
S”v”
 *
¤v
)

431 
i
 = 0;

432 
i
 = 0; i < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); i++) {

433 
HªdËr
 *
hªdËr
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
i
);

434 
	`check
(
hªdËr
 !ğ
NULL
, "Invalid handler, can't be NULL.");

436 
	`debug
("############################### HANDLER SHUTDOWN: %p,„unning: %d,ask: %p",

437 
hªdËr
, hªdËr->
ruÂšg
, hªdËr->
sk
);

438 if(
hªdËr
->
ruÂšg
) {

439 
	`log_šfo
("STOPPING HANDLER %s", 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

440 if(
hªdËr
->
sk
 !ğ
NULL
) {

441 
	`sksigÇl
(
hªdËr
->
sk
, 
SIGINT
);

442 
hªdËr
->
ruÂšg
 = 0;

443 
	`skd–ay
(1);

447 if(
hªdËr
->
»cv_sock‘
è
	`zmq_şo£
(handler->recv_socket);

448 if(
hªdËr
->
£nd_sock‘
è
	`zmq_şo£
(handler->send_socket);

449 
hªdËr
->
»cv_sock‘
 = 
NULL
;

450 
hªdËr
->
£nd_sock‘
 = 
NULL
;

454 
”rÜ
:

456 
	}
}

	@src/server.h

35 #iâdeà
_£rv”_h


36 
	#_£rv”_h


	)

38 
	~"adt/t¡.h
"

39 
	~"adt/d¬¿y.h
"

40 
	~"ho¡.h
"

41 
	~"routšg.h
"

42 
	~"pŞ¬s¦/s¦.h
"

43 
	~"pŞ¬s¦/x509.h
"

44 
	~"pŞ¬s¦/r§.h
"

48 
	mIPADDR_SIZE
 = 40

51 
	sS”v”
 {

52 
	mpÜt
;

53 
	mli¡’_fd
;

54 
Ho¡
 *
	mdeçuÉ_ho¡
;

55 
Rou‹M­
 *
	mho¡s
;

56 
d¬¿y_t
 *
	mhªdËrs
;

57 
b¡ršg
 
	mbšd_addr
;

58 
b¡ršg
 
	muuid
;

59 
b¡ršg
 
	mchroÙ
;

60 
b¡ršg
 
	macûss_log
;

61 
b¡ršg
 
	m”rÜ_log
;

62 
b¡ršg
 
	mpid_fe
;

63 
b¡ršg
 
	mdeçuÉ_ho¡Çme
;

64 
	mu£_s¦
;

65 
x509_û¹
 
	mown_û¹
;

66 
r§_cÚ‹xt
 
	mr§_key
;

67 *
	mch”s
;

68 *
	mdhm_P
;

69 *
	mdhm_G
;

70 } 
	tS”v”
;

72 
S”v”
 *
S”v”_ü—‹
(
b¡ršg
 
uuid
, b¡ršg 
deçuÉ_ho¡
,

73 
b¡ršg
 
bšd_addr
, 
pÜt
, b¡ršg 
chroÙ
,

74 
b¡ršg
 
acûss_log
, b¡ršg 
”rÜ_log
, b¡ršg 
pid_fe
, 
u£_s¦
);

76 
S”v”_de¡roy
(
S”v”
 *
¤v
);

78 
S”v”_š™
();

80 
S”v”_¡¬t
(
S”v”
 *
¤v
);

82 
S”v”_add_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
);

84 
S”v”_£t_deçuÉ_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
);

86 
Ho¡
 *
S”v”_m©ch_back’d
(
S”v”
 *
¤v
, 
b¡ršg
 
rg‘
);

88 
S”v”_¡¬t_hªdËrs
(
S”v”
 *
¤v
, S”v” *
cİy_äom
);

90 
S”v”_¡İ_hªdËrs
(
S”v”
 *
¤v
);

	@src/setting.c

35 
	~<£‰šg.h
>

36 
	~<adt/t¡.h
>

37 
	~<dbg.h
>

39 
t¡_t
 *
	gSETTINGS_MAP
 = 
NULL
;

42 
	$S‘tšg_add
(cÚ¡ *
key
, cÚ¡ *
v®ue
)

44 
b¡ršg
 
key_¡r
 = 
	`bäomc¡r
(
key
);

45 
b¡ršg
 
v®ue_¡r
 = 
	`bäomc¡r
(
v®ue
);

47 
	`check
(!
	`t¡_£¬ch
(
SETTINGS_MAP
, 
	`bd©a
(
key_¡r
), 
	`bËngth
(
v®ue_¡r
)),

49 
key
, key, 
v®ue
);

51 
SETTINGS_MAP
 = 
	`t¡_š£¹
(SETTINGS_MAP, 
	`bd©a
(
key_¡r
),

52 
	`bËngth
(
key_¡r
), 
v®ue_¡r
);

54 
	`bde¡roy
(
key_¡r
);

57 
”rÜ
:

58 
	`bde¡roy
(
key_¡r
);

59 
	`bde¡roy
(
v®ue_¡r
);

61 
	}
}

64 
b¡ršg
 
	$S‘tšg_g‘_¡r
(cÚ¡ *
key
, 
b¡ršg
 
def
)

66 
b¡ršg
 
v®ue
 = 
	`t¡_£¬ch
(
SETTINGS_MAP
, 
key
, 
	`¡¾’
(key));

68  
v®ue
 =ğ
NULL
 ? 
def
 : value;

69 
	}
}

71 
	$S‘tšg_g‘_št
(cÚ¡ *
key
, 
def
)

73 
b¡ršg
 
v®ue
 = 
	`t¡_£¬ch
(
SETTINGS_MAP
, 
key
, 
	`¡¾’
(key));

75 if(
v®ue
) {

76  
	`©oi
((cÚ¡ *)
v®ue
->
d©a
);

78  
def
;

80 
	}
}

82 
	$S‘tšg_Œav”£_de¡roy
(*
v®ue
, *
d©a
)

84 
	`bde¡roy
((
b¡ršg
)
v®ue
);

85 
	}
}

87 
	$S‘tšg_de¡roy
()

89 if(
SETTINGS_MAP
) {

90 
	`t¡_Œav”£
(
SETTINGS_MAP
, 
S‘tšg_Œav”£_de¡roy
, 
NULL
);

91 
	`t¡_de¡roy
(
SETTINGS_MAP
);

92 
SETTINGS_MAP
 = 
NULL
;

94 
	}
}

	@src/setting.h

35 #iâdeà
_£‰šg_h


36 
	#_£‰šg_h


	)

38 
	~<¡dlib.h
>

39 
	~<b¡ršg.h
>

41 
S‘tšg_add
(cÚ¡ *
key
, cÚ¡ *
v®ue
);

43 
b¡ršg
 
S‘tšg_g‘_¡r
(cÚ¡ *
key
, b¡ršg 
def
);

45 
S‘tšg_g‘_št
(cÚ¡ *
key
, 
def
);

47 
S‘tšg_de¡roy
();

	@src/state.c

37 
	~<¡dlib.h
>

38 
	~<¡dio.h
>

39 
	~<¡©e.h
>

40 
	~<dbg.h
>

41 
	~<ev’ts.h
>

42 
	~<as£¹.h
>

44 
	#CALL
(
A
, 
C
è
	`TRACE
(A,C); if(
¡©e
->
aùiÚs
 && s‹->aùiÚs->Aè
Ãxt
 = s‹->aùiÚs->
	`A
(
cÚn
)

	)

52 cÚ¡ 
	gS‹AùiÚs_¡¬t
 = 16;

53 cÚ¡ 
	gS‹AùiÚs_fœ¡_fš®
 = 16;

54 cÚ¡ 
	gS‹AùiÚs_”rÜ
 = 0;

56 cÚ¡ 
	gS‹AùiÚs_’_Proxy
 = 10;

57 cÚ¡ 
	gS‹AùiÚs_’_maš
 = 16;

58 cÚ¡ 
	gS‹AùiÚs_’_maš_CÚÃùiÚ_IdË
 = 5;

59 cÚ¡ 
	gS‹AùiÚs_’_maš_CÚÃùiÚ_HTTPRoutšg
 = 3;

64 
	$S‹_š™
(
S‹
 *
¡©e
, 
S‹AùiÚs
 *
aùiÚs
)

66 
¡©e
->
aùiÚs
 =‡ctions;

71 
¡©e
->
cs
 = 
S‹AùiÚs_¡¬t
;

76 
	}
}

78 
	$S‹_šv¬ŸÁ
(
S‹
 *
¡©e
)

80 iàĞ
¡©e
->
cs
 ==

88 iàĞ
¡©e
->
cs
 >=

97 
	}
}

99 
	$S‹_exec
(
S‹
 *
¡©e
, 
ev’t
, 
CÚÃùiÚ
 *
cÚn
)

101 
ev’t_queue
[2] = {0};

102 
ev’t_queue
[0] = 
ev’t
;

103 
Ãxt
 = 0;

105 cÚ¡ *
p
 = 
ev’t_queue
;

106 cÚ¡ *
³
 = 
p
+1;

107 cÚ¡ *
eof
 = 
ev’t
 =ğ
CLOSE
 ? 
³
 : 
NULL
;

112 iàĞ
p
 =ğ
³
 )

113 
_‹¡_eof
;

114  
¡©e
->
cs
 )

117 iàĞ(*
p
) == 107 )

118 
Œ20
;

119 
¡0
;

120 
Œ0
:

122 { 
	`CALL
(
”rÜ
, (*
p
)); }

123 
¡0
;

125 
¡0
:

126 
¡©e
->
cs
 = 0;

127 
_out
;

128 
Œ20
:

130 { 
	`CALL
(
·r£
, (*
p
)); }

131 
¡1
;

132 
¡1
:

133 iàĞ++
p
 =ğ
³
 )

134 
_‹¡_eof1
;

137  (*
p
) ) {

138 100: 
Œ1
;

139 110: 
Œ2
;

141 
Œ0
;

142 
Œ1
:

144 { 
	`CALL
(
şo£
, (*
p
)); }

145 
¡17
;

146 
¡17
:

147 iàĞ++
p
 =ğ
³
 )

148 
_‹¡_eof17
;

151 iàĞ(*
p
) == 107 )

152 
Œ20
;

153 
Œ0
;

154 
Œ2
:

156 { 
	`CALL
(
»gi¡”_»que¡
, (*
p
)); }

157 
¡2
;

158 
¡2
:

159 iàĞ++
p
 =ğ
³
 )

160 
_‹¡_eof2
;

163  (*
p
) ) {

164 100: 
Œ1
;

165 105: 
Œ3
;

166 106: 
Œ4
;

167 113: 
Œ5
;

169 
Œ0
;

170 
Œ3
:

172 { 
	`CALL
(
rou‹_»que¡
, (*
p
)); }

173 
¡3
;

174 
¡3
:

175 iàĞ++
p
 =ğ
³
 )

176 
_‹¡_eof3
;

179  (*
p
) ) {

180 100: 
Œ1
;

181 102: 
Œ6
;

182 104: 
Œ7
;

183 108: 
Œ8
;

185 
Œ0
;

186 
Œ5
:

188 { 
	`CALL
(
£nd_sock‘_»¥Ú£
, (*
p
)); }

189 
¡4
;

190 
Œ6
:

192 { 
	`CALL
(
h‰p_to_dœeùÜy
, (*
p
)); }

193 
¡4
;

194 
¡4
:

195 iàĞ++
p
 =ğ
³
 )

196 
_‹¡_eof4
;

199  (*
p
) ) {

200 100: 
Œ1
;

201 112: 
Œ9
;

203 
Œ0
;

204 
Œ9
:

206 { 
	`CALL
(
·r£
, (*
p
)); }

207 
¡5
;

208 
¡5
:

209 iàĞ++
p
 =ğ
³
 )

210 
_‹¡_eof5
;

213  (*
p
) ) {

214 100: 
Œ1
;

215 110: 
Œ10
;

217 
Œ0
;

218 
Œ10
:

220 { 
	`CALL
(
id’tify_»que¡
, (*
p
)); }

221 
¡6
;

222 
¡6
:

223 iàĞ++
p
 =ğ
³
 )

224 
_‹¡_eof6
;

227  (*
p
) ) {

228 105: 
Œ3
;

229 106: 
Œ4
;

230 113: 
Œ5
;

232 
Œ0
;

233 
Œ4
:

235 { 
	`CALL
(
rou‹_»que¡
, (*
p
)); }

236 
¡7
;

237 
¡7
:

238 iàĞ++
p
 =ğ
³
 )

239 
_‹¡_eof7
;

242 iàĞ(*
p
) == 104 )

243 
Œ11
;

244 
Œ0
;

245 
Œ7
:

247 { 
	`CALL
(
h‰p_to_hªdËr
, (*
p
)); }

248 
¡8
;

249 
Œ11
:

251 { 
	`CALL
(
msg_to_hªdËr
, (*
p
)); }

252 
¡8
;

253 
¡8
:

254 iàĞ++
p
 =ğ
³
 )

255 
_‹¡_eof8
;

258 iàĞ(*
p
) == 111 )

259 
Œ9
;

260 
Œ0
;

261 
Œ8
:

263 { 
	`CALL
(
h‰p_to_´oxy
, (*
p
)); {
¡10
;} }

264 
¡9
;

265 
¡9
:

266 iàĞ++
p
 =ğ
³
 )

267 
_‹¡_eof9
;

270 
Œ0
;

271 
¡10
:

272 iàĞ++
p
 =ğ
³
 )

273 
_‹¡_eof10
;

275  (*
p
) ) {

276 101: 
Œ12
;

277 103: 
Œ14
;

279 
¡0
;

280 
Œ12
:

282 { 
	`CALL
(
´oxy_d–iv”
, (*
p
)); }

283 
¡11
;

284 
¡11
:

285 iàĞ++
p
 =ğ
³
 )

286 
_‹¡_eof11
;

289  (*
p
) ) {

290 109: 
Œ15
;

291 111: 
Œ16
;

293 
Œ0
;

294 
Œ14
:

296 { 
	`CALL
(
´oxy_çed
, (*
p
)); }

297 
¡12
;

298 
Œ15
:

300 { 
	`CALL
(
´oxy_şo£
, (*
p
)); }

301 
¡12
;

302 
¡12
:

303 iàĞ++
p
 =ğ
³
 )

304 
_‹¡_eof12
;

307 iàĞ(*
p
) == 100 )

308 
Œ17
;

309 
Œ0
;

310 
Œ17
:

313 
p
--;

314 {
¡5
;}

316 
¡13
;

317 
Œ19
:

320 
	`CALL
(
´oxy_şo£
, (*
p
));

321 
p
--;

322 {
¡3
;}

324 
¡13
;

325 
¡13
:

326 iàĞ++
p
 =ğ
³
 )

327 
_‹¡_eof13
;

330 
Œ0
;

331 
Œ16
:

333 { 
	`CALL
(
´oxy_»¶y_·r£
, (*
p
)); }

334 
¡14
;

335 
¡14
:

336 iàĞ++
p
 =ğ
³
 )

337 
_‹¡_eof14
;

340  (*
p
) ) {

341 109: 
Œ15
;

342 110: 
Œ18
;

344 
Œ0
;

345 
Œ18
:

347 { 
	`CALL
(
´oxy_»q_·r£
, (*
p
)); }

348 
¡15
;

349 
¡15
:

350 iàĞ++
p
 =ğ
³
 )

351 
_‹¡_eof15
;

354  (*
p
) ) {

355 102: 
Œ19
;

356 104: 
Œ19
;

357 105: 
Œ12
;

358 108: 
Œ19
;

359 109: 
Œ15
;

361 
Œ0
;

363 
_‹¡_eof1
: 
¡©e
->
cs
 = 1; 
_‹¡_eof
;

364 
_‹¡_eof17
: 
¡©e
->
cs
 = 17; 
_‹¡_eof
;

365 
_‹¡_eof2
: 
¡©e
->
cs
 = 2; 
_‹¡_eof
;

366 
_‹¡_eof3
: 
¡©e
->
cs
 = 3; 
_‹¡_eof
;

367 
_‹¡_eof4
: 
¡©e
->
cs
 = 4; 
_‹¡_eof
;

368 
_‹¡_eof5
: 
¡©e
->
cs
 = 5; 
_‹¡_eof
;

369 
_‹¡_eof6
: 
¡©e
->
cs
 = 6; 
_‹¡_eof
;

370 
_‹¡_eof7
: 
¡©e
->
cs
 = 7; 
_‹¡_eof
;

371 
_‹¡_eof8
: 
¡©e
->
cs
 = 8; 
_‹¡_eof
;

372 
_‹¡_eof9
: 
¡©e
->
cs
 = 9; 
_‹¡_eof
;

373 
_‹¡_eof10
: 
¡©e
->
cs
 = 10; 
_‹¡_eof
;

374 
_‹¡_eof11
: 
¡©e
->
cs
 = 11; 
_‹¡_eof
;

375 
_‹¡_eof12
: 
¡©e
->
cs
 = 12; 
_‹¡_eof
;

376 
_‹¡_eof13
: 
¡©e
->
cs
 = 13; 
_‹¡_eof
;

377 
_‹¡_eof14
: 
¡©e
->
cs
 = 14; 
_‹¡_eof
;

378 
_‹¡_eof15
: 
¡©e
->
cs
 = 15; 
_‹¡_eof
;

380 
_‹¡_eof
: {}

381 iàĞ
p
 =ğ
eof
 )

383  
¡©e
->
cs
 ) {

399 { 
	`CALL
(
”rÜ
, (*
p
)); }

405 
_out
: {}

410  
Ãxt
;

411 
	}
}

415 cÚ¡ *
	gEVENT_NAMES
[] = {

432 cÚ¡ *
	$S‹_ev’t_Çme
(
ev’t
)

434 if(
ev’t
 =ğ0èev’ˆğ
CLOSE
;

436 
	`as£¹
(
ev’t
 >ğ
CLOSE
 &&ƒv’ˆ< 
EVENT_END
 && "Event is outside„ange.");

438  
EVENT_NAMES
[
ev’t
 - 
CLOSE
];

439 
	}
}

	@src/state.h

35 #iâdeà
_¡©e_h


36 
	#_¡©e_h


	)

38 
	gS‹
;

39 
	gCÚÃùiÚ
;

41 (*
	t¡©e_aùiÚ_cb
)(
	tCÚÃùiÚ
 *
	tcÚn
);

43 
	sS‹AùiÚs
 {

44 
¡©e_aùiÚ_cb
 
”rÜ
;

45 
¡©e_aùiÚ_cb
 
şo£
;

46 
¡©e_aùiÚ_cb
 
·r£
;

47 
¡©e_aùiÚ_cb
 
»gi¡”_»que¡
;

48 
¡©e_aùiÚ_cb
 
id’tify_»que¡
;

49 
¡©e_aùiÚ_cb
 
rou‹_»que¡
;

50 
¡©e_aùiÚ_cb
 
£nd_sock‘_»¥Ú£
;

51 
¡©e_aùiÚ_cb
 
msg_to_hªdËr
;

52 
¡©e_aùiÚ_cb
 
h‰p_to_hªdËr
;

53 
¡©e_aùiÚ_cb
 
h‰p_to_´oxy
;

54 
¡©e_aùiÚ_cb
 
h‰p_to_dœeùÜy
;

55 
¡©e_aùiÚ_cb
 
´oxy_d–iv”
;

56 
¡©e_aùiÚ_cb
 
´oxy_çed
;

57 
¡©e_aùiÚ_cb
 
´oxy_»¶y_·r£
;

58 
¡©e_aùiÚ_cb
 
´oxy_»q_·r£
;

59 
¡©e_aùiÚ_cb
 
´oxy_şo£
;

60 } 
	tS‹AùiÚs
;

62 
	sS‹
 {

63 
cs
;

64 *
d©a
;

65 
S‹AùiÚs
 *
aùiÚs
;

66 } 
	tS‹
;

68 
	`S‹_exec
(
S‹
 *
¡©e
, 
ev’t
, 
CÚÃùiÚ
 *
cÚn
);

69 
	`S‹_šv¬ŸÁ
(
S‹
 *
¡©e
);

70 
	`S‹_š™
(
S‹
 *
¡©e
, 
S‹AùiÚs
 *
aùiÚs
);

72 cÚ¡ *
	`S‹_ev’t_Çme
(
ev’t
);

	@src/superpoll.c

36 
	~<su³½Şl.h
>

37 
	~<mem/h®loc.h
>

38 
	~<dbg.h
>

39 
	~<as£¹.h
>

40 
	~<sys/»sourû.h
>

41 
	~<uni¡d.h
>

42 
	~<as£¹.h
>

43 
	~<£‰šg.h
>

45 #ifdeà
__lšux__


46 
	#HAS_EPOLL
 1

	)

48 
	#HAS_EPOLL
 0

	)

51 
	gMAXFD
 = 0;

54 
	mMAX_NOFILE
 = 1024 * 10

57 
	$Su³rPŞl_de¡roy
(
Su³rPŞl
 *
¥
)

59 if(
¥
) {

60 if(
HAS_EPOLL
) {

61 if(
¥
->
idË_fd
 > 0è
	`şo£
(sp->idle_fd);

62 if(
¥
->
idË_aùive
) {

63 
	`li¡_de¡roy_nodes
(
¥
->
idË_aùive
);

64 
	`li¡_de¡roy
(
¥
->
idË_aùive
);

67 if(
¥
->
idË_ä“
) {

68 
	`li¡_de¡roy_nodes
(
¥
->
idË_ä“
);

69 
	`li¡_de¡roy
(
¥
->
idË_ä“
);

73 
	`h_ä“
(
¥
);

75 
	}
}

78 
šlše
 
Su³rPŞl_¬m_idË_fd
(
Su³rPŞl
 *
¥
);

79 
šlše
 
Su³rPŞl_£tup_idË
(
Su³rPŞl
 *
¥
, 
tÙ®_İ’_fd
);

80 
šlše
 
Su³rPŞl_add_idË
(
Su³rPŞl
 *
¥
, *
d©a
, 
fd
, 
rw
);

81 
šlše
 
Su³rPŞl_add_idË_h™s
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
);

84 
Su³rPŞl
 *
	$Su³rPŞl_ü—‹
()

86 
Su³rPŞl
 *
¥
 = 
	`h_ÿÎoc
((SuperPoll), 1);

87 
	`check_mem
(
¥
);

88 
rc
 = 0;

90 
tÙ®_İ’_fd
 = 
	`Su³rPŞl_g‘_max_fd
();

91 
¥
->
nfd_hÙ
 = 0;

93 if(
HAS_EPOLL
) {

94 
hÙ_divid’d
 = 
	`S‘tšg_g‘_št
("superpoll.hot_dividend", 4);

96 
¥
->
max_hÙ
 = 
tÙ®_İ’_fd
 / 
hÙ_divid’d
;

98 
rc
 = 
	`Su³rPŞl_£tup_idË
(
¥
, 
tÙ®_İ’_fd
);

99 
	`check
(
rc
 == 0, "Failedo configureƒpoll. Disabling.");

101 
	`log_šfo
("Allowing for %d hot‡nd %d idle file descriptors (dividend was %d)",

102 
¥
->
max_hÙ
, sp->
max_idË
, 
hÙ_divid’d
);

104 
¥
->
max_hÙ
 = 
tÙ®_İ’_fd
;

106 
	`log_šfo
("You dØnÙ hav•ŞÈsuµÜt. AÎowšg fÜ %d fdesütÜ through…Şl.", 
¥
->
max_hÙ
);

109 
¥
->
pŞlfd
 = 
	`h_ÿÎoc
((
zmq_pŞl™em_t
), sp->
max_hÙ
);

110 
	`check_mem
(
¥
->
pŞlfd
);

111 
	`h©ch
(
¥
->
pŞlfd
, sp);

113 
¥
->
hÙ_d©a
 = 
	`h_ÿÎoc
((*), sp->
max_hÙ
);

114 
	`check_mem
(
¥
->
hÙ_d©a
);

115 
	`h©ch
(
¥
->
hÙ_d©a
, sp);

117 if(
HAS_EPOLL
) {

118 
rc
 = 
	`Su³rPŞl_¬m_idË_fd
(
¥
);

119 
	`check
(
rc
 != -1, "Failedo‡ddheƒpoll socketohe…oll†ist.");

122  
¥
;

124 
”rÜ
:

125 
	`Su³rPŞl_de¡roy
(
¥
);

127  
NULL
;

128 
	}
}

132 
šlše
 
	$Su³rPŞl_add_pŞl
(
Su³rPŞl
 *
¥
, *
d©a
, *
sock‘
, 
fd
, 
rw
)

134 
cur_fd
 = 
¥
->
nfd_hÙ
;

135 
b™s
 = 0;

137 
	`check
(
sock‘
 !ğ
NULL
 || 
fd
 >ğ0, "A‰em±Ø% äom d—d fdesütÜ: %d", 
rw
 == 'r' ? "read" : "write", fd);

138 
	`check
(
cur_fd
 < 
	`Su³rPŞl_max_hÙ
(
¥
), "Too many %s: %d is greaterhan hot %d max.",

139 
sock‘
 ? "handler„equests outstanding, your handler isn't„unning" : "files open",

140 
cur_fd
, 
	`Su³rPŞl_max_hÙ
(
¥
));

143 if(
rw
 == 'r') {

144 
b™s
 |ğ
ZMQ_POLLIN
;

145 } if(
rw
 == 'w') {

146 
b™s
 |ğ
ZMQ_POLLOUT
;

148 
	`£Áš–
("Inv®idƒv’ˆ%øhªdedØsu³½Şl.„/w oÆy.", 
rw
);

151 
¥
->
pŞlfd
[
cur_fd
].
fd
 = fd;

152 
¥
->
pŞlfd
[
cur_fd
].
sock‘
 = socket;

153 
¥
->
pŞlfd
[
cur_fd
].
ev’ts
 = 
b™s
;

154 
¥
->
pŞlfd
[
cur_fd
].
»v’ts
 = 0;

155 
¥
->
hÙ_d©a
[
cur_fd
] = 
d©a
;

156 
¥
->
nfd_hÙ
++;

158  
¥
->
nfd_hÙ
;

160 
”rÜ
:

162 
	}
}

164 
	$Su³rPŞl_add
(
Su³rPŞl
 *
¥
, *
d©a
, *
sock‘
, 
fd
, 
rw
, 
hÙ
)

166 if(
sock‘
 || 
hÙ
 || !
HAS_EPOLL
) {

167  
	`Su³rPŞl_add_pŞl
(
¥
, 
d©a
, 
sock‘
, 
fd
, 
rw
);

169 
	`as£¹
(!
sock‘
 && "Cannot‡dd‡ 0MQ socketohe idle (!hot) set.");

170  
	`Su³rPŞl_add_idË
(
¥
, 
d©a
, 
fd
, 
rw
);

172 
	}
}

174 
	$Su³rPŞl_d–
(
Su³rPŞl
 *
¥
, *
sock‘
, 
fd
, 
hÙ
)

176 
i
 = 0;

177 
¦Ù
 = 0;

179 
i
 = 0; i < 
¥
->
nfd_hÙ
; i++) {

180 if(
sock‘
) {

181 if(
¥
->
pŞlfd
[
i
].
sock‘
 == socket) {

182 
¦Ù
 = 
i
; ;

184 } if(
hÙ
) {

185 if(
¥
->
pŞlfd
[
i
].
fd
 == fd) {

186 
¦Ù
 = 
i
; ;

189 
	`£Áš–
("Not implemented yet.");

193 
	`Su³rPŞl_com·ù_down
(
¥
, 
¦Ù
);

196 
”rÜ
:

198 
	}
}

201 
	$Su³rPŞl_com·ù_down
(
Su³rPŞl
 *
¥
, 
i
)

203 
¥
->
nfd_hÙ
--;

204 if(
¥
->
nfd_hÙ
 >= 0) {

205 
¥
->
pŞlfd
[
i
] = sp->pŞlfd[¥->
nfd_hÙ
];

206 
¥
->
hÙ_d©a
[
i
] = sp->hÙ_d©a[¥->
nfd_hÙ
];

208 
	}
}

210 
šlše
 
	$Su³rPŞl_add_h™
(
PŞlResuÉ
 *
»suÉ
, 
zmq_pŞl™em_t
 *
p
, *
d©a
)

212 
»suÉ
->
h™s
[»suÉ->
nh™s
].
ev
 = *
p
;

213 
»suÉ
->
h™s
[»suÉ->
nh™s
].
d©a
 = data;

214 
»suÉ
->
nh™s
++;

215 
	}
}

218 
	$Su³rPŞl_pŞl
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
, 
ms
)

220 
i
 = 0;

221 
nfound
 = 0;

222 
cur_i
 = 0;

223 
rc
 = 0;

224 
h™_idË
 = 0;

226 
»suÉ
->
nh™s
 = 0;

229 
nfound
 = 
	`zmq_pŞl
(
¥
->
pŞlfd
, sp->
nfd_hÙ
, 
ms
 * 1000);

230 
	`check
(
nfound
 >ğ0 || 
”ºo
 =ğ
EINTR
, "zmq_poll failed.");

232 
»suÉ
->
hÙ_fds
 = 
nfound
;

234 
i
 = 0; i < 
nfound
; i++) {

235 
cur_i
 < 
¥
->
nfd_hÙ
 && !¥->
pŞlfd
[cur_i].
»v’ts
) {

236 
cur_i
++;

239 if(
HAS_EPOLL
 && 
¥
->
pŞlfd
[
cur_i
].
fd
 =ğ¥->
idË_fd
) {

240 
h™_idË
 = 1;

241 
rc
 = 
	`Su³rPŞl_add_idË_h™s
(
¥
, 
»suÉ
);

242 
	`check
(
rc
 != -1, "Failedo‡dd idle hits.");

244 
	`Su³rPŞl_add_h™
(
»suÉ
, &
¥
->
pŞlfd
[
cur_i
], sp->
hÙ_d©a
[cur_i]);

247 
	`Su³rPŞl_com·ù_down
(
¥
, 
cur_i
);

250 if(
h™_idË
) {

251 
	`Su³rPŞl_¬m_idË_fd
(
¥
);

254  
»suÉ
->
nh™s
;

256 
”rÜ
:

259 
	}
}

261 
	$Su³rPŞl_g‘_max_fd
()

263 
rc
 = 0;

264 
¾im™
 
¾
;

266 if(
MAXFD
)  MAXFD;

268 
»que¡ed_max
 = 
	`S‘tšg_g‘_št
("su³½Şl.max_fd", 
MAX_NOFILE
);

270 
	`debug
("A‰em±šgØfÜû NOFILE†im™Ø%d", 
»que¡ed_max
);

271 
¾
.
¾im_cur
 = 
»que¡ed_max
;

272 
¾
.
¾im_max
 = 
»que¡ed_max
;

274 
rc
 = 
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾
);

276 if(
rc
 == 0) {

277 
MAXFD
 = 
»que¡ed_max
;

279 
	`log_šfo
("Could‚Ù fÜû NOFILE high”, you'Î‚“dØruÀa roÙ: %s", 
	`¡»¼Ü
(
”ºo
));

280 
rc
 = 
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾
);

281 
	`check
(
rc
 == 0, "Failedo get your max open file†imit,otally weird.");

282 
MAXFD
 = 
¾
.
¾im_cur
;

285 
	`log_šfo
("MAX o³ÀfdesütÜ i %d‚ow.", 
MAXFD
);

286  
MAXFD
;

288 
”rÜ
:

289 
	`log_”r
("TOTAL CATASTROPHE, ifhis happens we can't get your„limit for max files,…icking 256o be safe.");

291 
MAXFD
 = 256;

292  
MAXFD
;

293 
	}
}

296 
	$PŞlResuÉ_š™
(
Su³rPŞl
 *
p
, 
PŞlResuÉ
 *
»suÉ
)

298 
	`mem£t
(
»suÉ
, 0, (
PŞlResuÉ
));

299 
»suÉ
->
h™s
 = 
	`h_ÿÎoc
((
PŞlEv’t
), 
	`Su³rPŞl_max_hÙ
(
p
è+ 
	`Su³rPŞl_max_idË
(p));

300 
	`h©ch
(
»suÉ
->
h™s
, 
p
);

301 
	`check_mem
(
»suÉ
->
h™s
);

305 
”rÜ
:

307 
	}
}

309 
	$PŞlResuÉ_ş—n
(
PŞlResuÉ
 *
»suÉ
)

311 if(
»suÉ
) {

312 if(
»suÉ
->
h™s
è
	`h_ä“
(result->hits);

314 
	}
}

317 #ià
defšed
 
HAS_EPOLL
 && HAS_EPOLL == 0

319 
šlše
 
	$Su³rPŞl_¬m_idË_fd
(
Su³rPŞl
 *
¥
)

321 
	`as£¹
(0 && "Should‚ot get called.");

323 
	}
}

325 
šlše
 
	$Su³rPŞl_£tup_idË
(
Su³rPŞl
 *
¥
, 
tÙ®_İ’_fd
)

327 
¥
->
max_idË
 = 0;

328 
¥
->
ev’ts
 = 
NULL
;

329 
¥
->
idË_fd
 = -1;

330 
¥
->
idË_d©a
 = 
NULL
;

331 
¥
->
idË_ä“
 = 
NULL
;

332 
¥
->
idË_aùive
 = 
NULL
;

334 
	}
}

336 
šlše
 
	$Su³rPŞl_add_idË
(
Su³rPŞl
 *
¥
, *
d©a
, 
fd
, 
rw
)

338  
	`Su³rPŞl_add_pŞl
(
¥
, 
d©a
, 
NULL
, 
fd
, 
rw
);

339 
	}
}

341 
šlše
 
	$Su³rPŞl_add_idË_h™s
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
)

344 
	}
}

348 
	~<sys/•Şl.h
>

350 
	#Su³rPŞl_•Şl_ev’ts
(
S
è((
•Şl_ev’t
 *)(S->
ev’ts
))

	)

352 
šlše
 
	$Su³rPŞl_¬m_idË_fd
(
Su³rPŞl
 *
¥
)

354  
	`Su³rPŞl_add
(
¥
, 
NULL
, NULL, sp->
idË_fd
, 'r', 1);

355 
	}
}

357 
šlše
 
	$Su³rPŞl_£tup_idË
(
Su³rPŞl
 *
¥
, 
tÙ®_İ’_fd
)

359 
	`as£¹
(
HAS_EPOLL
 == 1 && "This function should‚ot„un unless HAS_EPOLL is 1.");

361 
i
 = 0;

363 
¥
->
max_idË
 = 
tÙ®_İ’_fd
 - sp->
max_hÙ
;

364 
	`as£¹
(
¥
->
max_idË
 >= 0 && "max idle is can't be†esshan zero.");

367 
¥
->
ev’ts
 = 
	`h_ÿÎoc
((
•Şl_ev’t
), sp->
max_idË
);

368 
	`check_mem
(
¥
->
ev’ts
);

369 
	`h©ch
(
¥
->
ev’ts
, sp);

371 
¥
->
idË_fd
 = 
	`•Şl_ü—‹
(¥->
max_idË
);

372 
	`check
(
¥
->
idË_fd
 != -1, "Failedo createheƒpoll structure.");

374 
¥
->
idË_d©a
 = 
	`h_ÿÎoc
((
IdËD©a
), sp->
max_idË
);

375 
	`check_mem
(
¥
->
idË_d©a
);

376 
	`h©ch
(
¥
->
idË_d©a
, sp);

378 
¥
->
idË_ä“
 = 
	`li¡_ü—‹
(¥->
max_idË
);

379 
	`check_mem
(
¥
->
idË_ä“
);

382 
	`debug
("Budšg u°¦Ù fÜ %d sock‘ š idË. Couldak¨mšu‹.", 
¥
->
max_idË
);

383 
i
 = 0; i < 
¥
->
max_idË
; i++) {

384 
Êode_t
 *
n
 = 
	`Êode_ü—‹
(&
¥
->
idË_d©a
[
i
]);

385 
	`check_mem
(
n
);

386 
	`li¡_­³nd
(
¥
->
idË_ä“
, 
n
);

389 
¥
->
idË_aùive
 = 
	`li¡_ü—‹
(¥->
max_idË
);

390 
	`check_mem
(
¥
->
idË_aùive
);

393 
”rÜ
:

395 
	}
}

398 
šlše
 
	$Su³rPŞl_add_idË
(
Su³rPŞl
 *
¥
, *
d©a
, 
fd
, 
rw
)

401 
	`check
(!
	`li¡_i£m±y
(
¥
->
idË_ä“
), "Too many open files,‚o free idle slots.");

403 
Êode_t
 *
Ãxt
 = 
	`li¡_d–_Ï¡
(
¥
->
idË_ä“
);

405 
IdËD©a
 *
id
 = (IdËD©¨*)
	`Êode_g‘
(
Ãxt
);

406 
	`as£¹
(
id
 && "Got‡n id NULL…tr fromhe free†ist.");

408 
id
->
fd
 = fd;

409 
id
->
d©a
 = data;

411 
	`li¡_­³nd
(
¥
->
idË_aùive
, 
Ãxt
);

414 
•Şl_ev’t
 
ev’t
;

416 if(
rw
 == 'r') {

417 
•Şl_ev’t
 
ev
 = {.
d©a
 = {.
±r
 = 
Ãxt
}, .
ev’ts
 = 
EPOLLIN
 | 
EPOLLONESHOT
};

418 
ev’t
 = 
ev
;

419 } if(
rw
 == 'w') {

420 
•Şl_ev’t
 
ev
 = {.
d©a
 = {.
±r
 = 
Ãxt
}, .
ev’ts
 = 
EPOLLOUT
 | 
EPOLLONESHOT
};

421 
ev’t
 = 
ev
;

423 
	`£Áš–
("Inv®idƒv’ˆ%øhªdedØsu³½Şl.„/w oÆy.", 
rw
);

427 
rc
 = 
	`•Şl_ùl
(
¥
->
idË_fd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
);

429 if(
rc
 =ğ-1 && 
”ºo
 =ğ
EEXIST
) {

431 
rc
 = 
	`•Şl_ùl
(
¥
->
idË_fd
, 
EPOLL_CTL_MOD
, 
fd
, &
ev’t
);

432 
	`check
(
rc
 != -1, "Could‚ot MOD fdhat's‡lready inƒpoll.");

433 } if(
rc
 == -1) {

434 
	`£Áš–
("Failedo‡dd FDoƒpoll.");

439 
”rÜ
:

441 
	}
}

444 
šlše
 
	$Su³rPŞl_add_idË_h™s
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
)

446 
nfds
 = 0;

447 
i
 = 0;

448 
rc
 = 0;

449 
zmq_pŞl™em_t
 
ev
 = {.
sock‘
 = 
NULL
};

451 
nfds
 = 
	`•Şl_wa™
(
¥
->
idË_fd
, 
	`Su³rPŞl_•Şl_ev’ts
(¥), sp->
max_idË
, 0);

452 
	`check
(
nfds
 >= 0, "Error doingƒpoll.");

453 
•Şl_ev’t
 *
ev’ts
 = 
	`Su³rPŞl_•Şl_ev’ts
(
¥
);

455 
i
 = 0; i < 
nfds
; i++) {

456 
Êode_t
 *
node
 = (Êode_ˆ*)
ev’ts
[
i
].
d©a
.
±r
;

457 
IdËD©a
 *
d©a
 = 
	`Êode_g‘
(
node
);

458 
ev
.
fd
 = 
d©a
->fd;

460 if(
ev’ts
[
i
].ev’t & 
EPOLLIN
) {

461 
ev
.
»v’ts
 = 
ZMQ_POLLIN
;

464 if(
ev’ts
[
i
].ev’t & 
EPOLLOUT
) {

465 
ev
.
»v’ts
 = 
ZMQ_POLLOUT
;

468 if(
ev
.
»v’ts
) {

469 
	`Su³rPŞl_add_h™
(
»suÉ
, &
ev
, 
d©a
->data);

473 
rc
 = 
	`•Şl_ùl
(
¥
->
idË_fd
, 
EPOLL_CTL_DEL
, 
ev
.
fd
, 
NULL
);

474 
	`check
(
rc
 !ğ-1, "FaedØ»movfd %d fromƒpŞl.", 
ev
.
fd
);

477 
node
 = 
	`li¡_d–‘e
(
¥
->
idË_aùive
,‚ode);

478 
	`li¡_­³nd
(
¥
->
idË_ä“
, 
node
);

480 
	`as£¹
(
	`li¡_couÁ
(
¥
->
idË_aùive
è+†i¡_couÁ(¥->
idË_ä“
è=ğ()¥->
max_idË
 && "We†ost one somewhere.");

483 
»suÉ
->
idË_fds
 = 
nfds
;

484  
nfds
;

486 
”rÜ
:

488 
	}
}

	@src/superpoll.h

35 #iâdeà
_su³½Şl_h


36 
	#_su³½Şl_h


	)

38 
	~<adt/li¡.h
>

39 
	~<zmq.h
>

41 
	sIdËD©a
 {

42 
	mfd
;

43 *
	md©a
;

44 } 
	tIdËD©a
;

46 
	sSu³rPŞl
 {

49 
zmq_pŞl™em_t
 *
	mpŞlfd
;

51 **
	mhÙ_d©a
;

52 
	mnfd_hÙ
;

53 
	mmax_hÙ
;

56 *
	mev’ts
;

57 
	midË_fd
;

59 
	mmax_idË
;

60 
IdËD©a
 *
	midË_d©a
;

61 
li¡_t
 *
	midË_aùive
;

62 
li¡_t
 *
	midË_ä“
;

63 } 
	tSu³rPŞl
;

66 
	sPŞlEv’t
 {

67 
zmq_pŞl™em_t
 
	mev
;

68 *
	md©a
;

69 } 
	tPŞlEv’t
;

72 
	sPŞlResuÉ
 {

73 
	mhÙ_fds
;

74 
	mhÙ_©r
;

76 
	midË_fds
;

77 
	midË_©r
;

79 
	mnh™s
;

80 
PŞlEv’t
 *
	mh™s
;

81 } 
	tPŞlResuÉ
;

83 
Su³rPŞl_de¡roy
(
Su³rPŞl
 *
¥
);

85 
Su³rPŞl
 *
Su³rPŞl_ü—‹
();

87 
Su³rPŞl_add
(
Su³rPŞl
 *
¥
, *
d©a
, *
sock‘
, 
fd
, 
rw
, 
hÙ
);

88 
Su³rPŞl_d–
(
Su³rPŞl
 *
¥
, *
sock‘
, 
fd
, 
hÙ
);

90 
Su³rPŞl_com·ù_down
(
Su³rPŞl
 *
¥
, 
i
);

92 
Su³rPŞl_pŞl
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
, 
ms
);

94 
Su³rPŞl_g‘_max_fd
();

96 
	#Su³rPŞl_aùive_hÙ
(
S
è((S)->
nfd_hÙ
)

	)

98 
	#Su³rPŞl_aùive_idË
(
S
è((S)->
idË_aùive
 ? 
	`li¡_couÁ
((S)->idË_aùiveè:0)

	)

100 
	#Su³rPŞl_aùive_couÁ
(
S
è(
	`Su³rPŞl_aùive_hÙ
(Sè+ 
	`Su³rPŞl_aùive_idË
(S))

	)

102 
	#Su³rPŞl_max_hÙ
(
S
è((S)->
max_hÙ
)

	)

103 
	#Su³rPŞl_max_idË
(
S
è((S)->
max_idË
)

	)

105 
	#Su³rPŞl_d©a
(
S
, 
I
è((S)->
hÙ_d©a
[(I)])

	)

107 
PŞlResuÉ_š™
(
Su³rPŞl
 *
p
, 
PŞlResuÉ
 *
»suÉ
);

109 
PŞlResuÉ_ş—n
(
PŞlResuÉ
 *
»suÉ
);

	@src/task/386-ucontext.h

1 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

2 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

3 
mcÚ‹xt
 
	tmcÚ‹xt_t
;

4 
ucÚ‹xt
 
	tucÚ‹xt_t
;

6 
sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

7 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

8 
g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

9 
£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

73 
	smcÚ‹xt
 {

79 
	mmc_Ú¡ack
;

80 
	mmc_gs
;

81 
	mmc_fs
;

82 
	mmc_es
;

83 
	mmc_ds
;

84 
	mmc_edi
;

85 
	mmc_esi
;

86 
	mmc_ebp
;

87 
	mmc_i¥
;

88 
	mmc_ebx
;

89 
	mmc_edx
;

90 
	mmc_ecx
;

91 
	mmc_—x
;

92 
	mmc_Œ­no
;

93 
	mmc_”r
;

94 
	mmc_e
;

95 
	mmc_cs
;

96 
	mmc_eæags
;

97 
	mmc_e¥
;

98 
	mmc_ss
;

100 
	mmc_å»gs
[28];

101 
	m__¥¬e__
[17];

104 
	sucÚ‹xt
 {

113 
sig£t_t
 
	muc_sigmask
;

114 
mcÚ‹xt_t
 
	muc_mcÚ‹xt
;

116 
__ucÚ‹xt
 *
	muc_lšk
;

117 
¡ack_t
 
	muc_¡ack
;

118 
	m__¥¬e__
[8];

	@src/task/amd64-ucontext.h

1 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

2 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

3 
mcÚ‹xt
 
	tmcÚ‹xt_t
;

4 
ucÚ‹xt
 
	tucÚ‹xt_t
;

6 
sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

7 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

8 
g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

9 
£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

73 
	smcÚ‹xt
 {

79 
	mmc_Ú¡ack
;

80 
	mmc_rdi
;

81 
	mmc_rsi
;

82 
	mmc_rdx
;

83 
	mmc_rcx
;

84 
	mmc_r8
;

85 
	mmc_r9
;

86 
	mmc_¿x
;

87 
	mmc_rbx
;

88 
	mmc_rbp
;

89 
	mmc_r10
;

90 
	mmc_r11
;

91 
	mmc_r12
;

92 
	mmc_r13
;

93 
	mmc_r14
;

94 
	mmc_r15
;

95 
	mmc_Œ­no
;

96 
	mmc_addr
;

97 
	mmc_æags
;

98 
	mmc_”r
;

99 
	mmc_r
;

100 
	mmc_cs
;

101 
	mmc_ræags
;

102 
	mmc_r¥
;

103 
	mmc_ss
;

105 
	mmc_Ën
;

106 
	#_MC_FPFMT_NODEV
 0x10000

	)

107 
	#_MC_FPFMT_XMM
 0x10002

	)

108 
	mmc_åfÜm©
;

109 
	#_MC_FPOWNED_NONE
 0x20000

	)

110 
	#_MC_FPOWNED_FPU
 0x20001

	)

111 
	#_MC_FPOWNED_PCB
 0x20002

	)

112 
	mmc_owÃdå
;

116 
	mmc_å¡©e
[64];

117 
	mmc_¥¬e
[8];

120 
	sucÚ‹xt
 {

129 
sig£t_t
 
	muc_sigmask
;

130 
mcÚ‹xt_t
 
	muc_mcÚ‹xt
;

132 
__ucÚ‹xt
 *
	muc_lšk
;

133 
¡ack_t
 
	muc_¡ack
;

134 
	m__¥¬e__
[8];

	@src/task/context.c

3 
	~"skim¶.h
"

5 #ià
defšed
(
__APPLE__
)

6 #ià
defšed
(
__i386__
)

7 
	#NEEDX86MAKECONTEXT


	)

8 
	#NEEDSWAPCONTEXT


	)

9 #–ià
defšed
(
__x86_64__
)

10 
	#NEEDAMD64MAKECONTEXT


	)

11 
	#NEEDSWAPCONTEXT


	)

13 
	#NEEDPOWERMAKECONTEXT


	)

14 
	#NEEDSWAPCONTEXT


	)

18 #ià
defšed
(
__F»eBSD__
è&& defšed(
__i386__
) && __FreeBSD__ < 5

19 
	#NEEDX86MAKECONTEXT


	)

20 
	#NEEDSWAPCONTEXT


	)

23 #ià
defšed
(
__O³nBSD__
)

24 #ià
defšed
(
__i386__
)

25 
	#NEEDX86MAKECONTEXT


	)

26 
	#NEEDSWAPCONTEXT


	)

27 #–ià
defšed
(
__x86_64__
)

28 
	#NEEDAMD64MAKECONTEXT


	)

29 
	#NEEDSWAPCONTEXT


	)

33 #ià
defšed
(
__lšux__
è&& defšed(
__¬m__
)

34 
	#NEEDSWAPCONTEXT


	)

35 
	#NEEDARMMAKECONTEXT


	)

38 #ifdeà
NEEDPOWERMAKECONTEXT


39 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uı
, (*
func
)(), 
¬gc
, ...)

41 
ulÚg
 *
¥
, *
tos
;

42 
va_li¡
 
¬g
;

44 
tos
 = (
ulÚg
*)
uı
->
uc_¡ack
.
ss_¥
+uı->uc_¡ack.
ss_size
/(ulong);

45 
¥
 = 
tos
 - 16;

46 
uı
->
mc
.
pc
 = ()
func
;

47 
uı
->
mc
.
¥
 = ()sp;

48 
	`va_¡¬t
(
¬g
, 
¬gc
);

49 
uı
->
mc
.
r3
 = 
	`va_¬g
(
¬g
, );

50 
	`va_’d
(
¬g
);

51 
	}
}

54 #ifdeà
NEEDX86MAKECONTEXT


55 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uı
, (*
func
)(), 
¬gc
, ...)

57 *
¥
;

59 
¥
 = (*)
uı
->
uc_¡ack
.
ss_¥
+uı->uc_¡ack.
ss_size
/4;

60 
¥
 -ğ
¬gc
;

61 
¥
 = (*)((
ušŒ_t
)sp - (uintptr_t)sp%16);

62 
	`memmove
(
¥
, &
¬gc
+1,‡rgc*());

64 *--
¥
 = 0;

65 
uı
->
uc_mcÚ‹xt
.
mc_e
 = ()
func
;

66 
uı
->
uc_mcÚ‹xt
.
mc_e¥
 = ()
¥
;

67 
	}
}

70 #ifdeà
NEEDAMD64MAKECONTEXT


71 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uı
, (*
func
)(), 
¬gc
, ...)

73 *
¥
;

74 
va_li¡
 
va
;

76 
	`mem£t
(&
uı
->
uc_mcÚ‹xt
, 0,  ucp->uc_mcontext);

77 if(
¬gc
 != 2)

79 
	`va_¡¬t
(
va
, 
¬gc
);

80 
uı
->
uc_mcÚ‹xt
.
mc_rdi
 = 
	`va_¬g
(
va
, );

81 
uı
->
uc_mcÚ‹xt
.
mc_rsi
 = 
	`va_¬g
(
va
, );

82 
	`va_’d
(
va
);

83 
¥
 = (*)
uı
->
uc_¡ack
.
ss_¥
+uı->uc_¡ack.
ss_size
/();

84 
¥
 -ğ
¬gc
;

85 
¥
 = (*)((
ušŒ_t
)sp - (uintptr_t)sp%16);

86 *--
¥
 = 0;

87 
uı
->
uc_mcÚ‹xt
.
mc_r
 = ()
func
;

88 
uı
->
uc_mcÚ‹xt
.
mc_r¥
 = ()
¥
;

89 
	}
}

92 #ifdeà
NEEDARMMAKECONTEXT


93 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uc
, (*
â
)(), 
¬gc
, ...)

95 
i
, *
¥
;

96 
va_li¡
 
¬g
;

98 
¥
 = (*)
uc
->
uc_¡ack
.
ss_¥
+uc->uc_¡ack.
ss_size
/4;

99 
	`va_¡¬t
(
¬g
, 
¬gc
);

101 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r0
 = 
	`va_¬g
(
¬g
, 
ušt
);

102 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r1
 = 
	`va_¬g
(
¬g
, 
ušt
);

103 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r2
 = 
	`va_¬g
(
¬g
, 
ušt
);

104 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r3
 = 
	`va_¬g
(
¬g
, 
ušt
);

106 
	`va_’d
(
¬g
);

107 
uc
->
uc_mcÚ‹xt
.
¬m_¥
 = (
ušt
)
¥
;

108 
uc
->
uc_mcÚ‹xt
.
¬m_Ì
 = (
ušt
)
â
;

109 
	}
}

112 #ifdeà
NEEDSWAPCONTEXT


113 
	$sw­cÚ‹xt
(
ucÚ‹xt_t
 *
ouı
, cÚ¡ ucÚ‹xt_ˆ*
uı
)

115 if(
	`g‘cÚ‹xt
(
ouı
) == 0) {

116 
	`£tcÚ‹xt
(
uı
);

120 
	}
}

	@src/task/fd.c

1 
	~"skim¶.h
"

2 
	~<zmq.h
>

3 
	~<sys/pŞl.h
>

4 
	~<fú.h
>

5 
	~<¡dio.h
>

6 
	~<sigÇl.h
>

7 
	~<sys/sock‘.h
>

9 
	~"su³½Şl.h
"

10 
	~"dbg.h
"

11 
	~"£‰šg.h
"

12 
	~"»gi¡”.h
"

15 
	gSTARTED_FDTASK
 = 0;

16 
Taskli¡
 
	g¦“pšg
;

17 
	g¦“pšgcouÁed
;

18 
uvlÚg
 
n£c
();

19 
Su³rPŞl
 *
	gPOLL
 = 
NULL
;

20 
Task
 *
	gFDTASK
;

22 *
	gZMQ_CTX
 = 
NULL
;

24 
	gFDSTACK
= 100 * 1024;

26 #iâdeà
MSG_NOSIGNAL


27 
	#MSG_NOSIGNAL
 0

	)

30 
	$mqš™
(
th»ads
)

32 if(
ZMQ_CTX
 =ğ
NULL
) {

33 
ZMQ_CTX
 = 
	`zmq_š™
(
th»ads
);

35 if(!
ZMQ_CTX
) {

36 
	`´štf
("Error setting up 0mq.\n");

37 
	`ex™
(1);

40 
	}
}

42 
šlše
 
	$Ãxt_sk_¦“±ime
(
mš
)

44 
Task
 *
t
;

45 
uvlÚg
 
now
 = 0;

46 
ms
 = 0;

48 if((
t
=
¦“pšg
.
h—d
è=ğ
NULL
)

49 
ms
 = -1;

51 
now
 = 
	`n£c
();

52 if(
now
 >ğ
t
->
®¬mtime
) {

53 
ms
 = 0;

55 
ms
 = (
t
->
®¬mtime
 - 
now
) / 1000000;

58 if(
ms
 % 
mš
 != 0) ms = ms - (ms % min);

61 if(
ms
 =ğ0èm ğ
mš
;

63  
ms
;

64 
	}
}

66 
šlše
 
	$wake_¦“³rs
()

68 
Task
 *
t
;

69 
uvlÚg
 
now
 = 
	`n£c
();

71 (
t
 =
¦“pšg
.
h—d
è&& 
now
 >ğt->
®¬mtime
){

72 
	`d–sk
(&
¦“pšg
, 
t
);

74 if(!
t
->
sy¡em
 && --
¦“pšgcouÁed
 =ğ0è
skcouÁ
--;

76 
	`sk»ady
(
t
);

78 
	}
}

80 
šlše
 
	$fdsk_shutdown
()

82 
i
 = 0;

84 
i
 = 0; i < 
	`Su³rPŞl_aùive_hÙ
(
POLL
); i++) {

85 
	`Su³rPŞl_com·ù_down
(
POLL
, 
i
);

89 
Task
 *
t
 = 
NULL
;

90 (
t
 = 
¦“pšg
.
h—d
)){

91 
	`d–sk
(&
¦“pšg
, 
t
);

92 
	`sksigÇl
(
t
, 
	`sk_was_sigÇËd
());

94 
	}
}

96 
	$fdsk
(*
v
)

98 
i
, 
ms
;

99 
PŞlResuÉ
 
»suÉ
;

100 
rc
 = 0;

101 
FDTASK
 = 
	`sk£lf
();

103 
rc
 = 
	`PŞlResuÉ_š™
(
POLL
, &
»suÉ
);

104 
	`check
(
rc
 == 0, "Failedo initializehe…oll„esult.");

106 
	`sksy¡em
();

107 
	`skÇme
("fdtask");

111 
	`sky›ld
() > 0)

115 
”ºo
 = 0;

116 
	`sk¡©e
("poll");

118 
ms
 = 
	`Ãxt_sk_¦“±ime
(500);

120 if(
	`sk_was_sigÇËd
()) {

121 
	`fdsk_shutdown
();

122 
	`sk_ş—r_sigÇl
();

125 
rc
 = 
	`Su³rPŞl_pŞl
(
POLL
, &
»suÉ
, 
ms
);

126 
	`check
(
rc
 != -1, "SuperPoll failure,‡borting.");

128 
i
 = 0; i < 
rc
; i++) {

129 
	`sk»ady
(
»suÉ
.
h™s
[
i
].
d©a
);

132 
	`wake_¦“³rs
();

137 
	`PŞlResuÉ_ş—n
(&
»suÉ
);

138 
FDTASK
 = 
NULL
;

141 
”rÜ
:

142 
	`skex™®l
(1);

143 
	}
}

147 
šlše
 
	$¡¬tfdsk
()

149 if(!
STARTED_FDTASK
) {

150 
FDSTACK
 = 
	`S‘tšg_g‘_št
("limits.fdtask_stack", 100 * 1024);

151 
	`log_šfo
("MAX†im™s.fdsk_¡ack=%d", 
FDSTACK
);

153 
POLL
 = 
	`Su³rPŞl_ü—‹
();

154 
STARTED_FDTASK
 = 1;

155 
	`skü—‹
(
fdsk
, 0, 
FDSTACK
);

157 
	}
}

159 
	$skwa™šg
()

161 
	`¡¬tfdsk
();

163  
	`Su³rPŞl_aùive_couÁ
(
POLL
);

164 
	}
}

167 
ušt
 
	$skd–ay
(
ušt
 
ms
)

169 
uvlÚg
 
wh’
 = 0L;

170 
uvlÚg
 
now
 = 0L;

171 
Task
 *
t
 = 
NULL
;

173 
	`¡¬tfdsk
();

175 
now
 = 
	`n£c
();

176 
wh’
 = 
now
 + (
uvlÚg
)
ms
 * 1000000;

177 
t
=
¦“pšg
.
h—d
; !ğ
NULL
 &&->
®¬mtime
 < 
wh’
;ñ->
Ãxt
)

180 if(
t
) {

181 
skruÂšg
->
´ev
 = 
t
->prev;

182 
skruÂšg
->
Ãxt
 = 
t
;

184 
skruÂšg
->
´ev
 = 
¦“pšg
.

;

185 
skruÂšg
->
Ãxt
 = 
NULL
;

188 
t
 = 
skruÂšg
;

189 
t
->
®¬mtime
 = 
wh’
;

191 if(
t
->
´ev
) {

192 
t
->
´ev
->
Ãxt
 =;

194 
¦“pšg
.
h—d
 = 
t
;

197 if(
t
->
Ãxt
) {

198 
t
->
Ãxt
->
´ev
 =;

200 
¦“pšg
.

 = 
t
;

203 if(!
t
->
sy¡em
 && 
¦“pšgcouÁed
++ == 0) {

204 
skcouÁ
++;

207 
	`sksw™ch
();

209  (
	`n£c
(è- 
now
) / 1000000;

210 
	}
}

212 
	$_wa™
(*
sock‘
, 
fd
, 
rw
)

214 
	`¡¬tfdsk
();

215 
	`check
(
sock‘
 !ğ
NULL
 || 
fd
 >= 0, "Attempto wait on‡ dead socket/fd: %p or %d", socket, fd);

217 
max
 = 0;

218 
hÙ_add
 = 
	`Su³rPŞl_aùive_hÙ
(
POLL
è< 
	`Su³rPŞl_max_hÙ
(POLL);

219 
was_»gi¡”ed
 = 0;

221 if(
sock‘
 !ğ
NULL
) {

222 
	`sk¡©e
(
rw
 == 'r' ? "read handler" : "write handler");

224 
was_»gi¡”ed
 = 
	`Regi¡”_fd_exi¡s
(
fd
è!ğ
NULL
;

225 
	`sk¡©e
(
rw
 == 'r' ? "read fd" : "write fd");

228 
max
 = 
	`Su³rPŞl_add
(
POLL
, (*)
skruÂšg
, 
sock‘
, 
fd
, 
rw
, 
hÙ_add
);

229 
	`check
(
max
 !ğ-1, "E¼Ü‡ddšg fd: %d o¸sock‘: %°tØsk wa™†i¡.", 
fd
, 
sock‘
);

231 
	`sksw™ch
();

233 if(
	`sk_was_sigÇËd
()) {

234 
	`debug
("GOT SIGNAL %d AFTER WAIT", 
skruÂšg
->
sigÇl
);

235 
	`Su³rPŞl_d–
(
POLL
, 
sock‘
, 
fd
, 
hÙ_add
);

237 } if(
was_»gi¡”ed
 && 
	`Regi¡”_fd_exi¡s
(
fd
è=ğ
NULL
) {

238 
	`debug
("Sock‘ %d wa şo£d‡á”‡ wa™.", 
fd
);

244 
”rÜ
:

246 
	}
}

248 
	$fdwa™
(
fd
, 
rw
)

250  
	`_wa™
(
NULL
, 
fd
, 
rw
);

251 
	}
}

253 *
	$mqsock‘
(
ty³
)

255 *
sock
 = 
	`zmq_sock‘
(
ZMQ_CTX
, 
ty³
);

256 
	`check
(
sock
 !ğ
NULL
, "Failedo create zmq socket.");

258 #ifdeà
ZMQ_LINGER


259 
İt
 = 0;

260 
rc
 = 
	`zmq_£tsockİt
(
sock
, 
ZMQ_LINGER
, &
İt
, (opt));

261 
	`check
(
rc
 == 0, "Failedo set†ingerimeout for socket.");

264  
sock
;

266 
”rÜ
:

267 if(
sock
è
	`zmq_şo£
(sock);

268  
NULL
;

269 
	}
}

271 
	$mqwa™
(*
sock‘
, 
rw
)

273  
	`_wa™
(
sock‘
, -1, 
rw
);

274 
	}
}

276 
	$mq»cv
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
)

278 
rc
 = -1;

281 
rc
 = 
	`zmq_»cv
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

284 
rc
 !ğ0 && 
æags
 !ğ
ZMQ_NOBLOCK
 && 
”ºo
 =ğ
EAGAIN
) {

285 if(
	`mqwa™
(
sock‘
, 'r') == -1) {

289 
rc
 = 
	`zmq_»cv
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

292  
rc
;

293 
	}
}

295 
	$mq£nd
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
)

297 
rc
 = -1;

300 
rc
 = 
	`zmq_£nd
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

303 
rc
 !ğ0 && 
æags
 !ğ
ZMQ_NOBLOCK
 && 
”ºo
 =ğ
EAGAIN
) {

304 if(
	`mqwa™
(
sock‘
, 'w') == -1) {

308 
rc
 = 
	`zmq_£nd
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

311  
rc
;

312 
	}
}

316 
	$fd»ad1
(
fd
, *
buf
, 
n
)

318 
m
;

321 if(
	`fdwa™
(
fd
, 'r') == -1) {

324 } (
m
 = 
	`»ad
(
fd
, 
buf
, 
n
)è< 0 && 
”ºo
 =ğ
EAGAIN
);

326  
m
;

327 
	}
}

329 
	$fd»cv1
(
fd
, *
buf
, 
n
)

331 
m
;

334 if(
	`fdwa™
(
fd
, 'r') == -1) {

337 } (
m
 = 
	`»cv
(
fd
, 
buf
, 
n
, 
MSG_NOSIGNAL
)è< 0 && 
”ºo
 =ğ
EAGAIN
);

339  
m
;

340 
	}
}

342 
	$fd»ad
(
fd
, *
buf
, 
n
)

344 
m
;

346 (
m
=
	`»ad
(
fd
, 
buf
, 
n
)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

347 if(
	`fdwa™
(
fd
, 'r') == -1) {

351  
m
;

352 
	}
}

354 
	$fd»cv
(
fd
, *
buf
, 
n
)

356 
m
;

358 (
m
=
	`»cv
(
fd
, 
buf
, 
n
, 
MSG_NOSIGNAL
)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

359 if(
	`fdwa™
(
fd
, 'r') == -1) {

363  
m
;

364 
	}
}

366 
	$fdwr™e
(
fd
, *
buf
, 
n
)

368 
m
 = 0;

369 
tÙ
 = 0;

371 
tÙ
 = 0;Ù < 
n
;Ù +ğ
m
){

372 (
m
=
	`wr™e
(
fd
, (*)
buf
+
tÙ
, 
n
-tÙ)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

373 if(
	`fdwa™
(
fd
, 'w') == -1) {

378 if(
m
 < 0)  m;

379 if(
m
 == 0) ;

382  
tÙ
;

383 
	}
}

385 
	$fd£nd
(
fd
, *
buf
, 
n
)

387 
m
 = 0;

388 
tÙ
 = 0;

390 
tÙ
 = 0;Ù < 
n
;Ù +ğ
m
){

391 (
m
=
	`£nd
(
fd
, (*)
buf
+
tÙ
, 
n
-tÙ, 
MSG_NOSIGNAL
)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

392 if(
	`fdwa™
(
fd
, 'w') == -1) {

397 if(
m
 < 0)  m;

398 if(
m
 == 0) ;

400  
tÙ
;

401 
	}
}

403 
	$fdnoblock
(
fd
)

405 #ifdeà
SO_NOSIGPIPE


406 
£t
 = 1;

407 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_NOSIGPIPE
, (*)&
£t
, ());

410  
	`fú
(
fd
, 
F_SETFL
, fú(fd, 
F_GETFL
)|
O_NONBLOCK
);

411 
	}
}

413 
uvlÚg
 
	$n£c
()

415 
timev®
 
tv
;

417 if(
	`g‘timeofday
(&
tv
, 0) < 0) {

421  (
uvlÚg
)
tv
.
tv_£c
*1000*1000*1000 +v.
tv_u£c
*1000;

422 
	}
}

	@src/task/net.c

1 
	~"skim¶.h
"

2 
	~"dbg.h
"

3 
	~"£rv”.h
"

4 
	~<sys/ty³s.h
>

5 
	~<sys/sock‘.h
>

6 
	~<Ãtdb.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<Ãtš‘/tı.h
>

9 
	~<sys/pŞl.h
>

10 
	~<¡dio.h
>

11 
	~<¬·/š‘.h
>

26 
	mCB_BIND
 = 0,

27 
	mCB_CONNECT


30 
	gMAX_LISTEN_BACKLOG
 = 128;

31 
	gSET_NODELAY
 = 1;

33 
	$addr_Áİ
(*
sšx
, *
rg‘
, 
size
)

35 
sockaddr_š6
 *
sš6
 = 
sšx
;

36 
sockaddr_š
 *
sš
 = 
sšx
;

38 if(
sš6
->
sš6_çmy
 =ğ
AF_INET6
) {

39 
	`š‘_Áİ
(
AF_INET6
, &
sš6
->
sš6_addr
, 
rg‘
, 
size
);

41 
	`š‘_Áİ
(
AF_INET
, &
sš
->
sš_addr
, 
rg‘
, 
size
);

43 
	}
}

45 
	$cb_bšd
(
fd
, 
i¡ı
, 
sockaddr
 *
p§
, 
size_t
 
sz
)

47 
n
 = 0;

48 
sockËn_t
 
¢
 = (
n
);

49 
¡r
[
IPADDR_SIZE
+1];

50 
rc
 = 0;

52 
	`addr_Áİ
(
p§
, 
¡r
, 
IPADDR_SIZE
);

53 
	`debug
("BšdšgØ%s:%d!", 
¡r
, 
	`Áohs
(((
sockaddr_š6
*)
p§
)->
sš6_pÜt
));

56 if(
i¡ı
 && 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_TYPE
, (*)&
n
, &
¢
) >= 0){

57 
n
 = 1;

58 
rc
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
n
, ‚);

59 
	`check
(
rc
 != -1, "Failedo set bind socketo SO_REUSEADDR,hat's messed up.");

62 
rc
 = 
	`bšd
(
fd
, 
p§
, 
sz
);

63 
	`check
(
rc
 != -1, "Failedo bindo‡ddress.");

65 if(
i¡ı
) {

66 
rc
 = 
	`li¡’
(
fd
, 
MAX_LISTEN_BACKLOG
);

67 
	`check
(
rc
 !ğ-1, "FaedØli¡’ w™h %d backlog", 
MAX_LISTEN_BACKLOG
);

70  
fd
;

72 
”rÜ
:

73 
	`sk¡©e
("bind failed");

74 
	`fdşo£
(
fd
);

76 
	}
}

78 
	$cb_cÚÃù
(
fd
, 
i¡ı
, 
sockaddr
 *
p§
, 
sockËn_t
 
¢
)

80 
n
 = 0;

81 
rc
 = 0;

84 if(!
i¡ı
) {

85 
n
 = 1;

86 
rc
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_BROADCAST
, &
n
, ‚);

87 
	`check
(
rc
 != -1, "Failedo set SO_BROADCAST on UDP socket.");

91 
rc
 = 
	`cÚÃù
(
fd
, 
p§
, 
¢
);

92 
	`check
(
rc
 !ğ-1 || 
”ºo
 =ğ
EINPROGRESS
, "Connect failed.");

95 
rc
 = 
	`fdwa™
(
fd
, 'w');

96 
	`check
(
rc
 != -1, "Failed waiting on‚on-blocking connect.");

98 
¢
 =  *
p§
;

99 
rc
 = 
	`g‘³”Çme
(
fd
, 
p§
, &
¢
);

100 
	`check_debug
(
rc
 != -1, "Connection failed,ƒither…ort isn't open or…eername isn't‡vailable.");

102  
fd
;

105 
”rÜ
:

107 
¢
 =  
n
;

108 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
n
, &
¢
);

109 
”ºo
 = 
n
 =ğ0 ? 
ECONNREFUSED
 :‚;

111 
	`fdşo£
(
fd
);

112 
	`sk¡©e
("connect failed");

115 
	}
}

118 
	$Ãtg‘sock‘
(
i¡ı
, *
£rv”
, 
pÜt
,

119 
is_aùive_İ’
)

121 
rc
 = 0;

122 
fd
 = -1;

123 
´Ùo
 = 
i¡ı
 ? 
SOCK_STREAM
 : 
SOCK_DGRAM
;

124 
¡r
[
IPADDR_SIZE
+1];

125 
addršfo
 *
»s
 = 
NULL
, *
»s§ve
 = NULL;

126 
·ssive
 = 
is_aùive_İ’
 && 
£rv”
 =ğ
NULL
 ? 0 : 
AI_PASSIVE
;

127 
num”ic
 = 
is_aùive_İ’
 ? 0 : 
AI_NUMERICHOST
;

129 
addršfo
 
hšts
 = {

130 .
ai_sockty³
 = 
´Ùo
,

131 .
ai_æags
 = 
num”ic
 | 
·ssive


135 
£rviû
[6] = {0};

137 
	`check
(
pÜt
 >= 0 &&…ort <= 65535, "Port %d is outsid‡llowed„ange.",…ort);

139 
	`debug
("Attempting‚etgetsocket: %d, %s:%d,‡ctive: %d",

140 
i¡ı
, 
£rv”
, 
pÜt
,

141 
is_aùive_İ’
);

143 
´Ùo
 = 
i¡ı
 ? 
SOCK_STREAM
 : 
SOCK_DGRAM
;

145 
hšts
.
ai_sockty³
 = 
´Ùo
;

148 
	`¢´štf
(
£rviû
, (£rviû), "%d", 
pÜt
);

149 
£rviû
[(service) - 1] = '\0';

151 
rc
 = 
	`g‘addršfo
(
£rv”
, 
£rviû
, &
hšts
, &
»s
);

152 
	`check
(
rc
 !ğ-1, "G‘‡ddršfØçed fÜ s”v”: %s.", 
£rv”
);

154 
»s§ve
 = 
»s
;

156 
	`debug
("Enumeratingargets...");

157 ; 
»s
;„e ğ»s->
ai_Ãxt
) {

158 
	`addr_Áİ
(
»s
->
ai_addr
, 
¡r
, 
IPADDR_SIZE
);

159 
	`debug
("Tryšg¬g‘: %s:%d,‡à%d,…rÙ %d", 
¡r
,

160 
	`Áohs
(((
sockaddr_š6
*)(
»s
->
ai_addr
))->
sš6_pÜt
),„es->
ai_çmy
,

161 
»s
->
ai_´ÙocŞ
);

163 
fd
 = 
	`sock‘
(
»s
->
ai_çmy
,

164 
´Ùo
,

165 
»s
->
ai_´ÙocŞ
);

167 if(
fd
 < 0) {

168 
”ºo
) {

169 
EAFNOSUPPORT
:

171 
EPROTONOSUPPORT
:

173 
	`debug
("Famy %d‚Ù suµÜ‹d", 
»s
->
ai_çmy
);

176 
	`£Áš–
("Socket failureƒnumerating…ossible‡ddresses.");

179 
	`fdnoblock
(
fd
);

183 if(
is_aùive_İ’
) {

184 
fd
 = 
	`cb_cÚÃù
(fd, 
i¡ı
, (*)
»s
->
ai_addr
,„es->
ai_add¾’
);

186 
fd
 = 
	`cb_bšd
(fd, 
i¡ı
, (*è
»s
->
ai_addr
,„es->
ai_add¾’
);

189 if(
fd
 >= 0) {

195 if(
»s§ve
) {

196 
	`ä“addršfo
(
»s§ve
);

199  
fd
;

201 
”rÜ
:

202 if(
»s§ve
) {

203 
	`ä“addršfo
(
»s§ve
);

206 
	}
}

208 
	$ÃÂounû
(
i¡ı
, *
£rv”
, 
pÜt
)

210  
	`Ãtg‘sock‘
(
i¡ı
, 
£rv”
, 
pÜt
, 
CB_BIND
);

211 
	}
}

213 
	$Ãcû±
(
fd
, *
£rv”
, *
pÜt
)

215 
cfd
 = 0;

216 
İt
 = 0;

220 
sockaddr_š6
 
v6
;

221 
sockaddr_š
 
v4
;

222 } 
addr_cÚv”‹r
;

224 
sockËn_t
 
Ën
 = (
addr_cÚv”‹r
);

225 
rc
 = 0;

227 
cfd
 = 
	`acû±
(
fd
, (*)&
addr_cÚv”‹r
, &
Ën
);

229 if(
cfd
 == -1) {

230 if(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

231 
rc
 = 
	`fdwa™
(
fd
, 'r');

232 
	`check
(
rc
 != -1, "Failed waiting on‚on-block‡ccept.");

234 
cfd
 = 
	`acû±
(
fd
, (*)&
addr_cÚv”‹r
, &
Ën
);

235 
	`check
(
cfd
 != -1, "Failedo‡ccept‡fter doing‡…oll onhe socket.");

237 
	`£Áš–
("Faed c®lšg‡cû± oÀsock‘h© wa »ady: %d, %d", 
cfd
, 
”ºo
 =ğ
EAGAIN
);

241 if(
£rv”
) {

242 if(
addr_cÚv”‹r
.
v6
.
sš6_çmy
 =ğ
AF_INET
) {

243 
	`check
(
	`š‘_Áİ
(
addr_cÚv”‹r
.
v4
.
sš_çmy
, &addr_cÚv”‹r.v4.
sš_addr
, 
£rv”
, 
IPADDR_SIZE
è!ğ
NULL
,

246 
	`check
(
	`š‘_Áİ
(
addr_cÚv”‹r
.
v6
.
sš6_çmy
, &addr_cÚv”‹r.v6.
sš6_addr
, 
£rv”
, 
IPADDR_SIZE
è!ğ
NULL
,

251 if(
pÜt
) {

252 if(
addr_cÚv”‹r
.
v6
.
sš6_çmy
 =ğ
AF_INET
) {

253 *
pÜt
 = 
	`Áohs
(
addr_cÚv”‹r
.
v4
.
sš_pÜt
);

255 *
pÜt
 = 
	`Áohs
(
addr_cÚv”‹r
.
v6
.
sš6_pÜt
);

259 
	`fdnoblock
(
cfd
);

261 if(
SET_NODELAY
) {

262 
İt
 = 1;

263 
	`£tsockİt
(
cfd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
İt
,  opt);

266 
	`sk¡©e
("netaccept succeeded");

267  
cfd
;

269 
”rÜ
:

270 
	`sk¡©e
("accept failed");

272 
	}
}

275 
	$ÃtdŸl
(
i¡ı
, *
£rv”
, 
pÜt
)

277  
	`Ãtg‘sock‘
(
i¡ı
, 
£rv”
, 
pÜt
, 
CB_CONNECT
);

278 
	}
}

	@src/task/power-ucontext.h

1 
	#£tcÚ‹xt
(
u
è
	`_£tmcÚ‹xt
(&(u)->
mc
)

	)

2 
	#g‘cÚ‹xt
(
u
è
	`_g‘mcÚ‹xt
(&(u)->
mc
)

	)

3 
mcÚ‹xt
 
	tmcÚ‹xt_t
;

4 
ucÚ‹xt
 
	tucÚ‹xt_t
;

5 
	smcÚ‹xt


7 
ulÚg
 
	mpc
;

8 
ulÚg
 
	mü
;

9 
ulÚg
 
	mùr
;

10 
ulÚg
 
	mx”
;

11 
ulÚg
 
	m¥
;

12 
ulÚg
 
	mtoc
;

13 
ulÚg
 
	mr3
;

14 
ulÚg
 
	mg´
[19];

23 
	sucÚ‹xt


26 *
	mss_¥
;

27 
ušt
 
	mss_size
;

28 } 
	muc_¡ack
;

29 
sig£t_t
 
	muc_sigmask
;

30 
mcÚ‹xt_t
 
	mmc
;

33 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

34 
	`sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

35 
	`_g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

36 
	`_£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

	@src/task/qlock.c

1 
	~"skim¶.h
"

2 
	~"dbg.h
"

7 
	$_qlock
(
QLock
 *
l
, 
block
)

9 if(
l
->
owÃr
 =ğ
NULL
){

10 
l
->
owÃr
 = 
skruÂšg
;

14 if(!
block
) {

18 
	`addsk
(&
l
->
wa™šg
, 
skruÂšg
);

19 
	`sk¡©e
("qlock");

20 
	`sksw™ch
();

22 
	`as£¹
(
l
->
owÃr
 =ğ
skruÂšg
 && "qlockƒrror, owner is‚othe„unningask");

25 
	}
}

27 
	$qlock
(
QLock
 *
l
)

29 
	`_qlock
(
l
, 1);

30 
	}
}

32 
	$ÿnqlock
(
QLock
 *
l
)

34  
	`_qlock
(
l
, 0);

35 
	}
}

37 
	$quÆock
(
QLock
 *
l
)

39 
Task
 *
»ady
 = 
NULL
;

41 
	`as£¹
(
l
->
owÃr
 != 0 && "qunlock: owner == 0\n");

43 if((
l
->
owÃr
 = 
»ady
 =†->
wa™šg
.
h—d
è!ğ
NULL
) {

44 
	`d–sk
(&
l
->
wa™šg
, 
»ady
);

45 
	`sk»ady
(
»ady
);

47 
	}
}

49 
	$_¾ock
(
RWLock
 *
l
, 
block
)

51 if(
l
->
wr™”
 =ğ
NULL
 &&†->
wwa™šg
.
h—d
 == NULL){

52 
l
->
»ad”s
++;

56 if(!
block
) {

60 
	`addsk
(&
l
->
rwa™šg
, 
skruÂšg
);

61 
	`sk¡©e
("rlock");

62 
	`sksw™ch
();

65 
	}
}

67 
	$¾ock
(
RWLock
 *
l
)

69 
	`_¾ock
(
l
, 1);

70 
	}
}

72 
	$ÿÄlock
(
RWLock
 *
l
)

74  
	`_¾ock
(
l
, 0);

75 
	}
}

77 
	$_wlock
(
RWLock
 *
l
, 
block
)

79 if(
l
->
wr™”
 =ğ
NULL
 &&†->
»ad”s
 == 0) {

80 
l
->
wr™”
 = 
skruÂšg
;

84 if(!
block
) {

88 
	`addsk
(&
l
->
wwa™šg
, 
skruÂšg
);

89 
	`sk¡©e
("wlock");

90 
	`sksw™ch
();

92 
	}
}

94 
	$wlock
(
RWLock
 *
l
)

96 
	`_wlock
(
l
, 1);

97 
	}
}

99 
	$ÿnwlock
(
RWLock
 *
l
)

101  
	`_wlock
(
l
, 0);

102 
	}
}

104 
	$ruÆock
(
RWLock
 *
l
)

106 
Task
 *
t
 = 
NULL
;

108 if(--
l
->
»ad”s
 =ğ0 && (
t
 =†->
wwa™šg
.
h—d
è!ğ
NULL
) {

109 
	`d–sk
(&
l
->
wwa™šg
, 
t
);

110 
l
->
wr™”
 = 
t
;

111 
	`sk»ady
(
t
);

113 
	}
}

115 
	$wuÆock
(
RWLock
 *
l
)

117 
Task
 *
t
 = 
NULL
;

119 
	`as£¹
(
l
->
wr™”
 !ğ
NULL
 && "wunlock:‚ot†ocked.");

121 
l
->
wr™”
 = 
NULL
;

122 
	`as£¹
(
l
->
»ad”s
 == 0 && "wunlock:„eaders is wrong.");

124 (
t
 = 
l
->
rwa™šg
.
h—d
è!ğ
NULL
){

125 
	`d–sk
(&
l
->
rwa™šg
, 
t
);

126 
l
->
»ad”s
++;

127 
	`sk»ady
(
t
);

130 if(
l
->
»ad”s
 =ğ0 && (
t
 =†->
wwa™šg
.
h—d
è!ğ
NULL
){

131 
	`d–sk
(&
l
->
wwa™šg
, 
t
);

132 
l
->
wr™”
 = 
t
;

133 
	`sk»ady
(
t
);

135 
	}
}

	@src/task/rendez.c

1 
	~"skim¶.h
"

6 
	$sk¦“p
(
R’dez
 *
r
)

8 
	`addsk
(&
r
->
wa™šg
, 
skruÂšg
);

10 if(
r
->
l
) {

11 
	`quÆock
(
r
->
l
);

14 
	`sk¡©e
("sleep");

15 
	`sksw™ch
();

17 if(
r
->
l
) {

18 
	`qlock
(
r
->
l
);

20 
	}
}

22 
	$_skwakeup
(
R’dez
 *
r
, 
®l
)

24 
i
;

25 
Task
 *
t
;

27 
i
=0;; i++){

28 if(
i
==1 && !
®l
) {

32 if((
t
 = 
r
->
wa™šg
.
h—d
è=ğ
NULL
) {

36 
	`d–sk
(&
r
->
wa™šg
, 
t
);

37 
	`sk»ady
(
t
);

40  
i
;

41 
	}
}

43 
	$skwakeup
(
R’dez
 *
r
)

45  
	`_skwakeup
(
r
, 0);

46 
	}
}

48 
	$skwakeu·Î
(
R’dez
 *
r
)

50  
	`_skwakeup
(
r
, 1);

51 
	}
}

53 
	$skb¬r›r
(
R’dez
 *
r
)

55 
n
 = 
	`skwakeu·Î
(
r
);

57 if(!
n
) {

58 
	`sk¦“p
(
r
);

61  
n
;

62 
	}
}

	@src/task/task.c

3 
	~"skim¶.h
"

4 
	~<fú.h
>

5 
	~<¡dio.h
>

6 
	~"dbg.h
"

7 
	~"Š‘¡ršgs.h
"

8 
	~"Š‘¡ršgs_im¶.h
"

10 
	gskcouÁ
;

11 
	gsknsw™ch
;

12 
	gskex™v®
;

13 
Task
 *
	gskruÂšg
;

15 
CÚ‹xt
 
	gskschedcÚ‹xt
;

16 
Taskli¡
 
	gskrunqueue
;

19 
	mTASK_LIST_GROWTH
=256

22 
Task
 **
	g®Éask
;

23 
	gÇÎsk
;

25 
cÚ‹xtsw™ch
(
CÚ‹xt
 *
äom
, CÚ‹xˆ*
to
);

27 
	$sk¡¬t
(
ušt
 
y
, ušˆ
x
)

29 
Task
 *
t
;

30 
ulÚg
 
z
;

32 
z
 = 
x
<<16;

33 
z
 <<= 16;

34 
z
 |ğ
y
;

35 
t
 = (
Task
*)
z
;

37 
t
->
	`¡¬tâ
Ñ->
¡¬rg
);

38 
	`skex™
(0);

39 
	}
}

41 
	gskidg’
;

43 
Task
* 
sk®loc
((*
â
)(*), *
¬g
, 
ušt
 
¡ack
)

45 
Task
 *
t
 = 
NULL
;

46 
sig£t_t
 
z”o
;

47 
ušt
 
x
 = 0;

48 
ušt
 
y
 = 0;

49 
ulÚg
 
z
 = 0L;

52 
t
 = 
	`ÿÎoc
((
Task
è+ 
¡ack
, 1);

53 
	`check_mem
(
t
);

55 
t
->
¡k
 = (
uch¬
*)(t+1);

56 
t
->
¡ksize
 = 
¡ack
;

57 
t
->
id
 = ++
skidg’
;

58 
t
->
¡¬tâ
 = 
â
;

59 
t
->
¡¬rg
 = 
¬g
;

62 
	`sigem±y£t
(&
z”o
);

63 
	`sig´ocmask
(
SIG_BLOCK
, &
z”o
, &
t
->
cÚ‹xt
.
uc
.
uc_sigmask
);

66 
	`check
(
	`g‘cÚ‹xt
(&
t
->
cÚ‹xt
.
uc
) >= 0, "getcontext failed.");

70 
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_¥
 = (*é->
¡k
+8;

71 
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_size
 =->
¡ksize
-64;

73 #ià
	`defšed
(
__sun__
è&& !defšed(
__MAKECONTEXT_V2_SOURCE
)

76 
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_¥
 =

77 (*)
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_¥


78 +
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_size
;

86 
z
 = (
ulÚg
)
t
;

87 
y
 = 
z
;

88 
z
 >>= 16;

89 
x
 = 
z
>>16;

91 
	`makecÚ‹xt
(&
t
->
cÚ‹xt
.
uc
, ((*)())
sk¡¬t
, 2, 
y
, 
x
);

93  
t
;

95 
”rÜ
:

96 
	`abÜt
();

97 
	}
}

99 
skü—‹
((*
â
)(*), *
¬g
, 
ušt
 
¡ack
)

101 
Task
 *
t
 = 
	`sk®loc
(
â
, 
¬g
, 
¡ack
);

102 
id
 = 
t
->id;

104 
skcouÁ
++;

106 if(
ÇÎsk
 % 
TASK_LIST_GROWTH
 == 0){

107 
®Éask
 = 
	`»®loc
×Îsk, (
ÇÎsk
 + 
TASK_LIST_GROWTH
)*(alltask[0]));

108 
	`check_mem
(
®Éask
);

111 
t
->
®Éask¦Ù
 = 
ÇÎsk
;

112 
®Éask
[
ÇÎsk
++] = 
t
;

113 
	`sk»ady
(
t
);

115  
id
;

117 
”rÜ
:

119 
	}
}

121 
	$sksy¡em
()

123 if(!
skruÂšg
->
sy¡em
) {

124 
skruÂšg
->
sy¡em
 = 1;

125 --
skcouÁ
;

127 
	}
}

129 
	$sksw™ch
()

131 
	`Ãed¡ack
(0);

132 
	`cÚ‹xtsw™ch
(&
skruÂšg
->
cÚ‹xt
, &
skschedcÚ‹xt
);

133 
	}
}

135 
	$sk»ady
(
Task
 *
t
)

137 
t
->
»ady
 = 1;

138 
	`addsk
(&
skrunqueue
, 
t
);

139 
	}
}

141 
	$sky›ld
()

143 
n
 = 
sknsw™ch
;

144 
	`sk»ady
(
skruÂšg
);

145 
	`sk¡©e
("yield");

146 
	`sksw™ch
();

148  
sknsw™ch
 - 
n
 - 1;

149 
	}
}

151 
	$ªy»ady
()

153  
skrunqueue
.
h—d
 !ğ
NULL
;

154 
	}
}

156 
	$skex™®l
(
v®
)

158 
	`ex™
(
v®
);

159 
	}
}

161 
	$skex™
(
v®
)

163 
skex™v®
 = 
v®
;

164 
skruÂšg
->
ex™šg
 = 1;

165 
	`sksw™ch
();

166 
	}
}

168 
	$cÚ‹xtsw™ch
(
CÚ‹xt
 *
äom
, CÚ‹xˆ*
to
)

170 if(
	`sw­cÚ‹xt
(&
äom
->
uc
, &
to
->uc) < 0){

171 
	`log_”r
("swapcontext failed.");

172 
	`abÜt
();

174 
	}
}

176 
	$sk¤uÂšg
()

178 
i
 = 0;

180 
	`debug
("Task ruÂšg‚®Éask=%d,askcouÁ=%d", 
ÇÎsk
, 
skcouÁ
);

181 
i
 = 0; i < 
ÇÎsk
; i++) {

182 
	`debug
("RUNNING id=%d:%p", 
®Éask
[
i
]->
id
,‡lltask[i]);

185  
ÇÎsk
;

186 
	}
}

189 
	$skscheduËr
()

191 
i
 = 0;

192 
Task
 *
t
 = 
NULL
;

195 if(
skcouÁ
 == 0) {

196 
	`ex™
(
skex™v®
);

199 
t
 = 
skrunqueue
.
h—d
;

201 if(
t
 =ğ
NULL
) {

202 
	`debug
("NÙhšg„uÂabË, h”e' thsk th©‡» sÎed (%d,%d):", 
ÇÎsk
, 
skcouÁ
);

203 
i
 = 0; i < 
ÇÎsk
; i++) {

204 
	`debug
("STALLED id=%d:%p", 
®Éask
[
i
]->
id
,‡lltask[i]);

208 
	`check
(
t
 !ğ
NULL
, "NØruÂabËasks, %dask ¡®Ëd", 
skcouÁ
);

210 
	`d–sk
(&
skrunqueue
, 
t
);

212 
t
->
»ady
 = 0;

213 
skruÂšg
 = 
t
;

214 
sknsw™ch
++;

216 
	`cÚ‹xtsw™ch
(&
skschedcÚ‹xt
, &
t
->
cÚ‹xt
);

217 
skruÂšg
 = 
NULL
;

219 if(
t
->
ex™šg
){

220 if(!
t
->
sy¡em
) {

221 
skcouÁ
--;

224 
i
 = 
t
->
®Éask¦Ù
;

225 
®Éask
[
i
] =‡Îsk[--
ÇÎsk
];

226 
®Éask
[
i
]->
®Éask¦Ù
 = i;

227 
	`debug
("FREEING TASK: %p", 
t
);

228 
	`ä“
(
t
);

232 
”rÜ
:

233 
	`abÜt
();

234 
	}
}

239 
	$skÇme
(*
Çme
)

241 
Ën
 = 
	`¡¾’
(
Çme
);

242 
	`memıy
(
skruÂšg
->
Çme
,‚ame, 
Ën
 < 
MAX_STATE_LENGTH
 ?†en : MAX_STATE_LENGTH);

243 
skruÂšg
->
Çme
[
Ën
] = '\0';

244 
	}
}

246 * 
	$skg‘Çme
()

248  
skruÂšg
->
Çme
;

249 
	}
}

252 
	$sk¡©e
(*
¡©e
)

254 
Ën
 = 
	`¡¾’
(
¡©e
);

255 
	`memıy
(
skruÂšg
->
¡©e
, s‹, 
Ën
 < 
MAX_STATE_LENGTH
 ?†en : MAX_STATE_LENGTH);

256 
skruÂšg
->
¡©e
[
Ën
] = '\0';

257 
	}
}

259 * 
	$skg‘¡©e
()

261  
skruÂšg
->
¡©e
;

262 
	}
}

264 
	$Ãed¡ack
(
n
)

266 
Task
 *
t
 = 
skruÂšg
;

268 if((*)&
t
 <ğ(*é->
¡k


269 || (*)&
t
 - (*é->
¡k
 < 256+
n
) {

270 
	`årštf
(
¡d”r
, "sk sck ov”æow: &t=%°t¡k=%°n=%d\n", &
t
,->
¡k
, 256+
n
);

272 
	}
}

274 
gb¡ršg
 
	gTASKINFO_HEADERS
 = 
bsStic
("38:2:id,6:system,4:name,5:state,6:status,]");

276 
Šs_v®ue_t
 *
	$skg‘šfo
()

278 
i
 = 0;

279 
Task
 *
t
 = 
NULL
;

280 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

281 * 
¡©us
 = 
NULL
;

283 
i
 = 0; i < 
ÇÎsk
; i++)

285 
t
 = 
®Éask
[
i
];

287 if(
t
 =ğ
skruÂšg
) {

288 
¡©us
 = "running";

289 } if(
t
->
»ady
) {

290 
¡©us
 = "ready";

291 } if(
t
->
ex™šg
) {

292 
¡©us
 = "exiting";

294 
¡©us
 = "idle";

297 
Šs_v®ue_t
 *
–
 = 
	`Šs_Ãw_li¡
();

298 
	`Šs_add_to_li¡
(
–
, 
	`Šs_Ãw_š‹g”
(
t
->
id
));

299 
	`Šs_add_to_li¡
(
–
, 
t
->
sy¡em
 ? 
	`Šs_g‘_Œue
(è: 
	`Šs_g‘_çl£
());

300 
	`Šs_add_to_li¡
(
–
, 
	`Šs_·r£_¡ršg
(
t
->
Çme
, 
	`¡¾’
(t->name)));

301 
	`Šs_add_to_li¡
(
–
, 
	`Šs_·r£_¡ršg
(
t
->
¡©e
, 
	`¡¾’
(t->state)));

302 
	`Šs_add_to_li¡
(
–
, 
	`Šs_·r£_¡ršg
(
¡©us
, 
	`¡¾’
(status)));

304 
	`Šs_add_to_li¡
(
rows
, 
–
);

307  
	`Šs_¡ªd¬d_bË
(&
TASKINFO_HEADERS
, 
rows
);

308 
	}
}

314 
	gsk¬gc
;

315 **
	gsk¬gv
;

316 #ià
defšed
(
__F»eBSD__
)

317 
	gMAINSTACKSIZE
 = 96 * 1024;

319 
	gMAINSTACKSIZE
 = 32 * 1024;

322 
	$skmaš¡¬t
(*
v
)

324 
	`skÇme
("taskmain");

325 
	`skmaš
(
sk¬gc
, 
sk¬gv
);

326 
	}
}

328 
	$maš
(
¬gc
, **
¬gv
)

330 
sk¬gc
 = 
¬gc
;

331 
sk¬gv
 = 
¬gv
;

333 
	`skü—‹
(
skmaš¡¬t
, 
NULL
, 
MAINSTACKSIZE
);

334 
	`skscheduËr
();

336 
	`årštf
(
¡d”r
, "taskscheduler„eturned in main!\n");

337 
	`abÜt
();

340 
	}
}

345 
	$addsk
(
Taskli¡
 *
l
, 
Task
 *
t
)

347 
Task
 *
‹¡
 = 
NULL
;

348 
‹¡
 = 
skrunqueue
.
h—d
;e¡ !ğ
NULL
;e¡ =e¡->
Ãxt
)

350 
	`as£¹
(
‹¡
 !ğ
t
 && "Fucking double‡ddtask mother fucker!");

353 if(
l
->

) {

354 
l
->

->
Ãxt
 = 
t
;

355 
t
->
´ev
 = 
l
->

;

357 
l
->
h—d
 = 
t
;

358 
t
->
´ev
 = 
NULL
;

361 
l
->

 = 
t
;

362 
t
->
Ãxt
 = 
NULL
;

363 
	}
}

365 
	$d–sk
(
Taskli¡
 *
l
, 
Task
 *
t
)

367 if(
t
->
´ev
) {

368 
t
->
´ev
->
Ãxt
 =->next;

370 
l
->
h—d
 = 
t
->
Ãxt
;

373 if(
t
->
Ãxt
) {

374 
t
->
Ãxt
->
´ev
 =->prev;

376 
l
->

 = 
t
->
´ev
;

379 
t
->
Ãxt
 = 
NULL
;

380 
t
->
´ev
 = 
NULL
;

381 
	}
}

383 
	$skid
()

385  
skruÂšg
->
id
;

386 
	}
}

389 
Task
 *
	$sk£lf
()

391  
skruÂšg
;

392 
	}
}

394 
	$skg‘id
(
Task
 *
sk
)

396  
sk
->
id
;

397 
	}
}

399 
	$sksigÇl
(
Task
 *
sk
, 
sigÇl
)

401 
	`check
(
sk
 !ğ
NULL
, "Task was NULL,hat's„eally bad.");

402 
	`check
(
sigÇl
 > 0, "Signal haso be greaterhan 0.");

404 
sk
->
sigÇl
 = signal;

405 
	`sk»ady
(
sk
);

408 
”rÜ
:

410 
	}
}

412 
	$sk®lsigÇl
(
sigÇl
)

414 
	`debug
("S’dšg %dØ®Èsks.", 
sigÇl
);

415 
i
 = 0;

416 
Task
 *
t
 = 
NULL
;

417 
	`check
(
sigÇl
 > 0, "Signal must be greaterhan 0.");

419 if(
FDTASK
 !ğ
NULL
) {

420 
	`debug
("MAKE THE FDTASK SIGNAL FIRST");

421 
FDTASK
->
sigÇl
 = signal;

422 
	`skd–ay
(1);

423 
	`debug
("BACK NOW CLEAR THE REST.");

427 
t
 = 
skrunqueue
.
h—d
; !ğ
NULL
 ; =->
Ãxt
) {

428 if(
t
 !ğ
FDTASK
 && !t->
ex™šg
 &&->
sigÇl
 == 0) {

429 
	`debug
("SIGNAL RUNNING: id=%d, %p", 
t
->
id
,);

430 
t
->
sigÇl
 = signal;

435 
i
 = 0; i < 
ÇÎsk
; i++)

437 
t
 = 
®Éask
[
i
];

439 if(
t
 !ğ
NULL
 && !t->
ex™šg
 && !ğ
skruÂšg
 &&->
sigÇl
 =ğ0 &&->
Ãxt
 =ğNULL &&->
´ev
 == NULL) {

440 
	`debug
("SIGNAL IDLE: id=%d, %p", 
t
->
id
,);

441 
t
->
sigÇl
 = signal;

442 
	`sk»ady
(
t
);

446 (
i
 = 
	`sky›ld
()) > 0) {

447 
	`debug
("BACK FROM THE FINAL SWITCH! TASK YIELD: %d", 
i
);

451 
”rÜ
:

453 
	}
}

455 
	$sk_was_sigÇËd
()

457  
skruÂšg
->
sigÇl
;

458 
	}
}

460 
	$sk_ş—r_sigÇl
()

462 
skruÂšg
->
sigÇl
 = 0;

463 
	}
}

	@src/task/task.h

3 #iâdeà
_TASK_H_


4 
	#_TASK_H_
 1

	)

6 #ifdeà
__ılu¥lus


10 
	~<¡d¬g.h
>

11 
	~<uni¡d.h
>

12 
	~<š‰y³s.h
>

13 
	~<zmq.h
>

15 
Šs_v®ue_t
;

21 
Task
 
	tTask
;

22 
Taskli¡
 
	tTaskli¡
;

24 
	#MAX_STATE_LENGTH
 30

	)

26 
ªy»ady
();

27 
skü—‹
((*
f
)(*
¬g
), *¬g, 
¡acksize
);

28 
skex™
();

29 
skex™®l
();

30 
skmaš
(
¬gc
, *
¬gv
[]);

31 
sky›ld
();

32 ** 
skd©a
();

33 
Ãed¡ack
();

34 
skÇme
(*);

35 
sk¡©e
(*);

36 * 
skg‘Çme
();

37 * 
skg‘¡©e
();

38 
Šs_v®ue_t
 *
skg‘šfo
();

39 
sksy¡em
();

40 
skd–ay
();

41 
skid
();

42 
skg‘id
(
Task
 *
sk
);

43 
skwa™šg
();

44 
sk¤uÂšg
();

45 
sk»ady
(
Task
 *
t
);

46 
Task
 *
sk£lf
();

47 
sksw™ch
();

49 
	sTaskli¡


51 
Task
 *
h—d
;

52 
Task
 *

;

57 
sksigÇl
(
Task
 *
sk
, 
sigÇl
);

58 
sk_was_sigÇËd
();

59 
sk_ş—r_sigÇl
();

60 
sk®lsigÇl
(
sigÇl
);

65 
QLock
 
	tQLock
;

66 
	sQLock


68 
Task
 *
owÃr
;

69 
Taskli¡
 
wa™šg
;

72 
qlock
(
QLock
*);

73 
ÿnqlock
(
QLock
*);

74 
quÆock
(
QLock
*);

79 
RWLock
 
	tRWLock
;

80 
	sRWLock


82 
»ad”s
;

83 
Task
 *
wr™”
;

84 
Taskli¡
 
rwa™šg
;

85 
Taskli¡
 
wwa™šg
;

88 
¾ock
(
RWLock
*);

89 
ÿÄlock
(
RWLock
*);

90 
ruÆock
(
RWLock
*);

92 
wlock
(
RWLock
*);

93 
ÿnwlock
(
RWLock
*);

94 
wuÆock
(
RWLock
*);

99 
R’dez
 
	tR’dez
;

101 
	sR’dez


103 
QLock
 *
l
;

104 
Taskli¡
 
wa™šg
;

107 
sk¦“p
(
R’dez
*);

108 
skwakeup
(
R’dez
*);

109 
skwakeu·Î
(
R’dez
*);

110 
skb¬r›r
(
R’dez
 *
r
);

117 
fd»ad
(, *, );

118 
fd»ad1
(, *, );

119 
fd»cv1
(, *, );

120 
fdwr™e
(, *, );

121 
fd£nd
(, *, );

122 
fd»cv
(, *, );

123 
fdwa™
(, );

124 
fdnoblock
();

126 
Task
 *
FDTASK
;

128 
	#fdşo£
(
fd
èif(fd >ğ0è
	`şo£
(fd)

	)

130 
fdsk
(*);

135 
mqš™
(
th»ads
);

136 *
mqsock‘
(
ty³
);

137 
mqwa™
(*
sock‘
, 
rw
);

138 
mq»cv
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
);

139 
mq£nd
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
);

141 *
ZMQ_CTX
;

148 
	gUDP
 = 0,

149 
	gTCP
 = 1,

152 
ÃÂounû
(, *, );

153 
Ãcû±
(, *, *);

154 
ÃtdŸl
(, *, );

155 
Ãookup
(*, 
ušt32_t
*);

157 #ifdeà
__ılu¥lus


	@src/task/taskimpl.h

3 #ià
defšed
(
__sun__
)

4 
	#__EXTENSIONS__
 1

	)

5 #ià
defšed
(
__SunOS5_6__
è|| defšed(
__SunOS5_7__
è|| defšed(
__SunOS5_8__
)

8 
	#__MAKECONTEXT_V2_SOURCE
 1

	)

12 
	#USE_UCONTEXT
 1

	)

14 #ià
defšed
(
__O³nBSD__
)

15 #undeà
USE_UCONTEXT


16 
	#USE_UCONTEXT
 0

	)

19 #ià
defšed
(
__APPLE__
)

20 
	~<Avaab™yMaüos.h
>

21 #ià
defšed
(
MAC_OS_X_VERSION_10_5
)

22 #undeà
USE_UCONTEXT


23 
	#USE_UCONTEXT
 0

	)

27 
	~<”ºo.h
>

28 
	~<¡dlib.h
>

29 
	~<uni¡d.h
>

30 
	~<¡ršg.h
>

31 
	~<as£¹.h
>

32 
	~<time.h
>

33 
	~<sys/time.h
>

34 
	~<sys/ty³s.h
>

35 
	~<sys/wa™.h
>

36 
	~<sched.h
>

37 
	~<sigÇl.h
>

38 #ià
USE_UCONTEXT


39 
	~<ucÚ‹xt.h
>

41 
	~<sys/ut¢ame.h
>

42 
	~<š‰y³s.h
>

43 
	~"sk.h
"

45 
	#ÃËm
(
x
è((x)/((x)[0]))

	)

47 
	#ulÚg
 
sk_ulÚg


	)

48 
	#ušt
 
sk_ušt


	)

49 
	#uch¬
 
sk_uch¬


	)

50 
	#ushÜt
 
sk_ushÜt


	)

51 
	#uvlÚg
 
sk_uvlÚg


	)

52 
	#vlÚg
 
sk_vlÚg


	)

54 
	tulÚg
;

55 
	tušt
;

56 
	tuch¬
;

57 
	tushÜt
;

58 
	tuvlÚg
;

59 
	tvlÚg
;

61 #ià
defšed
(
__F»eBSD__
) && __FreeBSD__ < 5

62 
g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

63 
£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

64 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

65 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

66 
sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

67 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

70 #ià
defšed
(
__APPLE__
)

71 
	#mcÚ‹xt
 
libth»ad_mcÚ‹xt


	)

72 
	#mcÚ‹xt_t
 
libth»ad_mcÚ‹xt_t


	)

73 
	#ucÚ‹xt
 
libth»ad_ucÚ‹xt


	)

74 
	#ucÚ‹xt_t
 
libth»ad_ucÚ‹xt_t


	)

75 #ià
defšed
(
__i386__
)

76 
	~"386-ucÚ‹xt.h
"

77 #–ià
defšed
(
__x86_64__
)

78 
	~"amd64-ucÚ‹xt.h
"

80 
	~"pow”-ucÚ‹xt.h
"

84 #ià
defšed
(
__O³nBSD__
)

85 
	#mcÚ‹xt
 
libth»ad_mcÚ‹xt


	)

86 
	#mcÚ‹xt_t
 
libth»ad_mcÚ‹xt_t


	)

87 
	#ucÚ‹xt
 
libth»ad_ucÚ‹xt


	)

88 
	#ucÚ‹xt_t
 
libth»ad_ucÚ‹xt_t


	)

89 #ià
defšed
 
__i386__


90 
	~"386-ucÚ‹xt.h
"

91 #–ià
defšed
(
__x86_64__
)

92 
	~"amd64-ucÚ‹xt.h
"

94 
	~"pow”-ucÚ‹xt.h
"

96 
pid_t
 
rfÜk_th»ad
(, *, (*)(*), *);

99 #ià0 && 
	`defšed
(
__sun__
)

100 
	#mcÚ‹xt
 
libth»ad_mcÚ‹xt


	)

101 
	#mcÚ‹xt_t
 
libth»ad_mcÚ‹xt_t


	)

102 
	#ucÚ‹xt
 
libth»ad_ucÚ‹xt


	)

103 
	#ucÚ‹xt_t
 
libth»ad_ucÚ‹xt_t


	)

104 
	~"¥¬c-ucÚ‹xt.h
"

107 #ià
	`defšed
(
__¬m__
)

108 
	`g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

109 
	`£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

110 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
((*)&((u)->
uc_mcÚ‹xt
.
¬m_r0
))

	)

111 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
((*)&((u)->
uc_mcÚ‹xt
.
¬m_r0
))

	)

114 
CÚ‹xt
 
	tCÚ‹xt
;

118 
STACK
 = 8192

121 
	sCÚ‹xt


123 
ucÚ‹xt_t
 
uc
;

126 
	sTask


128 
Çme
[
MAX_STATE_LENGTH
];

129 
¡©e
[
MAX_STATE_LENGTH
];

130 
Task
 *
Ãxt
;

131 
Task
 *
´ev
;

132 
CÚ‹xt
 
cÚ‹xt
;

133 
uvlÚg
 
®¬mtime
;

134 
ušt
 
id
;

135 
uch¬
 *
¡k
;

136 
ušt
 
¡ksize
;

137 
ex™šg
;

138 
®Éask¦Ù
;

139 
sy¡em
;

140 
»ady
;

141 (*
¡¬tâ
)(*);

142 *
¡¬rg
;

143 
sigÇl
;

146 
	`sk»ady
(
Task
*);

147 
	`sksw™ch
();

149 
	`addsk
(
Taskli¡
*, 
Task
*);

150 
	`d–sk
(
Taskli¡
*, 
Task
*);

152 
Task
 *
skruÂšg
;

153 
skcouÁ
;

	@src/tnetstrings.c

1 
	~"Š‘¡ršgs.h
"

2 
	~<¡ršg.h
>

3 
	~"dbg.h
"

4 
	~<as£¹.h
>

5 
	~"mem/h®loc.h
"

7 
	#MAX_NUM_LEN
 22

8 

	)

9 
šlše
 

10 
Šs_·r£_diù
(*
diù
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

12 
šlše
 

13 
Šs_·r£_li¡
(*
li¡
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

15 
šlše
 

16 
Šs_»nd”_v®ue
(*
v®
, 
Šs_outbuf
 *
outbuf
);

18 
šlše
 

19 
Šs_outbuf_™ß
(
size_t
 
n
, 
Šs_outbuf
 *
outbuf
);

21 
šlše
 

22 
Šs_outbuf_š™
(
Šs_outbuf
 *
outbuf
);

24 
šlše
 

25 
Šs_outbuf_ä“
(
Šs_outbuf
 *
outbuf
);

27 
šlše
 

28 
Šs_outbuf_ex‹nd
(
Šs_outbuf
 *
outbuf
);

30 
šlše
 

31 
Šs_outbuf_putc
(
Šs_outbuf
 *
outbuf
, 
c
);

33 
šlše
 

34 
Šs_outbuf_½uts
(
Šs_outbuf
 *
outbuf
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

36 
šlše
 

37 
Šs_š¶aû_»v”£
(*
d©a
, 
size_t
 
Ën
);

39 
	~"Š‘¡ršgs_im¶.h
"

42 
šlše
 
	$Šs_»nd”_¡ršg
(*
v®
, 
Šs_outbuf
 *
outbuf
)

44 
Šs_v®ue_t
 *
t
 = (Šs_v®ue_ˆ*)
v®
;

45 
	`as£¹
(
t
->
ty³
 =ğ
Šs_g_¡ršg
 && "Value is‚ot‡ string.");

46  
	`Šs_outbuf_½uts
(
outbuf
, 
	`bd©a
(
t
->
v®ue
.
¡ršg
), 
	`bËngth
(t->value.string));

47 
	}
}

49 
šlše
 
	$Šs_»nd”_numb”
(*
v®
, 
Šs_outbuf
 *
outbuf
)

51 
Šs_v®ue_t
 *
t
 = (Šs_v®ue_ˆ*)
v®
;

52 
	`as£¹
(
t
->
ty³
 =ğ
Šs_g_numb”
 && "Value is‚ot‡‚umber.");

54 
numb”
 = 
t
->
v®ue
.number;

55 
Ãg©ive
 = 
numb”
 < 0;

57 
	`as£¹
(
numb”
 !ğ
LONG_MIN
 && "LONG_MIN cannot be handled");

59 
outbuf
->
®loc_size
 < outbuf->
u£d_size
 + 
MAX_NUM_LEN
) {

60 
	`check
(
	`Šs_outbuf_ex‹nd
(
outbuf
) != -1, "Failedoƒxtend buffer.");

63 ià(
Ãg©ive
) {

64 
numb”
 = -number;

68 
outbuf
->
bufãr
[outbuf->
u£d_size
++] = '0' + (
numb”
%10);

69 } 
numb”
 /= 10);

71 ià(
Ãg©ive
) {

72 
outbuf
->
bufãr
[outbuf->
u£d_size
++] = '-';

77 
”rÜ
:

79 
	}
}

81 
šlše
 
	$Šs_»nd”_boŞ
(*
v®
, 
Šs_outbuf
 *
outbuf
)

83 
Šs_v®ue_t
 *
t
 = (Šs_v®ue_ˆ*)
v®
;

84 
	`as£¹
(
t
->
ty³
 =ğ
Šs_g_boŞ
 && "Value is‚ot‡ bool.");

86 if(
t
->
v®ue
.
boŞ
) {

87  
	`Šs_outbuf_½uts
(
outbuf
, "true", 4);

89  
	`Šs_outbuf_½uts
(
outbuf
, "false", 5);

91 
	}
}

94 
šlše
 
	$Šs_»nd”_diù
(*
diù
, 
Šs_outbuf
 *
outbuf
)

96 
hash_t
 *
h
 = ((
Šs_v®ue_t
 *)
diù
)->
v®ue
.dict;

97 
hsÿn_t
 
hs
;

98 
hnode_t
 *
node
;

99 
	`hash_sÿn_begš
(&
hs
, 
h
);

100 
Šs_v®ue_t
 
key
;

102 (
node
 = 
	`hash_sÿn_Ãxt
(&
hs
))) {

103 
	`check
(
	`Šs_»nd”_v®ue
(
	`hnode_g‘
(
node
), 
outbuf
) == 0, "Failedo„ender dict value.");

105 
key
.
ty³
 = 
Šs_g_¡ršg
;

106 
key
.
v®ue
.
¡ršg
 = (
b¡ršg
)
	`hnode_g‘key
(
node
);

108 
	`check
(
	`Šs_»nd”_v®ue
(&
key
, 
outbuf
) == 0, "Failedo„ender dict key.");

112 
”rÜ
:

114 
	}
}

116 
šlše
 
	$Šs_»nd”_li¡
(*
li¡
, 
Šs_outbuf
 *
outbuf
)

118 
d¬¿y_t
 *
L
 = ((
Šs_v®ue_t
 *)
li¡
)->
v®ue
.list;

119 
i
 = 0;

121 
i
 = 
	`d¬¿y_’d
(
L
) - 1; i >= 0; i--) {

122 
Šs_v®ue_t
 *
v®
 = 
	`d¬¿y_g‘
(
L
, 
i
);

123 
	`check
(
v®
 !ğ
NULL
, "Invalidns†ist structure, got‡ NULL.");

124 
	`check
(
	`Šs_»nd”_v®ue
(
v®
, 
outbuf
) == 0, "Failedo„ender†istƒlement.");

128 
”rÜ
:

130 
	}
}

134 
	$Šs_v®ue_de¡roy
(
Šs_v®ue_t
 *
v®ue
)

136 if(
v®ue
 =ğ
NULL
) ;

137 
d¬¿y_t
 *
L
 = 
v®ue
->v®ue.
li¡
;

138 
i
 = 0;

140 
v®ue
->
ty³
) {

141 
Šs_g_boŞ
:

143 
Šs_g_diù
:

144 
	`hash_ä“_nodes
(
v®ue
->v®ue.
diù
);

145 
	`hash_ä“
(
v®ue
->v®ue.
diù
);

147 
Šs_g_li¡
:

148 
i
 = 0; i < 
	`d¬¿y_’d
(
L
); i++) {

149 
	`Šs_v®ue_de¡roy
(
	`d¬¿y_g‘
(
L
, 
i
));

151 
	`h_ä“
(
L
);

153 
Šs_g_nuÎ
:

155 
Šs_g_numb”
:

157 
Šs_g_¡ršg
:

158 
	`bde¡roy
(
v®ue
->v®ue.
¡ršg
);

161 
	`£Áš–
("Inv®idy³ giv’: '%c'", 
v®ue
->
ty³
);

164 
”rÜ
:

165 
	`ä“
(
v®ue
);

167 
	}
}

169 
	$Šs_hnode_ä“
(
hnode_t
 *
node
, *
nÙu£d
)

171 
	`bde¡roy
((
b¡ršg
)
	`hnode_g‘key
(
node
));

172 
	`Šs_v®ue_de¡roy
(
	`hnode_g‘
(
node
));

173 
	`ä“
(
node
);

174 
	}
}

176 
hnode_t
 *
	$Šs_hnode_®loc
(*
nÙu£d
)

178  
	`m®loc
((
hnode_t
));

179 
	}
}

182 * 
	$Šs_·r£
(cÚ¡ *
d©a
, 
size_t
 
Ën
, **
»maš
)

184 *
v®
 = 
NULL
;

185 *
v®¡r
 = 
NULL
;

186 
Šs_ty³_g
 
ty³
 = 
Šs_g_nuÎ
;

187 
size_t
 
v®Ën
 = 0;

190 
v®Ën
 = 
	`¡¹Ş
(
d©a
, &
v®¡r
, 10);

191 
	`check
(
v®¡r
 !ğ
d©a
, "Not‡netstring:‚o†ength…refix.");

192 
	`check
((
v®¡r
 + 
v®Ën
 + 1è< (
d©a
 + 
Ën
) && *valstr == ':', "Not‡netstring: invalid†ength…refix.");

193 
v®¡r
++;

196 
ty³
 = 
v®¡r
[
v®Ën
];

199 if(
»maš
 !ğ
NULL
) {

200 *
»maš
 = 
v®¡r
 + 
v®Ën
 + 1;

204 
ty³
) {

206 
Šs_g_¡ršg
:

207 
v®
 = 
	`Šs_·r£_¡ršg
(
v®¡r
, 
v®Ën
);

210 
Šs_g_numb”
:

211 
v®
 = 
	`Šs_·r£_š‹g”
(
v®¡r
, 
v®Ën
);

212 
	`check
(
v®
 !ğ
NULL
, "Not‡netstring: invalid integer†iteral.");

214 
Šs_g_æßt
:

215 
v®
 = 
	`Šs_·r£_æßt
(
v®¡r
, 
v®Ën
);

216 
	`check
(
v®
 !ğ
NULL
, "Not‡netstring: invalid float†iteral.");

220 
Šs_g_boŞ
:

221 if(
v®Ën
 =ğ4 && 
v®¡r
[0] == 't') {

222 
v®
 = 
	`Šs_g‘_Œue
();

223 } if(
v®Ën
 =ğ5 && 
v®¡r
[0] == 'f') {

224 
v®
 = 
	`Šs_g‘_çl£
();

226 
	`£Áš–
("Not‡netstring: invalid boolean†iteral.");

231 
Šs_g_nuÎ
:

232 
	`check
(
v®Ën
 == 0, "Not‡netstring: invalid‚ull†iteral.");

233 
v®
 = 
	`Šs_g‘_nuÎ
();

237 
Šs_g_diù
:

238 
v®
 = 
	`Šs_Ãw_diù
();

239 
	`check
(
	`Šs_·r£_diù
(
v®
,
v®¡r
,
v®Ën
) != -1, "Not‡netstring: broken dict items.");

243 
Šs_g_li¡
:

244 
v®
 = 
	`Šs_Ãw_li¡
();

245 
	`check
(
	`Šs_·r£_li¡
(
v®
,
v®¡r
,
v®Ën
) != -1, "not‡netstring: broken†ist items");

248 
	`£Áš–
("not‡netstring: invalidypeag");

251  
v®
;

253 
”rÜ
:

254 
	`Šs_v®ue_de¡roy
(
v®
);

255  
NULL
;

256 
	}
}

259 
	$Šs_outbuf_şamp
(
Šs_outbuf
 *
outbuf
, 
Üig_size
)

261 
size_t
 
d©®’
 = 
outbuf
->
u£d_size
 - 
Üig_size
;

262 
	`Šs_outbuf_putc
(
outbuf
, ':');

263 
	`Šs_outbuf_™ß
(
d©®’
, 
outbuf
);

264 
	}
}

266 *
	$Šs_»nd”
(*
v®
, 
size_t
 *
Ën
)

268 *
ouut
 = 
NULL
;

270 
ouut
 = 
	`Šs_»nd”_»v”£d
(
v®
, 
Ën
);

271 
	`check
(
ouut
 !ğ
NULL
, "Failedo„endernetstring.");

273 
	`Šs_š¶aû_»v”£
(
ouut
, *
Ën
);

274 
ouut
[*
Ën
] = '\0';

276  
ouut
;

278 
”rÜ
:

279  
NULL
;

280 
	}
}

282 
šlše
 
	$Šs_»nd”_hash_·œ_li¡
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
key
, 
b¡rLi¡
 *
v®ue
)

284 
i
 = 0;

285 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_¡ršg
};

286 
	`Šs_outbuf_putc
(
outbuf
, ']');

287 
Üig_size
 = 
outbuf
->
u£d_size
;

289 
i
 = 
v®ue
->
qty
 - 1; i >= 0 ; i--) {

290 
v®
.
v®ue
.
¡ršg
 = v®ue->
’Œy
[
i
];

291 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

294 
	`Šs_outbuf_şamp
(
outbuf
, 
Üig_size
);

295 
v®
.
v®ue
.
¡ršg
 = 
key
;

296 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

297 
	}
}

299 
	$Šs_»nd”_hash_·œ
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
key
, b¡ršg 
v®ue
)

301 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_¡ršg
, .
v®ue
.
¡ršg
 = value};

302 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

304 
v®
.
v®ue
.
¡ršg
 = 
key
;

305 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

306 
	}
}

308 
	$Šs_»nd”_numb”_´•’d
(
Šs_outbuf
 *
outbuf
, 
v®ue
)

310 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = value};

311 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

312 
	}
}

314 
	$Šs_»nd”_¡ršg_´•’d
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
v®ue
)

316 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_¡ršg
, .
v®ue
.
¡ršg
 = value};

317 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

318 
	}
}

320 
	$Šs_»nd”_»que¡_¡¬t
(
Šs_outbuf
 *
outbuf
)

322 
	`check
(
	`Šs_outbuf_š™
(
outbuf
) != -1, "Failedo init buffer.");

324 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, '}') != -1, "Failedƒnding„equest.");

326  
outbuf
->
u£d_size
;

327 
”rÜ
:

329 
	}
}

331 
	$Šs_»nd”_»que¡_’d
(
Šs_outbuf
 *
outbuf
, 
h—d”_¡¬t
, 
b¡ršg
 
uuid
, 
id
, b¡ršg 
·th
)

334 
	`Šs_outbuf_şamp
(
outbuf
, 
h—d”_¡¬t
);

336 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ' ') != -1, "Failedƒnding„equest.");

337 
	`check
(
	`Šs_outbuf_½uts
(
outbuf
, 
	`bd©a
(
·th
), 
	`bËngth
(path)) != -1, "Failedƒnding„equest.");

339 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ' ') != -1, "Failedƒnding„equest.");

340 
	`check
(
	`Šs_outbuf_™ß
(
id
, 
outbuf
) != -1, "Failedƒnding„equest.");

342 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ' ') != -1, "Failedƒnding„equest.");

343 
	`check
(
	`Šs_outbuf_½uts
(
outbuf
, 
	`bd©a
(
uuid
), 
	`bËngth
(uuid)) != -1, "Failedƒnding„equest.");

347 
”rÜ
:

349 
	}
}

351 
	$Šs_»nd”_log_¡¬t
(
Šs_outbuf
 *
outbuf
)

353 
	`check
(
	`Šs_outbuf_š™
(
outbuf
) != -1, "Failedo init buffer.");

355 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ']') != -1, "Failedƒnding„equest.");

357  
outbuf
->
u£d_size
;

358 
”rÜ
:

360 
	}
}

362 
	$Šs_»nd”_log_’d
(
Šs_outbuf
 *
outbuf
)

364 
	`Šs_outbuf_şamp
(
outbuf
, 1);

365 
	}
}

367 
	$Šs_»nd”_»que¡_h—d”s
(
Šs_outbuf
 *
outbuf
, 
hash_t
 *
h—d”s
)

369 
hsÿn_t
 
sÿn
;

370 
hnode_t
 *
n
 = 
NULL
;

371 
	`hash_sÿn_begš
(&
sÿn
, 
h—d”s
);

373 
n
 = 
	`hash_sÿn_Ãxt
(&
sÿn
);‚ !ğ
NULL
;‚ = hash_scan_next(&scan)) {

374 
b¡rLi¡
 *
v®_li¡
 = 
	`hnode_g‘
(
n
);

375 if(
v®_li¡
->
qty
 == 0) ;

377 
b¡ršg
 
key
 = (b¡ršg)
	`hnode_g‘key
(
n
);

379 if(
v®_li¡
->
qty
 == 1) {

380 
	`Šs_»nd”_hash_·œ
(
outbuf
, 
key
, 
v®_li¡
->
’Œy
[0]);

382 
	`Šs_»nd”_hash_·œ_li¡
(
outbuf
, 
key
, 
v®_li¡
);

387 
	}
}

389 
b¡ršg
 
	$Šs_outbuf_to_b¡ršg
(
Šs_outbuf
 *
outbuf
)

391 if(
outbuf
->
u£d_size
 =ğoutbuf->
®loc_size
) {

392 
	`Šs_outbuf_ex‹nd
(
outbuf
);

395 
	`Šs_š¶aû_»v”£
(
outbuf
->
bufãr
, outbuf->
u£d_size
);

397 
b¡ršg
 
b
 = 
	`m®loc
((
gb¡ršg
));

398 
b
->
¦’
 = 
outbuf
->
u£d_size
;

399 
b
->
d©a
 = (*)
outbuf
->
bufãr
;

400 
b
->
d©a
[b->
¦’
] = '\0';

401 
b
->
mËn
 = 
outbuf
->
®loc_size
;

403  
b
;

404 
	}
}

406 *
	$Šs_»nd”_»v”£d
(*
v®
, 
size_t
 *
Ën
)

408 
Šs_outbuf
 
outbuf
;

410 
	`check
(
	`Šs_outbuf_š™
(&
outbuf
) != -1, "Failedo initialize outbuf.");

412 
	`check
(
	`Šs_»nd”_v®ue
(
v®
, &
outbuf
) != -1, "Failedo„ender value.");

413 *
Ën
 = 
outbuf
.
u£d_size
;

415 if(
outbuf
.
u£d_size
 =ğoutbuf.
®loc_size
) {

417 
outbuf
.
bufãr
 = 
	`»®loc
(outbuf.bufãr, outbuf.
u£d_size
 + 1);

418 
	`check_mem
(
outbuf
.
bufãr
);

421  
outbuf
.
bufãr
;

423 
”rÜ
:

424 
	`Šs_outbuf_ä“
(&
outbuf
);

425  
NULL
;

426 
	}
}

429 
šlše
 

430 
	$Šs_»nd”_v®ue
(*
v®
, 
Šs_outbuf
 *
outbuf
)

432 
Šs_ty³_g
 
ty³
 = 
Šs_g_nuÎ
;

433 
»s
 = -1;

434 
size_t
 
d©®’
 = 0;

437 
ty³
 = 
	`Šs_g‘_ty³
(
v®
);

438 
	`check
(
ty³
 != 0, "type‚ot serializable");

440 
	`Šs_outbuf_putc
(
outbuf
, 
ty³
);

441 
d©®’
 = 
outbuf
->
u£d_size
;

445 
ty³
) {

446 
Šs_g_¡ršg
:

447 
»s
 = 
	`Šs_»nd”_¡ršg
(
v®
, 
outbuf
);

449 
Šs_g_numb”
:

450 
»s
 = 
	`Šs_»nd”_numb”
(
v®
, 
outbuf
);

452 
Šs_g_boŞ
:

453 
»s
 = 
	`Šs_»nd”_boŞ
(
v®
, 
outbuf
);

455 
Šs_g_nuÎ
:

456 
»s
 = 0;

458 
Šs_g_diù
:

459 
»s
 = 
	`Šs_»nd”_diù
(
v®
, 
outbuf
);

461 
Šs_g_li¡
:

462 
»s
 = 
	`Šs_»nd”_li¡
(
v®
, 
outbuf
);

464 
Šs_g_šv®id
:

465 
	`£Áš–
("invalidns value, can't be NULL");

468 
	`£Áš–
("unknowÀty³ag: '%c'", 
ty³
);

471 
	`check
(
»s
 =ğ0, "FaedØ»nd” v®uty³: '%c'", 
ty³
);

473 
d©®’
 = 
outbuf
->
u£d_size
 - datalen;

474 
	`Šs_outbuf_putc
(
outbuf
, ':');

475 
»s
 = 
	`Šs_outbuf_™ß
(
d©®’
, 
outbuf
);

477  
»s
;

478 
”rÜ
:

480 
	}
}

484 
	$Šs_š¶aû_»v”£
(*
d©a
, 
size_t
 
Ën
)

486 *
d’d
 = 
NULL
;

487 
c
 = '\0';

488 
	`as£¹
(
d©a
 !ğ
NULL
 && "Data cannot be NULL.");

490 
d’d
 = 
d©a
 + 
Ën
 - 1;

491 
d’d
 > 
d©a
) {

492 
c
 = *
d©a
;

493 *
d©a
 = *
d’d
;

494 *
d’d
 = 
c
;

495 
d©a
++;

496 
d’d
--;

498 
	}
}

500 
	#Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
) {\

501 
Ën
 =†’ - (
»maš
 - 
d©a
);\

502 
	`check
(
Ën
 < 
Üig_Ën
, "Error…arsing data, buffer math is off.");\

503 
d©a
 = 
»maš
;\

504 }

	)

507 
	$Šs_·r£_li¡
(*
v®
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

509 *
™em
 = 
NULL
;

510 *
»maš
 = 
NULL
;

511 
size_t
 
Üig_Ën
 = 
Ën
;

513 
	`as£¹
(
v®
 !ğ
NULL
 && "Value cannot be NULL.");

514 
	`as£¹
(
d©a
 !ğ
NULL
 && "data cannot be NULL.");

516 
Ën
 > 0) {

517 
™em
 = 
	`Šs_·r£
(
d©a
, 
Ën
, &
»maš
);

518 
	`check
(
™em
 !ğ
NULL
, "Failedo…arse†ist.");

519 
	`Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
);

520 
	`check
(
	`Šs_add_to_li¡
(
v®
, 
™em
) != -1, "Failedo‡ddƒlemento†ist.");

521 
™em
 = 
NULL
;

526 
”rÜ
:

527 if(
™em
è
	`Šs_v®ue_de¡roy
(item);

529 
	}
}

532 
šlše
 

533 
	$Šs_·r£_diù
(*
v®
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

535 *
key
 = 
NULL
;

536 *
™em
 = 
NULL
;

537 *
»maš
 = 
NULL
;

538 
size_t
 
Üig_Ën
 = 
Ën
;

540 
	`as£¹
(
v®
 !ğ
NULL
 && "Value cannot be NULL.");

541 
	`as£¹
(
d©a
 !ğ
NULL
 && "Data cannot be NULL.");

543 
Ën
 > 0) {

544 
key
 = 
	`Šs_·r£
(
d©a
, 
Ën
, &
»maš
);

545 
	`check
(
key
 !ğ
NULL
, "Failedo…arse dict key fromnetstring.");

546 
	`Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
);

548 
™em
 = 
	`Šs_·r£
(
d©a
, 
Ën
, &
»maš
);

549 
	`check
(
™em
 !ğ
NULL
, "Failedo…arse dict key fromnetstring.");

551 
	`Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
);

552 
	`check
(
	`Šs_add_to_diù
(
v®
,
key
,
™em
) != -1, "Failedo‡ddƒlemento dict.");

553 
key
 = 
NULL
;

554 
™em
 = 
NULL
;

559 
”rÜ
:

560 if(
key
è
	`Šs_v®ue_de¡roy
(key);

561 if(
™em
è
	`Šs_v®ue_de¡roy
(item);

563 
	}
}

566 
šlše
 

567 
	$Šs_outbuf_™ß
(
size_t
 
n
, 
Šs_outbuf
 *
outbuf
)

570 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, 
n
%10+'0') != -1, "Failedo write intonetstring buffer.");

571 
n
 =‚ / 10;

572 } 
n
 > 0);

576 
”rÜ
:

578 
	}
}

581 
šlše
 

582 
	$Šs_outbuf_š™
(
Šs_outbuf
 *
outbuf
)

584 
outbuf
->
bufãr
 = 
	`m®loc
(64);

585 
	`check_mem
(
outbuf
->
bufãr
);

587 
outbuf
->
®loc_size
 = 64;

588 
outbuf
->
u£d_size
 = 0;

591 
”rÜ
:

592 
outbuf
->
®loc_size
 = 0;

593 
outbuf
->
u£d_size
 = 0;

595 
	}
}

598 
šlše
 

599 
	$Šs_outbuf_ä“
(
Šs_outbuf
 *
outbuf
)

601 if(
outbuf
) {

602 
	`ä“
(
outbuf
->
bufãr
);

603 
outbuf
->
bufãr
 = 
NULL
;

604 
outbuf
->
®loc_size
 = 0;

605 
outbuf
->
u£d_size
 = 0;

607 
	}
}

610 
šlše
 

611 
	$Šs_outbuf_ex‹nd
(
Šs_outbuf
 *
outbuf
)

613 *
Ãw_buf
 = 
NULL
;

614 
size_t
 
Ãw_size
 = 
outbuf
->
®loc_size
 * 2;

616 
Ãw_buf
 = 
	`»®loc
(
outbuf
->
bufãr
, 
Ãw_size
);

617 
	`check_mem
(
Ãw_buf
);

619 
outbuf
->
bufãr
 = 
Ãw_buf
;

620 
outbuf
->
®loc_size
 = 
Ãw_size
;

624 
”rÜ
:

626 
	}
}

629 
šlše
 

630 
	$Šs_outbuf_putc
(
Šs_outbuf
 *
outbuf
, 
c
)

632 if(
outbuf
->
®loc_size
 =ğoutbuf->
u£d_size
) {

633 
	`check
(
	`Šs_outbuf_ex‹nd
(
outbuf
) != -1, "Failedoƒxtend buffer.");

636 
outbuf
->
bufãr
[outbuf->
u£d_size
++] = 
c
;

639 
”rÜ
:

641 
	}
}

644 
šlše
 

645 
	$Šs_outbuf_½uts
(
Šs_outbuf
 *
outbuf
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

647 cÚ¡ *
d’d
 = 
NULL
;

648 *
bufãr
 = 
NULL
;

651 
outbuf
->
®loc_size
 - outbuf->
u£d_size
 < 
Ën
) {

652 
	`check
(
	`Šs_outbuf_ex‹nd
(
outbuf
) != -1, "Failedo„puts into‡netstring buffer.");

656 
bufãr
 = 
outbuf
->bufã¸+ outbuf->
u£d_size
;

657 
d’d
 = 
d©a
 + 
Ën
 - 1;

659 
d’d
 >ğ
d©a
) {

660 *
bufãr
 = *
d’d
;

661 
bufãr
++;

662 
d’d
--;

665 
outbuf
->
u£d_size
 +ğ
Ën
;

668 
”rÜ
:

670 
	}
}

672 
Šs_v®ue_t
 *
	$Šs_¡ªd¬d_bË
(
b¡ršg
 
h—d”_d©a
, 
Šs_v®ue_t
 *
rows
)

674 
Šs_v®ue_t
 *
h—d”s
 = 
	`Šs_·r£
(
	`bd©a
(
h—d”_d©a
), 
	`bËngth
(h—d”_d©a), 
NULL
);

675 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

677 
	`Šs_diù_£tc¡r
(
»suÉ
, "h—d”s", 
h—d”s
);

678 
	`Šs_diù_£tc¡r
(
»suÉ
, "rows", 
rows
);

680  
»suÉ
;

681 
	}
}

	@src/tnetstrings.h

1 #iâdeà
_Š‘¡ršgs_h


2 
	#_Š‘¡ršgs_h


	)

4 
	~<¡dlib.h
>

5 
	~<¡ddef.h
>

6 
	~<ùy³.h
>

7 
	~"b¡ršg.h
"

8 
	~"adt/hash.h
"

9 
	~"adt/d¬¿y.h
"

11 
	sŠs_outbuf_s
 {

12 *
	mbufãr
;

13 
size_t
 
	mu£d_size
;

14 
size_t
 
	m®loc_size
;

15 } 
	tŠs_outbuf
;

17 
	eŠs_ty³_g_e
 {

18 
	mŠs_g_¡ršg
 = ',',

19 
	mŠs_g_numb”
 = '#',

20 
	mŠs_g_æßt
 = '^',

21 
	mŠs_g_boŞ
 = '!',

22 
	mŠs_g_nuÎ
 = '~',

23 
	mŠs_g_diù
 = '}',

24 
	mŠs_g_li¡
 = ']',

25 
	mŠs_g_šv®id
 = 'Z',

26 } 
	tŠs_ty³_g
;

28 
	sŠs_v®ue_t
 {

29 
Šs_ty³_g
 
	mty³
;

32 
b¡ršg
 
	m¡ršg
;

33 
	mnumb”
;

34 
	måošt
;

35 
	mboŞ
;

36 
d¬¿y_t
 *
	mli¡
;

37 
hash_t
 *
	mdiù
;

38 } 
	mv®ue
;

39 } 
	tŠs_v®ue_t
;

41 
	#MAX_HASH_COUNT
 
HASHCOUNT_T_MAX


	)

43 
Šs_hnode_ä“
(
hnode_t
 *
node
, *
nÙu£d
);

45 
hnode_t
 *
Šs_hnode_®loc
(*
nÙu£d
);

47 
Šs_v®ue_de¡roy
(
Šs_v®ue_t
 *
v®ue
);

55 *
Šs_·r£
(cÚ¡ *
d©a
, 
size_t
 
Ën
, ** 
»maš
);

65 *
Šs_»nd”
(*
v®
, 
size_t
 *
Ën
);

75 *
Šs_»nd”_»v”£d
(*
v®
, 
size_t
 *
Ën
);

78 
Šs_»nd”_hash_·œ
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
key
, b¡ršg 
v®ue
);

80 
Šs_»nd”_»que¡_h—d”s
(
Šs_outbuf
 *
outbuf
, 
hash_t
 *
h—d”s
);

82 
b¡ršg
 
Šs_outbuf_to_b¡ršg
(
Šs_outbuf
 *
outbuf
);

84 
Šs_outbuf_şamp
(
Šs_outbuf
 *
outbuf
, 
Üig_size
);

87 
Šs_»nd”_»que¡_¡¬t
(
Šs_outbuf
 *
outbuf
);

89 
Šs_»nd”_»que¡_’d
(
Šs_outbuf
 *
outbuf
, 
h—d”_¡¬t
, 
b¡ršg
 
uuid
, 
id
, b¡ršg 
·th
);

91 
Šs_»nd”_log_¡¬t
(
Šs_outbuf
 *
outbuf
);

93 
Šs_»nd”_log_’d
(
Šs_outbuf
 *
outbuf
);

95 
Šs_»nd”_¡ršg_´•’d
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
v®ue
);

96 
Šs_»nd”_numb”_´•’d
(
Šs_outbuf
 *
outbuf
, 
v®ue
);

98 
Šs_v®ue_t
 *
Šs_¡ªd¬d_bË
(
b¡ršg
 
h—d”_d©a
,ns_v®ue_ˆ*
rows
);

100 
	#Šs_g‘_ty³
(
T
è(((
Šs_v®ue_t
 *)(T)è=ğ
NULL
 ? 
Šs_g_šv®id
 : (Ñns_v®ue_ˆ*)(T))->
ty³
)

	)

	@src/tnetstrings_impl.h

1 #iâdeà
_Š‘¡ršgs_im¶_h


2 
	#_Š‘¡ršgs_im¶_h


	)

4 
	~"dbg.h
"

5 
	~<as£¹.h
>

7 
šlše
 
Šs_v®ue_t
 *
	$Šs_v®ue_ü—‹
(
Šs_ty³_g
 
g
)

9 
Šs_v®ue_t
 *
v®
 = 
	`m®loc
((tns_value_t));

10 
v®
->
ty³
 = 
g
;

11  
v®
;

12 
	}
}

16 
šlše
 *
	$Šs_Ãw_diù
()

18 
Šs_v®ue_t
 *
v®
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_diù
);

19 
v®
->
v®ue
.
diù
 = 
	`hash_ü—‹
(
MAX_HASH_COUNT
, (
hash_comp_t
)
b¡rcmp
, 
b¡r_hash_fun
);

20 
	`hash_£t_®loÿtÜ
(
v®
->
v®ue
.
diù
, 
Šs_hnode_®loc
, 
Šs_hnode_ä“
, 
NULL
);

22  
v®
;

23 
	}
}

25 
šlše
 
	$Šs_add_to_diù
(*
diù
, *
key
, *
™em
)

27 
	`check
(
	`Šs_g‘_ty³
(
diù
è=ğ
Šs_g_diù
, "Can't‡ddohat, it's‚ot‡ dict.");

28 
hash_t
 *
h
 = ((
Šs_v®ue_t
 *)
diù
)->
v®ue
.dict;

29 
Šs_v®ue_t
 *
k
 = 
key
;

31 
	`check
(
k
->
ty³
 =ğ
Šs_g_¡ršg
, "Only strings can be keys.");

32 
	`check
(
	`hash_®loc_š£¹
(
h
, 
k
->
v®ue
.
¡ršg
, 
™em
), "Failedo insert key into dict.");

34 
	`ä“
(
k
);

36 
”rÜ
:

38 
	}
}

42 
šlše
 *
	$Šs_g‘_nuÎ
()

44  
	`Šs_v®ue_ü—‹
(
Šs_g_nuÎ
);

45 
	}
}

47 
šlše
 *
	$Šs_g‘_Œue
()

49 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_boŞ
);

50 
t
->
v®ue
.
boŞ
 = 1;

51  
t
;

52 
	}
}

54 
šlše
 *
	$Šs_g‘_çl£
()

56 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_boŞ
);

57 
t
->
v®ue
.
boŞ
 = 0;

58  
t
;

59 
	}
}

61 
šlše
 *
	$Šs_Ãw_li¡
()

63 
Šs_v®ue_t
 *
v®
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_li¡
);

64 
v®
->
v®ue
.
li¡
 = 
	`d¬¿y_ü—‹
((
Šs_v®ue_t
), 100);

66  
v®
;

67 
	}
}

69 
šlše
 
	$Šs_add_to_li¡
(*
li¡
, *
™em
)

71 
	`check
(
	`Šs_g‘_ty³
(
li¡
è=ğ
Šs_g_li¡
, "Can't‡ddohat, it's‚ot‡†ist.");

72 
d¬¿y_t
 *
L
 = ((
Šs_v®ue_t
 *)
li¡
)->
v®ue
.list;

73 
	`d¬¿y_push
(
L
, 
™em
);

75 
”rÜ
:

77 
	}
}

80 
šlše
 *
	$Šs_·r£_¡ršg
(cÚ¡ *
d©a
, 
size_t
 
Ën
)

82 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_¡ršg
);

83 
t
->
v®ue
.
¡ršg
 = 
	`blk2b¡r
(
d©a
, 
Ën
);

84  
t
;

85 
	}
}

87 
šlše
 *
	$Šs_·r£_š‹g”
(cÚ¡ *
d©a
, 
size_t
 
Ën
)

89 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_numb”
);

90 *
’d±r
 = 
NULL
;

91 
t
->
v®ue
.
numb”
 = 
	`¡¹Ş
(
d©a
, &
’d±r
, 10);

92 
	`check
(
’d±r
 !ğ
NULL
 &&ƒnd±¸- 
d©a
 =ğ()
Ën
, "Failedo…arse integer.");

93 
	`check
(
”ºo
 !ğ
ERANGE
, "Integer isoo†arge.");

95  
t
;

96 
”rÜ
:

97  
NULL
;

98 
	}
}

100 
šlše
 *
	$Šs_·r£_æßt
(cÚ¡ *
d©a
, 
size_t
 
Ën
)

102 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_æßt
);

103 *
’d±r
 = 
NULL
;

104 
t
->
v®ue
.
åošt
 = 
	`¡¹od
(
d©a
, 
NULL
);

105 
	`check
(
’d±r
 !ğ
NULL
 &&ƒnd±¸- 
d©a
 =ğ()
Ën
, "Failedo…arse float.");

106 
	`check
(
”ºo
 !ğ
ERANGE
, "Float isoo†arge.");

108  
t
;

109 
”rÜ
:

110  
NULL
;

111 
	}
}

114 
šlše
 *
	$Šs_Ãw_š‹g”
(
numb”
)

116 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_numb”
);

117 
t
->
v®ue
.
numb”
 =‚umber;

118  
t
;

119 
	}
}

121 
šlše
 *
	$Šs_Ãw_æßt
(
åošt
)

123 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_æßt
);

124 
t
->
v®ue
.
åošt
 = fpoint;

125  
t
;

126 
	}
}

129 
šlše
 
	$Šs_diù_£tc¡r
(
Šs_v®ue_t
 *
d
, cÚ¡ *
key
,ns_v®ue_ˆ*
v®
)

131  
	`Šs_add_to_diù
(
d
, 
	`Šs_·r£_¡ršg
(
key
, 
	`¡¾’
(key)), 
v®
);

132 
	}
}

134 
šlše
 
	$Šs_diù_£t
(
Šs_v®ue_t
 *
d
, 
b¡ršg
 
key
,ns_v®ue_ˆ*
v®
)

136  
	`Šs_add_to_diù
(
d
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(
key
), 
	`bËngth
(key)), 
v®
);

137 
	}
}

139 
šlše
 
	$Šs_li¡_add¡r
(
Šs_v®ue_t
 *
d
, 
b¡ršg
 
–em’t
)

141  
	`Šs_add_to_li¡
(
d
,

142 
	`Šs_·r£_¡ršg
(
	`bd©a
(
–em’t
), 
	`bËngth
(element)));

143 
	}
}

	@src/unixy.c

35 
	~<unixy.h
>

36 
	~<dbg.h
>

37 
	~<uni¡d.h
>

38 
	~<sys/ty³s.h
>

39 
	~<sys/¡©.h
>

40 
	~<sys/ty³s.h
>

41 
	~<sigÇl.h
>

42 
	~<lim™s.h
>

43 
	~<¡dlib.h
>

47 
	$Unixy_chroÙ
(
b¡ršg
 
·th
)

49 
rc
 = 0;

50 cÚ¡ *
to_dœ
 = 
	`bd©a
(
·th
);

52 
	`check
(
to_dœ
 && 
	`bËngth
(
·th
) > 0, "Invalid orƒmpty…ath for chroot.");

54 
rc
 = 
	`chroÙ
(
to_dœ
);

55 
	`check
(
rc
 =ğ0, "Cª'ˆchroÙØ%s,„”uÀa roÙ iàthi i wh© you wªt.", 
	`bd©a
(
·th
));

57 
rc
 = 
	`chdœ
("/");

58 
	`check
(
rc
 == 0, "Can't chdiro / directory inside chroot.");

62 
”rÜ
:

64 
	}
}

67 
	$Unixy_drİ_´iv
(
b¡ršg
 
·th
)

69 cÚ¡ *
äom_dœ
 = 
	`bd©a
(
·th
);

70 
¡©
 
sb
;

72 
	`check
(
äom_dœ
 && 
	`bËngth
(
·th
), "Chroot…ath can't beƒmpty.");

74 
rc
 = 
	`¡©
(
äom_dœ
, &
sb
);

75 
	`check
(
rc
 =ğ0, "FaedØ¡©¬g‘ chroÙ dœeùÜy: %s", 
	`bd©a
(
·th
));

77 
rc
 = 
	`£Œegid
(
sb
.
¡_gid
, sb.st_gid);

78 
	`check
(
rc
 =ğ0 && 
	`g‘gid
(è=ğ
sb
.
¡_gid
 && 
	`g‘egid
() == sb.st_gid, "Failedo changeo GID: %d", sb.st_gid);

80 
rc
 = 
	`£Œeuid
(
sb
.
¡_uid
, sb.st_uid);

81 
	`check
(
rc
 =ğ0 && 
	`g‘uid
(è=ğ
sb
.
¡_uid
 && 
	`g‘euid
() == sb.st_uid, "Failedo changeo UID: %d", sb.st_uid);

83 
	`log_šfo
("Now„uÂšg‡ UID:%d, GID:%d", 
sb
.
¡_uid
, sb.
¡_gid
);

86 
”rÜ
:

88 
	}
}

91 
pid_t
 
	$Unixy_pid_»ad
(
b¡ršg
 
pid_·th
)

93 
pid_t
 
pid
 = -1;

94 
FILE
 *
pid_fe
 = 
NULL
;

96 
	`check
(
pid_·th
, "PID file has‚ot been set yet.");

98 
pid_fe
 = 
	`fİ’
(
	`bd©a
(
pid_·th
), "r");

99 
	`check
(
pid_fe
, "FaedØİ’ PID f% fÜ„—dšg.", 
	`bd©a
(
pid_·th
));

101 
	`check
(
	`fsÿnf
(
pid_fe
, "%d", &
pid
è!ğ-1, "FaedØ»ad‡Àš‹g” from PID fe: %s", 
	`bd©a
(
pid_·th
));

103 
	`fşo£
(
pid_fe
);

104  
pid
;

105 
”rÜ
:

107 if(
pid_fe
è
	`fşo£
(pid_file);

109 
	}
}

111 
	$Unixy_¡l_ruÂšg
(
b¡ršg
 
pid_·th
, 
pid_t
 *
pid
)

113 
rc
 = 0;

115 *
pid
 = 
	`Unixy_pid_»ad
(
pid_·th
);

117 if(*
pid
 < 0) {

122 
rc
 = 
	`kl
(*
pid
, 0);

123  
rc
 == 0;

124 
	}
}

127 
	$Unixy_»move_d—d_pidfe
(
b¡ršg
 
pid_·th
)

129 
rc
 = 0;

130 
pid_t
 
pid
 = 0;

132 
rc
 = 
	`Unixy_¡l_ruÂšg
(
pid_·th
, &
pid
);

134 
	`check
(
rc
 !ğ-1, "FaedØfigu» ouˆià´oûs %d i ¡ÈruÂšg. You…robably dÚ'ˆhav/´oøÜ‡ weœd oÃ.", 
pid
);

135 
	`check
(
rc
 !ğ1, "Proûs %d i ¡ÈruÂšg, shuˆ™ dowÀfœ¡.", 
pid
);

137 if(
pid
 == -1) {

138 
	`log_šfo
("No…revious Mongrel2„unning, continuing on.");

140 
	`log_šfo
("Proûs %d i nÙ„uÂšg‡nymÜe, sØ»movšg PID f%s.", 
pid
, 
	`bd©a
(
pid_·th
));

141 
rc
 = 
	`uÆšk
((cÚ¡ *)
pid_·th
->
d©a
);

142 
	`check
(
rc
 =ğ0, "FaedØ»movthPID f%s, mª you'» sØho£d I givup.", 
	`bd©a
(
pid_·th
));

147 
”rÜ
:

149 
	}
}

151 
	$Unixy_pid_fe
(
b¡ršg
 
·th
)

153 
FILE
 *
pid_fe
 = 
NULL
;

154 
rc
 = 0;

155 
¡©
 
sb
;

156 *
pid_·th
 = 
NULL
;

158 
pid_·th
 = 
	`b¡r2c¡r
(
·th
, '\0');

159 
	`check_mem
(
pid_·th
);

161 
rc
 = 
	`¡©
(
pid_·th
, &
sb
);

162 
	`check
(
rc
 == -1, "PID file‡lreadyƒxists, something bad happened.");

165 
pid_fe
 = 
	`fİ’
(
pid_·th
, "w");

166 
	`check
(
pid_fe
, "FaedØİ’ PID f% fÜ wr™šg.", 
pid_·th
);

168 
rc
 = 
	`årštf
(
pid_fe
, "%d", 
	`g‘pid
());

169 
	`check
(
rc
 > 0, "FaedØwr™PIDØf%s", 
pid_·th
);

172 if(
pid_·th
è
	`ä“
(pid_path);

173 
	`fşo£
(
pid_fe
);

176 
”rÜ
:

177 if(
pid_·th
è
	`ä“
(pid_path);

178 if(
pid_fe
è
	`fşo£
(pid_file);

180 
	}
}

183 
	$Unixy_d«mÚize
()

186 
rc
 = 
	`d«mÚ
(0, 1);

187 
	`check
(
rc
 == 0, "Failedo daemonize.");

191 
”rÜ
:

193 
	}
}

196 
b¡ršg
 
	$Unixy_g‘cwd
()

198 *
wd
 = 
	`ÿÎoc
(
PATH_MAX
 + 1, 1);

199 
b¡ršg
 
dœ
 = 
NULL
;

201 
	`check
(
	`g‘cwd
(
wd
, 
PATH_MAX
-1), "Could‚ot get current working directory.");

202 
wd
[
PATH_MAX
] = '\0';

204 
dœ
 = 
	`bäomc¡r
(
wd
);

206 
”rÜ
:

208 
	`ä“
(
wd
);

209  
dœ
;

210 
	}
}

	@src/unixy.h

35 #iâdeà
_unixy_h


36 
	#_unixy_h


	)

38 
	~<b¡ršg.h
>

39 
	~<uni¡d.h
>

41 
Unixy_chroÙ
(
b¡ršg
 
·th
);

43 
Unixy_drİ_´iv
(
b¡ršg
 
·th
);

45 
b¡ršg
 
Unixy_g‘cwd
();

47 
Unixy_pid_fe
(
b¡ršg
 
·th
);

49 
Unixy_d«mÚize
();

51 
Unixy_¡l_ruÂšg
(
b¡ršg
 
pid_·th
, 
pid_t
 *
pid
);

53 
Unixy_»move_d—d_pidfe
(
b¡ršg
 
pid_·th
);

55 
pid_t
 
Unixy_pid_»ad
(
b¡ršg
 
pid_·th
);

	@src/upload.c

35 
	~<sys/¡©.h
>

36 
	~"u¶ßd.h
"

37 
	~"dbg.h
"

38 
	~"£‰šg.h
"

39 
	~"»¥Ú£.h
"

41 
b¡ršg
 
	gUPLOAD_STORE
 = 
NULL
;

42 
mode_t
 
	gUPLOAD_MODE
 = 0;

43 
gb¡ršg
 
	gUPLOAD_MODE_DEFAULT
 = 
bsStic
("0600");

45 
šlše
 
	$¡»am_to_disk
(
IOBuf
 *
iob
, 
cÚ‹Á_Ën
, 
tmpfd
)

47 *
d©a
 = 
NULL
;

48 
ava
 = 0;

50 
	`debug
("max cÚ‹Á†’gth: %d, cÚ‹Á_Ën: %d", 
MAX_CONTENT_LENGTH
, 
cÚ‹Á_Ën
);

52 
	`IOBuf_»size
(
iob
, 
MAX_CONTENT_LENGTH
);

54 
cÚ‹Á_Ën
 > 0) {

55 
d©a
 = 
	`IOBuf_»ad_some
(
iob
, &
ava
);

56 
	`check
(!
	`IOBuf_şo£d
(
iob
), "Closed while„eading from IOBuf.");

57 
cÚ‹Á_Ën
 -ğ
ava
;

58 
	`check
(
	`wr™e
(
tmpfd
, 
d©a
, 
ava
) ==‡vail, "Failedo write„equested‡mountoempfile: %d",‡vail);

60 
	`check
(
	`IOBuf_»ad_comm™
(
iob
, 
ava
) != -1, "Final commit failed streamingo disk.");

63 
	`check
(
cÚ‹Á_Ën
 == 0, "Failedo writeƒverythingohe†arge uploadmpfile.");

67 
”rÜ
:

69 
	}
}

72 
	$U¶ßd_nÙify
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, cÚ¡ *
¡age
, 
b¡ršg
 
tmp_Çme
)

74 
b¡ršg
 
key
 = 
	`bfÜm©
("x-mÚg»l2-u¶ßd-%s", 
¡age
);

75 
	`Reque¡_£t
(
cÚn
->
»q
, 
key
, 
	`b¡rıy
(
tmp_Çme
), 1);

77  
	`CÚÃùiÚ_£nd_to_hªdËr
(
cÚn
, 
hªdËr
, "", 0);

78 
	}
}

80 
	$U¶ßd_fe
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, 
cÚ‹Á_Ën
)

82 
rc
 = 0;

83 
tmpfd
 = 0;

84 
b¡ršg
 
tmp_Çme
 = 
NULL
;

85 
b¡ršg
 
»suÉ
 = 
NULL
;

87 if(
UPLOAD_STORE
 =ğ
NULL
) {

88 
UPLOAD_STORE
 = 
	`S‘tšg_g‘_¡r
("u¶ßd.‹mp_¡Üe", 
NULL
);

89 
	`”rÜ_uÆess
(
UPLOAD_STORE
, 
cÚn
, 413, "Reque¡ƒÁ™y i toØÏrge: %d,‡nd‚Øu¶ßd.‹mp_¡Ü£‰šg fÜ wh”tØpuˆthbig fes.", 
cÚ‹Á_Ën
);

91 
UPLOAD_STORE
 = 
	`b¡rıy
(UPLOAD_STORE);

94 if(
UPLOAD_MODE
 == 0) {

95 
b¡ršg
 
mode
 = 
	`S‘tšg_g‘_¡r
("u¶ßd.‹mp_¡Üe_mode", &
UPLOAD_MODE_DEFAULT
);

96 
	`log_šfo
("WÈ£ˆmodfÜ u¶ßdem°¡Üto: %s", 
	`bd©a
(
mode
));

98 
UPLOAD_MODE
 = 
	`¡¹oul
((cÚ¡ *)
mode
->
d©a
, 
NULL
, 0);

99 
	`check
(
UPLOAD_MODE
 > 0, "Failedo convert upload.temp_store_modeo‡‚umber.");

100 
	`check
(
UPLOAD_MODE
 < 066666, "Inv®id modth©' wayoØbig: %s.", 
	`bd©a
(
mode
));

103 
tmp_Çme
 = 
	`b¡rıy
(
UPLOAD_STORE
);

105 
tmpfd
 = 
	`mk¡emp
((*)
tmp_Çme
->
d©a
);

106 
	`check
(
tmpfd
 != -1, "Failedo create secureempfile, did youƒnd it with XXXXXX?");

108 
	`log_šfo
("Wr™šgempf% fÜ†¬gu¶ßd.", 
	`bd©a
(
tmp_Çme
));

110 
rc
 = 
	`chmod
((*)
tmp_Çme
->
d©a
, 
UPLOAD_MODE
);

111 
	`check
(
rc
 == 0, "Failedo chmod.");

113 
rc
 = 
	`U¶ßd_nÙify
(
cÚn
, 
hªdËr
, "¡¬t", 
tmp_Çme
);

114 
	`check
(
rc
 == 0, "Failedo‚otify ofhe start of upload.");

116 
rc
 = 
	`¡»am_to_disk
(
cÚn
->
iob
, 
cÚ‹Á_Ën
, 
tmpfd
);

117 
	`check
(
rc
 == 0, "Failedo streamo disk.");

119 
rc
 = 
	`U¶ßd_nÙify
(
cÚn
, 
hªdËr
, "dÚe", 
tmp_Çme
);

120 
	`check
(
rc
 == 0, "Failedo‚otifyheƒnd ofhe upload.");

122 
	`bde¡roy
(
»suÉ
);

123 
	`bde¡roy
(
tmp_Çme
);

124 
	`fdşo£
(
tmpfd
);

127 
”rÜ
:

128 if(
»suÉ
è
	`bde¡roy
(result);

129 
	`fdşo£
(
tmpfd
);

131 if(
tmp_Çme
 !ğ
NULL
) {

132 
	`uÆšk
((*)
tmp_Çme
->
d©a
);

133 
	`bde¡roy
(
tmp_Çme
);

137 
	}
}

	@src/upload.h

1 #iâdeà
_u¶ßd_h


2 
	#_u¶ßd_h


	)

4 
	~"cÚÃùiÚ.h
"

5 
	~"hªdËr.h
"

7 
U¶ßd_fe
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, 
cÚ‹Á_Ën
);

8 
U¶ßd_nÙify
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, cÚ¡ *
¡age
, 
b¡ršg
 
tmp_Çme
);

	@src/version.h

1 
	#VERSION
 "MÚg»l2/1.7.5"

	)

	@tests/bstr_tests.c

1 #undeà
NDEBUG


2 
	~<¡dio.h
>

3 
	~<b¡r/b¡¾ib.h
>

4 
	~<b¡r/b¡¿ux.h
>

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<¡d¬g.h
>

8 
	~<lim™s.h
>

9 
	~<ùy³.h
>

10 
	~<dbg.h
>

12 
	$tWr™e
 (cÚ¡ * 
buf
, 
size_t
 
–size
, size_ˆ
ÃËm
, * 
·rm
) {

13 
b¡ršg
 
b
 = (b¡ršgè
·rm
;

14 
size_t
 
i
;

16 ià(
NULL
 =ğ
b
 || NULL =ğ
buf
 || 0 =ğ
–size
 || 0 =ğ
ÃËm
)

17  -
__LINE__
;

19 
i
=0; i < 
ÃËm
; i++) {

20 ià(0 > 
	`bÿtblk
 (
b
, 
buf
, 
–size
)) ;

21 
buf
 = (cÚ¡ *è(
–size
 + (const *) buf);

23  (è
i
;

24 
	}
}

26 
	$‹¡aux0
 () {

27 
bwr™eSŒ—m
 * 
ws
;

28 
b¡ršg
 
s
;

29 
»t
 = 0;

31 
	`debug
 ("TEST: struct bwriteStream functions.");

33 
ws
 = 
	`bwsO³n
 ((
bNwr™e
è
tWr™e
, (
s
 = 
	`bäomc¡r
 ("")));

34 
	`bwsBuffL’gth
 (
ws
, 8);

35 
»t
 +ğ8 !ğ
	`bwsBuffL’gth
 (
ws
, 0);

36 
	`bwsWr™eBlk
 (
ws
, 
	`bsSticBlkP¬ms
 ("Hello "));

37 
»t
 +ğ0 =ğ
	`bi£qc¡r
 (
s
, "");

38 
	`bwsWr™eBlk
 (
ws
, 
	`bsSticBlkP¬ms
 ("World"));

39 
»t
 +ğ0 =ğ
	`bi£qc¡r
 (
s
, "Hello Wo");

40 
»t
 +ğ
s
 !ğ
	`bwsClo£
 (
ws
);

41 
»t
 +ğ0 =ğ
	`bi£qc¡r
 (
s
, "Hello World");

43 
	`bde¡roy
(
s
);

45 
	`debug
 ("\t# fau»s: %d", 
»t
);

47  
»t
;

48 
	}
}

50 
	$‹¡aux1
 () {

51 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

52 
b¡ršg
 
b
, 
c
, 
d
;

53 
»t
 = 0;

55 
	`debug
 ("TEST: bTail‡nd bHead functions.");

56 
b
 = 
	`bTa
 (&
t
, 5);

57 
c
 = 
	`bH—d
 (&
t
, 5);

58 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "world");

59 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
c
, "Hello");

60 
	`bde¡roy
 (
b
);

61 
	`bde¡roy
 (
c
);

63 
b
 = 
	`bTa
 (&
t
, 0);

64 
c
 = 
	`bH—d
 (&
t
, 0);

65 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

66 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
c
, "");

67 
	`bde¡roy
 (
b
);

68 
	`bde¡roy
 (
c
);

70 
d
 = 
	`b¡rıy
 (&
t
);

71 
b
 = 
	`bTa
 (
d
, 5);

72 
c
 = 
	`bH—d
 (
d
, 5);

73 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "world");

74 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
c
, "Hello");

75 
	`bde¡roy
 (
b
);

76 
	`bde¡roy
 (
c
);

77 
	`bde¡roy
 (
d
);

79 
	`debug
 ("\t# fau»s: %d", 
»t
);

81  
»t
;

82 
	}
}

84 
	$‹¡aux2
 () {

85 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

86 
b¡ršg
 
b
;

87 
»t
 = 0, 
»to
;

89 
	`debug
 ("TEST: bSetChar function.");

90 
»t
 +ğ0 <ğ
	`bS‘Ch¬
 (&
t
, 4, ',');

91 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
 = 
	`b¡rıy
 (&
t
), 4, ',');

92 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hell, world");

93 
»t
 +ğ0 <ğ
	`bS‘Ch¬
 (
b
, -1, 'x');

94 
b
->
¦’
 = 2;

95 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
, 1, 'i');

96 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hi");

97 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
, 2, 's');

98 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "His");

99 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
, 1, '\0');

100 
»t
 +ğ
	`bËngth
 (
b
) != 3;

101 
»t
 +ğ
	`bch¬e
 (
b
, 0, '?') != 'H';

102 
»t
 +ğ
	`bch¬e
 (
b
, 1, '?') != '\0';

103 
»t
 +ğ
	`bch¬e
 (
b
, 2, '?') != 's';

104 
	`bde¡roy
 (
b
);

106 
	`debug
 ("\t# fau»s: %d", 
»t
);

108 
»to
 = 
»t
;

109 
»t
 = 0;

111 
	`debug
 ("TEST: bSetCstrChar function.");

112 
»t
 +ğ0 <ğ
	`bS‘C¡rCh¬
 (&
t
, 4, ',');

113 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
 = 
	`b¡rıy
 (&
t
), 4, ',');

114 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hell, world");

115 
»t
 +ğ0 <ğ
	`bS‘C¡rCh¬
 (
b
, -1, 'x');

116 
b
->
¦’
 = 2;

117 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
, 1, 'i');

118 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hi");

119 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
, 2, 's');

120 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "His");

121 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
, 1, '\0');

122 
»t
 +ğ
	`bËngth
 (
b
) != 1;

123 
»t
 +ğ
	`bch¬e
 (
b
, 0, '?') != 'H';

124 
	`bde¡roy
 (
b
);

126 
	`debug
 ("\t# fau»s: %d", 
»t
);

128  
»to
 + 
»t
;

129 
	}
}

131 
	$‹¡aux3
 () {

132 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

133 
b¡ršg
 
b
;

134 
»t
 = 0;

136 
	`debug
 ("TEST: bFill function.");

137 
»t
 +ğ0 <ğ
	`bFl
 (&
t
, 'x', 7);

138 
»t
 +ğ0 > 
	`bFl
 (
b
 = 
	`b¡rıy
 (&
t
), 'x', 7);

139 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "xxxxxxx");

140 
»t
 +ğ0 <ğ
	`bFl
 (
b
, 'x', -1);

141 
»t
 +ğ0 > 
	`bFl
 (
b
, 'x', 0);

142 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

143 
	`bde¡roy
 (
b
);

145 
	`debug
 ("\t# fau»s: %d", 
»t
);

147  
»t
;

148 
	}
}

150 
	$‹¡aux4
 () {

151 
gb¡ršg
 
t
 = 
	`bsStic
 ("foo");

152 
b¡ršg
 
b
;

153 
»t
 = 0;

155 
	`debug
 ("TEST: bReplicate function.");

156 
»t
 +ğ0 <ğ
	`bR•liÿ‹
 (&
t
, 4);

157 
»t
 +ğ0 <ğ
	`bR•liÿ‹
 (
b
 = 
	`b¡rıy
 (&
t
), -1);

158 
»t
 +ğ0 > 
	`bR•liÿ‹
 (
b
, 4);

159 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "foofoofoofoo");

160 
»t
 +ğ0 > 
	`bR•liÿ‹
 (
b
, 0);

161 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

162 
	`bde¡roy
 (
b
);

164 
	`debug
 ("\t# fau»s: %d", 
»t
);

166  
»t
;

167 
	}
}

169 
	$‹¡aux5
 () {

170 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

171 
b¡ršg
 
b
;

172 
»t
 = 0;

174 
	`debug
 ("TEST: bReverse function.");

175 
»t
 +ğ0 <ğ
	`bRev”£
 (&
t
);

176 
»t
 +ğ0 > 
	`bRev”£
 (
b
 = 
	`b¡rıy
 (&
t
));

177 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "dlrow olleH");

178 
b
->
¦’
 = 0;

179 
»t
 +ğ0 > 
	`bRev”£
 (
b
);

180 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

181 
	`bde¡roy
 (
b
);

183 
	`debug
 ("\t# fau»s: %d", 
»t
);

185  
»t
;

186 
	}
}

188 
	$‹¡aux6
 () {

189 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

190 
b¡ršg
 
b
;

191 
»t
 = 0;

193 
	`debug
 ("TEST: bInsertChrs function.");

194 
»t
 +ğ0 <ğ
	`bIn£¹Chrs
 (&
t
, 6, 4, 'x', '?');

195 
»t
 +ğ0 > 
	`bIn£¹Chrs
 (
b
 = 
	`b¡rıy
 (&
t
), 6, 4, 'x', '?');

196 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hello xxxxworld");

197 
	`bde¡roy
 (
b
);

199 
	`debug
 ("\t# fau»s: %d", 
»t
);

201  
»t
;

202 
	}
}

204 
	$‹¡aux7
 () {

205 
gb¡ršg
 
t
 = 
	`bsStic
 (" i‡m ");

206 
b¡ršg
 
b
;

207 
»t
 = 0;

209 
	`debug
 ("TEST: bJustify functions.");

210 
»t
 +ğ0 <ğ
	`bJu¡ifyLeá
 (&
t
, ' ');

211 
»t
 +ğ0 <ğ
	`bJu¡ifyRight
 (&
t
, 8, ' ');

212 
»t
 +ğ0 <ğ
	`bJu¡ifyM¬gš
 (&
t
, 8, ' ');

213 
»t
 +ğ0 <ğ
	`bJu¡ifyC’‹r
 (&
t
, 8, ' ');

214 
»t
 +ğ0 > 
	`bJu¡ifyLeá
 (
b
 = 
	`b¡rıy
 (&
t
), ' ');

215 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "i‡m");

216 
»t
 +ğ0 > 
	`bJu¡ifyRight
 (
b
, 8, ' ');

217 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, " i‡m");

218 
»t
 +ğ0 > 
	`bJu¡ifyM¬gš
 (
b
, 8, ' ');

219 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "i‡m");

220 
»t
 +ğ0 > 
	`bJu¡ifyC’‹r
 (
b
, 8, ' ');

221 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, " i‡m");

222 
	`bde¡roy
 (
b
);

224 
	`debug
 ("\t# fau»s: %d", 
»t
);

226  
»t
;

227 
	}
}

229 
	$‹¡aux8
 () {

230 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

231 
b¡ršg
 
b
;

232 * 
c
;

233 
»t
 = 0;

235 
	`debug
 ("TEST: NetStr functions.");

236 
c
 = 
	`bSŒ2N‘SŒ
 (&
t
);

237 
»t
 +ğ0 !ğ
	`¡rcmp
 (
c
, "11:Hello world,");

238 
b
 = 
	`bN‘SŒ2B¡r
 (
c
);

239 
»t
 +ğ0 >ğ
	`bi£q
 (
b
, &
t
);

240 
	`bde¡roy
 (
b
);

241 
	`bc¡rä“
 (
c
);

243 
	`debug
 ("\t# fau»s: %d", 
»t
);

245  
»t
;

246 
	}
}

248 
	$‹¡aux9
 () {

249 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

250 
b¡ršg
 
b
, 
c
;

251 
”r
, 
»t
 = 0;

253 
	`debug
 ("TEST: Base 64 codec.");

255 
b
 = 
	`bBa£64Encode
 (&
t
);

256 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "SGVsbG8gd29ybGQ=");

257 
c
 = 
	`bBa£64DecodeEx
 (
b
, &
”r
);

258 
»t
 +ğ0 !ğ
”r
;

259 
»t
 +ğ0 >ğ
	`bi£q
 (
c
, &
t
);

260 
	`bde¡roy
 (
b
);

261 
	`bde¡roy
 (
c
);

263 
	`debug
 ("\t# fau»s: %d", 
»t
);

265  
»t
;

266 
	}
}

268 
	$‹¡aux10
 () {

269 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

270 
b¡ršg
 
b
, 
c
;

271 
”r
, 
»t
 = 0;

273 
	`debug
 ("TEST: UU codec.");

275 
b
 = 
	`bUuEncode
 (&
t
);

276 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "+2&5L;&\\@=V]R;&0`\r\n");

277 
c
 = 
	`bUuDecodeEx
 (
b
, &
”r
);

278 
»t
 +ğ0 !ğ
”r
;

279 
»t
 +ğ0 >ğ
	`bi£q
 (
c
, &
t
);

280 
	`bde¡roy
 (
b
);

281 
	`bde¡roy
 (
c
);

283 
	`debug
 ("\t# fau»s: %d", 
»t
);

285  
»t
;

286 
	}
}

288 
	$‹¡aux11
 () {

289 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

290 
Yt¡r
[] = {0x72, 0x8f, 0x96, 0x96, 0x99, 0x4a, 0xa1, 0x99, 0x9c, 0x96, 0x8e};

291 
b¡ršg
 
b
, 
c
;

292 
»t
 = 0;

294 
	`debug
 ("TEST: Y codec.");

296 
b
 = 
	`bYEncode
 (&
t
);

297 
»t
 +ğ11 !ğ
b
->
¦’
;

298 
»t
 +ğ0 >ğ
	`bis¡emeqblk
 (
b
, 
Yt¡r
, 11);

299 
c
 = 
	`bYDecode
 (
b
);

300 
»t
 +ğ0 >ğ
	`bi£q
 (
c
, &
t
);

301 
	`bde¡roy
 (
b
);

302 
	`bde¡roy
 (
c
);

304 
	`debug
 ("\t# fau»s: %d", 
»t
);

306  
»t
;

307 
	}
}

309 
	$‹¡aux12
 () {

310 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

311 
bSŒ—m
 * 
s
;

312 
b¡ršg
 
b
;

313 
»t
 = 0;

315 
	`debug
 ("TEST: bsFromBstr.");

317 
»t
 = 
	`b¤—d
 (
b
 = 
	`bäomc¡r
 (""), 
s
 = 
	`bsFromB¡r
 (&
t
), 6);

318 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b
, "Hello ");

319 ià(
b
èb->
¦’
 = 0;

320 
»t
 = 
	`b¤—d
 (
b
, 
s
, 6);

321 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b
, "world");

323 
	`bde¡roy
 (
b
);

324 
	`bsşo£
 (
s
);

326 
	`debug
 ("\t# fau»s: %d", 
»t
);

328  
»t
;

329 
	}
}

331 
	svfg‘c
 {

332 
	mofs
;

333 
b¡ršg
 
	mba£
;

345 
b¡ršg
 
	gdumpOut
[16];

346 
	grÙ
 = 0;

348 * 
	$dumpB¡ršg
 (cÚ¡ 
gb¡ršg
 * 
b
) {

349 
rÙ
 = (rot + 1) % ()16;

350 ià(
dumpOut
[
rÙ
] =ğ
NULL
) {

351 
dumpOut
[
rÙ
] = 
	`bäomc¡r
 ("");

352 ià(
dumpOut
[
rÙ
] =ğ
NULL
)  "FATAL INTERNAL ERROR";

354 
dumpOut
[
rÙ
]->
¦’
 = 0;

355 ià(
b
 =ğ
NULL
) {

356 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "NULL");

358 
msg
[256];

359 
	`¥rštf
(
msg
, "%p", (*)
b
);

360 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], 
msg
);

362 ià(
b
->
¦’
 < 0) {

363 
	`¥rštf
 (
msg
, ":[”r:¦’=%d<0]", 
b
->
¦’
);

364 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], 
msg
);

366 ià(
b
->
mËn
 > 0 && b->mËÀ< b->
¦’
) {

367 
	`¥rštf
 (
msg
, ":[”r:mËn=%d<¦’=%d]", 
b
->
mËn
, b->
¦’
);

368 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], 
msg
);

370 ià(
b
->
mËn
 == -1) {

371 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "[p]");

372 } ià(
b
->
mËn
 < 0) {

373 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "[c]");

375 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], ":");

376 ià(
b
->
d©a
 =ğ
NULL
) {

377 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "[err:data=NULL]");

379 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "\"");

380 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], (cÚ¡ *è
b
->
d©a
);

381 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "\"");

386  (*è
dumpOut
[
rÙ
]->
d©a
;

387 
	}
}

389 
	$‹¡0_0
 (cÚ¡ * 
s
, cÚ¡ * 
»s
) {

390 
b¡ršg
 
b0
 = 
	`bäomc¡r
 (
s
);

391 
»t
 = 0;

393 ià(
s
 =ğ
NULL
) {

394 ià(
»s
 !ğ
NULL
è
»t
++;

395 
	`debug
 (".\tbäomc¡¸(NULLèğ%s", 
	`dumpB¡ršg
 (
b0
));

396  
»t
;

399 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b0
->
¦’
)

400 || (0 !ğ
	`memcmp
 (
»s
, 
b0
->
d©a
, b0->
¦’
));

401 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

403 
	`debug
 (".\tbäomc¡¸(\"%s\"èğ%s", 
s
, 
	`dumpB¡ršg
 (
b0
));

404 
	`bde¡roy
 (
b0
);

405  
»t
;

406 
	}
}

408 
	$‹¡0_1
 (cÚ¡ * 
s
, 
Ën
, cÚ¡ * 
»s
) {

409 
b¡ršg
 
b0
 = 
	`bäomc¡¿Îoc
 (
Ën
, 
s
);

410 
»t
 = 0;

412 ià(
s
 =ğ
NULL
) {

413 ià(
»s
 !ğ
NULL
è
»t
++;

414 
	`debug
 (".\tbäomc¡¿Îoø(*, NULLèğ%s", 
	`dumpB¡ršg
 (
b0
));

415  
»t
;

418 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b0
->
¦’
)

419 || (0 !ğ
	`memcmp
 (
»s
, 
b0
->
d©a
, b0->
¦’
));

420 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

421 
»t
 +ğ
Ën
 > 
b0
->
mËn
;

423 
	`debug
 (".\tbäomc¡¿Îoø(%d, \"%s\"èğ%s", 
Ën
, 
s
, 
	`dumpB¡ršg
 (
b0
));

424 
	`bde¡roy
 (
b0
);

425  
»t
;

426 
	}
}

428 
	#EMPTY_STRING
 ""

	)

429 
	#SHORT_STRING
 "bogus"

	)

430 
	#LONG_STRING
 "Thi i ¨bogu buˆ»asÚably†Úg sŒšg. Ju¡†ÚgƒnoughØÿu£ somm®locšg."

	)

432 
	$‹¡0
 () {

433 
»t
 = 0;

435 
	`debug
 ("TEST: bstring bfromcstr (const char * str);");

438 
»t
 +ğ
	`‹¡0_0
 (
NULL
, NULL);

441 
»t
 +ğ
	`‹¡0_0
 (
EMPTY_STRING
, EMPTY_STRING);

442 
»t
 +ğ
	`‹¡0_0
 (
SHORT_STRING
, SHORT_STRING);

443 
»t
 +ğ
	`‹¡0_0
 (
LONG_STRING
, LONG_STRING);

444 
	`debug
 ("\t# fau»s: %d", 
»t
);

446 
	`debug
 ("TEST: bstring bfromcstralloc (int†en, const char * str);");

449 
»t
 +ğ
	`‹¡0_1
 (
NULL
, 0, NULL);

450 
»t
 +ğ
	`‹¡0_1
 (
NULL
, 30, NULL);

453 
»t
 +ğ
	`‹¡0_1
 (
EMPTY_STRING
, 0, EMPTY_STRING);

454 
»t
 +ğ
	`‹¡0_1
 (
EMPTY_STRING
, 30, EMPTY_STRING);

455 
»t
 +ğ
	`‹¡0_1
 (
SHORT_STRING
, 0, SHORT_STRING);

456 
»t
 +ğ
	`‹¡0_1
 (
SHORT_STRING
, 30, SHORT_STRING);

457 
»t
 +ğ
	`‹¡0_1
 ( 
LONG_STRING
, 0, LONG_STRING);

458 
»t
 +ğ
	`‹¡0_1
 ( 
LONG_STRING
, 30, LONG_STRING);

459 
	`debug
 ("\t# fau»s: %d", 
»t
);

461  
»t
;

462 
	}
}

464 
	$‹¡1_0
 (cÚ¡ * 
blk
, 
Ën
, cÚ¡ * 
»s
) {

465 
b¡ršg
 
b0
 = 
	`blk2b¡r
 (
blk
, 
Ën
);

466 
»t
 = 0;

467 ià(
b0
 =ğ
NULL
) {

468 ià(
»s
 !ğ
NULL
è
»t
++;

469 
	`debug
 (".\tblk2b¡¸(NULL,†’=%dèğ%s", 
Ën
, 
	`dumpB¡ršg
 (
b0
));

471 
»t
 +ğ(
»s
 =ğ
NULL
è|| (
Ën
 !ğ
b0
->
¦’
)

472 || (0 !ğ
	`memcmp
 (
»s
, 
b0
->
d©a
, 
Ën
));

473 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

474 
	`debug
 (".\tblk2b¡¸(blk=%p,†’=%dèğ%s", 
blk
, 
Ën
, 
	`dumpB¡ršg
 (
b0
));

477 ià(
»t
) {

478 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

479 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

480 
	`debug
 (")");

482 
	`bde¡roy
 (
b0
);

483  
»t
;

484 
	}
}

486 
	$‹¡1
 () {

487 
»t
 = 0;

489 
	`debug
 ("TEST: bstring blk2bstr (const void * blk, int†en);");

492 
»t
 +ğ
	`‹¡1_0
 (
NULL
, 10, NULL);

493 
»t
 +ğ
	`‹¡1_0
 (
NULL
, 0, NULL);

494 
»t
 +ğ
	`‹¡1_0
 (
NULL
, -1, NULL);

497 
»t
 +ğ
	`‹¡1_0
 (
SHORT_STRING
,  (SHORT_STRING)-1, SHORT_STRING);

498 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
,  (LONG_STRING)-1, LONG_STRING);

499 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
, 5, "This ");

500 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
, 0, "");

501 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
, -1, 
NULL
);

502 
	`debug
 ("\t# fau»s: %d", 
»t
);

503  
»t
;

504 
	}
}

506 
	$‹¡2_0
 (
cÚ¡_b¡ršg
 
b
, 
z
, cÚ¡ * 
»s
) {

507 * 
s
 = 
	`b¡r2c¡r
 (
b
, 
z
);

508 
»t
 = 0;

509 ià(
s
 =ğ
NULL
) {

510 ià(
»s
 !ğ
NULL
è
»t
++;

511 
	`debug
 (".\tb¡r2c¡¸(%s, %02XèğNULL", 
	`dumpB¡ršg
 (
b
), 
z
);

512 
	`bc¡rä“
(
s
);

513  
»t
;

516 ià(
»s
 =ğ
NULL
è
»t
++;

518 ià(
z
 !ğ'\0'èià((è
	`¡¾’
 (
s
è!ğ
b
->
¦’
è
»t
++;

519 ià(!
»t
) {

520 
»t
 +ğ(0 !ğ
	`memcmp
 (
»s
, 
b
->
d©a
, b->
¦’
));

524 
	`debug
 (".\tb¡r2c¡¸(%s, %02Xèğ\"%s\"", 
	`dumpB¡ršg
 (
b
), 
z
, 
s
);

525 
	`bc¡rä“
 (
s
);

526  
»t
;

527 
	}
}

529 
gb¡ršg
 
	gem±yB¡ršg
 = 
bsStic
 ("");

530 
gb¡ršg
 
	gshÜtB¡ršg
 = 
bsStic
 ("bogus");

531 
gb¡ršg
 
	glÚgB¡ršg
 = 
bsStic
 ("This is‡ bogus but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

533 
gb¡ršg
 
	gbadB¡ršg1
 = {8, 4, 
NULL
};

534 
gb¡ršg
 
	gbadB¡ršg2
 = {2, -5, (*) "bogus"};

535 
gb¡ršg
 
	gbadB¡ršg3
 = {2, 5, (*) "bogus"};

537 
gb¡ršg
 
	gxxxxxB¡ršg
 = 
bsStic
 ("xxxxx");

539 
	$‹¡2
 () {

540 
»t
 = 0;

542 
	`debug
 ("TEST: char * bstr2cstr (const_bstring s, char z);");

545 
»t
 +ğ
	`‹¡2_0
 (
NULL
, () '?', NULL);

548 
»t
 +ğ
	`‹¡2_0
 (&
em±yB¡ršg
, (è'?',ƒm±yB¡ršg.
d©a
);

549 
»t
 +ğ
	`‹¡2_0
 (&
shÜtB¡ršg
, (è'?', shÜtB¡ršg.
d©a
);

550 
»t
 +ğ
	`‹¡2_0
 (&
lÚgB¡ršg
, (è'?',†ÚgB¡ršg.
d©a
);

551 
»t
 +ğ
	`‹¡2_0
 (&
badB¡ršg1
, (è'?', 
NULL
);

552 
»t
 +ğ
	`‹¡2_0
 (&
badB¡ršg2
, (è'?', 
NULL
);

553 
	`debug
 ("\t# fau»s: %d", 
»t
);

554  
»t
;

555 
	}
}

557 
	$‹¡3_0
 (
cÚ¡_b¡ršg
 
b
) {

558 
b¡ršg
 
b0
 = 
	`b¡rıy
 (
b
);

559 
»t
 = 0;

560 
	`debug
 (".\tb¡rıy (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
b0
));

561 ià(
b0
 =ğ
NULL
) {

562 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >ğ0è
»t
++;

564 
»t
 +ğ(
b
 =ğ
NULL
è|| (b->
¦’
 !ğ
b0
->slen)

565 || (0 !ğ
	`memcmp
 (
b
->
d©a
, 
b0
->d©a, b->
¦’
));

566 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

568 
	`bde¡roy
 (
b0
);

569  
»t
;

570 
	}
}

572 
	$‹¡3
 () {

573 
»t
 = 0;

575 
	`debug
 ("TEST: bstring bstrcpy (const_bstring b1);");

578 
»t
 +ğ
	`‹¡3_0
 (
NULL
);

579 
»t
 +ğ
	`‹¡3_0
 (&
badB¡ršg1
);

580 
»t
 +ğ
	`‹¡3_0
 (&
badB¡ršg2
);

583 
»t
 +ğ
	`‹¡3_0
 (&
em±yB¡ršg
);

584 
»t
 +ğ
	`‹¡3_0
 (&
shÜtB¡ršg
);

585 
»t
 +ğ
	`‹¡3_0
 (&
lÚgB¡ršg
);

586 
	`debug
 ("\t# fau»s: %d", 
»t
);

587  
»t
;

588 
	}
}

590 
	$‹¡4_0
 (
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
, cÚ¡ * 
»s
) {

591 
b¡ršg
 
b0
 = 
	`bmid¡r
 (
b
, 
Ëá
, 
Ën
);

592 
»t
 = 0;

593 
	`debug
 (".\tbmid¡¸(%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b
), 
Ëá
, 
Ën
, dumpB¡ršg (
b0
));

594 ià(
b0
 =ğ
NULL
) {

595 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >ğ0 && 
Ën
 >ğ0è
»t
++;

597 
»t
 +ğ(
b
 =ğ
NULL
è|| (
»s
 =ğNULLè|| (
b0
->
¦’
 > 
Ën
 &&†en >= 0)

598 || (
b0
->
¦’
 !ğ(è
	`¡¾’
 (
»s
))

599 || (
b0
->
¦’
 > 0 && 0 !ğ
	`memcmp
 (
»s
, b0->
d©a
, b0->slen));

600 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

602 ià(
»t
) {

603 
	`debug
 ("(b =ğNULLè = %d", (
b
 =ğ
NULL
));

604 
	`debug
 ("Ôe =ğNULLè = %d", (
»s
 =ğ
NULL
));

605 
	`debug
 ("(b0->¦’ >†’ &&†’ >ğ0èğ%d", (
b0
->
¦’
 > 
Ën
 &&†en >= 0));

606 ià(
»s
è
	`debug
 ("(b0->¦’ !ğ¡¾’ (»s)è = %d", (
b0
->
¦’
 !ğ(è
	`¡¾’
 (res)));

607 
	`debug
 ("(b0->¦’ > 0 && 0 !ğmemcm°Ôes, b0->d©a, b0->¦’èğ%d", (
b0
->
¦’
 > 0 && 0 !ğ
	`memcmp
 (
»s
, b0->
d©a
, b0->slen)));

609 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

610 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

611 
	`debug
 (")");

613 
	`bde¡roy
 (
b0
);

614  
»t
;

615 
	}
}

617 
	$‹¡4
 () {

618 
»t
 = 0;

620 
	`debug
 ("TEST: bstring bmidstr (const_bstring b, int†eft, int†en);");

623 
»t
 +ğ
	`‹¡4_0
 (
NULL
, 0, 0, NULL);

624 
»t
 +ğ
	`‹¡4_0
 (
NULL
, 0, 2, NULL);

625 
»t
 +ğ
	`‹¡4_0
 (
NULL
, 0, -2, NULL);

626 
»t
 +ğ
	`‹¡4_0
 (
NULL
, -5, 2, NULL);

627 
»t
 +ğ
	`‹¡4_0
 (
NULL
, -5, -2, NULL);

628 
»t
 +ğ
	`‹¡4_0
 (&
badB¡ršg1
, 1, 3, 
NULL
);

629 
»t
 +ğ
	`‹¡4_0
 (&
badB¡ršg2
, 1, 3, 
NULL
);

632 
»t
 +ğ
	`‹¡4_0
 (&
em±yB¡ršg
, 0, 0, "");

633 
»t
 +ğ
	`‹¡4_0
 (&
em±yB¡ršg
, 0, -1, "");

634 
»t
 +ğ
	`‹¡4_0
 (&
em±yB¡ršg
, 1, 3, "");

635 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 0, 0, "");

636 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 0, -1, "");

637 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 1, 3, "ogu");

638 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, -1, 3, "bo");

639 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, -1, 9, "bogus");

640 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 3, -1, "");

641 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 9, 3, "");

642 
	`debug
 ("\t# fau»s: %d", 
»t
);

643  
»t
;

644 
	}
}

646 
	$‹¡5_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
, cÚ¡ * 
»s
) {

647 
b¡ršg
 
b2
;

648 
rv
, 
»t
 = 0;

650 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

651 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0 ) {

652 
b2
 = 
	`b¡rıy
 (
b0
);

653 
	`bwr™•rÙeù
 (*
b2
);

655 
	`debug
 (".\tbcÚÿˆ(%s, ", 
	`dumpB¡ršg
 (
b2
));

657 
rv
 = 
	`bcÚÿt
 (
b2
, 
b1
);

658 
»t
 +ğ(
rv
 == 0);

659 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

661 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

663 
	`bwr™—Îow
 (*
b2
);

665 
	`debug
 (".\tbcÚÿˆ(%s, ", 
	`dumpB¡ršg
 (
b2
));

667 
rv
 = 
	`bcÚÿt
 (
b2
, 
b1
);

669 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

671 ià(
b1
è
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen + b1->slen);

672 
»t
 +ğ((0 !ğ
rv
è&& (
b1
 !ğ
NULL
)) || ((0 ==„v) && (b1 == NULL));

673 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

674 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

675 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

676 
	`bde¡roy
 (
b2
);

678 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bcÚÿt
 (
b0
, 
b1
)));

679 
	`debug
 (".\tbcÚÿˆ(%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

682 ià(
»t
) {

683 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

684 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

685 
	`debug
 (")");

687  
»t
;

688 
	}
}

690 
	$‹¡5_1
 () {

691 
b¡ršg
 
b
, 
c
;

692 
gb¡ršg
 
t
;

693 
i
, 
»t
;

695 
	`debug
 ("TEST: bconcat‡liasing");

696 
»t
=
i
=0; i < 
lÚgB¡ršg
.
¦’
; i++) {

697 
b
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

698 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

699 
	`bmid2tb¡r
 (
t
, 
b
, 
i
, 
lÚgB¡ršg
.
¦’
);

700 
»t
 +ğ0 !ğ
	`bcÚÿt
 (
c
, &
t
);

701 
»t
 +ğ0 !ğ
	`bcÚÿt
 (
b
, &
t
);

702 
»t
 +ğ!
	`bi£q
 (
b
, 
c
);

703 
	`bde¡roy
 (
b
);

704 
	`bde¡roy
 (
c
);

707 
b
 = 
	`bäomc¡r
 ("abcd");

708 
c
 = 
	`bäomc¡r
 ("abcd");

710 
»t
=
i
=0; i < 100; i++) {

711 
	`bmid2tb¡r
 (
t
, 
b
, 0, 3);

712 
»t
 +ğ0 !ğ
	`bÿtc¡r
 (
c
, "abc");

713 
»t
 +ğ0 !ğ
	`bcÚÿt
 (
b
, &
t
);

714 
»t
 +ğ!
	`bi£q
 (
b
, 
c
);

717 
	`bde¡roy
 (
b
);

718 
	`bde¡roy
 (
c
);

720 ià(
»t
) {

721 
	`debug
 ("\t\lŸ çu»s(%dèğ%d", 
__LINE__
, 
»t
);

724  
»t
;

725 
	}
}

727 
	$‹¡5
 () {

728 
»t
 = 0;

730 
	`debug
 ("TEST: int bconcat (bstring b0, const_bstring b1);");

733 
»t
 +ğ
	`‹¡5_0
 (
NULL
, NULL, NULL);

734 
»t
 +ğ
	`‹¡5_0
 (
NULL
, &
em±yB¡ršg
, NULL);

735 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, 
NULL
, "");

736 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
NULL
);

737 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 
NULL
);

738 
»t
 +ğ
	`‹¡5_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
NULL
);

739 
»t
 +ğ
	`‹¡5_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 
NULL
);

742 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &emptyBstring, "");

743 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &
shÜtB¡ršg
, "bogus");

744 
»t
 +ğ
	`‹¡5_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, "bogus");

745 
»t
 +ğ
	`‹¡5_0
 (&
shÜtB¡ršg
, &shortBstring, "bogusbogus");

747 
»t
 +ğ
	`‹¡5_1
 ();

749 
	`debug
 ("\t# fau»s: %d", 
»t
);

750  
»t
;

751 
	}
}

753 
	$‹¡6_0
 (
b¡ršg
 
b
, 
c
, cÚ¡ * 
»s
) {

754 
b¡ršg
 
b0
;

755 
rv
, 
»t
 = 0;

757 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

758 
b0
 = 
	`b¡rıy
 (
b
);

759 
	`bwr™•rÙeù
 (*
b0
);

760 
rv
 = 
	`bcÚch¬
 (
b0
, 
c
);

761 
»t
 +ğ(
rv
 == 0);

762 ià(!
	`bi£q
 (
b0
, 
b
)è
»t
++;

764 
	`debug
 (".\tbcÚch¬ (%s, %cèğ%s", 
	`dumpB¡ršg
 (
b
), 
c
, dumpB¡ršg (
b0
));

766 
	`bwr™—Îow
 (*
b0
);

767 
rv
 = 
	`bcÚch¬
 (
b0
, 
c
);

768 
»t
 +ğ(0 !ğ
rv
);

769 
»t
 +ğ(
b0
->
¦’
 !ğ
b
->slen + 1);

770 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b0
->
¦’
)

771 || (0 !ğ
	`memcmp
 (
b0
->
d©a
, 
»s
, b0->
¦’
));

772 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

773 
	`debug
 (".\tbcÚch¬ (%s, %cèğ%s", 
	`dumpB¡ršg
 (
b
), 
c
, dumpB¡ršg (
b0
));

775 
	`bde¡roy
 (
b0
);

777 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bcÚch¬
 (
b
, 
c
)));

778 
	`debug
 (".\tbcÚch¬ (%s, %cèğ%d", 
	`dumpB¡ršg
 (
b
), 
c
, 
rv
);

781 ià(
»t
) {

782 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

783 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

784 
	`debug
 (")");

786  
»t
;

787 
	}
}

789 
	$‹¡6
 () {

790 
»t
 = 0;

792 
	`debug
 ("TEST: int bconchar (bstring b, char c);");

795 
»t
 +ğ
	`‹¡6_0
 (
NULL
, () 'x', NULL);

796 
»t
 +ğ
	`‹¡6_0
 (&
badB¡ršg1
, (è'x', 
NULL
);

797 
»t
 +ğ
	`‹¡6_0
 (&
badB¡ršg2
, (è'x', 
NULL
);

800 
»t
 +ğ
	`‹¡6_0
 (&
em±yB¡ršg
, () 'x', "x");

801 
»t
 +ğ
	`‹¡6_0
 (&
shÜtB¡ršg
, () 'x', "bogusx");

802 
	`debug
 ("\t# fau»s: %d", 
»t
);

803  
»t
;

804 
	}
}

806 
‹¡7x8_0
 (* 
âÇme
, (* 
â±r
è(cÚ¡ 
gb¡ršg
 *, cÚ¡ gb¡ršg *), cÚ¡ gb¡ršg * 
b0
, cÚ¡ gb¡ršg * 
b1
, 
»s
) {

807 
rv
, 
»t
 = 0;

809 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`â±r
 (
b0
, 
b1
)));

810 
	`debug
 (".\t% (%s, %sèğ%d", 
âÇme
, 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

811 ià(
»t
) {

812 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

814  
»t
;

815 
	}
}

817 
‹¡7x8
 (* 
âÇme
, (* 
â±r
è(cÚ¡ 
gb¡ršg
 *, const tagbstring *),

818 
»tFa
, 
»tLT
, 
»tGT
, 
»tEQ
) {

819 
»t
 = 0;

821 
	`debug
 ("TEST: iÁ % (cÚ¡_b¡ršg b0, cÚ¡_b¡ršg b1);", 
âÇme
);

824 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
NULL
, NULL, 
»tFa
);

825 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
em±yB¡ršg
, 
NULL
, 
»tFa
);

826 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
NULL
, &
em±yB¡ršg
, 
»tFa
);

827 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, 
NULL
, 
»tFa
);

828 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
NULL
, &
shÜtB¡ršg
, 
»tFa
);

829 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
badB¡ršg1
, &badB¡ršg1, 
»tFa
);

830 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
badB¡ršg2
, &badB¡ršg2, 
»tFa
);

831 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
badB¡ršg2
, 
»tFa
);

832 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
badB¡ršg2
, &
shÜtB¡ršg
, 
»tFa
);

835 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
em±yB¡ršg
, &em±yB¡ršg, 
»tEQ
);

836 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
em±yB¡ršg
, 
»tGT
);

837 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
em±yB¡ršg
, &
shÜtB¡ršg
, 
»tLT
);

838 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &shÜtB¡ršg, 
»tEQ
);

841 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

842 
b
->
d©a
[1]++;

843 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
b
, &
shÜtB¡ršg
, 
»tGT
);

844 
	`bde¡roy
 (
b
);

847 ià(
â±r
 =ğ
bi£q
) {

848 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
lÚgB¡ršg
, 
»tGT
);

849 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
lÚgB¡ršg
, &
shÜtB¡ršg
, 
»tLT
);

851 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
lÚgB¡ršg
, 'b'-'T');

852 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
lÚgB¡ršg
, &
shÜtB¡ršg
, 'T'-'b');

855 
	`debug
 ("\t# fau»s: %d", 
»t
);

856  
»t
;

857 
	}
}

859 
	#‹¡7
(è
	`‹¡7x8
 ("bi£q", 
bi£q
, -1, 0, 0, 1)

	)

860 
	#‹¡8
(è
	`‹¡7x8
 ("b¡rcmp", 
b¡rcmp
, 
SHRT_MIN
, -1, 1, 0)

	)

862 
	$‹¡9_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
, 
»s
) {

863 
rv
, 
»t
 = 0;

865 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`b¡ºcmp
 (
b0
, 
b1
, 
n
)));

866 
	`debug
 (".\tb¡ºcm°(%s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
n
, 
rv
);

867 ià(
»t
) {

868 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

870  
»t
;

871 
	}
}

873 
	$‹¡9
 () {

874 
»t
 = 0;

876 
	`debug
 ("TEST: int bstrncmp (const_bstring b0, const_bstring b1, int‚);");

879 
»t
 +ğ
	`‹¡9_0
 (
NULL
, NULL, 0, 
SHRT_MIN
);

880 
»t
 +ğ
	`‹¡9_0
 (
NULL
, NULL, -1, 
SHRT_MIN
);

881 
»t
 +ğ
	`‹¡9_0
 (
NULL
, NULL, 1, 
SHRT_MIN
);

882 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, 
NULL
, 0, 
SHRT_MIN
);

883 
»t
 +ğ
	`‹¡9_0
 (
NULL
, &
em±yB¡ršg
, 0, 
SHRT_MIN
);

884 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, 
NULL
, 1, 
SHRT_MIN
);

885 
»t
 +ğ
	`‹¡9_0
 (
NULL
, &
em±yB¡ršg
, 1, 
SHRT_MIN
);

886 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg1
, &badB¡ršg1, 1, 
SHRT_MIN
);

887 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg2
, &badB¡ršg2, 1, 
SHRT_MIN
);

888 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 1, 
SHRT_MIN
);

889 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 1, 
SHRT_MIN
);

890 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 1, 
SHRT_MIN
);

891 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 1, 
SHRT_MIN
);

894 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &emptyBstring, -1, 0);

895 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &emptyBstring, 0, 0);

896 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &emptyBstring, 1, 0);

897 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, -1, 0);

898 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, 0, 0);

899 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, 1, 0);

900 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, 9, 0);

901 
	`debug
 ("\t# fau»s: %d", 
»t
);

902  
»t
;

903 
	}
}

905 
	$‹¡10_0
 (
b¡ršg
 
b
, 
»s
, 
nochªge
) {

906 
gb¡ršg
 
sb
 = 
	`bsStic
 ("<NULL>");

907 
rv
, 
x
, 
»t
 = 0;

909 ià(
b
è
sb
 = *b;

910 
	`debug
 (".\tbde¡roy (%sèğ", 
	`dumpB¡ršg
 (
b
));

911 
rv
 = 
	`bde¡roy
 (
b
);

912 
	`debug
 ("%d", 
rv
);

914 ià(
b
 !ğ
NULL
) {

915 ià(
rv
 >= 0)

918 
x
 = 1;

920 
x
 = 
	`memcmp
 (&
sb
, 
b
,  sb);

921 } 
x
 = !
nochªge
;

922 
»t
 +ğ(
rv
 !ğ
»s
);

923 
»t
 +ğ(!
nochªge
è=ğ(!
x
);

924 ià(
»t
) {

925 
	`debug
 ("\t\tçu»(%dè» ğ%d‚ochªgğ%d, x = %d, sb.¦’ = %d, sb.mËÀğ%d, sb.d©¨ğ%p", 
__LINE__
, 
»s
, 
nochªge
, 
x
, 
sb
.
¦’
, sb.
mËn
, sb.
d©a
);

927  
»t
;

928 
	}
}

930 
	$‹¡10
 () {

931 
b¡ršg
 
c
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

932 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
em±yB¡ršg
);

933 
»t
 = 0;

935 
	`debug
 ("TEST: int bdestroy (const_bstring b);");

937 
»t
 +ğ
	`‹¡10_0
 (
NULL
, 
BSTR_ERR
, 1);

940 
	`bwr™•rÙeù
 (*
b
);

941 
	`bwr™•rÙeù
 (*
c
);

942 
»t
 +ğ
	`‹¡10_0
 (
b
, 
BSTR_ERR
, 1);

943 
»t
 +ğ
	`‹¡10_0
 (
c
, 
BSTR_ERR
, 1);

944 
	`bwr™—Îow
 (*
b
);

945 
	`bwr™—Îow
 (*
c
);

946 
»t
 +ğ
	`‹¡10_0
 (
b
, 
BSTR_OK
, 0);

947 
»t
 +ğ
	`‹¡10_0
 (
c
, 
BSTR_OK
, 0);

948 
»t
 +ğ
	`‹¡10_0
 (&
em±yB¡ršg
, 
BSTR_ERR
, 1);

949 
	`bwr™—Îow
 (
em±yB¡ršg
);

950 
»t
 +ğ
	`‹¡10_0
 (&
em±yB¡ršg
, 
BSTR_ERR
, 1);

951 
»t
 +ğ
	`‹¡10_0
 (&
shÜtB¡ršg
, 
BSTR_ERR
, 1);

952 
	`bwr™—Îow
 (
em±yB¡ršg
);

953 
»t
 +ğ
	`‹¡10_0
 (&
shÜtB¡ršg
, 
BSTR_ERR
, 1);

954 
»t
 +ğ
	`‹¡10_0
 (&
badB¡ršg1
, 
BSTR_ERR
, 1);

955 
»t
 +ğ
	`‹¡10_0
 (&
badB¡ršg2
, 
BSTR_ERR
, 1);

957 
	`debug
 ("\t# fau»s: %d", 
»t
);

958  
»t
;

959 
	}
}

961 
	$‹¡11_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

962 
rv
, 
»t
 = 0;

964 
	`debug
 (".\tbš¡¸(%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

965 
rv
 = 
	`bš¡r
 (
s1
, 
pos
, 
s2
);

966 
	`debug
 ("%d", 
rv
);

967 
»t
 +ğ(
rv
 !ğ
»s
);

968 ià(
»t
) {

969 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

971  
»t
;

972 
	}
}

974 
	$‹¡11_1
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

975 
rv
, 
»t
 = 0;

977 
	`debug
 (".\tbš¡rÿ£Ës (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

978 
rv
 = 
	`bš¡rÿ£Ëss
 (
s1
, 
pos
, 
s2
);

979 
	`debug
 ("%d", 
rv
);

980 
»t
 +ğ(
rv
 !ğ
»s
);

981 ià(
»t
) {

982 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

984  
»t
;

985 
	}
}

987 
	$‹¡11
 () {

988 
b¡ršg
 
b
, 
c
;

989 
»t
 = 0;

991 
	`debug
 ("TEST: int binstr (const_bstring s1, int…os, const_bstring s2);");

992 
»t
 +ğ
	`‹¡11_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

993 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

994 
»t
 +ğ
	`‹¡11_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

995 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

996 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

997 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

998 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

999 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1000 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1002 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1003 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1004 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 1, &shÜtB¡ršg, 
BSTR_ERR
);

1005 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1006 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1007 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1008 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1009 
	`bde¡roy
 (
b
);

1010 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 
BSTR_ERR
);

1011 
	`bde¡roy
 (
b
);

1012 
»t
 +ğ
	`‹¡11_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 10);

1013 
»t
 +ğ
	`‹¡11_0
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 
BSTR_ERR
);

1015 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 0, 
b
 = bfromcstr ("sap"), 8);

1016 
	`bde¡roy
 (
c
);

1017 
	`bde¡roy
 (
b
);

1018 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 3, 
b
 = bfromcstr ("sap"), 8);

1019 
	`bde¡roy
 (
c
);

1020 
	`bde¡roy
 (
b
);

1021 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("sssssssss§p"), 3, 
b
 = bfromcstr ("sap"), 9);

1022 
	`bde¡roy
 (
c
);

1023 
	`bde¡roy
 (
b
);

1024 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 0, 
b
 = bfromcstr ("s"), 0);

1025 
	`bde¡roy
 (
c
);

1026 
	`bde¡roy
 (
b
);

1027 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 3, 
b
 = bfromcstr ("s"), 3);

1028 
	`bde¡roy
 (
c
);

1029 
	`bde¡roy
 (
b
);

1030 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 0, 
b
 = bfromcstr ("a"), 9);

1031 
	`bde¡roy
 (
c
);

1032 
	`bde¡roy
 (
b
);

1033 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 5, 
b
 = bfromcstr ("a"), 9);

1034 
	`bde¡roy
 (
c
);

1035 
	`bde¡roy
 (
b
);

1036 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("§§§§§p"), 0, 
b
 = bfromcstr ("sap"), 8);

1037 
	`bde¡roy
 (
c
);

1038 
	`bde¡roy
 (
b
);

1039 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("s§§§§§p"), 0, 
b
 = bfromcstr ("sap"), 9);

1040 
	`bde¡roy
 (
c
);

1041 
	`bde¡roy
 (
b
);

1043 
	`debug
 ("TEST: int binstrcaseless (const_bstring s1, int…os, const_bstring s2);");

1044 
»t
 +ğ
	`‹¡11_1
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1045 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1046 
»t
 +ğ
	`‹¡11_1
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1047 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1048 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1049 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1050 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1051 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1052 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1054 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1055 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1056 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 1, &shÜtB¡ršg, 
BSTR_ERR
);

1057 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1058 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1059 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1060 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1061 
	`bde¡roy
 (
b
);

1062 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 0);

1063 
	`bde¡roy
 (
b
);

1064 
»t
 +ğ
	`‹¡11_1
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 10);

1065 
»t
 +ğ
	`‹¡11_1
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 
BSTR_ERR
);

1067 
	`debug
 ("\t# fau»s: %d", 
»t
);

1068  
»t
;

1069 
	}
}

1071 
	$‹¡12_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1072 
rv
, 
»t
 = 0;

1074 
	`debug
 (".\tbš¡¼ (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1075 
rv
 = 
	`bš¡¼
 (
s1
, 
pos
, 
s2
);

1076 
	`debug
 ("%d", 
rv
);

1077 
»t
 +ğ(
rv
 !ğ
»s
);

1078 ià(
»t
) {

1079 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1081  
»t
;

1082 
	}
}

1084 
	$‹¡12_1
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1085 
rv
, 
»t
 = 0;

1087 
	`debug
 (".\tbš¡¼ÿ£Ës (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1088 
rv
 = 
	`bš¡¼ÿ£Ëss
 (
s1
, 
pos
, 
s2
);

1089 
	`debug
 ("%d", 
rv
);

1090 
»t
 +ğ(
rv
 !ğ
»s
);

1091 ià(
»t
) {

1092 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1094  
»t
;

1095 
	}
}

1097 
	$‹¡12
 () {

1098 
b¡ršg
 
b
;

1099 
»t
 = 0;

1101 
	`debug
 ("TEST: int binstrr (const_bstring s1, int…os, const_bstring s2);");

1102 
»t
 +ğ
	`‹¡12_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1103 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1104 
»t
 +ğ
	`‹¡12_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1105 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1106 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1107 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1108 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1109 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1110 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1112 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1113 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1114 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 1, &shortBstring, 0);

1115 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1116 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1117 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1118 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1119 
	`bde¡roy
 (
b
);

1120 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 
BSTR_ERR
);

1121 
	`bde¡roy
 (
b
);

1122 
»t
 +ğ
	`‹¡12_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1123 
»t
 +ğ
	`‹¡12_0
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 10);

1125 
	`debug
 ("TEST: int binstrrcaseless (const_bstring s1, int…os, const_bstring s2);");

1126 
»t
 +ğ
	`‹¡12_1
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1127 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1128 
»t
 +ğ
	`‹¡12_1
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1129 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1130 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1131 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1132 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1133 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1134 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1136 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1137 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1138 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 1, &shortBstring, 0);

1139 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1140 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1141 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1142 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1143 
	`bde¡roy
 (
b
);

1144 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 0);

1145 
	`bde¡roy
 (
b
);

1146 
»t
 +ğ
	`‹¡12_1
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1147 
»t
 +ğ
	`‹¡12_1
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 10);

1149 
	`debug
 ("\t# fau»s: %d", 
»t
);

1150  
»t
;

1151 
	}
}

1153 
	$‹¡13_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1154 
rv
, 
»t
 = 0;

1156 
	`debug
 (".\tbšch¸(%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1157 
rv
 = 
	`bšchr
 (
s1
, 
pos
, 
s2
);

1158 
	`debug
 ("%d", 
rv
);

1159 
»t
 +ğ(
rv
 !ğ
»s
);

1160 ià(
»t
) {

1161 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1163  
»t
;

1164 
	}
}

1166 
	$‹¡13
 () {

1167 
b¡ršg
 
b
;

1168 
»t
 = 0;

1169 
gb¡ršg
 
muÉËOs
 = 
	`bsStic
 ("ooooo");

1171 
	`debug
 ("TEST: int binchr (const_bstring s1, int…os, const_bstring s2);");

1172 
»t
 +ğ
	`‹¡13_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1173 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1174 
»t
 +ğ
	`‹¡13_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1175 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1176 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1177 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1178 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1179 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1180 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1182 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

1183 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1184 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1185 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, &
muÉËOs
, 1);

1186 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1187 
	`bde¡roy
 (
b
);

1188 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1189 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 10, &shÜtB¡ršg, 
BSTR_ERR
);

1190 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 1, &shortBstring, 1);

1191 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1192 
»t
 +ğ
	`‹¡13_0
 (&
xxxxxB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1193 
»t
 +ğ
	`‹¡13_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 3);

1194 
»t
 +ğ
	`‹¡13_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 10);

1195 
	`debug
 ("\t# fau»s: %d", 
»t
);

1196  
»t
;

1197 
	}
}

1199 
	$‹¡14_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1200 
rv
, 
»t
 = 0;

1202 
	`debug
 (".\tbšch¼ (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1203 
rv
 = 
	`bšch¼
 (
s1
, 
pos
, 
s2
);

1204 
	`debug
 ("%d", 
rv
);

1205 
»t
 +ğ(
rv
 !ğ
»s
);

1206 ià(
»t
) {

1207 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1209  
»t
;

1210 
	}
}

1212 
	$‹¡14
 () {

1213 
b¡ršg
 
b
;

1214 
»t
 = 0;

1216 
	`debug
 ("TEST: int binchrr (const_bstring s1, int…os, const_bstring s2);");

1217 
»t
 +ğ
	`‹¡14_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1218 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1219 
»t
 +ğ
	`‹¡14_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1220 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

1221 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1222 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1223 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1224 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1225 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1226 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1227 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1229 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1230 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1231 
	`bde¡roy
 (
b
);

1232 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1233 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 5, &shortBstring, 4);

1234 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 4, &shortBstring, 4);

1235 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 1, &shortBstring, 1);

1236 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1237 
»t
 +ğ
	`‹¡14_0
 (&
xxxxxB¡ršg
, 4, &
shÜtB¡ršg
, 
BSTR_ERR
);

1238 
»t
 +ğ
	`‹¡14_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1239 
»t
 +ğ
	`‹¡14_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 10);

1240 
	`debug
 ("\t# fau»s: %d", 
»t
);

1241  
»t
;

1242 
	}
}

1244 
	$‹¡15_0
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
, * 
»s
) {

1245 
b¡ršg
 
b2
;

1246 
rv
, 
»t
 = 0, 
lš’um
 = 0;

1248 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

1249 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

1250 
b2
 = 
	`b¡rıy
 (
b0
);

1251 
	`bwr™•rÙeù
 (*
b2
);

1253 
	`debug
 (".\tb£t¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

1255 
rv
 = 
	`b£t¡r
 (
b2
, 
pos
, 
b1
, 
fl
);

1256 
»t
 +ğ(
rv
 =ğ0); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1257 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++; iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1259 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1261 
	`bwr™—Îow
 (*
b2
);

1263 
	`debug
 (".\tb£t¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

1265 
rv
 = 
	`b£t¡r
 (
b2
, 
pos
, 
b1
, 
fl
);

1266 ià(
b1
) {

1267 
»t
 +ğ(
pos
 >ğ0è&& (
b2
->
¦’
 !ğ
b0
->¦’ + 
b1
->¦’è&& (b2->¦’ !ğpo + b1->¦’); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1268 
»t
 +ğ(
pos
 < 0è&& (
b2
->
¦’
 !ğ
b0
->¦’); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1271 
»t
 +ğ((
rv
 =ğ0è!ğ(
pos
 >ğ0)); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1272 
»t
 +ğ(
»s
 =ğ
NULL
); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1273 
»t
 +ğ((è
	`¡¾’
 (
»s
è> 
b2
->
¦’
); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1274 
»t
 +ğ(0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
)); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1275 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] !ğ'\0'; iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1277 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1279 
	`bde¡roy
 (
b2
);

1281 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`b£t¡r
 (
b0
, 
pos
, 
b1
, 
fl
))); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1282 
	`debug
 (".\tb£t¡¸(%s, %d, %s, %02Xèğ%d", 
	`dumpB¡ršg
 (
b0
), 
pos
, dumpB¡ršg (
b1
), 
fl
, 
rv
);

1285 ià(
»t
) {

1286 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
lš’um
, 
»t
, 
»s
);

1287 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1288 
	`debug
 (")");

1290  
»t
;

1291 
	}
}

1293 
	$‹¡15
 () {

1294 
»t
 = 0;

1295 
	`debug
 ("TEST: int bsetstr (bstring b0, int…os, const_bstring b1, unsigned char fill);");

1297 
»t
 +ğ
	`‹¡15_0
 (
NULL
, 0, NULL, () '?', NULL);

1298 
»t
 +ğ
	`‹¡15_0
 (
NULL
, 0, &
em±yB¡ršg
, () '?', NULL);

1299 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg1
, 0, 
NULL
, () '?', NULL);

1300 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg1
, 0, &badB¡ršg1, (è'?', 
NULL
);

1301 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, (è'?', 
NULL
);

1302 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1303 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg2
, 0, 
NULL
, () '?', NULL);

1304 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg2
, 0, &badB¡ršg2, (è'?', 
NULL
);

1305 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, (è'?', 
NULL
);

1306 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1309 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &emptyBstring, () '?', "");

1310 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 5, &emptyBstring, () '?', "?????");

1311 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 5, &
shÜtB¡ršg
, () '?', "?????bogus");

1312 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, () '?', "bogus");

1313 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, () '?', "bogus");

1314 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 0, &shortBstring, () '?', "bogus");

1315 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, -1, &shortBstring, () '?', "bogus");

1316 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 2, &shortBstring, () '?', "bobogus");

1317 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 6, &shortBstring, () '?', "bogus?bogus");

1318 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 6, 
NULL
, () '?', "bogus?");

1319 
	`debug
 ("\t# fau»s: %d", 
»t
);

1320  
»t
;

1321 
	}
}

1323 
	$‹¡16_0
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
, * 
»s
) {

1324 
b¡ršg
 
b2
;

1325 
rv
, 
»t
 = 0;

1327 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

1328 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

1329 
b2
 = 
	`b¡rıy
 (
b0
);

1330 
	`bwr™•rÙeù
 (*
b2
);

1332 
	`debug
 (".\tbš£¹ (%s, ", 
	`dumpB¡ršg
 (
b2
));

1334 
rv
 = 
	`bš£¹
 (
b2
, 
pos
, 
b1
, 
fl
);

1335 
»t
 +ğ(
rv
 == 0);

1336 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

1338 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1340 
	`bwr™—Îow
 (*
b2
);

1342 
	`debug
 (".\tbš£¹ (%s, ", 
	`dumpB¡ršg
 (
b2
));

1344 
rv
 = 
	`bš£¹
 (
b2
, 
pos
, 
b1
, 
fl
);

1345 ià(
b1
) {

1346 
»t
 +ğ(
pos
 >ğ0è&& (
b2
->
¦’
 !ğ
b0
->¦’ + 
b1
->slen) && (b2->slen !=…os + b1->slen);

1347 
»t
 +ğ(
pos
 < 0è&& (
b2
->
¦’
 !ğ
b0
->slen);

1348 
»t
 +ğ((
rv
 =ğ0è!ğ(
pos
 >ğ0 &&…o <ğ
b2
->
¦’
));

1351 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

1352 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

1353 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

1355 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1357 
	`bde¡roy
 (
b2
);

1359 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bš£¹
 (
b0
, 
pos
, 
b1
, 
fl
)));

1360 
	`debug
 (".\tbš£¹ (%s, %d, %s, %02Xèğ%d", 
	`dumpB¡ršg
 (
b0
), 
pos
, dumpB¡ršg (
b1
), 
fl
, 
rv
);

1363 ià(
»t
) {

1364 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

1365 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1366 
	`debug
 (")");

1368  
»t
;

1369 
	}
}

1371 
	$‹¡16
 () {

1372 
»t
 = 0;

1373 
	`debug
 ("TEST: int binsert (bstring b0, int…os, const_bstring b1, unsigned char fill);");

1375 
»t
 +ğ
	`‹¡16_0
 (
NULL
, 0, NULL, () '?', NULL);

1376 
»t
 +ğ
	`‹¡16_0
 (
NULL
, 0, &
em±yB¡ršg
, () '?', NULL);

1377 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg1
, 0, 
NULL
, () '?', NULL);

1378 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg1
, 0, &badB¡ršg1, (è'?', 
NULL
);

1379 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, (è'?', 
NULL
);

1380 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1381 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg2
, 0, 
NULL
, () '?', NULL);

1382 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg2
, 0, &badB¡ršg2, (è'?', 
NULL
);

1383 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, (è'?', 
NULL
);

1384 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1387 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &emptyBstring, () '?', "");

1388 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 5, &emptyBstring, () '?', "?????");

1389 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 5, &
shÜtB¡ršg
, () '?', "?????bogus");

1390 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, () '?', "bogus");

1391 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, () '?', "bogus");

1392 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 0, &shortBstring, () '?', "bogusbogus");

1393 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, -1, &shortBstring, () '?', "bogus");

1394 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 2, &shortBstring, () '?', "bobogusgus");

1395 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 6, &shortBstring, () '?', "bogus?bogus");

1396 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 6, 
NULL
, () '?', "bogus");

1397 
	`debug
 ("\t# fau»s: %d", 
»t
);

1398  
»t
;

1399 
	}
}

1401 
	$‹¡17_0
 (
b¡ršg
 
s1
, 
pos
, 
Ën
, * 
»s
) {

1402 
b¡ršg
 
b2
;

1403 
rv
, 
»t
 = 0;

1405 ià(
s1
 !ğ
NULL
 && s1->
d©a
 !ğNULL && s1->
¦’
 >= 0) {

1406 
b2
 = 
	`b¡rıy
 (
s1
);

1407 
	`bwr™•rÙeù
 (*
b2
);

1409 
	`debug
 (".\tbd–‘(%s, ", 
	`dumpB¡ršg
 (
b2
));

1411 
rv
 = 
	`bd–‘e
 (
b2
, 
pos
, 
Ën
);

1412 
»t
 +ğ(
rv
 == 0);

1413 ià(!
	`bi£q
 (
s1
, 
b2
)è
»t
++;

1415 
	`debug
 ("%d, %dèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b2
));

1417 
	`bwr™—Îow
 (*
b2
);

1419 
	`debug
 (".\tbd–‘(%s, ", 
	`dumpB¡ršg
 (
b2
));

1421 
rv
 = 
	`bd–‘e
 (
b2
, 
pos
, 
Ën
);

1422 
»t
 +ğ(
Ën
 >ğ0è!ğ(
rv
 == 0);

1423 
»t
 +ğ(
b2
->
¦’
 > 
s1
->¦’è|| (b2->¦’ < 
pos
 && s1->slen >=…os);

1425 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

1426 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

1427 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

1429 
	`debug
 ("%d, %dèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b2
));

1431 
	`bde¡roy
 (
b2
);

1433 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bd–‘e
 (
s1
, 
pos
, 
Ën
)));

1434 
	`debug
 (".\tbd–‘(%s, %d, %dèğ%d", 
	`dumpB¡ršg
 (
s1
), 
pos
, 
Ën
, 
rv
);

1437 ià(
»t
) {

1438 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

1439 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1440 
	`debug
 (")");

1442  
»t
;

1443 
	}
}

1445 
	$‹¡17
 () {

1446 
»t
 = 0;

1447 
	`debug
 ("TEST: int bdelete (bstring s1, int…os, int†en);");

1449 
»t
 +ğ
	`‹¡17_0
 (
NULL
, 0, 0, NULL);

1450 
»t
 +ğ
	`‹¡17_0
 (&
badB¡ršg1
, 0, 0, 
NULL
);

1451 
»t
 +ğ
	`‹¡17_0
 (&
badB¡ršg2
, 0, 0, 
NULL
);

1454 
»t
 +ğ
	`‹¡17_0
 (&
em±yB¡ršg
, 0, 0, "");

1455 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 1, 3, "bs");

1456 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, -1, 3, "gus");

1457 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 1, -3, "bogus");

1458 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 3, 9, "bog");

1459 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 3, 1, "bogs");

1460 
»t
 +ğ
	`‹¡17_0
 (&
lÚgB¡ršg
, 4, 300, "This");

1462 
	`debug
 ("\t# fau»s: %d", 
»t
);

1463  
»t
;

1464 
	}
}

1466 
	$‹¡18_0
 (
b¡ršg
 
b
, 
Ën
, 
»s
, 
mËn
) {

1467 
»t
 = 0;

1468 
rv
;

1469 
Ş
 = 0;

1471 
	`debug
 (".\tb®loø(%s, %dèğ", 
	`dumpB¡ršg
 (
b
), 
Ën
);

1472 ià(
b
è
Ş
 = b->
mËn
;

1473 
rv
 = 
	`b®loc
 (
b
, 
Ën
);

1474 
	`debug
 ("%d", 
rv
);

1476 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >=0 && 
Ş
 > b->
mËn
) {

1477 
	`debug
 ("\t\tçu»(%dèŞdmËÀğ%d,‚ewmËÀ%d", 
__LINE__
, 
Ş
, 
b
->
mËn
);

1478 
»t
++;

1481 ià(
rv
 !ğ
»s
) {

1482 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1483 
»t
++;

1485 ià(
b
 !ğ
NULL
 && (
mËn
 > b->mlen || b->mlen == 0)) {

1486 
	`debug
 ("\t\tçu»(%dèb->mËÀğ%d mËÀğ%d", 
__LINE__
, 
b
->
mËn
, mlen);

1487 
»t
++;

1489  
»t
;

1490 
	}
}

1492 
	$‹¡18_1_št
 (
b¡ršg
 
b
, 
Ën
, 
»s
, 
mËn
, 
__lše__
) {

1493 
»t
 = 0;

1494 
rv
;

1495 
Ş
 = 0;

1497 
	`debug
 (".\tb®locmš (%s, %dèğ", 
	`dumpB¡ršg
 (
b
), 
Ën
);

1498 ià(
b
è
Ş
 = b->
mËn
;

1500 
rv
 = 
	`b®locmš
 (
b
, 
Ën
);

1501 
	`debug
 ("[%d] %d", 
__LINE__
, 
rv
);

1503 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
mËn
 != mlen) {

1504 
	`debug
 ("\t\t[%d] fau»(%dèŞdmËÀğ%d,‚ewmËÀğ%d, mËÀğ%d†’ = %d", 
__lše__
, 
__LINE__
, 
Ş
, 
b
->
mËn
, mËn, b->
¦’
);

1505 
»t
++;

1508 ià(
rv
 !ğ
»s
) {

1509 
	`debug
 ("\t\t[%d] fau»(%dè» ğ%d", 
__lše__
, 
__LINE__
, 
»s
);

1510 
»t
++;

1513  
»t
;

1514 
	}
}

1516 
	#‹¡18_1
(
b
, 
Ën
, 
»s
, 
mËn
è
	`‹¡18_1_št
 (b,†’,„es, mËn, 
__LINE__
)

	)

1518 
	$‹¡18
 () {

1519 
»t
 = 0, 
»to
;

1520 
b¡ršg
 
b
 = 
	`bäomc¡r
 ("test");

1522 
	`debug
 ("TEST: int balloc (bstring s, int†en);");

1524 
»t
 +ğ
	`‹¡18_0
 (
NULL
, 2, 
BSTR_ERR
, 0);

1525 
»t
 +ğ
	`‹¡18_0
 (&
badB¡ršg1
, 2, 
BSTR_ERR
, 0);

1526 
»t
 +ğ
	`‹¡18_0
 (&
badB¡ršg2
, 2, 
BSTR_ERR
, 0);

1529 
»t
 +ğ
	`‹¡18_0
 (
b
, 2, 0, b->
mËn
);

1530 
»t
 +ğ
	`‹¡18_0
 (
b
, -1, 
BSTR_ERR
, b->
mËn
);

1531 
»t
 +ğ
	`‹¡18_0
 (
b
, 9, 0, 9);

1532 
»t
 +ğ
	`‹¡18_0
 (
b
, 2, 0, 9);

1533 
	`bwr™•rÙeù
 (*
b
);

1534 
»t
 +ğ
	`‹¡18_0
 (
b
, 4, 
BSTR_ERR
, b->
mËn
);

1535 
	`bwr™—Îow
 (*
b
);

1536 
»t
 +ğ
	`‹¡18_0
 (
b
, 2, 0, b->
mËn
);

1537 
»t
 +ğ
	`‹¡18_0
 (&
em±yB¡ršg
, 9, 
BSTR_ERR
,ƒm±yB¡ršg.
mËn
);

1539 
	`bde¡roy
 (
b
);

1540 
	`debug
 ("\t# fau»s: %d", 
»t
);

1542 
»to
 = 
»t
;

1543 
»t
 = 0;

1545 
b
 = 
	`bäomc¡r
 ("test");

1547 
	`debug
 ("TEST: int ballocmin (bstring s, int†en);");

1549 
»t
 +ğ
	`‹¡18_1
 (
NULL
, 2, 
BSTR_ERR
, 0);

1550 
»t
 +ğ
	`‹¡18_1
 (&
badB¡ršg1
, 2, 
BSTR_ERR
, 0);

1551 
»t
 +ğ
	`‹¡18_1
 (&
badB¡ršg2
, 2, 
BSTR_ERR
, 2);

1554 
»t
 +ğ
	`‹¡18_1
 (
b
, 2, 0, b->
¦’
 + 1);

1555 
»t
 +ğ
	`‹¡18_1
 (
b
, -1, 
BSTR_ERR
, b->
mËn
);

1556 
»t
 +ğ
	`‹¡18_1
 (
b
, 9, 0, 9);

1557 
»t
 +ğ
	`‹¡18_1
 (
b
, 2, 0, b->
¦’
 + 1);

1558 
»t
 +ğ
	`‹¡18_1
 (
b
, 9, 0, 9);

1559 
	`bwr™•rÙeù
 (*
b
);

1560 
»t
 +ğ
	`‹¡18_1
 (
b
, 4, 
BSTR_ERR
, -1);

1561 
	`bwr™—Îow
 (*
b
);

1562 
»t
 +ğ
	`‹¡18_1
 (
b
, 2, 0, b->
¦’
 + 1);

1563 
»t
 +ğ
	`‹¡18_1
 (&
em±yB¡ršg
, 9, 
BSTR_ERR
,ƒm±yB¡ršg.
mËn
);

1565 
	`bde¡roy
 (
b
);

1566 
	`debug
 ("\t# fau»s: %d", 
»t
);

1568  
»to
 + 
»t
;

1569 
	}
}

1571 
	$‹¡19_0
 (
b¡ršg
 
b
, 
Ën
, cÚ¡ * 
»s
, 
”v
) {

1572 
rv
, 
»t
 = 0;

1573 
b¡ršg
 
b1
;

1575 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

1576 
b1
 = 
	`b¡rıy
 (
b
);

1577 
	`bwr™•rÙeù
 (*
b1
);

1578 
»t
 +ğ
	`b·‰”n
 (
b1
, 
Ën
è!ğ
BSTR_ERR
;

1579 
»t
 +ğ!
	`bi£q
 (
b1
, 
b
);

1580 
	`bwr™—Îow
 (*
b1
);

1582 
	`debug
 (".\tb·‰”À(%s, %dèğ", 
	`dumpB¡ršg
 (
b1
), 
Ën
);

1584 
rv
 = 
	`b·‰”n
 (
b1
, 
Ën
);

1586 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b1
));

1588 
»t
 +ğ(
rv
 !ğ
”v
);

1589 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b1
->
¦’
)

1590 || (0 !ğ
	`memcmp
 (
b1
->
d©a
, 
»s
, b1->
¦’
));

1591 
»t
 +ğ
b1
->
d©a
[b1->
¦’
] != '\0';

1593 
	`bde¡roy
(
b1
);

1595 
»t
 +ğ
BSTR_ERR
 !ğ(
rv
 = 
	`b·‰”n
 (
b
, 
Ën
));

1596 
	`debug
 (".\tb·‰”À(%s, %dèğ%d", 
	`dumpB¡ršg
 (
b
), 
Ën
, 
rv
);

1599 ià(
»t
) {

1600 
	`debug
 ("\t\tçu»(%dèrv = %dƒrv = %d (» ğ%p", 
__LINE__
, 
rv
, 
”v
, 
»s
);

1601 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1602 
	`debug
 (")");

1605  
»t
;

1606 
	}
}

1608 
	$‹¡19
 () {

1609 
»t
 = 0;

1611 
	`debug
 ("TEST: int bpattern (bstring b, int†en);");

1613 
»t
 +ğ
	`‹¡19_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1614 
»t
 +ğ
	`‹¡19_0
 (
NULL
, 5, NULL, 
BSTR_ERR
);

1615 
»t
 +ğ
	`‹¡19_0
 (
NULL
, -5, NULL, 
BSTR_ERR
);

1616 
»t
 +ğ
	`‹¡19_0
 (&
badB¡ršg1
, 5, 
NULL
, 
BSTR_ERR
);

1617 
»t
 +ğ
	`‹¡19_0
 (&
badB¡ršg2
, 5, 
NULL
, 
BSTR_ERR
);

1620 
»t
 +ğ
	`‹¡19_0
 (&
em±yB¡ršg
, 0, "", 
BSTR_ERR
);

1621 
»t
 +ğ
	`‹¡19_0
 (&
em±yB¡ršg
, 10, "", 
BSTR_ERR
);

1622 
»t
 +ğ
	`‹¡19_0
 (&
em±yB¡ršg
, -1, "", 
BSTR_ERR
);

1623 
»t
 +ğ
	`‹¡19_0
 (&
shÜtB¡ršg
, 0, "", 0);

1624 
»t
 +ğ
	`‹¡19_0
 (&
shÜtB¡ršg
, 12, "bogusbogusbo", 0);

1625 
»t
 +ğ
	`‹¡19_0
 (&
shÜtB¡ršg
, -1, "bogus", 
BSTR_ERR
);

1627 
	`debug
 ("\t# fau»s: %d", 
»t
);

1628  
»t
;

1629 
	}
}

1631 
	$‹¡20
 () {

1632 
»t
 = 0;

1634 #ià!
	`defšed
 (
BSTRLIB_NOVSNP
)

1635 
rv
;

1636 
b¡ršg
 
b
, 
c
;

1638 
	`debug
 ("TEST: bstring bformat (const char * fmt, ...);");

1640 
	`debug
 (".\tbformat (NULL, 1, 2) = ");

1641 
b
 = 
	`bfÜm©
 (
NULL
, 1, 2);

1642 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1643 
»t
 +ğ
b
 !ğ
NULL
;

1646 
	`debug
 (".\tbformat (\"%%d %%s\", 1, \"xy\") = ");

1647 
b
 = 
	`bfÜm©
 ("%d %s", 1, "xy");

1648 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1649 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("1 xy"), 
b
);

1650 
	`bde¡roy
 (
b
);

1652 
	`debug
 (".\tbfÜm© (\"%%d %%s(%%s)\", 6, %s, %sèğ", 
	`dumpB¡ršg
 (
c
), dumpB¡ršg (&
shÜtB¡ršg
));

1653 
b
 = 
	`bfÜm©
 ("%d %s(%s)", 6, 
c
->
d©a
, 
shÜtB¡ršg
.data);

1654 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1655 
	`bde¡roy
 (
c
);

1656 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("6 1 xy(bogus)"), 
b
);

1657 
	`bde¡roy
 (
c
);

1658 
	`bde¡roy
 (
b
);

1660 
	`debug
 (".\tbformat (\"%%s%%s%%s%%s%%s%%s%%s%%s\", ...) ...");

1661 
b
 = 
	`bfÜm©
 ("%s%s%s%s%s%s%s%s", 
lÚgB¡ršg
.
d©a
,†ongBstring.data

1662 , 
lÚgB¡ršg
.
d©a
,†ongBstring.data

1663 , 
lÚgB¡ršg
.
d©a
,†ongBstring.data

1664 , 
lÚgB¡ršg
.
d©a
,†ongBstring.data);

1665 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

1666 
	`bcÚÿt
 (
c
, c);

1667 
	`bcÚÿt
 (
c
, c);

1668 
	`bcÚÿt
 (
c
, c);

1669 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1670 
	`bde¡roy
 (
c
);

1671 
	`bde¡roy
 (
b
);

1673 
	`debug
 ("\t# fau»s: %d", 
»t
);

1675 
b
 = 
	`bäomc¡r
 ("");

1676 
	`debug
 ("TEST: int bformata (bstring b, const char * fmt, ...);");

1678 
	`debug
 (".\tbfÜm©¨(%s, NULL, 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1679 
rv
 = 
	`bfÜm©a
 (
b
, 
NULL
, 1, 2);

1680 
	`debug
 ("%d", 
rv
);

1681 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1682 
	`debug
 (".\tbfÜm©¨(%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (&
badB¡ršg1
));

1683 
rv
 = 
	`bfÜm©a
 (&
badB¡ršg1
, "%d %d", 1, 2);

1684 
	`debug
 ("%d", 
rv
);

1685 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1686 
	`debug
 (".\tbfÜm©¨(%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1687 
rv
 = 
	`bfÜm©a
 (
b
, "%d %d", 1, 2);

1688 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1689 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("1 2"), 
b
);

1690 
	`bde¡roy
 (
c
);

1691 
	`bde¡roy
 (
b
);

1693 
	`debug
 (".\tbformata (\"x\", \"%%s%%s%%s%%s%%s%%s%%s%%s\", ...) ...");

1694 
rv
 = 
	`bfÜm©a
 (
b
 = 
	`bäomc¡r
 ("x"), "%s%s%s%s%s%s%s%s",

1695 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1696 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1697 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1698 
lÚgB¡ršg
.
d©a
,†ongBstring.data);

1699 
»t
 +ğ
rv
 =ğ
BSTR_ERR
;

1700 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

1701 
	`bcÚÿt
 (
c
, c);

1702 
	`bcÚÿt
 (
c
, c);

1703 
	`bcÚÿt
 (
c
, c);

1704 
	`bš£¹ch
 (
c
, 0, 1, () 'x');

1705 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1706 
	`bde¡roy
 (
c
);

1707 
	`bde¡roy
 (
b
);

1709 
	`debug
 ("\t# fau»s: %d", 
»t
);

1711 
b
 = 
	`bäomc¡r
 ("Initial");

1712 
	`debug
 ("TEST: int bassignformat (bstring b, const char * fmt, ...);");

1714 
	`debug
 (".\tbassignfÜm© (%s, NULL, 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1715 
rv
 = 
	`bassignfÜm©
 (
b
, 
NULL
, 1, 2);

1716 
	`debug
 ("%d", 
rv
);

1717 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1718 
	`debug
 (".\tbassignfÜm© (%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (&
badB¡ršg1
));

1719 
rv
 = 
	`bassignfÜm©
 (&
badB¡ršg1
, "%d %d", 1, 2);

1720 
	`debug
 ("%d", 
rv
);

1721 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1722 
	`debug
 (".\tbassignfÜm© (%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1723 
rv
 = 
	`bassignfÜm©
 (
b
, "%d %d", 1, 2);

1724 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1725 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("1 2"), 
b
);

1726 
	`bde¡roy
 (
c
);

1727 
	`bde¡roy
 (
b
);

1729 
	`debug
 (".\tbassignformat (\"x\", \"%%s%%s%%s%%s%%s%%s%%s%%s\", ...) ...");

1730 
rv
 = 
	`bassignfÜm©
 (
b
 = 
	`bäomc¡r
 ("x"), "%s%s%s%s%s%s%s%s",

1731 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1732 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1733 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1734 
lÚgB¡ršg
.
d©a
,†ongBstring.data);

1735 
»t
 +ğ
rv
 =ğ
BSTR_ERR
;

1736 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

1737 
	`bcÚÿt
 (
c
, c);

1738 
	`bcÚÿt
 (
c
, c);

1739 
	`bcÚÿt
 (
c
, c);

1740 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1741 
	`bde¡roy
 (
c
);

1742 
	`bde¡roy
 (
b
);

1744 
	`debug
 ("\t# fau»s: %d", 
»t
);

1747  
»t
;

1748 
	}
}

1750 
	$‹¡21_0
 (
b¡ršg
 
b
, 
sc
, 
ns
) {

1751 
b¡rLi¡
 * 
l
;

1752 
»t
 = 0;

1754 
	`debug
 (".\tb¥l™ (%s, '%c'èğ", 
	`dumpB¡ršg
 (
b
), 
sc
);

1756 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

1757 
b¡ršg
 
c
;

1758 
gb¡ršg
 
t
;

1760 
	`blk2tb¡r
(
t
,&
sc
,1);

1762 
	`debug
 ("{");

1764 
l
 = 
	`b¥l™
 (
b
, 
sc
);

1766 ià(
l
) {

1767 
i
;

1768 
i
=0; i < 
l
->
qty
; i++) {

1769 ià(
i
 !ğ0è
	`debug
 (", ");

1770 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
l
->
’Œy
[
i
]));

1772 
	`debug
 (":<%d>", 
l
->
qty
);

1773 ià(
ns
 !ğ
l
->
qty
è
»t
++;

1775 
	`debug
 ("NULL");

1776 
»t
 ++;

1779 
	`debug
 ("}");

1781 
c
 = 
	`bjoš
 (
l
, &
t
);

1782 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1783 
	`bde¡roy
 (
c
);

1784 
»t
 +ğ0 !ğ
	`b¡rLi¡De¡roy
 (
l
);

1786 
l
 = 
	`b¥l™
 (
b
, 
sc
);

1787 
»t
 +ğ(
l
 !ğ
NULL
);

1788 
	`debug
 ("%p", (*è
l
);

1791 ià(
»t
) {

1792 
	`debug
 ("\t\tçu»(%dèn ğ%d", 
__LINE__
, 
ns
);

1795  
»t
;

1796 
	}
}

1798 
	$‹¡21_1
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
sc
, 
ns
) {

1799 
b¡rLi¡
 * 
l
;

1800 
»t
 = 0;

1802 
	`debug
 (".\tb¥l™¡¸(%s, %sèğ", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
sc
));

1804 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

1805 
b¡ršg
 
c
;

1807 
	`debug
 ("{");

1809 
l
 = 
	`b¥l™¡r
 (
b
, 
sc
);

1811 ià(
l
) {

1812 
i
;

1813 
i
=0; i < 
l
->
qty
; i++) {

1814 ià(
i
 !ğ0è
	`debug
 (", ");

1815 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
l
->
’Œy
[
i
]));

1817 
	`debug
 (":<%d>", 
l
->
qty
);

1818 ià(
ns
 !ğ
l
->
qty
è
»t
++;

1820 
	`debug
 ("NULL");

1821 
»t
 ++;

1824 
	`debug
 ("}");

1826 
c
 = 
	`bjoš
 (
l
, 
sc
);

1827 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1828 
	`bde¡roy
 (
c
);

1829 
»t
 +ğ0 !ğ
	`b¡rLi¡De¡roy
 (
l
);

1831 
l
 = 
	`b¥l™¡r
 (
b
, 
sc
);

1832 
»t
 +ğ(
l
 !ğ
NULL
);

1833 
	`debug
 ("%p", (*è
l
);

1836 ià(
»t
) {

1837 
	`debug
 ("\t\tçu»(%dèn ğ%d", 
__LINE__
, 
ns
);

1840  
»t
;

1841 
	}
}

1843 
	$‹¡21
 () {

1844 
gb¡ršg
 
is
 = 
	`bsStic
 ("is");

1845 
gb¡ršg
 
ng
 = 
	`bsStic
 ("ng");

1846 
»t
 = 0;

1848 
	`debug
 ("TEST: struct bstrList * bsplit (const_bstring str, unsigned char splitChar);");

1850 
»t
 +ğ
	`‹¡21_0
 (
NULL
, () '?', 0);

1851 
»t
 +ğ
	`‹¡21_0
 (&
badB¡ršg1
, () '?', 0);

1852 
»t
 +ğ
	`‹¡21_0
 (&
badB¡ršg2
, () '?', 0);

1855 
»t
 +ğ
	`‹¡21_0
 (&
em±yB¡ršg
, () '?', 1);

1856 
»t
 +ğ
	`‹¡21_0
 (&
shÜtB¡ršg
, () 'o', 2);

1857 
»t
 +ğ
	`‹¡21_0
 (&
shÜtB¡ršg
, () 's', 2);

1858 
»t
 +ğ
	`‹¡21_0
 (&
shÜtB¡ršg
, () 'b', 2);

1859 
»t
 +ğ
	`‹¡21_0
 (&
lÚgB¡ršg
, () 'o', 9);

1861 
	`debug
 ("TEST: struct bstrList * bsplitstr (bstring str, const_bstring splitStr);");

1863 
»t
 +ğ
	`‹¡21_1
 (
NULL
, NULL, 0);

1864 
»t
 +ğ
	`‹¡21_1
 (&
badB¡ršg1
, &
em±yB¡ršg
, 0);

1865 
»t
 +ğ
	`‹¡21_1
 (&
badB¡ršg2
, &
em±yB¡ršg
, 0);

1868 
»t
 +ğ
	`‹¡21_1
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, 5);

1869 
»t
 +ğ
	`‹¡21_1
 (&
lÚgB¡ršg
, &
is
, 3);

1870 
»t
 +ğ
	`‹¡21_1
 (&
lÚgB¡ršg
, &
ng
, 5);

1872 ià(0 =ğ
»t
) {

1873 
b¡rLi¡
 * 
l
;

1874 
c
;

1875 
gb¡ršg
 
t
;

1876 
b¡ršg
 
b
;

1877 
b¡ršg
 
li¡
[3] = { &
em±yB¡ršg
, &
shÜtB¡ršg
, &
lÚgB¡ršg
 };

1878 
i
;

1880 
	`blk2tb¡r
 (
t
, &
c
, 1);

1882 
i
=0; i < 3; i++) {

1883 
c
 = () '\0';

1885 
b
 = 
	`bjoš
 (
l
 = 
	`b¥l™
 (
li¡
[
i
], 
c
), &
t
);

1886 ià(!
	`bi£q
 (
b
, 
li¡
[
i
])) {

1887 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

1888 
	`debug
 ("još (b¥l™ (%s, x%02X), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
b
));

1889 
»t
++;

1891 
	`bde¡roy
 (
b
);

1892 
	`b¡rLi¡De¡roy
 (
l
);

1893 ià(
»t
) ;

1895 
b
 = 
	`bjoš
 (
l
 = 
	`b¥l™¡r
 (
li¡
[
i
], &
t
), &t);

1896 ià(!
	`bi£q
 (
b
, 
li¡
[
i
])) {

1897 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

1898 
	`debug
 ("još (b¥l™¡¸(%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
b
));

1899 
»t
++;

1901 
	`bde¡roy
 (
b
);

1902 
	`b¡rLi¡De¡roy
 (
l
);

1903 ià(
»t
) ;

1905 ià(
UCHAR_MAX
 =ğ
c
) ;

1906 
c
++;

1908 ià(
»t
) ;

1912 
	`debug
 ("\t# fau»s: %d", 
»t
);

1913  
»t
;

1914 
	}
}

1916 
	$‹¡22_0
 (
cÚ¡_b¡ršg
 
b
, cÚ¡_b¡ršg 
£p
, 
ns
, ...) {

1917 
va_li¡
 
¬gli¡
;

1918 
b¡rLi¡
 * 
l
;

1919 
»t
 = 0;

1921 
	`debug
 (".\tb¥l™ (%s, %s)", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
£p
));

1922 iàĞ
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0 &&

1923 
£p
 !ğ
NULL
 && s•->
d©a
 !ğNULL && s•->
¦’
 >= 0) {

1924 
	`debug
 (" {");

1926 
l
 = 
	`b¥l™s
 (
b
, 
£p
);

1928 ià(
l
) {

1929 
i
;

1930 
	`va_¡¬t
 (
¬gli¡
, 
ns
);

1932 
i
=0; i < 
l
->
qty
; i++) {

1933 * 
»s
;

1935 
»s
 = 
	`va_¬g
 (
¬gli¡
, *);

1937 ià(
i
 !ğ0è
	`debug
 (", ");

1938 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
l
->
’Œy
[
i
]));

1940 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
l
->
’Œy
[
i
]->
¦’
)

1941 || (0 !ğ
	`memcmp
 (
l
->
’Œy
[
i
]->
d©a
, 
»s
,†->’Œy[i]->
¦’
));

1942 
»t
 +ğ
l
->
’Œy
[
i
]->
d©a
[l->’Œy[i]->
¦’
] != '\0';

1945 
	`va_’d
 (
¬gli¡
);

1947 
	`debug
 (":<%d>", 
l
->
qty
);

1948 ià(
ns
 !ğ
l
->
qty
è
»t
++;

1950 
	`debug
 ("NULL");

1951 
»t
 +ğ(
ns
 != 0);

1954 
	`debug
 ("}");

1956 
»t
 +ğ(0 !ğ
	`b¡rLi¡De¡roy
 (
l
è&&† !ğ
NULL
);

1958 
l
 = 
	`b¥l™s
 (
b
, 
£p
);

1959 
»t
 +ğ(
l
 !ğ
NULL
);

1960 
	`debug
 (" = %p", (*è
l
);

1963 ià(
»t
) {

1964 
	`debug
 ("\t\tçu»(%dèn ğ%d", 
__LINE__
, 
ns
);

1967  
»t
;

1968 
	}
}

1970 
	$‹¡22
 () {

1971 
»t
 = 0;

1972 
gb¡ršg
 
o
=
	`bsStic
("o");

1973 
gb¡ršg
 
s
=
	`bsStic
("s");

1974 
gb¡ršg
 
b
=
	`bsStic
("b");

1975 
gb¡ršg
 
bs
=
	`bsStic
("bs");

1976 
gb¡ršg
 
uo
=
	`bsStic
("uo");

1978 
	`debug
 ("TEST:ƒxtern struct bstrList * bsplits (const_bstring str, const_bstring splitStr);");

1980 
»t
 +ğ
	`‹¡22_0
 (
NULL
, &
o
, 0);

1981 
»t
 +ğ
	`‹¡22_0
 (&
o
, 
NULL
, 0);

1984 
»t
 +ğ
	`‹¡22_0
 (&
em±yB¡ršg
, &
o
, 1, "");

1985 
»t
 +ğ
	`‹¡22_0
 (&
em±yB¡ršg
, &
uo
, 1, "");

1986 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, 1, "bogus");

1987 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
o
, 2, "b", "gus");

1988 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
s
, 2, "bogu", "");

1989 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
b
, 2, "" , "ogus");

1990 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
bs
, 3, "" , "ogu", "");

1991 
»t
 +ğ
	`‹¡22_0
 (&
lÚgB¡ršg
, &
o
, 9, "This is‡ b", "gus but„eas", "nably†", "ng string. Just†", "ngƒn", "ugh", " cause s", "me mall", "cing.");

1992 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
uo
, 3, "b", "g", "s");

1994 ià(0 =ğ
»t
) {

1995 
b¡rLi¡
 * 
l
;

1996 
c
;

1997 
gb¡ršg
 
t
;

1998 
b¡ršg
 
bb
;

1999 
b¡ršg
 
li¡
[3] = { &
em±yB¡ršg
, &
shÜtB¡ršg
, &
lÚgB¡ršg
 };

2000 
i
;

2002 
	`blk2tb¡r
 (
t
, &
c
, 1);

2004 
i
=0; i < 3; i++) {

2005 
c
 = () '\0';

2007 
bb
 = 
	`bjoš
 (
l
 = 
	`b¥l™s
 (
li¡
[
i
], &
t
), &t);

2008 ià(!
	`bi£q
 (
bb
, 
li¡
[
i
])) {

2009 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

2010 
	`debug
 ("još (b¥l™ (%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
bb
));

2011 
»t
++;

2013 
	`bde¡roy
 (
bb
);

2014 
	`b¡rLi¡De¡roy
 (
l
);

2015 ià(
»t
) ;

2016 ià(
UCHAR_MAX
 =ğ
c
) ;

2017 
c
++;

2019 ià(
»t
) ;

2023 
	`debug
 ("\t# fau»s: %d", 
»t
);

2024  
»t
;

2025 
	}
}

2027 
	ssb¡r
 {

2028 
	mofs
;

2029 
b¡ršg
 
	mb
;

2032 
size_t
 
	$‹¡23_aux_»ad
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

2033 
sb¡r
 * 
sb
 = (sb¡¸*)
·rm
;

2034 
–s
, 
Ën
;

2036 ià(
·rm
 =ğ
NULL
 || 
–size
 =ğ0 || 
ÃËm
 == 0)  0;

2037 
Ën
 = (è(
ÃËm
 * 
–size
); if (len <= 0)  0;

2038 ià(
Ën
 + 
sb
->
ofs
 > sb->
b
->
¦’
)†en = sb->b->slen - sb->ofs;

2039 
–s
 = (è(
Ën
 / 
–size
);

2040 
Ën
 = (è(
–s
 * 
–size
);

2041 ià(
Ën
 > 0) {

2042 
	`memıy
 (
buff
, 
sb
->
b
->
d©a
 + sb->
ofs
, 
Ën
);

2043 
sb
->
ofs
 +ğ
Ën
;

2045  
–s
;

2046 
	}
}

2048 
	$‹¡23_aux_İ’
 (
sb¡r
 * 
sb
, 
b¡ršg
 
b
) {

2049 ià(!
sb
 || 
b
 =ğ
NULL
 || b->
d©a
 =ğNULLè -
__LINE__
;

2050 
sb
->
ofs
 = 0;

2051 
sb
->
b
 = b;

2053 
	}
}

2055 
	$‹¡23_aux_¥l™cb
 (* 
·rm
, 
ofs
, cÚ¡ 
gb¡ršg
 * 
’Œy
) {

2056 
b¡ršg
 
b
 = (b¡ršgè
·rm
;

2058 
ofs
 = ofs;

2059 ià(
b
->
¦’
 > 0è
	`bcÚch¬
 (b, () '|');

2060 
	`bcÚÿt
 (
b
, 
’Œy
);

2062 
	}
}

2064 
	sgBss
 {

2065 
	mfœ¡
;

2066 
	msc
;

2067 
b¡ršg
 
	mb
;

2070 
	$‹¡23_aux_¥l™cbx
 (* 
·rm
, 
ofs
, cÚ¡ 
gb¡ršg
 * 
’Œy
) {

2071 
gBss
 * 
p
 = (gBs *è
·rm
;

2073 
ofs
 = ofs;

2074 ià(!
p
->
fœ¡
) {

2075 
	`bcÚch¬
 (
p
->
b
, (èp->
sc
);

2076 } 
p
->
fœ¡
 = 0;

2078 
	`bcÚÿt
 (
p
->
b
, 
’Œy
);

2080 
	}
}

2082 
	$‹¡23
 () {

2083 
gb¡ršg
 
¥aû
 = 
	`bsStic
 (" ");

2084 
sb¡r
 
sb
;

2085 
bSŒ—m
 * 
bs
;

2086 
b¡ršg
 
b
;

2087 
l
, 
»t
 = 0;

2089 
	`debug
 ("TEST: bstream integratedest");

2090 
	`‹¡23_aux_İ’
 (&
sb
, &
lÚgB¡ršg
);

2091 
»t
 +ğ
NULL
 !ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
èNULL, &
sb
));

2092 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2093 
»t
 +ğ(
	`b£of
 (
bs
) != 0);

2094 
»t
 +ğ
BSTR_ERR
 !ğ
	`bsbufæ’gth
 (
NULL
, -1);

2095 
»t
 +ğ
BSTR_ERR
 !ğ
	`bsbufæ’gth
 (
NULL
, 1);

2096 
»t
 +ğ
BSTR_ERR
 !ğ
	`bsbufæ’gth
 (
bs
, -1);

2097 
	`debug
 (".\tbsbufæ’gth (bs, 0è-> %d", 
	`bsbufæ’gth
 (
bs
, 0));

2098 
»t
 +ğ
BSTR_ERR
 =ğ
	`bsbufæ’gth
 (
bs
, 1);

2099 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¥“k
 (
NULL
, 
bs
);

2100 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¤—dÊ
 (
NULL
, 
bs
, () '?');

2101 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¤—dÊ
 (&
em±yB¡ršg
, 
bs
, () '?');

2102 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¥“k
 (&
em±yB¡ršg
, 
bs
);

2104 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¥“k
 (
b
 = 
	`bäomc¡r
 (""), 
bs
);

2106 
	`debug
 (".\tb¥“k (è-> %s", 
	`dumpB¡ršg
 (
b
));

2107 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¤—dÊ
 (
b
, 
NULL
, () '?');

2108 
b
->
¦’
 = 0;

2109 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '?');

2110 
»t
 +ğ(
	`b£of
 (
bs
) <= 0);

2111 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2112 
	`debug
 (".\tb¤—dÊ ('?'è-> %s", 
	`dumpB¡ršg
 (
b
));

2113 
»t
 +ğ
BSTR_ERR
 =ğ
	`bsuÄ—d
 (
bs
, 
b
);

2114 
»t
 +ğ(
	`b£of
 (
bs
) != 0);

2115 
	`debug
 (".\tbsuÄ—d (%s)", 
	`dumpB¡ršg
 (
b
));

2116 
b
->
¦’
 = 0;

2117 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¥“k
 (
b
, 
bs
);

2118 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2119 
	`debug
 (".\tb¥“k (è-> %s", 
	`dumpB¡ršg
 (
b
));

2120 
b
->
¦’
 = 0;

2121 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '?');

2122 
»t
 +ğ(
	`b£of
 (
bs
) <= 0);

2123 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2124 
	`debug
 (".\tb¤—dÊ ('?'è-> %s", 
	`dumpB¡ršg
 (
b
));

2125 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2126 
sb
.
ofs
 = 0;

2128 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2129 
b
->
¦’
 = 0;

2130 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '.');

2131 
l
 = 
b
->
¦’
;

2132 
»t
 +ğ(0 !ğ
	`b¡ºcmp
 (
b
, &
lÚgB¡ršg
, 
l
)è|| (lÚgB¡ršg.
d©a
[l-1] != '.');

2133 
	`debug
 (".\tb¤—dÊ ('.'è-> %s", 
	`dumpB¡ršg
 (
b
));

2134 
»t
 +ğ
BSTR_ERR
 =ğ
	`bsuÄ—d
 (
bs
, 
b
);

2136 
	`debug
 (".\tbsuÄ—d (%s)", 
	`dumpB¡ršg
 (
b
));

2137 
b
->
¦’
 = 0;

2138 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¥“k
 (
b
, 
bs
);

2139 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2140 
	`debug
 (".\tb¥“k (è-> %s", 
	`dumpB¡ršg
 (
b
));

2141 
b
->
¦’
 = 0;

2142 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '.');

2144 
»t
 +ğ
b
->
¦’
 !ğ
l
 || (0 !ğ
	`b¡ºcmp
 (b, &
lÚgB¡ršg
,†)è|| (lÚgB¡ršg.
d©a
[l-1] != '.');

2145 
	`debug
 (".\tb¤—dÊ ('.'è-> %s", 
	`dumpB¡ršg
 (
b
));

2146 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2148 
	`‹¡23_aux_İ’
 (&
sb
, &
lÚgB¡ršg
);

2149 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2150 
»t
 +ğ(
	`b£of
 (
bs
) != 0);

2151 
b
->
¦’
 = 0;

2152 
l
 = 
	`bs¥l™scb
 (
bs
, &
¥aû
, 
‹¡23_aux_¥l™cb
, 
b
);

2153 
»t
 +ğ(
	`b£of
 (
bs
) <= 0);

2154 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2155 
	`debug
 (".\tbs¥l™scb (' 'è-> %s", 
	`dumpB¡ršg
 (
b
));

2157 
l
=1;† < 4;†++) {

2158 * 
¡r
;

2159 
¡r
 = (*è
lÚgB¡ršg
.
d©a
; *str; str++) {

2160 
	`‹¡23_aux_İ’
 (&
sb
, &
lÚgB¡ršg
);

2161 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2162 
»t
 +ğ
	`b£of
 (
bs
) != 0;

2163 
»t
 +ğ0 > 
	`bsbufæ’gth
 (
bs
, 
l
);

2164 
b
->
¦’
 = 0;

2165 0 =ğ
	`b¤—dÊa
 (
b
, 
bs
, *
¡r
)) ;

2166 
»t
 +ğ0 =ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
);

2167 
»t
 +ğ
	`b£of
 (
bs
) <= 0;

2168 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2169 ià(
»t
) ;

2171 ià(
»t
) ;

2174 
	`bde¡roy
 (
b
);

2176 ià(0 =ğ
»t
) {

2177 
c
;

2178 
gb¡ršg
 
t
;

2179 
b¡ršg
 
li¡
[3] = { &
em±yB¡ršg
, &
shÜtB¡ršg
, &
lÚgB¡ršg
 };

2180 
i
;

2182 
	`blk2tb¡r
 (
t
, &
c
, 1);

2184 
i
=0; i < 3; i++) {

2185 
c
 = () '\0';

2187 
gBss
 
bss
;

2189 
bss
.
sc
 = 
c
;

2190 
bss
.
b
 = 
	`bäomc¡r
 ("");

2191 
bss
.
fœ¡
 = 1;

2193 
	`‹¡23_aux_İ’
 (&
sb
, 
li¡
[
i
]);

2194 
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
);

2195 
	`bs¥l™scb
 (
bs
, &
t
, 
‹¡23_aux_¥l™cbx
, &
bss
);

2196 
	`bsşo£
 (
bs
);

2198 ià(!
	`bi£q
 (
bss
.
b
, 
li¡
[
i
])) {

2199 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

2200 
	`debug
 ("još (bs¥l™scb (%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
bss
.
b
));

2201 
»t
++;

2203 
	`bde¡roy
 (
bss
.
b
);

2204 ià(
»t
) ;

2205 ià(
UCHAR_MAX
 =ğ
c
) ;

2206 
c
++;

2208 ià(
»t
) ;

2211 
gBss
 
bss
;

2213 
bss
.
sc
 = 
c
;

2214 
bss
.
b
 = 
	`bäomc¡r
 ("");

2215 
bss
.
fœ¡
 = 1;

2217 
	`‹¡23_aux_İ’
 (&
sb
, 
li¡
[
i
]);

2218 
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
);

2219 
	`bs¥l™¡rcb
 (
bs
, &
t
, 
‹¡23_aux_¥l™cbx
, &
bss
);

2220 
	`bsşo£
 (
bs
);

2222 ià(!
	`bi£q
 (
bss
.
b
, 
li¡
[
i
])) {

2223 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

2224 
	`debug
 ("još (bs¥l™¡rcb (%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
bss
.
b
));

2225 
»t
++;

2227 
	`bde¡roy
 (
bss
.
b
);

2228 ià(
»t
) ;

2229 ià(
UCHAR_MAX
 =ğ
c
) ;

2230 
c
++;

2232 ià(
»t
) ;

2236 
	`debug
 ("\t# fau»s: %d", 
»t
);

2237  
»t
;

2238 
	}
}

2240 
	$‹¡24_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

2241 
rv
, 
»t
 = 0;

2243 
	`debug
 (".\tbnšch¸(%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

2244 
rv
 = 
	`bnšchr
 (
s1
, 
pos
, 
s2
);

2245 
	`debug
 ("%d", 
rv
);

2246 
»t
 +ğ(
rv
 !ğ
»s
);

2247 ià(
»t
) {

2248 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2250  
»t
;

2251 
	}
}

2253 
	$‹¡24
 () {

2254 
b¡ršg
 
b
;

2255 
»t
 = 0;

2257 
	`debug
 ("TEST: int bninchr (const_bstring s1, int…os, const_bstring s2);");

2258 
»t
 +ğ
	`‹¡24_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

2259 
»t
 +ğ
	`‹¡24_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

2260 
»t
 +ğ
	`‹¡24_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2261 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 3, &
badB¡ršg1
, 
BSTR_ERR
);

2262 
»t
 +ğ
	`‹¡24_0
 (&
badB¡ršg1
, 3, &
shÜtB¡ršg
, 
BSTR_ERR
);

2264 
»t
 +ğ
	`‹¡24_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

2265 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2266 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 0, &shÜtB¡ršg, 
BSTR_ERR
);

2267 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 1, &shÜtB¡ršg, 
BSTR_ERR
);

2268 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 3, &
shÜtB¡ršg
, 4);

2269 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 3, 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
), 4);

2270 
	`bde¡roy
 (
b
);

2271 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, -1, &
shÜtB¡ršg
, 
BSTR_ERR
);

2272 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 1000, &
shÜtB¡ršg
, 
BSTR_ERR
);

2273 
»t
 +ğ
	`‹¡24_0
 (&
xxxxxB¡ršg
, 0, &
shÜtB¡ršg
, 0);

2274 
»t
 +ğ
	`‹¡24_0
 (&
xxxxxB¡ršg
, 1, &
shÜtB¡ršg
, 1);

2275 
»t
 +ğ
	`‹¡24_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

2277 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 0);

2278 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 15);

2279 
	`debug
 ("\t# fau»s: %d", 
»t
);

2280  
»t
;

2281 
	}
}

2283 
	$‹¡25_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

2284 
rv
, 
»t
 = 0;

2286 
	`debug
 (".\tbnšch¼ (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

2287 
rv
 = 
	`bnšch¼
 (
s1
, 
pos
, 
s2
);

2288 
	`debug
 ("%d", 
rv
);

2289 
»t
 +ğ(
rv
 !ğ
»s
);

2290 ià(
»t
) {

2291 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2293  
»t
;

2294 
	}
}

2296 
	$‹¡25
 () {

2297 
b¡ršg
 
b
;

2298 
»t
 = 0;

2300 
	`debug
 ("TEST: int bninchrr (const_bstring s1, int…os, const_bstring s2);");

2301 
»t
 +ğ
	`‹¡25_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

2302 
»t
 +ğ
	`‹¡25_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

2303 
»t
 +ğ
	`‹¡25_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2304 
»t
 +ğ
	`‹¡25_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

2305 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2306 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

2307 
»t
 +ğ
	`‹¡25_0
 (&
badB¡ršg1
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

2309 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 0, &shÜtB¡ršg, 
BSTR_ERR
);

2310 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 4, &shÜtB¡ršg, 
BSTR_ERR
);

2311 
»t
 +ğ
	`‹¡25_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 9);

2312 
»t
 +ğ
	`‹¡25_0
 (&
lÚgB¡ršg
, 10, 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
), 9);

2313 
	`bde¡roy
 (
b
);

2314 
»t
 +ğ
	`‹¡25_0
 (&
xxxxxB¡ršg
, 4, &
shÜtB¡ršg
, 4);

2315 
»t
 +ğ
	`‹¡25_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

2317 
	`debug
 ("\t# fau»s: %d", 
»t
);

2318  
»t
;

2319 
	}
}

2321 
	$‹¡26_0
 (
b¡ršg
 
b0
, 
pos
, 
Ën
, 
cÚ¡_b¡ršg
 
b1
, 
fl
, * 
»s
) {

2322 
b¡ršg
 
b2
;

2323 
rv
, 
»t
 = 0;

2325 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2326 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

2327 
b2
 = 
	`b¡rıy
 (
b0
);

2328 
	`bwr™•rÙeù
 (*
b2
);

2330 
	`debug
 (".\tb»¶aû (%s, ", 
	`dumpB¡ršg
 (
b2
));

2332 
rv
 = 
	`b»¶aû
 (
b2
, 
pos
, 
Ën
, 
b1
, 
fl
);

2333 
»t
 +ğ(
rv
 == 0);

2334 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2336 
	`debug
 ("%d, %d, %s, %02Xèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

2338 
	`bwr™—Îow
 (*
b2
);

2340 
	`debug
 (".\tb»¶aû (%s, ", 
	`dumpB¡ršg
 (
b2
));

2342 
rv
 = 
	`b»¶aû
 (
b2
, 
pos
, 
Ën
, 
b1
, 
fl
);

2343 ià(
b1
) {

2344 
»t
 +ğ(
pos
 < 0è&& (
b2
->
¦’
 !ğ
b0
->slen);

2345 
»t
 +ğ((
rv
 =ğ0è!ğ(
pos
 >ğ0 &&…o <ğ
b2
->
¦’
));

2348 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

2349 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2350 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2352 
	`debug
 ("%d, %d, %s, %02Xèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

2354 
	`bde¡roy
 (
b2
);

2356 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`b»¶aû
 (
b0
, 
pos
, 
Ën
, 
b1
, 
fl
)));

2357 
	`debug
 (".\tb»¶aû (%s, %d, %d, %s, %02Xèğ%d", 
	`dumpB¡ršg
 (
b0
), 
pos
, 
Ën
, dumpB¡ršg (
b1
), 
fl
, 
rv
);

2360 ià(
»t
) {

2361 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2362 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2363 
	`debug
 (")");

2365  
»t
;

2366 
	}
}

2368 
	$‹¡26
 () {

2369 
»t
 = 0;

2370 
	`debug
 ("TEST: int breplace (bstring b0, int…os, int†en, const_bstring b1, unsigned char fill);");

2372 
»t
 +ğ
	`‹¡26_0
 (
NULL
, 0, 0, NULL, () '?', NULL);

2373 
»t
 +ğ
	`‹¡26_0
 (
NULL
, 0, 0, &
em±yB¡ršg
, () '?', NULL);

2374 
»t
 +ğ
	`‹¡26_0
 (&
badB¡ršg1
, 1, 3, &
shÜtB¡ršg
, (è'?', 
NULL
);

2375 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 1, 3, &
badB¡ršg1
, (è'?', 
NULL
);

2378 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 0, 0, &emptyBstring, () '?', "");

2379 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 5, 0, &emptyBstring, () '?', "?????");

2380 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 5, 0, &
shÜtB¡ršg
, () '?', "?????bogus");

2381 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 0, 0, &
em±yB¡ršg
, () '?', "bogus");

2382 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 0, 0, &
shÜtB¡ršg
, () '?', "bogus");

2383 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 0, 0, &shortBstring, () '?', "bogusbogus");

2384 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 1, 3, &shortBstring, () '?', "bboguss");

2385 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 3, 8, &shortBstring, () '?', "bogbogus");

2386 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, -1, 0, &shortBstring, () '?', "bogus");

2387 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 2, 0, &shortBstring, () '?', "bobogusgus");

2388 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 6, 0, &shortBstring, () '?', "bogus?bogus");

2389 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 6, 0, 
NULL
, () '?', "bogus");

2390 
	`debug
 ("\t# fau»s: %d", 
»t
);

2391  
»t
;

2392 
	}
}

2394 
	$‹¡27_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
, cÚ¡ * 
»s
) {

2395 
b¡ršg
 
b2
;

2396 
rv
, 
»t
 = 0;

2398 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2399 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

2400 
b2
 = 
	`b¡rıy
 (
b0
);

2401 
	`bwr™•rÙeù
 (*
b2
);

2403 
	`debug
 (".\tbassigÀ(%s, ", 
	`dumpB¡ršg
 (
b2
));

2405 
rv
 = 
	`bassign
 (
b2
, 
b1
);

2406 
»t
 +ğ(
rv
 == 0);

2407 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2409 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

2411 
	`bwr™—Îow
 (*
b2
);

2413 
	`debug
 (".\tbassigÀ(%s, ", 
	`dumpB¡ršg
 (
b2
));

2415 
rv
 = 
	`bassign
 (
b2
, 
b1
);

2417 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

2419 ià(
b1
è
»t
 +ğ(
b2
->
¦’
 != b1->slen);

2420 
»t
 +ğ((0 !ğ
rv
è&& (
b1
 !ğ
NULL
)) || ((0 ==„v) && (b1 == NULL));

2421 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2422 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2423 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2424 
	`bde¡roy
 (
b2
);

2426 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bassign
 (
b0
, 
b1
)));

2427 
	`debug
 (".\tbassigÀ(%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

2430 ià(
»t
) {

2431 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2432 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2433 
	`debug
 (")");

2435  
»t
;

2436 
	}
}

2438 
	$‹¡27
 () {

2439 
»t
 = 0;

2441 
	`debug
 ("TEST: int bassign (bstring b0, const_bstring b1);");

2444 
»t
 +ğ
	`‹¡27_0
 (
NULL
, NULL, NULL);

2445 
»t
 +ğ
	`‹¡27_0
 (
NULL
, &
em±yB¡ršg
, NULL);

2446 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, 
NULL
, "");

2447 
»t
 +ğ
	`‹¡27_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
NULL
);

2448 
»t
 +ğ
	`‹¡27_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 
NULL
);

2449 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
NULL
);

2450 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 
NULL
);

2453 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &emptyBstring, "");

2454 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &
shÜtB¡ršg
, "bogus");

2455 
»t
 +ğ
	`‹¡27_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, "");

2456 
»t
 +ğ
	`‹¡27_0
 (&
shÜtB¡ršg
, &shortBstring, "bogus");

2457 
	`debug
 ("\t# fau»s: %d", 
»t
);

2458  
»t
;

2459 
	}
}

2461 
	$‹¡28_0
 (
b¡ršg
 
s1
, 
c
, 
»s
) {

2462 
rv
, 
»t
 = 0;

2464 
	`debug
 (".\tb¡rch¸(%s, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
);

2465 
rv
 = 
	`b¡rchr
 (
s1
, 
c
);

2466 
	`debug
 ("%d", 
rv
);

2467 
»t
 +ğ(
rv
 !ğ
»s
);

2468 ià(
»t
) {

2469 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2471  
»t
;

2472 
	}
}

2474 
	$‹¡28_1
 (
b¡ršg
 
s1
, 
c
, 
»s
) {

2475 
rv
, 
»t
 = 0;

2477 
	`debug
 (".\tb¡¼ch¸(%s, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
);

2478 
rv
 = 
	`b¡¼chr
 (
s1
, 
c
);

2479 
	`debug
 ("%d", 
rv
);

2480 
»t
 +ğ(
rv
 !ğ
»s
);

2481 ià(
»t
) {

2482 
	`debug
 ("\t\tçu»(%dè» ğ%d„v = %d", 
__LINE__
, 
»s
, 
rv
);

2484  
»t
;

2485 
	}
}

2487 
	$‹¡28_2
 (
b¡ršg
 
s1
, 
c
, 
pos
, 
»s
) {

2488 
rv
, 
»t
 = 0;

2490 
	`debug
 (".\tb¡rch½ (%s, %d, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
, 
pos
);

2491 
rv
 = 
	`b¡rch½
 (
s1
, 
c
, 
pos
);

2492 
	`debug
 ("%d", 
rv
);

2493 
»t
 +ğ(
rv
 !ğ
»s
);

2494 ià(
»t
) {

2495 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2497  
»t
;

2498 
	}
}

2500 
	$‹¡28_3
 (
b¡ršg
 
s1
, 
c
, 
pos
, 
»s
) {

2501 
rv
, 
»t
 = 0;

2503 
	`debug
 (".\tb¡¼ch½ (%s, %d, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
, 
pos
);

2504 
rv
 = 
	`b¡¼ch½
 (
s1
, 
c
, 
pos
);

2505 
	`debug
 ("%d", 
rv
);

2506 
»t
 +ğ(
rv
 !ğ
»s
);

2507 ià(
»t
) {

2508 
	`debug
 ("\t\tçu»(%dè» ğ%d„v = %d", 
__LINE__
, 
»s
, 
rv
);

2510  
»t
;

2511 
	}
}

2513 
	$‹¡28
 () {

2514 
»t
 = 0;

2516 
	`debug
 ("TEST: int bstrchr (const_bstring s1, int c);");

2517 
»t
 +ğ
	`‹¡28_0
 (
NULL
, 0, 
BSTR_ERR
);

2518 
»t
 +ğ
	`‹¡28_0
 (&
badB¡ršg1
, 'b', 
BSTR_ERR
);

2519 
»t
 +ğ
	`‹¡28_0
 (&
badB¡ršg2
, 's', 
BSTR_ERR
);

2521 
»t
 +ğ
	`‹¡28_0
 (&
em±yB¡ršg
, 0, 
BSTR_ERR
);

2522 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 0, 
BSTR_ERR
);

2523 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 'b', 0);

2524 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 's', 4);

2525 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 'q', 
BSTR_ERR
);

2526 
»t
 +ğ
	`‹¡28_0
 (&
xxxxxB¡ršg
, 0, 
BSTR_ERR
);

2527 
»t
 +ğ
	`‹¡28_0
 (&
xxxxxB¡ršg
, 'b', 
BSTR_ERR
);

2528 
»t
 +ğ
	`‹¡28_0
 (&
lÚgB¡ršg
, 'i', 2);

2530 
	`debug
 ("TEST: int bstrrchr (const_bstring s1, int c);");

2531 
»t
 +ğ
	`‹¡28_1
 (
NULL
, 0, 
BSTR_ERR
);

2532 
»t
 +ğ
	`‹¡28_1
 (&
badB¡ršg1
, 'b', 
BSTR_ERR
);

2533 
»t
 +ğ
	`‹¡28_1
 (&
badB¡ršg2
, 's', 
BSTR_ERR
);

2535 
»t
 +ğ
	`‹¡28_1
 (&
em±yB¡ršg
, 0, 
BSTR_ERR
);

2536 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 0, 
BSTR_ERR
);

2537 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 'b', 0);

2538 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 's', 4);

2539 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 'q', 
BSTR_ERR
);

2540 
»t
 +ğ
	`‹¡28_1
 (&
xxxxxB¡ršg
, 0, 
BSTR_ERR
);

2541 
»t
 +ğ
	`‹¡28_1
 (&
xxxxxB¡ršg
, 'b', 
BSTR_ERR
);

2542 
»t
 +ğ
	`‹¡28_1
 (&
lÚgB¡ršg
, 'i', 82);

2544 
	`debug
 ("TEST: int bstrchrp (const_bstring s1, int c, int…os);");

2545 
»t
 +ğ
	`‹¡28_2
 (
NULL
, 0, 0, 
BSTR_ERR
);

2546 
»t
 +ğ
	`‹¡28_2
 (&
badB¡ršg1
, 'b', 0, 
BSTR_ERR
);

2547 
»t
 +ğ
	`‹¡28_2
 (&
badB¡ršg2
, 's', 0, 
BSTR_ERR
);

2548 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', -1, 
BSTR_ERR
);

2549 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', shÜtB¡ršg.
¦’
, 
BSTR_ERR
);

2551 
»t
 +ğ
	`‹¡28_2
 (&
em±yB¡ršg
, 0, 0, 
BSTR_ERR
);

2552 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 0, 0, 
BSTR_ERR
);

2553 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', 0, 0);

2554 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', 1, 
BSTR_ERR
);

2555 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 's', 0, 4);

2556 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'q', 0, 
BSTR_ERR
);

2558 
	`debug
 ("TEST: int bstrrchrp (const_bstring s1, int c, int…os);");

2559 
»t
 +ğ
	`‹¡28_3
 (
NULL
, 0, 0, 
BSTR_ERR
);

2560 
»t
 +ğ
	`‹¡28_3
 (&
badB¡ršg1
, 'b', 0, 
BSTR_ERR
);

2561 
»t
 +ğ
	`‹¡28_3
 (&
badB¡ršg2
, 's', 0, 
BSTR_ERR
);

2562 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', -1, 
BSTR_ERR
);

2563 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', shÜtB¡ršg.
¦’
, 
BSTR_ERR
);

2565 
»t
 +ğ
	`‹¡28_3
 (&
em±yB¡ršg
, 0, 0, 
BSTR_ERR
);

2566 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 0, 0, 
BSTR_ERR
);

2567 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', 0, 0);

2568 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', shÜtB¡ršg.
¦’
 - 1, 0);

2569 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 's', shÜtB¡ršg.
¦’
 - 1, 4);

2570 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 's', 0, 
BSTR_ERR
);

2572 
	`debug
 ("\t# fau»s: %d", 
»t
);

2573  
»t
;

2574 
	}
}

2576 
	$‹¡29_0
 (
b¡ršg
 
b0
, * 
s
, cÚ¡ * 
»s
) {

2577 
b¡ršg
 
b2
;

2578 
rv
, 
»t
 = 0;

2580 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2581 
b2
 = 
	`b¡rıy
 (
b0
);

2582 
	`bwr™•rÙeù
 (*
b2
);

2584 
	`debug
 (".\tbÿtc¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

2586 
rv
 = 
	`bÿtc¡r
 (
b2
, 
s
);

2587 
»t
 +ğ(
rv
 == 0);

2588 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2590 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2592 
	`bwr™—Îow
 (*
b2
);

2594 
	`debug
 (".\tbÿtc¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

2596 
rv
 = 
	`bÿtc¡r
 (
b2
, 
s
);

2598 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2600 ià(
s
è
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->¦’ + (è
	`¡¾’
 (s));

2601 
»t
 +ğ((0 !ğ
rv
è&& (
s
 !ğ
NULL
)) || ((0 ==„v) && (s == NULL));

2602 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2603 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2604 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2605 
	`bde¡roy
 (
b2
);

2607 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bÿtc¡r
 (
b0
, 
s
)));

2608 
	`debug
 (".\tbÿtc¡¸(%s, %pèğ%d", 
	`dumpB¡ršg
 (
b0
), 
s
, 
rv
);

2611 ià(
»t
) {

2612 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2613 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2614 
	`debug
 (")");

2616  
»t
;

2617 
	}
}

2619 
	$‹¡29
 () {

2620 
»t
 = 0;

2622 
	`debug
 ("TEST: int bcatcstr (bstring b0, const char * s);");

2625 
»t
 +ğ
	`‹¡29_0
 (
NULL
, NULL, NULL);

2626 
»t
 +ğ
	`‹¡29_0
 (
NULL
, "", NULL);

2627 
»t
 +ğ
	`‹¡29_0
 (&
em±yB¡ršg
, 
NULL
, "");

2628 
»t
 +ğ
	`‹¡29_0
 (&
badB¡ršg1
, "bogus", 
NULL
);

2629 
»t
 +ğ
	`‹¡29_0
 (&
badB¡ršg2
, "bogus", 
NULL
);

2632 
»t
 +ğ
	`‹¡29_0
 (&
em±yB¡ršg
, "", "");

2633 
»t
 +ğ
	`‹¡29_0
 (&
em±yB¡ršg
, "bogus", "bogus");

2634 
»t
 +ğ
	`‹¡29_0
 (&
shÜtB¡ršg
, "", "bogus");

2635 
»t
 +ğ
	`‹¡29_0
 (&
shÜtB¡ršg
, "bogus", "bogusbogus");

2636 
	`debug
 ("\t# fau»s: %d", 
»t
);

2637  
»t
;

2638 
	}
}

2640 
	$‹¡30_0
 (
b¡ršg
 
b0
, cÚ¡ * 
s
, 
Ën
, cÚ¡ * 
»s
) {

2641 
b¡ršg
 
b2
;

2642 
rv
, 
»t
 = 0;

2644 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2645 
b2
 = 
	`b¡rıy
 (
b0
);

2646 
	`bwr™•rÙeù
 (*
b2
);

2648 
	`debug
 (".\tbÿtblk (%s, ", 
	`dumpB¡ršg
 (
b2
));

2650 
rv
 = 
	`bÿtblk
 (
b2
, 
s
, 
Ën
);

2651 
»t
 +ğ(
rv
 == 0);

2652 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2654 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2656 
	`bwr™—Îow
 (*
b2
);

2658 
	`debug
 (".\tbÿtblk (%s, ", 
	`dumpB¡ršg
 (
b2
));

2660 
rv
 = 
	`bÿtblk
 (
b2
, 
s
, 
Ën
);

2662 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2664 ià(
s
) {

2665 ià(
Ën
 >ğ0è
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen +†en);

2666 
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen);

2668 
»t
 +ğ((0 !ğ
rv
è&& (
s
 !ğ
NULL
 && 
Ën
 >= 0)) || ((0 ==„v) && (s == NULL ||†en < 0));

2669 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2670 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2671 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2672 
	`bde¡roy
 (
b2
);

2674 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bÿtblk
 (
b0
, 
s
, 
Ën
)));

2675 
	`debug
 (".\tbÿtblk (%s, %p, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), 
s
, 
Ën
, 
rv
);

2678 ià(
»t
) {

2679 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2680 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2681 
	`debug
 (")");

2683  
»t
;

2684 
	}
}

2686 
	$‹¡30
 () {

2687 
»t
 = 0;

2689 
	`debug
 ("TEST: int bcatblk (bstring b0, const char * s);");

2692 
»t
 +ğ
	`‹¡30_0
 (
NULL
, NULL, 0, NULL);

2693 
»t
 +ğ
	`‹¡30_0
 (
NULL
, (*) "", 0, NULL);

2694 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, 
NULL
, 0, "");

2695 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, 
NULL
, -1, "");

2696 
»t
 +ğ
	`‹¡30_0
 (&
badB¡ršg1
, 
NULL
, 0, NULL);

2697 
»t
 +ğ
	`‹¡30_0
 (&
badB¡ršg2
, 
NULL
, 0, NULL);

2700 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, (*) "", -1, "");

2701 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, (*) "", 0, "");

2702 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, (*) "bogus", 5, "bogus");

2703 
»t
 +ğ
	`‹¡30_0
 (&
shÜtB¡ršg
, (*) "", 0, "bogus");

2704 
»t
 +ğ
	`‹¡30_0
 (&
shÜtB¡ršg
, (*) "bogus", 5, "bogusbogus");

2705 
»t
 +ğ
	`‹¡30_0
 (&
shÜtB¡ršg
, (*) "bogus", -1, "bogus");

2706 
	`debug
 ("\t# fau»s: %d", 
»t
);

2707  
»t
;

2708 
	}
}

2710 
	$‹¡31_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶aû
, 
pos
, * 
»s
) {

2711 
b¡ršg
 
b2
;

2712 
rv
, 
»t
 = 0;

2714 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2715 
fšd
 !ğ
NULL
 && fšd->
d©a
 !ğNULL && fšd->
¦’
 >= 0 &&

2716 
»¶aû
 !ğ
NULL
 &&„•Ïû->
d©a
 !ğNULL &&„•Ïû->
¦’
 >= 0) {

2717 
b2
 = 
	`b¡rıy
 (
b0
);

2718 
	`bwr™•rÙeù
 (*
b2
);

2720 
	`debug
 (".\tbfšd»¶aû (%s, %s, %s, %dèğ", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2722 
rv
 = 
	`bfšd»¶aû
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2723 
»t
 +ğ(
rv
 == 0);

2724 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2726 
	`debug
 ("%d", 
rv
);

2728 
	`bwr™—Îow
 (*
b2
);

2730 
	`debug
 (".\tbfšd»¶aû (%s, %s, %s, %d)", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2732 
rv
 = 
	`bfšd»¶aû
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2734 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

2735 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2736 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2738 
	`debug
 (" -> %s", 
	`dumpB¡ršg
 (
b2
));

2740 
	`bde¡roy
 (
b2
);

2742 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bfšd»¶aû
 (
b0
, 
fšd
, 
»¶aû
, 
pos
)));

2743 
	`debug
 (".\tbfšd»¶aû (%s, %s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
, 
rv
);

2746 ià(
»t
) {

2747 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2748 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2749 
	`debug
 (")");

2751  
»t
;

2752 
	}
}

2754 
	$‹¡31_1
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶aû
, 
pos
, * 
»s
) {

2755 
b¡ršg
 
b2
;

2756 
rv
, 
»t
 = 0;

2758 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2759 
fšd
 !ğ
NULL
 && fšd->
d©a
 !ğNULL && fšd->
¦’
 >= 0 &&

2760 
»¶aû
 !ğ
NULL
 &&„•Ïû->
d©a
 !ğNULL &&„•Ïû->
¦’
 >= 0) {

2761 
b2
 = 
	`b¡rıy
 (
b0
);

2762 
	`bwr™•rÙeù
 (*
b2
);

2764 
	`debug
 (".\tbfšd»¶aûÿ£Ës (%s, %s, %s, %dèğ", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2766 
rv
 = 
	`bfšd»¶aûÿ£Ëss
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2767 
»t
 +ğ(
rv
 == 0);

2768 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2770 
	`debug
 ("%d", 
rv
);

2772 
	`bwr™—Îow
 (*
b2
);

2774 
	`debug
 (".\tbfšd»¶aûÿ£Ës (%s, %s, %s, %d)", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2776 
rv
 = 
	`bfšd»¶aûÿ£Ëss
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2778 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

2779 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2780 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2782 
	`debug
 (" -> %s", 
	`dumpB¡ršg
 (
b2
));

2784 
	`bde¡roy
 (
b2
);

2786 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bfšd»¶aûÿ£Ëss
 (
b0
, 
fšd
, 
»¶aû
, 
pos
)));

2787 
	`debug
 (".\tbfšd»¶aûÿ£Ës (%s, %s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
, 
rv
);

2790 ià(
»t
) {

2791 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2792 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2793 
	`debug
 (")");

2795  
»t
;

2796 
	}
}

2798 
	#LOTS_OF_S
 "ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss"

	)

2800 
	$‹¡31
 () {

2801 
»t
 = 0;

2802 
gb¡ršg
 
t0
 = 
	`bsStic
 ("funny");

2803 
gb¡ršg
 
t1
 = 
	`bsStic
 ("weird");

2804 
gb¡ršg
 
t2
 = 
	`bsStic
 ("s");

2805 
gb¡ršg
 
t3
 = 
	`bsStic
 ("long");

2806 
gb¡ršg
 
t4
 = 
	`bsStic
 ("big");

2807 
gb¡ršg
 
t5
 = 
	`bsStic
 ("ss");

2808 
gb¡ršg
 
t6
 = 
	`bsStic
 ("sstsst");

2809 
gb¡ršg
 
t7
 = 
	`bsStic
 ("xx" 
LOTS_OF_S
 "xx");

2810 
gb¡ršg
 
t8
 = 
	`bsStic
 ("S");

2811 
gb¡ršg
 
t9
 = 
	`bsStic
 ("LONG");

2813 
	`debug
 ("TEST: int bfindreplace (bstring b, const_bstring f, const_bstring„, int…os);");

2815 
»t
 +ğ
	`‹¡31_0
 (
NULL
, NULL, NULL, 0, NULL);

2816 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, 
NULL
, &
t1
, 0, (*èshÜtB¡ršg.
d©a
);

2817 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, &
t2
, 
NULL
, 0, (*èshÜtB¡ršg.
d©a
);

2818 
»t
 +ğ
	`‹¡31_0
 (&
badB¡ršg1
, &
t2
, &
t1
, 0, 
NULL
);

2819 
»t
 +ğ
	`‹¡31_0
 (&
badB¡ršg2
, &
t2
, &
t1
, 0, 
NULL
);

2822 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
shÜtB¡ršg
, &
t0
, 0, "This is‡ funny but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

2823 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 0, "Thiweird iweird‡ boguweird but„eaweirdonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2824 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, &
t2
, &
t1
, 0, "boguweird");

2825 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, &
t8
, &
t1
, 0, "bogus");

2826 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 27, "This is‡ bogus but„easonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2827 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t3
, &
t4
, 0, "This is‡ bogus but„easonably big string. Just bigƒnougho cause some mallocing.");

2828 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t9
, &
t4
, 0, "This is‡ bogus but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

2829 
»t
 +ğ
	`‹¡31_0
 (&
t6
, &
t2
, &
t5
, 0, "sssstsssst");

2830 
»t
 +ğ
	`‹¡31_0
 (&
t7
, &
t2
, &
t5
, 0, "xx" 
LOTS_OF_S
 LOTS_OF_S "xx");

2832 
	`debug
 ("TEST: int bfindreplacecaseless (bstring b, const_bstring f, const_bstring„, int…os);");

2834 
»t
 +ğ
	`‹¡31_1
 (
NULL
, NULL, NULL, 0, NULL);

2835 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, 
NULL
, &
t1
, 0, (*èshÜtB¡ršg.
d©a
);

2836 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, &
t2
, 
NULL
, 0, (*èshÜtB¡ršg.
d©a
);

2837 
»t
 +ğ
	`‹¡31_1
 (&
badB¡ršg1
, &
t2
, &
t1
, 0, 
NULL
);

2838 
»t
 +ğ
	`‹¡31_1
 (&
badB¡ršg2
, &
t2
, &
t1
, 0, 
NULL
);

2841 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
shÜtB¡ršg
, &
t0
, 0, "This is‡ funny but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

2842 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 0, "Thiweird iweird‡ boguweird but„eaweirdonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2843 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, &
t2
, &
t1
, 0, "boguweird");

2844 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, &
t8
, &
t1
, 0, "boguweird");

2845 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 27, "This is‡ bogus but„easonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2846 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t3
, &
t4
, 0, "This is‡ bogus but„easonably big string. Just bigƒnougho cause some mallocing.");

2847 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t9
, &
t4
, 0, "This is‡ bogus but„easonably big string. Just bigƒnougho cause some mallocing.");

2848 
»t
 +ğ
	`‹¡31_1
 (&
t6
, &
t2
, &
t5
, 0, "sssstsssst");

2849 
»t
 +ğ
	`‹¡31_1
 (&
t6
, &
t8
, &
t5
, 0, "sssstsssst");

2850 
»t
 +ğ
	`‹¡31_1
 (&
t7
, &
t2
, &
t5
, 0, "xx" 
LOTS_OF_S
 LOTS_OF_S "xx");

2852 
	`debug
 ("\t# fau»s: %d", 
»t
);

2853  
»t
;

2854 
	}
}

2856 
	$‹¡32_0
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
, 
»s
) {

2857 
rv
, 
»t
 = 0;

2859 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`bi£qc¡r
 (
b
, 
s
)));

2860 
	`debug
 (".\tbi£qc¡¸(%s, %p:<%s>èğ%d", 
	`dumpB¡ršg
 (
b
), 
s
, ( ? s : 
NULL
), 
rv
);

2861 ià(
»t
) {

2862 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

2864  
»t
;

2865 
	}
}

2867 
	$‹¡32_1
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
, 
»s
) {

2868 
rv
, 
»t
 = 0;

2870 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`bi£qc¡rÿ£Ëss
 (
b
, 
s
)));

2871 
	`debug
 (".\tbi£qc¡rÿ£Ës (%s, %p:<%s>èğ%d", 
	`dumpB¡ršg
 (
b
), 
s
, ( ? s : 
NULL
), 
rv
);

2872 ià(
»t
) {

2873 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

2875  
»t
;

2876 
	}
}

2879 
	$‹¡32
 () {

2880 
»t
 = 0;

2882 
	`debug
 ("TEST: int biseqcstr (const_bstring b, const char * s);");

2885 
»t
 +ğ
	`‹¡32_0
 (
NULL
, NULL, 
BSTR_ERR
);

2886 
»t
 +ğ
	`‹¡32_0
 (&
em±yB¡ršg
, 
NULL
, 
BSTR_ERR
);

2887 
»t
 +ğ
	`‹¡32_0
 (
NULL
, "", 
BSTR_ERR
);

2888 
»t
 +ğ
	`‹¡32_0
 (&
badB¡ršg1
, "", 
BSTR_ERR
);

2889 
»t
 +ğ
	`‹¡32_0
 (&
badB¡ršg2
, "bogus", 
BSTR_ERR
);

2892 
»t
 +ğ
	`‹¡32_0
 (&
em±yB¡ršg
, "", 1);

2893 
»t
 +ğ
	`‹¡32_0
 (&
shÜtB¡ršg
, "bogus", 1);

2894 
»t
 +ğ
	`‹¡32_0
 (&
em±yB¡ršg
, "bogus", 0);

2895 
»t
 +ğ
	`‹¡32_0
 (&
shÜtB¡ršg
, "", 0);

2898 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

2899 
b
->
d©a
[1]++;

2900 
»t
 +ğ
	`‹¡32_0
 (
b
, (*è
shÜtB¡ršg
.
d©a
, 0);

2901 
	`bde¡roy
 (
b
);

2904 
	`debug
 ("TEST: int biseqcstrcaseless (const_bstring b, const char * s);");

2907 
»t
 +ğ
	`‹¡32_1
 (
NULL
, NULL, 
BSTR_ERR
);

2908 
»t
 +ğ
	`‹¡32_1
 (&
em±yB¡ršg
, 
NULL
, 
BSTR_ERR
);

2909 
»t
 +ğ
	`‹¡32_1
 (
NULL
, "", 
BSTR_ERR
);

2910 
»t
 +ğ
	`‹¡32_1
 (&
badB¡ršg1
, "", 
BSTR_ERR
);

2911 
»t
 +ğ
	`‹¡32_1
 (&
badB¡ršg2
, "bogus", 
BSTR_ERR
);

2914 
»t
 +ğ
	`‹¡32_1
 (&
em±yB¡ršg
, "", 1);

2915 
»t
 +ğ
	`‹¡32_1
 (&
shÜtB¡ršg
, "bogus", 1);

2916 
»t
 +ğ
	`‹¡32_1
 (&
shÜtB¡ršg
, "BOGUS", 1);

2917 
»t
 +ğ
	`‹¡32_1
 (&
em±yB¡ršg
, "bogus", 0);

2918 
»t
 +ğ
	`‹¡32_1
 (&
shÜtB¡ršg
, "", 0);

2921 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

2922 
b
->
d©a
[1]++;

2923 
»t
 +ğ
	`‹¡32_1
 (
b
, (*è
shÜtB¡ršg
.
d©a
, 0);

2924 
	`bde¡roy
 (
b
);

2927 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

2928  
»t
;

2929 
	}
}

2931 
	$‹¡33_0
 (
b¡ršg
 
b0
, cÚ¡ * 
»s
) {

2932 
b¡ršg
 
b2
;

2933 
rv
, 
»t
 = 0;

2935 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2936 
b2
 = 
	`b¡rıy
 (
b0
);

2937 
	`bwr™•rÙeù
 (*
b2
);

2939 
	`debug
 (".\tbtouµ” (%s)", 
	`dumpB¡ršg
 (
b2
));

2941 
rv
 = 
	`btouµ”
 (
b2
);

2942 
»t
 +ğ(
rv
 == 0);

2943 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2945 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

2947 
	`bwr™—Îow
 (*
b2
);

2949 
	`debug
 (".\tbtouµ” (%s)", 
	`dumpB¡ršg
 (
b2
));

2951 
rv
 = 
	`btouµ”
 (
b2
);

2953 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

2955 
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen);

2956 
»t
 +ğ(0 !ğ
rv
);

2957 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2958 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2959 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2960 
	`bde¡roy
 (
b2
);

2962 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`btouµ”
 (
b0
)));

2963 
	`debug
 (".\tbtouµ” (%sèğ%d", 
	`dumpB¡ršg
 (
b0
), 
rv
);

2966 ià(
»t
) {

2967 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2968 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2969 
	`debug
 (")");

2971  
»t
;

2972 
	}
}

2974 
	$‹¡33
 () {

2975 
»t
 = 0;

2977 
	`debug
 ("TEST: int btoupper (bstring b);");

2980 
»t
 +ğ
	`‹¡33_0
 (
NULL
, NULL);

2981 
»t
 +ğ
	`‹¡33_0
 (&
badB¡ršg1
, 
NULL
);

2982 
»t
 +ğ
	`‹¡33_0
 (&
badB¡ršg2
, 
NULL
);

2985 
»t
 +ğ
	`‹¡33_0
 (&
em±yB¡ršg
, "");

2986 
»t
 +ğ
	`‹¡33_0
 (&
shÜtB¡ršg
, "BOGUS");

2987 
»t
 +ğ
	`‹¡33_0
 (&
lÚgB¡ršg
, "THIS IS A BOGUS BUT REASONABLY LONG STRING. JUST LONG ENOUGH TO CAUSE SOME MALLOCING.");

2989 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

2990  
»t
;

2991 
	}
}

2993 
	$‹¡34_0
 (
b¡ršg
 
b0
, cÚ¡ * 
»s
) {

2994 
b¡ršg
 
b2
;

2995 
rv
, 
»t
 = 0;

2997 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2998 
b2
 = 
	`b¡rıy
 (
b0
);

2999 
	`bwr™•rÙeù
 (*
b2
);

3001 
	`debug
 (".\tbtŞow” (%s)", 
	`dumpB¡ršg
 (
b2
));

3003 
rv
 = 
	`btŞow”
 (
b2
);

3004 
»t
 +ğ(
rv
 == 0);

3005 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

3007 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

3009 
	`bwr™—Îow
 (*
b2
);

3011 
	`debug
 (".\tbtŞow” (%s)", 
	`dumpB¡ršg
 (
b2
));

3013 
rv
 = 
	`btŞow”
 (
b2
);

3015 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

3017 
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen);

3018 
»t
 +ğ(0 !ğ
rv
);

3019 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

3020 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

3021 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

3022 
	`bde¡roy
 (
b2
);

3024 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`btŞow”
 (
b0
)));

3025 
	`debug
 (".\tbtŞow” (%sèğ%d", 
	`dumpB¡ršg
 (
b0
), 
rv
);

3028 ià(
»t
) {

3029 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

3030 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

3031 
	`debug
 (")");

3033  
»t
;

3034 
	}
}

3036 
	$‹¡34
 () {

3037 
»t
 = 0;

3039 
	`debug
 ("TEST: int btolower (bstring b);");

3042 
»t
 +ğ
	`‹¡34_0
 (
NULL
, NULL);

3043 
»t
 +ğ
	`‹¡34_0
 (&
badB¡ršg1
, 
NULL
);

3044 
»t
 +ğ
	`‹¡34_0
 (&
badB¡ršg2
, 
NULL
);

3047 
»t
 +ğ
	`‹¡34_0
 (&
em±yB¡ršg
, "");

3048 
»t
 +ğ
	`‹¡34_0
 (&
shÜtB¡ršg
, "bogus");

3049 
»t
 +ğ
	`‹¡34_0
 (&
lÚgB¡ršg
, "this is‡ bogus but„easonably†ong string. just†ongƒnougho cause some mallocing.");

3051 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3052  
»t
;

3053 
	}
}

3055 
	$‹¡35_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
»s
) {

3056 
rv
, 
»t
 = 0;

3058 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`b¡ricmp
 (
b0
, 
b1
)));

3059 
	`debug
 (".\tb¡ricm°(%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

3060 ià(
»t
) {

3061 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

3063  
»t
;

3064 
	}
}

3066 
	$‹¡35
 () {

3067 
»t
 = 0;

3068 
gb¡ršg
 
t0
 = 
	`bsStic
 ("bOgUs");

3069 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bOgUR");

3070 
gb¡ršg
 
t2
 = 
	`bsStic
 ("bOgUt");

3072 
	`debug
 ("TEST: int bstricmp (const_bstring b0, const_bstring b1);");

3075 
»t
 +ğ
	`‹¡35_0
 (
NULL
, NULL, 
SHRT_MIN
);

3076 
»t
 +ğ
	`‹¡35_0
 (&
em±yB¡ršg
, 
NULL
, 
SHRT_MIN
);

3077 
»t
 +ğ
	`‹¡35_0
 (
NULL
, &
em±yB¡ršg
, 
SHRT_MIN
);

3078 
»t
 +ğ
	`‹¡35_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
SHRT_MIN
);

3079 
»t
 +ğ
	`‹¡35_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
SHRT_MIN
);

3080 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
badB¡ršg2
, 
SHRT_MIN
);

3081 
»t
 +ğ
	`‹¡35_0
 (&
badB¡ršg2
, &
shÜtB¡ršg
, 
SHRT_MIN
);

3084 
»t
 +ğ
	`‹¡35_0
 (&
em±yB¡ršg
, &emptyBstring, 0);

3085 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t0
, 0);

3086 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t1
, 
	`tŞow”
 (shÜtB¡ršg.
d©a
[4]) -olower (t1.data[4]));

3087 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t2
, 
	`tŞow”
 (shÜtB¡ršg.
d©a
[4]) -olower (t2.data[4]));

3089 
t0
.
¦’
++;

3090 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t0
, -(
UCHAR_MAX
+1));

3091 
»t
 +ğ
	`‹¡35_0
 (&
t0
, &
shÜtB¡ršg
, (
UCHAR_MAX
+1));

3093 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3094  
»t
;

3095 
	}
}

3097 
	$‹¡36_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
, 
»s
) {

3098 
rv
, 
»t
 = 0;

3100 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`b¡ºicmp
 (
b0
, 
b1
, 
n
)));

3101 
	`debug
 (".\tb¡ºicm°(%s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
n
, 
rv
);

3102 ià(
»t
) {

3103 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

3105  
»t
;

3106 
	}
}

3108 
	$‹¡36
 () {

3109 
»t
 = 0;

3110 
gb¡ršg
 
t0
 = 
	`bsStic
 ("bOgUs");

3111 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bOgUR");

3112 
gb¡ršg
 
t2
 = 
	`bsStic
 ("bOgUt");

3114 
	`debug
 ("TEST: int bstrnicmp (const_bstring b0, const_bstring b1);");

3117 
»t
 +ğ
	`‹¡36_0
 (
NULL
, NULL, 0, 
SHRT_MIN
);

3118 
»t
 +ğ
	`‹¡36_0
 (&
em±yB¡ršg
, 
NULL
, 0, 
SHRT_MIN
);

3119 
»t
 +ğ
	`‹¡36_0
 (
NULL
, &
em±yB¡ršg
, 0, 
SHRT_MIN
);

3120 
»t
 +ğ
	`‹¡36_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 0, 
SHRT_MIN
);

3121 
»t
 +ğ
	`‹¡36_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 0, 
SHRT_MIN
);

3122 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
badB¡ršg2
, 5, 
SHRT_MIN
);

3123 
»t
 +ğ
	`‹¡36_0
 (&
badB¡ršg2
, &
shÜtB¡ršg
, 5, 
SHRT_MIN
);

3126 
»t
 +ğ
	`‹¡36_0
 (&
em±yB¡ršg
, &emptyBstring, 0, 0);

3127 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 0, 0);

3128 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 5, 0);

3129 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 4, 0);

3130 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 6, 0);

3131 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t1
, 5, shÜtB¡ršg.
d©a
[4] -1.data[4]);

3132 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t1
, 4, 0);

3133 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t1
, 6, shÜtB¡ršg.
d©a
[4] -1.data[4]);

3134 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t2
, 5, shÜtB¡ršg.
d©a
[4] -2.data[4]);

3135 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t2
, 4, 0);

3136 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t2
, 6, shÜtB¡ršg.
d©a
[4] -2.data[4]);

3138 
t0
.
¦’
++;

3139 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 5, 0);

3140 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 6, -(
UCHAR_MAX
+1));

3141 
»t
 +ğ
	`‹¡36_0
 (&
t0
, &
shÜtB¡ršg
, 6, (
UCHAR_MAX
+1));

3143 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3144  
»t
;

3145 
	}
}

3147 
	$‹¡37_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
»s
) {

3148 
rv
, 
»t
 = 0;

3150 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`bi£qÿ£Ëss
 (
b0
, 
b1
)));

3151 
	`debug
 (".\tbi£qÿ£Ës (%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

3152 ià(
»t
) {

3153 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

3155  
»t
;

3156 
	}
}

3158 
	$‹¡37
 () {

3159 
»t
 = 0;

3160 
gb¡ršg
 
t0
 = 
	`bsStic
 ("bOgUs");

3161 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bOgUR");

3162 
gb¡ršg
 
t2
 = 
	`bsStic
 ("bOgUt");

3164 
	`debug
 ("TEST: int biseqcaseless (const_bstring b0, const_bstring b1);");

3167 
»t
 +ğ
	`‹¡37_0
 (
NULL
, NULL, 
BSTR_ERR
);

3168 
»t
 +ğ
	`‹¡37_0
 (&
em±yB¡ršg
, 
NULL
, 
BSTR_ERR
);

3169 
»t
 +ğ
	`‹¡37_0
 (
NULL
, &
em±yB¡ršg
, 
BSTR_ERR
);

3170 
»t
 +ğ
	`‹¡37_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
BSTR_ERR
);

3171 
»t
 +ğ
	`‹¡37_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
BSTR_ERR
);

3172 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
badB¡ršg2
, 
BSTR_ERR
);

3173 
»t
 +ğ
	`‹¡37_0
 (&
badB¡ršg2
, &
shÜtB¡ršg
, 
BSTR_ERR
);

3176 
»t
 +ğ
	`‹¡37_0
 (&
em±yB¡ršg
, &emptyBstring, 1);

3177 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
t0
, 1);

3178 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
t1
, 0);

3179 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
t2
, 0);

3181 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3182  
»t
;

3183 
	}
}

3185 
	semuFe
 {

3186 
	mofs
;

3187 
b¡ršg
 
	mcÚ‹Ás
;

3190 
	$‹¡38_aux_bNg‘c
 (
emuFe
 * 
f
) {

3191 
v
 = 
EOF
;

3192 ià(
NULL
 !ğ
f
 && 
EOF
 !ğ(
v
 = 
	`bch¬e
 (f->
cÚ‹Ás
, f->
ofs
, EOF))) f->ofs++;

3193  
v
;

3194 
	}
}

3196 
size_t
 
	$‹¡38_aux_bN»ad
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, 
emuFe
 * 
f
) {

3197 * 
b
 = (*è
buff
;

3198 
v
;

3199 
size_t
 
i
, 
j
, 
c
 = 0;

3201 ià(
NULL
 =ğ
f
 || NULL =ğ
b
è 
c
;

3202 
i
=0; i < 
ÃËm
; i++è
j
=0; j < 
–size
; j++) {

3203 
v
 = 
	`‹¡38_aux_bNg‘c
 (
f
);

3204 ià(
EOF
 =ğ
v
) {

3205 *
b
 = () '\0';

3206  
c
;

3208 *
b
 = (è
v
;

3209 
b
++;

3210 
c
++;

3214  
c
;

3215 
	}
}

3217 
	$‹¡38_aux_bNİ’
 (
emuFe
 * 
f
, 
b¡ršg
 
b
) {

3218 ià(
NULL
 =ğ
f
 || NULL =ğ
b
è -
__LINE__
;

3219 
f
->
ofs
 = 0;

3220 
f
->
cÚ‹Ás
 = 
b
;

3222 
	}
}

3224 
	$‹¡38
 () {

3225 
emuFe
 
f
;

3226 
b¡ršg
 
b0
, 
b1
, 
b2
, 
b3
;

3227 
»t
 = 0;

3229 
	`debug
 ("TEST: bgets/breadsest");

3231 
	`‹¡38_aux_bNİ’
 (&
f
, &
shÜtB¡ršg
);

3235 
b0
 = 
	`bg‘s
 ((
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'b');

3236 
b1
 = 
	`b»ad
 ((
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3237 
b2
 = 
	`bg‘s
 ((
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () '\0');

3238 
b3
 = 
	`b»ad
 ((
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3240 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b0
, "b");

3241 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b1
, "ogus");

3242 
»t
 +ğ
NULL
 !ğ
b2
;

3243 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b3
, "");

3247 
f
.
ofs
 = 0;

3249 
»t
 +ğ0 <ğ
	`bg‘§
 (
NULL
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3250 
»t
 +ğ0 <ğ
	`b»ada
 (
NULL
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3251 
»t
 +ğ0 <ğ
	`bg‘§
 (&
shÜtB¡ršg
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3252 
»t
 +ğ0 <ğ
	`b»ada
 (&
shÜtB¡ršg
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3256 
»t
 +ğ0 > 
	`bg‘§
 (
b0
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3257 
»t
 +ğ0 > 
	`b»ada
 (
b1
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3259 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b0
, "bbo");

3260 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b1
, "ogusgus");

3264 
»t
 +ğ0 > 
	`bg‘§
 (
b0
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3265 
»t
 +ğ0 > 
	`b»ada
 (
b1
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3267 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b0
, "bbo");

3268 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b1
, "ogusgus");

3270 
	`bde¡roy
 (
b0
);

3271 
	`bde¡roy
 (
b1
);

3272 
	`bde¡roy
 (
b2
);

3273 
	`bde¡roy
 (
b3
);

3275 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3276  
»t
;

3277 
	}
}

3279 
	$‹¡39_0
 (
cÚ¡_b¡ršg
 
b
, cÚ¡_b¡ršg 
É
, cÚ¡_b¡ršg 
¹
, cÚ¡_b¡ršg 
t
) {

3280 
b¡ršg
 
r
;

3281 
»t
 = 0;

3283 
»t
 +ğ0 <ğ
	`bÉrimws
 (
NULL
);

3284 
»t
 +ğ0 <ğ
	`b¹rimws
 (
NULL
);

3285 
»t
 +ğ0 <ğ
	`bŒimws
 (
NULL
);

3287 
r
 = 
	`b¡rıy
 (
b
);

3288 
	`bwr™•rÙeù
 (*
r
);

3289 
»t
 +ğ0 <ğ
	`bÉrimws
 (
r
);

3290 
»t
 +ğ0 <ğ
	`b¹rimws
 (
r
);

3291 
»t
 +ğ0 <ğ
	`bŒimws
 (
r
);

3292 
	`bwr™—Îow
(*
r
);

3293 
»t
 +ğ0 !ğ
	`bÉrimws
 (
r
);

3294 
	`debug
 (".\tbÉrim (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3295 
»t
 +ğ!
	`bi£q
 (
r
, 
É
);

3296 
	`bde¡roy
 (
r
);

3298 
r
 = 
	`b¡rıy
 (
b
);

3299 
»t
 +ğ0 !ğ
	`b¹rimws
 (
r
);

3300 
	`debug
 (".\tb¹rim (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3301 
»t
 +ğ!
	`bi£q
 (
r
, 
¹
);

3302 
	`bde¡roy
 (
r
);

3304 
r
 = 
	`b¡rıy
 (
b
);

3305 
»t
 +ğ0 !ğ
	`bŒimws
 (
r
);

3306 
	`debug
 (".\tbŒim (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3307 
»t
 +ğ!
	`bi£q
 (
r
, 
t
);

3308 
	`bde¡roy
 (
r
);

3310  
»t
;

3311 
	}
}

3313 
	$‹¡39
 () {

3314 
»t
 = 0;

3315 
gb¡ršg
 
t0
 = 
	`bsStic
 (" bogus string ");

3316 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bogus string ");

3317 
gb¡ršg
 
t2
 = 
	`bsStic
 (" bogus string");

3318 
gb¡ršg
 
t3
 = 
	`bsStic
 ("bogus string");

3319 
gb¡ršg
 
t4
 = 
	`bsStic
 (" ");

3320 
gb¡ršg
 
t5
 = 
	`bsStic
 ("");

3322 
	`debug
 ("TEST:rim functions");

3324 
»t
 +ğ
	`‹¡39_0
 (&
t0
, &
t1
, &
t2
, &
t3
);

3325 
»t
 +ğ
	`‹¡39_0
 (&
t1
, &t1, &
t3
, &t3);

3326 
»t
 +ğ
	`‹¡39_0
 (&
t2
, &
t3
, &t2, &t3);

3327 
»t
 +ğ
	`‹¡39_0
 (&
t3
, &t3, &t3, &t3);

3328 
»t
 +ğ
	`‹¡39_0
 (&
t4
, &
t5
, &t5, &t5);

3329 
»t
 +ğ
	`‹¡39_0
 (&
t5
, &t5, &t5, &t5);

3331 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3332  
»t
;

3333 
	}
}

3335 
	$‹¡40_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
, 
Ëá
, 
Ën
, cÚ¡ * 
»s
) {

3336 
b¡ršg
 
b2
;

3337 
rv
, 
»t
 = 0;

3339 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

3340 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

3341 
b2
 = 
	`b¡rıy
 (
b0
);

3342 
	`bwr™•rÙeù
 (*
b2
);

3344 
	`debug
 (".\tbassignmid¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

3346 
rv
 = 
	`bassignmid¡r
 (
b2
, 
b1
, 
Ëá
, 
Ën
);

3347 
»t
 +ğ(
rv
 == 0);

3348 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

3350 
	`debug
 ("%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b2
));

3352 
	`bwr™—Îow
 (*
b2
);

3354 
	`debug
 (".\tbassignmid¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

3356 
rv
 = 
	`bassignmid¡r
 (
b2
, 
b1
, 
Ëá
, 
Ën
);

3358 
	`debug
 ("%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b2
));

3360 ià(
b1
è
»t
 +ğ(
b2
->
¦’
 > 
Ën
) | (b2->slen < 0);

3361 
»t
 +ğ((0 !ğ
rv
è&& (
b1
 !ğ
NULL
)) || ((0 ==„v) && (b1 == NULL));

3362 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

3363 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

3364 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

3365 
	`bde¡roy
 (
b2
);

3367 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bassignmid¡r
 (
b0
, 
b1
, 
Ëá
, 
Ën
)));

3368 
	`debug
 (".\tbassignmid¡¸(%s, %s, %d, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
Ëá
, 
Ën
, 
rv
);

3371 ià(
»t
) {

3372 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

3373 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

3374 
	`debug
 (")");

3376  
»t
;

3377 
	}
}

3379 
	$‹¡40
 () {

3380 
»t
 = 0;

3382 
	`debug
 ("TEST: int bassignmidstr (bstring b0, const_bstring b1, int†eft, int†en);");

3385 
»t
 +ğ
	`‹¡40_0
 (
NULL
, NULL, 0, 1, NULL);

3386 
»t
 +ğ
	`‹¡40_0
 (
NULL
, &
em±yB¡ršg
, 0, 1, NULL);

3387 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, 
NULL
, 0, 1, "");

3388 
»t
 +ğ
	`‹¡40_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 0, 1, 
NULL
);

3389 
»t
 +ğ
	`‹¡40_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 0, 1, 
NULL
);

3390 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 0, 1, 
NULL
);

3391 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 0, 1, 
NULL
);

3394 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &emptyBstring, 0, 1, "");

3395 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &
shÜtB¡ršg
, 1, 3, "ogu");

3396 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, 0, 1, "");

3397 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, 1, 3, "ogu");

3398 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, -1, 4, "bog");

3399 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, 1, 9, "ogus");

3400 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, 9, 1, "");

3402 
	`debug
 ("\t# fau»s: %d", 
»t
);

3403  
»t
;

3404 
	}
}

3406 
	$‹¡41_0
 (
b¡ršg
 
b1
, 
Ëá
, 
Ën
, cÚ¡ * 
»s
) {

3407 
gb¡ršg
 
t
;

3408 
b¡ršg
 
b2
, 
b3
;

3409 
»t
 = 0;

3411 ià(
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

3412 
b2
 = 
	`bäomc¡r
 ("");

3414 
	`bassignmid¡r
 (
b2
, 
b1
, 
Ëá
, 
Ën
);

3416 
	`bmid2tb¡r
 (
t
, 
b1
, 
Ëá
, 
Ën
);

3417 
b3
 = 
	`b¡rıy
 (&
t
);

3419 
	`debug
 (".\tbmid2tb¡¸(%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b3
));

3421 
»t
 +ğ!
	`bi£q
 (&
t
, 
b2
);

3423 
	`bde¡roy
 (
b2
);

3424 
	`bde¡roy
 (
b3
);

3426 
	`bmid2tb¡r
 (
t
, 
b1
, 
Ëá
, 
Ën
);

3427 
b3
 = 
	`b¡rıy
 (&
t
);

3428 
»t
 +ğ
t
.
¦’
 != 0;

3430 
	`debug
 (".\tbmid2tb¡¸(%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b3
));

3431 
	`bde¡roy
 (
b3
);

3434 ià(
»t
) {

3435 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

3436 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

3437 
	`debug
 (")");

3439  
»t
;

3440 
	}
}

3442 
	$‹¡41
 () {

3443 
»t
 = 0;

3445 
	`debug
 ("TEST: int bmid2tbstr (structagbstring &t, const_bstring b1, int†eft, int†en);");

3448 
»t
 +ğ
	`‹¡41_0
 (
NULL
, 0, 1, NULL);

3449 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, 
NULL
);

3450 
»t
 +ğ
	`‹¡41_0
 (
NULL
, 0, 1, "");

3451 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, 
NULL
);

3452 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, 
NULL
);

3453 
»t
 +ğ
	`‹¡41_0
 (&
badB¡ršg1
, 0, 1, 
NULL
);

3454 
»t
 +ğ
	`‹¡41_0
 (&
badB¡ršg2
, 0, 1, 
NULL
);

3457 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, "");

3458 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 1, 3, "ogu");

3459 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, "");

3460 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 1, 3, "ogu");

3461 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, -1, 4, "bog");

3462 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 1, 9, "ogus");

3463 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 9, 1, "");

3465 
	`debug
 ("\t# fau»s: %d", 
»t
);

3466  
»t
;

3467 
	}
}

3469 
	$‹¡42_0
 (
cÚ¡_b¡ršg
 
bi
, 
Ën
, cÚ¡ * 
»s
) {

3470 
b¡ršg
 
b
;

3471 
rv
, 
»t
 = 0;

3473 
rv
 = 
	`bŒunc
 (
b
 = 
	`b¡rıy
 (
bi
), 
Ën
);

3474 
»t
 +ğ(
Ën
 >ğ0è? (
rv
 < 0) : (rv >= 0);

3475 ià(
»s
è
»t
 +ğ(0 =ğ
	`bi£qc¡r
 (
b
,„es));

3476 
	`debug
 (".\tbŒunø(%s, %dèğ%s", 
	`dumpB¡ršg
 (
bi
), 
Ën
, dumpB¡ršg (
b
));

3477 
	`bde¡roy
 (
b
);

3478  
»t
;

3479 
	}
}

3481 
	$‹¡42
 () {

3482 
»t
 = 0;

3484 
	`debug
 ("TEST: int btrunc (bstring b, int‚);");

3487 
»t
 +ğ0 <ğ
	`bŒunc
 (
NULL
, 2);

3488 
»t
 +ğ0 <ğ
	`bŒunc
 (
NULL
, 0);

3489 
»t
 +ğ0 <ğ
	`bŒunc
 (
NULL
, -1);

3492 
»t
 +ğ0 <ğ
	`bŒunc
 (&
shÜtB¡ršg
, 2);

3493 
»t
 +ğ0 <ğ
	`bŒunc
 (&
shÜtB¡ršg
, 0);

3494 
»t
 +ğ0 <ğ
	`bŒunc
 (&
shÜtB¡ršg
, -1);

3496 
»t
 +ğ
	`‹¡42_0
 (&
em±yB¡ršg
, 10, "");

3497 
»t
 +ğ
	`‹¡42_0
 (&
em±yB¡ršg
, 0, "");

3498 
»t
 +ğ
	`‹¡42_0
 (&
em±yB¡ršg
, -1, 
NULL
);

3500 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, 10, "bogus");

3501 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, 3, "bog");

3502 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, 0, "");

3503 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, -1, 
NULL
);

3505 
	`debug
 ("\t# fau»s: %d", 
»t
);

3506  
»t
;

3507 
	}
}

3509 
	$‹¡43
 () {

3510 
gb¡ršg
 
ts0
 = 
	`bsStic
 ("");

3511 
gb¡ršg
 
ts1
 = 
	`bsStic
 (" ");

3512 
gb¡ršg
 
ts2
 = 
	`bsStic
 ("‡bc");

3513 
gb¡ršg
 
ts3
 = 
	`bsStic
 ("abc ");

3514 
gb¡ršg
 
ts4
 = 
	`bsStic
 ("‡bc ");

3515 
gb¡ršg
 
ts5
 = 
	`bsStic
 ("abc");

3516 
b¡ršg
 
t¡rs
[6] = { &
ts0
, &
ts1
, &
ts2
, &
ts3
, &
ts4
, &
ts5
 };

3517 
»t
 = 0;

3518 
i
;

3520 
	`debug
 ("TEST: int btfromblk*trim (structagbstring, void * s, int†);");

3522 
i
=0; i < 6; i++) {

3523 
gb¡ršg
 
t
;

3524 
b¡ršg
 
b
;

3526 
	`btäomblkÉrimws
 (
t
, 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3527 
	`bÉrimws
 (
b
 = 
	`b¡rıy
 (
t¡rs
[
i
]));

3528 ià(!
	`bi£q
 (
b
, &
t
)) {

3529 
»t
++;

3530 
	`bassign
 (
b
, &
t
);

3531 
	`debug
 ("btäomblkÉrimw çu»: <%s> -> <%s>", 
t¡rs
[
i
]->
d©a
, 
b
->data);

3533 
	`debug
 (".\tbtäomblkÉrimw (\"%s\", \"%s\", %d)", (*è
	`bd©«
 (
b
, 
NULL
), 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3534 
	`bde¡roy
 (
b
);

3536 
	`btäomblk¹rimws
 (
t
, 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3537 
	`b¹rimws
 (
b
 = 
	`b¡rıy
 (
t¡rs
[
i
]));

3538 ià(!
	`bi£q
 (
b
, &
t
)) {

3539 
»t
++;

3540 
	`bassign
 (
b
, &
t
);

3541 
	`debug
 ("btäomblk¹rimw çu»: <%s> -> <%s>", 
t¡rs
[
i
]->
d©a
, 
b
->data);

3543 
	`debug
 (".\tbtäomblk¹rimw (\"%s\", \"%s\", %d)", (*è
	`bd©«
 (
b
, 
NULL
), 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3544 
	`bde¡roy
 (
b
);

3546 
	`btäomblkŒimws
 (
t
, 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3547 
	`bŒimws
 (
b
 = 
	`b¡rıy
 (
t¡rs
[
i
]));

3548 ià(!
	`bi£q
 (
b
, &
t
)) {

3549 
»t
++;

3550 
	`bassign
 (
b
, &
t
);

3551 
	`debug
 ("btäomblkŒimw çu»: <%s> -> <%s>", 
t¡rs
[
i
]->
d©a
, 
b
->data);

3553 
	`debug
 (".\tbtäomblkŒimw (\"%s\", \"%s\", %d)", (*è
	`bd©«
 (
b
, 
NULL
), 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3554 
	`bde¡roy
 (
b
);

3557 
	`debug
 ("\t# fau»s: %d", 
»t
);

3558  
»t
;

3559 
	}
}

3561 
	$‹¡44_0
 (cÚ¡ * 
¡r
) {

3562 
»t
 = 0, 
v
;

3563 
b¡ršg
 
b
 = 
	`bäomc¡r
("");

3565 ià(
NULL
 =ğ
¡r
) {

3566 
»t
 +ğ0 <ğ
	`bassignc¡r
 (
NULL
, "test");

3567 
	`debug
 (".\tbassignc¡¸(b = %s, NULL)", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")));

3568 
»t
 +ğ0 <ğ(
v
 = 
	`bassignc¡r
 (
b
, 
NULL
));

3569 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3570 
»t
 +ğ0 <ğ
	`bassignc¡r
 (&
shÜtB¡ršg
, 
NULL
);

3571 
	`bde¡roy
 (
b
);

3572  
»t
;

3575 
»t
 +ğ0 <ğ
	`bassignc¡r
 (
NULL
, 
¡r
);

3576 
	`debug
 (".\tbassignc¡¸(b = %s, \"%s\")", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")), 
¡r
);

3577 
»t
 +ğ0 > (
v
 = 
	`bassignc¡r
 (
b
, 
¡r
));

3578 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3579 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), 
¡r
);

3580 
»t
 +ğ((
size_t
è
b
->
¦’
è!ğ
	`¡¾’
 (
¡r
);

3581 
»t
 +ğ0 > 
	`bassignc¡r
 (
b
, "xxxxx");

3582 
	`bwr™•rÙeù
(*
b
)

3583 
	`log_šfo
(".\tbassignc¡¸(b = %s, \"%s\")", 
	`dumpB¡ršg
 (
b
), 
¡r
);

3584 
»t
 +ğ0 <ğ(
v
 = 
	`bassignc¡r
 (
b
, 
¡r
));

3585 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3586 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), "xxxxx");

3587 
»t
 +ğ((
size_t
è
b
->
¦’
è!ğ
	`¡¾’
 ("xxxxx");

3588 
	`bwr™—Îow
(*
b
)

3589 
»t
 +ğ0 <ğ
	`bassignc¡r
 (&
shÜtB¡ršg
, 
¡r
);

3590 
	`bde¡roy
 (
b
);

3591 
	`debug
 (".\tbassignc¡¸× = %s, \"%s\")", 
	`dumpB¡ršg
 (&
shÜtB¡ršg
), 
¡r
);

3592 
»t
 +ğ0 <ğ(
v
 = 
	`bassignc¡r
 (&
shÜtB¡ršg
, 
¡r
));

3593 
	`debug
 (" = %d;‡ -> %s", 
v
, 
	`dumpB¡ršg
 (&
shÜtB¡ršg
));

3594  
»t
;

3595 
	}
}

3597 
	$‹¡44
 () {

3598 
»t
 = 0;

3600 
	`debug
 ("TEST: int bassigncstr (bstring‡, char * str);");

3603 
»t
 +ğ
	`‹¡44_0
 (
NULL
);

3605 
»t
 +ğ
	`‹¡44_0
 (
EMPTY_STRING
);

3606 
»t
 +ğ
	`‹¡44_0
 (
SHORT_STRING
);

3607 
»t
 +ğ
	`‹¡44_0
 (
LONG_STRING
);

3609 
	`debug
 ("\t# fau»s: %d", 
»t
);

3610  
»t
;

3611 
	}
}

3613 
	$‹¡45_0
 (cÚ¡ * 
¡r
) {

3614 
»t
 = 0, 
v
, 
Ën
;

3615 
b¡ršg
 
b
 = 
	`bäomc¡r
("");

3616 ià(
NULL
 =ğ
¡r
) {

3617 
»t
 +ğ0 <ğ
	`bassignblk
 (
NULL
, "test", 4);

3618 
	`debug
 (".\tbassignblk (b = %s, NULL, 1)", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")));

3619 
»t
 +ğ0 <ğ(
v
 = 
	`bassignblk
 (
b
, 
NULL
, 1));

3620 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3621 
»t
 +ğ0 <ğ
	`bassignblk
 (&
shÜtB¡ršg
, 
NULL
, 1);

3622 
	`bde¡roy
 (
b
);

3623  
»t
;

3626 
Ën
 = (è
	`¡¾’
 (
¡r
);

3627 
»t
 +ğ0 <ğ
	`bassignblk
 (
NULL
, 
¡r
, 
Ën
);

3628 
	`debug
 (".\tbassignblk (b = %s, \"%s\", %d)", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")), 
¡r
, 
Ën
);

3629 
»t
 +ğ0 > (
v
 = 
	`bassignblk
 (
b
, 
¡r
, 
Ën
));

3630 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3631 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), 
¡r
);

3632 
»t
 +ğ
b
->
¦’
 !ğ
Ën
;

3633 
»t
 +ğ0 > 
	`bassignc¡r
 (
b
, "xxxxx");

3634 
	`bwr™•rÙeù
(*
b
)

3635 
	`debug
 (".\tbassignblk (b = %s, \"%s\", %d)", 
	`dumpB¡ršg
 (
b
), 
¡r
, 
Ën
);

3636 
»t
 +ğ0 <ğ(
v
 = 
	`bassignblk
 (
b
, 
¡r
, 
Ën
));

3637 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3638 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), "xxxxx");

3639 
»t
 +ğ((
size_t
è
b
->
¦’
è!ğ
	`¡¾’
 ("xxxxx");

3640 
	`bwr™—Îow
(*
b
)

3641 
»t
 +ğ0 <ğ
	`bassignblk
 (&
shÜtB¡ršg
, 
¡r
, 
Ën
);

3642 
	`bde¡roy
 (
b
);

3643 
	`debug
 (".\tbassignblk (¨ğ%s, \"%s\", %d)", 
	`dumpB¡ršg
 (&
shÜtB¡ršg
), 
¡r
, 
Ën
);

3644 
»t
 +ğ0 <ğ(
v
 = 
	`bassignblk
 (&
shÜtB¡ršg
, 
¡r
, 
Ën
));

3645 
	`debug
 (" = %d;‡ -> %s", 
v
, 
	`dumpB¡ršg
 (&
shÜtB¡ršg
));

3646  
»t
;

3647 
	}
}

3649 
	$‹¡45
 () {

3650 
»t
 = 0;

3652 
	`debug
 ("TEST: int bassignblk (bstring‡, const void * s, int†en);");

3655 
»t
 +ğ
	`‹¡45_0
 (
NULL
);

3657 
»t
 +ğ
	`‹¡45_0
 (
EMPTY_STRING
);

3658 
»t
 +ğ
	`‹¡45_0
 (
SHORT_STRING
);

3659 
»t
 +ğ
	`‹¡45_0
 (
LONG_STRING
);

3661 
	`debug
 ("\t# fau»s: %d", 
»t
);

3662  
»t
;

3663 
	}
}

3665 
	$‹¡46_0
 (
cÚ¡_b¡ršg
 
r
, 
b¡ršg
 
b
, 
couÁ
, cÚ¡ * 
fmt
, ...) {

3666 
»t
;

3667 
va_li¡
 
¬gli¡
;

3669 
	`debug
 (".\tbvcfÜm©¨(%s, %d, \"%s\", ...è-> ", 
	`dumpB¡ršg
 (
b
), 
couÁ
, 
fmt
);

3670 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

3671 
»t
 = 
	`bvcfÜm©a
 (
b
, 
couÁ
, 
fmt
, 
¬gli¡
);

3672 
	`va_’d
 (
¬gli¡
);

3673 
	`debug
 ("%d, % (%s)", 
»t
, 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3674 ià(
»t
 < 0è (
NULL
 !ğ
r
);

3675 
»t
 +ğ1 !ğ
	`bi£q
 (
r
, 
b
);

3676 ià(0 !ğ
»t
è
	`debug
 ("\t->failed");

3677  
»t
;

3678 
	}
}

3680 
	$‹¡46_1
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, 
cÚ¡_b¡ršg
 
r
, ...) {

3681 
»t
;

3683 
	`debug
 (".\tbvfÜm©¨(&, %s, \"%s\", ...è-> ", 
	`dumpB¡ršg
 (
b
), 
fmt
);

3684 
	`bvfÜm©a
 (
»t
, 
b
, 
fmt
, 
r
);

3685 
	`debug
 ("%d, % (%s)", 
»t
, 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3686 ià(
»t
 < 0è (
NULL
 !ğ
r
);

3687 
»t
 +ğ1 !ğ
	`bi£q
 (
r
, 
b
);

3688 ià(0 !ğ
»t
è
	`debug
 ("\t->failed");

3689  
»t
;

3690 
	}
}

3692 
	$‹¡46
 () {

3693 
b¡ršg
 
b
;

3694 
»t
 = 0;

3696 
	`debug
 ("TEST: int bvcformata (bstring b, int count, const char * fmt, va_list‡rg);");

3698 
»t
 +ğ
	`‹¡46_0
 (
NULL
, NULL, 8, "[%d]", 15);

3699 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
shÜtB¡ršg
, 8, "[%d]", 15);

3700 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
badB¡ršg1
, 8, "[%d]", 15);

3701 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
badB¡ršg2
, 8, "[%d]", 15);

3702 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
badB¡ršg3
, 8, "[%d]", 15);

3704 
b
 = 
	`bäomc¡r
 ("");

3705 
»t
 +ğ
	`‹¡46_0
 (&
shÜtB¡ršg
, 
b
, shÜtB¡ršg.
¦’
, "%s", (*èshÜtB¡ršg.
d©a
);

3706 
b
->
¦’
 = 0;

3707 
»t
 +ğ
	`‹¡46_0
 (&
shÜtB¡ršg
, 
b
, shÜtB¡ršg.
¦’
 + 1, "%s", (*èshÜtB¡ršg.
d©a
);

3708 
b
->
¦’
 = 0;

3709 
»t
 +ğ
	`‹¡46_0
 (
NULL
, 
b
, 
shÜtB¡ršg
.
¦’
-1, "%s", (*èshÜtB¡ršg.
d©a
);

3711 
	`debug
 ("TEST: bvformata (int &ret, bstring b, const char * fmt, <type>†astarg);");

3713 
»t
 +ğ
	`‹¡46_1
 (
NULL
, "[%d]", NULL, 15);

3714 
»t
 +ğ
	`‹¡46_1
 (&
shÜtB¡ršg
, "[%d]", 
NULL
, 15);

3715 
»t
 +ğ
	`‹¡46_1
 (&
badB¡ršg1
, "[%d]", 
NULL
, 15);

3716 
»t
 +ğ
	`‹¡46_1
 (&
badB¡ršg2
, "[%d]", 
NULL
, 15);

3717 
»t
 +ğ
	`‹¡46_1
 (&
badB¡ršg3
, "[%d]", 
NULL
, 15);

3719 
b
->
¦’
 = 0;

3720 
»t
 +ğ
	`‹¡46_1
 (
b
, "%s", &
shÜtB¡ršg
, (*èshÜtB¡ršg.
d©a
);

3722 
b
->
¦’
 = 0;

3723 
»t
 +ğ
	`‹¡46_1
 (
b
, "%s", &
lÚgB¡ršg
, (*èlÚgB¡ršg.
d©a
);

3725 
	`bde¡roy
 (
b
);

3726 
	`debug
 ("\t# fau»s: %d", 
»t
);

3727  
»t
;

3728 
	}
}

3730 
	$skmaš
 (
¬gc
, * 
¬gv
[])

3732 
FILE
 *
log_fe
 = 
	`fİ’
("tests/tests.log", "a+");

3733 
	`£tbuf
(
log_fe
, 
NULL
);

3734 
	`dbg_£t_log
(
log_fe
);

3736 
»t
 = 0;

3738 
¬gc
 =‡rgc;

3739 
¬gv
 =‡rgv;

3741 
	`debug
 ("Direct caseesting of bstring core functions");

3743 
»t
 +ğ
	`‹¡0
 ();

3744 
»t
 +ğ
	`‹¡1
 ();

3745 
»t
 +ğ
	`‹¡2
 ();

3746 
»t
 +ğ
	`‹¡3
 ();

3747 
»t
 +ğ
	`‹¡4
 ();

3748 
»t
 +ğ
	`‹¡5
 ();

3749 
»t
 +ğ
	`‹¡6
 ();

3750 
»t
 +ğ
	`‹¡7
 ();

3751 
»t
 +ğ
	`‹¡8
 ();

3752 
»t
 +ğ
	`‹¡9
 ();

3753 
»t
 +ğ
	`‹¡10
 ();

3754 
»t
 +ğ
	`‹¡11
 ();

3755 
»t
 +ğ
	`‹¡12
 ();

3756 
»t
 +ğ
	`‹¡13
 ();

3757 
»t
 +ğ
	`‹¡14
 ();

3758 
»t
 +ğ
	`‹¡15
 ();

3759 
»t
 +ğ
	`‹¡16
 ();

3760 
»t
 +ğ
	`‹¡17
 ();

3761 
»t
 +ğ
	`‹¡18
 ();

3762 
»t
 +ğ
	`‹¡19
 ();

3763 
»t
 +ğ
	`‹¡20
 ();

3764 
»t
 +ğ
	`‹¡21
 ();

3765 
»t
 +ğ
	`‹¡22
 ();

3766 
»t
 +ğ
	`‹¡23
 ();

3767 
»t
 +ğ
	`‹¡24
 ();

3768 
»t
 +ğ
	`‹¡25
 ();

3769 
»t
 +ğ
	`‹¡26
 ();

3770 
»t
 +ğ
	`‹¡27
 ();

3771 
»t
 +ğ
	`‹¡28
 ();

3772 
»t
 +ğ
	`‹¡29
 ();

3773 
»t
 +ğ
	`‹¡30
 ();

3774 
»t
 +ğ
	`‹¡31
 ();

3775 
»t
 +ğ
	`‹¡32
 ();

3776 
»t
 +ğ
	`‹¡33
 ();

3777 
»t
 +ğ
	`‹¡34
 ();

3778 
»t
 +ğ
	`‹¡35
 ();

3779 
»t
 +ğ
	`‹¡36
 ();

3780 
»t
 +ğ
	`‹¡37
 ();

3781 
»t
 +ğ
	`‹¡38
 ();

3782 
»t
 +ğ
	`‹¡39
 ();

3783 
»t
 +ğ
	`‹¡40
 ();

3784 
»t
 +ğ
	`‹¡41
 ();

3785 
»t
 +ğ
	`‹¡42
 ();

3786 
»t
 +ğ
	`‹¡43
 ();

3787 
»t
 +ğ
	`‹¡44
 ();

3788 
»t
 +ğ
	`‹¡45
 ();

3789 
»t
 +ğ
	`‹¡46
 ();

3791 
	`debug
 ("#e¡ b¡¸çu»s: %d", 
»t
);

3793 
	`debug
 ("Direct caseesting of bstraux functions");

3795 
»t
 +ğ
	`‹¡aux0
 ();

3796 
»t
 +ğ
	`‹¡aux1
 ();

3797 
»t
 +ğ
	`‹¡aux2
 ();

3798 
»t
 +ğ
	`‹¡aux3
 ();

3799 
»t
 +ğ
	`‹¡aux4
 ();

3800 
»t
 +ğ
	`‹¡aux5
 ();

3801 
»t
 +ğ
	`‹¡aux6
 ();

3802 
»t
 +ğ
	`‹¡aux7
 ();

3803 
»t
 +ğ
	`‹¡aux8
 ();

3804 
»t
 +ğ
	`‹¡aux9
 ();

3805 
»t
 +ğ
	`‹¡aux10
 ();

3806 
»t
 +ğ
	`‹¡aux11
 ();

3807 
»t
 +ğ
	`‹¡aux12
 ();

3809 if(
»t
 > 0) {

3810 
	`´štf
("FAILED: %d fau» š b¡¾ib", 
»t
);

3813 
	`debug
 ("#e¡‡ux fau»s: %d", 
»t
);

3815  
»t
;

3816 
	}
}

	@tests/cache_tests.c

1 
	~"mšun™.h
"

2 
	~<ÿche.h
>

3 
	~<as£¹.h
>

5 
	gÏ¡_eviùed
;

6 
	$‹¡_eviù
(*
d©a
) {

7 
Ï¡_eviùed
 = (è
d©a
;

8 
	}
}

10 
	$‹¡_lookup
(*
d©a
, *
key
) {

11  
d©a
 =ğ
key
;

12 
	}
}

14 *
	$‹¡_ÿche_eviù
()

16 
Ï¡_eviùed
 = -1;

18 
Cache
 *
ÿche
 = 
	`Cache_ü—‹
(
MIN_CACHE_SIZE
, 
‹¡_lookup
, 
‹¡_eviù
);

19 
	`mu_as£¹
(
ÿche
 !ğ
NULL
, "Failedo create cache");

21 
i
;

22 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

23 
	`Cache_add
(
ÿche
, (*è
i
);

24 
	`mu_as£¹
(
Ï¡_eviùed
 == -1, "Evicted somethingooƒarly");

27 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

28 
	`Cache_add
(
ÿche
, (*è
i
 + 
MIN_CACHE_SIZE
);

29 
	`mu_as£¹
(
Ï¡_eviùed
 =ğ
i
, "Evicted something out of order");

32 
	`Cache_de¡roy
(
ÿche
);

33  
NULL
;

34 
	}
}

36 *
	$‹¡_ÿche_mªu®_eviù
()

38 
Ï¡_eviùed
 = -1;

40 
Cache
 *
ÿche
 = 
	`Cache_ü—‹
(
MIN_CACHE_SIZE
, 
‹¡_lookup
, 
‹¡_eviù
);

41 
	`mu_as£¹
(
ÿche
 !ğ
NULL
, "Failedo create cache");

43 
i
;

44 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

45 
	`Cache_add
(
ÿche
, (*è
i
);

46 
	`mu_as£¹
(
Ï¡_eviùed
 == -1, "Evicted somethingooƒarly");

50 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

51 
	`Cache_eviù_objeù
(
ÿche
, (*è
i
);

52 
	`mu_as£¹
(
Ï¡_eviùed
 =ğ
i
, "Evicted something out of order");

55 
Ï¡_eviùed
 = -1;

56 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

57 
	`Cache_add
(
ÿche
, (*è
i
);

58 
	`mu_as£¹
(
Ï¡_eviùed
 == -1, "The cache wasn'tƒmpty'");

61 
	`Cache_de¡roy
(
ÿche
);

62  
NULL
;

63 
	}
}

65 *
	$‹¡_ÿche_lookup
()

67 
Cache
 *
ÿche
 = 
	`Cache_ü—‹
(
MIN_CACHE_SIZE
, 
‹¡_lookup
, 
‹¡_eviù
);

68 
	`mu_as£¹
(
ÿche
 !ğ
NULL
, "Failedo create cache");

69 
™em
;

71 
i
;

72 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

73 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
i
);

74 
	`mu_as£¹
(
™em
 == 0, "Found somethinghat wasn'there");

77 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++è
	`Cache_add
(
ÿche
, (*) i);

79 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

80 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
i
);

81 
	`mu_as£¹
(
™em
 =ğ
i
, "Did‚ot find somethinghat should behere");

84 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++è
	`Cache_add
(
ÿche
, (*) (i * 2));

86 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

87 
f
 = 
i
 * 2;

88 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
f
);

89 
	`mu_as£¹
(
™em
 =ğ
f
, "Did‚ot find somethinghat should behere");

90 
nf
 = 
f
 - 1;

91 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
nf
);

92 
	`mu_as£¹
(
™em
 == 0, "Found somethinghat wasn'there");

95 
	`Cache_de¡roy
(
ÿche
);

97  
NULL
;

98 
	}
}

100 *
	$®l_‹¡s
() {

101 
	`mu_su™e_¡¬t
();

103 
	`mu_run_‹¡
(
‹¡_ÿche_eviù
);

104 
	`mu_run_‹¡
(
‹¡_ÿche_mªu®_eviù
);

105 
	`mu_run_‹¡
(
‹¡_ÿche_lookup
);

107  
NULL
;

108 
	}
}

110 
RUN_TESTS
(
®l_‹¡s
);

	@tests/config_tests.c

1 
	~"mšun™.h
"

2 
	~<zmq.h
>

3 
	~"£rv”.h
"

4 
	~"cÚfig/cÚfig.h
"

5 
	~"cÚfig/db.h
"

6 
	~"cÚfig/moduË.h
"

7 
	~"mime.h
"

8 
	~"£‰šg.h
"

10 *
	$‹¡_CÚfig_lßd_£‰šgs
()

12 
	`CÚfig_š™_db
("tests/config.sqlite");

14 
rc
 = 
	`CÚfig_lßd_£‰šgs
();

15 
	`debug
("LOADED %d SETTINGS", 
rc
);

16 
	`mu_as£¹
(
rc
 > 0, "Failedo†oadhe„ight‚umber of settings.");

18 
	`CÚfig_şo£_db
();

19 
	`S‘tšg_de¡roy
();

21  
NULL
;

22 
	}
}

24 
gb¡ršg
 
	gTEST_MIME
 = 
bsStic
("/test.txt");

26 *
	$‹¡_CÚfig_lßd_mim‘y³s
()

28 
	`CÚfig_š™_db
("tests/config.sqlite");

30 
rc
 = 
	`CÚfig_lßd_mim‘y³s
();

31 
	`debug
("LOADED %d MIME TYPES", 
rc
);

32 
	`mu_as£¹
(
rc
 > 2, "Failedo†oadhe„ight‚umber of mimetypes.");

34 
	`mu_as£¹
(
	`MIME_m©ch_ext
(&
TEST_MIME
, 
NULL
) != NULL, "Mime†oad failed.");

35 
	`CÚfig_şo£_db
();

36 
	`MIME_de¡roy
();

37  
NULL
;

38 
	}
}

40 *
	$‹¡_CÚfig_lßd
()

42 
	`CÚfig_š™_db
("tests/config.sqlite");

43 
S”v”
 *
£rv”
 = 
	`CÚfig_lßd_£rv”
("AC1F8236-5919-4696-9D40-0F38DE9E5861");

44 
	`mu_as£¹
(
£rv”
 !ğ
NULL
, "Failedo†oad server");

46 
	`S”v”_de¡roy
(
£rv”
);

47 
	`CÚfig_şo£_db
();

49  
NULL
;

50 
	}
}

52 *
	$‹¡_CÚfig_lßd_moduË
()

54 
rc
 = 
	`CÚfig_moduË_lßd
("tools/config_modules/null.so");

55 
	`mu_as£¹
(
rc
 == 0, "Failedo†oadhe‚ull module.");

57 
rc
 = 
CONFIG_MODULE
.
	`š™
("goodpath");

58 
	`mu_as£¹
(
rc
 == 0, "The‚ull module should fail init.");

60 
rc
 = 
CONFIG_MODULE
.
	`š™
("badpath");

61 
	`mu_as£¹
(
rc
 == -1, "The‚ull module should fail init.");

63  
NULL
;

64 
	}
}

67 * 
	$®l_‹¡s
()

69 
	`mu_su™e_¡¬t
();

71 
	`S”v”_š™
();

73 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd_mim‘y³s
);

74 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd_£‰šgs
);

75 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd
);

76 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd_moduË
);

78 
	`zmq_‹rm
(
ZMQ_CTX
);

80  
NULL
;

81 
	}
}

83 
RUN_TESTS
(
®l_‹¡s
);

	@tests/connection_tests.c

1 
	~"mšun™.h
"

2 
	~<cÚÃùiÚ.h
>

3 
	~<uni¡d.h
>

4 
	~<sys/ty³s.h
>

5 
	~<fú.h
>

6 
	~<zmq.h
>

7 
	~<sk/sk.h
>

8 
	~<dœ.h
>

10 
S”v”
 *
	gSRV
 = 
NULL
;

12 *
	$‹¡_CÚÃùiÚ_ü—‹_de¡roy
()

14 cÚ¡ 
»mÙe
[
IPADDR_SIZE
];

16 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 0, 0, 
»mÙe
);

17 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo create‡ connection.");

18 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

20  
NULL
;

21 
	}
}

23 *
	$‹¡_CÚÃùiÚ_d–iv”
()

25 
b¡ršg
 
t1
;

26 cÚ¡ 
»mÙe
[
IPADDR_SIZE
];

27 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 1, 0, 
»mÙe
);

28 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo create‡ connection.");

30 
rc
 = 
	`CÚÃùiÚ_d–iv”
(
cÚn
, 
t1
 = 
	`bäomc¡r
("TEST"));

32 
	`mu_as£¹
(
rc
 == -1, "Should NOT be‡bleo write.");

34 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

35 
	`bde¡roy
(
t1
);

37  
NULL
;

38 
	}
}

40 
	$‹¡_sk_w™h_§m¶e
(cÚ¡ *
§m¶e_fe
)

42 
	`check
(
SRV
, "Server isn't configured.");

44 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
SRV
, 12, 1400, "127.0.0.1");

45 
	`check
(
cÚn
, "Failedo createhe conn.");

47 
	`£Áš–
("REWRITE NEEDED");

49 
	`CÚÃùiÚ_sk
(
cÚn
);

52 
”rÜ
:

54 
	}
}

56 *
	$‹¡_CÚÃùiÚ_sk
()

68  
NULL
;

69 
	}
}

71 * 
	$®l_‹¡s
() {

72 
	`mu_su™e_¡¬t
();

74 
	`S”v”_š™
();

75 
S”v”
 *
SRV
 = 
	`S”v”_ü—‹
(

76 
	`bäomc¡r
("uuid"),

77 
	`bäomc¡r
("localhost"),

78 
	`bäomc¡r
("0.0.0.0"),

80 
	`bäomc¡r
("chroot"),

81 
	`bäomc¡r
("access_log"),

82 
	`bäomc¡r
("error_log"),

83 
	`bäomc¡r
("pid_file"), 0);

85 
Ho¡
 *
zedshaw_com
 = 
	`Ho¡_ü—‹
(
	`bäomc¡r
("zedshaw.com"), bfromcstr("zedshaw.com"));

87 
	`Ho¡_add_back’d
(
zedshaw_com
, 
	`bäomc¡r
("@ch©"), 
BACKEND_HANDLER
, 
NULL
);

89 
Dœ
 *
‹¡s
 = 
	`Dœ_ü—‹
(

90 
	`bäomc¡r
("tests/"),

91 
	`bäomc¡r
("index.html"),

92 
	`bäomc¡r
("text/plain"),

95 
	`Ho¡_add_back’d
(
zedshaw_com
, 
	`bäomc¡r
("/‹¡s"), 
BACKEND_DIR
, 
‹¡s
);

97 
	`S”v”_£t_deçuÉ_ho¡
(
SRV
, 
zedshaw_com
);

99 
	`mu_run_‹¡
(
‹¡_CÚÃùiÚ_ü—‹_de¡roy
);

100 
	`mu_run_‹¡
(
‹¡_CÚÃùiÚ_d–iv”
);

101 
	`mu_run_‹¡
(
‹¡_CÚÃùiÚ_sk
);

103 
	`S”v”_de¡roy
(
SRV
);

105 
	`Ho¡_de¡roy
(
zedshaw_com
);

106 
	`zmq_‹rm
(
ZMQ_CTX
);

107  
NULL
;

108 
	}
}

110 
RUN_TESTS
(
®l_‹¡s
);

	@tests/darray_tests.c

1 
	~"mšun™.h
"

2 
	~<adt/d¬¿y.h
>

4 *
	$‹¡_d¬¿y_İ”©iÚs
()

6 
d¬¿y_t
 *
¬¿y
 = 
	`d¬¿y_ü—‹
((), 100);

7 
	`mu_as£¹
(
¬¿y
 !ğ
NULL
, "darray_create failed.");

8 
	`mu_as£¹
(
¬¿y
->
cÚ‹Ás
 !ğ
NULL
, "contents‡re wrong in darray");

9 
	`mu_as£¹
(
¬¿y
->
’d
 == 0, "end isn't‡the„ight spot");

10 
	`mu_as£¹
(
¬¿y
->
–em’t_size
 == (), "element size is wrong.");

11 
	`mu_as£¹
(
¬¿y
->
max
 == 100, "wrong max†ength on initial size");

13 *
v®1
 = 
	`d¬¿y_Ãw
(
¬¿y
);

14 
	`mu_as£¹
(
v®1
 !ğ
NULL
, "failedo make‡‚ewƒlement");

16 *
v®2
 = 
	`d¬¿y_Ãw
(
¬¿y
);

17 
	`mu_as£¹
(
v®2
 !ğ
NULL
, "failedo make‡‚ewƒlement");

19 
	`d¬¿y_£t
(
¬¿y
, 0, 
v®1
);

20 
	`d¬¿y_£t
(
¬¿y
, 1, 
v®2
);

22 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 0è=ğ
v®1
, "Wrong first value.");

23 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 1è=ğ
v®2
, "Wrong second value.");

25 *
v®_check
 = 
	`d¬¿y_»move
(
¬¿y
, 0);

26 
	`mu_as£¹
(
v®_check
 !ğ
NULL
, "Should‚ot get NULL.");

27 
	`mu_as£¹
(*
v®_check
 =ğ*
v®1
, "Should gethe first value.");

28 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 0è=ğ
NULL
, "Should be gone.");

29 
	`ä“
(
v®_check
);

31 
v®_check
 = 
	`d¬¿y_»move
(
¬¿y
, 1);

32 
	`mu_as£¹
(
v®_check
 !ğ
NULL
, "Should‚ot get NULL.");

33 
	`mu_as£¹
(*
v®_check
 =ğ*
v®2
, "Should gethe first value.");

34 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 1è=ğ
NULL
, "Should be gone.");

35 
	`ä“
(
v®_check
);

37 
Şd_max
 = 
¬¿y
->
max
;

38 
	`d¬¿y_ex·nd
(
¬¿y
);

39 
	`mu_as£¹
(
¬¿y
->
max
 =ğ
Şd_max
 +‡¼ay->
ex·nd_¿‹
, "Wrong size‡fterƒxpand.");

41 
	`d¬¿y_cÚŒaù
(
¬¿y
);

42 
	`mu_as£¹
(
¬¿y
->
max
 =ğ¬¿y->
ex·nd_¿‹
 + 1, "Should stay‡theƒxpand_rate‡t†east.");

44 
	`d¬¿y_cÚŒaù
(
¬¿y
);

45 
	`mu_as£¹
(
¬¿y
->
max
 =ğ¬¿y->
ex·nd_¿‹
 + 1, "Should stay‡theƒxpand_rate‡t†east.");

47 
i
 = 0;

48 
i
 = 0; i < 1000; i++) {

49 *
v®
 = 
	`d¬¿y_Ãw
(
¬¿y
);

50 *
v®
 = 
i
 * 333;

51 
	`d¬¿y_push
(
¬¿y
, 
v®
);

54 
	`mu_as£¹
(
¬¿y
->
max
 == 1201, "Wrong max size.");

56 
i
 = 999; i > 0; i--) {

57 *
v®
 = 
	`d¬¿y_pİ
(
¬¿y
);

58 
	`mu_as£¹
(
v®
 !ğ
NULL
, "Shouldn't get‡ NULL.");

59 
	`mu_as£¹
(*
v®
 =ğ
i
 * 333, "Wrong value.");

60 
	`ä“
(
v®
);

63 
	`d¬¿y_de¡roy
(
¬¿y
);

65  
NULL
;

66 
	}
}

69 * 
	$®l_‹¡s
() {

70 
	`mu_su™e_¡¬t
();

72 
	`mu_run_‹¡
(
‹¡_d¬¿y_İ”©iÚs
);

74  
NULL
;

75 
	}
}

77 
RUN_TESTS
(
®l_‹¡s
);

	@tests/db_tests.c

1 
	~"mšun™.h
"

2 
	~<cÚfig/db.h
>

3 
	~<dbg.h
>

5 *
	$‹¡_DB_š™
()

7 
	`mu_as£¹
(
	`DB_š™
("tests/empty.sqlite") == 0, "Database init failed.");

9  
NULL
;

10 
	}
}

12 *
	$‹¡_DB_şo£
()

14 
	`DB_şo£
();

16  
NULL
;

17 
	}
}

19 
gb¡ršg
 
	gEMPTY_RESULT
 = 
bsStic
("0:~");

21 
	$check_»suÉ
(
Šs_v®ue_t
 *
»s
, 
b¡ršg
 
ex³ùšg
)

23 *
v®
 = 
NULL
;

24 
size_t
 
Ën
 = 0;

26 
	`check
(
»s
 !ğ
NULL
, "Got NULL for„esult.");

27 
v®
 = 
	`Šs_»nd”
(
»s
, &
Ën
);

28 
	`check
(
v®
 !ğ
NULL
, "Failedo„ender value„esult.");

29 
	`check
(
	`bis¡emeqblk
(
ex³ùšg
, 
v®
, 
Ën
),

31 
	`bd©a
(
ex³ùšg
), ()
Ën
, 
v®
);

33 
	`ä“
(
v®
);

34 
	`Šs_v®ue_de¡roy
(
»s
);

37 
”rÜ
:

38 
	`ä“
(
v®
);

39 
	`Šs_v®ue_de¡roy
(
»s
);

41 
	}
}

43 *
	$‹¡_DB_exec
()

45 
	`DB_š™
("tests/empty.sqlite");

46 
Šs_v®ue_t
 *
»s
 = 
NULL
;

47 
cŞs
 = 0;

48 
rows
 = 0;

50 
»s
 = 
	`DB_exec
("DROP TABLE IF EXISTSesting");

51 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, &
EMPTY_RESULT
), "Dropable failed.");

53 
»s
 = 
	`DB_exec
("CREATE TABLEesting (name TEXT,‡ge INT)");

54 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

55 
	`mu_as£¹
(
rows
 == 0, "Should be 0†ength„esult.");

56 
	`mu_as£¹
(
cŞs
 == 0, "Should be 0 cols‡s well.");

57 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, &
EMPTY_RESULT
), "Createable failed");

59 
»s
 = 
	`DB_exec
("INSERT INTOesting VALUES ('Zed',35)");

60 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, &
EMPTY_RESULT
), "Insert failed");

62 
b¡ršg
 
£Ëù_»suÉ
 = 
	`bäomc¡r
("15:11:3:Zed,2:35#]]");

63 
»s
 = 
	`DB_exec
("SELECT * FROMesting");

64 
	`mu_as£¹
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Wrongype, should get‡†ist from select.");

68 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

69 
	`mu_as£¹
(
rows
 != -1, "Failedo gethe counts ofhe„esult.");

70 
	`mu_as£¹
(
rows
 == 1, "Should get one„ow.");

71 
	`mu_as£¹
(
cŞs
 == 2, "Should getwo cols.");

73 
b¡ršg
 
Çme
 = 
	`DB_g‘_as
(
»s
, 0, 0, 
¡ršg
);

74 
	`mu_as£¹
(
	`bi£qc¡r
(
Çme
, "Zed"), "Wrong value for column 0.");

76 
age
 = 
	`DB_g‘_as
(
»s
, 0, 1, 
numb”
);

77 
	`debug
("GOT AGE: %d", 
age
);

78 
	`mu_as£¹
(
age
 == 35, "Wrong value for column 1.");

81 
i
 = 0;

82 
j
 = 0;

83 
i
 = 0; i < 
rows
; i++) {

84 
j
 = 0; j < 
cŞs
; j++) {

85 
Šs_v®ue_t
 *
–
 = 
	`DB_g‘
(
»s
, 
i
, 
j
);

86 
	`mu_as£¹
(
	`Šs_g‘_ty³
(
–
è!ğ
Šs_g_šv®id
, "Value should‚ot be invalid(NULL)");

91 
	`mu_as£¹
(
	`DB_g‘
(
»s
, 100, 0è=ğ
NULL
, "Should‚ot work with insane„ows.");

92 
	`mu_as£¹
(
	`DB_g‘
(
»s
, 0, 100è=ğ
NULL
, "Should‚ot work with insane cols.");

93 
	`mu_as£¹
(
	`DB_g‘
(
»s
, 32, 87è=ğ
NULL
, "Should‚ot work with insane cols‡nd„ows.");

95 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, 
£Ëù_»suÉ
), "Select failed.");

96 
	`bde¡roy
(
£Ëù_»suÉ
);

99 
	`mu_as£¹
(
	`DB_couÁs
(
NULL
, &
cŞs
) == -1, "Should‡bort on NULL.");

100 
	`mu_as£¹
(
	`DB_g‘
(
NULL
, 0, 0) == NULL, "Should‡bort on NULL.");

102  
NULL
;

103 
	}
}

105 * 
	$®l_‹¡s
() {

106 
	`mu_su™e_¡¬t
();

108 
	`mu_run_‹¡
(
‹¡_DB_š™
);

109 
	`mu_run_‹¡
(
‹¡_DB_şo£
);

110 
	`mu_run_‹¡
(
‹¡_DB_exec
);

112 
	`DB_şo£
();

114  
NULL
;

115 
	}
}

117 
RUN_TESTS
(
®l_‹¡s
);

	@tests/dict_tests.c

1 
	~"mšun™.h
"

2 
	~<»gi¡”.h
>

3 
	~<adt/diù.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<ùy³.h
>

7 
	~<¡dlib.h
>

8 
	~<¡d¬g.h
>

10 
	tšput_t
[256];

12 
	$tok’ize
(*
¡ršg
, ...)

14 **
tok±r
;

15 
va_li¡
 
¬gli¡
;

16 
tokcouÁ
 = 0;

18 
	`va_¡¬t
(
¬gli¡
, 
¡ršg
);

19 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

20 
tok±r
) {

21 *
¡ršg
 && 
	`is¥aû
(() *string))

22 
¡ršg
++;

23 ià(!*
¡ršg
)

25 *
tok±r
 = 
¡ršg
;

26 *
¡ršg
 && !
	`is¥aû
(() *string))

27 
¡ršg
++;

28 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

29 
tokcouÁ
++;

30 ià(!*
¡ršg
)

32 *
¡ršg
++ = 0;

34 
	`va_’d
(
¬gli¡
);

36  
tokcouÁ
;

37 
	}
}

39 
	$com·»f
(cÚ¡ *
key1
, cÚ¡ *
key2
)

41  
	`¡rcmp
(
key1
, 
key2
);

42 
	}
}

44 *
	$dup¡ršg
(*
¡r
)

46 
sz
 = 
	`¡¾’
(
¡r
) + 1;

47 *
Ãw
 = 
	`m®loc
(
sz
);

48 ià(
Ãw
)

49 
	`memıy
(
Ãw
, 
¡r
, 
sz
);

50  
Ãw
;

51 
	}
}

53 
dnode_t
 *
	$Ãw_node
(*
c
)

55 
dnode_t
 
ãw
[5];

56 
couÁ
;

58 ià(
couÁ
 < 5)

59  
ãw
 + 
couÁ
++;

61  
NULL
;

62 
	}
}

64 
	$d–_node
(
dnode_t
 *
n
, *
c
)

66 
	}
}

68 
	g´om±
 = 0;

70 
	$cÚ¡ruù
(
diù_t
 *
d
)

72 
šput_t
 
š
;

73 
dÚe
 = 0;

74 
diù_lßd_t
 
dl
;

75 
dnode_t
 *
dn
;

76 *
tok1
, *
tok2
, *
v®
;

77 cÚ¡ *
key
;

78 *
h–p
 =

83 ià(!
	`diù_i£m±y
(
d
))

84 
	`puts
("warning: dictionary‚otƒmpty!");

86 
	`diù_lßd_begš
(&
dl
, 
d
);

88 !
dÚe
) {

89 ià(
´om±
)

90 
	`putch¬
('>');

91 
	`fæush
(
¡dout
);

93 ià(!
	`fg‘s
(
š
, (
šput_t
), 
¡dš
))

96 
š
[0]) {

98 
	`puts
(
h–p
);

101 
´om±
 = 1;

104 
dÚe
 = 1;

107 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

108 
	`puts
("what?");

111 
key
 = 
	`dup¡ršg
(
tok1
);

112 
v®
 = 
	`dup¡ršg
(
tok2
);

113 
dn
 = 
	`dnode_ü—‹
(
v®
);

115 ià(!
key
 || !
v®
 || !
dn
) {

116 
	`puts
("out of memory");

117 
	`ä“
((*è
key
);

118 
	`ä“
(
v®
);

119 ià(
dn
)

120 
	`dnode_de¡roy
(
dn
);

123 
	`diù_lßd_Ãxt
(&
dl
, 
dn
, 
key
);

126 
	`putch¬
('?');

127 
	`putch¬
('\n');

132 
	`diù_lßd_’d
(&
dl
);

133 
	}
}

135 *
	$‹¡_diù_İ”©iÚs
()

137 
šput_t
 
š
;

138 
diù_t
 
d¬¿y
[10];

139 
diù_t
 *
d
 = &
d¬¿y
[0];

140 
dnode_t
 *
dn
;

141 
i
;

142 *
tok1
, *
tok2
, *
v®
;

143 cÚ¡ *
key
;

144 
FILE
 *
d©a
 = 
	`fİ’
("tests/adt_data.txt", "r");

145 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Couldn't†oadest data.");

147 *
h–p
 =

164 
i
 = 0; i <  
d¬¿y
 /  *darray; i++)

165 
	`diù_š™
(&
d¬¿y
[
i
], 
DICTCOUNT_T_MAX
, 
com·»f
);

168 ià(
´om±
)

169 
	`putch¬
('>');

170 
	`fæush
(
¡dout
);

172 ià(!
	`fg‘s
(
š
, (
šput_t
), 
d©a
))

175 
š
[0]) {

177 
	`puts
(
h–p
);

180 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

181 
	`puts
("what?");

184 
key
 = 
	`dup¡ršg
(
tok1
);

185 
v®
 = 
	`dup¡ršg
(
tok2
);

187 ià(!
key
 || !
v®
) {

188 
	`puts
("out of memory");

189 
	`ä“
((*è
key
);

190 
	`ä“
(
v®
);

193 ià(!
	`diù_®loc_š£¹
(
d
, 
key
, 
v®
)) {

194 
	`puts
("dict_alloc_insert failed");

195 
	`ä“
((*è
key
);

196 
	`ä“
(
v®
);

201 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

202 
	`puts
("what?");

205 
dn
 = 
	`diù_lookup
(
d
, 
tok1
);

206 ià(!
dn
) {

209 
v®
 = 
	`dnode_g‘
(
dn
);

210 
key
 = 
	`dnode_g‘key
(
dn
);

211 
	`diù_d–‘e_ä“
(
d
, 
dn
);

213 
	`ä“
(
v®
);

214 
	`ä“
((*è
key
);

217 
	`diù_ä“
(
d
);

222 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

223 
	`puts
("what?");

226 
dn
 = 0;

227 
š
[0]) {

229 
dn
 = 
	`diù_lookup
(
d
, 
tok1
);

232 
dn
 = 
	`diù_low”_bound
(
d
, 
tok1
);

235 
dn
 = 
	`diù_uµ”_bound
(
d
, 
tok1
);

238 ià(!
dn
) {

241 
v®
 = 
	`dnode_g‘
(
dn
);

242 
	`puts
(
v®
);

245 
	`cÚ¡ruù
(
d
);

248 
	`diù_®low_du³s
(
d
);

251 
	`´štf
("%lu\n", (è
	`diù_couÁ
(
d
));

254 
dn
 = 
	`diù_fœ¡
(
d
); dn; dÀğ
	`diù_Ãxt
(d, dn)) {

255 
	`mu_as£¹
(
	`dnode_g‘key
(
dn
è!ğ
NULL
, "invalid key");

256 
	`mu_as£¹
(
	`dnode_g‘
(
dn
è!ğ
NULL
, "invalid value");

260  
NULL
;

265 
´om±
 = 1;

268 
	`diù_£t_®loÿtÜ
(
d
, 
Ãw_node
, 
d–_node
, 
NULL
);

271 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

272 
	`puts
("what?");

275 
diùnum
 = 
	`©oi
(
tok1
);

276 ià(
diùnum
 < 0 || dictnum > 9) {

277 
	`puts
("invalid‚umber");

280 
d
 = &
d¬¿y
[
diùnum
];

284 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

285 
	`puts
("what?");

288 
diù1
 = 
	`©oi
(
tok1
), 
diù2
 =‡toi(
tok2
);

289 ià(
diù1
 < 0 || diù1 > 9 || 
diù2
 < 0 || dict2 > 9) {

290 
	`puts
("invalid‚umber");

293 
	`diù_m”ge
(&
d¬¿y
[
diù1
], &d¬¿y[
diù2
]);

297 
	`putch¬
('?');

298 
	`putch¬
('\n');

303 
	`mu_as£¹
(
	`diù_v”ify
(
d
), "Dict became invalid.");

305  
NULL
;

306 
	}
}

308 * 
	$®l_‹¡s
() {

309 
	`mu_su™e_¡¬t
();

311 
	`mu_run_‹¡
(
‹¡_diù_İ”©iÚs
);

313  
NULL
;

314 
	}
}

316 
RUN_TESTS
(
®l_‹¡s
);

	@tests/dir_tests.c

1 
	~"mšun™.h
"

2 
	~"dœ.h
"

3 
	~"»gi¡”.h
"

4 
	~<¡ršg.h
>

5 
	~<fú.h
>

7 *
	$‹¡_Dœ_fšd_fe
()

9 
b¡ršg
 
ùy³
 = 
NULL
;

11 
FeRecÜd
 *
fe
 = 
	`Dœ_fšd_fe
(
	`bäomc¡r
("tests/sample.json"),

12 
ùy³
 = 
	`bäomc¡r
("text/plain"));

14 
	`mu_as£¹
(
fe
 !ğ
NULL
, "Failedo findhe file.");

16 
	`FeRecÜd_de¡roy
(
fe
);

17 
	`bde¡roy
(
ùy³
);

19  
NULL
;

20 
	}
}

22 *
	$‹¡_Dœ_fšd_fe_isdœ
(){

24 
b¡ršg
 
ùy³
 = 
NULL
;

26 
FeRecÜd
 *
fe
 = 
	`Dœ_fšd_fe
(
	`bäomc¡r
("tests/"),

27 
ùy³
 = 
	`bäomc¡r
("text/plain"));

29 
	`mu_as£¹
(
fe
 !ğ
NULL
, "Failedo findhe directory.");

30 
	`mu_as£¹
(
fe
->
is_dœ
 == 1, "Did‚ot„ecognized it's‡ directory");

32 
	`FeRecÜd_de¡roy
(
fe
);

33 
	`bde¡roy
(
ùy³
);

36  
NULL
;

37 
	}
}

40 *
	$‹¡_Dœ_»sŞve_fe
()

42 
Dœ
 *
‹¡
 = 
	`Dœ_ü—‹
(

43 
	`bäomc¡r
("tests/"),

44 
	`bäomc¡r
("sample.html"),

45 
	`bäomc¡r
("test/plain"),

47 
	`mu_as£¹
(
‹¡
 !ğ
NULL
, "Failedo makeest dir.");

49 
FeRecÜd
 *
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/sample.json"));

50 
	`mu_as£¹
(
»c
 !ğ
NULL
, "Failedo„esolve filehat should behere.");

52 
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/"));

53 
	`mu_as£¹
(
»c
 !ğ
NULL
, "Failedo find default file.");

55 
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/../../../../../etc/passwd"));

56 
	`mu_as£¹
(
»c
 =ğ
NULL
, "HACK! should‚ot findhis.");

58 
	`Dœ_de¡roy
(
‹¡
);

60 
‹¡
 = 
	`Dœ_ü—‹
(

61 
	`bäomc¡r
("foobar/"),

62 
	`bäomc¡r
("sample.html"),

63 
	`bäomc¡r
("test/plan"),

65 
	`mu_as£¹
(
‹¡
 !ğ
NULL
, "Failedo makehe failed dir.");

67 
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/sample.json"));

68 
	`mu_as£¹
(
»c
 =ğ
NULL
, "Should‚ot get something from‡ bad base directory.");

70 
	`Dœ_de¡roy
(
‹¡
);

72  
NULL
;

73 
	}
}

75 cÚ¡ *
	gREQ_PATTERN
 = "%s %s HTTP/1.1\r\n\r\n";

77 
Reque¡
 *
	$çke_»q
(cÚ¡ *
m‘hod
, cÚ¡ *
´efix
, cÚ¡ *
·th
)

79 
rc
 = 0;

80 
size_t
 
Å¬£d
 = 0;

81 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

82 
	`Reque¡_¡¬t
(
»q
);

84 
b¡ršg
 
p
 = 
	`bäomc¡r
(
·th
);

85 
b¡ršg
 
½
 = 
	`bfÜm©
(
REQ_PATTERN
, 
m‘hod
, 
	`bd©a
(
p
));

87 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
½
), 
	`bËngth
Ôp), &
Å¬£d
);

88 
»q
->
´efix
 = 
	`bäomc¡r
(prefix);

89 
»q
->
·‰”n
 = 
	`bäomc¡r
(
´efix
);

91 
	`check
(
rc
 != 0, "Failedo…arse„equest.");

92 
	`check
(
Å¬£d
 =ğ
	`bËngth
(
½
), "Failedo…arse‡ll of„equest.");

94  
»q
;

96 
”rÜ
:

97  
NULL
;

98 
	}
}

101 *
	$‹¡_Dœ_£rve_fe
()

103 
rc
 = 0;

104 
Reque¡
 *
»q
 = 
NULL
;

106 
Dœ
 *
‹¡
 = 
	`Dœ_ü—‹
(

107 
	`bäomc¡r
("tests/"),

108 
	`bäomc¡r
("sample.html"),

109 
	`bäomc¡r
("test/plain"),

112 
CÚÃùiÚ
 
cÚn
 = {.
iob
 = 
NULL
};

113 
z”o_fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

114 
cÚn
.
iob
 = 
	`IOBuf_ü—‹
(1024, 
z”o_fd
, 
IOBUF_NULL
);

116 
»q
 = 
	`çke_»q
("GET", "/", "/sample.json");

117 
rc
 = 
	`Dœ_£rve_fe
(
‹¡
, 
»q
, &
cÚn
);

121 
»q
 = 
	`çke_»q
("HEAD", "/", "/sample.json");

122 
rc
 = 
	`Dœ_£rve_fe
(
‹¡
, 
»q
, &
cÚn
);

123 
	`mu_as£¹
(
rc
 == 0, "Should servehe HEAD of /sample.json");

125 
»q
 = 
	`çke_»q
("POST", "/", "/sample.json");

126 
rc
 = 
	`Dœ_£rve_fe
(
‹¡
, 
»q
, &
cÚn
);

127 
	`mu_as£¹
(
rc
 == -1, "POST should…asshrough but send‡nƒrror.");

129  
NULL
;

130 
	}
}

132 *
	$‹¡_Dœ_£rve_big_fes
(){

134 
¡©
 
Ëss1gb
;

135 
Ëss1gb
.
¡_size
 = 858993459;

137 
¡©
 
mÜe1gb
;

138 
mÜe1gb
.
¡_size
 = 399560397;

140 *
LESS_1GB
 = "HTTP/1.1 200 OK\r\n"

146 "S”v”: " 
VERSION


149 *
MORE_1GB
 = "HTTP/1.1 200 OK\r\n"

155 "S”v”: " 
VERSION


158 
b¡ršg
 
»¥Ú£_Ëss_1gb
 = 
	`bfÜm©
(
RESPONSE_FORMAT
, "", "", 
Ëss1gb
.
¡_size
, "", "");

159 
b¡ršg
 
»¥Ú£_mÜe_1gb
 = 
	`bfÜm©
(
RESPONSE_FORMAT
, "", "", 
mÜe1gb
.
¡_size
, "", "");

161 
	`mu_as£¹
(
	`b¡rcmp
(
»¥Ú£_Ëss_1gb
, 
	`bäomc¡r
(
LESS_1GB
)) == 0, "Wrong„esponse headers for <1GB files");

162 
	`debug
("MORE_1GB=%s\n", 
MORE_1GB
);

163 
	`debug
("RESPONSE=%s\n", 
	`bd©a
(
»¥Ú£_mÜe_1gb
));

164 
	`mu_as£¹
(
	`b¡rcmp
(
»¥Ú£_mÜe_1gb
, 
	`bäomc¡r
(
MORE_1GB
)) == 0, "Wrong„esponse headers for >1GB files");

165  
NULL
;

166 
	}
}

168 * 
	$®l_‹¡s
() {

169 
	`mu_su™e_¡¬t
();

170 
	`Regi¡”_š™
();

172 
	`mu_run_‹¡
(
‹¡_Dœ_fšd_fe
);

173 
	`mu_run_‹¡
(
‹¡_Dœ_£rve_fe
);

174 
	`mu_run_‹¡
(
‹¡_Dœ_»sŞve_fe
);

175 
	`mu_run_‹¡
(
‹¡_Dœ_£rve_big_fes
);

176 
	`mu_run_‹¡
(
‹¡_Dœ_fšd_fe_isdœ
);

178  
NULL
;

179 
	}
}

181 
RUN_TESTS
(
®l_‹¡s
);

	@tests/filter_tests.c

1 
	~"mšun™.h
"

2 
	~<f‹r.h
>

3 
	~<cÚÃùiÚ.h
>

5 *
	$‹¡_F‹r_lßd
()

7 
S”v”
 *
¤v
 = 
NULL
;

8 
b¡ršg
 
lßd_·th
 = 
	`bäomc¡r
("tests/filters/test_filter.so");

10 
»s
 = 
	`F‹r_lßd
(
¤v
, 
lßd_·th
);

11 
	`mu_as£¹
(
»s
 == 0, "Failedo†oadests/filters/test_filter.so");

12 
	`mu_as£¹
(
	`F‹r_aùiv©ed
(), "Filters‚ot‡ctivated.");

14  
NULL
;

15 
	}
}

17 *
	$‹¡_F‹r_run
()

19 
Ãxt
 = 
	`F‹r_run
(
HANDLER
, 
NULL
);

20 
	`debug
("HANDLER„‘uºed: %d", 
Ãxt
);

22 
	`mu_as£¹
(
Ãxt
 =ğ
CLOSE
, "Wrongƒvent for callback.");

24 
	`mu_as£¹
(
	`F‹r_run
(
MSG_REQ
, 
NULL
) == MSG_REQ, "Should„eturn same for‚on-registered.");

26  
NULL
;

27 
	}
}

30 *
	$‹¡_F‹r_run_chaš
(){

32 
	`F‹r_š™
();

33 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 0, 80, "");

35 
»s_f‹r_a
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_a.so"));

36 
	`mu_as£¹
(
»s_f‹r_a
 == 0, "Failedo†oadests/filters/test_filter_a.so");

38 
»s_f‹r_b
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_b.so"));

39 
	`mu_as£¹
(
»s_f‹r_b
 == 0, "Failedo†oadests/filters/test_filter_b.so");

41 
	`F‹r_run
(
CONNECT
, 
cÚn
);

44 
	`mu_as£¹
(
cÚn
->
½Üt
 == 90, "Not‡ll filters was„un,„port‚ot correctly changed");

46  
NULL
;

47 
	}
}

49 *
	$‹¡_F‹r_¡İ_f‹r_chaš
(){

50 
	`F‹r_š™
();

51 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 0, 80, "");

53 
»s_f‹r_a
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_a.so"));

54 
	`mu_as£¹
(
»s_f‹r_a
 == 0, "Failedo†oadests/filters/test_filter_a.so");

56 
»s_f‹r_c
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_c.so"));

57 
	`mu_as£¹
(
»s_f‹r_c
 == 0, "Failedo†oadests/filters/test_filter_c.so");

59 
»s_f‹r_b
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_b.so"));

60 
	`mu_as£¹
(
»s_f‹r_b
 == 0, "Failedo†oadests/filters/test_filter_b.so");

62 
Ãxt
 = 
	`F‹r_run
(
CONNECT
, 
cÚn
);

63 
	`mu_as£¹
(
Ãxt
 =ğ
CLOSE
, "Last filter‚ot„un correctly");

66 
	`mu_as£¹
(
cÚn
->
½Üt
 == 87, "Not‡ll filters should be„un");

68  
NULL
;

69 
	}
}

73 * 
	$®l_‹¡s
() {

74 
	`mu_su™e_¡¬t
();

76 
	`mu_run_‹¡
(
‹¡_F‹r_lßd
);

77 
	`mu_run_‹¡
(
‹¡_F‹r_run
);

78 
	`mu_run_‹¡
(
‹¡_F‹r_run_chaš
);

79 
	`mu_run_‹¡
(
‹¡_F‹r_¡İ_f‹r_chaš
);

81  
NULL
;

82 
	}
}

84 
RUN_TESTS
(
®l_‹¡s
);

	@tests/filters/test_filter.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6  
CLOSE
;

7 
	}
}

10 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

12 
S‹Ev’t
 
¡©es
[] = {
HANDLER
};

13 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

14 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

16  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

18 
”rÜ
:

19  
NULL
;

20 
	}
}

	@tests/filters/test_filter_a.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6 
cÚn
->
½Üt
 += 2;

7  
¡©e
;

8 
	}
}

11 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

13 
S‹Ev’t
 
¡©es
[] = {
CONNECT
};

14 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

15 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

17  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

19 
”rÜ
:

20  
NULL
;

21 
	}
}

	@tests/filters/test_filter_b.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6 
cÚn
->
½Üt
 += 8;

7  
¡©e
;

8 
	}
}

11 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

13 
S‹Ev’t
 
¡©es
[] = {
CONNECT
};

14 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

15 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

17  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

19 
”rÜ
:

20  
NULL
;

21 
	}
}

	@tests/filters/test_filter_c.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6 
cÚn
->
½Üt
 += 5;

7  
CLOSE
;

8 
	}
}

11 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

13 
S‹Ev’t
 
¡©es
[] = {
CONNECT
};

14 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

15 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

17  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

19 
”rÜ
:

20  
NULL
;

21 
	}
}

	@tests/handler_parser_tests.c

1 
	~"mšun™.h
"

2 
	~<hªdËr_·r£r.h
>

3 
	~<b¡ršg.h
>

5 
	$‹¡_·r£
(cÚ¡ *
‹¡
, 
rg‘_couÁ
)

7 
HªdËrP¬£r
 *
·r£r
 = 
	`HªdËrP¬£r_ü—‹
(128);

9 
b¡ršg
 
T1
 = 
	`bäomc¡r
(
‹¡
);

11 
rc
 = 
	`HªdËrP¬£r_execu‹
(
·r£r
, 
	`bd©a
(
T1
), 
	`bËngth
(T1));

13 
	`bde¡roy
(
T1
);

15  
rc
 =ğ1 && 
rg‘_couÁ
 =ğ
·r£r
->target_count;

16 
	}
}

18 
	#TEST
(
T
, 
C
, 
M
è
	`mu_as£¹
(
	`‹¡_·r£
(T, Cè=ğ1, "FaedØ·r£: " #M);

	)

19 
	#TEST_FAIL
(
T
, 
C
, 
M
è
	`mu_as£¹
(
	`‹¡_·r£
(T, Cè=ğ0, "SHOULD faØ·r£: " #M);

	)

21 *
	$‹¡_HªdËrP¬£r_execu‹
()

23 
	`TEST
("5a9a6354-fc33-4468-8ccd-5d736737dad7 2:12, The body", 1, "T1");

24 
	`TEST
("5a9a6354-fc33-4468-8ccd-5d736737dad7 11:0 1 2 3 4 5, The body", 6, "T2");

25 
	`TEST
("5a9a6354-fc33-4468-8ccd-5d736737dad7 5:12 34, Another body.", 2, "T3");

26 
	`TEST
("5a9a6354fc3344688ccd5d736737dad7 5:12 34, ", 2, "EMPTY");

28 
	`TEST_FAIL
("this.is.wrong 5:12 34, ", 2, "BAD UUID");

29 
	`TEST_FAIL
("5a9a6354fc3344688ccd5d736737dad7 10:12 34, ", 2, "TOO LONG NETSTRING");

30 
	`TEST_FAIL
("5a9a6354fc3344688ccd5d736737dad7 3:12 34, ", 2, "TOO SHORT NETSTRING");

31 
	`TEST_FAIL
("5a9a6354fc3344688ccd5d736737dad7 5:12 34,", 2, "NO TRAILING SPACE");

32 
	`TEST_FAIL
(" 5:12 34,", 2, "NO UUID");

34  
NULL
;

35 
	}
}

39 * 
	$®l_‹¡s
() {

40 
	`mu_su™e_¡¬t
();

42 
	`mu_run_‹¡
(
‹¡_HªdËrP¬£r_execu‹
);

44  
NULL
;

45 
	}
}

47 
RUN_TESTS
(
®l_‹¡s
);

	@tests/handler_tests.c

2 
	~"mšun™.h
"

3 
	~<hªdËr.h
>

4 
	~<¡ršg.h
>

5 
	~<sk/sk.h
>

8 *
	$‹¡_HªdËr_»cv_ü—‹
()

10 *
sock‘
 = 
	`HªdËr_»cv_ü—‹
("tcp://127.0.0.1:4321", "ZED");

11 
	`mu_as£¹
(
sock‘
 !ğ
NULL
, "Failedo make„ecv socket.");

12 
	`zmq_şo£
(
sock‘
);

13  
NULL
;

14 
	}
}

16 *
	$‹¡_HªdËr_£nd_ü—‹
()

19 *
sock‘
 = 
	`HªdËr_£nd_ü—‹
("tcp://127.0.0.1:12345", "ZED");

20 
	`mu_as£¹
(
sock‘
 !ğ
NULL
, "Failedo makehe send socket.");

22 
	`zmq_şo£
(
sock‘
);

24  
NULL
;

25 
	}
}

27 *
	$‹¡_HªdËr_d–iv”
()

29 *
sock‘
 = 
	`HªdËr_£nd_ü—‹
("tcp://127.0.0.1:12346", "ZED");

30 #ifdeà
ZMQ_LINGER


31 
İt
 = 0;

32 
	`zmq_£tsockİt
(
sock‘
, 
ZMQ_LINGER
, &
İt
, (opt));

35 
	`mu_as£¹
(
sock‘
 !ğ
NULL
, "Failedo makehe send socket.");

37 
b¡ršg
 
mes§ge
 = 
	`bäomc¡r
("{\"type\":\"join\"}");

38 
rc
 = 
	`HªdËr_d–iv”
(
sock‘
, 
	`bd©a
(
mes§ge
), 
	`bËngth
(message));

39 
	`ä“
(
mes§ge
);

41 
	`mu_as£¹
(
rc
 == 0, "Failedo deliverhe message.");

43 
	`zmq_şo£
(
sock‘
);

44  
NULL
;

45 
	}
}

48 *
	$‹¡_HªdËr_ü—‹_de¡roy
()

50 
HªdËr
 *
hªdËr
 = 
	`HªdËr_ü—‹
(

51 
	`bäomc¡r
("tcp://127.0.0.1:12348"),

52 
	`bäomc¡r
("ZED"),

53 
	`bäomc¡r
("tcp://127.0.0.1:4321"),

54 
	`bäomc¡r
("ZED"));

55 
	`mu_as£¹
(
hªdËr
 !ğ
NULL
, "Failedo makehe handler.");

57 
	`HªdËr_de¡roy
(
hªdËr
);

59  
NULL
;

60 
	}
}

62 * 
	$®l_‹¡s
() {

63 
	`mu_su™e_¡¬t
();

64 
	`mqš™
(2);

66 
	`mu_run_‹¡
(
‹¡_HªdËr_£nd_ü—‹
);

67 
	`mu_run_‹¡
(
‹¡_HªdËr_»cv_ü—‹
);

69 
	`mu_run_‹¡
(
‹¡_HªdËr_ü—‹_de¡roy
);

71 
	`zmq_‹rm
(
ZMQ_CTX
);

72  
NULL
;

73 
	}
}

75 
RUN_TESTS
(
®l_‹¡s
);

	@tests/hash_tests.c

1 
	~"mšun™.h
"

2 
	~<»gi¡”.h
>

3 
	~<adt/hash.h
>

5 
	~<¡dio.h
>

6 
	~<ùy³.h
>

7 
	~<¡d¬g.h
>

9 
	tšput_t
[256];

11 
	$tok’ize
(*
¡ršg
, ...)

13 **
tok±r
;

14 
va_li¡
 
¬gli¡
;

15 
tokcouÁ
 = 0;

17 
	`va_¡¬t
(
¬gli¡
, 
¡ršg
);

18 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

19 
tok±r
) {

20 *
¡ršg
 && 
	`is¥aû
(() *string))

21 
¡ršg
++;

22 ià(!*
¡ršg
)

24 *
tok±r
 = 
¡ršg
;

25 *
¡ršg
 && !
	`is¥aû
(() *string))

26 
¡ršg
++;

27 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

28 
tokcouÁ
++;

29 ià(!*
¡ršg
)

31 *
¡ršg
++ = 0;

33 
	`va_’d
(
¬gli¡
);

35  
tokcouÁ
;

36 
	}
}

38 *
	$dup¡ršg
(*
¡r
)

40 
sz
 = 
	`¡¾’
(
¡r
) + 1;

41 *
Ãw
 = 
	`m®loc
(
sz
);

42 ià(
Ãw
)

43 
	`memıy
(
Ãw
, 
¡r
, 
sz
);

44  
Ãw
;

45 
	}
}

47 
hnode_t
 *
	$Ãw_node
(*
c
)

49 
hnode_t
 
ãw
[5];

50 
couÁ
;

52 ià(
couÁ
 < 5)

53  
ãw
 + 
couÁ
++;

55  
NULL
;

56 
	}
}

58 
	$d–_node
(
hnode_t
 *
n
, *
c
)

60 
	}
}

62 *
	$‹¡_hash_İ”©iÚs
()

64 
šput_t
 
š
;

65 
hash_t
 *
h
 = 
	`hash_ü—‹
(
HASHCOUNT_T_MAX
, 0, 0);

66 
hnode_t
 *
hn
;

67 
hsÿn_t
 
hs
;

68 *
tok1
, *
tok2
, *
v®
;

69 cÚ¡ *
key
;

70 
´om±
 = 0;

71 
FILE
 *
d©a
 = 
	`fİ’
("tests/adt_data.txt", "r");

72 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Couldn't†oadest data.");

74 *
h–p
 =

88 ià(!
h
)

89 
	`puts
("hash_create failed");

92 ià(
´om±
)

93 
	`putch¬
('>');

94 
	`fæush
(
¡dout
);

97 ià(!
	`fg‘s
(
š
, (
šput_t
), 
d©a
))

100 
š
[0]) {

102 
	`puts
(
h–p
);

105 
	`´štf
("%d\n", 
hash_v®_t_b™
);

108 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

109 
	`puts
("what?");

112 
key
 = 
	`dup¡ršg
(
tok1
);

113 
v®
 = 
	`dup¡ršg
(
tok2
);

115 ià(!
key
 || !
v®
) {

116 
	`puts
("out of memory");

117 
	`ä“
((*è
key
);

118 
	`ä“
(
v®
);

121 ià(!
	`hash_®loc_š£¹
(
h
, 
key
, 
v®
)) {

122 
	`puts
("hash_alloc_insert failed");

123 
	`ä“
((*è
key
);

124 
	`ä“
(
v®
);

129 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

130 
	`puts
("what?");

133 
hn
 = 
	`hash_lookup
(
h
, 
tok1
);

134 ià(!
hn
) {

137 
v®
 = 
	`hnode_g‘
(
hn
);

138 
key
 = 
	`hnode_g‘key
(
hn
);

139 
	`hash_sÿn_d–ä“
(
h
, 
hn
);

140 
	`ä“
((*è
key
);

141 
	`ä“
(
v®
);

144 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

145 
	`puts
("what?");

148 
hn
 = 
	`hash_lookup
(
h
, 
tok1
);

149 ià(!
hn
) {

152 
v®
 = 
	`hnode_g‘
(
hn
);

153 
	`puts
(
v®
);

156 
	`´štf
("%lu\n", (è
	`hash_size
(
h
));

159 
	`´štf
("%lu\n", (è
	`hash_couÁ
(
h
));

162 
	`hash_sÿn_begš
(&
hs
, 
h
);

163 (
hn
 = 
	`hash_sÿn_Ãxt
(&
hs
))) {

164 
	`mu_as£¹
(
	`hnode_g‘key
(
hn
è!ğ
NULL
, "invalid key");

165 
	`mu_as£¹
(
	`hnode_g‘
(
hn
è!ğ
NULL
, "invalid value");

169  
NULL
;

174 
´om±
 = 1;

177 
	`hash_£t_®loÿtÜ
(
h
, 
Ãw_node
, 
d–_node
, 
NULL
);

180 
	`putch¬
('?');

181 
	`putch¬
('\n');

186 
	`mu_as£¹
(
	`hash_v”ify
(
h
), "Hash became invalid.");

188  
NULL
;

189 
	}
}

191 * 
	$®l_‹¡s
() {

192 
	`mu_su™e_¡¬t
();

194 
	`mu_run_‹¡
(
‹¡_hash_İ”©iÚs
);

196  
NULL
;

197 
	}
}

199 
RUN_TESTS
(
®l_‹¡s
);

	@tests/host_tests.c

1 
	~"mšun™.h
"

2 
	~<ho¡.h
>

4 * 
	$‹¡_ü—‹_de¡roy
() {

5 
Ho¡
 *
ho¡
 = 
	`Ho¡_ü—‹
(
	`bäomc¡r
("zedshaw.com"), bfromcstr("zedshaw.com"));

7 
	`mu_as£¹
(
ho¡
 !ğ
NULL
, "Failedo make host.");

9 
	`Ho¡_de¡roy
(
ho¡
);

11  
NULL
;

12 
	}
}

14 *
	$®l_‹¡s
() {

15 
	`mu_su™e_¡¬t
();

17 
	`mu_run_‹¡
(
‹¡_ü—‹_de¡roy
);

19  
NULL
;

20 
	}
}

22 
RUN_TESTS
(
®l_‹¡s
);

	@tests/http11_tests.c

1 
	~"mšun™.h
"

2 
	~<h‰p11/h‰p11_·r£r.h
>

3 
	~<glob.h
>

4 
	~<b¡ršg.h
>

6 
	$debug_–em’t_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

8 
	}
}

10 
	$debug_f›ld_cb
(*
d©a
, cÚ¡ *
f›ld
, 
size_t
 
æ’
, cÚ¡ *
v®ue
, size_ˆ
vËn
)

12 
	}
}

14 
h‰p_·r£r
 
	$£tup_·r£r
()

16 
h‰p_·r£r
 
p
;

17 
p
.
h‰p_f›ld
 = 
debug_f›ld_cb
;

18 
p
.
»que¡_m‘hod
 = 
debug_–em’t_cb
;

19 
p
.
»que¡_uri
 = 
debug_–em’t_cb
;

20 
p
.
äagm’t
 = 
debug_–em’t_cb
;

21 
p
.
»que¡_·th
 = 
debug_–em’t_cb
;

22 
p
.
qu”y_¡ršg
 = 
debug_–em’t_cb
;

23 
p
.
h‰p_v”siÚ
 = 
debug_–em’t_cb
;

24 
p
.
h—d”_dÚe
 = 
debug_–em’t_cb
;

26 
	`h‰p_·r£r_š™
(&
p
);

28  
p
;

29 
	}
}

31 *
	$‹¡_h‰p11_·r£r_basics
()

33 
h‰p_·r£r
 
p
 = 
	`£tup_·r£r
();

34 
rc
 = 0;

36 
rc
 = 
	`h‰p_·r£r_fšish
(&
p
);

37 
	`mu_as£¹
(
rc
 == 0, "Should NOT be finished if‚othing…arsed.");

39 
rc
 = 
	`h‰p_·r£r_has_”rÜ
(&
p
);

40 
	`mu_as£¹
(
rc
 == 0, "Should‚ot have‡nƒrror‡the beginning.");

42 
rc
 = 
	`h‰p_·r£r_is_fšished
(&
p
);

43 
	`mu_as£¹
(
rc
 == 0, "Should‚ot be finished since‚ever handed‡nything.");

44  
NULL
;

45 
	}
}

47 *
	$‹¡_·r£r_th¿shšg
()

49 
glob_t
 
‹¡_fes
;

50 
i
 = 0;

51 
Å¬£d
 = 0;

52 
d–
 = 0;

53 
‹¡s_run
 = 0;

54 
execs_run
 = 0;

55 
unfšished
 = 0;

56 
”rÜs
 = 0;

58 
rc
 = 
	`glob
("‹¡s/ªd_su™e/*", 0, 
NULL
, &
‹¡_fes
);

59 
	`mu_as£¹
(
rc
 == 0, "Failedo glob file sinests/and_suite/*");

61 
i
 = 0; i < 
‹¡_fes
.
gl_·thc
; i++) {

62 
FILE
 *
šfe
 = 
	`fİ’
(
‹¡_fes
.
gl_·thv
[
i
], "r");

63 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

65 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

66 
	`fşo£
(
šfe
);

67 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

69 
‹¡s_run
++;

71 
h‰p_·r£r
 
p
 = 
	`£tup_·r£r
();

73 
Å¬£d
 = 0;

74 
d–
 = 0;

76 
Å¬£d
 < 
	`bËngth
(
d©a
)) {

77 
	`debug
("jsÚ PARSING: %d oà%d‡ˆ%s", 
Å¬£d
, 
	`bËngth
(
d©a
), 
	`bd©aofs
(data,‚parsed));

79 
d–
 = 
	`h‰p_·r£r_execu‹
(&
p
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
Å¬£d
);

80 
execs_run
++;

82 if(
d–
 == 0) { ; }

84 if(!
	`h‰p_·r£r_fšish
(&
p
)) {

85 
unfšished
++;

88 
Å¬£d
 +ğ
d–
;

90 if(
	`h‰p_·r£r_has_”rÜ
(&
p
)) {

91 
”rÜs
++;

94 
	`debug
("TEST %s„esults: delta %d, has_error: %d, is_finished: %d",

95 
‹¡_fes
.
gl_·thv
[
i
],

96 
Å¬£d
, 
	`h‰p_·r£r_has_”rÜ
(&
p
), 
	`h‰p_·r£r_is_fšished
(&p));

98 
	`h‰p_·r£r_š™
(&
p
);

102 
	`debug
("HTTP PARSING:ests_run: %d,ƒxecs_run: %d, unfinished: %d,ƒrrors: %d",

103 
‹¡s_run
, 
execs_run
, 
unfšished
, 
”rÜs
);

105  
NULL
;

106 
	}
}

109 * 
	$®l_‹¡s
() {

110 
	`mu_su™e_¡¬t
();

112 
	`mu_run_‹¡
(
‹¡_h‰p11_·r£r_basics
);

113 
	`mu_run_‹¡
(
‹¡_·r£r_th¿shšg
);

115  
NULL
;

116 
	}
}

118 
RUN_TESTS
(
®l_‹¡s
);

	@tests/httpclient_tests.c

2 
	~"mšun™.h
"

3 
	~<h‰p11/h‰pş›Á_·r£r.h
>

4 
	~<glob.h
>

5 
	~<b¡ršg.h
>

8 
h‰pş›Á_·r£r
 
	$£tup_·r£r
()

10 
h‰pş›Á_·r£r
 
p
;

11 
	`h‰pş›Á_·r£r_š™
(&
p
);

12 
p
.
h‰p_f›ld
 = 
NULL
;

13 
p
.
»asÚ_ph¿£
 = 
NULL
;

14 
p
.
¡©us_code
 = 
NULL
;

15 
p
.
chunk_size
 = 
NULL
;

16 
p
.
h‰p_v”siÚ
 = 
NULL
;

17 
p
.
h—d”_dÚe
 = 
NULL
;

18 
p
.
Ï¡_chunk
 = 
NULL
;

20  
p
;

21 
	}
}

23 *
	$‹¡_h‰pş›Á_·r£r_basics
()

25 
h‰pş›Á_·r£r
 
p
 = 
	`£tup_·r£r
();

26 
p
.
d©a
 = &p;

27 
rc
 = 0;

29 
rc
 = 
	`h‰pş›Á_·r£r_fšish
(&
p
);

30 
	`mu_as£¹
(
rc
 == 0, "Client…arser SHOULD be finished if‚othing…arsed.");

32 
rc
 = 
	`h‰pş›Á_·r£r_has_”rÜ
(&
p
);

33 
	`mu_as£¹
(
rc
 == 0, "Should‚ot have‡nƒrror‡the beginning.");

35 
rc
 = 
	`h‰pş›Á_·r£r_is_fšished
(&
p
);

36 
	`mu_as£¹
(
rc
 == 0, "Should‚ot be finished since‚ever handed‡nything.");

37  
NULL
;

38 
	}
}

40 
b¡ršg
 
	$lßd_‹¡_ÿ£
(cÚ¡ *
·th
)

42 
FILE
 *
šfe
 = 
	`fİ’
(
·th
, "r");

43 
	`check
(
šfe
 !ğ
NULL
, "Failedo openest file.");

45 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

46 
	`fşo£
(
šfe
);

47 
	`check
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

49  
d©a
;

51 
”rÜ
:

52 if(
šfe
è
	`fşo£
(infile);

53  
NULL
;

54 
	}
}

56 *
	$‹¡_·r£r_th¿shšg
()

58 
glob_t
 
‹¡_fes
;

59 
i
 = 0;

60 
Å¬£d
 = 0;

61 
‹¡s_run
 = 0;

62 
execs_run
 = 0;

63 
unfšished
 = 0;

64 
”rÜs
 = 0;

66 
rc
 = 
	`glob
("‹¡s/ş›Á_su™e/*", 0, 
NULL
, &
‹¡_fes
);

67 
	`mu_as£¹
(
rc
 == 0, "Failedo glob file sinests/client_suite/*");

69 
i
 = 0; i < 
‹¡_fes
.
gl_·thc
; i++) {

70 
	`debug
("TESTING: %s", 
‹¡_fes
.
gl_·thv
[
i
]);

71 
b¡ršg
 
d©a
 = 
	`lßd_‹¡_ÿ£
(
‹¡_fes
.
gl_·thv
[
i
]);

72 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo†oadest case.");

74 
‹¡s_run
++;

76 
h‰pş›Á_·r£r
 
p
 = 
	`£tup_·r£r
();

77 
p
.
d©a
 = &p;

79 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(&
p
, 
	`bd©a
(
d©a
), 
	`bËngth
(data), 0);

80 
execs_run
++;

82 if(!
	`h‰pş›Á_·r£r_fšish
(&
p
)) {

83 
unfšished
++;

86 if(
	`h‰pş›Á_·r£r_has_”rÜ
(&
p
)) {

87 
”rÜs
++;

88 
	`debug
("TEST %s„esults: delta %d, has_error: %d, is_finished: %d",

89 
‹¡_fes
.
gl_·thv
[
i
],

90 
Å¬£d
, 
	`h‰pş›Á_·r£r_has_”rÜ
(&
p
),

91 
	`h‰pş›Á_·r£r_is_fšished
(&
p
));

92 } if(
p
.
chunked
) {

93 
¡¬t
 = 
p
.
body_¡¬t
;

96 
	`h‰pş›Á_·r£r_š™
(&
p
);

98 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(&
p
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
¡¬t
);

99 
	`mu_as£¹
(
p
.
body_¡¬t
 > 
¡¬t
, "Didn't go…ast start.");

100 
	`mu_as£¹
(
p
.
chunked
, "Should still be chunked.");

101 
¡¬t
 = 
p
.
body_¡¬t
 +….
cÚ‹Á_Ën
 + 1;

103 
	`debug
("CHUNK:†ength: %d, done: %d, start: %d",

104 
p
.
cÚ‹Á_Ën
,….
chunks_dÚe
, 
¡¬t
);

105 } !
p
.
chunks_dÚe
 &&….
cÚ‹Á_Ën
 > 0 && !
	`h‰pş›Á_·r£r_has_”rÜ
(&p));

107 
	`mu_as£¹
(
p
.
chunks_dÚe
, "Should have chunks_done set.");

108 
	`mu_as£¹
(
p
.
cÚ‹Á_Ën
 == 0, "Should have 0 content_lenoo.");

112 
	`debug
("HTTP PARSING:ests_run: %d,ƒxecs_run: %d, unfinished: %d,ƒrrors: %d",

113 
‹¡s_run
, 
execs_run
, 
unfšished
, 
”rÜs
);

115  
NULL
;

116 
	}
}

119 * 
	$®l_‹¡s
() {

120 
	`mu_su™e_¡¬t
();

122 
	`mu_run_‹¡
(
‹¡_h‰pş›Á_·r£r_basics
);

123 
	`mu_run_‹¡
(
‹¡_·r£r_th¿shšg
);

125  
NULL
;

126 
	}
}

128 
RUN_TESTS
(
®l_‹¡s
);

	@tests/io_tests.c

2 
	~"mšun™.h
"

3 
	~<io.h
>

4 
	~<cÚÃùiÚ.h
>

5 
	~<»gi¡”.h
>

6 
	~<as£¹.h
>

7 
	~<mem/h®loc.h
>

8 
	~<fú.h
>

10 
CÚÃùiÚ
 *
	$çke_cÚn
(cÚ¡ *
fe
, 
mode
) {

11 
CÚÃùiÚ
 *
cÚn
 = 
	`h_ÿÎoc
((Connection), 1);

12 
	`as£¹
(
cÚn
 && "Failedo create connection.");

14 
fd
 = 
	`İ’
(
fe
, 
mode
);

15 
	`as£¹
(
fd
 != -1 && "Failedo open file.");

17 
cÚn
->
iob
 = 
	`IOBuf_ü—‹
(10 * 1024, 
fd
, 
IOBUF_FILE
);

18 
	`as£¹
(
cÚn
->
iob
 && "Failedo create iobuffer.");

19 
cÚn
->
ty³
 = 
CONN_TYPE_HTTP
;

21 
	`Regi¡”_cÚÃù
(
fd
, 
cÚn
);

23  
cÚn
;

24 
	}
}

26 
	$çke_cÚn_şo£
(
CÚÃùiÚ
 *
cÚn
)

28 
	`as£¹
(
cÚn
 && cÚn->
iob
 && "Invalid connection.");

29 
	`Regi¡”_discÚÃù
(
cÚn
->
iob
->
fd
);

30 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

31 
	}
}

33 *
	$‹¡_IOBuf_»ad_İ”©iÚs
()

35 *
d©a
 = 
NULL
;

36 
ava
 = 0;

37 
CÚÃùiÚ
 *
cÚn
 = 
	`çke_cÚn
("/dev/z”o", 
O_RDONLY
);

38 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo make fake /dev/zero connection.");

39 
IOBuf
 *
buf
 = 
cÚn
->
iob
;

41 
	`IOBuf_»size
(
buf
, 31);

42 
	`mu_as£¹
(
buf
->
Ën
 == 31, "Wrong size‡fter„esize.");

44 
d©a
 = 
	`IOBuf_¡¬t
(
buf
);

45 
ava
 = 
	`IOBuf_ava
(
buf
);

46 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Didn't get‡ data„esponse on begin.");

47 
	`mu_as£¹
(
d©a
 =ğ
buf
->buf, "Begin on fresh iobuf should be‡the beginning.");

48 
	`mu_as£¹
(
ava
 == 0, "Should‚ot have‡nything‡vailable yet.");

50 
d©a
 = 
	`IOBuf_»ad
(
buf
, 10, &
ava
);

51 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

52 
	`mu_as£¹
(
d©a
 =ğ
	`IOBuf_¡¬t
(
buf
), "First„ead should work from start.");

53 
	`mu_as£¹
(
d©a
 =ğ
buf
->buf, "First„ead should be‡t start of internal buf.");

54 
	`mu_as£¹
(
ava
 == 10, "Should get 10 bytes.");

57 
	`mu_as£¹
(!
	`IOBuf_com·ù_Ãeded
(
buf
, 10), "Should‚ot‚eed compacting for 10.");

58 
	`mu_as£¹
(
	`IOBuf_com·ù_Ãeded
(
buf
, 100), "SHOULD‚eed compacting for 100.");

60 
	`mu_as£¹
(
	`IOBuf_»ad_comm™
(
buf
, 10) != -1, "Failedo commit.");

62 
d©a
 = 
	`IOBuf_¡¬t
(
buf
);

63 
ava
 = 
	`IOBuf_ava
(
buf
);

64 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Didn't get‡ data„esponse on begin.");

65 
	`mu_as£¹
(
d©a
 !ğ
buf
->buf, "Later„eads should‚ot be‡the start.");

66 
	`mu_as£¹
(
ava
 == 21, "Should have 21 bytes‡vailable inhe buf‡lready.");

68 
d©a
 = 
	`IOBuf_»ad
(
buf
, 10, &
ava
);

69 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

70 
	`mu_as£¹
(
ava
 == 10, "Should get 10 bytes.");

72 
	`mu_as£¹
(
	`IOBuf_»ad_comm™
(
buf
, 10) != -1, "Finaly commit failed.");

75 
d©a
 = 
	`IOBuf_¡¬t
(
buf
);

76 
ava
 = 
	`IOBuf_ava
(
buf
);

77 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Didn't get‡ data„esponse on begin.");

78 
	`mu_as£¹
(
d©a
 !ğ
buf
->buf, "Later„eads should‚ot be‡the start.");

79 
	`mu_as£¹
(
ava
 == 11, "Should have 11 bytes‡vailable inhe buf‡lready.");

83 
d©a
 = 
	`IOBuf_»ad
(
buf
, 5, &
ava
);

84 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

85 
	`mu_as£¹
(
ava
 == 5, "Should get 10 bytes.");

88 
d©a
 = 
	`IOBuf_»ad
(
buf
, 20, &
ava
);

89 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

90 
	`mu_as£¹
(
ava
 == 20, "Should get 10 bytes.");

92 
	`mu_as£¹
(
	`IOBuf_»ad_comm™
(
buf
, 21) != -1, "Final commit failed.");

93 
	`debug
("We'vgÙ %d‡va‡á”hÏ¡„—d.", 
buf
->
ava
);

94 
	`mu_as£¹
(
buf
->
ava
 == 10, "Should have 11 still inhe queue.");

96 
d©a
 = 
	`IOBuf_»ad_®l
(
buf
, 30, 1);

97 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„ead‡ll.");

98 
	`mu_as£¹
(
buf
->
ava
 == 1, "Should have 1 inhe queue.");

100 
d©a
 = 
	`IOBuf_»ad_some
(
buf
, &
ava
);

101 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„ead some.");

102 
	`mu_as£¹
(
buf
->
ava
 == 31, "Should be full.");

103 
	`mu_as£¹
(
ava
 == 31, "And we should gethe full‡mount.");

105 
	`çke_cÚn_şo£
(
cÚn
);

106  
NULL
;

107 
	}
}

109 *
	$‹¡_IOBuf_£nd_İ”©iÚs
()

111 
CÚÃùiÚ
 *
cÚn
 = 
	`çke_cÚn
("/dev/nuÎ", 
O_WRONLY
);

112 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo‡llocate buf.");

113 
IOBuf
 *
buf
 = 
cÚn
->
iob
;

114 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(
	`IOBuf_fd
(
buf
)è!ğ
NULL
, "Damn fd isn't„egistered.");

116 
rc
 = 
	`IOBuf_£nd
(
buf
, "012345789", 10);

117 
	`mu_as£¹
(!
	`IOBuf_şo£d
(
buf
), "Should‚ot be closed.");

118 
	`mu_as£¹
(
rc
 == 10, "Should have sent 10 bytes.");

120 
	`fdşo£
(
	`IOBuf_fd
(
buf
));

121 
rc
 = 
	`IOBuf_£nd
(
buf
, "012345789", 10);

122 
	`mu_as£¹
(
	`IOBuf_şo£d
(
buf
), "Should be closed.");

123 
	`mu_as£¹
(
rc
 == -1, "Should send‚othing.");

125 
	`çke_cÚn_şo£
(
cÚn
);

127  
NULL
;

128 
	}
}

131 *
	$‹¡_IOBuf_¡»amšg
()

134 
CÚÃùiÚ
 *
z”o
 = 
	`çke_cÚn
("/dev/z”o", 
O_RDONLY
);

135 
IOBuf
 *
äom
 = 
z”o
->
iob
;

136 
CÚÃùiÚ
 *
nuÎ
 = 
	`çke_cÚn
("/dev/nuÎ", 
O_WRONLY
);

137 
IOBuf
 *
to
 = 
nuÎ
->
iob
;

139 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 500);

140 
	`mu_as£¹
(
rc
 == 500, "Didn't streamhe„ight‡mount on smallest.");

142 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 10 * 1024);

143 
	`mu_as£¹
(
rc
 == 10 * 1024, "Didn't stream oversized‡mount.");

145 
	`fdşo£
(
äom
->
fd
);

146 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 10 * 1024);

147 
	`mu_as£¹
(
rc
 == -1, "Should fail if send side is closed.");

148 
	`mu_as£¹
(
äom
->
ava
 >= 0, "Avail should‚ever go below 0.");

150 
	`fdşo£
(
to
->
fd
);

151 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 10 * 1024);

152 
	`mu_as£¹
(
rc
 == -1, "Should fail if„ecv side is closed.");

154 
	`çke_cÚn_şo£
(
z”o
);

155 
	`çke_cÚn_şo£
(
nuÎ
);

156  
NULL
;

157 
	}
}

159 * 
	$®l_‹¡s
() {

160 
	`Regi¡”_š™
();

161 
	`mu_su™e_¡¬t
();

163 
	`mu_run_‹¡
(
‹¡_IOBuf_»ad_İ”©iÚs
);

164 
	`mu_run_‹¡
(
‹¡_IOBuf_£nd_İ”©iÚs
);

165 
	`mu_run_‹¡
(
‹¡_IOBuf_¡»amšg
);

167  
NULL
;

168 
	}
}

170 
RUN_TESTS
(
®l_‹¡s
);

	@tests/list_tests.c

1 
	~"mšun™.h
"

2 
	~<»gi¡”.h
>

3 
	~<adt/li¡.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<ùy³.h
>

7 
	~<¡d¬g.h
>

9 
	tšput_t
[256];

11 
	$tok’ize
(*
¡ršg
, ...)

13 **
tok±r
;

14 
va_li¡
 
¬gli¡
;

15 
tokcouÁ
 = 0;

17 
	`va_¡¬t
(
¬gli¡
, 
¡ršg
);

18 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

19 
tok±r
) {

20 *
¡ršg
 && 
	`is¥aû
(() *string))

21 
¡ršg
++;

22 ià(!*
¡ršg
)

24 *
tok±r
 = 
¡ršg
;

25 *
¡ršg
 && !
	`is¥aû
(() *string))

26 
¡ršg
++;

27 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

28 
tokcouÁ
++;

29 ià(!*
¡ršg
)

31 *
¡ršg
++ = 0;

33 
	`va_’d
(
¬gli¡
);

35  
tokcouÁ
;

36 
	}
}

38 
	$com·»f
(cÚ¡ *
key1
, cÚ¡ *
key2
)

40  
	`¡rcmp
(
key1
, 
key2
);

41 
	}
}

43 *
	$dup¡ršg
(*
¡r
)

45 
sz
 = 
	`¡¾’
(
¡r
) + 1;

46 *
Ãw
 = 
	`m®loc
(
sz
);

47 ià(
Ãw
)

48 
	`memıy
(
Ãw
, 
¡r
, 
sz
);

49  
Ãw
;

50 
	}
}

52 *
	$‹¡_li¡_İ”©iÚs
()

54 
šput_t
 
š
;

55 
li¡_t
 *
l
 = 
	`li¡_ü—‹
(
LISTCOUNT_T_MAX
);

56 
Êode_t
 *
Ê
;

57 *
tok1
, *
v®
;

58 
´om±
 = 0;

59 
FILE
 *
d©a
 = 
	`fİ’
("tests/adt_data.txt", "r");

60 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Couldn't†oadest data.");

62 *
h–p
 =

72 ià(!
l
)

73 
	`puts
("list_create failed");

76 ià(
´om±
)

77 
	`putch¬
('>');

78 
	`fæush
(
¡dout
);

81 ià(!
	`fg‘s
(
š
, (
šput_t
), 
d©a
))

84 
š
[0]) {

86 
	`puts
(
h–p
);

89 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

90 
	`puts
("what?");

93 
v®
 = 
	`dup¡ršg
(
tok1
);

94 
Ê
 = 
	`Êode_ü—‹
(
v®
);

96 ià(!
v®
 || !
Ê
) {

97 
	`puts
("allocation failure");

98 ià(
Ê
)

99 
	`Êode_de¡roy
(
Ê
);

100 
	`ä“
(
v®
);

104 
	`li¡_­³nd
(
l
, 
Ê
);

107 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

108 
	`puts
("what?");

111 
Ê
 = 
	`li¡_fšd
(
l
, 
tok1
, 
com·»f
);

112 ià(!
Ê
) {

115 
	`li¡_d–‘e
(
l
, 
Ê
);

116 
v®
 = 
	`Êode_g‘
(
Ê
);

117 
	`Êode_de¡roy
(
Ê
);

118 
	`ä“
(
v®
);

121 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

122 
	`puts
("what?");

125 
Ê
 = 
	`li¡_fšd
(
l
, 
tok1
, 
com·»f
);

128 
	`li¡_sÜt
(
l
, 
com·»f
);

131 
	`´štf
("%lu\n", (è
	`li¡_couÁ
(
l
));

134 
Ê
 = 
	`li¡_fœ¡
(
l
);†À!ğ0;†Àğ
	`li¡_Ãxt
(l,†n)) {

135 
	`mu_as£¹
(
	`Êode_g‘
(
Ê
), "invalidƒlement");

139  
NULL
;

144 
´om±
 = 1;

147 
	`putch¬
('?');

148 
	`putch¬
('\n');

153 
	`mu_as£¹
(
	`li¡_v”ify
(
l
), "List became invalid.");

155  
NULL
;

156 
	}
}

158 * 
	$®l_‹¡s
() {

159 
	`mu_su™e_¡¬t
();

161 
	`mu_run_‹¡
(
‹¡_li¡_İ”©iÚs
);

163  
NULL
;

164 
	}
}

166 
RUN_TESTS
(
®l_‹¡s
);

	@tests/mime_tests.c

1 
	~"mšun™.h
"

2 
	~<mime.h
>

4 *
	$‹¡_MIME_çu»s
()

6 
rc
 = 
	`MIME_add_ty³
("txt", "badtype");

7 
	`mu_as£¹
(
rc
 == -1, "Should‚ot‡cceptƒxtension with '.'");

8 
rc
 = 
	`MIME_add_ty³
("", "badtype");

9 
	`mu_as£¹
(
rc
 == -1, "Should„ejectƒmptyƒxt.");

10 
rc
 = 
	`MIME_add_ty³
(".txt", "");

11 
	`mu_as£¹
(
rc
 == -1, "Should„ejectƒmpty MIMEype.");

13  
NULL
;

14 
	}
}

17 *
	$‹¡_MIME_İs
()

19 
rc
 = 
	`MIME_add_ty³
(".txt", "text/plain");

20 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd .txt");

22 
rc
 = 
	`MIME_add_ty³
(".txt", "badtype");

23 
	`mu_as£¹
(
rc
 == -1, "Should‚ot‡dd duplicates");

25 
rc
 = 
	`MIME_add_ty³
(".json", "application/javascript");

26 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd .json");

28 
rc
 = 
	`MIME_add_ty³
(".html", "text/html");

29 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd .html");

32 
b¡ršg
 
ty³
;

33 
b¡ršg
 
t1
, 
t2
, 
t3
, 
t4
, 
t5
;

35 
ty³
 = 
	`MIME_m©ch_ext
(
t1
 = 
	`bäomc¡r
("‹¡.html"), 
NULL
);

36 
	`mu_as£¹
(
ty³
, "Didn't find .html file.");

37 
	`mu_as£¹
(
	`bi£qc¡r
(
ty³
, "text/html"), "Wrongype„eturned for.html.");

39 
ty³
 = 
	`MIME_m©ch_ext
(
t2
 = 
	`bäomc¡r
("‹¡.jsÚ"), 
NULL
);

40 
	`mu_as£¹
(
ty³
, "Didn't find .json file.");

41 
	`debug
("GOT jsÚy³: %s", 
	`bd©a
(
ty³
));

42 
	`mu_as£¹
(
	`bi£qc¡r
(
ty³
, "application/javascript"), "Wrongype„eturned for .json.");

44 
ty³
 = 
	`MIME_m©ch_ext
(
t3
 = 
	`bäomc¡r
("‹¡.ü­"), 
NULL
);

45 
	`mu_as£¹
(!
ty³
, "Should‚ot find unknownypes.");

47 
ty³
 = 
	`MIME_m©ch_ext
(
t4
 = 
	`bäomc¡r
("‹¡.ü­"), 
t5
 = bfromcstr("text/plain"));

48 
	`mu_as£¹
(
ty³
, "Should gethe defaultype.");

49 
	`mu_as£¹
(
	`bi£qc¡r
(
ty³
, "text/plain"), "Wrongype„eturned for.html.");

51 
	`bde¡roy
(
t1
);

52 
	`bde¡roy
(
t2
);

53 
	`bde¡roy
(
t3
);

54 
	`bde¡roy
(
t4
);

55 
	`bde¡roy
(
t5
);

56  
NULL
;

57 
	}
}

59 *
	$‹¡_MIME_de¡roy
()

61 
	`MIME_de¡roy
();

62  
NULL
;

63 
	}
}

66 * 
	$®l_‹¡s
() {

67 
	`mu_su™e_¡¬t
();

69 
	`mu_run_‹¡
(
‹¡_MIME_çu»s
);

70 
	`mu_run_‹¡
(
‹¡_MIME_İs
);

71 
	`mu_run_‹¡
(
‹¡_MIME_de¡roy
);

73  
NULL
;

74 
	}
}

76 
RUN_TESTS
(
®l_‹¡s
);

	@tests/minunit.h

1 #undeà
NDEBUG


2 #iâdeà
_mšun™_h


3 
	#_mšun™_h


	)

5 
	~<¡dio.h
>

6 
	~<dbg.h
>

7 
	~<¡dlib.h
>

9 
	#mu_su™e_¡¬t
(è*
mes§ge
 = 
NULL


	)

12 
	#mu_as£¹
(
‹¡
, 
mes§ge
èià(!Ñe¡)è{ 
	`log_”r
(mes§ge);  mes§ge; }

	)

13 
	#mu_run_‹¡
(
‹¡
è
	`debug
("\n-----%s", " " #‹¡); 
mes§ge
 = 
	`‹¡
(); 
‹¡s_run
++; ià(mes§geè mes§ge;

	)

15 
	#RUN_TESTS
(
Çme
è
	`skmaš
(
¬gc
, *
¬gv
[]) {\

16 
FILE
 *
log_fe
 = 
	`fİ’
("tests/tests.log", "a+");\

17 if(!
log_fe
è{ 
	`´štf
("CAN'T OPEN TEST LOG\n"); 
	`ex™
(1); } \

18 
	`£tbuf
(
log_fe
, 
NULL
);\

19 
	`dbg_£t_log
(
log_fe
);\

20 
	`debug
("----- RUNNING: %s", 
¬gv
[0]);\

21 
	`´štf
("----\nRUNNING: %s\n", 
¬gv
[0]);\

22 *
»suÉ
 = 
	`Çme
();\

23 ià(
»suÉ
 != 0) {\

24 
	`´štf
("FAILED: %s\n", 
»suÉ
);\

27 
	`´štf
("ALL TESTS PASSED\n");\

29 
	`´štf
("Te¡ run: %d\n", 
‹¡s_run
);\

30 
	`ex™
(
»suÉ
 != 0);\

31 }

	)

34 
	g‹¡s_run
;

	@tests/pattern_tests.c

1 
	~"mšun™.h
"

2 
	~<·‰”n.h
>

3 
	~<¡ršg.h
>

5 cÚ¡ *
	gm
;

7 *
	$‹¡_sim¶e_m©ches
()

9 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZED");

10 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match†iteral identically.");

12 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z.D");

13 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match wildcard.");

15 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "FOO");

16 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

18  
NULL
;

19 
	}
}

21 *
	$‹¡_sim¶e_»³t™iÚs
()

23 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE*D");

24 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

26 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE*ED");

27 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

29 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZEEEED"), "ZE*ED");

30 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

32 
m
 = 
	`·‰”n_m©ch
("ZD", 
	`¡¾’
("ZD"), "ZE*D");

33 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

35 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZX*D");

36 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

38 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "Z.*D");

39 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

41 
m
 = 
	`·‰”n_m©ch
("ZXXXXD", 
	`¡¾’
("ZXXXXD"), "ZE.*D");

42 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

44 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE+D");

45 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

47 
m
 = 
	`·‰”n_m©ch
("ZD", 
	`¡¾’
("ZEEEED"), "ZE+D");

48 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

50 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE-D");

51 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

53 
m
 = 
	`·‰”n_m©ch
("ZD", 
	`¡¾’
("ZEEEED"), "ZE-D");

54 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

56  
NULL
;

57 
	}
}

59 *
	$‹¡_ªchÜs
()

61 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZED$");

62 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match. Anchor‡theƒnd.");

64 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZE$");

65 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match. Should haveƒnded‡t $.'");

67 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ED");

68 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match. Implicit‡nchor‡the start of…attern.");

70  
NULL
;

71 
	}
}

73 *
	$‹¡_blocks
()

76 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZEED"), "Z(ED)");

77 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

79 
b¡ršg
 
s
 = 
	`bäomc¡r
("ZED");

80 
b¡ršg
 
p
 = 
	`bäomc¡r
("Z(ED)");

81 
m
 = 
	`b¡ršg_m©ch
(
s
, 
p
);

82 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

84 
	`bde¡roy
(
s
); bde¡roy(
p
);

85  
NULL
;

86 
	}
}

88 *
	$‹¡_äÚt›r
()

92 
m
 = 
	`·‰”n_m©ch
("THE (QUICK) brOWN FOx JUMPS",

93 
	`¡¾’
("THE (QUICK) brOWN FOx JUMPS"), "\\f[\\a]\\u-\\f[\\a]");

94 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

96  
NULL
;

97 
	}
}

99 *
	$‹¡_b®ªû
()

102 
m
 = 
	`·‰”n_m©ch
("/u£rs/{1234}", 
	`¡¾’
("/users/{1234}"), "/users/\\b{}");

103 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match balanced chars.");

105 
m
 = 
	`·‰”n_m©ch
("/u£rs/{1234", 
	`¡¾’
("/users/{1234}"), "/users/\\b{}");

106 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match balanced unchars.");

108 
m
 = 
	`·‰”n_m©ch
("/u£rs/1234}", 
	`¡¾’
("/users/{1234}"), "/users/\\b{}");

109 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match balanced unchars.");

111  
NULL
;

112 
	}
}

114 *
	$‹¡_£t
()

116 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z[OE]D");

117 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

119 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z[^OE]D");

120 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

122 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z[A-Z]D");

123 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

125  
NULL
;

126 
	}
}

128 *
	$‹¡_İtiÚ®
()

130 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZEE?D");

131 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

133 
m
 = 
	`·‰”n_m©ch
("ZEED", 
	`¡¾’
("ZEED"), "ZEE?D");

134 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match wildcard.");

136 
m
 = 
	`·‰”n_m©ch
("ZEEED", 
	`¡¾’
("ZEEED"), "ZEE?D");

137 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

139  
NULL
;

140 
	}
}

142 *
	$‹¡_esÿ³d
()

156 
m
 = 
	`·‰”n_m©ch
("a \t 9† . \n U w A \0", 19, "\\a \\c \\d \\l \\p \\s \\u \\w \\x \\z");

158 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

162 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z\\ED");

164 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

168 
m
 = 
	`·‰”n_m©ch
("*Z*E+D.", 
	`¡¾’
("*Z*E+D."), "\\*Z\\*E\\+D\\.");

170 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

172 
m
 = 
	`·‰”n_m©ch
("ZED!", 
	`¡¾’
("ZED!"), "ZED\\.");

174 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

176  
NULL
;

177 
	}
}

180 * 
	$®l_‹¡s
() {

181 
	`mu_su™e_¡¬t
();

183 
	`mu_run_‹¡
(
‹¡_sim¶e_m©ches
);

184 
	`mu_run_‹¡
(
‹¡_sim¶e_»³t™iÚs
);

185 
	`mu_run_‹¡
(
‹¡_ªchÜs
);

186 
	`mu_run_‹¡
(
‹¡_blocks
);

187 
	`mu_run_‹¡
(
‹¡_äÚt›r
);

188 
	`mu_run_‹¡
(
‹¡_b®ªû
);

189 
	`mu_run_‹¡
(
‹¡_£t
);

190 
	`mu_run_‹¡
(
‹¡_İtiÚ®
);

191 
	`mu_run_‹¡
(
‹¡_esÿ³d
);

193  
NULL
;

194 
	}
}

196 
RUN_TESTS
(
®l_‹¡s
);

	@tests/proxy_tests.c

1 
	~"mšun™.h
"

2 
	~<´oxy.h
>

3 
	~<¡dlib.h
>

4 
	~<mem/h®loc.h
>

7 *
	$‹¡_Proxy_ü—‹_de¡roy
()

9 
Proxy
 *
´oxy
 = 
	`Proxy_ü—‹
(
	`bäomc¡r
("127.0.0.1"), 80);

10 
	`mu_as£¹
(
´oxy
 !ğ
NULL
, "Didn't makehe…roxy.");

12 
	`Proxy_de¡roy
(
´oxy
);

14  
NULL
;

15 
	}
}

17 * 
	$®l_‹¡s
() {

18 
	`mu_su™e_¡¬t
();

20 
	`mu_run_‹¡
(
‹¡_Proxy_ü—‹_de¡roy
);

22  
NULL
;

23 
	}
}

25 
RUN_TESTS
(
®l_‹¡s
);

	@tests/register_tests.c

1 
	~"mšun™.h
"

2 
	~<cÚÃùiÚ.h
>

3 
	~<»gi¡”.h
>

5 
	gV_TEST_CONN_1
 = 1;

6 
	gV_TEST_CONN_2
 = 2;

7 
CÚÃùiÚ
 *
	gTEST_CONN_1
 = 
NULL
;

8 
CÚÃùiÚ
 *
	gTEST_CONN_2
 = 
NULL
;

10 *
	$‹¡_Regi¡”_š™
()

12 
	`Regi¡”_š™
();

14 
TEST_CONN_1
 = 
	`ÿÎoc
((
CÚÃùiÚ
), 1);

15 
TEST_CONN_2
 = 
	`ÿÎoc
((
CÚÃùiÚ
), 1);

17  
NULL
;

18 
	}
}

20 *
	$‹¡_Regi¡”_cÚÃù_discÚÃù
()

22 
id
 = 
	`Regi¡”_cÚÃù
(12, 
TEST_CONN_1
);

23 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12è=ğ
TEST_CONN_1
, "Didn't„egister.");

24 
	`mu_as£¹
(
id
 >= 0, "Got‡‚egative forhe ident.");

26 
fd
 = 
	`Regi¡”_fd_fÜ_id
(
id
);

27 
	`mu_as£¹
(
fd
 == 12, "Should get 12 forhe fd.");

29 
Şd_id
 = 
	`Regi¡”_id_fÜ_fd
(
fd
);

30 
	`mu_as£¹
(
Şd_id
 =ğ
id
, "Wrong id for fd.");

32 
Şd_id
 = 
	`Regi¡”_discÚÃù
(12);

33 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12) == 0, "Didn't disconnect.");

34 
	`mu_as£¹
(
id
 =ğ
Şd_id
, "Wrong id on disconnect.");

37 
Şd_id
 = 
	`Regi¡”_discÚÃù
(12);

38 
	`mu_as£¹
(
Şd_id
 == -1, "Should get‡nƒrror.");

39  
NULL
;

40 
	}
}

42 *
	$‹¡_Regi¡”_pšg
()

44 
id
 = 
	`Regi¡”_cÚÃù
(12232, 
TEST_CONN_1
);

45 
	`mu_as£¹
(
id
 >= 0, "Failedo connect 12232.");

46 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12232è=ğ
TEST_CONN_1
, "Didn't„egister.");

48 
	`mu_as£¹
(
	`Regi¡”_pšg
(12232), "Ping didn't work.");

51 
Ãw_id
 = 
	`Regi¡”_cÚÃù
(12232, 
TEST_CONN_2
);

52 
	`mu_as£¹
(
Ãw_id
 !ğ
id
, "Second„egister should get‚ew id.");

53 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12232è=ğ
TEST_CONN_2
, "Should have different connection");

55 
id
 = 
	`Regi¡”_discÚÃù
(12232);

56 
	`mu_as£¹
(
id
 != -1, "Didn't disconnect‡fter some…ings.");

57 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12232) == 0, "Disconnect didn't work.");

59 
	`mu_as£¹
(
	`Regi¡”_pšg
(12) == -1, "Should getƒrror on…ing of disconnect.");

61  
NULL
;

62 
	}
}

65 * 
	$®l_‹¡s
() {

66 
	`mu_su™e_¡¬t
();

68 
	`mu_run_‹¡
(
‹¡_Regi¡”_š™
);

69 
	`mu_run_‹¡
(
‹¡_Regi¡”_cÚÃù_discÚÃù
);

70 
	`mu_run_‹¡
(
‹¡_Regi¡”_pšg
);

72  
NULL
;

73 
	}
}

75 
RUN_TESTS
(
®l_‹¡s
);

	@tests/request_tests.c

1 
	~"mšun™.h
"

2 
	~"»que¡.h
"

3 
	~"Š‘¡ršgs.h
"

4 
	~"h—d”s.h
"

5 
	~<glob.h
>

6 
	~"»gi¡”.h
"

7 
	~"cÚÃùiÚ.h
"

9 cÚ¡ *
	gRFC_822_TIME
 = "%a, %d %b %y %T";

11 *
	$‹¡_Reque¡_·ylßds
()

13 
glob_t
 
‹¡_fes
;

14 
b¡ršg
 
çke_£nd”
 = 
	`bäomc¡r
("FAKESENDER");

15 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

16 
size_t
 
Å¬£d
 = 0;

17 
i
 = 0;

18 
rc
 = 
	`glob
("‹¡s/ªd_su™e/*", 0, 
NULL
, &
‹¡_fes
);

19 
	`mu_as£¹
(
rc
 == 0, "Failedo glob file sinests/and_suite/*");

20 
FILE
 *
‹¡_ÿ£s
 = 
	`fİ’
("tests/request_payloads.txt", "w");

21 
	`mu_as£¹
(
‹¡_ÿ£s
 !ğ
NULL
, "Failedo createheests/request_payloads.txt file.");

23 
i
 = 0; i < 
‹¡_fes
.
gl_·thc
; i++) {

24 
Å¬£d
 = 0;

25 
FILE
 *
šfe
 = 
	`fİ’
(
‹¡_fes
.
gl_·thv
[
i
], "r");

26 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

28 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

29 
	`fşo£
(
šfe
);

30 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

32 
	`Reque¡_¡¬t
(
»q
);

33 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), &
Å¬£d
);

35 if(
rc
 == 1) {

36 
	`mu_as£¹
(
Å¬£d
 > 0, "Should have…arsed something.");

39 if(
»q
->
·th
 =ğ
NULL
è»q->·th = 
	`bäomc¡r
("/");

41 
b¡ršg
 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
»q
, 
çke_£nd”
, 0, "", 0);

42 
	`bcÚch¬
(
·ylßd
, '\n');

43 
	`fwr™e
(
·ylßd
->
d©a
, 
	`bËngth
Õaylßd), 1, 
‹¡_ÿ£s
);

44 
	`bde¡roy
(
·ylßd
);

46 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
»q
, 
çke_£nd”
, 0, "", 0);

47 
	`debug
("TNETSTRING PAYLOAD: '%.*s'", 
	`bËngth
(
·ylßd
), 
	`bd©a
(payload));

48 
	`bcÚch¬
(
·ylßd
, '\n');

49 
	`fwr™e
(
·ylßd
->
d©a
, 
	`bËngth
Õaylßd), 1, 
‹¡_ÿ£s
);

50 
	`bde¡roy
(
·ylßd
);

53 
	`bde¡roy
(
d©a
);

56 
	`globä“
(&
‹¡_fes
);

57 
	`fşo£
(
‹¡_ÿ£s
);

58 
	`bde¡roy
(
çke_£nd”
);

59 
	`Reque¡_de¡roy
(
»q
);

60  
NULL
;

61 
	}
}

63 *
	$‹¡_Reque¡_¥“ds
()

65 
i
 = 0;

66 
FILE
 *
šfe
 = 
	`fİ’
("tests/request_payloads.txt", "r");

67 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openheests/request_payloads.txtest file.");

68 
b¡rLi¡
 *
li¡
 = 
	`b¡rLi¡C»©e
();

69 
	`b¡rLi¡AÎoc
(
li¡
, 300);

72 
i
 = 0; i < 300; i++, 
li¡
->
qty
++) {

73 
b¡ršg
 
£nd”
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, ' ');

74 
b¡ršg
 
cÚn_id
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, ' ');

75 
b¡ršg
 
·th
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, ' ');

76 
li¡
->
’Œy
[
i
] = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, '\n');

79 if(!(
£nd”
 && 
cÚn_id
 && 
·th
)) ;

81 
	`bde¡roy
(
£nd”
);

82 
	`bde¡roy
(
cÚn_id
);

83 
	`bde¡roy
(
·th
);

86 
	`fşo£
(
šfe
);

90 
j
 = 0;

91 
j
 = 0; j < 200; j++) {

92 
i
 = 0; i < 
li¡
->
qty
; i++) {

93 
Šs_v®ue_t
 *
v®
 = 
	`Šs_·r£
(
	`bd©a
(
li¡
->
’Œy
[
i
]), 
	`bËngth
Öi¡->’Œy[i]), 
NULL
);

94 
	`mu_as£¹
(
v®
->
ty³
 =ğ
Šs_g_¡ršg
 || v®->ty³ =ğ
Šs_g_diù
, "Got‡n invalid data chunk from file.");

96 
size_t
 
Ën
 = 0;

97 *
·ylßd
 = 
	`Šs_»nd”
(
v®
, &
Ën
);

98 
	`mu_as£¹
(
Ën
 > 0, "Failedo„enderhe…ayload.");

100 
	`ä“
(
·ylßd
);

101 
	`Šs_v®ue_de¡roy
(
v®
);

105 
	`b¡rLi¡De¡roy
(
li¡
);

106  
NULL
;

107 
	}
}

109 *
	$‹¡_Reque¡_ü—‹
()

111 
rc
 = 0;

112 
size_t
 
Å¬£d
 = 0;

113 
b¡ršg
 
çke_£nd”
 = 
	`bäomc¡r
("FAKESENDER");

115 
	`Reque¡_š™
();

117 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

118 
	`mu_as£¹
(
»q
 !ğ
NULL
, "Failedo create…arser for„equest.");

120 
FILE
 *
šfe
 = 
	`fİ’
("tests/and_suite/ex_httpd_tst_16", "r");

121 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

123 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

124 
	`fşo£
(
šfe
);

125 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

126 
	`mu_as£¹
(
	`bËngth
(
d©a
) > 0, "Nothing inhat file.");

128 
	`Reque¡_¡¬t
(
»q
);

130 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), &
Å¬£d
);

132 
	`mu_as£¹
(
rc
 == 1, "It should…arse.");

133 
	`mu_as£¹
(
Å¬£d
 > 0, "Should have…arsed something.");

135 
b¡ršg
 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
»q
, 
çke_£nd”
, 0, "", 0);

136 
	`debug
("PAYLOAD IS: %s", 
	`bd©a
(
·ylßd
));

137 
	`bde¡roy
(
·ylßd
);

139 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
»q
, 
çke_£nd”
, 0, "", 0);

140 
	`debug
("TNETSTRING PAYLOAD: '%.*s'", 
	`bËngth
(
·ylßd
), 
	`bd©a
(payload));

142 
	`mu_as£¹
(
	`Reque¡_g‘
(
»q
, &
HTTP_IF_MODIFIED_SINCE
è!ğ
NULL
,

144 
	`mu_as£¹
(
»q
->
ho¡
 !ğ
NULL
, "Should have Host header.");

145 
	`mu_as£¹
(
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_MODIFIED_SINCE
, 
RFC_822_TIME
) > 0,

148 
	`mu_as£¹
(
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_UNMODIFIED_SINCE
, 
RFC_822_TIME
) == 0,

151 
	`mu_as£¹
(
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_NONE_MATCH
, 
RFC_822_TIME
) == 0,

154 
	`Reque¡_¡¬t
(
»q
);

156 
	`Reque¡_de¡roy
(
»q
);

159 
	`Reque¡_de¡roy
(
NULL
);

160 
	`bde¡roy
(
·ylßd
);

161 
	`bde¡roy
(
çke_£nd”
);

162 
	`bde¡roy
(
d©a
);

164  
NULL
;

165 
	}
}

167 
gb¡ršg
 
	gCOOKIE_HEADER
 = 
bsStic
("cookie");

168 
gb¡ršg
 
	gEXPECTED_COOKIE_HEADER
 = 
bsStic
("JSON 0 / 97:{\"PATH\":\"/\",\"cookie\":[\"foo=bar\",\"test=yes; go=no\"],\"METHOD\":\"GET\",\"VERSION\":\"HTTP/1.0\",\"URI\":\"/\"},0:,");

170 *
	$‹¡_MuÉË_H—d”_Reque¡
()

172 
rc
 = 0;

173 
size_t
 
Å¬£d
 = 0;

175 
	`Reque¡_š™
();

177 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

178 
	`mu_as£¹
(
»q
 !ğ
NULL
, "Failedo create…arser for„equest.");

180 
FILE
 *
šfe
 = 
	`fİ’
("tests/and_suite/ex_httpd_tst_21", "r");

181 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

183 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

184 
	`fşo£
(
šfe
);

185 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

186 
	`mu_as£¹
(
	`bËngth
(
d©a
) > 0, "Nothing inhat file.");

188 
	`Reque¡_¡¬t
(
»q
);

190 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), &
Å¬£d
);

192 
	`mu_as£¹
(
rc
 == 1, "It should…arse.");

193 
	`mu_as£¹
(
Å¬£d
 > 0, "Should have…arsed something.");

195 
	`mu_as£¹
(
	`Reque¡_g‘
(
»q
, &
COOKIE_HEADER
è!ğ
NULL
,

198 
b¡ršg
 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
»q
, &
JSON_METHOD
, 0, "", 0);

199 
	`debug
("PAYLOAD IS: %s", 
	`bd©a
(
·ylßd
));

201 
	`mu_as£¹
(
	`b¡rcmp
(
·ylßd
, &
EXPECTED_COOKIE_HEADER
) == 0,

204 
	`Reque¡_de¡roy
(
»q
);

205 
	`bde¡roy
(
·ylßd
);

206 
	`bde¡roy
(
d©a
);

208  
NULL
;

209 
	}
}

212 * 
	$®l_‹¡s
() {

213 
	`mu_su™e_¡¬t
();

214 
	`Regi¡”_š™
();

217 
CÚÃùiÚ
 *
cÚn
 = 
	`ÿÎoc
((Connection), 1);

218 
cÚn
->
iob
 = 
NULL
;

219 
cÚn
->
ty³
 = 
CONN_TYPE_HTTP
;

220 
	`Regi¡”_cÚÃù
(0, 
cÚn
);

222 
	`mu_run_‹¡
(
‹¡_Reque¡_ü—‹
);

223 
	`mu_run_‹¡
(
‹¡_MuÉË_H—d”_Reque¡
);

224 
	`mu_run_‹¡
(
‹¡_Reque¡_·ylßds
);

225 
	`mu_run_‹¡
(
‹¡_Reque¡_¥“ds
);

227  
NULL
;

228 
	}
}

230 
RUN_TESTS
(
®l_‹¡s
);

	@tests/response_tests.c

1 
	~"mšun™.h
"

2 
	~"»¥Ú£.h
"

3 
	~"cÚÃùiÚ.h
"

4 
	~"»gi¡”.h
"

5 
	~<fú.h
>

8 *
	$‹¡_Re¥Ú£_£nd_¡©us
()

10 
z”o_fd
 = 
	`İ’
("/dev/z”o", 
O_WRONLY
);

11 
IOBuf
 *
buf
 = 
	`IOBuf_ü—‹
(1024, 
z”o_fd
, 
IOBUF_FILE
);

12 
CÚÃùiÚ
 
cÚn
 = {.
iob
 = 
buf
};

13 
	`Regi¡”_cÚÃù
(
z”o_fd
, &
cÚn
);

15 
rc
 = 
	`Re¥Ú£_£nd_¡©us
(&
cÚn
, &
HTTP_405
);

16 
	`mu_as£¹
(
rc
 != -1, "Failedo send 405 status.");

18 
	`Regi¡”_discÚÃù
(
z”o_fd
);

19  
NULL
;

20 
	}
}

22 *
	$‹¡_Re¥Ú£_£nd_sock‘_pŞicy
()

24 
z”o_fd
 = 
	`İ’
("/dev/z”o", 
O_WRONLY
);

25 
IOBuf
 *
buf
 = 
	`IOBuf_ü—‹
(1024, 
z”o_fd
, 
IOBUF_FILE
);

26 
CÚÃùiÚ
 
cÚn
 = {.
iob
 = 
buf
};

27 
	`Regi¡”_cÚÃù
(
z”o_fd
, &
cÚn
);

29 
rc
 = 
	`Re¥Ú£_£nd_sock‘_pŞicy
(&
cÚn
);

30 
	`mu_as£¹
(
rc
 != -1, "Failedo sendhe flash socket…olicy.");

32 
	`Regi¡”_discÚÃù
(
z”o_fd
);

33  
NULL
;

34 
	}
}

37 * 
	$®l_‹¡s
() {

38 
	`mu_su™e_¡¬t
();

39 
	`Regi¡”_š™
();

41 
	`mu_run_‹¡
(
‹¡_Re¥Ú£_£nd_¡©us
);

42 
	`mu_run_‹¡
(
‹¡_Re¥Ú£_£nd_sock‘_pŞicy
);

44  
NULL
;

45 
	}
}

47 
RUN_TESTS
(
®l_‹¡s
);

	@tests/routing_tests.c

1 
	~"mšun™.h
"

2 
	~<routšg.h
>

3 
	~<¡ršg.h
>

4 
	~<dbg.h
>

7 
	$check_routšg
(
li¡_t
 *
found
, 
Rou‹
 *
rou‹
, 
ex³ùed_couÁ
, cÚ¡ *
rou‹_d©a
)

9 if(
	`li¡_fœ¡
(
found
)) {

10 
rou‹
 = 
	`Êode_g‘
(
	`li¡_fœ¡
(
found
));

13 
	`check
(
	`li¡_couÁ
(
found
è=ğ
ex³ùed_couÁ
, "Didn't find„ight‚umber of„outes: got %d,ƒxpected %d.",

14 ()
	`li¡_couÁ
(
found
), 
ex³ùed_couÁ
);

16 if(
rou‹_d©a
 =ğ
NULL
) {

17 
	`check
(
rou‹
 =ğ
NULL
, "Should have‚o„outes found.");

19 
	`check
(
rou‹
->
d©a
 =ğ
rou‹_d©a
, "Wrong data„eturned.");

23 
”rÜ
:

24 if(
rou‹
è
	`debug
("Rou‹„‘uºed: %s", (cÚ¡ *ìou‹->
d©a
);

26 
	}
}

29 
	$check_sim¶e_´efix
(
Rou‹M­
 *
rou‹s
, cÚ¡ * 
·th
, cÚ¡ *
ex³ùed
)

31 
b¡ršg
 
·th_¡r
 = 
	`bäomc¡r
(
·th
);

32 
Rou‹
 *
found
 = 
	`Rou‹M­_sim¶e_´efix_m©ch
(
rou‹s
, 
·th_¡r
);

33 
	`debug
("Testing simple…refix: %so match %s‡nd found %s",

34 
·th
, 
ex³ùed
, 
found
 =ğ
NULL
 ? "NULL" : (cÚ¡ *)found->
d©a
);

36 if(
ex³ùed
 !ğ
NULL
) {

37 
	`check
(
found
 !ğ
NULL
, "Should find‡ match.");

38 
	`check
(
found
->
d©a
 =ğ
ex³ùed
, "Didn't match.");

40 
	`check
(
found
 =ğ
NULL
, "Should‚ot find‡ match.");

43 
	`bde¡roy
(
·th_¡r
);

45 
”rÜ
:

46 
	`bde¡roy
(
·th_¡r
);

48 
	}
}

50 *
	$‹¡_sim¶e_´efix_m©chšg
()

52 
Rou‹M­
 *
rou‹s
 = 
	`Rou‹M­_ü—‹
(
NULL
);

53 
	`mu_as£¹
(
rou‹s
 !ğ
NULL
, "Failedo makehe„oute map.");

54 *
rou‹_d©a0
 = "route0";

55 *
rou‹_d©a1
 = "route1";

56 *
rou‹_d©a2
 = "route2";

57 *
rou‹_d©a3
 = "route3";

58 *
rou‹_d©a4
 = "route4";

59 
b¡ršg
 
rou‹0
 = 
	`bäomc¡r
("/");

60 
b¡ršg
 
rou‹1
 = 
	`bäomc¡r
("/users/([0-9]+)");

61 
b¡ršg
 
rou‹2
 = 
	`bäomc¡r
("/users");

62 
b¡ršg
 
rou‹3
 = 
	`bäomc¡r
("/users/people/([0-9]+)$");

63 
b¡ršg
 
rou‹4
 = 
	`bäomc¡r
("/cars-fast/([a-z]-)$");

65 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹0
, 
rou‹_d©a0
);

66 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹1
, 
rou‹_d©a1
);

67 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹2
, 
rou‹_d©a2
);

68 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹3
, 
rou‹_d©a3
);

69 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹4
, 
rou‹_d©a4
);

71 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs/1234/‹¡šg", 
rou‹_d©a1
), "Failed.");

72 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs", 
rou‹_d©a2
), "Failed.");

73 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs/³İË/1234", 
rou‹_d©a3
), "Failed.");

74 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/ÿrs-ç¡/ÿdÏc", 
rou‹_d©a4
), "Failed.");

75 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs/1234", 
rou‹_d©a1
), "Failed.");

76 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/", 
rou‹_d©a0
), "Failed.");

80 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rsBLAAHAHAH", 
rou‹_d©a2
), "Failed.");

82 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/us", 
rou‹_d©a2
), "Failed.");

84 
	`Rou‹M­_de¡roy
(
rou‹s
);

86  
NULL
;

87 
	}
}

89 *
	$‹¡_routšg_m©ch
()

91 
Rou‹M­
 *
rou‹s
 = 
	`Rou‹M­_ü—‹
(
NULL
);

92 
	`mu_as£¹
(
rou‹s
 !ğ
NULL
, "Failedo makehe„oute map.");

93 *
rou‹_d©a0
 = "route0";

94 *
rou‹_d©a1
 = "route1";

95 *
rou‹_d©a2
 = "route2";

96 *
rou‹_d©a3
 = "route3";

97 *
rou‹_d©a4
 = "route4";

98 
b¡ršg
 
rou‹0
 = 
	`bäomc¡r
("/");

99 
b¡ršg
 
rou‹1
 = 
	`bäomc¡r
("/users/([0-9]+)");

100 
b¡ršg
 
rou‹2
 = 
	`bäomc¡r
("/users");

101 
b¡ršg
 
rou‹3
 = 
	`bäomc¡r
("/users/people/([0-9]+)$");

102 
b¡ršg
 
rou‹4
 = 
	`bäomc¡r
("/cars-fast/([a-z]-)$");

104 
Rou‹
 *
rou‹
 = 
NULL
;

106 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹0
, 
rou‹_d©a0
);

107 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹1
, 
rou‹_d©a1
);

108 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹2
, 
rou‹_d©a2
);

109 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹3
, 
rou‹_d©a3
);

110 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹4
, 
rou‹_d©a4
);

112 
b¡ršg
 
·th1
 = 
	`bäomc¡r
("/users/1234/testing");

113 
b¡ršg
 
·th2
 = 
	`bäomc¡r
("/users");

114 
b¡ršg
 
·th3
 = 
	`bäomc¡r
("/users/people/1234");

115 
b¡ršg
 
·th4
 = 
	`bäomc¡r
("/cars-fast/cadillac");

116 
b¡ršg
 
·th5
 = 
	`bäomc¡r
("/users/1234");

117 
b¡ršg
 
·th6
 = 
	`bäomc¡r
("/");

118 
b¡ršg
 
·th7
 = 
	`bäomc¡r
("/users/people/1234/notgonnawork");

120 
li¡_t
 *
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th5
);

121 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a1
), "Pattern match„oute wrong.");

122 
	`li¡_de¡roy_nodes
(
found
);

123 
	`li¡_de¡roy
(
found
);

125 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th1
);

126 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a1
), "Pastƒnd„oute wrong.");

127 
	`li¡_de¡roy_nodes
(
found
);

128 
	`li¡_de¡roy
(
found
);

130 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th2
);

131 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a2
), "No…attern„oute wrong.");

132 
	`li¡_de¡roy_nodes
(
found
);

133 
	`li¡_de¡roy
(
found
);

135 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th3
);

136 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a3
), "Wrong $erminated„oute.");

137 
	`li¡_de¡roy_nodes
(
found
);

138 
	`li¡_de¡roy
(
found
);

140 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th4
);

141 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a4
), "Wrong†onger„oute match.");

142 
	`li¡_de¡roy_nodes
(
found
);

143 
	`li¡_de¡roy
(
found
);

145 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th5
);

146 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a1
), "Wrong„oute for /users/1234");

147 
	`li¡_de¡roy_nodes
(
found
);

148 
	`li¡_de¡roy
(
found
);

150 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th6
);

151 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 2, 
rou‹_d©a0
), "Should get„oot /„oute.");

152 
	`li¡_de¡roy_nodes
(
found
);

153 
	`li¡_de¡roy
(
found
);

155 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th7
);

156 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 0, 
NULL
), "Should‚ot match…astƒnd");

157 
	`li¡_de¡roy_nodes
(
found
);

158 
	`li¡_de¡roy
(
found
);

160 
	`bde¡roy
(
·th1
);

161 
	`bde¡roy
(
·th2
);

162 
	`bde¡roy
(
·th3
);

163 
	`bde¡roy
(
·th4
);

164 
	`bde¡roy
(
·th5
);

166 
	`Rou‹M­_de¡roy
(
rou‹s
);

168  
NULL
;

169 
	}
}

172 *
	$‹¡_routšg_m©ch_»v”£d
()

174 
Rou‹M­
 *
rou‹s
 = 
	`Rou‹M­_ü—‹
(
NULL
);

175 
	`mu_as£¹
(
rou‹s
 !ğ
NULL
, "Failedo makehe„oute map.");

176 *
rou‹_d©a1
 = "route1";

177 *
rou‹_d©a2
 = "route2";

178 *
rou‹_d©a3
 = "route3";

179 
b¡ršg
 
rou‹1
 = 
	`bäomc¡r
("foo");

180 
b¡ršg
 
rou‹2
 = 
	`bäomc¡r
("moo");

181 
b¡ršg
 
rou‹3
 = 
	`bäomc¡r
("fio");

183 
Rou‹
 *
rou‹
 = 
NULL
;

185 
	`Rou‹M­_š£¹_»v”£d
(
rou‹s
, 
rou‹1
, 
rou‹_d©a1
);

186 
	`Rou‹M­_š£¹_»v”£d
(
rou‹s
, 
rou‹2
, 
rou‹_d©a2
);

187 
	`Rou‹M­_š£¹_»v”£d
(
rou‹s
, 
rou‹3
, 
rou‹_d©a3
);

189 
b¡ršg
 
·th1
 = 
	`bäomc¡r
("foo");

190 
b¡ršg
 
·th2
 = 
	`bäomc¡r
("moo");

191 
b¡ršg
 
·th3
 = 
	`bäomc¡r
("fio");

193 
rou‹
 = 
	`Rou‹M­_m©ch_suffix
(
rou‹s
, 
·th1
);

194 
	`mu_as£¹
(
rou‹
 !ğ
NULL
, "Pattern match failed.");

195 
	`mu_as£¹
(
rou‹
->
d©a
 =ğ
rou‹_d©a1
, "Pattern matched wrong„oute.");

197 
rou‹
 = 
	`Rou‹M­_m©ch_suffix
(
rou‹s
, 
·th2
);

198 
	`mu_as£¹
(
rou‹
 !ğ
NULL
, "Pattern match failed.");

199 
	`mu_as£¹
(
rou‹
->
d©a
 =ğ
rou‹_d©a2
, "Pattern matched wrong„oute.");

201 
rou‹
 = 
	`Rou‹M­_m©ch_suffix
(
rou‹s
, 
·th3
);

202 
	`mu_as£¹
(
rou‹
 !ğ
NULL
, "Pattern match failed.");

203 
	`mu_as£¹
(
rou‹
->
d©a
 =ğ
rou‹_d©a3
, "Pattern matched wrong„oute.");

205 
	`bde¡roy
(
·th1
);

206 
	`bde¡roy
(
·th2
);

207 
	`bde¡roy
(
·th3
);

209 
	`Rou‹M­_de¡roy
(
rou‹s
);

211  
NULL
;

212 
	}
}

215 * 
	$®l_‹¡s
() {

216 
	`mu_su™e_¡¬t
();

218 
	`mu_run_‹¡
(
‹¡_routšg_m©ch
);

219 
	`mu_run_‹¡
(
‹¡_sim¶e_´efix_m©chšg
);

220 
	`mu_run_‹¡
(
‹¡_routšg_m©ch_»v”£d
);

222  
NULL
;

223 
	}
}

225 
RUN_TESTS
(
®l_‹¡s
);

	@tests/server_tests.c

1 
	~"mšun™.h
"

2 
	~<£rv”.h
>

3 
	~<¡ršg.h
>

4 
	~<sk/sk.h
>

6 *
	$‹¡_S”v”_š™
()

8 
	`mqš™
(1);

9 
	`S”v”_š™
();

11  
NULL
;

12 
	}
}

15 *
	$‹¡_S”v”_ü—‹_de¡roy
()

17 
S”v”
 *
£rv”
 = 
	`S”v”_ü—‹
(

18 
	`bäomc¡r
("uuid"),

19 
	`bäomc¡r
("localhost"),

20 
	`bäomc¡r
("0.0.0.0"),

22 
	`bäomc¡r
("chroot"),

23 
	`bäomc¡r
("access_log"),

24 
	`bäomc¡r
("error_log"),

25 
	`bäomc¡r
("pid_file"), 0);

26 
	`mu_as£¹
(
£rv”
 !ğ
NULL
, "Failedo makehe server, something on 8090?");

28 
	`S”v”_de¡roy
(
£rv”
);

30  
NULL
;

31 
	}
}

34 *
	$‹¡_S”v”_adds
()

36 
rc
 = 0;

38 
S”v”
 *
¤v
 = 
	`S”v”_ü—‹
(

39 
	`bäomc¡r
("uuid"),

40 
	`bäomc¡r
("localhost"),

41 
	`bäomc¡r
("0.0.0.0"),

43 
	`bäomc¡r
("chroot"),

44 
	`bäomc¡r
("access_log"),

45 
	`bäomc¡r
("error_log"),

46 
	`bäomc¡r
("pid_file"), 0);

47 
	`mu_as£¹
(
¤v
 !ğ
NULL
, "Failedo makehe server, something on 8090?");

49 
Ho¡
 *
ho¡
 = 
	`Ho¡_ü—‹
(
	`bäomc¡r
("zedshaw.com"), bfromcstr("zedshaw.com"));

50 
	`mu_as£¹
(
ho¡
 !ğ
NULL
, "Failedo make host.");

52 
rc
 = 
	`S”v”_add_ho¡
(
¤v
, 
ho¡
);

53 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd hosto server.");

55 
	`S”v”_£t_deçuÉ_ho¡
(
¤v
, 
ho¡
);

57 
Ho¡
 *
zedshaw
 = 
	`S”v”_m©ch_back’d
(
¤v
, 
ho¡
->
Çme
);

58 
	`mu_as£¹
(
zedshaw
 =ğ
ho¡
, "Didn't gethe„ight one back.");

60 
	`mu_as£¹
(
	`S”v”_m©ch_back’d
(
¤v
, 
	`bäomc¡r
("NOWAY")è=ğ
ho¡
, "Didn't fall backo default_host");

62 
	`S”v”_de¡roy
(
¤v
);

64  
NULL
;

65 
	}
}

68 *
	$®l_‹¡s
() {

69 
	`mu_su™e_¡¬t
();

71 
	`mu_run_‹¡
(
‹¡_S”v”_š™
);

72 
	`mu_run_‹¡
(
‹¡_S”v”_ü—‹_de¡roy
);

73 
	`mu_run_‹¡
(
‹¡_S”v”_adds
);

74 
	`zmq_‹rm
(
ZMQ_CTX
);

76  
NULL
;

77 
	}
}

79 
RUN_TESTS
(
®l_‹¡s
);

	@tests/setting_tests.c

1 
	~"mšun™.h
"

2 
	~<£‰šg.h
>

4 *
	$‹¡_S‘tšg_add_g‘
()

6 
rc
 = 
	`S‘tšg_add
("TEST1", "2345");

7 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd TEST1");

9 
rc
 = 
	`S‘tšg_add
("TEST2", "Hello");

10 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd TEST2");

12 
b¡ršg
 
t1
 = 
	`S‘tšg_g‘_¡r
("TEST1", 
NULL
);

13 
	`debug
("GÙ1: %s", 
	`bd©a
(
t1
));

14 
	`mu_as£¹
(
t1
 !ğ
NULL
, "Gothe default.");

15 
	`mu_as£¹
(
	`bi£qc¡r
(
t1
, "2345"), "Failedo get TEST1.");

17 
t1_št
 = 
	`S‘tšg_g‘_št
("TEST1", 999);

18 
	`debug
("GÙ %d fÜhTEST1", 
t1_št
);

19 
	`mu_as£¹
(
t1_št
 == 2345, "Wrong value for TEST1‡s int.");

21 
t3_št
 = 
	`S‘tšg_g‘_št
("TEST5", 999);

22 
	`mu_as£¹
(
t3_št
 == 999, "Should gethe default.");

24  
NULL
;

25 
	}
}

27 *
	$‹¡_S‘tšg_de¡roy
()

29 
	`S‘tšg_de¡roy
();

31  
NULL
;

32 
	}
}

34 * 
	$®l_‹¡s
() {

35 
	`mu_su™e_¡¬t
();

37 
	`mu_run_‹¡
(
‹¡_S‘tšg_add_g‘
);

38 
	`mu_run_‹¡
(
‹¡_S‘tšg_de¡roy
);

40  
NULL
;

41 
	}
}

43 
RUN_TESTS
(
®l_‹¡s
);

	@tests/state_tests.c

1 
	~"mšun™.h
"

2 
	~<¡©e.h
>

3 
	~<ev’ts.h
>

4 
	~<¡dšt.h
>

5 
	~"cÚÃùiÚ.h
"

7 
	$‹¡_aùiÚ_cb
(
CÚÃùiÚ
 *
d©a
)

10 
	}
}

12 
S‹AùiÚs
 
	g‹¡_aùiÚs
 = {

13 .
”rÜ
 = 
‹¡_aùiÚ_cb
,

14 .
	gşo£
 = 
‹¡_aùiÚ_cb
,

15 .
	g·r£
 = 
‹¡_aùiÚ_cb
,

16 .
	gid’tify_»que¡
 = 
‹¡_aùiÚ_cb
,

17 .
	g£nd_sock‘_»¥Ú£
 = 
‹¡_aùiÚ_cb
,

18 .
	grou‹_»que¡
 = 
‹¡_aùiÚ_cb
,

19 .
	gmsg_to_hªdËr
 = 
‹¡_aùiÚ_cb
,

20 .
	gh‰p_to_hªdËr
 = 
‹¡_aùiÚ_cb
,

21 .
	gh‰p_to_´oxy
 = 
‹¡_aùiÚ_cb
,

22 .
	gh‰p_to_dœeùÜy
 = 
‹¡_aùiÚ_cb
,

23 .
	g´oxy_d–iv”
 = 
‹¡_aùiÚ_cb
,

24 .
	g´oxy_çed
 = 
‹¡_aùiÚ_cb
,

25 .
	g´oxy_»q_·r£
 = 
‹¡_aùiÚ_cb
,

26 .
	g´oxy_»¶y_·r£
 = 
‹¡_aùiÚ_cb
,

27 .
	g´oxy_şo£
 = 
‹¡_aùiÚ_cb


34 
	$run_ev’ts
(
S‹
 *
¡©e
, cÚ¡ *
Çme
, *
ev’ts
)

36 
i
 = 0;

37 
rc
 = 0;

38 
	`S‹_š™
(
¡©e
, &
‹¡_aùiÚs
);

40 
	`debug
(">>> RUNNING %s", 
Çme
);

42 
i
 = 0; 
ev’ts
[i] != 0; i++) {

43 
rc
 = 
	`S‹_exec
(
¡©e
, 
ev’ts
[
i
], (*)(
šŒ_t
)i);

44 
	`check
(
	`S‹_šv¬ŸÁ
(
¡©e
è!ğ-1, "Faed oÀ´oûssšg %dƒv’t.", 
ev’ts
[
i
]);

47 
	`debug
("<<< FINAL RESULT: %d, fšished: %d", 
rc
, 
	`S‹_šv¬ŸÁ
(
¡©e
));

48  
	`S‹_šv¬ŸÁ
(
¡©e
);

50 
”rÜ
:

52 
	}
}

58 
	#RUN
(
N
, ...èN[] = { 
__VA_ARGS__
, 0 };\

59 
	`mu_as£¹
(
	`run_ev’ts
(&
¡©e
, "TEST " #N, 
N
), "Te¡ " #N " faed.");

	)

64 
	#FAILS
(
N
, ...èN[] = { 
__VA_ARGS__
, 0 };\

65 
	`mu_as£¹
(!
	`run_ev’ts
(&
¡©e
, "TEST " #N, 
N
), "Te¡ " #N " faed.");

	)

67 *
	$‹¡_S‹_msg
()

69 
S‹
 
¡©e
;

72 
	`RUN
(
msg_hªdËr
,

73 
OPEN
,

74 
REQ_RECV
, 
MSG_REQ
, 
HANDLER
, 
REQ_SENT
, 
CLOSE
);

77 
	`RUN
(
sock‘_¡¬t
, 
OPEN
, 
REQ_RECV
, 
SOCKET_REQ
, 
RESP_SENT
, 
CLOSE
);

80 
	`RUN
(
msg_hªdËr_2_»q
,

81 
OPEN
,

82 
REQ_RECV
, 
MSG_REQ
, 
HANDLER
, 
REQ_SENT
,

83 
REQ_RECV
, 
MSG_REQ
, 
HANDLER
, 
REQ_SENT
,

84 
CLOSE
);

87  
NULL
;

88 
	}
}

91 *
	$‹¡_S‹_h‰p
()

93 
S‹
 
¡©e
;

96 
	`RUN
(
h‰p_dœ
,

97 
OPEN
,

98 
REQ_RECV
, 
HTTP_REQ
, 
DIRECTORY
, 
RESP_SENT
, 
CLOSE
);

101 
	`RUN
(
h‰p_hªdËr
,

102 
OPEN
,

103 
REQ_RECV
, 
HTTP_REQ
, 
HANDLER
, 
REQ_SENT
,

104 
REQ_RECV
, 
HTTP_REQ
, 
HANDLER
, 
REQ_SENT
, 
CLOSE
);

108 
	`RUN
(
h‰p_´oxy
,

109 
OPEN
,

110 
REQ_RECV
, 
HTTP_REQ
, 
PROXY
, 
CONNECT
,

111 
REQ_SENT
, 
REQ_RECV
, 
HTTP_REQ
, REQ_SENT, REQ_RECV, 
REMOTE_CLOSE
,

112 
CLOSE
);

116 
	`RUN
(
h‰p_´oxy_hªdËr
,

117 
OPEN
,

118 
REQ_RECV
, 
HTTP_REQ
, 
PROXY
, 
CONNECT
,

119 
REQ_SENT
, 
REQ_RECV
,

120 
HANDLER
, 
REQ_SENT
, 
CLOSE
);

122  
NULL
;

123 
	}
}

126 *
	$‹¡_S‹_exec_”rÜ
()

128 
S‹
 
¡©e
;

131 
	`FAILS
(
çed_´oxy
,

132 
OPEN
,

133 
REQ_RECV
, 
HTTP_REQ
, 
PROXY
, 
CONNECT
, 
CLOSE
);

135  
NULL
;

136 
	}
}

138 * 
	$®l_‹¡s
() {

139 
	`mu_su™e_¡¬t
();

141 
	`mu_run_‹¡
(
‹¡_S‹_exec_”rÜ
);

142 
	`mu_run_‹¡
(
‹¡_S‹_msg
);

143 
	`mu_run_‹¡
(
‹¡_S‹_h‰p
);

145  
NULL
;

146 
	}
}

148 
RUN_TESTS
(
®l_‹¡s
);

	@tests/superpoll_tests.c

1 
	~"mšun™.h
"

2 
	~<as£¹.h
>

3 
	~<mem/h®loc.h
>

5 
	~<su³½Şl.h
>

6 
	~<zmq.h
>

8 
Su³rPŞl
 *
	gTEST_POLL
 = 
NULL
;

15 
	~<¡dlib.h
>

16 
	~<¡dio.h
>

17 
	~<¡ršg.h
>

18 
	~<as£¹.h
>

19 
	~<fú.h
>

20 
	~<”ºo.h
>

21 
	~<uni¡d.h
>

22 
	~<sigÇl.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/pŞl.h
>

26 
	~<sys/ioùl.h
>

27 
	~<sys/time.h
>

28 
	~<sys/mmª.h
>

29 
	~<sys/time.h
>

30 
	~<sys/»sourû.h
>

32 
	~<dbg.h
>

34 
	gdÚe
 = 0;

36 
	#FD_SLOP
 10

	)

37 
	#MAX_FDS
 64*1024

	)

39 
	#READ
 0

	)

40 
	#WRITE
 1

	)

43 
	mfds
[2];

44 } 
	gpefds
[
MAX_FDS
/2];

46 
	gÄ_pes
;

48 
	gÄ_tok’_·s£s
;

49 
	gmax_g’”©iÚ
;

50 
	gmax_th»ads
 = 1;

51 
	gth»ads_com¶‘e
 = 0;

53 
	stok’
 {

54 
	mg’”©iÚ
;

55 
	mtofd
;

56 
	mth»ad
;

59 
	gBUFSIZE
 = (
tok’
);

61 
	sfdšfo
 {

62 
	mz”o
;

64 
	mÚe
;

65 
	mfd
;

66 
	mpe_idx
;

67 
	maùive
:1;

68 
	mrw
:1;

69 *
	mbuf
;

71 } 
	gfdšfo
[
MAX_FDS
];

73 
tok’
 
	g³ndšg_tok’s
[
MAX_FDS
];

74 
	gÄ_³ndšg_tok’s
;

76 
	$»®ly_£nd_toke
(
tok’
 *
toke
)

78 
fdšfo
 *
šf
;

79 *
fds
;

80 
fd
;

81 
pe_idx
 = 
Ä_pes
 - 
toke
->
th»ad
 - 1;

83 
fds
 = 
pefds
[
pe_idx
].fds;

84 
fd
 = 
fds
[
WRITE
];

85 
šf
 = &
fdšfo
[
fd
];

87 
	`debug
("£ndšg oÀpšdex %u, fd %d", 
pe_idx
, 
fd
);

89 
»s
 = 
	`wr™e
(
fds
[
WRITE
], 
toke
, 
BUFSIZE
);

90 
	`debug
("wr™e[%ld %d %d]", 
toke
->
g’”©iÚ
,

91 
toke
->
tofd
,oke->
th»ad
);

92 ià(
»s
 !ğ
BUFSIZE
) {

93 
	`´štf
("wr™ğ%d (%s)", 
»s
, 
	`¡»¼Ü
(
”ºo
));

94 
	`ex™
(1);

96 
	}
}

98 
	$£nd_³ndšg_tokes
()

100 
i
;

101 
i
=0; i<
Ä_³ndšg_tok’s
; i++)

102 
	`»®ly_£nd_toke
(&
³ndšg_tok’s
[
i
]);

103 
Ä_³ndšg_tok’s
 = 0;

104 
	}
}

106 
	$£nd_toke
(
tok’
 *
toke
)

108 
pe_idx
;

109 *
fds
;

111 
pe_idx
 = 
Ä_pes
 - 
toke
->
th»ad
 - 1;

113 
fds
 = 
pefds
[
pe_idx
].fds;

115 
toke
->
tofd
 = 
fds
[
READ
];

116 
	`»®ly_£nd_toke
(
toke
);

117 
	}
}

119 
	$´oûss_tok’
(
fd
, 
tok’
 *
toke
, 
Ä
)

121 ià(
Ä
 !ğ
BUFSIZE
)

122 
	`årštf
(
¡d”r
, "process_token:‚r == %d (vs %d)\n",

123 
Ä
, 
BUFSIZE
);

124 
	`as£¹
(
Ä
 =ğ
BUFSIZE
);

125 
	`as£¹
(
toke
->
tofd
 =ğ
fd
);

126 
Ä_tok’_·s£s
++;

127 
toke
->
g’”©iÚ
++;

129 
	`debug
("·s£d %ld, g’: %ld,ok’_g’: %ld", 
Ä_tok’_·s£s
, 
max_g’”©iÚ
,

130 
toke
->
g’”©iÚ
);

132 ià(
toke
->
g’”©iÚ
 < 
max_g’”©iÚ
)

133 
	`£nd_toke
(
toke
);

135 
	`debug
("th»ad %d com¶‘e, %ld…as£s", 
toke
->
th»ad
, 
Ä_tok’_·s£s
);

136 
th»ads_com¶‘e
++;

137 ià(
th»ads_com¶‘e
 >ğ
max_th»ads
)

138 
dÚe
 = 1;

140 
	}
}

142 
	$»ad_ªd_´oûss_tok’
(
fd
)

144 
tok’
 *
toke
;

145 
fdšfo
 *
šf
 = &fdšfo[
fd
];

146 *
buf
 = 
šf
->buf;

147 
Ä
;

148 
Ä
 = 
	`»ad
(
fd
, 
buf
, 
BUFSIZE
);

149 
	`check
(
Ä
 !ğ-1, "FaedØ»ad from fdh© wa suµo£dly„—dy: %d", 
fd
);

151 
toke
 = (
tok’
 *)
buf
;

153 
Ä
 >ğ
BUFSIZE
) {

154 
	`´oûss_tok’
(
fd
, 
toke
, 
BUFSIZE
);

155 
toke
++;

156 
Ä
 -ğ
BUFSIZE
;

159 
	`check
(
Ä
 == 0, "Didn't writeƒverythigo…ipe.");

163 
”rÜ
:

165 
	}
}

168 
	$mak—pe
(
idx
, 
hÙ
)

170 *
fds
 = 
pefds
[
idx
].fds;

171 
fdšfo
 *
šf
;

172 
i
;

173 
rc
 = 0;

175 
	`check
(
	`pe
(
fds
è=ğ0, "FaedØmakp#%d", 
idx
);

177 
i
=0; i<2; i++) {

178 
æ
 = 
	`fú
(
fds
[
i
], 
F_GETFL
);

179 
æ
 |ğ
O_NONBLOCK
;

180 
	`fú
(
fds
[
i
], 
F_SETFL
, 
æ
);

183 
šf
 = &
fdšfo
[
fds
[
READ
]];

184 
šf
->
buf
 = 
	`ÿÎoc
(1, 
BUFSIZE
);

185 
	`as£¹
(
šf
->
buf
 !ğ
NULL
);

186 
	`as£¹
(
šf
->
aùive
 == 0);

187 
šf
->
aùive
 = 1;

188 
šf
->
rw
 = 
READ
;

189 
šf
->
fd
 = 
fds
[
READ
];

190 
šf
->
pe_idx
 = 
idx
;

192 
rc
 = 
	`Su³rPŞl_add
(
TEST_POLL
, 
NULL
, NULL, 
fds
[
READ
], 'r', 
hÙ
);

193 
	`check
(
rc
 != -1, "Failedo‡dd„ead sideo superpoll.");

195 
šf
 = &
fdšfo
[
fds
[
WRITE
]];

196 
	`as£¹
(
šf
->
aùive
 == 0);

197 
šf
->
aùive
 = 1;

198 
šf
->
rw
 = 
WRITE
;

199 
šf
->
fd
 = 
fds
[
WRITE
];

200 
šf
->
pe_idx
 = 
idx
;

204 
”rÜ
:

206 
	}
}

208 
	$mak•es
(
Ä
, 
hÙ
)

210 
i
;

211 
i
=0; i<
Ä
; i++)

212 
	`mak—pe
(
i
, 
hÙ
);

213 
Ä_pes
 = 
Ä
;

214 
	}
}

217 
	$şo£pes
(
Ä
)

219 
i
 = 0;

220 
i
 = 0; i < 
Ä
; i++) {

221 
	`ä“
(
fdšfo
[
pefds
[
i
].
fds
[
READ
]].
buf
);

222 
	`şo£
(
pefds
[
i
].
fds
[
READ
]);

224 
	`ä“
(
fdšfo
[
pefds
[
i
].
fds
[
WRITE
]].
buf
);

225 
	`şo£
(
pefds
[
i
].
fds
[
WRITE
]);

228 
	`mem£t
(
fdšfo
, 0, (fdinfo));

229 
	`mem£t
(
pefds
, 0, (pipefds));

231 
dÚe
 = 0;

232 
Ä_tok’_·s£s
 = 0;

233 
	}
}

235 
	$run_maš_loİ
(
hÙ
)

237 
i
 = 0;

238 
nfds
 = 0;

239 
rc
 = 0;

240 
PŞlResuÉ
 
»suÉ
;

242 
rc
 = 
	`PŞlResuÉ_š™
(
TEST_POLL
, &
»suÉ
);

243 
	`check
(
rc
 == 0, "Failedo initializehe…oll„esult.");

245 !
dÚe
) {

246 
	`£nd_³ndšg_tokes
();

248 
nfds
 = 
	`Su³rPŞl_pŞl
(
TEST_POLL
, &
»suÉ
, -1);

249 
	`check
(
nfds
 >= 0, "superpoll failed.");

251 
i
 = 0; i < 
nfds
; i++) {

252 ià(
»suÉ
.
h™s
[
i
].
ev
.
»v’ts
 & 
ZMQ_POLLIN
) {

254 if(
	`»ad_ªd_´oûss_tok’
(
»suÉ
.
h™s
[
i
].
ev
.
fd
) == 0) {

255 
rc
 = 
	`Su³rPŞl_add
(
TEST_POLL
, 
NULL
, NULL, 
»suÉ
.
h™s
[
i
].
ev
.
fd
, 'r', 
hÙ
);

261 
	`PŞlResuÉ_ş—n
(&
»suÉ
);

264 
”rÜ
:

265 
	`PŞlResuÉ_ş—n
(&
»suÉ
);

267 
	}
}

269 
	$£edth»ads
(
Ä
)

271 
tok’
 
toke
;

272 
i
;

274 
i
=0; i<
Ä
; i++) {

275 
toke
.
g’”©iÚ
 = 0;

276 
toke
.
th»ad
 = 
i
;

277 
toke
.
tofd
 = -1;

278 
	`£nd_toke
(&
toke
);

280 
	}
}

282 *
	$run_‹¡
(
Ä
, 
th»ads
, 
g’s
, 
hÙ
, *
ç_msg
)

284 
	`debug
("TEST IS: %s", 
ç_msg
);

286 
timev®
 
¡v
, 
‘v
;

287 
u£cs
, 
·s£s_³r_£c
;

288 
rc
 = 0;

289 
FILE
 *
³rf
 = 
NULL
;

291 
	`check
(
Ä
 >ğ
th»ads
, "You can't havehe‚r†esshanhreads.");

293 
max_th»ads
 = 
th»ads
;

294 
max_g’”©iÚ
 = 
g’s
;

296 
³rf
 = 
	`fİ’
("tests/perf.log", "a+");

297 
	`check
(
³rf
, "Failedo openests/perf.log");

298 
pid_t
 
mypid
 = 
	`g‘pid
();

301 
	`årštf
(
³rf
, "% %d %d %d %ld %d ", 
hÙ
 ? "poll" : "epoll",

302 
mypid
, 
Ä
, 
max_th»ads
, 
max_g’”©iÚ
, 
BUFSIZE
);

305 
	`mak•es
(
Ä
, 
hÙ
);

307 
	`£nd_³ndšg_tokes
();

309 
	`g‘timeofday
(&
¡v
, 
NULL
);

311 
	`£edth»ads
(
max_th»ads
);

313 
rc
 = 
	`run_maš_loİ
(
hÙ
);

314 
	`check
(
rc
 =ğ0, "Look likthmaš†oİ faed fÜ '%s'", 
ç_msg
);

316 
	`g‘timeofday
(&
‘v
, 
NULL
);

318 
‘v
.
tv_£c
 -ğ
¡v
.tv_sec;

319 
‘v
.
tv_u£c
 -ğ
¡v
.tv_usec;

321 ià(
‘v
.
tv_u£c
 < 0) {

322 
‘v
.
tv_u£c
 += 1000000;

323 
‘v
.
tv_£c
 -= 1;

326 
	`årštf
(
³rf
, "%ld %ld.%06ld ", 
Ä_tok’_·s£s
, 
‘v
.
tv_£c
, (ëtv.
tv_u£c
);

328 
u£cs
 = 
‘v
.
tv_u£c
 +ƒtv.
tv_£c
 * 1000000LL;

329 if(
u£cs
 == 0) usecs++;

330 
·s£s_³r_£c
 = 
Ä_tok’_·s£s
 * 1000000LL * 100;

331 
·s£s_³r_£c
 /ğ
u£cs
 ;

333 
	`årštf
(
³rf
, "%Ld.%02Ld\n", 
·s£s_³r_£c
 / 100,…asses_per_sec % 100);

335 
	`şo£pes
(
Ä
);

336 
	`fşo£
(
³rf
);

338  
NULL
;

340 
”rÜ
:

341 
	`şo£pes
(
Ä
);

342 if(
³rf
è
	`fşo£
(perf);

343  
ç_msg
;

344 
	}
}

346 *
	$‹¡_maxed_pes_hÙ
()

348  
	`run_‹¡
(50, 50, 50, 1, "max…ipes 1 failed");

349 
	}
}

352 *
	$‹¡_¥¬£_pes_hÙ
()

354  
	`run_‹¡
(50, 5, 50, 1, "sparse…ipes 1 failed");

355 
	}
}

357 *
	$‹¡_midËv–_pes_hÙ
()

359  
	`run_‹¡
(50, 25, 50, 1, "midlevel…ipes failed.");

360 
	}
}

362 *
	$‹¡_maxed_pes_idË
()

364  
	`run_‹¡
(50, 50, 50, 0, "max idle…ipes 1 failed");

365 
	}
}

368 *
	$‹¡_¥¬£_pes_idË
()

370  
	`run_‹¡
(50, 5, 50, 0, "sparse…ipes 1 failed");

371 
	}
}

373 *
	$‹¡_midËv–_pes_idË
()

375  
	`run_‹¡
(50, 25, 50, 0, "midlevel…ipes failed.");

376 
	}
}

378 *
	$‹¡_tÙ®ly_maxed
()

380  
	`run_‹¡
(400, 350, 10, 0, "midlevel…ipes failed.");

381 
	}
}

383 *
	$®l_‹¡s
() {

384 
	`mu_su™e_¡¬t
();

386 
	`Su³rPŞl_g‘_max_fd
();

387 
TEST_POLL
 = 
	`Su³rPŞl_ü—‹
();

389 
	`mu_run_‹¡
(
‹¡_¥¬£_pes_hÙ
);

390 
	`mu_run_‹¡
(
‹¡_maxed_pes_hÙ
);

391 
	`mu_run_‹¡
(
‹¡_midËv–_pes_hÙ
);

393 #ifdeà
__lšux__


394 
	`mu_run_‹¡
(
‹¡_¥¬£_pes_idË
);

395 
	`mu_run_‹¡
(
‹¡_maxed_pes_idË
);

396 
	`mu_run_‹¡
(
‹¡_midËv–_pes_idË
);

397 
	`mu_run_‹¡
(
‹¡_tÙ®ly_maxed
);

400 
	`Su³rPŞl_de¡roy
(
TEST_POLL
);

402  
NULL
;

403 
	}
}

405 
RUN_TESTS
(
®l_‹¡s
);

	@tests/tnetstrings_tests.c

1 
	~"mšun™.h
"

2 
	~<Š‘¡ršgs.h
>

3 
	~<»que¡.h
>

4 
	~<lim™s.h
>

5 
	~<as£¹.h
>

8 *
	$‹¡_Š‘¡ršg_numb”s
()

10 *
»suÉ
;

11 
size_t
 
Ën
;

13 
Šs_v®ue_t
 
max
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = 
LONG_MAX
};

14 
»suÉ
 = 
	`Šs_»nd”
(&
max
, &
Ën
);

15 
	`debug
("GÙ‡†’gth from LONG_MAX of: %d", 
Ën
);

16 
	`mu_as£¹
(
Ën
 == 23 ||†en == 14, "Wrong†ength on LONG_MAX");

17 
	`ä“
(
»suÉ
);

25 
Šs_v®ue_t
 
mšus_Úe
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = -1};

26 
»suÉ
 = 
	`Šs_»nd”
(&
mšus_Úe
, &
Ën
);

27 
	`mu_as£¹
(
Ën
 == 5, "Wrong†ength on -1");

28 
	`ä“
(
»suÉ
);

30  
NULL
;

31 
	}
}

33 *
	$‹¡_Š‘¡ršg_’code
()

35 
size_t
 
Ën
 = 0;

37 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_nuÎ
};

38 *
»suÉ
 = 
	`Šs_»nd”
(&
v®
, &
Ën
);

39 
	`mu_as£¹
(
Ën
 == 3, "Wrong†ength on‚ull.");

40 
	`ä“
(
»suÉ
);

42 
Šs_v®ue_t
 
num
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = 12345};

43 
»suÉ
 = 
	`Šs_»nd”
(&
num
, &
Ën
);

44 
	`mu_as£¹
(
Ën
 == 8, "Wrong†ength on‚umber.");

45 
	`ä“
(
»suÉ
);

47 
b¡ršg
 
d©a
 = 
	`bäomc¡r
("hello");

48 
Šs_v®ue_t
 
¡r
 = {.
ty³
 = 
Šs_g_¡ršg
, .
v®ue
.
¡ršg
 = 
d©a
};

49 
»suÉ
 = 
	`Šs_»nd”
(&
¡r
, &
Ën
);

50 
	`mu_as£¹
(
Ën
 == 8, "Wrong†ength on string.");

51 
	`bde¡roy
(
d©a
);

52 
	`ä“
(
»suÉ
);

54 
Šs_v®ue_t
 
boŞ—n
 = {.
ty³
 = 
Šs_g_boŞ
, .
v®ue
.
boŞ
 = 1};

55 
»suÉ
 = 
	`Šs_»nd”
(&
boŞ—n
, &
Ën
);

56 
	`mu_as£¹
(
Ën
 == 7, "Wrong†ength onrue.");

57 
	`ä“
(
»suÉ
);

59 
boŞ—n
.
v®ue
.
boŞ
 = 0;

60 
»suÉ
 = 
	`Šs_»nd”
(&
boŞ—n
, &
Ën
);

61 
	`mu_as£¹
(
Ën
 == 8, "Wrong†ength on false.");

62 
	`ä“
(
»suÉ
);

64  
NULL
;

65 
	}
}

67 *
	$‹¡_Š‘¡ršg_decode
()

69 
b¡ršg
 
d©a
 = 
	`bäomc¡r
("0:~");

70 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

72 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo get‡rue.");

73 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_nuÎ
, "Wrongype, should be‚ull.");

74 
	`ä“
(
»suÉ
);

76 
	`bassignc¡r
(
d©a
, "4:true!");

77 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

78 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

79 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_boŞ
, "Wrongype, should be bool.");

80 
	`mu_as£¹
(
»suÉ
->
v®ue
.
boŞ
 == 1, "Wrong value, should be 1.");

81 
	`ä“
(
»suÉ
);

83 
	`bassignc¡r
(
d©a
, "5:false!");

84 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

85 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

86 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_boŞ
, "Wrongype, should be bool.");

87 
	`mu_as£¹
(
»suÉ
->
v®ue
.
boŞ
 == 0, "Wrong value, should be 0.");

88 
	`ä“
(
»suÉ
);

90 
	`bassignc¡r
(
d©a
, "5:hello,");

91 
b¡ršg
 
com·»
 = 
	`bäomc¡r
("hello");

92 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

93 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

94 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_¡ršg
, "Wrongype, should be string.");

95 
	`mu_as£¹
(
	`bi£q
(
»suÉ
->
v®ue
.
¡ršg
, 
com·»
), "Wrong value, should be 'hello'.");

96 
	`bde¡roy
(
»suÉ
->
v®ue
.
¡ršg
);

97 
	`ä“
(
»suÉ
);

98 
	`bde¡roy
(
com·»
);

100 
	`bassignc¡r
(
d©a
, "5:12345#");

101 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

102 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

103 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_numb”
, "Wrongype, should be‚umber.");

104 
	`mu_as£¹
(
»suÉ
->
v®ue
.
numb”
 == 12345, "Wrong value, should be 12345.");

105 
	`ä“
(
»suÉ
);

107 
	`bde¡roy
(
d©a
);

109  
NULL
;

110 
	}
}

112 *
	$‹¡_com¶ex_ty³s
()

114 
b¡ršg
 
d©a
 = 
	`bäomc¡r
("16:5:hello,5:12345#}");

115 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

116 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡ dict.");

117 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_diù
, "Wrongype, should be dict.");

119 
size_t
 
Ën
 = 0;

120 *
»nd”ed
 = 
	`Šs_»nd”
((*)
»suÉ
, &
Ën
);

121 
	`mu_as£¹
(
»nd”ed
 !ğ
NULL
, "Failedo„ender dict back.");

122 
	`mu_as£¹
(
	`bi£qc¡r
(
d©a
, 
»nd”ed
), "Round-trip of dict doesn't work.");

123 
	`ä“
(
»nd”ed
);

125 
b¡ršg
 
key
 = 
	`bäomc¡r
("hello");

126 
Šs_v®ue_t
 *
v®
 = 
	`hnode_g‘
(
	`hash_lookup
(
»suÉ
->
v®ue
.
diù
, 
key
));

127 
	`mu_as£¹
(
v®
 !ğ
NULL
, "Should have hello‡s key.");

128 
	`mu_as£¹
(
v®
->
ty³
 =ğ
Šs_g_numb”
, "Value should be‡‚umber.");

129 
	`mu_as£¹
(
v®
->
v®ue
.
numb”
 == 12345, "Value shouldƒqual 12345.");

131 
	`Šs_v®ue_de¡roy
(
»suÉ
);

132 
	`bde¡roy
(
key
);

134 
	`bassignc¡r
(
d©a
, "32:5:hello,5:12345#5:hello,5:56789#]");

135 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

136 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡†ist.");

137 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_li¡
, "Wrongype, should be†ist.");

139 
v®
 = 
	`d¬¿y_g‘
(
»suÉ
->
v®ue
.
li¡
, 
	`d¬¿y_’d
(result->value.list) - 1);

140 
	`mu_as£¹
(
v®
 !ğ
NULL
, "Should have hello‡s key.");

141 
	`mu_as£¹
(
v®
->
ty³
 =ğ
Šs_g_numb”
, "Value should be‡‚umber.");

142 
	`mu_as£¹
(
v®
->
v®ue
.
numb”
 == 56789, "Value shouldƒqual 56789.");

144 
»nd”ed
 = 
	`Šs_»nd”
((*)
»suÉ
, &
Ën
);

145 
	`debug
("RENDERED LIST: %s", 
»nd”ed
);

146 
	`mu_as£¹
(
»nd”ed
 !ğ
NULL
, "Failedo„ender†ist back.");

147 
	`mu_as£¹
(
	`bi£qc¡r
(
d©a
, 
»nd”ed
), "Rendered†ist wrong.");

148 
	`ä“
(
»nd”ed
);

150 
	`Šs_v®ue_de¡roy
(
»suÉ
);

151 
	`bde¡roy
(
d©a
);

154  
NULL
;

155 
	}
}

157 * 
	$®l_‹¡s
() {

158 
	`Reque¡_š™
();

159 
	`mu_su™e_¡¬t
();

161 
	`mu_run_‹¡
(
‹¡_Š‘¡ršg_’code
);

162 
	`mu_run_‹¡
(
‹¡_Š‘¡ršg_decode
);

163 
	`mu_run_‹¡
(
‹¡_Š‘¡ršg_numb”s
);

164 
	`mu_run_‹¡
(
‹¡_com¶ex_ty³s
);

166  
NULL
;

167 
	}
}

169 
RUN_TESTS
(
®l_‹¡s
);

	@tests/tst_tests.c

1 
	~"mšun™.h
"

2 
	~<adt/t¡.h
>

3 
	~<¡ršg.h
>

4 
	~<as£¹.h
>

5 
	~<b¡ršg.h
>

8 
t¡_t
 *
	gnode
 = 
NULL
;

9 *
	gv®ueA
 = "VALUEA";

10 *
	gv®ueB
 = "VALUEB";

11 *
	gv®ue2
 = "VALUE2";

12 *
	gv®ue4
 = "VALUE4";

13 *
	g»v”£
 = "VALUER";

14 
	gŒav”£_couÁ
 = 0;

16 
b¡ršg
 
	g‹¡1
;

17 
b¡ršg
 
	g‹¡2
;

18 
b¡ršg
 
	g‹¡3
;

19 
b¡ršg
 
	g‹¡4
;

21 *
	$‹¡_t¡_š£¹
()

23 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡1
), 
	`bËngth
Ñe¡1), 
v®ueA
);

24 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost.");

26 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡2
), 
	`bËngth
Ñe¡2), 
v®ue2
);

27 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost with second‚ame.");

29 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡3
), 
	`bËngth
Ñe¡3), 
»v”£
);

30 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost with„everse‚ame.");

32 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡4
), 
	`bËngth
Ñe¡4), 
v®ue4
);

33 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost with second‚ame.");

35  
NULL
;

36 
	}
}

38 *
	$‹¡_t¡_£¬ch_exaù
()

41 *
»s
 = 
	`t¡_£¬ch
(
node
, 
	`bd©a
(
‹¡1
), 
	`bËngth
(test1));

42 
	`mu_as£¹
(
»s
 =ğ
v®ueA
, "Gothe wrong value back, should get A‚ot B.");

45 
»s
 = 
	`t¡_£¬ch
(
node
, "TESTNO", 
	`¡¾’
("TESTNO"));

46 
	`mu_as£¹
(
»s
 =ğ
NULL
, "Should‚ot find‡nything.");

48  
NULL
;

49 
	}
}

51 *
	$‹¡_t¡_£¬ch_suffix
()

53 *
»s
 = 
	`t¡_£¬ch_suffix
(
node
, 
	`bd©a
(
‹¡1
), 
	`bËngth
(test1));

54 
	`debug
("»suÉ: %p,ƒx³ùed: %p", 
»s
, 
»v”£
);

55 
	`mu_as£¹
(
»s
 =ğ
»v”£
, "Gothe wrong value.");

57 
»s
 = 
	`t¡_£¬ch_suffix
(
node
, "TESTNO", 
	`¡¾’
("TESTNO"));

58 
	`mu_as£¹
(
»s
 =ğ
NULL
, "Reverse search should find‚othing.");

60 
»s
 = 
	`t¡_£¬ch_suffix
(
node
, "EST", 
	`¡¾’
("EST"));

61 
	`mu_as£¹
(
»s
 !ğ
NULL
, "Reverse search should find byhe suffix.");

63 
»s
 = 
	`t¡_£¬ch_suffix
(
node
, "ESTO", 
	`¡¾’
("ESTO"));

64 
	`mu_as£¹
(
»s
 =ğ
NULL
, "Reverse search should‚ot find invalid suffix.");

66  
NULL
;

67 
	}
}

69 *
	$‹¡_t¡_£¬ch_´efix
()

71 *
»s
 = 
	`t¡_£¬ch_´efix
(
node
, 
	`bd©a
(
‹¡1
), 
	`bËngth
(test1));

72 
	`debug
("»suÉ: %p,ƒx³ùed: %p", 
»s
, 
v®ueA
);

73 
	`mu_as£¹
(
»s
 =ğ
v®ueA
, "Got wrong valueA by…refix.");

75 
»s
 = 
	`t¡_£¬ch_´efix
(
node
, 
	`bd©a
(
‹¡1
), 1);

76 
	`debug
("»suÉ: %p,ƒx³ùed: %p", 
»s
, 
v®ueA
);

77 
	`mu_as£¹
(
»s
 =ğ
v®ue4
, "Got wrong value4 for…refix of 1.");

79 
»s
 = 
	`t¡_£¬ch_´efix
(
node
, "TE", 
	`¡¾’
("TE"));

80 
	`mu_as£¹
(
»s
 !ğ
NULL
, "Should find for short…refix.");

82 
»s
 = 
	`t¡_£¬ch_´efix
(
node
, "TE--", 
	`¡¾’
("TE--"));

83 
	`mu_as£¹
(
»s
 !ğ
NULL
, "Should find for…artial…refix.");

86  
NULL
;

87 
	}
}

89 
	$t¡_Œav”£_‹¡_cb
(*
v®ue
, *
d©a
)

91 
	`as£¹
(
v®ue
 !ğ
NULL
 && "Should‚ot get NULL value.");

92 
	`as£¹
(
d©a
 =ğ
v®ueA
 && "Expecting valueA‡she data.");

93 
Œav”£_couÁ
++;

94 
	}
}

96 *
	$‹¡_t¡_Œav”£
()

98 
Œav”£_couÁ
 = 0;

99 
	`t¡_Œav”£
(
node
, 
t¡_Œav”£_‹¡_cb
, 
v®ueA
);

100 
	`debug
("Œav”£ couÁ is: %d", 
Œav”£_couÁ
);

101 
	`mu_as£¹
(
Œav”£_couÁ
 == 4, "Didn't find 4 keys.");

103  
NULL
;

104 
	}
}

106 *
	$‹¡_t¡_cŞËù
()

108 
li¡_t
 *
found
 = 
	`t¡_cŞËù
(
node
, "TE", 2, 
NULL
);

109 
	`debug
("cŞËù found %d v®ues", ()
	`li¡_couÁ
(
found
));

111 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 3, "Didn't find 2 with…refix TE.");

112 
	`li¡_de¡roy_nodes
(
found
);

113 
	`li¡_de¡roy
(
found
);

115 
found
 = 
	`t¡_cŞËù
(
node
, "T", 1, 
NULL
);

116 
	`debug
("cŞËù found %d v®ues", ()
	`li¡_couÁ
(
found
));

117 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 4, "Didn't find 4 with…refix T.");

118 
	`li¡_de¡roy_nodes
(
found
);

119 
	`li¡_de¡roy
(
found
);

121 
found
 = 
	`t¡_cŞËù
(
node
, "TEST2", 5, 
NULL
);

122 
	`debug
("cŞËù found %d v®ues", ()
	`li¡_couÁ
(
found
));

123 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 1, "Didn't find 1 with…refix TEST2.");

124 
	`li¡_de¡roy_nodes
(
found
);

125 
	`li¡_de¡roy
(
found
);

127 
found
 = 
	`t¡_cŞËù
(
node
, "XNOT", 4, 
NULL
);

128 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 0, "Should‚ot find‡ny with…refix XNOT.");

129 
	`li¡_de¡roy_nodes
(
found
);

130 
	`li¡_de¡roy
(
found
);

132  
NULL
;

133 
	}
}

135 *
	$‹¡_t¡_de¡roy
()

137 
	`t¡_de¡roy
(
node
);

139  
NULL
;

140 
	}
}

142 * 
	$®l_‹¡s
() {

143 
	`mu_su™e_¡¬t
();

145 
‹¡1
 = 
	`bäomc¡r
("TEST");

146 
‹¡2
 = 
	`bäomc¡r
("TEST2");

147 
‹¡3
 = 
	`bäomc¡r
("TSET");

148 
‹¡4
 = 
	`bäomc¡r
("T");

150 
	`mu_run_‹¡
(
‹¡_t¡_š£¹
);

151 
	`mu_run_‹¡
(
‹¡_t¡_£¬ch_exaù
);

152 
	`mu_run_‹¡
(
‹¡_t¡_£¬ch_suffix
);

153 
	`mu_run_‹¡
(
‹¡_t¡_£¬ch_´efix
);

154 
	`mu_run_‹¡
(
‹¡_t¡_Œav”£
);

155 
	`mu_run_‹¡
(
‹¡_t¡_cŞËù
);

156 
	`mu_run_‹¡
(
‹¡_t¡_de¡roy
);

158 
	`bde¡roy
(
‹¡1
);

159 
	`bde¡roy
(
‹¡2
);

160 
	`bde¡roy
(
‹¡3
);

161 
	`bde¡roy
(
‹¡4
);

163  
NULL
;

164 
	}
}

166 
RUN_TESTS
(
®l_‹¡s
);

	@tests/unixy_tests.c

1 
	~"mšun™.h
"

2 
	~<unixy.h
>

3 
	~<uni¡d.h
>

4 
	~<sys/ty³s.h
>

6 *
	$‹¡_Unixy_g‘cwd
()

8 
b¡ršg
 
dœ
 = 
	`Unixy_g‘cwd
();

9 
	`mu_as£¹
(
dœ
 !ğ
NULL
, "getcwd failed.");

10 
	`debug
("CWD is: %s", 
	`bd©a
(
dœ
));

12 
	`bde¡roy
(
dœ
);

13  
NULL
;

14 
	}
}

16 *
	$‹¡_Unixy_chroÙ_çs
()

18 
b¡ršg
 
dœ
 = 
	`Unixy_g‘cwd
();

19 
	`mu_as£¹
(
dœ
 !ğ
NULL
, "can't getcwd in chrootest.");

21 
rc
 = 
	`Unixy_chroÙ
(
dœ
);

22 
	`mu_as£¹
(
rc
 == -1, "We shouldn't be‡bleo chroot unless„unning‡s„oot.");

24 
	`bde¡roy
(
dœ
);

26  
NULL
;

27 
	}
}

29 *
	$‹¡_Unixy_drİ_´iv_çs
()

31 
b¡ršg
 
dœ
 = 
	`Unixy_g‘cwd
();

32 
	`mu_as£¹
(
dœ
 !ğ
NULL
, "can't getcwd in chrootest.");

34 
	`Unixy_drİ_´iv
(
dœ
);

37 
	`bde¡roy
(
dœ
);

38  
NULL
;

39 
	}
}

42 *
	$‹¡_Unixy_pid_fe
()

44 
b¡ršg
 
pid_·th
 = 
	`bäomc¡r
("tests/test.pid");

45 
	`uÆšk
((cÚ¡ *)
pid_·th
->
d©a
);

47 
rc
 = 
	`Unixy_pid_fe
(
pid_·th
);

48 
	`mu_as£¹
(
rc
 == 0, "Failedo make…id file.");

50 
rc
 = 
	`Unixy_pid_fe
(
pid_·th
);

51 
	`mu_as£¹
(
rc
 == -1, "Can't„un it morehan once…er…rocess.");

53 
rc
 = 
	`Unixy_»move_d—d_pidfe
(
pid_·th
);

54 
	`mu_as£¹
(
rc
 == -1, "Should NOT be‡bleo„emovehe PID file while„unning.");

55 
	`bde¡roy
(
pid_·th
);

57  
NULL
;

58 
	}
}

61 * 
	$®l_‹¡s
() {

62 
	`mu_su™e_¡¬t
();

64 
	`mu_run_‹¡
(
‹¡_Unixy_g‘cwd
);

65 if(
	`g‘uid
() != 0) {

66 
	`mu_run_‹¡
(
‹¡_Unixy_chroÙ_çs
);

67 
	`mu_run_‹¡
(
‹¡_Unixy_drİ_´iv_çs
);

69 
	`mu_run_‹¡
(
‹¡_Unixy_pid_fe
);

71  
NULL
;

72 
	}
}

74 
RUN_TESTS
(
®l_‹¡s
);

	@tools/config_modules/null.c

35 
	~<f‹r.h
>

36 
	~<dbg.h
>

37 
	~<cÚfig/moduË.h
>

38 
	~<cÚfig/db.h
>

40 
gb¡ršg
 
	gGOODPATH
 = 
bsStic
("goodpath");

42 
	$cÚfig_š™
(cÚ¡ *
·th
)

44 if(
	`bi£qc¡r
(&
GOODPATH
, 
·th
)) {

45 
	`log_šfo
("Gothe good…ath.");

48 
	`log_šfo
("GÙhbad…©h: %s", 
·th
);

51 
	}
}

53 
	$cÚfig_şo£
()

55 
	}
}

57 
Šs_v®ue_t
 *
	$cÚfig_lßd_hªdËr
(
hªdËr_id
)

59  
NULL
;

60 
	}
}

62 
Šs_v®ue_t
 *
	$cÚfig_lßd_´oxy
(
´oxy_id
)

64  
NULL
;

65 
	}
}

67 
Šs_v®ue_t
 *
	$cÚfig_lßd_dœ
(
dœ_id
)

69  
NULL
;

70 
	}
}

72 
Šs_v®ue_t
 *
	$cÚfig_lßd_rou‹s
(
ho¡_id
, 
£rv”_id
)

74  
NULL
;

75 
	}
}

77 
Šs_v®ue_t
 *
	$cÚfig_lßd_ho¡s
(
£rv”_id
)

79  
NULL
;

80 
	}
}

82 
Šs_v®ue_t
 *
	$cÚfig_lßd_£rv”
(cÚ¡ *
uuid
)

84  
NULL
;

85 
	}
}

88 
Šs_v®ue_t
 *
	$cÚfig_lßd_mim‘y³s
()

90  
NULL
;

91 
	}
}

93 
Šs_v®ue_t
 *
	$cÚfig_lßd_£‰šgs
()

95  
NULL
;

96 
	}
}

	@tools/config_modules/zmq.c

35 
	~<f‹r.h
>

36 
	~<dbg.h
>

37 
	~<cÚfig/moduË.h
>

38 
	~<cÚfig/db.h
>

41 
	$cÚfig_š™
(cÚ¡ *
·th
)

44 
	}
}

46 
	$cÚfig_şo£
()

48 
	}
}

50 
Šs_v®ue_t
 *
	$cÚfig_lßd_hªdËr
(
hªdËr_id
)

52  
NULL
;

53 
	}
}

55 
Šs_v®ue_t
 *
	$cÚfig_lßd_´oxy
(
´oxy_id
)

57  
NULL
;

58 
	}
}

60 
Šs_v®ue_t
 *
	$cÚfig_lßd_dœ
(
dœ_id
)

62  
NULL
;

63 
	}
}

65 
Šs_v®ue_t
 *
	$cÚfig_lßd_rou‹s
(
ho¡_id
, 
£rv”_id
)

67  
NULL
;

68 
	}
}

70 
Šs_v®ue_t
 *
	$cÚfig_lßd_ho¡s
(
£rv”_id
)

72  
NULL
;

73 
	}
}

75 
Šs_v®ue_t
 *
	$cÚfig_lßd_£rv”
(cÚ¡ *
uuid
)

77  
NULL
;

78 
	}
}

81 
Šs_v®ue_t
 *
	$cÚfig_lßd_mim‘y³s
()

83  
NULL
;

84 
	}
}

86 
Šs_v®ue_t
 *
	$cÚfig_lßd_£‰šgs
()

88  
NULL
;

89 
	}
}

	@tools/examples/kegogi/lemon.c

9 
	~<¡dio.h
>

10 
	~<¡d¬g.h
>

11 
	~<¡ršg.h
>

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<as£¹.h
>

16 #iâdeà
__WIN32__


17 #ià
defšed
(
_WIN32
è|| defšed(
WIN32
)

18 
	#__WIN32__


	)

22 #ifdeà
__WIN32__


23 
acûss
();

25 
	~<uni¡d.h
>

29 
	#PRIVATE


	)

31 #ifdeà
TEST


32 
	#MAXRHS
 5

	)

34 
	#MAXRHS
 1000

	)

37 *
msÜt
(*,**,(*)(const *,const *));

44 
	#ËmÚSŒËn
(
X
è(()
	`¡¾’
(X))

	)

46 
aùiÚ
 *
	`AùiÚ_Ãw
();

47 
aùiÚ
 *
	`AùiÚ_sÜt
(action *);

50 
	`FšdRuËP»ûd’ûs
();

51 
	`FšdFœ¡S‘s
();

52 
	`FšdS‹s
();

53 
	`FšdLšks
();

54 
	`FšdFŞlowS‘s
();

55 
	`FšdAùiÚs
();

58 
	`CÚfigli¡_š™
( );

59 
cÚfig
 *
	`CÚfigli¡_add
( );

60 
cÚfig
 *
	`CÚfigli¡_addbasis
( );

61 
	`CÚfigli¡_şosu»
( );

62 
	`CÚfigli¡_sÜt
( );

63 
	`CÚfigli¡_sÜtbasis
( );

64 
cÚfig
 *
	`CÚfigli¡_»tuº
( );

65 
cÚfig
 *
	`CÚfigli¡_basis
( );

66 
	`CÚfigli¡_—t
( );

67 
	`CÚfigli¡_»£t
( );

70 
	`E¼ÜMsg
(const *, ,const *, ...);

73 
	ss_İtiÚs
 {

74 ’um { 
OPT_FLAG
=1, 
OPT_INT
, 
OPT_DBL
, 
OPT_STR
,

75 
OPT_FFLAG
, 
OPT_FINT
, 
OPT_FDBL
, 
OPT_FSTR
} 
ty³
;

76 *
Ïb–
;

77 *
¬g
;

78 *
mes§ge
;

80 
	`O±In™
( );

81 
	`O±NArgs
( );

82 *
	`O±Arg
( );

83 
	`O±E¼
( );

84 
	`O±Pršt
( );

87 
	`P¬£
( );

90 
¶šk
 *
	`Plšk_Ãw
( );

91 
	`Plšk_add
( );

92 
	`Plšk_cİy
( );

93 
	`Plšk_d–‘e
( );

96 
	`R•ršt
( );

97 
	`R•ÜtOuut
( );

98 
	`R•ÜtTabË
( );

99 
	`R•ÜtH—d”
( );

100 
	`Com´essTabËs
( );

101 
	`ResÜtS‹s
( );

104 
	`S‘Size
( );

105 *
	`S‘New
( );

106 
	`S‘F»e
( );

108 
	`S‘Add
( );

109 
	`S‘UniÚ
( );

111 
	#S‘Fšd
(
X
,
Y
è(X[Y]è

	)

118 ’um {
LEMON_FALSE
=0, 
LEMON_TRUE
} 
	tBoŞ—n
;

122 
	ssymbŞ
 {

123 *
Çme
;

124 
šdex
;

126 
TERMINAL
,

127 
NONTERMINAL
,

128 
MULTITERMINAL


129 } 
ty³
;

130 
ruË
 *rule;

131 
symbŞ
 *
çÎback
;

132 
´ec
;

133 
	ee_assoc
 {

134 
LEFT
,

135 
RIGHT
,

136 
NONE
,

137 
UNK


138 } 
assoc
;

139 *
fœ¡£t
;

140 
BoŞ—n
 
Ïmbda
;

141 
u£CÁ
;

142 *
de¡ruùÜ
;

144 
de¡Lš’o
;

145 *
d©©y³
;

147 
dŠum
;

151 
nsubsym
;

152 
symbŞ
 **
subsym
;

157 
	sruË
 {

158 
symbŞ
 *
lhs
;

159 *
lh§lŸs
;

160 
lhsS¹
;

161 
ruËlše
;

162 
Ähs
;

163 
symbŞ
 **
rhs
;

164 **
rh§lŸs
;

165 
lše
;

166 *
code
;

167 
symbŞ
 *
´ecsym
;

168 
šdex
;

169 
BoŞ—n
 
ÿnReduû
;

170 
ruË
 *
Ãxhs
;

171 
ruË
 *
Ãxt
;

179 
	scÚfig
 {

180 
ruË
 *
½
;

181 
dÙ
;

182 *
fws
;

183 
¶šk
 *
åÍ
;

184 
¶šk
 *
b¶p
;

185 
¡©e
 *
¡p
;

187 
COMPLETE
,

188 
INCOMPLETE


189 } 
¡©us
;

190 
cÚfig
 *
Ãxt
;

191 
cÚfig
 *
bp
;

195 
	saùiÚ
 {

196 
symbŞ
 *
¥
;

197 
	ee_aùiÚ
 {

198 
SHIFT
,

199 
ACCEPT
,

200 
REDUCE
,

201 
ERROR
,

202 
SSCONFLICT
,

203 
SRCONFLICT
,

204 
RRCONFLICT
,

205 
SH_RESOLVED
,

206 
RD_RESOLVED
,

207 
NOT_USED


208 } 
ty³
;

210 
¡©e
 *
¡p
;

211 
ruË
 *
½
;

212 } 
x
;

213 
aùiÚ
 *
Ãxt
;

214 
aùiÚ
 *
cŞlide
;

219 
	s¡©e
 {

220 
cÚfig
 *
bp
;

221 
cÚfig
 *
cå
;

222 
¡©’um
;

223 
aùiÚ
 *
­
;

224 
nTknAù
, 
nNtAù
;

225 
iTknOf¡
, 
iNtOf¡
;

226 
iDæt
;

228 
	#NO_OFFSET
 (-2147483647)

	)

233 
	s¶šk
 {

234 
cÚfig
 *
cå
;

235 
¶šk
 *
Ãxt
;

242 
	sËmÚ
 {

243 
¡©e
 **
sÜ‹d
;

244 
ruË
 *rule;

245 
n¡©e
;

246 
ÄuË
;

247 
nsymbŞ
;

248 
Á”mš®
;

249 
symbŞ
 **
symbŞs
;

250 
”rÜút
;

251 
symbŞ
 *
”rsym
;

252 
symbŞ
 *
wdÿrd
;

253 *
Çme
;

254 *
¬g
;

255 *
tok’ty³
;

256 *
v¬ty³
;

257 *
¡¬t
;

258 *
¡acksize
;

259 *
šşude
;

260 *
”rÜ
;

261 *
ov”æow
;

262 *
çu»
;

263 *
acû±
;

264 *
exŒacode
;

265 *
tok’de¡
;

266 *
v¬de¡
;

267 *
f’ame
;

268 *
ouŠame
;

269 *
tok’´efix
;

270 
ncÚæiù
;

271 
bËsize
;

272 
basisæag
;

273 
has_çÎback
;

274 
nŞš’osæag
;

275 *
¬gv0
;

278 
	#MemÜyCheck
(
X
) if((X)==0){ \

279 
	`memÜy_”rÜ
(); \

280 
	`memÜy_”rÜ
(); \

281 
	}

	)
}

298 *
SŒ§ã
();

300 
SŒ§ã_š™
( );

301 
SŒ§ã_š£¹
( );

302 *
SŒ§ã_fšd
( );

306 
symbŞ
 *
SymbŞ_Ãw
();

307 
SymbŞcmµ
( );

308 
SymbŞ_š™
( );

309 
SymbŞ_š£¹
( );

310 
symbŞ
 *
SymbŞ_fšd
( );

311 
symbŞ
 *
SymbŞ_Nth
( );

312 
SymbŞ_couÁ
( );

313 
symbŞ
 **
SymbŞ_¬¿yof
( );

317 
CÚfigcmp
( );

318 
¡©e
 *
S‹_Ãw
();

319 
S‹_š™
( );

320 
S‹_š£¹
( );

321 
¡©e
 *
S‹_fšd
( );

322 
¡©e
 **
S‹_¬¿yof
( );

326 
CÚfigbË_š™
( );

327 
CÚfigbË_š£¹
( );

328 
cÚfig
 *
CÚfigbË_fšd
( );

329 
CÚfigbË_ş—r
( );

336 
aùiÚ
 *
	$AùiÚ_Ãw
(){

337 
aùiÚ
 *
ä“li¡
 = 0;

338 
aùiÚ
 *
Ãw
;

340 ifĞ
ä“li¡
==0 ){

341 
i
;

342 
amt
 = 100;

343 
ä“li¡
 = (
aùiÚ
 *)
	`ÿÎoc
(
amt
, (action));

344 ifĞ
ä“li¡
==0 ){

345 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew…arser‡ction.");

346 
	`ex™
(1);

348 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

349 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

351 
Ãw
 = 
ä“li¡
;

352 
ä“li¡
 = f»–i¡->
Ãxt
;

353  
Ãw
;

354 
	}
}

360 
	$aùiÚcmp
(

361 
aùiÚ
 *
­1
,

362 
aùiÚ
 *
­2


364 
rc
;

365 
rc
 = 
­1
->
¥
->
šdex
 - 
­2
->sp->index;

366 ifĞ
rc
==0 ){

367 
rc
 = ()
­1
->
ty³
 - ()
­2
->type;

369 ifĞ
rc
==0 && 
­1
->
ty³
==
REDUCE
 ){

370 
rc
 = 
­1
->
x
.
½
->
šdex
 - 
­2
->x.rp->index;

372  
rc
;

373 
	}
}

376 
aùiÚ
 *
	$AùiÚ_sÜt
(

377 
aùiÚ
 *
­


379 
­
 = (
aùiÚ
 *)
	`msÜt
((*ïp,(**)&­->
Ãxt
,

380 ((*)(cÚ¡ *,cÚ¡ *))
aùiÚcmp
);

381  
­
;

382 
	}
}

384 
	$AùiÚ_add
(
­p
,
ty³
,
¥
,
¬g
)

385 
aùiÚ
 **
­p
;

386 
e_aùiÚ
 
ty³
;

387 
symbŞ
 *
¥
;

388 *
¬g
;

390 
aùiÚ
 *
Ãw
;

391 
Ãw
 = 
	`AùiÚ_Ãw
();

392 
Ãw
->
Ãxt
 = *
­p
;

393 *
­p
 = 
Ãw
;

394 
Ãw
->
ty³
 =ype;

395 
Ãw
->
¥
 = sp;

396 ifĞ
ty³
==
SHIFT
 ){

397 
Ãw
->
x
.
¡p
 = (
¡©e
 *)
¬g
;

399 
Ãw
->
x
.
½
 = (
ruË
 *)
¬g
;

401 
	}
}

411 
aùb
 
	taùb
;

412 
	saùb
 {

413 
	mnAùiÚ
;

414 
	mnAùiÚAÎoc
;

416 
	mlookah—d
;

417 
	maùiÚ
;

418 } *
	maAùiÚ
,

419 *
	maLookah—d
;

420 
	mmnLookah—d
;

421 
	mmnAùiÚ
;

422 
	mmxLookah—d
;

423 
	mnLookah—d
;

424 
	mnLookah—dAÎoc
;

428 
	#aùb_size
(
X
è((X)->
nAùiÚ
)

	)

431 
	#aùb_yyaùiÚ
(
X
,
N
è((X)->
aAùiÚ
[N].
aùiÚ
)

	)

434 
	#aùb_yylookah—d
(
X
,
N
è((X)->
aAùiÚ
[N].
lookah—d
)

	)

437 
	$aùb_ä“
(
aùb
 *
p
){

438 
	`ä“
Ğ
p
->
aAùiÚ
 );

439 
	`ä“
Ğ
p
->
aLookah—d
 );

440 
	`ä“
Ğ
p
 );

441 
	}
}

444 
aùb
 *
	$aùb_®loc
(){

445 
aùb
 *
p
 = 
	`ÿÎoc
( 1, (*p) );

446 ifĞ
p
==0 ){

447 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew‡cttab.");

448 
	`ex™
(1);

450 
	`mem£t
(
p
, 0, (*p));

451  
p
;

452 
	}
}

456 
	$aùb_aùiÚ
(
aùb
 *
p
, 
lookah—d
, 
aùiÚ
){

457 ifĞ
p
->
nLookah—d
>õ->
nLookah—dAÎoc
 ){

458 
p
->
nLookah—dAÎoc
 += 25;

459 
p
->
aLookah—d
 = 
	`»®loc
(…->aLookahead,

460 (
p
->
aLookah—d
[0])*p->
nLookah—dAÎoc
 );

461 ifĞ
p
->
aLookah—d
==0 ){

462 
	`årštf
(
¡d”r
,"malloc failed\n");

463 
	`ex™
(1);

466 ifĞ
p
->
nLookah—d
==0 ){

467 
p
->
mxLookah—d
 = 
lookah—d
;

468 
p
->
mnLookah—d
 = 
lookah—d
;

469 
p
->
mnAùiÚ
 = 
aùiÚ
;

471 ifĞ
p
->
mxLookah—d
<
lookah—d
 )…->mxLookahead =†ookahead;

472 ifĞ
p
->
mnLookah—d
>
lookah—d
 ){

473 
p
->
mnLookah—d
 = 
lookah—d
;

474 
p
->
mnAùiÚ
 = 
aùiÚ
;

477 
p
->
aLookah—d
[p->
nLookah—d
].
lookah—d
 =†ookahead;

478 
p
->
aLookah—d
[p->
nLookah—d
].
aùiÚ
 =‡ction;

479 
p
->
nLookah—d
++;

480 
	}
}

489 
	$aùb_š£¹
(
aùb
 *
p
){

490 
i
, 
j
, 
k
, 
n
;

491 
	`as£¹
Ğ
p
->
nLookah—d
>0 );

497 
n
 = 
p
->
mxLookah—d
 + 1;

498 ifĞ
p
->
nAùiÚ
 + 
n
 >ğp->
nAùiÚAÎoc
 ){

499 
ŞdAÎoc
 = 
p
->
nAùiÚAÎoc
;

500 
p
->
nAùiÚAÎoc
 =…->
nAùiÚ
 + 
n
 +…->nActionAlloc + 20;

501 
p
->
aAùiÚ
 = 
	`»®loc
(…->aAction,

502 (
p
->
aAùiÚ
[0])*p->
nAùiÚAÎoc
);

503 ifĞ
p
->
aAùiÚ
==0 ){

504 
	`årštf
(
¡d”r
,"malloc failed\n");

505 
	`ex™
(1);

507 
i
=
ŞdAÎoc
; i<
p
->
nAùiÚAÎoc
; i++){

508 
p
->
aAùiÚ
[
i
].
lookah—d
 = -1;

509 
p
->
aAùiÚ
[
i
].
aùiÚ
 = -1;

520 
i
=0; i<
p
->
nAùiÚ
+p->
mnLookah—d
; i++){

521 ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
<0 ){

522 
j
=0; j<
p
->
nLookah—d
; j++){

523 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

524 ifĞ
k
<0 ) ;

525 ifĞ
p
->
aAùiÚ
[
k
].
lookah—d
>=0 ) ;

527 ifĞ
j
<
p
->
nLookah—d
 ) ;

528 
j
=0; j<
p
->
nAùiÚ
; j++){

529 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) ;

531 ifĞ
j
==
p
->
nAùiÚ
 ){

534 }ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
=õ->
mnLookah—d
 ){

535 ifĞ
p
->
aAùiÚ
[
i
].
aùiÚ
!õ->
mnAùiÚ
 ) ;

536 
j
=0; j<
p
->
nLookah—d
; j++){

537 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

538 ifĞ
k
<0 || k>=
p
->
nAùiÚ
 ) ;

539 ifĞ
p
->
aLookah—d
[
j
].
lookah—d
!õ->
aAùiÚ
[
k
].lookahead ) ;

540 ifĞ
p
->
aLookah—d
[
j
].
aùiÚ
!õ->
aAùiÚ
[
k
].action ) ;

542 ifĞ
j
<
p
->
nLookah—d
 ) ;

543 
n
 = 0;

544 
j
=0; j<
p
->
nAùiÚ
; j++){

545 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
<0 ) ;

546 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) 
n
++;

548 ifĞ
n
==
p
->
nLookah—d
 ){

554 
j
=0; j<
p
->
nLookah—d
; j++){

555 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

556 
p
->
aAùiÚ
[
k
] =…->
aLookah—d
[
j
];

557 ifĞ
k
>=
p
->
nAùiÚ
 )…->nAction = k+1;

559 
p
->
nLookah—d
 = 0;

563  
i
 - 
p
->
mnLookah—d
;

564 
	}
}

581 
	$FšdRuËP»ûd’ûs
(
xp
)

582 
ËmÚ
 *
xp
;

584 
ruË
 *
½
;

585 
½
=
xp
->
ruË
;„p;„pôp->
Ãxt
){

586 ifĞ
½
->
´ecsym
==0 ){

587 
i
, 
j
;

588 
i
=0; i<
½
->
Ähs
 &&„p->
´ecsym
==0; i++){

589 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

590 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

591 
j
=0; j<
¥
->
nsubsym
; j++){

592 ifĞ
¥
->
subsym
[
j
]->
´ec
>=0 ){

593 
½
->
´ecsym
 = 
¥
->
subsym
[
j
];

597 }ifĞ
¥
->
´ec
>=0 ){

598 
½
->
´ecsym
 =„p->
rhs
[
i
];

604 
	}
}

611 
	$FšdFœ¡S‘s
(
Ëmp
)

612 
ËmÚ
 *
Ëmp
;

614 
i
, 
j
;

615 
ruË
 *
½
;

616 
´og»ss
;

618 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

619 
Ëmp
->
symbŞs
[
i
]->
Ïmbda
 = 
LEMON_FALSE
;

621 
i
=
Ëmp
->
Á”mš®
; i<Ëmp->
nsymbŞ
; i++){

622 
Ëmp
->
symbŞs
[
i
]->
fœ¡£t
 = 
	`S‘New
();

627 
´og»ss
 = 0;

628 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

629 ifĞ
½
->
lhs
->
Ïmbda
 ) ;

630 
i
=0; i<
½
->
Ähs
; i++){

631 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

632 ifĞ
¥
->
ty³
!=
TERMINAL
 || sp->
Ïmbda
==
LEMON_FALSE
 ) ;

634 ifĞ
i
==
½
->
Ähs
 ){

635 
½
->
lhs
->
Ïmbda
 = 
LEMON_TRUE
;

636 
´og»ss
 = 1;

639 } 
´og»ss
 );

643 
symbŞ
 *
s1
, *
s2
;

644 
´og»ss
 = 0;

645 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

646 
s1
 = 
½
->
lhs
;

647 
i
=0; i<
½
->
Ähs
; i++){

648 
s2
 = 
½
->
rhs
[
i
];

649 ifĞ
s2
->
ty³
==
TERMINAL
 ){

650 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
šdex
);

652 }ifĞ
s2
->
ty³
==
MULTITERMINAL
 ){

653 
j
=0; j<
s2
->
nsubsym
; j++){

654 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
subsym
[
j
]->
šdex
);

657 }ifĞ
s1
==
s2
 ){

658 ifĞ
s1
->
Ïmbda
==
LEMON_FALSE
 ) ;

660 
´og»ss
 +ğ
	`S‘UniÚ
(
s1
->
fœ¡£t
,
s2
->firstset);

661 ifĞ
s2
->
Ïmbda
==
LEMON_FALSE
 ) ;

665 } 
´og»ss
 );

667 
	}
}

673 
PRIVATE
 
¡©e
 *
g‘¡©e
( );

674 
	$FšdS‹s
(
Ëmp
)

675 
ËmÚ
 *
Ëmp
;

677 
symbŞ
 *
¥
;

678 
ruË
 *
½
;

680 
	`CÚfigli¡_š™
();

683 ifĞ
Ëmp
->
¡¬t
 ){

684 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

685 ifĞ
¥
==0 ){

686 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

687 "Th¥ecif›d s¹ symbŞ \"%s\" i nÙ \
‡‚Ú‹rmš® oàthg¿mm¬. \"%s\" wÈbu£d‡ th¡¬ˆ\
 in¡—d.",
Ëmp
->
¡¬t
,Ëmp->
ruË
->
lhs
->
Çme
);

690 
Ëmp
->
”rÜút
++;

691 
¥
 = 
Ëmp
->
ruË
->
lhs
;

694 
¥
 = 
Ëmp
->
ruË
->
lhs
;

700 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

701 
i
;

702 
i
=0; i<
½
->
Ähs
; i++){

703 ifĞ
½
->
rhs
[
i
]==
¥
 ){

704 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

705 "Th¡¬ˆsymbŞ \"%s\" occur Úh\
-hªd sidoà¨ruË. Thi wÈ»suÉ iÀ¨·r£¸which \
‚Ù wÜk…rİ”ly.",
¥
->
Çme
);

708 
Ëmp
->
”rÜút
++;

716 
½
=
¥
->
ruË
;„p;„pôp->
Ãxhs
){

717 
cÚfig
 *
Ãwcå
;

718 
½
->
lhsS¹
 = 1;

719 
Ãwcå
 = 
	`CÚfigli¡_addbasis
(
½
,0);

720 
	`S‘Add
(
Ãwcå
->
fws
,0);

726 ()
	`g‘¡©e
(
Ëmp
);

728 
	}
}

733 
PRIVATE
 
budshiás
( );

734 
PRIVATE
 
¡©e
 *
	$g‘¡©e
(
Ëmp
)

735 
ËmÚ
 *
Ëmp
;

737 
cÚfig
 *
cå
, *
bp
;

738 
¡©e
 *
¡p
;

742 
	`CÚfigli¡_sÜtbasis
();

743 
bp
 = 
	`CÚfigli¡_basis
();

746 
¡p
 = 
	`S‹_fšd
(
bp
);

747 ifĞ
¡p
 ){

751 
cÚfig
 *
x
, *
y
;

752 
x
=
bp
, 
y
=
¡p
->bp; x && y; x=x->bp, y=y->bp){

753 
	`Plšk_cİy
(&
y
->
b¶p
,
x
->bplp);

754 
	`Plšk_d–‘e
(
x
->
åÍ
);

755 
x
->
åÍ
 = x->
b¶p
 = 0;

757 
cå
 = 
	`CÚfigli¡_»tuº
();

758 
	`CÚfigli¡_—t
(
cå
);

761 
	`CÚfigli¡_şosu»
(
Ëmp
);

762 
	`CÚfigli¡_sÜt
();

763 
cå
 = 
	`CÚfigli¡_»tuº
();

764 
¡p
 = 
	`S‹_Ãw
();

765 
	`MemÜyCheck
(
¡p
);

766 
¡p
->
bp
 = bp;

767 
¡p
->
cå
 = cfp;

768 
¡p
->
¡©’um
 = 
Ëmp
->
n¡©e
++;

769 
¡p
->
­
 = 0;

770 
	`S‹_š£¹
(
¡p
,¡p->
bp
);

771 
	`budshiás
(
Ëmp
,
¡p
);

773  
¡p
;

774 
	}
}

779 
	$§me_symbŞ
(
a
,
b
)

780 
symbŞ
 *
a
;

781 
symbŞ
 *
b
;

783 
i
;

784 ifĞ
a
==
b
 )  1;

785 ifĞ
a
->
ty³
!=
MULTITERMINAL
 )  0;

786 ifĞ
b
->
ty³
!=
MULTITERMINAL
 )  0;

787 ifĞ
a
->
nsubsym
!=
b
->nsubsym )  0;

788 
i
=0; i<
a
->
nsubsym
; i++){

789 ifĞ
a
->
subsym
[
i
]!=
b
->subsym[i] )  0;

792 
	}
}

797 
PRIVATE
 
	$budshiás
(
Ëmp
,
¡p
)

798 
ËmÚ
 *
Ëmp
;

799 
¡©e
 *
¡p
;

801 
cÚfig
 *
cå
;

802 
cÚfig
 *
bcå
;

803 
cÚfig
 *
Ãw
;

804 
symbŞ
 *
¥
;

805 
symbŞ
 *
b¥
;

806 
¡©e
 *
Ãw¡p
;

810 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
ècå->
¡©us
 = 
INCOMPLETE
;

813 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

814 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

815 ifĞ
cå
->
dÙ
>=cå->
½
->
Ähs
 ) ;

816 
	`CÚfigli¡_»£t
();

817 
¥
 = 
cå
->
½
->
rhs
[cå->
dÙ
];

822 
bcå
=
cå
; bcå; bcå=bcå->
Ãxt
){

823 ifĞ
bcå
->
¡©us
==
COMPLETE
 ) ;

824 ifĞ
bcå
->
dÙ
>=bcå->
½
->
Ähs
 ) ;

825 
b¥
 = 
bcå
->
½
->
rhs
[bcå->
dÙ
];

826 ifĞ!
	`§me_symbŞ
(
b¥
,
¥
) ) ;

827 
bcå
->
¡©us
 = 
COMPLETE
;

828 
Ãw
 = 
	`CÚfigli¡_addbasis
(
bcå
->
½
,bcå->
dÙ
+1);

829 
	`Plšk_add
(&
Ãw
->
b¶p
,
bcå
);

834 
Ãw¡p
 = 
	`g‘¡©e
(
Ëmp
);

838 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

839 
i
;

840 
i
=0; i<
¥
->
nsubsym
; i++){

841 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
->
subsym
[
i
],(*)
Ãw¡p
);

844 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
,(*)
Ãw¡p
);

847 
	}
}

852 
	$FšdLšks
(
Ëmp
)

853 
ËmÚ
 *
Ëmp
;

855 
i
;

856 
cÚfig
 *
cå
, *
Ùh”
;

857 
¡©e
 *
¡p
;

858 
¶šk
 *
¶p
;

863 
i
=0; i<
Ëmp
->
n¡©e
; i++){

864 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

865 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

866 
cå
->
¡p
 = stp;

872 
i
=0; i<
Ëmp
->
n¡©e
; i++){

873 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

874 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

875 
¶p
=
cå
->
b¶p
;…Í;…ÍõÍ->
Ãxt
){

876 
Ùh”
 = 
¶p
->
cå
;

877 
	`Plšk_add
(&
Ùh”
->
åÍ
,
cå
);

881 
	}
}

888 
	$FšdFŞlowS‘s
(
Ëmp
)

889 
ËmÚ
 *
Ëmp
;

891 
i
;

892 
cÚfig
 *
cå
;

893 
¶šk
 *
¶p
;

894 
´og»ss
;

895 
chªge
;

897 
i
=0; i<
Ëmp
->
n¡©e
; i++){

898 
cå
=
Ëmp
->
sÜ‹d
[
i
]->cå; cå; cå=cå->
Ãxt
){

899 
cå
->
¡©us
 = 
INCOMPLETE
;

904 
´og»ss
 = 0;

905 
i
=0; i<
Ëmp
->
n¡©e
; i++){

906 
cå
=
Ëmp
->
sÜ‹d
[
i
]->cå; cå; cå=cå->
Ãxt
){

907 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

908 
¶p
=
cå
->
åÍ
;…Í;…ÍõÍ->
Ãxt
){

909 
chªge
 = 
	`S‘UniÚ
(
¶p
->
cå
->
fws
,cfp->fws);

910 ifĞ
chªge
 ){

911 
¶p
->
cå
->
¡©us
 = 
INCOMPLETE
;

912 
´og»ss
 = 1;

915 
cå
->
¡©us
 = 
COMPLETE
;

918 } 
´og»ss
 );

919 
	}
}

921 
»sŞve_cÚæiù
();

925 
	$FšdAùiÚs
(
Ëmp
)

926 
ËmÚ
 *
Ëmp
;

928 
i
,
j
;

929 
cÚfig
 *
cå
;

930 
¡©e
 *
¡p
;

931 
symbŞ
 *
¥
;

932 
ruË
 *
½
;

938 
i
=0; i<
Ëmp
->
n¡©e
; i++){

939 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

940 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

941 ifĞ
cå
->
½
->
Ähs
==cå->
dÙ
 ){

942 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

943 ifĞ
	`S‘Fšd
(
cå
->
fws
,
j
) ){

946 
	`AùiÚ_add
(&
¡p
->
­
,
REDUCE
,
Ëmp
->
symbŞs
[
j
],(*)
cå
->
½
);

954 ifĞ
Ëmp
->
¡¬t
 ){

955 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

956 ifĞ
¥
==0 ) s°ğ
Ëmp
->
ruË
->
lhs
;

958 
¥
 = 
Ëmp
->
ruË
->
lhs
;

963 
	`AùiÚ_add
(&
Ëmp
->
sÜ‹d
[0]->
­
,
ACCEPT
,
¥
,0);

966 
i
=0; i<
Ëmp
->
n¡©e
; i++){

967 
aùiÚ
 *
­
, *
Çp
;

968 
¡©e
 *
¡p
;

969 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

971 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

972 
­
=
¡p
->­;‡°&&‡p->
Ãxt
;‡p=ap->next){

973 
Çp
=
­
->
Ãxt
;‚­ &&‚­->
¥
==ap->sp;‚ap=nap->next){

976 
Ëmp
->
ncÚæiù
 +ğ
	`»sŞve_cÚæiù
(
­
,
Çp
,Ëmp->
”rsym
);

982 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
è½->
ÿnReduû
 = 
LEMON_FALSE
;

983 
i
=0; i<
Ëmp
->
n¡©e
; i++){

984 
aùiÚ
 *
­
;

985 
­
=
Ëmp
->
sÜ‹d
[
i
]->­;‡p;‡p÷p->
Ãxt
){

986 ifĞ
­
->
ty³
==
REDUCE
 )‡p->
x
.
½
->
ÿnReduû
 = 
LEMON_TRUE
;

989 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

990 ifĞ
½
->
ÿnReduû
 ) ;

991 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,"This„ule can‚ot be„educed.\n");

992 
Ëmp
->
”rÜút
++;

994 
	}
}

1009 
	$»sŞve_cÚæiù
(
­x
,
­y
,
”rsym
)

1010 
aùiÚ
 *
­x
;

1011 
aùiÚ
 *
­y
;

1012 
symbŞ
 *
”rsym
;

1014 
symbŞ
 *
¥x
, *
¥y
;

1015 
”rút
 = 0;

1016 
	`as£¹
Ğ
­x
->
¥
==
­y
->sp );

1017 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->type==SHIFT ){

1018 
­y
->
ty³
 = 
SSCONFLICT
;

1019 
”rút
++;

1021 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->ty³==
REDUCE
 ){

1022 
¥x
 = 
­x
->
¥
;

1023 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1024 ifĞ
¥y
==0 || 
¥x
->
´ec
<0 || spy->prec<0 ){

1026 
­y
->
ty³
 = 
SRCONFLICT
;

1027 
”rút
++;

1028 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1029 
­y
->
ty³
 = 
RD_RESOLVED
;

1030 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1031 
­x
->
ty³
 = 
SH_RESOLVED
;

1032 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
RIGHT
 ){

1033 
­y
->
ty³
 = 
RD_RESOLVED
;

1034 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
LEFT
 ){

1035 
­x
->
ty³
 = 
SH_RESOLVED
;

1037 
	`as£¹
Ğ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
NONE
 );

1038 
­y
->
ty³
 = 
SRCONFLICT
;

1039 
”rút
++;

1041 }ifĞ
­x
->
ty³
==
REDUCE
 && 
­y
->type==REDUCE ){

1042 
¥x
 = 
­x
->
x
.
½
->
´ecsym
;

1043 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1044 ifĞ
¥x
==0 || 
¥y
==0 || spx->
´ec
<0 ||

1045 
¥y
->
´ec
<0 || 
¥x
->prec==spy->prec ){

1046 
­y
->
ty³
 = 
RRCONFLICT
;

1047 
”rút
++;

1048 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1049 
­y
->
ty³
 = 
RD_RESOLVED
;

1050 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1051 
­x
->
ty³
 = 
RD_RESOLVED
;

1054 
	`as£¹
(

1055 
­x
->
ty³
==
SH_RESOLVED
 ||

1056 
­x
->
ty³
==
RD_RESOLVED
 ||

1057 
­x
->
ty³
==
SSCONFLICT
 ||

1058 
­x
->
ty³
==
SRCONFLICT
 ||

1059 
­x
->
ty³
==
RRCONFLICT
 ||

1060 
­y
->
ty³
==
SH_RESOLVED
 ||

1061 
­y
->
ty³
==
RD_RESOLVED
 ||

1062 
­y
->
ty³
==
SSCONFLICT
 ||

1063 
­y
->
ty³
==
SRCONFLICT
 ||

1064 
­y
->
ty³
==
RRCONFLICT


1070  
”rút
;

1071 
	}
}

1078 
cÚfig
 *
	gä“li¡
 = 0;

1079 
cÚfig
 *
	gcu¼’t
 = 0;

1080 
cÚfig
 **
	gcu¼’‹nd
 = 0;

1081 
cÚfig
 *
	gbasis
 = 0;

1082 
cÚfig
 **
	gbasi£nd
 = 0;

1085 
PRIVATE
 
cÚfig
 *
	$ÃwcÚfig
(){

1086 
cÚfig
 *
Ãw
;

1087 ifĞ
ä“li¡
==0 ){

1088 
i
;

1089 
amt
 = 3;

1090 
ä“li¡
 = (
cÚfig
 *)
	`ÿÎoc
Ğ
amt
, (config) );

1091 ifĞ
ä“li¡
==0 ){

1092 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew configuration.");

1093 
	`ex™
(1);

1095 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

1096 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

1098 
Ãw
 = 
ä“li¡
;

1099 
ä“li¡
 = f»–i¡->
Ãxt
;

1100  
Ãw
;

1101 
	}
}

1104 
PRIVATE
 
	$d–‘ecÚfig
(
Şd
)

1105 
cÚfig
 *
Şd
;

1107 
Şd
->
Ãxt
 = 
ä“li¡
;

1108 
ä“li¡
 = 
Şd
;

1109 
	}
}

1112 
	$CÚfigli¡_š™
(){

1113 
cu¼’t
 = 0;

1114 
cu¼’‹nd
 = &
cu¼’t
;

1115 
basis
 = 0;

1116 
basi£nd
 = &
basis
;

1117 
	`CÚfigbË_š™
();

1119 
	}
}

1122 
	$CÚfigli¡_»£t
(){

1123 
cu¼’t
 = 0;

1124 
cu¼’‹nd
 = &
cu¼’t
;

1125 
basis
 = 0;

1126 
basi£nd
 = &
basis
;

1127 
	`CÚfigbË_ş—r
(0);

1129 
	}
}

1132 
cÚfig
 *
	$CÚfigli¡_add
(
½
,
dÙ
)

1133 
ruË
 *
½
;

1134 
dÙ
;

1136 
cÚfig
 *
cå
, 
mod–
;

1138 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1139 
mod–
.
½
 =„p;

1140 
mod–
.
dÙ
 = dot;

1141 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1142 ifĞ
cå
==0 ){

1143 
cå
 = 
	`ÃwcÚfig
();

1144 
cå
->
½
 =„p;

1145 
cå
->
dÙ
 = dot;

1146 
cå
->
fws
 = 
	`S‘New
();

1147 
cå
->
¡p
 = 0;

1148 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1149 
cå
->
Ãxt
 = 0;

1150 
cå
->
bp
 = 0;

1151 *
cu¼’‹nd
 = 
cå
;

1152 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1153 
	`CÚfigbË_š£¹
(
cå
);

1155  
cå
;

1156 
	}
}

1159 
cÚfig
 *
	$CÚfigli¡_addbasis
(
½
,
dÙ
)

1160 
ruË
 *
½
;

1161 
dÙ
;

1163 
cÚfig
 *
cå
, 
mod–
;

1165 
	`as£¹
Ğ
basi£nd
!=0 );

1166 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1167 
mod–
.
½
 =„p;

1168 
mod–
.
dÙ
 = dot;

1169 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1170 ifĞ
cå
==0 ){

1171 
cå
 = 
	`ÃwcÚfig
();

1172 
cå
->
½
 =„p;

1173 
cå
->
dÙ
 = dot;

1174 
cå
->
fws
 = 
	`S‘New
();

1175 
cå
->
¡p
 = 0;

1176 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1177 
cå
->
Ãxt
 = 0;

1178 
cå
->
bp
 = 0;

1179 *
cu¼’‹nd
 = 
cå
;

1180 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1181 *
basi£nd
 = 
cå
;

1182 
basi£nd
 = &
cå
->
bp
;

1183 
	`CÚfigbË_š£¹
(
cå
);

1185  
cå
;

1186 
	}
}

1189 
	$CÚfigli¡_şosu»
(
Ëmp
)

1190 
ËmÚ
 *
Ëmp
;

1192 
cÚfig
 *
cå
, *
Ãwcå
;

1193 
ruË
 *
½
, *
Ãw½
;

1194 
symbŞ
 *
¥
, *
x¥
;

1195 
i
, 
dÙ
;

1197 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1198 
cå
=
cu¼’t
; cå; cå=cå->
Ãxt
){

1199 
½
 = 
cå
->rp;

1200 
dÙ
 = 
cå
->dot;

1201 ifĞ
dÙ
>=
½
->
Ähs
 ) ;

1202 
¥
 = 
½
->
rhs
[
dÙ
];

1203 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

1204 ifĞ
¥
->
ruË
==0 && sp!=
Ëmp
->
”rsym
 ){

1205 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
lše
,"Nonterminal \"%s\" has‚o„ules.",

1206 
¥
->
Çme
);

1207 
Ëmp
->
”rÜút
++;

1209 
Ãw½
=
¥
->
ruË
;‚ew½;‚ew½òew½->
Ãxhs
){

1210 
Ãwcå
 = 
	`CÚfigli¡_add
(
Ãw½
,0);

1211 
i
=
dÙ
+1; i<
½
->
Ähs
; i++){

1212 
x¥
 = 
½
->
rhs
[
i
];

1213 ifĞ
x¥
->
ty³
==
TERMINAL
 ){

1214 
	`S‘Add
(
Ãwcå
->
fws
,
x¥
->
šdex
);

1216 }ifĞ
x¥
->
ty³
==
MULTITERMINAL
 ){

1217 
k
;

1218 
k
=0; k<
x¥
->
nsubsym
; k++){

1219 
	`S‘Add
(
Ãwcå
->
fws
, 
x¥
->
subsym
[
k
]->
šdex
);

1223 
	`S‘UniÚ
(
Ãwcå
->
fws
,
x¥
->
fœ¡£t
);

1224 ifĞ
x¥
->
Ïmbda
==
LEMON_FALSE
 ) ;

1227 ifĞ
i
==
½
->
Ähs
 ) 
	`Plšk_add
(&
cå
->
åÍ
,
Ãwcå
);

1232 
	}
}

1235 
	$CÚfigli¡_sÜt
(){

1236 
cu¼’t
 = (
cÚfig
 *)
	`msÜt
((*)cu¼’t,(**)&(cu¼’t->
Ãxt
),
CÚfigcmp
);

1237 
cu¼’‹nd
 = 0;

1239 
	}
}

1242 
	$CÚfigli¡_sÜtbasis
(){

1243 
basis
 = (
cÚfig
 *)
	`msÜt
((*)
cu¼’t
,(**)&(cu¼’t->
bp
),
CÚfigcmp
);

1244 
basi£nd
 = 0;

1246 
	}
}

1250 
cÚfig
 *
	$CÚfigli¡_»tuº
(){

1251 
cÚfig
 *
Şd
;

1252 
Şd
 = 
cu¼’t
;

1253 
cu¼’t
 = 0;

1254 
cu¼’‹nd
 = 0;

1255  
Şd
;

1256 
	}
}

1260 
cÚfig
 *
	$CÚfigli¡_basis
(){

1261 
cÚfig
 *
Şd
;

1262 
Şd
 = 
basis
;

1263 
basis
 = 0;

1264 
basi£nd
 = 0;

1265  
Şd
;

1266 
	}
}

1269 
	$CÚfigli¡_—t
(
cå
)

1270 
cÚfig
 *
cå
;

1272 
cÚfig
 *
Ãxtcå
;

1273 ; 
cå
; cå=
Ãxtcå
){

1274 
Ãxtcå
 = 
cå
->
Ãxt
;

1275 
	`as£¹
Ğ
cå
->
åÍ
==0 );

1276 
	`as£¹
Ğ
cå
->
b¶p
==0 );

1277 ifĞ
cå
->
fws
 ) 
	`S‘F»e
(cfp->fws);

1278 
	`d–‘ecÚfig
(
cå
);

1281 
	}
}

1290 
	$fšdb»ak
(
msg
,
mš
,
max
)

1291 *
msg
;

1292 
mš
;

1293 
max
;

1295 
i
,
¥Ù
;

1296 
c
;

1297 
i
=
¥Ù
=
mš
; i<=
max
; i++){

1298 
c
 = 
msg
[
i
];

1299 ifĞ
c
=='\t' ) 
msg
[
i
] = ' ';

1300 ifĞ
c
=='\n' ){ 
msg
[
i
] = ' '; 
¥Ù
 = i; ; }

1301 ifĞ
c
==0 ){ 
¥Ù
 = 
i
; ; }

1302 ifĞ
c
=='-' && 
i
<
max
-1 ) 
¥Ù
 = i+1;

1303 ifĞ
c
==' ' ) 
¥Ù
 = 
i
;

1305  
¥Ù
;

1306 
	}
}

1313 
	#ERRMSGSIZE
 10000

	)

1314 
	#LINEWIDTH
 79

	)

1315 
	#PREFIXLIMIT
 30

	)

1316 
	$E¼ÜMsg
(cÚ¡ *
f’ame
, 
lš’o
, cÚ¡ *
fÜm©
, ...){

1317 
”rmsg
[
ERRMSGSIZE
];

1318 
´efix
[
PREFIXLIMIT
+10];

1319 
”rmsgsize
;

1320 
´efixsize
;

1321 
avaabËwidth
;

1322 
va_li¡
 
­
;

1323 
’d
, 
»¡¬t
, 
ba£
;

1325 
	`va_¡¬t
(
­
, 
fÜm©
);

1327 ifĞ
lš’o
>0 ){

1328 
	`¥rštf
(
´efix
,"%.*s:%d: ",
PREFIXLIMIT
-10,
f’ame
,
lš’o
);

1330 
	`¥rštf
(
´efix
,"%.*s: ",
PREFIXLIMIT
-10,
f’ame
);

1332 
´efixsize
 = 
	`ËmÚSŒËn
(
´efix
);

1333 
avaabËwidth
 = 
LINEWIDTH
 - 
´efixsize
;

1336 
	`v¥rštf
(
”rmsg
,
fÜm©
,
­
);

1337 
	`va_’d
(
­
);

1338 
”rmsgsize
 = 
	`ËmÚSŒËn
(
”rmsg
);

1340  
”rmsgsize
>0 && 
”rmsg
[errmsgsize-1]=='\n' ){

1341 
”rmsg
[--
”rmsgsize
] = 0;

1345 
ba£
 = 0;

1346  
”rmsg
[
ba£
]!=0 ){

1347 
’d
 = 
»¡¬t
 = 
	`fšdb»ak
(&
”rmsg
[
ba£
],0,
avaabËwidth
);

1348 
»¡¬t
 +ğ
ba£
;

1349  
”rmsg
[
»¡¬t
]==' ' )„estart++;

1350 
	`årštf
(
¡dout
,"%s%.*s\n",
´efix
,
’d
,&
”rmsg
[
ba£
]);

1351 
ba£
 = 
»¡¬t
;

1353 
	}
}

1362 
	$memÜy_”rÜ
(){

1363 
	`årštf
(
¡d”r
,"Out of memory. Aborting...\n");

1364 
	`ex™
(1);

1365 
	}
}

1367 
	gnDefše
 = 0;

1368 **
	gazDefše
 = 0;

1373 
	$hªdË_D_İtiÚ
(*
z
){

1374 **
·z
;

1375 
nDefše
++;

1376 
azDefše
 = 
	`»®loc
×zDefše, ×zDefše[0])*
nDefše
);

1377 ifĞ
azDefše
==0 ){

1378 
	`årštf
(
¡d”r
,"out of memory\n");

1379 
	`ex™
(1);

1381 
·z
 = &
azDefše
[
nDefše
-1];

1382 *
·z
 = 
	`m®loc
Ğ
	`ËmÚSŒËn
(
z
)+1 );

1383 ifĞ*
·z
==0 ){

1384 
	`årštf
(
¡d”r
,"out of memory\n");

1385 
	`ex™
(1);

1387 
	`¡rıy
(*
·z
, 
z
);

1388 
z
=*
·z
; *z && *z!='='; z++){}

1389 *
z
 = 0;

1390 
	}
}

1394 
	$maš
(
¬gc
,
¬gv
)

1395 
¬gc
;

1396 **
¬gv
;

1398 
v”siÚ
 = 0;

1399 
½æag
 = 0;

1400 
basisæag
 = 0;

1401 
com´ess
 = 0;

1402 
qu›t
 = 0;

1403 
¡©i¡ics
 = 0;

1404 
mhæag
 = 0;

1405 
nŞš’osæag
 = 0;

1406 
s_İtiÚs
 
İtiÚs
[] = {

1407 {
OPT_FLAG
, "b", (*)&
basisæag
, "Print onlyhe basis in„eport."},

1408 {
OPT_FLAG
, "c", (*)&
com´ess
, "Don't compresshe‡ctionable."},

1409 {
OPT_FSTR
, "D", (*)
hªdË_D_İtiÚ
, "Define‡n %ifdef macro."},

1410 {
OPT_FLAG
, "g", (*)&
½æag
, "Print grammar without‡ctions."},

1411 {
OPT_FLAG
, "m", (*)&
mhæag
, "Output‡ makeheaders compatible file."},

1412 {
OPT_FLAG
, "l", (*)&
nŞš’osæag
, "Do‚ot…rint #line statements."},

1413 {
OPT_FLAG
, "q", (*)&
qu›t
, "(Quiet) Don't…rinthe„eport file."},

1414 {
OPT_FLAG
, "s", (*)&
¡©i¡ics
,

1416 {
OPT_FLAG
, "x", (*)&
v”siÚ
, "Printhe version‚umber."},

1417 {
OPT_FLAG
,0,0,0}

1419 
i
;

1420 
ËmÚ
 
Ëm
;

1422 
	`O±In™
(
¬gv
,
İtiÚs
,
¡d”r
);

1423 ifĞ
v”siÚ
 ){

1424 
	`´štf
("Lemon version 1.0\n");

1425 
	`ex™
(0);

1427 ifĞ
	`O±NArgs
()!=1 ){

1428 
	`årštf
(
¡d”r
,"Exactly one filename‡rgument is„equired.\n");

1429 
	`ex™
(1);

1431 
	`mem£t
(&
Ëm
, 0, (lem));

1432 
Ëm
.
”rÜút
 = 0;

1435 
	`SŒ§ã_š™
();

1436 
	`SymbŞ_š™
();

1437 
	`S‹_š™
();

1438 
Ëm
.
¬gv0
 = 
¬gv
[0];

1439 
Ëm
.
f’ame
 = 
	`O±Arg
(0);

1440 
Ëm
.
basisæag
 = basisflag;

1441 
Ëm
.
nŞš’osæag
 =‚olinenosflag;

1442 
	`SymbŞ_Ãw
("$");

1443 
Ëm
.
”rsym
 = 
	`SymbŞ_Ãw
("error");

1444 
Ëm
.
”rsym
->
u£CÁ
 = 0;

1447 
	`P¬£
(&
Ëm
);

1448 ifĞ
Ëm
.
”rÜút
 ) 
	`ex™
(lem.errorcnt);

1449 ifĞ
Ëm
.
ÄuË
==0 ){

1450 
	`årštf
(
¡d”r
,"Empty grammar.\n");

1451 
	`ex™
(1);

1455 
Ëm
.
nsymbŞ
 = 
	`SymbŞ_couÁ
();

1456 
	`SymbŞ_Ãw
("{default}");

1457 
Ëm
.
symbŞs
 = 
	`SymbŞ_¬¿yof
();

1458 
i
=0; i<=
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1459 
	`qsÜt
(
Ëm
.
symbŞs
,Ëm.
nsymbŞ
+1,(
symbŞ
*),

1460 ((*)())
SymbŞcmµ
);

1461 
i
=0; i<=
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1462 
i
=1; 
	`isuµ”
(
Ëm
.
symbŞs
[i]->
Çme
[0]); i++);

1463 
Ëm
.
Á”mš®
 = 
i
;

1466 ifĞ
½æag
 ){

1467 
	`R•ršt
(&
Ëm
);

1470 
	`S‘Size
(
Ëm
.
Á”mš®
+1);

1473 
	`FšdRuËP»ûd’ûs
(&
Ëm
);

1477 
	`FšdFœ¡S‘s
(&
Ëm
);

1481 
Ëm
.
n¡©e
 = 0;

1482 
	`FšdS‹s
(&
Ëm
);

1483 
Ëm
.
sÜ‹d
 = 
	`S‹_¬¿yof
();

1486 
	`FšdLšks
(&
Ëm
);

1489 
	`FšdFŞlowS‘s
(&
Ëm
);

1492 
	`FšdAùiÚs
(&
Ëm
);

1495 ifĞ
com´ess
==0 ) 
	`Com´essTabËs
(&
Ëm
);

1499 
	`ResÜtS‹s
(&
Ëm
);

1502 ifĞ!
qu›t
 ) 
	`R•ÜtOuut
(&
Ëm
);

1505 
	`R•ÜtTabË
(&
Ëm
, 
mhæag
);

1510 ifĞ!
mhæag
 ) 
	`R•ÜtH—d”
(&
Ëm
);

1512 ifĞ
¡©i¡ics
 ){

1513 
	`´štf
("Parser statistics: %derminals, %d‚onterminals, %d„ules\n",

1514 
Ëm
.
Á”mš®
,†em.
nsymbŞ
 -†em.Á”mš®,†em.
ÄuË
);

1515 
	`´štf
(" %d states, %d…arserableƒntries, %d conflicts\n",

1516 
Ëm
.
n¡©e
,†em.
bËsize
,†em.
ncÚæiù
);

1518 ifĞ
Ëm
.
ncÚæiù
 ){

1519 
	`årštf
(
¡d”r
,"%d…¬sšg cÚæiùs.\n",
Ëm
.
ncÚæiù
);

1521 
	`ex™
(
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1522  (
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1523 
	}
}

1551 
	#NEXT
(
A
è(*(**)((()A)+
off£t
))

	)

1568 *
m”ge
(

1569 *
a
,

1570 *
b
,

1571 (*
cmp
)(const *,const *),

1572 
off£t


1574 *
±r
, *
h—d
;

1576 ifĞ
a
==0 ){

1577 
h—d
 = 
b
;

1578 }ifĞ
b
==0 ){

1579 
h—d
 = 
a
;

1581 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1582 
±r
 = 
a
;

1583 
a
 = 
	`NEXT
(a);

1585 
±r
 = 
b
;

1586 
b
 = 
	`NEXT
(b);

1588 
h—d
 = 
±r
;

1589  
a
 && 
b
 ){

1590 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1591 
	`NEXT
(
±r
èğ
a
;

1592 
±r
 = 
a
;

1593 
a
 = 
	`NEXT
(a);

1595 
	`NEXT
(
±r
èğ
b
;

1596 
±r
 = 
b
;

1597 
b
 = 
	`NEXT
(b);

1600 ifĞ
a
 ) 
	`NEXT
(
±r
) =‡;

1601 
	`NEXT
(
±r
èğ
b
;

1603  
h—d
;

1604 
	}
}

1619 
	#LISTSIZE
 30

	)

1620 *
msÜt
(

1621 *
li¡
,

1622 **
Ãxt
,

1623 (*
cmp
)(const *,const *)

1625 
off£t
;

1626 *
•
;

1627 *
£t
[
LISTSIZE
];

1628 
i
;

1629 
off£t
 = ()
Ãxt
 - ()
li¡
;

1630 
i
=0; i<
LISTSIZE
; i++è
£t
[i] = 0;

1631  
li¡
 ){

1632 
•
 = 
li¡
;

1633 
li¡
 = 
	`NEXT
(list);

1634 
	`NEXT
(
•
) = 0;

1635 
i
=0; i<
LISTSIZE
-1 && 
£t
[i]!=0; i++){

1636 
•
 = 
	`m”ge
Óp,
£t
[
i
],
cmp
,
off£t
);

1637 
£t
[
i
] = 0;

1639 
£t
[
i
] = 
•
;

1641 
•
 = 0;

1642 
i
=0; i<
LISTSIZE
; i++èifĞ
£t
[i] ) 
•
 = 
	`m”ge
Óp,£t[i],
cmp
,
off£t
);

1643  
•
;

1644 
	}
}

1646 **
	g¬gv
;

1647 
s_İtiÚs
 *
	gİ
;

1648 
FILE
 *
	g”r¡»am
;

1650 
	#ISOPT
(
X
è((X)[0]=='-'||(X)[0]=='+'||
	`¡rchr
((X),'=')!=0)

	)

1656 
	$”¾še
(
n
,
k
,
”r
)

1657 
n
;

1658 
k
;

1659 
FILE
 *
”r
;

1661 
¥út
, 
i
;

1662 ifĞ
¬gv
[0] ) 
	`årštf
(
”r
,"%s",argv[0]);

1663 
¥út
 = 
	`ËmÚSŒËn
(
¬gv
[0]) + 1;

1664 
i
=1; i<
n
 && 
¬gv
[i]; i++){

1665 
	`årštf
(
”r
," %s",
¬gv
[
i
]);

1666 
¥út
 +ğ
	`ËmÚSŒËn
(
¬gv
[
i
])+1;

1668 
¥út
 +ğ
k
;

1669 ; 
¬gv
[
i
]; i++è
	`årštf
(
”r
," %s",argv[i]);

1670 ifĞ
¥út
<20 ){

1671 
	`årštf
(
”r
,"\n%*s^-- h”e\n",
¥út
,"");

1673 
	`årštf
(
”r
,"\n%*sh”--^\n",
¥út
-7,"");

1675 
	}
}

1681 
	$¬gšdex
(
n
)

1682 
n
;

1684 
i
;

1685 
dashdash
 = 0;

1686 ifĞ
¬gv
!=0 && *argv!=0 ){

1687 
i
=1; 
¬gv
[i]; i++){

1688 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]) ){

1689 ifĞ
n
==0 )  
i
;

1690 
n
--;

1692 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1696 
	}
}

1698 
	gemsg
[] = "Command†ine syntaxƒrror: ";

1703 
	$hªdËæags
(
i
,
”r
)

1704 
i
;

1705 
FILE
 *
”r
;

1707 
v
;

1708 
”rút
 = 0;

1709 
j
;

1710 
j
=0; 
İ
[j].
Ïb–
; j++){

1711 ifĞ
	`¡ºcmp
(&
¬gv
[
i
][1],
İ
[
j
].
Ïb–
,
	`ËmÚSŒËn
(op[j].label))==0 ) ;

1713 
v
 = 
¬gv
[
i
][0]=='-' ? 1 : 0;

1714 ifĞ
İ
[
j
].
Ïb–
==0 ){

1715 ifĞ
”r
 ){

1716 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1717 
	`”¾še
(
i
,1,
”r
);

1719 
”rút
++;

1720 }ifĞ
İ
[
j
].
ty³
==
OPT_FLAG
 ){

1721 *((*)
İ
[
j
].
¬g
èğ
v
;

1722 }ifĞ
İ
[
j
].
ty³
==
OPT_FFLAG
 ){

1723 (*((*)())(
İ
[
j
].
¬g
))(
v
);

1724 }ifĞ
İ
[
j
].
ty³
==
OPT_FSTR
 ){

1725 (*((*)())(
İ
[
j
].
¬g
))(&
¬gv
[
i
][2]);

1727 ifĞ
”r
 ){

1728 
	`årštf
(
”r
,"%smissšg‡rgum’ˆÚ sw™ch.\n",
emsg
);

1729 
	`”¾še
(
i
,1,
”r
);

1731 
”rút
++;

1733  
”rút
;

1734 
	}
}

1739 
	$hªdËsw™ch
(
i
,
”r
)

1740 
i
;

1741 
FILE
 *
”r
;

1743 
lv
 = 0;

1744 
dv
 = 0.0;

1745 *
sv
 = 0, *
’d
;

1746 *
ı
;

1747 
j
;

1748 
”rút
 = 0;

1749 
ı
 = 
	`¡rchr
(
¬gv
[
i
],'=');

1750 
	`as£¹
Ğ
ı
!=0 );

1751 *
ı
 = 0;

1752 
j
=0; 
İ
[j].
Ïb–
; j++){

1753 ifĞ
	`¡rcmp
(
¬gv
[
i
],
İ
[
j
].
Ïb–
)==0 ) ;

1755 *
ı
 = '=';

1756 ifĞ
İ
[
j
].
Ïb–
==0 ){

1757 ifĞ
”r
 ){

1758 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1759 
	`”¾še
(
i
,0,
”r
);

1761 
”rút
++;

1763 
ı
++;

1764  
İ
[
j
].
ty³
 ){

1765 
OPT_FLAG
:

1766 
OPT_FFLAG
:

1767 ifĞ
”r
 ){

1768 
	`årštf
(
”r
,"%sİtiÚ„equœe ª‡rgum’t.\n",
emsg
);

1769 
	`”¾še
(
i
,0,
”r
);

1771 
”rút
++;

1773 
OPT_DBL
:

1774 
OPT_FDBL
:

1775 
dv
 = 
	`¡¹od
(
ı
,&
’d
);

1776 ifĞ*
’d
 ){

1777 ifĞ
”r
 ){

1778 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀæßtšg-pošˆ¬gum’t.\n",
emsg
);

1779 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1781 
”rút
++;

1784 
OPT_INT
:

1785 
OPT_FINT
:

1786 
lv
 = 
	`¡¹Ş
(
ı
,&
’d
,0);

1787 ifĞ*
’d
 ){

1788 ifĞ
”r
 ){

1789 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀš‹g”‡rgum’t.\n",
emsg
);

1790 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1792 
”rút
++;

1795 
OPT_STR
:

1796 
OPT_FSTR
:

1797 
sv
 = 
ı
;

1800  
İ
[
j
].
ty³
 ){

1801 
OPT_FLAG
:

1802 
OPT_FFLAG
:

1804 
OPT_DBL
:

1805 *(*)(
İ
[
j
].
¬g
èğ
dv
;

1807 
OPT_FDBL
:

1808 (*((*)())(
İ
[
j
].
¬g
))(
dv
);

1810 
OPT_INT
:

1811 *(*)(
İ
[
j
].
¬g
èğ
lv
;

1813 
OPT_FINT
:

1814 (*((*)())(
İ
[
j
].
¬g
))(()
lv
);

1816 
OPT_STR
:

1817 *(**)(
İ
[
j
].
¬g
èğ
sv
;

1819 
OPT_FSTR
:

1820 (*((*)())(
İ
[
j
].
¬g
))(
sv
);

1824  
”rút
;

1825 
	}
}

1827 
	$O±In™
(
a
,
o
,
”r
)

1828 **
a
;

1829 
s_İtiÚs
 *
o
;

1830 
FILE
 *
”r
;

1832 
”rút
 = 0;

1833 
¬gv
 = 
a
;

1834 
İ
 = 
o
;

1835 
”r¡»am
 = 
”r
;

1836 ifĞ
¬gv
 && *¬gv && 
İ
 ){

1837 
i
;

1838 
i
=1; 
¬gv
[i]; i++){

1839 ifĞ
¬gv
[
i
][0]=='+' ||‡rgv[i][0]=='-' ){

1840 
”rút
 +ğ
	`hªdËæags
(
i
,
”r
);

1841 }ifĞ
	`¡rchr
(
¬gv
[
i
],'=') ){

1842 
”rút
 +ğ
	`hªdËsw™ch
(
i
,
”r
);

1846 ifĞ
”rút
>0 ){

1847 
	`årštf
(
”r
,"V®id commªd†šİtiÚ fÜ \"%s\"‡»:\n",*
a
);

1848 
	`O±Pršt
();

1849 
	`ex™
(1);

1852 
	}
}

1854 
	$O±NArgs
(){

1855 
út
 = 0;

1856 
dashdash
 = 0;

1857 
i
;

1858 ifĞ
¬gv
!=0 &&‡rgv[0]!=0 ){

1859 
i
=1; 
¬gv
[i]; i++){

1860 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]èè
út
++;

1861 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1864  
út
;

1865 
	}
}

1867 *
	$O±Arg
(
n
)

1868 
n
;

1870 
i
;

1871 
i
 = 
	`¬gšdex
(
n
);

1872  
i
>=0 ? 
¬gv
[i] : 0;

1873 
	}
}

1875 
	$O±E¼
(
n
)

1876 
n
;

1878 
i
;

1879 
i
 = 
	`¬gšdex
(
n
);

1880 ifĞ
i
>=0 ) 
	`”¾še
(i,0,
”r¡»am
);

1881 
	}
}

1883 
	$O±Pršt
(){

1884 
i
;

1885 
max
, 
Ën
;

1886 
max
 = 0;

1887 
i
=0; 
İ
[i].
Ïb–
; i++){

1888 
Ën
 = 
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
) + 1;

1889  
İ
[
i
].
ty³
 ){

1890 
OPT_FLAG
:

1891 
OPT_FFLAG
:

1893 
OPT_INT
:

1894 
OPT_FINT
:

1895 
Ën
 += 9;

1897 
OPT_DBL
:

1898 
OPT_FDBL
:

1899 
Ën
 += 6;

1901 
OPT_STR
:

1902 
OPT_FSTR
:

1903 
Ën
 += 8;

1906 ifĞ
Ën
>
max
 ) max =†en;

1908 
i
=0; 
İ
[i].
Ïb–
; i++){

1909  
İ
[
i
].
ty³
 ){

1910 
OPT_FLAG
:

1911 
OPT_FFLAG
:

1912 
	`årštf
(
”r¡»am
," -%-*  %s\n",
max
,
İ
[
i
].
Ïb–
,İ[i].
mes§ge
);

1914 
OPT_INT
:

1915 
OPT_FINT
:

1916 
	`årštf
(
”r¡»am
," %s=<š‹g”>%*  %s\n",
İ
[
i
].
Ïb–
,

1917 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-9),"",İ[i].
mes§ge
);

1919 
OPT_DBL
:

1920 
OPT_FDBL
:

1921 
	`årštf
(
”r¡»am
," %s=<»®>%*  %s\n",
İ
[
i
].
Ïb–
,

1922 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-6),"",İ[i].
mes§ge
);

1924 
OPT_STR
:

1925 
OPT_FSTR
:

1926 
	`årštf
(
”r¡»am
," %s=<¡ršg>%*  %s\n",
İ
[
i
].
Ïb–
,

1927 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-8),"",İ[i].
mes§ge
);

1931 
	}
}

1938 
	sp¡©e
 {

1939 *
	mf’ame
;

1940 
	mtok’lš’o
;

1941 
	m”rÜút
;

1942 *
	mtok’¡¬t
;

1943 
ËmÚ
 *
	mgp
;

1944 
	ee_¡©e
 {

1945 
	mINITIALIZE
,

1946 
	mWAITING_FOR_DECL_OR_RULE
,

1947 
	mWAITING_FOR_DECL_KEYWORD
,

1948 
	mWAITING_FOR_DECL_ARG
,

1949 
	mWAITING_FOR_PRECEDENCE_SYMBOL
,

1950 
	mWAITING_FOR_ARROW
,

1951 
	mIN_RHS
,

1952 
	mLHS_ALIAS_1
,

1953 
	mLHS_ALIAS_2
,

1954 
	mLHS_ALIAS_3
,

1955 
	mRHS_ALIAS_1
,

1956 
	mRHS_ALIAS_2
,

1957 
	mPRECEDENCE_MARK_1
,

1958 
	mPRECEDENCE_MARK_2
,

1959 
	mRESYNC_AFTER_RULE_ERROR
,

1960 
	mRESYNC_AFTER_DECL_ERROR
,

1961 
	mWAITING_FOR_DESTRUCTOR_SYMBOL
,

1962 
	mWAITING_FOR_DATATYPE_SYMBOL
,

1963 
	mWAITING_FOR_FALLBACK_ID
,

1964 
	mWAITING_FOR_WILDCARD_ID


1965 } 
	m¡©e
;

1966 
symbŞ
 *
	mçÎback
;

1967 
symbŞ
 *
	mlhs
;

1968 *
	mlh§lŸs
;

1969 
	mÄhs
;

1970 
symbŞ
 *
	mrhs
[
MAXRHS
];

1971 *
	m®Ÿs
[
MAXRHS
];

1972 
ruË
 *
	m´evruË
;

1973 *
	mdeşkeywÜd
;

1974 **
	mdeş¬g¦Ù
;

1975 
	mš£¹LšeMaüo
;

1976 *
	mdeşlš’o¦Ù
;

1977 
e_assoc
 
	mdeşassoc
;

1978 
	m´eccouÁ”
;

1979 
ruË
 *
	mfœ¡ruË
;

1980 
ruË
 *
	mÏ¡ruË
;

1984 
	$·r£Ú‘ok’
(
p¥
)

1985 
p¡©e
 *
p¥
;

1987 *
x
;

1988 
x
 = 
	`SŒ§ã
(
p¥
->
tok’¡¬t
);

1990 
	`´štf
("%s:%d: Tok’=[%s] s‹=%d\n",
p¥
->
f’ame
,p¥->
tok’lš’o
,

1991 
x
,
p¥
->
¡©e
);

1993  
p¥
->
¡©e
 ){

1994 
INITIALIZE
:

1995 
p¥
->
´evruË
 = 0;

1996 
p¥
->
´eccouÁ”
 = 0;

1997 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 0;

1998 
p¥
->
gp
->
ÄuË
 = 0;

2000 
WAITING_FOR_DECL_OR_RULE
:

2001 ifĞ
x
[0]=='%' ){

2002 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2003 }ifĞ
	`i¦ow”
(
x
[0]) ){

2004 
p¥
->
lhs
 = 
	`SymbŞ_Ãw
(
x
);

2005 
p¥
->
Ähs
 = 0;

2006 
p¥
->
lh§lŸs
 = 0;

2007 
p¥
->
¡©e
 = 
WAITING_FOR_ARROW
;

2008 }ifĞ
x
[0]=='{' ){

2009 ifĞ
p¥
->
´evruË
==0 ){

2010 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2013 
p¥
->
”rÜút
++;

2014 }ifĞ
p¥
->
´evruË
->
code
!=0 ){

2015 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2018 
p¥
->
”rÜút
++;

2020 
p¥
->
´evruË
->
lše
 =…¥->
tok’lš’o
;

2021 
p¥
->
´evruË
->
code
 = &
x
[1];

2023 }ifĞ
x
[0]=='[' ){

2024 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_1
;

2026 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2028 
x
);

2029 
p¥
->
”rÜút
++;

2032 
PRECEDENCE_MARK_1
:

2033 ifĞ!
	`isuµ”
(
x
[0]) ){

2034 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2036 
p¥
->
”rÜút
++;

2037 }ifĞ
p¥
->
´evruË
==0 ){

2038 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2039 "Th”i nØ´iÜ„uËØassigÀ´eûd’û \"[%s]\".",
x
);

2040 
p¥
->
”rÜút
++;

2041 }ifĞ
p¥
->
´evruË
->
´ecsym
!=0 ){

2042 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2045 
p¥
->
”rÜút
++;

2047 
p¥
->
´evruË
->
´ecsym
 = 
	`SymbŞ_Ãw
(
x
);

2049 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_2
;

2051 
PRECEDENCE_MARK_2
:

2052 ifĞ
x
[0]!=']' ){

2053 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2055 
p¥
->
”rÜút
++;

2057 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2059 
WAITING_FOR_ARROW
:

2060 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2061 
p¥
->
¡©e
 = 
IN_RHS
;

2062 }ifĞ
x
[0]=='(' ){

2063 
p¥
->
¡©e
 = 
LHS_ALIAS_1
;

2065 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2067 
p¥
->
lhs
->
Çme
);

2068 
p¥
->
”rÜút
++;

2069 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2072 
LHS_ALIAS_1
:

2073 ifĞ
	`i§Íha
(
x
[0]) ){

2074 
p¥
->
lh§lŸs
 = 
x
;

2075 
p¥
->
¡©e
 = 
LHS_ALIAS_2
;

2077 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2079 
x
,
p¥
->
lhs
->
Çme
);

2080 
p¥
->
”rÜút
++;

2081 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2084 
LHS_ALIAS_2
:

2085 ifĞ
x
[0]==')' ){

2086 
p¥
->
¡©e
 = 
LHS_ALIAS_3
;

2088 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2089 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2090 
p¥
->
”rÜút
++;

2091 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2094 
LHS_ALIAS_3
:

2095 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2096 
p¥
->
¡©e
 = 
IN_RHS
;

2098 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2100 
p¥
->
lhs
->
Çme
,p¥->
lh§lŸs
);

2101 
p¥
->
”rÜút
++;

2102 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2105 
IN_RHS
:

2106 ifĞ
x
[0]=='.' ){

2107 
ruË
 *
½
;

2108 
½
 = (
ruË
 *)
	`ÿÎoc
( (rule) +

2109 (
symbŞ
*)*
p¥
->
Ähs
 + (*)*psp->nrhs, 1);

2110 ifĞ
½
==0 ){

2111 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2113 
p¥
->
”rÜút
++;

2114 
p¥
->
´evruË
 = 0;

2116 
i
;

2117 
½
->
ruËlše
 = 
p¥
->
tok’lš’o
;

2118 
½
->
rhs
 = (
symbŞ
**)&rp[1];

2119 
½
->
rh§lŸs
 = (**)&Ôp->
rhs
[
p¥
->
Ähs
]);

2120 
i
=0; i<
p¥
->
Ähs
; i++){

2121 
½
->
rhs
[
i
] = 
p¥
->rhs[i];

2122 
½
->
rh§lŸs
[
i
] = 
p¥
->
®Ÿs
[i];

2124 
½
->
lhs
 = 
p¥
->lhs;

2125 
½
->
lh§lŸs
 = 
p¥
->lhsalias;

2126 
½
->
Ähs
 = 
p¥
->nrhs;

2127 
½
->
code
 = 0;

2128 
½
->
´ecsym
 = 0;

2129 
½
->
šdex
 = 
p¥
->
gp
->
ÄuË
++;

2130 
½
->
Ãxhs
 =„p->
lhs
->
ruË
;

2131 
½
->
lhs
->
ruË
 =„p;

2132 
½
->
Ãxt
 = 0;

2133 ifĞ
p¥
->
fœ¡ruË
==0 ){

2134 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 
½
;

2136 
p¥
->
Ï¡ruË
->
Ãxt
 = 
½
;

2137 
p¥
->
Ï¡ruË
 = 
½
;

2139 
p¥
->
´evruË
 = 
½
;

2141 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2142 }ifĞ
	`i§Íha
(
x
[0]) ){

2143 ifĞ
p¥
->
Ähs
>=
MAXRHS
 ){

2144 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2146 
x
);

2147 
p¥
->
”rÜút
++;

2148 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2150 
p¥
->
rhs
[p¥->
Ähs
] = 
	`SymbŞ_Ãw
(
x
);

2151 
p¥
->
®Ÿs
[p¥->
Ähs
] = 0;

2152 
p¥
->
Ähs
++;

2154 }ifĞ(
x
[0]=='|' || x[0]=='/'è&& 
p¥
->
Ähs
>0 ){

2155 
symbŞ
 *
m¥
 = 
p¥
->
rhs
[p¥->
Ähs
-1];

2156 ifĞ
m¥
->
ty³
!=
MULTITERMINAL
 ){

2157 
symbŞ
 *
Üig¥
 = 
m¥
;

2158 
m¥
 = 
	`ÿÎoc
(1,(*msp));

2159 
	`mem£t
(
m¥
, 0, (*msp));

2160 
m¥
->
ty³
 = 
MULTITERMINAL
;

2161 
m¥
->
nsubsym
 = 1;

2162 
m¥
->
subsym
 = 
	`ÿÎoc
(1,(
symbŞ
*));

2163 
m¥
->
subsym
[0] = 
Üig¥
;

2164 
m¥
->
Çme
 = 
Üig¥
->name;

2165 
p¥
->
rhs
[p¥->
Ähs
-1] = 
m¥
;

2167 
m¥
->
nsubsym
++;

2168 
m¥
->
subsym
 = 
	`»®loc
(m¥->subsym, (
symbŞ
*)*m¥->
nsubsym
);

2169 
m¥
->
subsym
[m¥->
nsubsym
-1] = 
	`SymbŞ_Ãw
(&
x
[1]);

2170 ifĞ
	`i¦ow”
(
x
[1]è|| i¦ow”(
m¥
->
subsym
[0]->
Çme
[0]) ){

2171 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2173 
p¥
->
”rÜút
++;

2175 }ifĞ
x
[0]=='(' && 
p¥
->
Ähs
>0 ){

2176 
p¥
->
¡©e
 = 
RHS_ALIAS_1
;

2178 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2179 "IÎeg® ch¬aù” oÀRHS oàruË: \"%s\".",
x
);

2180 
p¥
->
”rÜút
++;

2181 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2184 
RHS_ALIAS_1
:

2185 ifĞ
	`i§Íha
(
x
[0]) ){

2186 
p¥
->
®Ÿs
[p¥->
Ähs
-1] = 
x
;

2187 
p¥
->
¡©e
 = 
RHS_ALIAS_2
;

2189 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2191 
x
,
p¥
->
rhs
[p¥->
Ähs
-1]->
Çme
);

2192 
p¥
->
”rÜút
++;

2193 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2196 
RHS_ALIAS_2
:

2197 ifĞ
x
[0]==')' ){

2198 
p¥
->
¡©e
 = 
IN_RHS
;

2200 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2201 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2202 
p¥
->
”rÜút
++;

2203 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2206 
WAITING_FOR_DECL_KEYWORD
:

2207 ifĞ
	`i§Íha
(
x
[0]) ){

2208 
p¥
->
deşkeywÜd
 = 
x
;

2209 
p¥
->
deş¬g¦Ù
 = 0;

2210 
p¥
->
deşlš’o¦Ù
 = 0;

2211 
p¥
->
š£¹LšeMaüo
 = 1;

2212 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2213 ifĞ
	`¡rcmp
(
x
,"name")==0 ){

2214 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
Çme
);

2215 
p¥
->
š£¹LšeMaüo
 = 0;

2216 }ifĞ
	`¡rcmp
(
x
,"include")==0 ){

2217 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
šşude
);

2218 }ifĞ
	`¡rcmp
(
x
,"code")==0 ){

2219 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
exŒacode
);

2220 }ifĞ
	`¡rcmp
(
x
,"token_destructor")==0 ){

2221 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’de¡
;

2222 }ifĞ
	`¡rcmp
(
x
,"default_destructor")==0 ){

2223 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
v¬de¡
;

2224 }ifĞ
	`¡rcmp
(
x
,"token_prefix")==0 ){

2225 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’´efix
;

2226 
p¥
->
š£¹LšeMaüo
 = 0;

2227 }ifĞ
	`¡rcmp
(
x
,"syntax_error")==0 ){

2228 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
”rÜ
);

2229 }ifĞ
	`¡rcmp
(
x
,"parse_accept")==0 ){

2230 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
acû±
);

2231 }ifĞ
	`¡rcmp
(
x
,"parse_failure")==0 ){

2232 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
çu»
);

2233 }ifĞ
	`¡rcmp
(
x
,"stack_overflow")==0 ){

2234 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
ov”æow
);

2235 }ifĞ
	`¡rcmp
(
x
,"extra_argument")==0 ){

2236 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¬g
);

2237 
p¥
->
š£¹LšeMaüo
 = 0;

2238 }ifĞ
	`¡rcmp
(
x
,"token_type")==0 ){

2239 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
tok’ty³
);

2240 
p¥
->
š£¹LšeMaüo
 = 0;

2241 }ifĞ
	`¡rcmp
(
x
,"default_type")==0 ){

2242 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
v¬ty³
);

2243 
p¥
->
š£¹LšeMaüo
 = 0;

2244 }ifĞ
	`¡rcmp
(
x
,"stack_size")==0 ){

2245 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡acksize
);

2246 
p¥
->
š£¹LšeMaüo
 = 0;

2247 }ifĞ
	`¡rcmp
(
x
,"start_symbol")==0 ){

2248 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡¬t
);

2249 
p¥
->
š£¹LšeMaüo
 = 0;

2250 }ifĞ
	`¡rcmp
(
x
,"left")==0 ){

2251 
p¥
->
´eccouÁ”
++;

2252 
p¥
->
deşassoc
 = 
LEFT
;

2253 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2254 }ifĞ
	`¡rcmp
(
x
,"right")==0 ){

2255 
p¥
->
´eccouÁ”
++;

2256 
p¥
->
deşassoc
 = 
RIGHT
;

2257 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2258 }ifĞ
	`¡rcmp
(
x
,"nonassoc")==0 ){

2259 
p¥
->
´eccouÁ”
++;

2260 
p¥
->
deşassoc
 = 
NONE
;

2261 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2262 }ifĞ
	`¡rcmp
(
x
,"destructor")==0 ){

2263 
p¥
->
¡©e
 = 
WAITING_FOR_DESTRUCTOR_SYMBOL
;

2264 }ifĞ
	`¡rcmp
(
x
,"type")==0 ){

2265 
p¥
->
¡©e
 = 
WAITING_FOR_DATATYPE_SYMBOL
;

2266 }ifĞ
	`¡rcmp
(
x
,"fallback")==0 ){

2267 
p¥
->
çÎback
 = 0;

2268 
p¥
->
¡©e
 = 
WAITING_FOR_FALLBACK_ID
;

2269 }ifĞ
	`¡rcmp
(
x
,"wildcard")==0 ){

2270 
p¥
->
¡©e
 = 
WAITING_FOR_WILDCARD_ID
;

2272 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2273 "UnknowÀdeş¬©iÚ keywÜd: \"%%%s\".",
x
);

2274 
p¥
->
”rÜút
++;

2275 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2278 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2279 "IÎeg® deş¬©iÚ keywÜd: \"%s\".",
x
);

2280 
p¥
->
”rÜút
++;

2281 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2284 
WAITING_FOR_DESTRUCTOR_SYMBOL
:

2285 ifĞ!
	`i§Íha
(
x
[0]) ){

2286 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2288 
p¥
->
”rÜút
++;

2289 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2291 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2292 
p¥
->
deş¬g¦Ù
 = &
¥
->
de¡ruùÜ
;

2293 
p¥
->
deşlš’o¦Ù
 = &
¥
->
de¡Lš’o
;

2294 
p¥
->
š£¹LšeMaüo
 = 1;

2295 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2298 
WAITING_FOR_DATATYPE_SYMBOL
:

2299 ifĞ!
	`i§Íha
(
x
[0]) ){

2300 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2302 
p¥
->
”rÜút
++;

2303 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2305 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2306 
p¥
->
deş¬g¦Ù
 = &
¥
->
d©©y³
;

2307 
p¥
->
š£¹LšeMaüo
 = 0;

2308 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2311 
WAITING_FOR_PRECEDENCE_SYMBOL
:

2312 ifĞ
x
[0]=='.' ){

2313 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2314 }ifĞ
	`isuµ”
(
x
[0]) ){

2315 
symbŞ
 *
¥
;

2316 
¥
 = 
	`SymbŞ_Ãw
(
x
);

2317 ifĞ
¥
->
´ec
>=0 ){

2318 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2319 "SymbŞ \"%s\" ha ®»ady bgiv’‡…»ûd’û.",
x
);

2320 
p¥
->
”rÜút
++;

2322 
¥
->
´ec
 = 
p¥
->
´eccouÁ”
;

2323 
¥
->
assoc
 = 
p¥
->
deşassoc
;

2326 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2327 "Cª'ˆassigÀ¨´eûd’ûØ\"%s\".",
x
);

2328 
p¥
->
”rÜút
++;

2331 
WAITING_FOR_DECL_ARG
:

2332 ifĞ
x
[0]=='{' || x[0]=='\"' || 
	`i§Êum
(x[0]) ){

2333 *
zOld
, *
zNew
, *
zBuf
, *
z
;

2334 
nOld
, 
n
, 
nLše
, 
nNew
, 
nBack
;

2335 
addLšeMaüo
;

2336 
zLše
[50];

2337 
zNew
 = 
x
;

2338 ifĞ
zNew
[0]=='"' || zNew[0]=='{' ) zNew++;

2339 
nNew
 = 
	`ËmÚSŒËn
(
zNew
);

2340 ifĞ*
p¥
->
deş¬g¦Ù
 ){

2341 
zOld
 = *
p¥
->
deş¬g¦Ù
;

2343 
zOld
 = "";

2345 
nOld
 = 
	`ËmÚSŒËn
(
zOld
);

2346 
n
 = 
nOld
 + 
nNew
 + 20;

2347 
addLšeMaüo
 = !
p¥
->
gp
->
nŞš’osæag
 &&…¥->
š£¹LšeMaüo
 &&

2348 (
p¥
->
deşlš’o¦Ù
==0 ||…sp->decllinenoslot[0]!=0);

2349 ifĞ
addLšeMaüo
 ){

2350 
z
=
p¥
->
f’ame
, 
nBack
=0; *z; z++){

2351 ifĞ*
z
=='\\' ) 
nBack
++;

2353 
	`¥rštf
(
zLše
, "#lš%d ", 
p¥
->
tok’lš’o
);

2354 
nLše
 = 
	`ËmÚSŒËn
(
zLše
);

2355 
n
 +ğ
nLše
 + 
	`ËmÚSŒËn
(
p¥
->
f’ame
è+ 
nBack
;

2357 *
p¥
->
deş¬g¦Ù
 = 
zBuf
 = 
	`»®loc
(*p¥->deş¬g¦Ù, 
n
);

2358 
zBuf
 +ğ
nOld
;

2359 ifĞ
addLšeMaüo
 ){

2360 ifĞ
nOld
 && 
zBuf
[-1]!='\n' ){

2361 *(
zBuf
++) = '\n';

2363 
	`memıy
(
zBuf
, 
zLše
, 
nLše
);

2364 
zBuf
 +ğ
nLše
;

2365 *(
zBuf
++) = '"';

2366 
z
=
p¥
->
f’ame
; *z; z++){

2367 ifĞ*
z
=='\\' ){

2368 *(
zBuf
++) = '\\';

2370 *(
zBuf
++èğ*
z
;

2372 *(
zBuf
++) = '"';

2373 *(
zBuf
++) = '\n';

2375 ifĞ
p¥
->
deşlš’o¦Ù
 &&…sp->decllinenoslot[0]==0 ){

2376 
p¥
->
deşlš’o¦Ù
[0] =…¥->
tok’lš’o
;

2378 
	`memıy
(
zBuf
, 
zNew
, 
nNew
);

2379 
zBuf
 +ğ
nNew
;

2380 *
zBuf
 = 0;

2381 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2383 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2384 "IÎeg®‡rgum’ˆtØ%%%s: %s",
p¥
->
deşkeywÜd
,
x
);

2385 
p¥
->
”rÜút
++;

2386 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2389 
WAITING_FOR_FALLBACK_ID
:

2390 ifĞ
x
[0]=='.' ){

2391 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2392 }ifĞ!
	`isuµ”
(
x
[0]) ){

2393 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2394 "%%çÎback‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2395 
p¥
->
”rÜút
++;

2397 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2398 ifĞ
p¥
->
çÎback
==0 ){

2399 
p¥
->
çÎback
 = 
¥
;

2400 }ifĞ
¥
->
çÎback
 ){

2401 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2402 "MÜthª oÃ f®lback‡ssigÃdØtok’ %s", 
x
);

2403 
p¥
->
”rÜút
++;

2405 
¥
->
çÎback
 = 
p¥
->fallback;

2406 
p¥
->
gp
->
has_çÎback
 = 1;

2410 
WAITING_FOR_WILDCARD_ID
:

2411 ifĞ
x
[0]=='.' ){

2412 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2413 }ifĞ!
	`isuµ”
(
x
[0]) ){

2414 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2415 "%%wdÿrd‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2416 
p¥
->
”rÜút
++;

2418 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2419 ifĞ
p¥
->
gp
->
wdÿrd
==0 ){

2420 
p¥
->
gp
->
wdÿrd
 = 
¥
;

2422 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2423 "ExŒ¨wdÿrdØtok’: %s", 
x
);

2424 
p¥
->
”rÜút
++;

2428 
RESYNC_AFTER_RULE_ERROR
:

2431 
RESYNC_AFTER_DECL_ERROR
:

2432 ifĞ
x
[0]=='.' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2433 ifĞ
x
[0]=='%' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2436 
	}
}

2443 
	$´•roûss_šput
(*
z
){

2444 
i
, 
j
, 
k
, 
n
;

2445 
exşude
 = 0;

2446 
¡¬t
 = 0;

2447 
lš’o
 = 1;

2448 
¡¬t_lš’o
 = 1;

2449 
i
=0; 
z
[i]; i++){

2450 ifĞ
z
[
i
]=='\n' ) 
lš’o
++;

2451 ifĞ
z
[
i
]!='%' || (i>0 && z[i-1]!='\n') ) ;

2452 ifĞ
	`¡ºcmp
(&
z
[
i
],"%’dif",6)==0 && 
	`is¥aû
(z[i+6]) ){

2453 ifĞ
exşude
 ){

2454 
exşude
--;

2455 ifĞ
exşude
==0 ){

2456 
j
=
¡¬t
; j<
i
; j++èifĞ
z
[j]!='\n' ) z[j] = ' ';

2459 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2460 }ifĞ(
	`¡ºcmp
(&
z
[
i
],"%ifdef",6)==0 && 
	`is¥aû
(z[i+6]))

2461 || (
	`¡ºcmp
(&
z
[
i
],"%iâdef",7)==0 && 
	`is¥aû
(z[i+7])) ){

2462 ifĞ
exşude
 ){

2463 
exşude
++;

2465 
j
=
i
+7; 
	`is¥aû
(
z
[j]); j++){}

2466 
n
=0; 
z
[
j
+n] && !
	`is¥aû
(z[j+n]);‚++){}

2467 
exşude
 = 1;

2468 
k
=0; k<
nDefše
; k++){

2469 ifĞ
	`¡ºcmp
(
azDefše
[
k
],&
z
[
j
],
n
)==0 && 
	`ËmÚSŒËn
(azDefine[k])==n ){

2470 
exşude
 = 0;

2474 ifĞ
z
[
i
+3]=='n' ) 
exşude
 = !exclude;

2475 ifĞ
exşude
 ){

2476 
¡¬t
 = 
i
;

2477 
¡¬t_lš’o
 = 
lš’o
;

2480 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2483 ifĞ
exşude
 ){

2484 
	`årštf
(
¡d”r
,"uÁ”mš©ed %%ifdeà¡¬tšg oÀlš%d\n", 
¡¬t_lš’o
);

2485 
	`ex™
(1);

2487 
	}
}

2494 
	$P¬£
(
gp
)

2495 
ËmÚ
 *
gp
;

2497 
p¡©e
 
ps
;

2498 
FILE
 *
å
;

2499 *
febuf
;

2500 
fesize
;

2501 
lš’o
;

2502 
c
;

2503 *
ı
, *
Ãxtı
;

2504 
¡¬še
 = 0;

2506 
	`mem£t
(&
ps
, '\0', (ps));

2507 
ps
.
gp
 = gp;

2508 
ps
.
f’ame
 = 
gp
->filename;

2509 
ps
.
”rÜút
 = 0;

2510 
ps
.
¡©e
 = 
INITIALIZE
;

2513 
å
 = 
	`fİ’
(
ps
.
f’ame
,"rb");

2514 ifĞ
å
==0 ){

2515 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't openhis file for„eading.");

2516 
gp
->
”rÜút
++;

2519 
	`f£ek
(
å
,0,2);

2520 
fesize
 = 
	`á–l
(
å
);

2521 
	`»wšd
(
å
);

2522 
febuf
 = (*)
	`m®loc
Ğ
fesize
+1 );

2523 ifĞ
febuf
==0 ){

2524 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't‡llocate %d of memoryo holdhis file.",

2525 
fesize
+1);

2526 
gp
->
”rÜút
++;

2529 ifĞ
	`ä—d
(
febuf
,1,
fesize
,
å
)!=filesize ){

2530 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't„ead in‡ll %d bytes ofhis file.",

2531 
fesize
);

2532 
	`ä“
(
febuf
);

2533 
gp
->
”rÜút
++;

2536 
	`fşo£
(
å
);

2537 
febuf
[
fesize
] = 0;

2540 
	`´•roûss_šput
(
febuf
);

2543 
lš’o
 = 1;

2544 
ı
=
febuf
; (
c
= *cp)!=0; ){

2545 ifĞ
c
=='\n' ) 
lš’o
++;

2546 ifĞ
	`is¥aû
(
c
è){ 
ı
++; ; }

2547 ifĞ
c
=='/' && 
ı
[1]=='/' ){

2548 
ı
+=2;

2549  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2552 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2553 
ı
+=2;

2554  (
c
ğ*
ı
)!=0 && (c!='/' || cp[-1]!='*') ){

2555 ifĞ
c
=='\n' ) 
lš’o
++;

2556 
ı
++;

2558 ifĞ
c
 ) 
ı
++;

2561 
ps
.
tok’¡¬t
 = 
ı
;

2562 
ps
.
tok’lš’o
 = 
lš’o
;

2563 ifĞ
c
=='\"' ){

2564 
ı
++;

2565  (
c
ğ*
ı
)!=0 && c!='\"' ){

2566 ifĞ
c
=='\n' ) 
lš’o
++;

2567 
ı
++;

2569 ifĞ
c
==0 ){

2570 
	`E¼ÜMsg
(
ps
.
f’ame
,
¡¬še
,

2572 
ps
.
”rÜút
++;

2573 
Ãxtı
 = 
ı
;

2575 
Ãxtı
 = 
ı
+1;

2577 }ifĞ
c
=='{' ){

2578 
Ëv–
;

2579 
ı
++;

2580 
Ëv–
=1; (
c
ğ*
ı
)!=0 && (level>1 || c!='}'); cp++){

2581 ifĞ
c
=='\n' ) 
lš’o
++;

2582 ifĞ
c
=='{' ) 
Ëv–
++;

2583 ifĞ
c
=='}' ) 
Ëv–
--;

2584 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2585 
´evc
;

2586 
ı
 = &cp[2];

2587 
´evc
 = 0;

2588  (
c
ğ*
ı
)!=0 && (c!='/' || 
´evc
!='*') ){

2589 ifĞ
c
=='\n' ) 
lš’o
++;

2590 
´evc
 = 
c
;

2591 
ı
++;

2593 }ifĞ
c
=='/' && 
ı
[1]=='/' ){

2594 
ı
 = &cp[2];

2595  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2596 ifĞ
c
 ) 
lš’o
++;

2597 }ifĞ
c
=='\'' || c=='\"' ){

2598 
¡¬tch¬
, 
´evc
;

2599 
¡¬tch¬
 = 
c
;

2600 
´evc
 = 0;

2601 
ı
++; (
c
ğ*ı)!=0 && (c!=
¡¬tch¬
 || 
´evc
=='\\'); cp++){

2602 ifĞ
c
=='\n' ) 
lš’o
++;

2603 ifĞ
´evc
=='\\' )…revc = 0;

2604 
´evc
 = 
c
;

2608 ifĞ
c
==0 ){

2609 
	`E¼ÜMsg
(
ps
.
f’ame
,ps.
tok’lš’o
,

2611 
ps
.
”rÜút
++;

2612 
Ãxtı
 = 
ı
;

2614 
Ãxtı
 = 
ı
+1;

2616 }ifĞ
	`i§Êum
(
c
) ){

2617  (
c
ğ*
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2618 
Ãxtı
 = 
ı
;

2619 }ifĞ
c
==':' && 
ı
[1]==':' && cp[2]=='=' ){

2620 
ı
 += 3;

2621 
Ãxtı
 = 
ı
;

2622 }ifĞ(
c
=='/' || c=='|'è&& 
	`i§Íha
(
ı
[1]) ){

2623 
ı
 += 2;

2624  (
c
 = *
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2625 
Ãxtı
 = 
ı
;

2627 
ı
++;

2628 
Ãxtı
 = 
ı
;

2630 
c
 = *
ı
;

2631 *
ı
 = 0;

2632 
	`·r£Ú‘ok’
(&
ps
);

2633 *
ı
 = 
c
;

2634 
ı
 = 
Ãxtı
;

2636 
	`ä“
(
febuf
);

2637 
gp
->
ruË
 = 
ps
.
fœ¡ruË
;

2638 
gp
->
”rÜút
 = 
ps
.errorcnt;

2639 
	}
}

2645 
¶šk
 *
	g¶šk_ä“li¡
 = 0;

2648 
¶šk
 *
	$Plšk_Ãw
(){

2649 
¶šk
 *
Ãw
;

2651 ifĞ
¶šk_ä“li¡
==0 ){

2652 
i
;

2653 
amt
 = 100;

2654 
¶šk_ä“li¡
 = (
¶šk
 *)
	`ÿÎoc
Ğ
amt
, (plink) );

2655 ifĞ
¶šk_ä“li¡
==0 ){

2656 
	`årštf
(
¡d”r
,

2658 
	`ex™
(1);

2660 
i
=0; i<
amt
-1; i++è
¶šk_ä“li¡
[i].
Ãxt
 = &plink_freelist[i+1];

2661 
¶šk_ä“li¡
[
amt
-1].
Ãxt
 = 0;

2663 
Ãw
 = 
¶šk_ä“li¡
;

2664 
¶šk_ä“li¡
 =…lšk_ä“li¡->
Ãxt
;

2665  
Ãw
;

2666 
	}
}

2669 
	$Plšk_add
(
¶µ
,
cå
)

2670 
¶šk
 **
¶µ
;

2671 
cÚfig
 *
cå
;

2673 
¶šk
 *
Ãw
;

2674 
Ãw
 = 
	`Plšk_Ãw
();

2675 
Ãw
->
Ãxt
 = *
¶µ
;

2676 *
¶µ
 = 
Ãw
;

2677 
Ãw
->
cå
 = cfp;

2678 
	}
}

2681 
	$Plšk_cİy
(
to
,
äom
)

2682 
¶šk
 **
to
;

2683 
¶šk
 *
äom
;

2685 
¶šk
 *
Ãxl
;

2686  
äom
 ){

2687 
Ãxl
 = 
äom
->
Ãxt
;

2688 
äom
->
Ãxt
 = *
to
;

2689 *
to
 = 
äom
;

2690 
äom
 = 
Ãxl
;

2692 
	}
}

2695 
	$Plšk_d–‘e
(
¶p
)

2696 
¶šk
 *
¶p
;

2698 
¶šk
 *
Ãxl
;

2700  
¶p
 ){

2701 
Ãxl
 = 
¶p
->
Ãxt
;

2702 
¶p
->
Ãxt
 = 
¶šk_ä“li¡
;

2703 
¶šk_ä“li¡
 = 
¶p
;

2704 
¶p
 = 
Ãxl
;

2706 
	}
}

2716 
PRIVATE
 *
	$fe_mak’ame
(
Ëmp
,
suffix
)

2717 
ËmÚ
 *
Ëmp
;

2718 *
suffix
;

2720 *
Çme
;

2721 *
ı
;

2723 
Çme
 = 
	`m®loc
Ğ
	`ËmÚSŒËn
(
Ëmp
->
f’ame
è+†emÚSŒËn(
suffix
) + 5 );

2724 ifĞ
Çme
==0 ){

2725 
	`årštf
(
¡d”r
,"Can't‡llocate space for‡ filename.\n");

2726 
	`ex™
(1);

2728 
	`¡rıy
(
Çme
,
Ëmp
->
f’ame
);

2729 
ı
 = 
	`¡¼chr
(
Çme
,'.');

2730 ifĞ
ı
 ) *cp = 0;

2731 
	`¡rÿt
(
Çme
,
suffix
);

2732  
Çme
;

2733 
	}
}

2738 
PRIVATE
 
FILE
 *
	$fe_İ’
(
Ëmp
,
suffix
,
mode
)

2739 
ËmÚ
 *
Ëmp
;

2740 *
suffix
;

2741 *
mode
;

2743 
FILE
 *
å
;

2745 ifĞ
Ëmp
->
ouŠame
 ) 
	`ä“
(lemp->outname);

2746 
Ëmp
->
ouŠame
 = 
	`fe_mak’ame
Öemp, 
suffix
);

2747 
å
 = 
	`fİ’
(
Ëmp
->
ouŠame
,
mode
);

2748 ifĞ
å
==0 && *
mode
=='w' ){

2749 
	`årštf
(
¡d”r
,"Cª'ˆİ’ f\"%s\".\n",
Ëmp
->
ouŠame
);

2750 
Ëmp
->
”rÜút
++;

2753  
å
;

2754 
	}
}

2758 
	$R•ršt
(
Ëmp
)

2759 
ËmÚ
 *
Ëmp
;

2761 
ruË
 *
½
;

2762 
symbŞ
 *
¥
;

2763 
i
, 
j
, 
maxËn
, 
Ën
, 
ncŞumns
, 
sk
;

2764 
	`´štf
("// R•ršˆoàšpuˆf\"%s\".\n// SymbŞs:\n",
Ëmp
->
f’ame
);

2765 
maxËn
 = 10;

2766 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2767 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2768 
Ën
 = 
	`ËmÚSŒËn
(
¥
->
Çme
);

2769 ifĞ
Ën
>
maxËn
 ) maxlen =†en;

2771 
ncŞumns
 = 76/(
maxËn
+5);

2772 ifĞ
ncŞumns
<1 )‚columns = 1;

2773 
sk
 = (
Ëmp
->
nsymbŞ
 + 
ncŞumns
 - 1)/ncolumns;

2774 
i
=0; i<
sk
; i++){

2775 
	`´štf
("//");

2776 
j
=
i
; j<
Ëmp
->
nsymbŞ
; j+=
sk
){

2777 
¥
 = 
Ëmp
->
symbŞs
[
j
];

2778 
	`as£¹
Ğ
¥
->
šdex
==
j
 );

2779 
	`´štf
(" %3d %-*.*s",
j
,
maxËn
,maxËn,
¥
->
Çme
);

2781 
	`´štf
("\n");

2783 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

2784 
	`´štf
("%s",
½
->
lhs
->
Çme
);

2786 
	`´štf
(" ::=");

2787 
i
=0; i<
½
->
Ähs
; i++){

2788 
¥
 = 
½
->
rhs
[
i
];

2789 
	`´štf
(" %s", 
¥
->
Çme
);

2790 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

2791 
j
=1; j<
¥
->
nsubsym
; j++){

2792 
	`´štf
("|%s", 
¥
->
subsym
[
j
]->
Çme
);

2797 
	`´štf
(".");

2798 ifĞ
½
->
´ecsym
 ) 
	`´štf
(" [%s]",½->´ecsym->
Çme
);

2800 
	`´štf
("\n");

2802 
	}
}

2804 
	$CÚfigPršt
(
å
,
cå
)

2805 
FILE
 *
å
;

2806 
cÚfig
 *
cå
;

2808 
ruË
 *
½
;

2809 
symbŞ
 *
¥
;

2810 
i
, 
j
;

2811 
½
 = 
cå
->rp;

2812 
	`årštf
(
å
,"% ::=",
½
->
lhs
->
Çme
);

2813 
i
=0; i<=
½
->
Ähs
; i++){

2814 ifĞ
i
==
cå
->
dÙ
 ) 
	`årštf
(
å
," *");

2815 ifĞ
i
==
½
->
Ähs
 ) ;

2816 
¥
 = 
½
->
rhs
[
i
];

2817 
	`årštf
(
å
," %s", 
¥
->
Çme
);

2818 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

2819 
j
=1; j<
¥
->
nsubsym
; j++){

2820 
	`årštf
(
å
,"|%s",
¥
->
subsym
[
j
]->
Çme
);

2824 
	}
}

2829 
PRIVATE
 
	$S‘Pršt
(
out
,
£t
,
Ëmp
)

2830 
FILE
 *
out
;

2831 *
£t
;

2832 
ËmÚ
 *
Ëmp
;

2834 
i
;

2835 *
¥aûr
;

2836 
¥aûr
 = "";

2837 
	`årštf
(
out
,"%12s[","");

2838 
i
=0; i<
Ëmp
->
Á”mš®
; i++){

2839 ifĞ
	`S‘Fšd
(
£t
,
i
) ){

2840 
	`årštf
(
out
,"%s%s",
¥aûr
,
Ëmp
->
symbŞs
[
i
]->
Çme
);

2841 
¥aûr
 = " ";

2844 
	`årštf
(
out
,"]\n");

2845 
	}
}

2848 
PRIVATE
 
	$PlškPršt
(
out
,
¶p
,
g
)

2849 
FILE
 *
out
;

2850 
¶šk
 *
¶p
;

2851 *
g
;

2853  
¶p
 ){

2854 
	`årštf
(
out
,"%12s% (¡©%2dè","",
g
,
¶p
->
cå
->
¡p
->
¡©’um
);

2855 
	`CÚfigPršt
(
out
,
¶p
->
cå
);

2856 
	`årštf
(
out
,"\n");

2857 
¶p
 =…Í->
Ãxt
;

2859 
	}
}

2865 
	$PrštAùiÚ
(
aùiÚ
 *
­
, 
FILE
 *
å
, 
šd’t
){

2866 
»suÉ
 = 1;

2867  
­
->
ty³
 ){

2868 
SHIFT
:

2869 
	`årštf
(
å
,"%* shiá %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
¡©’um
);

2871 
REDUCE
:

2872 
	`årštf
(
å
,"%* »duû %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2874 
ACCEPT
:

2875 
	`årštf
(
å
,"%* acû±",
šd’t
,
­
->
¥
->
Çme
);

2877 
ERROR
:

2878 
	`årštf
(
å
,"%* ”rÜ",
šd’t
,
­
->
¥
->
Çme
);

2880 
SRCONFLICT
:

2881 
RRCONFLICT
:

2882 
	`årštf
(
å
,"%*s„educe %-3d ** Parsing conflict **",

2883 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2885 
SSCONFLICT
:

2886 
	`årštf
(
å
,"%*s shift %d ** Parsing conflict **",

2887 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
¡©’um
);

2889 
SH_RESOLVED
:

2890 
RD_RESOLVED
:

2891 
NOT_USED
:

2892 
»suÉ
 = 0;

2895  
»suÉ
;

2896 
	}
}

2899 
	$R•ÜtOuut
(
Ëmp
)

2900 
ËmÚ
 *
Ëmp
;

2902 
i
;

2903 
¡©e
 *
¡p
;

2904 
cÚfig
 *
cå
;

2905 
aùiÚ
 *
­
;

2906 
FILE
 *
å
;

2908 
å
 = 
	`fe_İ’
(
Ëmp
,".out","wb");

2909 ifĞ
å
==0 ) ;

2910 
i
=0; i<
Ëmp
->
n¡©e
; i++){

2911 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

2912 
	`årštf
(
å
,"S‹ %d:\n",
¡p
->
¡©’um
);

2913 ifĞ
Ëmp
->
basisæag
 ) 
cå
=
¡p
->
bp
;

2914 
cå
=
¡p
->cfp;

2915  
cå
 ){

2916 
buf
[20];

2917 ifĞ
cå
->
dÙ
==cå->
½
->
Ähs
 ){

2918 
	`¥rštf
(
buf
,"(%d)",
cå
->
½
->
šdex
);

2919 
	`årštf
(
å
," %5 ",
buf
);

2921 
	`årštf
(
å
," ");

2923 
	`CÚfigPršt
(
å
,
cå
);

2924 
	`årštf
(
å
,"\n");

2926 
	`S‘Pršt
(
å
,
cå
->
fws
,
Ëmp
);

2927 
	`PlškPršt
(
å
,
cå
->
åÍ
,"To ");

2928 
	`PlškPršt
(
å
,
cå
->
b¶p
,"From");

2930 ifĞ
Ëmp
->
basisæag
 ) 
cå
=cå->
bp
;

2931 
cå
=cå->
Ãxt
;

2933 
	`årštf
(
å
,"\n");

2934 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

2935 ifĞ
	`PrštAùiÚ
(
­
,
å
,30èè
	`årštf
(fp,"\n");

2937 
	`årštf
(
å
,"\n");

2939 
	`årštf
(
å
, "----------------------------------------------------\n");

2940 
	`årštf
(
å
, "Symbols:\n");

2941 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2942 
j
;

2943 
symbŞ
 *
¥
;

2945 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2946 
	`årštf
(
å
, " %3d: %s", 
i
, 
¥
->
Çme
);

2947 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

2948 
	`årštf
(
å
, ":");

2949 ifĞ
¥
->
Ïmbda
 ){

2950 
	`årštf
(
å
, " <lambda>");

2952 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

2953 ifĞ
¥
->
fœ¡£t
 && 
	`S‘Fšd
(¥->fœ¡£t, 
j
) ){

2954 
	`årštf
(
å
, " %s", 
Ëmp
->
symbŞs
[
j
]->
Çme
);

2958 
	`årštf
(
å
, "\n");

2960 
	`fşo£
(
å
);

2962 
	}
}

2966 
PRIVATE
 *
	$·th£¬ch
(
¬gv0
,
Çme
,
modemask
)

2967 *
¬gv0
;

2968 *
Çme
;

2969 
modemask
;

2971 *
·thli¡
;

2972 *
·th
,*
ı
;

2973 
c
;

2975 #ifdeà
__WIN32__


2976 
ı
 = 
	`¡¼chr
(
¬gv0
,'\\');

2978 
ı
 = 
	`¡¼chr
(
¬gv0
,'/');

2980 ifĞ
ı
 ){

2981 
c
 = *
ı
;

2982 *
ı
 = 0;

2983 
·th
 = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
¬gv0
è+†emÚSŒËn(
Çme
) + 2 );

2984 ifĞ
·th
 ) 
	`¥rštf
Õ©h,"%s/%s",
¬gv0
,
Çme
);

2985 *
ı
 = 
c
;

2987 *
	`g‘’v
();

2988 
·thli¡
 = 
	`g‘’v
("PATH");

2989 ifĞ
·thli¡
==0 )…athlist = ".:/bin:/usr/bin";

2990 
·th
 = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
·thli¡
)+ËmÚSŒËn(
Çme
)+2 );

2991 ifĞ
·th
!=0 ){

2992  *
·thli¡
 ){

2993 
ı
 = 
	`¡rchr
(
·thli¡
,':');

2994 ifĞ
ı
==0 ) c°ğ&
·thli¡
[
	`ËmÚSŒËn
(pathlist)];

2995 
c
 = *
ı
;

2996 *
ı
 = 0;

2997 
	`¥rštf
(
·th
,"%s/%s",
·thli¡
,
Çme
);

2998 *
ı
 = 
c
;

2999 ifĞ
c
==0 ) 
·thli¡
 = "";

3000 
·thli¡
 = &
ı
[1];

3001 ifĞ
	`acûss
(
·th
,
modemask
)==0 ) ;

3005  
·th
;

3006 
	}
}

3012 
PRIVATE
 
	$compu‹_aùiÚ
(
Ëmp
,
­
)

3013 
ËmÚ
 *
Ëmp
;

3014 
aùiÚ
 *
­
;

3016 
aù
;

3017  
­
->
ty³
 ){

3018 
SHIFT
: 
aù
 = 
­
->
x
.
¡p
->
¡©’um
; ;

3019 
REDUCE
: 
aù
 = 
­
->
x
.
½
->
šdex
 + 
Ëmp
->
n¡©e
; ;

3020 
ERROR
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
; ;

3021 
ACCEPT
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 1; ;

3022 : 
aù
 = -1; ;

3024  
aù
;

3025 
	}
}

3027 
	#LINESIZE
 1000

	)

3037 
PRIVATE
 
	$É_xãr
(
Çme
,
š
,
out
,
lš’o
)

3038 *
Çme
;

3039 
FILE
 *
š
;

3040 
FILE
 *
out
;

3041 *
lš’o
;

3043 
i
, 
iS¹
;

3044 
lše
[
LINESIZE
];

3045  
	`fg‘s
(
lše
,
LINESIZE
,
š
) && (line[0]!='%' ||†ine[1]!='%') ){

3046 (*
lš’o
)++;

3047 
iS¹
 = 0;

3048 ifĞ
Çme
 ){

3049 
i
=0; 
lše
[i]; i++){

3050 ifĞ
lše
[
i
]=='P' && 
	`¡ºcmp
(&line[i],"Parse",5)==0

3051 && (
i
==0 || !
	`i§Íha
(
lše
[i-1]))

3053 ifĞ
i
>
iS¹
 ) 
	`årštf
(
out
,"%.*s",i-iS¹,&
lše
[iStart]);

3054 
	`årštf
(
out
,"%s",
Çme
);

3055 
i
 += 4;

3056 
iS¹
 = 
i
+1;

3060 
	`årštf
(
out
,"%s",&
lše
[
iS¹
]);

3062 
	}
}

3066 
PRIVATE
 
FILE
 *
	$É_İ’
(
Ëmp
)

3067 
ËmÚ
 *
Ëmp
;

3069 
‹m¶©’ame
[] = "lempar.c";

3070 
buf
[1000];

3071 
FILE
 *
š
;

3072 *
ÉÇme
;

3073 *
ı
;

3075 
ı
 = 
	`¡¼chr
(
Ëmp
->
f’ame
,'.');

3076 ifĞ
ı
 ){

3077 
	`¥rštf
(
buf
,"%.*s.É",()(
ı
-
Ëmp
->
f’ame
),lemp->filename);

3079 
	`¥rštf
(
buf
,"%s.É",
Ëmp
->
f’ame
);

3081 ifĞ
	`acûss
(
buf
,004)==0 ){

3082 
ÉÇme
 = 
buf
;

3083 }ifĞ
	`acûss
(
‹m¶©’ame
,004)==0 ){

3084 
ÉÇme
 = 
‹m¶©’ame
;

3086 
ÉÇme
 = 
	`·th£¬ch
(
Ëmp
->
¬gv0
,
‹m¶©’ame
,0);

3088 ifĞ
ÉÇme
==0 ){

3089 
	`årštf
(
¡d”r
,"Can't findhe…arser driveremplate file \"%s\".\n",

3090 
‹m¶©’ame
);

3091 
Ëmp
->
”rÜút
++;

3094 
š
 = 
	`fİ’
(
ÉÇme
,"rb");

3095 ifĞ
š
==0 ){

3096 
	`årštf
(
¡d”r
,"Cª'ˆİ’h‹m¶©f\"%s\".\n",
‹m¶©’ame
);

3097 
Ëmp
->
”rÜút
++;

3100  
š
;

3101 
	}
}

3104 
PRIVATE
 
	$É_lšedœ
(
out
,
lš’o
,
f’ame
)

3105 
FILE
 *
out
;

3106 
lš’o
;

3107 *
f’ame
;

3109 
	`årštf
(
out
,"#lš%d \"",
lš’o
);

3110  *
f’ame
 ){

3111 ifĞ*
f’ame
 =ğ'\\' ) 
	`putc
('\\',
out
);

3112 
	`putc
(*
f’ame
,
out
);

3113 
f’ame
++;

3115 
	`årštf
(
out
,"\"\n");

3116 
	}
}

3119 
PRIVATE
 
	$É_´št
(
out
,
Ëmp
,
¡r
,
lš’o
)

3120 
FILE
 *
out
;

3121 
ËmÚ
 *
Ëmp
;

3122 *
¡r
;

3123 *
lš’o
;

3125 ifĞ
¡r
==0 ) ;

3126  *
¡r
 ){

3127 
	`putc
(*
¡r
,
out
);

3128 ifĞ*
¡r
=='\n' ) (*
lš’o
)++;

3129 
¡r
++;

3131 ifĞ
¡r
[-1]!='\n' ){

3132 
	`putc
('\n',
out
);

3133 (*
lš’o
)++;

3135 ià(!
Ëmp
->
nŞš’osæag
) {

3136 (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,
Ëmp
->
ouŠame
);

3139 
	}
}

3145 
	$em™_de¡ruùÜ_code
(
out
,
¥
,
Ëmp
,
lš’o
)

3146 
FILE
 *
out
;

3147 
symbŞ
 *
¥
;

3148 
ËmÚ
 *
Ëmp
;

3149 *
lš’o
;

3151 *
ı
 = 0;

3153 ifĞ
¥
->
ty³
==
TERMINAL
 ){

3154 
ı
 = 
Ëmp
->
tok’de¡
;

3155 ifĞ
ı
==0 ) ;

3156 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3157 }ifĞ
¥
->
de¡ruùÜ
 ){

3158 
ı
 = 
¥
->
de¡ruùÜ
;

3159 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3160 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,
¥
->
de¡Lš’o
,Ëmp->
f’ame
); }

3161 }ifĞ
Ëmp
->
v¬de¡
 ){

3162 
ı
 = 
Ëmp
->
v¬de¡
;

3163 ifĞ
ı
==0 ) ;

3164 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3166 
	`as£¹
( 0 );

3168 ; *
ı
; cp++){

3169 ifĞ*
ı
=='$' && cp[1]=='$' ){

3170 
	`årštf
(
out
,"(yypmšÜ->yy%d)",
¥
->
dŠum
);

3171 
ı
++;

3174 ifĞ*
ı
=='\n' ) (*
lš’o
)++;

3175 
	`åutc
(*
ı
,
out
);

3177 
	`årštf
(
out
,"\n"); (*
lš’o
)++;

3178 ià(!
Ëmp
->
nŞš’osæag
) {

3179 (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,
Ëmp
->
ouŠame
);

3181 
	`årštf
(
out
,"}\n"); (*
lš’o
)++;

3183 
	}
}

3188 
	$has_de¡ruùÜ
(
¥
, 
Ëmp
)

3189 
symbŞ
 *
¥
;

3190 
ËmÚ
 *
Ëmp
;

3192 
»t
;

3193 ifĞ
¥
->
ty³
==
TERMINAL
 ){

3194 
»t
 = 
Ëmp
->
tok’de¡
!=0;

3196 
»t
 = 
Ëmp
->
v¬de¡
!=0 || 
¥
->
de¡ruùÜ
!=0;

3198  
»t
;

3199 
	}
}

3213 
PRIVATE
 *
	$­³nd_¡r
(*
zText
, 
n
, 
p1
, 
p2
){

3214 *
z
 = 0;

3215 
®loûd
 = 0;

3216 
u£d
 = 0;

3217 
c
;

3218 
zIÁ
[40];

3220 ifĞ
zText
==0 ){

3221 
u£d
 = 0;

3222  
z
;

3224 ifĞ
n
<=0 ){

3225 ifĞ
n
<0 ){

3226 
u£d
 +ğ
n
;

3227 
	`as£¹
Ğ
u£d
>=0 );

3229 
n
 = 
	`ËmÚSŒËn
(
zText
);

3231 ifĞ
n
+(
zIÁ
)*2+
u£d
 >ğ
®loûd
 ){

3232 
®loûd
 = 
n
 + (
zIÁ
)*2 + 
u£d
 + 200;

3233 
z
 = 
	`»®loc
(z, 
®loûd
);

3235 ifĞ
z
==0 )  "";

3236  
n
-- > 0 ){

3237 
c
 = *(
zText
++);

3238 ifĞ
c
=='%' && 
n
>0 && 
zText
[0]=='d' ){

3239 
	`¥rštf
(
zIÁ
, "%d", 
p1
);

3240 
p1
 = 
p2
;

3241 
	`¡rıy
(&
z
[
u£d
], 
zIÁ
);

3242 
u£d
 +ğ
	`ËmÚSŒËn
(&
z
[used]);

3243 
zText
++;

3244 
n
--;

3246 
z
[
u£d
++] = 
c
;

3249 
z
[
u£d
] = 0;

3250  
z
;

3251 
	}
}

3258 
PRIVATE
 
	$Œª¦©e_code
(
ËmÚ
 *
Ëmp
, 
ruË
 *
½
){

3259 *
ı
, *
xp
;

3260 
i
;

3261 
lhsu£d
 = 0;

3262 
u£d
[
MAXRHS
];

3264 
i
=0; i<
½
->
Ähs
; i++è
u£d
[i] = 0;

3265 
lhsu£d
 = 0;

3267 ifĞ
½
->
code
==0 ){

3268 
½
->
code
 = "\n";

3269 
½
->
lše
 =„p->
ruËlše
;

3272 
	`­³nd_¡r
(0,0,0,0);

3273 
ı
=
½
->
code
; *cp; cp++){

3274 ifĞ
	`i§Íha
(*
ı
è&& (ı==
½
->
code
 || (!
	`i§Êum
(cp[-1]) && cp[-1]!='_')) ){

3275 
§ved
;

3276 
xp
ğ&
ı
[1]; 
	`i§Êum
(*xp) || *xp=='_'; xp++);

3277 
§ved
 = *
xp
;

3278 *
xp
 = 0;

3279 ifĞ
½
->
lh§lŸs
 && 
	`¡rcmp
(
ı
,rp->lhsalias)==0 ){

3280 
	`­³nd_¡r
("yygÙomšÜ.yy%d",0,
½
->
lhs
->
dŠum
,0);

3281 
ı
 = 
xp
;

3282 
lhsu£d
 = 1;

3284 
i
=0; i<
½
->
Ähs
; i++){

3285 ifĞ
½
->
rh§lŸs
[
i
] && 
	`¡rcmp
(
ı
,rp->rhsalias[i])==0 ){

3286 ifĞ
ı
!=
½
->
code
 && cp[-1]=='@' ){

3289 
	`­³nd_¡r
("yym¥[%d].majÜ",-1,
i
-
½
->
Ähs
+1,0);

3291 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

3292 
dŠum
;

3293 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

3294 
dŠum
 = 
¥
->
subsym
[0]->dtnum;

3296 
dŠum
 = 
¥
->dtnum;

3298 
	`­³nd_¡r
("yym¥[%d].mšÜ.yy%d",0,
i
-
½
->
Ähs
+1, 
dŠum
);

3300 
ı
 = 
xp
;

3301 
u£d
[
i
] = 1;

3306 *
xp
 = 
§ved
;

3308 
	`­³nd_¡r
(
ı
, 1, 0, 0);

3312 ifĞ
½
->
lh§lŸs
 && !
lhsu£d
 ){

3313 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3315 
½
->
lh§lŸs
,½->
lhs
->
Çme
,rp->lhsalias);

3316 
Ëmp
->
”rÜút
++;

3321 
i
=0; i<
½
->
Ähs
; i++){

3322 ifĞ
½
->
rh§lŸs
[
i
] && !
u£d
[i] ){

3323 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3325 
½
->
rh§lŸs
[
i
],½->
rhs
[i]->
Çme
,rp->rhsalias[i]);

3326 
Ëmp
->
”rÜút
++;

3327 }ifĞ
½
->
rh§lŸs
[
i
]==0 ){

3328 ifĞ
	`has_de¡ruùÜ
(
½
->
rhs
[
i
],
Ëmp
) ){

3329 
	`­³nd_¡r
(" yy_destructor(yypParser,%d,&yymsp[%d].minor);\n", 0,

3330 
½
->
rhs
[
i
]->
šdex
,i-½->
Ähs
+1);

3336 ifĞ
½
->
code
 ){

3337 
ı
 = 
	`­³nd_¡r
(0,0,0,0);

3338 
½
->
code
 = 
	`SŒ§ã
(
ı
?cp:"");

3340 
	}
}

3346 
PRIVATE
 
	$em™_code
(
out
,
½
,
Ëmp
,
lš’o
)

3347 
FILE
 *
out
;

3348 
ruË
 *
½
;

3349 
ËmÚ
 *
Ëmp
;

3350 *
lš’o
;

3352 *
ı
;

3355 ifĞ
½
->
code
 ){

3356 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,
½
->
lše
,Ëmp->
f’ame
); }

3357 
	`årštf
(
out
,"{%s",
½
->
code
);

3358 
ı
=
½
->
code
; *cp; cp++){

3359 ifĞ*
ı
=='\n' ) (*
lš’o
)++;

3361 
	`årštf
(
out
,"}\n"); (*
lš’o
)++;

3362 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,Ëmp->
ouŠame
); }

3366 
	}
}

3375 
	$´št_¡ack_uniÚ
(
out
,
Ëmp
,
¶š’o
,
mhæag
)

3376 
FILE
 *
out
;

3377 
ËmÚ
 *
Ëmp
;

3378 *
¶š’o
;

3379 
mhæag
;

3381 
lš’o
 = *
¶š’o
;

3382 **
ty³s
;

3383 
¬¿ysize
;

3384 
maxd’gth
;

3385 *
¡ddt
;

3386 
i
,
j
;

3387 
hash
;

3388 *
Çme
;

3391 
¬¿ysize
 = 
Ëmp
->
nsymbŞ
 * 2;

3392 
ty³s
 = (**)
	`ÿÎoc
Ğ
¬¿ysize
, (*) );

3393 
i
=0; i<
¬¿ysize
; i++è
ty³s
[i] = 0;

3394 
maxd’gth
 = 0;

3395 ifĞ
Ëmp
->
v¬ty³
 ){

3396 
maxd’gth
 = 
	`ËmÚSŒËn
(
Ëmp
->
v¬ty³
);

3398 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3399 
Ën
;

3400 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3401 ifĞ
¥
->
d©©y³
==0 ) ;

3402 
Ën
 = 
	`ËmÚSŒËn
(
¥
->
d©©y³
);

3403 ifĞ
Ën
>
maxd’gth
 ) maxdtlength =†en;

3405 
¡ddt
 = (*)
	`m®loc
Ğ
maxd’gth
*2 + 1 );

3406 ifĞ
ty³s
==0 || 
¡ddt
==0 ){

3407 
	`årštf
(
¡d”r
,"Out of memory.\n");

3408 
	`ex™
(1);

3417 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3418 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3419 *
ı
;

3420 ifĞ
¥
==
Ëmp
->
”rsym
 ){

3421 
¥
->
dŠum
 = 
¬¿ysize
+1;

3424 ifĞ
¥
->
ty³
!=
NONTERMINAL
 || (¥->
d©©y³
==0 && 
Ëmp
->
v¬ty³
==0) ){

3425 
¥
->
dŠum
 = 0;

3428 
ı
 = 
¥
->
d©©y³
;

3429 ifĞ
ı
==0 ) c°ğ
Ëmp
->
v¬ty³
;

3430 
j
 = 0;

3431  
	`is¥aû
(*
ı
) ) cp++;

3432  *
ı
 ) 
¡ddt
[
j
++] = *cp++;

3433  
j
>0 && 
	`is¥aû
(
¡ddt
[j-1]) ) j--;

3434 
¡ddt
[
j
] = 0;

3435 ifĞ
Ëmp
->
tok’ty³
 && 
	`¡rcmp
(
¡ddt
,†emp->tokentype)==0 ){

3436 
¥
->
dŠum
 = 0;

3439 
hash
 = 0;

3440 
j
=0; 
¡ddt
[j]; j++){

3441 
hash
 = hash*53 + 
¡ddt
[
j
];

3443 
hash
 = (hash & 0x7fffffff)%
¬¿ysize
;

3444  
ty³s
[
hash
] ){

3445 ifĞ
	`¡rcmp
(
ty³s
[
hash
],
¡ddt
)==0 ){

3446 
¥
->
dŠum
 = 
hash
 + 1;

3449 
hash
++;

3450 ifĞ
hash
>=
¬¿ysize
 ) hash = 0;

3452 ifĞ
ty³s
[
hash
]==0 ){

3453 
¥
->
dŠum
 = 
hash
 + 1;

3454 
ty³s
[
hash
] = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
¡ddt
)+1 );

3455 ifĞ
ty³s
[
hash
]==0 ){

3456 
	`årštf
(
¡d”r
,"Out of memory.\n");

3457 
	`ex™
(1);

3459 
	`¡rıy
(
ty³s
[
hash
],
¡ddt
);

3464 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3465 
lš’o
 = *
¶š’o
;

3466 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++; }

3467 
	`årštf
(
out
,"#defš%sTOKENTYPE %s\n",
Çme
,

3468 
Ëmp
->
tok’ty³
?Ëmp->tok’ty³:"void*"); 
lš’o
++;

3469 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++; }

3470 
	`årštf
(
out
,"ty³deàuniÚ {\n"); 
lš’o
++;

3471 
	`årštf
(
out
," iÁ yyš™;\n"); 
lš’o
++;

3472 
	`årštf
(
out
," %sTOKENTYPE yy0;\n",
Çme
); 
lš’o
++;

3473 
i
=0; i<
¬¿ysize
; i++){

3474 ifĞ
ty³s
[
i
]==0 ) ;

3475 
	`årštf
(
out
," % yy%d;\n",
ty³s
[
i
],i+1); 
lš’o
++;

3476 
	`ä“
(
ty³s
[
i
]);

3478 ifĞ
Ëmp
->
”rsym
->
u£CÁ
 ){

3479 
	`årštf
(
out
," iÁ yy%d;\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3481 
	`ä“
(
¡ddt
);

3482 
	`ä“
(
ty³s
);

3483 
	`årštf
(
out
,"} YYMINORTYPE;\n"); 
lš’o
++;

3484 *
¶š’o
 = 
lš’o
;

3485 
	}
}

3491 cÚ¡ *
	$mšimum_size_ty³
(
lwr
, 
u´
){

3492 ifĞ
lwr
>=0 ){

3493 ifĞ
u´
<=255 ){

3495 }ifĞ
u´
<65535 ){

3500 }ifĞ
lwr
>=-127 && 
u´
<=127 ){

3502 }ifĞ
lwr
>=-32767 && 
u´
<32767 ){

3507 
	}
}

3515 
	sax£t
 {

3516 
¡©e
 *
	m¡p
;

3517 
	misTkn
;

3518 
	mnAùiÚ
;

3524 
	$ax£t_com·»
(cÚ¡ *
a
, cÚ¡ *
b
){

3525 
ax£t
 *
p1
 = (ax£t*)
a
;

3526 
ax£t
 *
p2
 = (ax£t*)
b
;

3527  
p2
->
nAùiÚ
 - 
p1
->nAction;

3528 
	}
}

3533 
	$wr™eRuËText
(
FILE
 *
out
, 
ruË
 *
½
){

3534 
j
;

3535 
	`årštf
(
out
,"% ::=", 
½
->
lhs
->
Çme
);

3536 
j
=0; j<
½
->
Ähs
; j++){

3537 
symbŞ
 *
¥
 = 
½
->
rhs
[
j
];

3538 
	`årštf
(
out
," %s", 
¥
->
Çme
);

3539 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

3540 
k
;

3541 
k
=1; k<
¥
->
nsubsym
; k++){

3542 
	`årštf
(
out
,"|%s",
¥
->
subsym
[
k
]->
Çme
);

3546 
	}
}

3550 
	$R•ÜtTabË
(
Ëmp
, 
mhæag
)

3551 
ËmÚ
 *
Ëmp
;

3552 
mhæag
;

3554 
FILE
 *
out
, *
š
;

3555 
lše
[
LINESIZE
];

3556 
lš’o
;

3557 
¡©e
 *
¡p
;

3558 
aùiÚ
 *
­
;

3559 
ruË
 *
½
;

3560 
aùb
 *
pAùb
;

3561 
i
, 
j
, 
n
;

3562 *
Çme
;

3563 
mnTknOf¡
, 
mxTknOf¡
;

3564 
mnNtOf¡
, 
mxNtOf¡
;

3565 
ax£t
 *
ax
;

3567 
š
 = 
	`É_İ’
(
Ëmp
);

3568 ifĞ
š
==0 ) ;

3569 
out
 = 
	`fe_İ’
(
Ëmp
,".c","wb");

3570 ifĞ
out
==0 ){

3571 
	`fşo£
(
š
);

3574 
lš’o
 = 1;

3575 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3578 
	`É_´št
(
out
,
Ëmp
,Ëmp->
šşude
,&
lš’o
);

3579 ifĞ
mhæag
 ){

3580 *
Çme
 = 
	`fe_mak’ame
(
Ëmp
, ".h");

3581 
	`årštf
(
out
,"#šşud\"%s\"\n", 
Çme
); 
lš’o
++;

3582 
	`ä“
(
Çme
);

3584 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3587 ifĞ
mhæag
 ){

3588 *
´efix
;

3589 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3590 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3591 
´efix
 = "";

3592 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

3593 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

3594 
lš’o
++;

3596 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3598 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3601 
	`årštf
(
out
,"#define YYCODETYPE %s\n",

3602 
	`mšimum_size_ty³
(0, 
Ëmp
->
nsymbŞ
+1)); 
lš’o
++;

3603 
	`årštf
(
out
,"#defšYYNOCODE %d\n",
Ëmp
->
nsymbŞ
+1); 
lš’o
++;

3604 
	`årštf
(
out
,"#define YYACTIONTYPE %s\n",

3605 
	`mšimum_size_ty³
(0, 
Ëmp
->
n¡©e
+Ëmp->
ÄuË
+5)); 
lš’o
++;

3606 ifĞ
Ëmp
->
wdÿrd
 ){

3607 
	`årštf
(
out
,"#define YYWILDCARD %d\n",

3608 
Ëmp
->
wdÿrd
->
šdex
); 
lš’o
++;

3610 
	`´št_¡ack_uniÚ
(
out
,
Ëmp
,&
lš’o
,
mhæag
);

3611 
	`årštf
(
out
, "#iâdeàYYSTACKDEPTH\n"); 
lš’o
++;

3612 ifĞ
Ëmp
->
¡acksize
 ){

3613 
	`årštf
(
out
,"#defšYYSTACKDEPTH %s\n",
Ëmp
->
¡acksize
); 
lš’o
++;

3615 
	`årštf
(
out
,"#defšYYSTACKDEPTH 100\n"); 
lš’o
++;

3617 
	`årštf
(
out
, "#’dif\n"); 
lš’o
++;

3618 ifĞ
mhæag
 ){

3619 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3621 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3622 ifĞ
Ëmp
->
¬g
 &&†emp->arg[0] ){

3623 
i
;

3624 
i
 = 
	`ËmÚSŒËn
(
Ëmp
->
¬g
);

3625  
i
>=1 && 
	`is¥aû
(
Ëmp
->
¬g
[i-1]) ) i--;

3626  
i
>=1 && (
	`i§Êum
(
Ëmp
->
¬g
[i-1]) ||†emp->arg[i-1]=='_') ) i--;

3627 
	`årštf
(
out
,"#defš%sARG_SDECL %s;\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3628 
	`årštf
(
out
,"#defš%sARG_PDECL ,%s\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3629 
	`årštf
(
out
,"#define %sARG_FETCH %s = yypParser->%s\n",

3630 
Çme
,
Ëmp
->
¬g
,&Ëmp->¬g[
i
]); 
lš’o
++;

3631 
	`årštf
(
out
,"#define %sARG_STORE yypParser->%s = %s\n",

3632 
Çme
,&
Ëmp
->
¬g
[
i
],&Ëmp->¬g[i]); 
lš’o
++;

3634 
	`årštf
(
out
,"#defš%sARG_SDECL\n",
Çme
); 
lš’o
++;

3635 
	`årštf
(
out
,"#defš%sARG_PDECL\n",
Çme
); 
lš’o
++;

3636 
	`årštf
(
out
,"#defš%sARG_FETCH\n",
Çme
); 
lš’o
++;

3637 
	`årštf
(
out
,"#defš%sARG_STORE\n",
Çme
); 
lš’o
++;

3639 ifĞ
mhæag
 ){

3640 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3642 
	`årštf
(
out
,"#defšYYNSTATE %d\n",
Ëmp
->
n¡©e
); 
lš’o
++;

3643 
	`årštf
(
out
,"#defšYYNRULE %d\n",
Ëmp
->
ÄuË
); 
lš’o
++;

3644 ifĞ
Ëmp
->
”rsym
->
u£CÁ
 ){

3645 
	`årštf
(
out
,"#defšYYERRORSYMBOL %d\n",
Ëmp
->
”rsym
->
šdex
); 
lš’o
++;

3646 
	`årštf
(
out
,"#defšYYERRSYMDT yy%d\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3648 ifĞ
Ëmp
->
has_çÎback
 ){

3649 
	`årštf
(
out
,"#defšYYFALLBACK 1\n"); 
lš’o
++;

3651 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3666 
ax
 = 
	`ÿÎoc
(
Ëmp
->
n¡©e
*2, (ax[0]));

3667 ifĞ
ax
==0 ){

3668 
	`årštf
(
¡d”r
,"malloc failed\n");

3669 
	`ex™
(1);

3671 
i
=0; i<
Ëmp
->
n¡©e
; i++){

3672 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3673 
ax
[
i
*2].
¡p
 = stp;

3674 
ax
[
i
*2].
isTkn
 = 1;

3675 
ax
[
i
*2].
nAùiÚ
 = 
¡p
->
nTknAù
;

3676 
ax
[
i
*2+1].
¡p
 = stp;

3677 
ax
[
i
*2+1].
isTkn
 = 0;

3678 
ax
[
i
*2+1].
nAùiÚ
 = 
¡p
->
nNtAù
;

3680 
mxTknOf¡
 = 
mnTknOf¡
 = 0;

3681 
mxNtOf¡
 = 
mnNtOf¡
 = 0;

3687 
	`qsÜt
(
ax
, 
Ëmp
->
n¡©e
*2, ×x[0]), 
ax£t_com·»
);

3688 
pAùb
 = 
	`aùb_®loc
();

3689 
i
=0; i<
Ëmp
->
n¡©e
*2 && 
ax
[i].
nAùiÚ
>0; i++){

3690 
¡p
 = 
ax
[
i
].stp;

3691 ifĞ
ax
[
i
].
isTkn
 ){

3692 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3693 
aùiÚ
;

3694 ifĞ
­
->
¥
->
šdex
>=
Ëmp
->
Á”mš®
 ) ;

3695 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3696 ifĞ
aùiÚ
<0 ) ;

3697 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3699 
¡p
->
iTknOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3700 ifĞ
¡p
->
iTknOf¡
<
mnTknOf¡
 ) mnTknOfst = stp->iTknOfst;

3701 ifĞ
¡p
->
iTknOf¡
>
mxTknOf¡
 ) mxTknOfst = stp->iTknOfst;

3703 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3704 
aùiÚ
;

3705 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ) ;

3706 ifĞ
­
->
¥
->
šdex
==
Ëmp
->
nsymbŞ
 ) ;

3707 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3708 ifĞ
aùiÚ
<0 ) ;

3709 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3711 
¡p
->
iNtOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3712 ifĞ
¡p
->
iNtOf¡
<
mnNtOf¡
 ) mnNtOfst = stp->iNtOfst;

3713 ifĞ
¡p
->
iNtOf¡
>
mxNtOf¡
 ) mxNtOfst = stp->iNtOfst;

3716 
	`ä“
(
ax
);

3719 
	`årštf
(
out
,"¡©iøcÚ¡ YYACTIONTYPE yy_aùiÚ[] = {\n"); 
lš’o
++;

3720 
n
 = 
	`aùb_size
(
pAùb
);

3721 
i
=
j
=0; i<
n
; i++){

3722 
aùiÚ
 = 
	`aùb_yyaùiÚ
(
pAùb
, 
i
);

3723 ifĞ
aùiÚ
<0 )‡ùiÚ = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 2;

3724 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3725 
	`årštf
(
out
, " %4d,", 
aùiÚ
);

3726 ifĞ
j
==9 || 
i
==
n
-1 ){

3727 
	`årštf
(
out
, "\n"); 
lš’o
++;

3728 
j
 = 0;

3730 
j
++;

3733 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3736 
	`årštf
(
out
,"¡©iøcÚ¡ YYCODETYPE yy_lookah—d[] = {\n"); 
lš’o
++;

3737 
i
=
j
=0; i<
n
; i++){

3738 
Ï
 = 
	`aùb_yylookah—d
(
pAùb
, 
i
);

3739 ifĞ
Ï
<0 )†¨ğ
Ëmp
->
nsymbŞ
;

3740 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3741 
	`årštf
(
out
, " %4d,", 
Ï
);

3742 ifĞ
j
==9 || 
i
==
n
-1 ){

3743 
	`årštf
(
out
, "\n"); 
lš’o
++;

3744 
j
 = 0;

3746 
j
++;

3749 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3752 
	`årštf
(
out
, "#defšYY_SHIFT_USE_DFLT (%d)\n", 
mnTknOf¡
-1); 
lš’o
++;

3753 
n
 = 
Ëmp
->
n¡©e
;

3754  
n
>0 && 
Ëmp
->
sÜ‹d
[n-1]->
iTknOf¡
==
NO_OFFSET
 )‚--;

3755 
	`årštf
(
out
, "#defšYY_SHIFT_MAX %d\n", 
n
-1); 
lš’o
++;

3756 
	`årštf
(
out
, "static const %s yy_shift_ofst[] = {\n",

3757 
	`mšimum_size_ty³
(
mnTknOf¡
-1, 
mxTknOf¡
)); 
lš’o
++;

3758 
i
=
j
=0; i<
n
; i++){

3759 
of¡
;

3760 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3761 
of¡
 = 
¡p
->
iTknOf¡
;

3762 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnTknOf¡
 - 1;

3763 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3764 
	`årštf
(
out
, " %4d,", 
of¡
);

3765 ifĞ
j
==9 || 
i
==
n
-1 ){

3766 
	`årštf
(
out
, "\n"); 
lš’o
++;

3767 
j
 = 0;

3769 
j
++;

3772 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3775 
	`årštf
(
out
, "#defšYY_REDUCE_USE_DFLT (%d)\n", 
mnNtOf¡
-1); 
lš’o
++;

3776 
n
 = 
Ëmp
->
n¡©e
;

3777  
n
>0 && 
Ëmp
->
sÜ‹d
[n-1]->
iNtOf¡
==
NO_OFFSET
 )‚--;

3778 
	`årštf
(
out
, "#defšYY_REDUCE_MAX %d\n", 
n
-1); 
lš’o
++;

3779 
	`årštf
(
out
, "static const %s yy_reduce_ofst[] = {\n",

3780 
	`mšimum_size_ty³
(
mnNtOf¡
-1, 
mxNtOf¡
)); 
lš’o
++;

3781 
i
=
j
=0; i<
n
; i++){

3782 
of¡
;

3783 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3784 
of¡
 = 
¡p
->
iNtOf¡
;

3785 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnNtOf¡
 - 1;

3786 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3787 
	`årštf
(
out
, " %4d,", 
of¡
);

3788 ifĞ
j
==9 || 
i
==
n
-1 ){

3789 
	`årštf
(
out
, "\n"); 
lš’o
++;

3790 
j
 = 0;

3792 
j
++;

3795 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3798 
	`årštf
(
out
, "¡©iøcÚ¡ YYACTIONTYPE yy_deçuÉ[] = {\n"); 
lš’o
++;

3799 
n
 = 
Ëmp
->
n¡©e
;

3800 
i
=
j
=0; i<
n
; i++){

3801 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3802 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3803 
	`årštf
(
out
, " %4d,", 
¡p
->
iDæt
);

3804 ifĞ
j
==9 || 
i
==
n
-1 ){

3805 
	`årštf
(
out
, "\n"); 
lš’o
++;

3806 
j
 = 0;

3808 
j
++;

3811 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3812 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3816 ifĞ
Ëmp
->
has_çÎback
 ){

3817 
mx
 = 
Ëmp
->
Á”mš®
 - 1;

3818  
mx
>0 && 
Ëmp
->
symbŞs
[mx]->
çÎback
==0 ){ mx--; }

3819 
i
=0; i<=
mx
; i++){

3820 
symbŞ
 *
p
 = 
Ëmp
->
symbŞs
[
i
];

3821 ifĞ
p
->
çÎback
==0 ){

3822 
	`årštf
(
out
, " 0, /* %10 =>‚Ùhšg */\n", 
p
->
Çme
);

3824 
	`årštf
(
out
, " %3d, /* %10 => % */\n", 
p
->
çÎback
->
šdex
,

3825 
p
->
Çme
,…->
çÎback
->name);

3827 
lš’o
++;

3830 
	`É_xãr
(
Ëmp
->
Çme
, 
š
, 
out
, &
lš’o
);

3834 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3835 
	`¥rštf
(
lše
,"\"%s\",",
Ëmp
->
symbŞs
[
i
]->
Çme
);

3836 
	`årštf
(
out
," %-15s",
lše
);

3837 ifĞ(
i
&3)==3 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3839 ifĞ(
i
&3)!=0 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3840 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3846 
i
=0, 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
, i++){

3847 
	`as£¹
Ğ
½
->
šdex
==
i
 );

3848 
	`årštf
(
out
," /* %3d */ \"", 
i
);

3849 
	`wr™eRuËText
(
out
, 
½
);

3850 
	`årštf
(
out
,"\",\n"); 
lš’o
++;

3852 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3858 ifĞ
Ëmp
->
tok’de¡
 ){

3859 
Úû
 = 1;

3860 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3861 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3862 ifĞ
¥
==0 || sp->
ty³
!=
TERMINAL
 ) ;

3863 ifĞ
Úû
 ){

3864 
	`årštf
(
out
, " /* TERMINAL De¡ruùÜ */\n"); 
lš’o
++;

3865 
Úû
 = 0;

3867 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3869 
i
=0; i<
Ëmp
->
nsymbŞ
 &&†emp->
symbŞs
[i]->
ty³
!=
TERMINAL
; i++);

3870 ifĞ
i
<
Ëmp
->
nsymbŞ
 ){

3871 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3872 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3875 ifĞ
Ëmp
->
v¬de¡
 ){

3876 
symbŞ
 *
dæt_¥
 = 0;

3877 
Úû
 = 1;

3878 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3879 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3880 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 ||

3881 
¥
->
šdex
<=0 || sp->
de¡ruùÜ
!=0 ) ;

3882 ifĞ
Úû
 ){

3883 
	`årštf
(
out
, " /* DeçuÉ NON-TERMINAL De¡ruùÜ */\n"); 
lš’o
++;

3884 
Úû
 = 0;

3886 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3887 
dæt_¥
 = 
¥
;

3889 ifĞ
dæt_¥
!=0 ){

3890 
	`em™_de¡ruùÜ_code
(
out
,
dæt_¥
,
Ëmp
,&
lš’o
);

3892 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3894 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3895 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3896 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 || sp->
de¡ruùÜ
==0 ) ;

3897 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3900 
j
=
i
+1; j<
Ëmp
->
nsymbŞ
; j++){

3901 
symbŞ
 *
¥2
 = 
Ëmp
->
symbŞs
[
j
];

3902 ifĞ
¥2
 && sp2->
ty³
!=
TERMINAL
 && sp2->
de¡ruùÜ


3903 && 
¥2
->
dŠum
==
¥
->dtnum

3904 && 
	`¡rcmp
(
¥
->
de¡ruùÜ
,
¥2
->destructor)==0 ){

3905 
	`årštf
(
out
," case %d: /* %s */\n",

3906 
¥2
->
šdex
, sp2->
Çme
); 
lš’o
++;

3907 
¥2
->
de¡ruùÜ
 = 0;

3911 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3912 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3914 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3917 
	`É_´št
(
out
,
Ëmp
,Ëmp->
ov”æow
,&
lš’o
);

3918 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3925 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3926 
	`årštf
(
out
," { %d, %d },\n",
½
->
lhs
->
šdex
,½->
Ähs
); 
lš’o
++;

3928 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3931 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3932 
	`Œª¦©e_code
(
Ëmp
, 
½
);

3935 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3936 
ruË
 *
½2
;

3937 ifĞ
½
->
code
==0 ) ;

3938 ifĞ
½
->
code
[0]=='\n' &&„p->code[1]==0 ) ;

3939 
	`årštf
(
out
," ca£ %d: /* ", 
½
->
šdex
);

3940 
	`wr™eRuËText
(
out
, 
½
);

3941 
	`årštf
(
out
, " */\n"); 
lš’o
++;

3942 
½2
=
½
->
Ãxt
;„p2;„p2=rp2->next){

3943 ifĞ
½2
->
code
==
½
->code ){

3944 
	`årštf
(
out
," ca£ %d: /* ", 
½2
->
šdex
);

3945 
	`wr™eRuËText
(
out
, 
½2
);

3946 
	`årštf
(
out
," */ yy‹¡ÿ£(yyruËno==%d);\n", 
½2
->
šdex
); 
lš’o
++;

3947 
½2
->
code
 = 0;

3950 
	`em™_code
(
out
,
½
,
Ëmp
,&
lš’o
);

3951 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3952 
½
->
code
 = 0;

3956 
	`årštf
(
out
," deçuÉ:\n"); 
lš’o
++;

3957 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3958 ifĞ
½
->
code
==0 ) ;

3959 
	`as£¹
Ğ
½
->
code
[0]=='\n' &&„p->code[1]==0 );

3960 
	`årštf
(
out
," /* (%dè", 
½
->
šdex
);

3961 
	`wr™eRuËText
(
out
, 
½
);

3962 
	`årštf
(
out
, " */ yy‹¡ÿ£(yyruËno==%d);\n", 
½
->
šdex
); 
lš’o
++;

3964 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3965 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3968 
	`É_´št
(
out
,
Ëmp
,Ëmp->
çu»
,&
lš’o
);

3969 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3972 
	`É_´št
(
out
,
Ëmp
,Ëmp->
”rÜ
,&
lš’o
);

3973 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3976 
	`É_´št
(
out
,
Ëmp
,Ëmp->
acû±
,&
lš’o
);

3977 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3980 
	`É_´št
(
out
,
Ëmp
,Ëmp->
exŒacode
,&
lš’o
);

3982 
	`fşo£
(
š
);

3983 
	`fşo£
(
out
);

3985 
	}
}

3988 
	$R•ÜtH—d”
(
Ëmp
)

3989 
ËmÚ
 *
Ëmp
;

3991 
FILE
 *
out
, *
š
;

3992 *
´efix
;

3993 
lše
[
LINESIZE
];

3994 
·‰”n
[
LINESIZE
];

3995 
i
;

3997 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3998 
´efix
 = "";

3999 
š
 = 
	`fe_İ’
(
Ëmp
,".h","rb");

4000 ifĞ
š
 ){

4001 
i
=1; i<
Ëmp
->
Á”mš®
 && 
	`fg‘s
(
lše
,
LINESIZE
,
š
); i++){

4002 
	`¥rštf
(
·‰”n
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

4003 ifĞ
	`¡rcmp
(
lše
,
·‰”n
) ) ;

4005 
	`fşo£
(
š
);

4006 ifĞ
i
==
Ëmp
->
Á”mš®
 ){

4011 
out
 = 
	`fe_İ’
(
Ëmp
,".h","wb");

4012 ifĞ
out
 ){

4013 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

4014 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

4016 
	`fşo£
(
out
);

4019 
	}
}

4028 
	$Com´essTabËs
(
Ëmp
)

4029 
ËmÚ
 *
Ëmp
;

4031 
¡©e
 *
¡p
;

4032 
aùiÚ
 *
­
, *
­2
;

4033 
ruË
 *
½
, *
½2
, *
rbe¡
;

4034 
nbe¡
, 
n
;

4035 
i
;

4036 
u£sWdÿrd
;

4038 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4039 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

4040 
nbe¡
 = 0;

4041 
rbe¡
 = 0;

4042 
u£sWdÿrd
 = 0;

4044 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4045 ifĞ
­
->
ty³
==
SHIFT
 &&‡p->
¥
==
Ëmp
->
wdÿrd
 ){

4046 
u£sWdÿrd
 = 1;

4048 ifĞ
­
->
ty³
!=
REDUCE
 ) ;

4049 
½
 = 
­
->
x
.rp;

4050 ifĞ
½
->
lhsS¹
 ) ;

4051 ifĞ
½
==
rbe¡
 ) ;

4052 
n
 = 1;

4053 
­2
=
­
->
Ãxt
;‡p2;‡p2=ap2->next){

4054 ifĞ
­2
->
ty³
!=
REDUCE
 ) ;

4055 
½2
 = 
­2
->
x
.
½
;

4056 ifĞ
½2
==
rbe¡
 ) ;

4057 ifĞ
½2
==
½
 ) 
n
++;

4059 ifĞ
n
>
nbe¡
 ){

4060 
nbe¡
 = 
n
;

4061 
rbe¡
 = 
½
;

4069 ifĞ
nbe¡
<1 || 
u£sWdÿrd
 ) ;

4073 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4074 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 ) ;

4076 
	`as£¹
Ğ
­
 );

4077 
­
->
¥
 = 
	`SymbŞ_Ãw
("{default}");

4078 
­
÷p->
Ãxt
;‡p;‡p=ap->next){

4079 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 )‡p->ty³ = 
NOT_USED
;

4081 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

4083 
	}
}

4092 
	$¡©eResÜtCom·»
(cÚ¡ *
a
, cÚ¡ *
b
){

4093 cÚ¡ 
¡©e
 *
pA
 = *(cÚ¡ ¡©e**)
a
;

4094 cÚ¡ 
¡©e
 *
pB
 = *(cÚ¡ ¡©e**)
b
;

4095 
n
;

4097 
n
 = 
pB
->
nNtAù
 - 
pA
->nNtAct;

4098 ifĞ
n
==0 ){

4099 
n
 = 
pB
->
nTknAù
 - 
pA
->nTknAct;

4101  
n
;

4102 
	}
}

4109 
	$ResÜtS‹s
(
Ëmp
)

4110 
ËmÚ
 *
Ëmp
;

4112 
i
;

4113 
¡©e
 *
¡p
;

4114 
aùiÚ
 *
­
;

4116 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4117 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

4118 
¡p
->
nTknAù
 = s->
nNtAù
 = 0;

4119 
¡p
->
iDæt
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
;

4120 
¡p
->
iTknOf¡
 = 
NO_OFFSET
;

4121 
¡p
->
iNtOf¡
 = 
NO_OFFSET
;

4122 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4123 ifĞ
	`compu‹_aùiÚ
(
Ëmp
,
­
)>=0 ){

4124 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ){

4125 
¡p
->
nTknAù
++;

4126 }ifĞ
­
->
¥
->
šdex
<
Ëmp
->
nsymbŞ
 ){

4127 
¡p
->
nNtAù
++;

4129 
¡p
->
iDæt
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

4134 
	`qsÜt
(&
Ëmp
->
sÜ‹d
[1],†emp->
n¡©e
-1, (lemp->sorted[0]),

4135 
¡©eResÜtCom·»
);

4136 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4137 
Ëmp
->
sÜ‹d
[
i
]->
¡©’um
 = i;

4139 
	}
}

4147 
	gsize
 = 0;

4150 
	$S‘Size
(
n
)

4151 
n
;

4153 
size
 = 
n
+1;

4154 
	}
}

4157 *
	$S‘New
(){

4158 *
s
;

4159 
s
 = (*)
	`ÿÎoc
Ğ
size
, 1);

4160 ifĞ
s
==0 ){

4161 
	`memÜy_”rÜ
();

4162 
	`memÜy_”rÜ
();

4164  
s
;

4165 
	}
}

4168 
	$S‘F»e
(
s
)

4169 *
s
;

4171 
	`ä“
(
s
);

4172 
	}
}

4176 
	$S‘Add
(
s
,
e
)

4177 *
s
;

4178 
e
;

4180 
rv
;

4181 
	`as£¹
Ğ
e
>=0 &&ƒ<
size
 );

4182 
rv
 = 
s
[
e
];

4183 
s
[
e
] = 1;

4184  !
rv
;

4185 
	}
}

4188 
	$S‘UniÚ
(
s1
,
s2
)

4189 *
s1
;

4190 *
s2
;

4192 
i
, 
´og»ss
;

4193 
´og»ss
 = 0;

4194 
i
=0; i<
size
; i++){

4195 ifĞ
s2
[
i
]==0 ) ;

4196 ifĞ
s1
[
i
]==0 ){

4197 
´og»ss
 = 1;

4198 
s1
[
i
] = 1;

4201  
´og»ss
;

4202 
	}
}

4216 
PRIVATE
 
	$¡rhash
(
x
)

4217 *
x
;

4219 
h
 = 0;

4220  *
x
è
h
 = h*13 + *(x++);

4221  
h
;

4222 
	}
}

4228 *
	$SŒ§ã
(
y
)

4229 *
y
;

4231 *
z
;

4233 ifĞ
y
==0 )  0;

4234 
z
 = 
	`SŒ§ã_fšd
(
y
);

4235 ifĞ
z
==0 && (z=
	`m®loc
Ğ
	`ËmÚSŒËn
(
y
)+1 ))!=0 ){

4236 
	`¡rıy
(
z
,
y
);

4237 
	`SŒ§ã_š£¹
(
z
);

4239 
	`MemÜyCheck
(
z
);

4240  
z
;

4241 
	}
}

4246 
	ss_x1
 {

4247 
	msize
;

4250 
	mcouÁ
;

4251 
s_x1node
 *
	mtbl
;

4252 
s_x1node
 **
	mht
;

4258 
	ss_x1node
 {

4259 *
	md©a
;

4260 
s_x1node
 *
	mÃxt
;

4261 
s_x1node
 **
	mäom
;

4262 } 
	tx1node
;

4265 
s_x1
 *
	gx1a
;

4268 
	$SŒ§ã_š™
(){

4269 ifĞ
x1a
 ) ;

4270 
x1a
 = (
s_x1
*)
	`m®loc
( (s_x1) );

4271 ifĞ
x1a
 ){

4272 
x1a
->
size
 = 1024;

4273 
x1a
->
couÁ
 = 0;

4274 
x1a
->
tbl
 = (
x1node
*)
	`m®loc
(

4275 ((
x1node
) + (x1node*))*1024 );

4276 ifĞ
x1a
->
tbl
==0 ){

4277 
	`ä“
(
x1a
);

4278 
x1a
 = 0;

4280 
i
;

4281 
x1a
->
ht
 = (
x1node
**)&(x1a->
tbl
[1024]);

4282 
i
=0; i<1024; i++è
x1a
->
ht
[i] = 0;

4285 
	}
}

4288 
	$SŒ§ã_š£¹
(
d©a
)

4289 *
d©a
;

4291 
x1node
 *
Å
;

4292 
h
;

4293 
ph
;

4295 ifĞ
x1a
==0 )  0;

4296 
ph
 = 
	`¡rhash
(
d©a
);

4297 
h
 = 
ph
 & (
x1a
->
size
-1);

4298 
Å
 = 
x1a
->
ht
[
h
];

4299  
Å
 ){

4300 ifĞ
	`¡rcmp
(
Å
->
d©a
,data)==0 ){

4305 
Å
 =‚p->
Ãxt
;

4307 ifĞ
x1a
->
couÁ
>=x1a->
size
 ){

4309 
i
,
size
;

4310 
s_x1
 
¬¿y
;

4311 
¬¿y
.
size
 = sizğ
x1a
->size*2;

4312 
¬¿y
.
couÁ
 = 
x1a
->count;

4313 
¬¿y
.
tbl
 = (
x1node
*)
	`m®loc
(

4314 ((
x1node
è+ (x1node*))*
size
 );

4315 ifĞ
¬¿y
.
tbl
==0 )  0;

4316 
¬¿y
.
ht
 = (
x1node
**)&×¼ay.
tbl
[
size
]);

4317 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4318 
i
=0; i<
x1a
->
couÁ
; i++){

4319 
x1node
 *
ŞdÅ
, *
ÃwÅ
;

4320 
ŞdÅ
 = &(
x1a
->
tbl
[
i
]);

4321 
h
 = 
	`¡rhash
(
ŞdÅ
->
d©a
è& (
size
-1);

4322 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4323 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4324 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4325 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4326 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4327 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4329 
	`ä“
(
x1a
->
tbl
);

4330 *
x1a
 = 
¬¿y
;

4333 
h
 = 
ph
 & (
x1a
->
size
-1);

4334 
Å
 = &(
x1a
->
tbl
[x1a->
couÁ
++]);

4335 
Å
->
d©a
 = data;

4336 ifĞ
x1a
->
ht
[
h
] ) x1a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4337 
Å
->
Ãxt
 = 
x1a
->
ht
[
h
];

4338 
x1a
->
ht
[
h
] = 
Å
;

4339 
Å
->
äom
 = &(
x1a
->
ht
[
h
]);

4341 
	}
}

4345 *
	$SŒ§ã_fšd
(
key
)

4346 *
key
;

4348 
h
;

4349 
x1node
 *
Å
;

4351 ifĞ
x1a
==0 )  0;

4352 
h
 = 
	`¡rhash
(
key
è& (
x1a
->
size
-1);

4353 
Å
 = 
x1a
->
ht
[
h
];

4354  
Å
 ){

4355 ifĞ
	`¡rcmp
(
Å
->
d©a
,
key
)==0 ) ;

4356 
Å
 =‚p->
Ãxt
;

4358  
Å
 ?‚p->
d©a
 : 0;

4359 
	}
}

4364 
symbŞ
 *
	$SymbŞ_Ãw
(
x
)

4365 *
x
;

4367 
symbŞ
 *
¥
;

4369 
¥
 = 
	`SymbŞ_fšd
(
x
);

4370 ifĞ
¥
==0 ){

4371 
¥
 = (
symbŞ
 *)
	`ÿÎoc
(1, (symbol) );

4372 
	`MemÜyCheck
(
¥
);

4373 
¥
->
Çme
 = 
	`SŒ§ã
(
x
);

4374 
¥
->
ty³
 = 
	`isuµ”
(*
x
è? 
TERMINAL
 : 
NONTERMINAL
;

4375 
¥
->
ruË
 = 0;

4376 
¥
->
çÎback
 = 0;

4377 
¥
->
´ec
 = -1;

4378 
¥
->
assoc
 = 
UNK
;

4379 
¥
->
fœ¡£t
 = 0;

4380 
¥
->
Ïmbda
 = 
LEMON_FALSE
;

4381 
¥
->
de¡ruùÜ
 = 0;

4382 
¥
->
de¡Lš’o
 = 0;

4383 
¥
->
d©©y³
 = 0;

4384 
¥
->
u£CÁ
 = 0;

4385 
	`SymbŞ_š£¹
(
¥
,¥->
Çme
);

4387 
¥
->
u£CÁ
++;

4388  
¥
;

4389 
	}
}

4401 
	$SymbŞcmµ
(
symbŞ
 **
a
, symbŞ **
b
){

4402 
i1
 = (**
a
).
šdex
 + 10000000*((**a).
Çme
[0]>'Z');

4403 
i2
 = (**
b
).
šdex
 + 10000000*((**b).
Çme
[0]>'Z');

4404  
i1
-
i2
;

4405 
	}
}

4410 
	ss_x2
 {

4411 
	msize
;

4414 
	mcouÁ
;

4415 
s_x2node
 *
	mtbl
;

4416 
s_x2node
 **
	mht
;

4422 
	ss_x2node
 {

4423 
symbŞ
 *
	md©a
;

4424 *
	mkey
;

4425 
s_x2node
 *
	mÃxt
;

4426 
s_x2node
 **
	mäom
;

4427 } 
	tx2node
;

4430 
s_x2
 *
	gx2a
;

4433 
	$SymbŞ_š™
(){

4434 ifĞ
x2a
 ) ;

4435 
x2a
 = (
s_x2
*)
	`m®loc
( (s_x2) );

4436 ifĞ
x2a
 ){

4437 
x2a
->
size
 = 128;

4438 
x2a
->
couÁ
 = 0;

4439 
x2a
->
tbl
 = (
x2node
*)
	`m®loc
(

4440 ((
x2node
) + (x2node*))*128 );

4441 ifĞ
x2a
->
tbl
==0 ){

4442 
	`ä“
(
x2a
);

4443 
x2a
 = 0;

4445 
i
;

4446 
x2a
->
ht
 = (
x2node
**)&(x2a->
tbl
[128]);

4447 
i
=0; i<128; i++è
x2a
->
ht
[i] = 0;

4450 
	}
}

4453 
	$SymbŞ_š£¹
(
d©a
,
key
)

4454 
symbŞ
 *
d©a
;

4455 *
key
;

4457 
x2node
 *
Å
;

4458 
h
;

4459 
ph
;

4461 ifĞ
x2a
==0 )  0;

4462 
ph
 = 
	`¡rhash
(
key
);

4463 
h
 = 
ph
 & (
x2a
->
size
-1);

4464 
Å
 = 
x2a
->
ht
[
h
];

4465  
Å
 ){

4466 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ){

4471 
Å
 =‚p->
Ãxt
;

4473 ifĞ
x2a
->
couÁ
>=x2a->
size
 ){

4475 
i
,
size
;

4476 
s_x2
 
¬¿y
;

4477 
¬¿y
.
size
 = sizğ
x2a
->size*2;

4478 
¬¿y
.
couÁ
 = 
x2a
->count;

4479 
¬¿y
.
tbl
 = (
x2node
*)
	`m®loc
(

4480 ((
x2node
è+ (x2node*))*
size
 );

4481 ifĞ
¬¿y
.
tbl
==0 )  0;

4482 
¬¿y
.
ht
 = (
x2node
**)&×¼ay.
tbl
[
size
]);

4483 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4484 
i
=0; i<
x2a
->
couÁ
; i++){

4485 
x2node
 *
ŞdÅ
, *
ÃwÅ
;

4486 
ŞdÅ
 = &(
x2a
->
tbl
[
i
]);

4487 
h
 = 
	`¡rhash
(
ŞdÅ
->
key
è& (
size
-1);

4488 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4489 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4490 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4491 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4492 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4493 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4494 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4496 
	`ä“
(
x2a
->
tbl
);

4497 *
x2a
 = 
¬¿y
;

4500 
h
 = 
ph
 & (
x2a
->
size
-1);

4501 
Å
 = &(
x2a
->
tbl
[x2a->
couÁ
++]);

4502 
Å
->
key
 = key;

4503 
Å
->
d©a
 = data;

4504 ifĞ
x2a
->
ht
[
h
] ) x2a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4505 
Å
->
Ãxt
 = 
x2a
->
ht
[
h
];

4506 
x2a
->
ht
[
h
] = 
Å
;

4507 
Å
->
äom
 = &(
x2a
->
ht
[
h
]);

4509 
	}
}

4513 
symbŞ
 *
	$SymbŞ_fšd
(
key
)

4514 *
key
;

4516 
h
;

4517 
x2node
 *
Å
;

4519 ifĞ
x2a
==0 )  0;

4520 
h
 = 
	`¡rhash
(
key
è& (
x2a
->
size
-1);

4521 
Å
 = 
x2a
->
ht
[
h
];

4522  
Å
 ){

4523 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ) ;

4524 
Å
 =‚p->
Ãxt
;

4526  
Å
 ?‚p->
d©a
 : 0;

4527 
	}
}

4530 
symbŞ
 *
	$SymbŞ_Nth
(
n
)

4531 
n
;

4533 
symbŞ
 *
d©a
;

4534 ifĞ
x2a
 && 
n
>0 &&‚<=x2a->
couÁ
 ){

4535 
d©a
 = 
x2a
->
tbl
[
n
-1].data;

4537 
d©a
 = 0;

4539  
d©a
;

4540 
	}
}

4543 
	$SymbŞ_couÁ
()

4545  
x2a
 ? x2a->
couÁ
 : 0;

4546 
	}
}

4551 
symbŞ
 **
	$SymbŞ_¬¿yof
()

4553 
symbŞ
 **
¬¿y
;

4554 
i
,
size
;

4555 ifĞ
x2a
==0 )  0;

4556 
size
 = 
x2a
->
couÁ
;

4557 
¬¿y
 = (
symbŞ
 **)
	`ÿÎoc
(
size
, (symbol *));

4558 ifĞ
¬¿y
 ){

4559 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x2a
->
tbl
[i].
d©a
;

4561  
¬¿y
;

4562 
	}
}

4565 
	$CÚfigcmp
(
a
,
b
)

4566 
cÚfig
 *
a
;

4567 
cÚfig
 *
b
;

4569 
x
;

4570 
x
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4571 ifĞ
x
==0 ) x = 
a
->
dÙ
 - 
b
->dot;

4572  
x
;

4573 
	}
}

4576 
PRIVATE
 
	$¡©ecmp
(
a
,
b
)

4577 
cÚfig
 *
a
;

4578 
cÚfig
 *
b
;

4580 
rc
;

4581 
rc
=0;„c==0 && 
a
 && 
b
;‡÷->
bp
, b=b->bp){

4582 
rc
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4583 ifĞ
rc
==0 )„øğ
a
->
dÙ
 - 
b
->dot;

4585 ifĞ
rc
==0 ){

4586 ifĞ
a
 ) 
rc
 = 1;

4587 ifĞ
b
 ) 
rc
 = -1;

4589  
rc
;

4590 
	}
}

4593 
PRIVATE
 
	$¡©ehash
(
a
)

4594 
cÚfig
 *
a
;

4596 
h
=0;

4597  
a
 ){

4598 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4599 
a
 =‡->
bp
;

4601  
h
;

4602 
	}
}

4605 
¡©e
 *
	$S‹_Ãw
()

4607 
¡©e
 *
Ãw
;

4608 
Ãw
 = (
¡©e
 *)
	`ÿÎoc
(1, (state) );

4609 
	`MemÜyCheck
(
Ãw
);

4610  
Ãw
;

4611 
	}
}

4616 
	ss_x3
 {

4617 
	msize
;

4620 
	mcouÁ
;

4621 
s_x3node
 *
	mtbl
;

4622 
s_x3node
 **
	mht
;

4628 
	ss_x3node
 {

4629 
¡©e
 *
	md©a
;

4630 
cÚfig
 *
	mkey
;

4631 
s_x3node
 *
	mÃxt
;

4632 
s_x3node
 **
	mäom
;

4633 } 
	tx3node
;

4636 
s_x3
 *
	gx3a
;

4639 
	$S‹_š™
(){

4640 ifĞ
x3a
 ) ;

4641 
x3a
 = (
s_x3
*)
	`m®loc
( (s_x3) );

4642 ifĞ
x3a
 ){

4643 
x3a
->
size
 = 128;

4644 
x3a
->
couÁ
 = 0;

4645 
x3a
->
tbl
 = (
x3node
*)
	`m®loc
(

4646 ((
x3node
) + (x3node*))*128 );

4647 ifĞ
x3a
->
tbl
==0 ){

4648 
	`ä“
(
x3a
);

4649 
x3a
 = 0;

4651 
i
;

4652 
x3a
->
ht
 = (
x3node
**)&(x3a->
tbl
[128]);

4653 
i
=0; i<128; i++è
x3a
->
ht
[i] = 0;

4656 
	}
}

4659 
	$S‹_š£¹
(
d©a
,
key
)

4660 
¡©e
 *
d©a
;

4661 
cÚfig
 *
key
;

4663 
x3node
 *
Å
;

4664 
h
;

4665 
ph
;

4667 ifĞ
x3a
==0 )  0;

4668 
ph
 = 
	`¡©ehash
(
key
);

4669 
h
 = 
ph
 & (
x3a
->
size
-1);

4670 
Å
 = 
x3a
->
ht
[
h
];

4671  
Å
 ){

4672 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ){

4677 
Å
 =‚p->
Ãxt
;

4679 ifĞ
x3a
->
couÁ
>=x3a->
size
 ){

4681 
i
,
size
;

4682 
s_x3
 
¬¿y
;

4683 
¬¿y
.
size
 = sizğ
x3a
->size*2;

4684 
¬¿y
.
couÁ
 = 
x3a
->count;

4685 
¬¿y
.
tbl
 = (
x3node
*)
	`m®loc
(

4686 ((
x3node
è+ (x3node*))*
size
 );

4687 ifĞ
¬¿y
.
tbl
==0 )  0;

4688 
¬¿y
.
ht
 = (
x3node
**)&×¼ay.
tbl
[
size
]);

4689 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4690 
i
=0; i<
x3a
->
couÁ
; i++){

4691 
x3node
 *
ŞdÅ
, *
ÃwÅ
;

4692 
ŞdÅ
 = &(
x3a
->
tbl
[
i
]);

4693 
h
 = 
	`¡©ehash
(
ŞdÅ
->
key
è& (
size
-1);

4694 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4695 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4696 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4697 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4698 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4699 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4700 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4702 
	`ä“
(
x3a
->
tbl
);

4703 *
x3a
 = 
¬¿y
;

4706 
h
 = 
ph
 & (
x3a
->
size
-1);

4707 
Å
 = &(
x3a
->
tbl
[x3a->
couÁ
++]);

4708 
Å
->
key
 = key;

4709 
Å
->
d©a
 = data;

4710 ifĞ
x3a
->
ht
[
h
] ) x3a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4711 
Å
->
Ãxt
 = 
x3a
->
ht
[
h
];

4712 
x3a
->
ht
[
h
] = 
Å
;

4713 
Å
->
äom
 = &(
x3a
->
ht
[
h
]);

4715 
	}
}

4719 
¡©e
 *
	$S‹_fšd
(
key
)

4720 
cÚfig
 *
key
;

4722 
h
;

4723 
x3node
 *
Å
;

4725 ifĞ
x3a
==0 )  0;

4726 
h
 = 
	`¡©ehash
(
key
è& (
x3a
->
size
-1);

4727 
Å
 = 
x3a
->
ht
[
h
];

4728  
Å
 ){

4729 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ) ;

4730 
Å
 =‚p->
Ãxt
;

4732  
Å
 ?‚p->
d©a
 : 0;

4733 
	}
}

4738 
¡©e
 **
	$S‹_¬¿yof
()

4740 
¡©e
 **
¬¿y
;

4741 
i
,
size
;

4742 ifĞ
x3a
==0 )  0;

4743 
size
 = 
x3a
->
couÁ
;

4744 
¬¿y
 = (
¡©e
 **)
	`m®loc
Ğ(¡©*)*
size
 );

4745 ifĞ
¬¿y
 ){

4746 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x3a
->
tbl
[i].
d©a
;

4748  
¬¿y
;

4749 
	}
}

4752 
PRIVATE
 
	$cÚfighash
(
a
)

4753 
cÚfig
 *
a
;

4755 
h
=0;

4756 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4757  
h
;

4758 
	}
}

4763 
	ss_x4
 {

4764 
	msize
;

4767 
	mcouÁ
;

4768 
s_x4node
 *
	mtbl
;

4769 
s_x4node
 **
	mht
;

4775 
	ss_x4node
 {

4776 
cÚfig
 *
	md©a
;

4777 
s_x4node
 *
	mÃxt
;

4778 
s_x4node
 **
	mäom
;

4779 } 
	tx4node
;

4782 
s_x4
 *
	gx4a
;

4785 
	$CÚfigbË_š™
(){

4786 ifĞ
x4a
 ) ;

4787 
x4a
 = (
s_x4
*)
	`m®loc
( (s_x4) );

4788 ifĞ
x4a
 ){

4789 
x4a
->
size
 = 64;

4790 
x4a
->
couÁ
 = 0;

4791 
x4a
->
tbl
 = (
x4node
*)
	`m®loc
(

4792 ((
x4node
) + (x4node*))*64 );

4793 ifĞ
x4a
->
tbl
==0 ){

4794 
	`ä“
(
x4a
);

4795 
x4a
 = 0;

4797 
i
;

4798 
x4a
->
ht
 = (
x4node
**)&(x4a->
tbl
[64]);

4799 
i
=0; i<64; i++è
x4a
->
ht
[i] = 0;

4802 
	}
}

4805 
	$CÚfigbË_š£¹
(
d©a
)

4806 
cÚfig
 *
d©a
;

4808 
x4node
 *
Å
;

4809 
h
;

4810 
ph
;

4812 ifĞ
x4a
==0 )  0;

4813 
ph
 = 
	`cÚfighash
(
d©a
);

4814 
h
 = 
ph
 & (
x4a
->
size
-1);

4815 
Å
 = 
x4a
->
ht
[
h
];

4816  
Å
 ){

4817 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,data)==0 ){

4822 
Å
 =‚p->
Ãxt
;

4824 ifĞ
x4a
->
couÁ
>=x4a->
size
 ){

4826 
i
,
size
;

4827 
s_x4
 
¬¿y
;

4828 
¬¿y
.
size
 = sizğ
x4a
->size*2;

4829 
¬¿y
.
couÁ
 = 
x4a
->count;

4830 
¬¿y
.
tbl
 = (
x4node
*)
	`m®loc
(

4831 ((
x4node
è+ (x4node*))*
size
 );

4832 ifĞ
¬¿y
.
tbl
==0 )  0;

4833 
¬¿y
.
ht
 = (
x4node
**)&×¼ay.
tbl
[
size
]);

4834 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4835 
i
=0; i<
x4a
->
couÁ
; i++){

4836 
x4node
 *
ŞdÅ
, *
ÃwÅ
;

4837 
ŞdÅ
 = &(
x4a
->
tbl
[
i
]);

4838 
h
 = 
	`cÚfighash
(
ŞdÅ
->
d©a
è& (
size
-1);

4839 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4840 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4841 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4842 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4843 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4844 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4846 
	`ä“
(
x4a
->
tbl
);

4847 *
x4a
 = 
¬¿y
;

4850 
h
 = 
ph
 & (
x4a
->
size
-1);

4851 
Å
 = &(
x4a
->
tbl
[x4a->
couÁ
++]);

4852 
Å
->
d©a
 = data;

4853 ifĞ
x4a
->
ht
[
h
] ) x4a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4854 
Å
->
Ãxt
 = 
x4a
->
ht
[
h
];

4855 
x4a
->
ht
[
h
] = 
Å
;

4856 
Å
->
äom
 = &(
x4a
->
ht
[
h
]);

4858 
	}
}

4862 
cÚfig
 *
	$CÚfigbË_fšd
(
key
)

4863 
cÚfig
 *
key
;

4865 
h
;

4866 
x4node
 *
Å
;

4868 ifĞ
x4a
==0 )  0;

4869 
h
 = 
	`cÚfighash
(
key
è& (
x4a
->
size
-1);

4870 
Å
 = 
x4a
->
ht
[
h
];

4871  
Å
 ){

4872 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,
key
)==0 ) ;

4873 
Å
 =‚p->
Ãxt
;

4875  
Å
 ?‚p->
d©a
 : 0;

4876 
	}
}

4880 
	$CÚfigbË_ş—r
(
f
)

4881 (*
f
)( );

4883 
i
;

4884 ifĞ
x4a
==0 || x4a->
couÁ
==0 ) ;

4885 ifĞ
f
 ) 
i
=0; i<
x4a
->
couÁ
; i++è(*f)(x4a->
tbl
[i].
d©a
);

4886 
i
=0; i<
x4a
->
size
; i++èx4a->
ht
[i] = 0;

4887 
x4a
->
couÁ
 = 0;

4889 
	}
}

	@tools/examples/kegogi/lempar.c

6 
	~<¡dio.h
>

7 %% /* 
	$yy·r£
 */ 
	`yyËx
()

18 
	}
%%

21 #iâdeà
INTERFACE


22 
	#INTERFACE
 1

	)

58 %% /* 
	$yy·r£
 */ 
	`yyËx
()

59 #
defše
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

60 #
defše
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

61 #
defše
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

65 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

75 #
iâdef
 
yy‹¡ÿ£


76 #
defše
 
	`yy‹¡ÿ£
(
X
)

77 #
’dif


127 
	}
%%

128 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

140 #ifdeà
YYFALLBACK


141 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

142 %% /* 
	$yy·r£
 */ 
	`yyËx
()

144 #
’dif


158 
	syySckEÁry
 {

159 
YYACTIONTYPE
 
	m¡©’o
;

160 
YYCODETYPE
 
	mmajÜ
;

162 
YYMINORTYPE
 
	mmšÜ
;

165 
yySckEÁry
 
	tyySckEÁry
;

169 
	syyP¬£r
 {

170 
	myyidx
;

171 #
ifdef
 
YYTRACKMAXSTACKDEPTH


172 
	myyidxMax
;

173 #
’dif


174 
	myy”rút
;

175 
	mP¬£ARG_SDECL


176 #
YYSTACKDEPTH
<=0

177 
	myy¡ksz
;

178 
yySckEÁry
 *
	myy¡ack
;

180 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

181 #
’dif


183 
yyP¬£r
 
	tyyP¬£r
;

185 #
iâdef
 
NDEBUG


186 #
šşude
 <
¡dio
.
h
>

187 
FILE
 *
	gyyT¿ûFILE
 = 0;

188 *
	gyyT¿ûProm±
 = 0;

189 #
’dif


191 #
iâdef
 
NDEBUG


209 
	`P¬£T¿û
(
FILE
 *
	gT¿ûFILE
, *
	gzT¿ûProm±
){

210 
	gyyT¿ûFILE
 = 
T¿ûFILE
;

211 
	gyyT¿ûProm±
 = 
zT¿ûProm±
;

212 ifĞ
	gyyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

213 ifĞ
	gyyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

215 #
’dif


217 #
iâdef
 
NDEBUG


220 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

221 
	}
%%

225 #iâdeà
NDEBUG


228 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

229 %% /* 
	$yy·r£
 */ 
	`yyËx
()

231 #
’dif


234 #
YYSTACKDEPTH
<=0

238 
	`yyGrowSck
(
yyP¬£r
 *
	gp
){

239 
	gÃwSize
;

240 
yySckEÁry
 *
	gpNew
;

242 
	gÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

243 
	gpNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

244 ifĞ
	gpNew
 ){

245 
	gp
->
	gyy¡ack
 = 
pNew
;

246 
	gp
->
	gyy¡ksz
 = 
ÃwSize
;

247 #
iâdef
 
NDEBUG


248 ifĞ
	gyyT¿ûFILE
 ){

249 
	`årštf
(
	gyyT¿ûFILE
,"%sStack growso %dƒntries!\n",

250 
	gyyT¿ûProm±
, 
	gp
->
	gyy¡ksz
);

252 #
’dif


255 #
’dif


269 *
	`P¬£AÎoc
(*(*
	gm®locProc
)(
	gsize_t
)){

270 
yyP¬£r
 *
	gpP¬£r
;

271 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

272 ifĞ
	gpP¬£r
 ){

273 
	gpP¬£r
->
	gyyidx
 = -1;

274 #
ifdef
 
YYTRACKMAXSTACKDEPTH


275 
	gpP¬£r
->
	gyyidxMax
 = 0;

276 #
’dif


277 #
YYSTACKDEPTH
<=0

278 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

279 
	gpP¬£r
->
	gyy¡ksz
 = 0;

280 
	`yyGrowSck
(
	gpP¬£r
);

281 #
’dif


283  
	gpP¬£r
;

291 
	`yy_de¡ruùÜ
(

292 
yyP¬£r
 *
	gyypP¬£r
,

293 
YYCODETYPE
 
	gyymajÜ
,

294 
YYMINORTYPE
 *
	gyypmšÜ


296 
	gP¬£ARG_FETCH
;

297  
	gyymajÜ
 ){

308 
	}
%%

321 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

322 
YYCODETYPE
 
yymajÜ
;

323 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

325 ifĞ
pP¬£r
->
yyidx
<0 )  0;

326 #iâdeà
NDEBUG


327 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

328 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

329 
yyT¿ûProm±
,

330 
yyTok’Name
[
yytos
->
majÜ
]);

333 
yymajÜ
 = 
yytos
->
majÜ
;

334 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

335 
pP¬£r
->
yyidx
--;

336  
yymajÜ
;

337 
	}
}

351 
P¬£F»e
(

352 *
p
,

353 (*
ä“Proc
)(*)

355 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

356 ifĞ
pP¬£r
==0 ) ;

357  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

358 #ià
YYSTACKDEPTH
<=0

359 
	`ä“
(
pP¬£r
->
yy¡ack
);

361 (*
ä“Proc
)((*)
pP¬£r
);

362 
	}
}

367 #ifdeà
YYTRACKMAXSTACKDEPTH


368 
	$P¬£SckP—k
(*
p
){

369 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

370  
pP¬£r
->
yyidxMax
;

371 
	}
}

382 
	$yy_fšd_shiá_aùiÚ
(

383 
yyP¬£r
 *
pP¬£r
,

384 
YYCODETYPE
 
iLookAh—d


386 
i
;

387 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

389 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

390  
yy_deçuÉ
[
¡©’o
];

392 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

393 
i
 +ğ
iLookAh—d
;

394 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

395 ifĞ
iLookAh—d
>0 ){

396 #ifdeà
YYFALLBACK


397 
YYCODETYPE
 
iF®lback
;

398 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

399 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

400 #iâdeà
NDEBUG


401 ifĞ
yyT¿ûFILE
 ){

402 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

403 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

406  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

409 #ifdeà
YYWILDCARD


411 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

412 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

413 #iâdeà
NDEBUG


414 ifĞ
yyT¿ûFILE
 ){

415 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

416 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

419  
yy_aùiÚ
[
j
];

424  
yy_deçuÉ
[
¡©’o
];

426  
yy_aùiÚ
[
i
];

428 
	}
}

438 
	$yy_fšd_»duû_aùiÚ
(

439 
¡©’o
,

440 
YYCODETYPE
 
iLookAh—d


442 
i
;

443 #ifdeà
YYERRORSYMBOL


444 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

445  
yy_deçuÉ
[
¡©’o
];

448 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

450 
i
 = 
yy_»duû_of¡
[
¡©’o
];

451 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

452 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

453 
i
 +ğ
iLookAh—d
;

454 #ifdeà
YYERRORSYMBOL


455 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

456  
yy_deçuÉ
[
¡©’o
];

459 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

460 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

462  
yy_aùiÚ
[
i
];

463 
	}
}

468 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

469 
P¬£ARG_FETCH
;

470 
yypP¬£r
->
yyidx
--;

471 #iâdeà
NDEBUG


472 ifĞ
yyT¿ûFILE
 ){

473 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

476  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

479 %% /* 
	$yy·r£
 */ 
	`yyËx
()

480 
P¬£ARG_STORE
;

481 
	}
}

486 
	`yy_shiá
(

487 
yyP¬£r
 *
	gyypP¬£r
,

488 
	gyyNewS‹
,

489 
	gyyMajÜ
,

490 
YYMINORTYPE
 *
	gyypMšÜ


492 
yySckEÁry
 *
	gyytos
;

493 
	gyypP¬£r
->
	gyyidx
++;

494 #
ifdef
 
YYTRACKMAXSTACKDEPTH


495 ifĞ
	gyypP¬£r
->
	gyyidx
>yypP¬£r->
	gyyidxMax
 ){

496 
	gyypP¬£r
->
	gyyidxMax
 = 
yypP¬£r
->
yyidx
;

498 #
’dif


499 #
YYSTACKDEPTH
>0

500 ifĞ
	gyypP¬£r
->
	gyyidx
>=
YYSTACKDEPTH
 ){

501 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

505 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

506 
	`yyGrowSck
(
yypP¬£r
);

507 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

508 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

512 #
’dif


513 
	gyytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

514 
	gyytos
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

515 
	gyytos
->
	gmajÜ
 = (
YYCODETYPE
)
yyMajÜ
;

516 
	gyytos
->
	gmšÜ
 = *
yypMšÜ
;

517 #
iâdef
 
NDEBUG


518 ifĞ
	gyyT¿ûFILE
 && 
	gyypP¬£r
->
	gyyidx
>0 ){

519 
	gi
;

520 
	`årštf
(
	gyyT¿ûFILE
,"%sShiá %d\n",
	gyyT¿ûProm±
,
	gyyNewS‹
);

521 
	`årštf
(
	gyyT¿ûFILE
,"%sSck:",
	gyyT¿ûProm±
);

522 
	gi
=1; i<=
yypP¬£r
->
yyidx
; i++)

523 
	`årštf
(
	gyyT¿ûFILE
," %s",
	gyyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
	gmajÜ
]);

524 
	`årštf
(
	gyyT¿ûFILE
,"\n");

526 #
’dif


533 
YYCODETYPE
 
	mlhs
;

534 
	mÄhs
;

535 } 
	gyyRuËInfo
[] = {

536 
	}
%%

539 
yy_acû±
(
yyP¬£r
*);

545 
	$yy_»duû
(

546 
yyP¬£r
 *
yypP¬£r
,

547 
yyruËno


549 
yygÙo
;

550 
yyaù
;

551 
YYMINORTYPE
 
yygÙomšÜ
;

552 
yySckEÁry
 *
yym¥
;

553 
yysize
;

554 
P¬£ARG_FETCH
;

555 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

556 #iâdeà
NDEBUG


557 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

558 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

559 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

560 
yyRuËName
[
yyruËno
]);

579 
yygÙomšÜ
 = 
yyz”omšÜ
;

582  
yyruËno
 ){

591 %% /* 
	$yy·r£
 */ 
	`yyËx
()

592 
	}
};

593 
	gyygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

594 
	gyysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

595 
	gyypP¬£r
->
	gyyidx
 -ğ
yysize
;

596 
	gyyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
	gYYCODETYPE
)
	gyygÙo
);

597 ifĞ
	gyyaù
 < 
	gYYNSTATE
 ){

598 #
ifdef
 
NDEBUG


603 ifĞ
	gyysize
 ){

604 
	gyypP¬£r
->
	gyyidx
++;

605 
	gyym¥
 -ğ
yysize
-1;

606 
	gyym¥
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

607 
	gyym¥
->
	gmajÜ
 = (
YYCODETYPE
)
yygÙo
;

608 
	gyym¥
->
	gmšÜ
 = 
yygÙomšÜ
;

610 #
’dif


612 
	`yy_shiá
(
	gyypP¬£r
,
	gyyaù
,
	gyygÙo
,&
	gyygÙomšÜ
);

615 
	`as£¹
Ğ
	gyyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

616 
	`yy_acû±
(
	gyypP¬£r
);

623 #
iâdef
 
YYNOERRORRECOVERY


624 
	`yy_·r£_çed
(

625 
yyP¬£r
 *
	gyypP¬£r


627 
	gP¬£ARG_FETCH
;

628 #
iâdef
 
NDEBUG


629 ifĞ
	gyyT¿ûFILE
 ){

630 
	`årštf
(
	gyyT¿ûFILE
,"%sFa!\n",
	gyyT¿ûProm±
);

632 #
’dif


633  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

636 
	}
%%

637 
	gP¬£ARG_STORE
;

644 
	$yy_syÁax_”rÜ
(

645 
yyP¬£r
 *
yypP¬£r
,

646 
yymajÜ
,

647 
YYMINORTYPE
 
yymšÜ


649 
P¬£ARG_FETCH
;

650 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

651 %% /* 
	$yy·r£
 */ 
	`yyËx
()

652 
P¬£ARG_STORE
;

653 
	}
}

658 
	`yy_acû±
(

659 
yyP¬£r
 *
	gyypP¬£r


661 
	gP¬£ARG_FETCH
;

662 #
iâdef
 
NDEBUG


663 ifĞ
	gyyT¿ûFILE
 ){

664 
	`årštf
(
	gyyT¿ûFILE
,"%sAcû±!\n",
	gyyT¿ûProm±
);

666 #
’dif


667  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

670 
	}
%%

671 
	gP¬£ARG_STORE
;

693 
	$P¬£
(

694 *
yyp
,

695 
yymajÜ
,

696 
P¬£TOKENTYPE
 
yymšÜ


697 
P¬£ARG_PDECL


699 
YYMINORTYPE
 
yymšÜuniÚ
;

700 
yyaù
;

701 
yy’dofšput
;

702 #ifdeà
YYERRORSYMBOL


703 
yy”rÜh™
 = 0;

705 
yyP¬£r
 *
yypP¬£r
;

708 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

709 ifĞ
yypP¬£r
->
yyidx
<0 ){

710 #ià
YYSTACKDEPTH
<=0

711 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

713 
yymšÜuniÚ
 = 
yyz”omšÜ
;

714 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

718 
yypP¬£r
->
yyidx
 = 0;

719 
yypP¬£r
->
yy”rút
 = -1;

720 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

721 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

723 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

724 
yy’dofšput
 = (
yymajÜ
==0);

725 
P¬£ARG_STORE
;

727 #iâdeà
NDEBUG


728 ifĞ
yyT¿ûFILE
 ){

729 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

734 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

735 ifĞ
yyaù
<
YYNSTATE
 ){

736 
	`as£¹
Ğ!
yy’dofšput
 );

737 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

738 
yypP¬£r
->
yy”rút
--;

739 
yymajÜ
 = 
YYNOCODE
;

740 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

741 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

743 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

744 #ifdeà
YYERRORSYMBOL


745 
yymx
;

747 #iâdeà
NDEBUG


748 ifĞ
yyT¿ûFILE
 ){

749 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

752 #ifdeà
YYERRORSYMBOL


772 ifĞ
yypP¬£r
->
yy”rút
<0 ){

773 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

775 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

776 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

777 #iâdeà
NDEBUG


778 ifĞ
yyT¿ûFILE
 ){

779 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

780 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

783 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

784 
yymajÜ
 = 
YYNOCODE
;

787 
yypP¬£r
->
yyidx
 >= 0 &&

788 
yymx
 !ğ
YYERRORSYMBOL
 &&

789 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

790 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

791 
YYERRORSYMBOL
)è>ğ
YYNSTATE


793 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

795 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

796 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

797 
	`yy_·r£_çed
(
yypP¬£r
);

798 
yymajÜ
 = 
YYNOCODE
;

799 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

800 
YYMINORTYPE
 
u2
;

801 
u2
.
YYERRSYMDT
 = 0;

802 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

805 
yypP¬£r
->
yy”rút
 = 3;

806 
yy”rÜh™
 = 1;

807 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

815 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

816 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

817 
yymajÜ
 = 
YYNOCODE
;

829 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

830 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

832 
yypP¬£r
->
yy”rút
 = 3;

833 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

834 ifĞ
yy’dofšput
 ){

835 
	`yy_·r£_çed
(
yypP¬£r
);

837 
yymajÜ
 = 
YYNOCODE
;

840 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

842 
	}
}

	@tools/examples/kegogi/src/fuzzrnd.c

35 
	~<as£¹.h
>

36 
	~<¡ršg.h
>

37 
	~<ùy³.h
>

38 
	~<¡dlib.h
>

47 
	mi
,
	mj
;

48 
	msbox
[256];

49 } 
	gArcFour
;

67 *
	$FuzzRnd_d©a
(
size_t
 
Ën
)

70 
n
;

71 
a
,
b
;

72 *
p
 = 
NULL
;

74 
p
 = 
	`m®loc
(
Ën
);

76 
n
=0;n<
Ën
;n++)

78 
ArcFour
.
i
++;

79 
a
 = 
ArcFour
.
sbox
[ArcFour.
i
];

80 
ArcFour
.
j
 = (è(ArcFour.j + 
a
);

81 
b
 = 
ArcFour
.
sbox
[ArcFour.
j
];

82 
ArcFour
.
sbox
[ArcFour.
i
] = 
b
;

83 
ArcFour
.
sbox
[ArcFour.
j
] = 
a
;

84 
p
[
n
] = 
ArcFour
.
sbox
[(
a
+
b
) & 0xFF];

87  
p
;

88 
	}
}

103 
	$FuzzRnd_£ed
(*
key
, 
size_t
 
key_Ën
)

106 
t
, 
u
;

107 
keyšdex
;

108 
¡©ešdex
;

109 *
¡©e
;

110 
couÁ”
;

112 
¡©e
 = 
ArcFour
.
sbox
;

113 
ArcFour
.
i
 = 0;

114 
ArcFour
.
j
 = 0;

116 
couÁ”
 = 0; counter < 256; counter++)

117 
¡©e
[
couÁ”
] = counter;

119 
keyšdex
 = 0;

120 
¡©ešdex
 = 0;

121 
couÁ”
 = 0; counter < 256; counter++)

123 
t
 = 
¡©e
[
couÁ”
];

124 
¡©ešdex
 = (¡©ešdex + 
key
[
keyšdex
] + 
t
) & 0xff;

125 
u
 = 
¡©e
[
¡©ešdex
];

126 
¡©e
[
¡©ešdex
] = 
t
;

127 
¡©e
[
couÁ”
] = 
u
;

128 ià(++
keyšdex
 >ğ
key_Ën
)

129 
keyšdex
 = 0;

131 
	}
}

	@tools/examples/kegogi/src/fuzzrnd.h

1 #iâdeà
_fuzzºd_h


2 
	#_fuzzºd_h


	)

4 
	~<¡dlib.h
>

6 *
FuzzRnd_d©a
(
size_t
 
Ën
);

8 
FuzzRnd_£ed
(*
key
, 
size_t
 
key_Ën
);

	@tools/examples/kegogi/src/httpclient.c

1 
	~"h‰pş›Á.h
"

3 
	~<¡dlib.h
>

5 
	~<sk/sk.h
>

6 
	~<b¡ršg.h
>

7 
	~<dbg.h
>

8 
	~<h‰p11/h‰pş›Á_·r£r.h
>

10 
	~"kegogi.h
"

12 
	#FETCH_BUFFER_SIZE
 10 * 1024

	)

14 *
	gREQUEST_FORMAT
 =

20 
	$H—d”s_š™
(
H—d”s
 *
h—d”s
) {

21 if(!
h—d”s
)  -1;

22 
h—d”s
->
num_h—d”s
 = 0;

24 
	}
}

26 
	$H—d”s_ş—nup
(
H—d”s
 *
h—d”s
) {

27 
i
;

28 
i
 = 0; i < 
h—d”s
->
num_h—d”s
; i++) {

29 
	`bde¡roy
(
h—d”s
->h—d”s[
i
].
f›ld
);

30 
	`bde¡roy
(
h—d”s
->h—d”s[
i
].
v®ue
);

33 
	}
}

35 
	$H—d”s_add
(
H—d”s
 *
h—d”s
, 
b¡ršg
 
f›ld
, b¡ršg 
v®ue
) {

36 if(!
h—d”s
 || h—d”s->
num_h—d”s
 >ğ
MAX_NUM_HEADERS
)  -1;

37 
i
 = 
h—d”s
->
num_h—d”s
;

38 
h—d”s
->h—d”s[
i
].
f›ld
 = field;

39 
h—d”s
->h—d”s[
i
].
v®ue
 = value;

40 
h—d”s
->
num_h—d”s
++;

42 
	}
}

44 
Reque¡
 *
	$Reque¡_ü—‹
(
b¡ršg
 
ho¡
, 
pÜt
, b¡ršg 
m‘hod
, b¡ršg 
uri
) {

45 
Reque¡
 *
»q
 = 
	`m®loc
((*req));

46 
»q
->
ho¡
 = host;

47 
»q
->
pÜt
 =…ort;

48 
»q
->
m‘hod
 = method;

49 
»q
->
uri
 = uri;

50 
	`H—d”s_š™
(&
»q
->
h—d”s
);

51 
»q
->
h—d”s
.
num_h—d”s
 = 0;

52  
»q
;

53 
	}
}

55 
	$h‰p_f›ld
(*
d©a
, cÚ¡ *
f›ld
, 
size_t
 
æ’
,

56 cÚ¡ *
v®
, 
size_t
 
vËn
)

58 
Re¥Ú£
 *
r¥
 = (Re¥Ú£ *è
d©a
;

60 
b¡ršg
 
bF›ld
 = 
	`blk2b¡r
(
f›ld
, 
æ’
);

61 
b¡ršg
 
bV®
 = 
	`blk2b¡r
(
v®
, 
vËn
);

63 if(
	`bi£qc¡rÿ£Ëss
(
bF›ld
, "content-length"))

64 
r¥
->
cÚ‹Á_Ën
 = 
	`©oi
((*)
bV®
->
d©a
);

65 ià(
	`bi£qc¡rÿ£Ëss
(
bF›ld
, "transfer-encoding"))

66 
r¥
->
chunked_body
 = 
	`bi£qc¡rÿ£Ëss
(
bV®
, "chunked");

68 
	`check
(!
	`H—d”s_add
(&
r¥
->
h—d”s
, 
bF›ld
, 
bV®
), "Failedo‡dd headers");

71 
”rÜ
:

72 
	`bde¡roy
(
bF›ld
);

73 
	`bde¡roy
(
bV®
);

74 
	}
}

76 
	$¡©us_code
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ën
)

78 
Re¥Ú£
 *
r¥
 = (Re¥Ú£ *è
d©a
;

79 
b¡ršg
 
bs
 = 
	`blk2b¡r
(
©
, 
Ën
);

80 
r¥
->
¡©us_code
 = 
	`©oi
((*)
bs
->
d©a
);

81 
	`bde¡roy
(
bs
);

82 
	}
}

84 
	$h—d”_dÚe
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ën
)

86 
Re¥Ú£
 *
r¥
 = (Re¥Ú£ *è
d©a
;

87 
r¥
->
body_¡¬t
 = 
©
;

88 
r¥
->
body_so_çr
 = 
Ën
;

89 
	}
}

91 
	$–em’t_nİ
(*
_
, cÚ¡ *
__
, 
size_t
 
___
è{ 
	}
}

94 
šlše
 
	$Re¥Ú£_»ad_chunks
(
Re¥Ú£
 *
r¥
, 
Ä—d
, *
bufãr
, 
fd
)

96 
i
 = 0;

97 
r
 = 0;

98 
chunk_size
 = -1;

99 
»ad_some_of_chunk_size
 = 0;

101 if(
r¥
->
body_¡¬t
) {

102 
i
 = 
r¥
->
body_¡¬t
 - 
bufãr
;

104 
Ä—d
 = 
i
 = 0;

107 
chunk_size
 != 0) {

108 if(
i
 >ğ
Ä—d
) {

112 
i
 = (˜- 
Ä—d
);

113 
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
FETCH_BUFFER_SIZE
);

114 
	`check
(
Ä—d
 > 0, "Failedo fdrecv in chunk„eading");

117 if(
chunk_size
 == -1) {

118 
c
 = 
	`touµ”
(
bufãr
[
i
]);

119 
i
++;

121 if((
c
 >= 'A' && c <= 'F') || (c >= '0' && c <= '9')) {

122 
c
 = (c >= 'A') ? c - 'A' + 10 : c - '0';

123 
r
 = (¸* 16è+ 
c
;

124 
»ad_some_of_chunk_size
 = 1;

126 if(
»ad_some_of_chunk_size
) {

127 
chunk_size
 = 
r
;

128 
»ad_some_of_chunk_size
 = 
r
 = 0;

129 
i
++;

132 if(
chunk_size
 <ğ
Ä—d
 - 
i
) {

133 
	`bÿtblk
(
r¥
->
body
, 
bufãr
 + 
i
, 
chunk_size
);

134 
i
 +ğ
chunk_size
;

135 
chunk_size
 = -1;

138 
	`bÿtblk
(
r¥
->
body
, 
bufãr
 + 
i
, 
Ä—d
 - i);

139 
chunk_size
 -ğ(
Ä—d
 - 
i
);

140 
i
 = 
Ä—d
;

145 
”rÜ
:

147 
	}
}

149 
šlše
 
	$Re¥Ú£_»ad_body
(
Re¥Ú£
 *
r¥
, 
Ä—d
, *
bufãr
, 
fd
)

151 if(
r¥
->
cÚ‹Á_Ën
 == -1) {

152 (
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
FETCH_BUFFER_SIZE
)) > 0)

153 
	`bÿtblk
(
r¥
->
body
, 
bufãr
, 
Ä—d
);

155 if(
r¥
->
cÚ‹Á_Ën
 > 0) {

156 
ssize_t
 
»maššg
 = 
r¥
->
cÚ‹Á_Ën
 -„¥->
body_so_çr
;

157 
»maššg
 > 0) {

158 
ssize_t
 
tÜ—d
 = 
FETCH_BUFFER_SIZE
;

159 if(
tÜ—d
 > 
»maššg
)oread =„emaining;

160 
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
tÜ—d
);

161 
	`check
(
Ä—d
 > 0, "fd»cv faed w™h %d„emaššg", ()
»maššg
);

162 
	`bÿtblk
(
r¥
->
body
, 
bufãr
, 
Ä—d
);

163 
»maššg
 -ğ
Ä—d
;

165 
»maššg
 -ğ
r¥
->
body_so_çr
;

170 
”rÜ
:

172 
	}
}

174 
Re¥Ú£
 *
	$Re¥Ú£_ü—‹
()

176 
Re¥Ú£
 *
r¥
 = 
	`ÿÎoc
((*rsp), 1);

177 
	`check_mem
(
r¥
);

179 
	`H—d”s_š™
(&
r¥
->
h—d”s
);

180 
r¥
->
cÚ‹Á_Ën
 = -1;

181 
r¥
->
body
 = 
NULL
;

182 
r¥
->
¡©us_code
 = -1;

183 
r¥
->
chunked_body
 = 0;

184 
r¥
->
body
 = 
	`bäomc¡r
("");

185 
r¥
->
body_¡¬t
 = 
NULL
;

186 
r¥
->
body_so_çr
 = 0;

187  
r¥
;

189 
”rÜ
:

190 
	`Re¥Ú£_de¡roy
(
r¥
);

191  
NULL
;

192 
	}
}

194 
	$Re¥Ú£_£tup_·r£r
(
Re¥Ú£
 *
r¥
, 
h‰pş›Á_·r£r
 *
·r£r
)

196 
rc
 = 
	`h‰pş›Á_·r£r_š™
(
·r£r
);

197 
	`check
(
rc
, "Failedo init…arser.");

199 
·r£r
->
h‰p_f›ld
 = http_field;

200 
·r£r
->
»asÚ_ph¿£
 = 
–em’t_nİ
;

201 
·r£r
->
¡©us_code
 = status_code;

202 
·r£r
->
chunk_size
 = 
–em’t_nİ
;

203 
·r£r
->
h‰p_v”siÚ
 = 
–em’t_nİ
;

204 
·r£r
->
h—d”_dÚe
 = header_done;

205 
·r£r
->
Ï¡_chunk
 = 
–em’t_nİ
;

206 
·r£r
->
d©a
 = 
r¥
;

209 
”rÜ
:

211 
	}
}

214 
Re¥Ú£
 *
	$Re¥Ú£_ãtch
(
Reque¡
 *
»q
)

216 
fd
 = 0;

217 *
bufãr
 = 
NULL
;

218 
b¡ršg
 
»que¡
 = 
NULL
;

219 
h‰pş›Á_·r£r
 
·r£r
;

220 
Re¥Ú£
 *
r¥
 = 
NULL
;

222 
bufãr
 = 
	`m®loc
(
FETCH_BUFFER_SIZE
);

223 
	`check_mem
(
bufãr
);

225 
r¥
 = 
	`Re¥Ú£_ü—‹
();

226 
	`check
(
r¥
, "Failedo create Response.");

228 
	`check
(
	`Re¥Ú£_£tup_·r£r
(
r¥
, &
·r£r
) == 0, "Failedo setup…arser.");

230 
fd
 = 
	`ÃtdŸl
(
TCP
, 
	`bd©a
(
»q
->
ho¡
),„eq->
pÜt
);

231 
	`check
(
fd
 > 0, "FaedØcÚÃùØ% Ú…Üˆ%d.", 
	`bd©a
(
»q
->
ho¡
),

232 
»q
->
pÜt
);

234 
»que¡
 = 
	`bfÜm©
(
REQUEST_FORMAT
, 
	`bd©a
(
»q
->
m‘hod
),

235 
	`bd©a
(
»q
->
uri
), bd©aÔeq->
ho¡
));

236 
tÙ®£Á
 = 
	`fd£nd
(
fd
, 
	`bd©a
(
»que¡
), 
	`bËngth
(request));

237 
	`check
(
tÙ®£Á
 =ğ
	`bËngth
(
»que¡
), "Didn't send‡ll ofhe„equest.");

240 
ssize_t
 
Ä—d
 = 0;

241 
ssize_t
 
Å¬£d
 = 0;

242 !
	`h‰pş›Á_·r£r_fšish
(&
·r£r
)) {

243 
Ä—d
 = 
	`fd»cv
(
fd
, 
bufãr
, 
FETCH_BUFFER_SIZE
 - 1);

244 
	`check
(
Ä—d
 > 0, "Failedo get‡ll of headers");

245 
bufãr
[
Ä—d
] = '\0';

246 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(&
·r£r
, 
bufãr
, 
Ä—d
, 0);

248 
	`check
(
	`h‰pş›Á_·r£r_fšish
(&
·r£r
) == 1, "Didn't…arse.");

252 
Å¬£d
--;

254 if(
Å¬£d
 < 
Ä—d
)

255 
	`bÿtblk
(
r¥
->
body
, 
bufãr
 + 
Å¬£d
, 
Ä—d
 -‚parsed);

257 if(
r¥
->
chunked_body
) {

258 
	`check
(
	`Re¥Ú£_»ad_chunks
(
r¥
, 
Ä—d
, 
bufãr
, 
fd
) == 0, "Failedo„ead chunked„esponse.");

261 
	`check
(
	`Re¥Ú£_»ad_body
(
r¥
, 
Ä—d
, 
bufãr
, 
fd
) == 0, "Failedo„ead full body.");

264  
r¥
;

266 
”rÜ
:

267 
	`Re¥Ú£_de¡roy
(
r¥
);

268 if(
»que¡
è
	`bde¡roy
(request);

269 if(
bufãr
è
	`ä“
(buffer);

271  
NULL
;

272 
	}
}

275 
	$Reque¡_de¡roy
(
Reque¡
 *
»q
) {

276 if(
»q
) {

277 
	`bde¡roy
(
»q
->
ho¡
);

278 
	`bde¡roy
(
»q
->
uri
);

279 
	`bde¡roy
(
»q
->
m‘hod
);

280 
	`H—d”s_ş—nup
(&
»q
->
h—d”s
);

281 
	`ä“
(
»q
);

283 
	}
}

285 
	$Re¥Ú£_de¡roy
(
Re¥Ú£
 *
r¥
) {

286 if(
r¥
) {

287 if(
r¥
->
body
è
	`bde¡roy
(rsp->body);

288 
	`H—d”s_ş—nup
(&
r¥
->
h—d”s
);

289 
	`ä“
(
r¥
);

291 
	}
}

	@tools/examples/kegogi/src/httpclient.h

1 #iâdeà
_HTTPCLIENT_H


2 
	#_HTTPCLIENT_H


	)

4 
	~<b¡ršg.h
>

6 
	#MAX_NUM_HEADERS
 128

	)

8 
	sH—d”
 {

9 
b¡ršg
 
	mf›ld
;

10 
b¡ršg
 
	mv®ue
;

11 } 
	tH—d”
;

13 
	sH—d”s
 {

14 
	mnum_h—d”s
;

15 
H—d”
 
	mh—d”s
[
MAX_NUM_HEADERS
];

16 } 
	tH—d”s
;

18 
	sReque¡
 {

19 
b¡ršg
 
	mho¡
;

20 
	mpÜt
;

21 
b¡ršg
 
	mm‘hod
;

22 
b¡ršg
 
	muri
;

23 
H—d”s
 
	mh—d”s
;

24 } 
	tReque¡
;

26 
	sRe¥Ú£
 {

27 
	m¡©us_code
;

28 
b¡ršg
 
	mbody
;

29 
H—d”s
 
	mh—d”s
;

30 
	mcÚ‹Á_Ën
;

31 cÚ¡ *
	mbody_¡¬t
;

32 
	mbody_so_çr
;

33 
	mchunked_body
;

34 } 
	tRe¥Ú£
;

36 
H—d”s_š™
(
H—d”s
 *
h—d”s
);

37 
H—d”s_ş—nup
(
H—d”s
 *
h—d”s
);

38 
H—d”s_add
(
H—d”s
 *
h—d”s
, 
b¡ršg
 
f›ld
, b¡ršg 
v®ue
);

40 
Reque¡
 *
Reque¡_ü—‹
(
b¡ršg
 
ho¡
, 
pÜt
, b¡ršg 
m‘hod
, b¡ršg 
uri
);

41 
Reque¡_de¡roy
(
Reque¡
 *
»q
);

43 
Re¥Ú£
 *
Re¥Ú£_ãtch
(
Reque¡
 *
»q
);

44 
Re¥Ú£_de¡roy
(
Re¥Ú£
 *
r¥
);

	@tools/examples/kegogi/src/kegogi.c

1 
	~"kegogi.h
"

2 
	~"fuzzºd.h
"

3 
	~<h‰p11/h‰pş›Á_·r£r.h
>

4 
	~<dbg.h
>

5 
	~<sk/sk.h
>

6 
	~<b¡r/b¡¾ib.h
>

7 
	~<·‰”n.h
>

8 
	~<g‘İt.h
>

10 
	~"h‰pş›Á.h
"

11 
	~"kegogi_·r£r.h
"

12 
	~"kegogi_tok’s.h
"

14 
	#MAX_COMMANDS
 1024

	)

16 
gb¡ršg
 
	gDEFAULT_HOST_KEY
 = 
bsStic
("host");

17 
gb¡ršg
 
	gDEFAULT_PORT_KEY
 = 
bsStic
("port");

19 
v”ify_»¥Ú£
(
Ex³ù
 *
ex³ù
, 
Reque¡
 *
»q
, 
Re¥Ú£
 *
aùu®
);

20 
Reque¡
 *
ü—‹_»que¡
(
S’d
 *
£nd
, 
P¬amDiù
 *
deçuÉs
);

22 
	sRunKegogiArgs
 {

23 
b¡ršg
 
	msüt_·th
;

24 
	mnum_th»ads
;

25 
	m™”©iÚs_³r_th»ad
;

26 } 
	tRunKegogiArgs
;

28 
	sKegogiTe¡Args
 {

29 
	mnum_commªds
;

30 
Commªd
 *
	mcommªds
;

31 
P¬amDiù
 *
	mdeçuÉs
;

32 
	m‹¡s_³r_th»ad
;

33 
R’dez
 *
	m»ndez
;

34 
	mth»ads_ruÂšg
;

35 
	m·s£d
;

36 
	mçed
;

37 } 
	tKegogiTe¡Args
;

39 
	$kegog™e¡
(*
¬g
)

41 
KegogiTe¡Args
 *
¬gs
 = (KegogiTe¡Args*è
¬g
;

43 
i
;

44 
i
 = 0; i < 
¬gs
->
‹¡s_³r_th»ad
; i++) {

45 
n
 = 
i
 % 
¬gs
->
num_commªds
;

46 
Reque¡
 *
»q
 = 
	`ü—‹_»que¡
(&
¬gs
->
commªds
[
n
].
£nd
,‡rgs->
deçuÉs
);

48 
Re¥Ú£
 *
aùu®
 = 
	`Re¥Ú£_ãtch
(
»q
);

50 if(
	`v”ify_»¥Ú£
(&
¬gs
->
commªds
[
n
].
ex³ù
, 
»q
, 
aùu®
))

51 
¬gs
->
·s£d
++;

53 
¬gs
->
çed
++;

54 
	`Reque¡_de¡roy
(
»q
);

55 
	`Re¥Ú£_de¡roy
(
aùu®
);

58 
¬gs
->
th»ads_ruÂšg
--;

59 
	`skwakeup
(
¬gs
->
»ndez
);

61 
	`skex™
(0);

62 
	}
}

64 
	$runkegogi
(*
¬g
)

66 
RunKegogiArgs
 *
runArgs
 = (RunKegogiArg *è
¬g
;

68 
KegogiTe¡Args
 *
‹¡Args
 = 
	`ÿÎoc
((*testArgs), 1);

69 
	`check_mem
(
‹¡Args
);

71 
‹¡Args
->
·s£d
 = 0;

72 
‹¡Args
->
çed
 = 0;

76 
‹¡Args
->
»ndez
 = 
	`ÿÎoc
((*testArgs->rendez), 1);

78 
‹¡Args
->
th»ads_ruÂšg
 = 
runArgs
->
num_th»ads
;

79 
‹¡Args
->
commªds
 = 
	`ÿÎoc
((
Commªd
), 
MAX_COMMANDS
);

80 
	`check_mem
(
‹¡Args
->
commªds
);

82 
‹¡Args
->
num_commªds
 = 
	`·r£_kegogi_fe
(
	`bd©a
(
runArgs
->
süt_·th
),

83 
‹¡Args
->
commªds
,

84 
MAX_COMMANDS
,

85 &
‹¡Args
->
deçuÉs
);

86 
	`check
(
‹¡Args
->
num_commªds
 > 0, "No kegogiests in file");

87 
‹¡Args
->
‹¡s_³r_th»ad
 =

88 
runArgs
->
™”©iÚs_³r_th»ad
 * 
‹¡Args
->
num_commªds
;

90 
i
;

91 
i
 = 0; i < 
runArgs
->
num_th»ads
; i++)

92 
	`skü—‹
(
kegog™e¡
, 
‹¡Args
, 128 * 1024);

94 
‹¡Args
->
th»ads_ruÂšg
 > 0)

95 
	`sk¦“p
(
‹¡Args
->
»ndez
);

97 
	`´štf
("Pas£d %d oà%d\n", 
‹¡Args
->
·s£d
,

98 
‹¡Args
->
·s£d
 +e¡Args->
çed
);

100 
	`ä“
(
runArgs
);

101 
	`ä“
(
‹¡Args
);

103 
	`skex™®l
((
‹¡Args
->
çed
 > 0) ? 1 : 0);

106 
	`ä“
(
runArgs
);

107 
	`skex™
(0);

109 
”rÜ
:

110 if(
runArgs
è
	`ä“
(runArgs);

111 if(
‹¡Args
è
	`ä“
(testArgs);

113 
	`skex™®l
(1);

114 
	}
}

116 
Reque¡
 *
	$ü—‹_»que¡
(
S’d
 *
£nd
, 
P¬amDiù
 *
deçuÉs
)

118 
	`check
(
£nd
 !ğ
NULL
, "create_request cannot‡ccept NULL send‡rg");

119 
gb¡ršg
 
deçuÉ_ho¡_key
 = 
	`bsStic
("host");

120 
gb¡ršg
 
deçuÉ_pÜt_key
 = 
	`bsStic
("port");

121 
P¬am
 *
p
;

123 
b¡ršg
 
m‘hod
 = 
£nd
->method;

124 
	`check
(
m‘hod
 !ğ
NULL
, "Command must specify method");

126 
b¡ršg
 
uri
 = 
£nd
->uri;

127 
	`check
(
uri
 !ğ
NULL
, "Command must specify uri");

129 
b¡ršg
 
ho¡
 = 
£nd
->host;

130 if(
ho¡
 =ğ
NULL
) {

131 
p
 = 
	`P¬amDiù_g‘
(
deçuÉs
, &
deçuÉ_ho¡_key
);

132 if(
p
 &&…->
ty³
 =ğ
STRING
)

133 
ho¡
 = 
p
->
d©a
.
¡ršg
;

135 
	`check
(
ho¡
 !ğ
NULL
, "Command is missing host‡ndhere is‚o default");

137 
b¡ršg
 
pÜt
 = 
£nd
->port;

138 if(
pÜt
 =ğ
NULL
) {

139 
p
 = 
	`P¬amDiù_g‘
(
deçuÉs
, &
deçuÉ_pÜt_key
);

140 if(
p
 &&…->
ty³
 =ğ
STRING
)

141 
pÜt
 = 
p
->
d©a
.
¡ršg
;

145  
	`Reque¡_ü—‹
(
	`b¡rıy
(
ho¡
),

146 (
pÜt
 !ğ
NULL
è? 
	`©oi
(
	`bd©a
ÕÜt)è: 
DEFAULT_PORT
,

147 
	`b¡rıy
(
m‘hod
),

148 
	`b¡rıy
(
uri
));

150 
”rÜ
:

151  
NULL
;

152 
	}
}

154 
	$v”ify_»¥Ú£
(
Ex³ù
 *
ex³ù
, 
Reque¡
 *
»q
, 
Re¥Ú£
 *
aùu®
) {

155 
	`check
(
ex³ù
 !ğ
NULL
 && 
»q
 != NULL, "command‡nd„eq must‚ot be NULL");

156 
gb¡ršg
 
body_key
 = 
	`bsStic
("body");

158 if(
aùu®
 =ğ
NULL
) {

159 
	`´štf
("Fau» wh’ f‘chšg %s:%d%s\n", 
	`bd©a
(
»q
->
ho¡
),„eq->
pÜt
,

160 
	`bd©a
(
»q
->
uri
));

161 
	`´štf
(" Failedo„etrieve„esponse from server,‡ctual is NULL\n");

165 
ex³ùed_¡©us_code
 = 
	`©oi
(
	`bd©a
(
ex³ù
->
¡©us_code
));

166 if(
ex³ùed_¡©us_code
 !ğ
aùu®
->
¡©us_code
) {

167 
	`´štf
("Fau» wh’ f‘chšg %s:%d%s\n", 
	`bd©a
(
»q
->
ho¡
),„eq->
pÜt
,

168 
	`bd©a
(
»q
->
uri
));

169 
	`´štf
(" Stu codwa %d,ƒx³ùed %d\n", 
aùu®
->
¡©us_code
,

170 
ex³ùed_¡©us_code
);

175 
P¬am
 *
p
 = 
	`P¬amDiù_g‘
(
ex³ù
->
·¿ms
, &
body_key
);

176 if(
p
 !ğ
NULL
) {

177 
·ss
 = 0;

178 if(
p
->
ty³
 =ğ
PATTERN
)

179 
·ss
 = (
	`b¡ršg_m©ch
(
aùu®
->
body
, 
p
->
d©a
.
·‰”n
è!ğ
NULL
);

180 if(
p
->
ty³
 =ğ
STRING
)

181 
·ss
 = (
	`b¡rcmp
(
aùu®
->
body
, 
p
->
d©a
.
¡ršg
) == 0);

183 if(!
·ss
) {

184 
	`´štf
("Fau» wh’ f‘chšg %s:%d%s\n", 
	`bd©a
(
»q
->
ho¡
),

185 
»q
->
pÜt
, 
	`bd©a
Ôeq->
uri
));

186 
	`´štf
(" Aùu®: \"%s\"\n", 
	`bd©a
(
aùu®
->
body
));

187 if(
p
->
ty³
 =ğ
PATTERN
)

188 
	`´štf
(" Ex³ùed: (%s)\n", 
	`bd©a
(
p
->
d©a
.
·‰”n
));

189 ià(
p
->
ty³
 =ğ
STRING
)

190 
	`´štf
(" Ex³ùed: \"%s\"\n", 
	`bd©a
(
p
->
d©a
.
¡ršg
));

192 
	`´štf
(" Expected dict?\n");

200 
”rÜ
:

202 
	}
}

204 
	$skmaš
(
¬gc
, *
¬gv
[])

206 
	`dbg_£t_log
(
¡d”r
);

207 
RunKegogiArgs
 *
¬gs
 = 
	`ÿÎoc
((*args), 1);

208 
	`check_mem
(
¬gs
);

209 
¬gs
->
süt_·th
 = 
NULL
;

210 
¬gs
->
num_th»ads
 = 1;

211 
¬gs
->
™”©iÚs_³r_th»ad
 = 1;

213 
İtiÚ
 
lÚg_İtiÚs
[] = {

218 
c
;

219 (
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, "t:i:", 
lÚg_İtiÚs
, 
NULL
)) != -1) {

220 
c
) {

222 
¬gs
->
num_th»ads
 = 
	`©oi
(
İrg
);

223 
	`check
(
¬gs
->
num_th»ads
 > 0, "Invalid‚umber ofhreads");

226 
¬gs
->
™”©iÚs_³r_th»ad
 = 
	`©oi
(
İrg
);

227 
	`check
(
¬gs
->
™”©iÚs_³r_th»ad
 > 0, "Invalid‚umber of "

231 
	`check
(0, "Invalid‡rgument");

235 
	`check
(
İtšd
 < 
¬gc
, "Expected kegogi file");

237 
¬gs
->
süt_·th
 = 
	`bäomc¡r
(
¬gv
[
İtšd
]);

239 
	`skü—‹
(
runkegogi
, 
¬gs
, 128 * 1024);

241 
	`skex™
(0);

243 
”rÜ
:

244 
	`skex™®l
(1);

245 
	}
}

	@tools/examples/kegogi/src/kegogi.h

1 #iâdeà
_KEGOGI_H


2 
	#_KEGOGI_H


	)

4 
	~<b¡ršg.h
>

6 
	~"·¿m.h
"

7 
	~"kegogi_tok’s.h
"

9 
	#DEFAULT_PORT
 80

	)

11 
	sS’d
 {

12 
b¡ršg
 
	mm‘hod
;

13 
b¡ršg
 
	mho¡
;

14 
b¡ršg
 
	mpÜt
;

15 
b¡ršg
 
	muri
;

16 
P¬amDiù
 *
	m·¿ms
;

17 } 
	tS’d
;

19 
	sEx³ù
 {

20 
b¡ršg
 
	m¡©us_code
;

21 
P¬amDiù
 *
	m·¿ms
;

22 } 
	tEx³ù
;

24 
	sCommªd
 {

25 
S’d
 
	m£nd
;

26 
Ex³ù
 
	mex³ù
;

27 } 
	tCommªd
;

29 
	sCommªdLi¡
 {

30 
	msize
;

31 
	mcouÁ
;

32 
Commªd
 *
	mcommªds
;

33 
P¬amDiù
 *
	mdeçuÉs
;

34 } 
	tCommªdLi¡
;

35 
·r£_kegogi_fe
(cÚ¡ *
·th
, 
Commªd
 
commªds
[],

36 
max_num_commªds
, 
P¬amDiù
 **
deçuÉs
);

37 
Tok’Li¡
 *
g‘_kegogi_tok’s
(
b¡ršg
 
cÚ‹Á
);

	@tools/examples/kegogi/src/kegogi_lexer.c

3 
	~"kegogi_tok’s.h
"

4 
	~"kegogi_·r£r.h
"

6 
	~<¡dio.h
>

8 
	~<b¡ršg.h
>

9 
	~<dbg.h
>

17 cÚ¡ 
	g_kegogi_Ëx”_aùiÚs
[] = {

37 cÚ¡ 
	g_kegogi_Ëx”_key_off£ts
[] = {

47 cÚ¡ 
	g_kegogi_Ëx”_Œªs_keys
[] = {

97 cÚ¡ 
	g_kegogi_Ëx”_sšgË_Ëngths
[] = {

107 cÚ¡ 
	g_kegogi_Ëx”_¿nge_Ëngths
[] = {

117 cÚ¡ 
	g_kegogi_Ëx”_šdex_off£ts
[] = {

127 cÚ¡ 
	g_kegogi_Ëx”_šdic›s
[] = {

171 cÚ¡ 
	g_kegogi_Ëx”_Œªs_rgs
[] = {

188 cÚ¡ 
	g_kegogi_Ëx”_Œªs_aùiÚs
[] = {

205 cÚ¡ 
	g_kegogi_Ëx”_to_¡©e_aùiÚs
[] = {

215 cÚ¡ 
	g_kegogi_Ëx”_äom_¡©e_aùiÚs
[] = {

225 cÚ¡ 
	g_kegogi_Ëx”_eof_Œªs
[] = {

235 cÚ¡ 
	gkegogi_Ëx”_¡¬t
 = 25;

236 cÚ¡ 
	gkegogi_Ëx”_fœ¡_fš®
 = 25;

237 cÚ¡ 
	gkegogi_Ëx”_”rÜ
 = 0;

239 cÚ¡ 
	gkegogi_Ëx”_’_maš
 = 25;

244 
Tok’Li¡
 *
	$g‘_kegogi_tok’s
(
b¡ršg
 
cÚ‹Á
) {

245 
Tok’Li¡
 *
tok’_li¡
 = 
	`Tok’Li¡_ü—‹
(1024);

246 
	`check_mem
(
tok’_li¡
);

248 *
p
 = 
	`bd©a
(
cÚ‹Á
);

249 *
³
 = 
p
 + 
	`bËngth
(
cÚ‹Á
);

250 *
m
 = 
NULL
;

251 *
eof
 = 
³
;

252 
cs
 = -1;

253 
aù
 = -1;

254 *
ts
 = 
NULL
;

255 *
‹
 = 
NULL
;

257 
b¡ršg
 
s1
 = 
NULL
;

258 
b¡ršg
 
s2
 = 
NULL
;

259 
b¡ršg
 
s3
 = 
NULL
;

264 
cs
 = 
kegogi_Ëx”_¡¬t
;

265 
ts
 = 0;

266 
‹
 = 0;

267 
aù
 = 0;

274 
_kËn
;

275 
_Œªs
;

276 cÚ¡ *
_aùs
;

277 
_Çùs
;

278 cÚ¡ *
_keys
;

280 iàĞ
p
 =ğ
³
 )

281 
_‹¡_eof
;

282 iàĞ
cs
 == 0 )

283 
_out
;

284 
_»sume
:

285 
_aùs
 = 
_kegogi_Ëx”_aùiÚs
 + 
_kegogi_Ëx”_äom_¡©e_aùiÚs
[
cs
];

286 
_Çùs
 = (è*
_aùs
++;

287  
_Çùs
-- > 0 ) {

288  *
_aùs
++ ) {

291 {
ts
 = 
p
;}

297 
_keys
 = 
_kegogi_Ëx”_Œªs_keys
 + 
_kegogi_Ëx”_key_off£ts
[
cs
];

298 
_Œªs
 = 
_kegogi_Ëx”_šdex_off£ts
[
cs
];

300 
_kËn
 = 
_kegogi_Ëx”_sšgË_Ëngths
[
cs
];

301 iàĞ
_kËn
 > 0 ) {

302 cÚ¡ *
_low”
 = 
_keys
;

303 cÚ¡ *
_mid
;

304 cÚ¡ *
_uµ”
 = 
_keys
 + 
_kËn
 - 1;

306 iàĞ
_uµ”
 < 
_low”
 )

309 
_mid
 = 
_low”
 + ((
_uµ”
-_lower) >> 1);

310 iàĞ(*
p
è< *
_mid
 )

311 
_uµ”
 = 
_mid
 - 1;

312 iàĞ(*
p
è> *
_mid
 )

313 
_low”
 = 
_mid
 + 1;

315 
_Œªs
 +ğ(
_mid
 - 
_keys
);

316 
_m©ch
;

319 
_keys
 +ğ
_kËn
;

320 
_Œªs
 +ğ
_kËn
;

323 
_kËn
 = 
_kegogi_Ëx”_¿nge_Ëngths
[
cs
];

324 iàĞ
_kËn
 > 0 ) {

325 cÚ¡ *
_low”
 = 
_keys
;

326 cÚ¡ *
_mid
;

327 cÚ¡ *
_uµ”
 = 
_keys
 + (
_kËn
<<1) - 2;

329 iàĞ
_uµ”
 < 
_low”
 )

332 
_mid
 = 
_low”
 + (((
_uµ”
-_lower) >> 1) & ~1);

333 iàĞ(*
p
è< 
_mid
[0] )

334 
_uµ”
 = 
_mid
 - 2;

335 iàĞ(*
p
è> 
_mid
[1] )

336 
_low”
 = 
_mid
 + 2;

338 
_Œªs
 +ğ((
_mid
 - 
_keys
)>>1);

339 
_m©ch
;

342 
_Œªs
 +ğ
_kËn
;

345 
_m©ch
:

346 
_Œªs
 = 
_kegogi_Ëx”_šdic›s
[_trans];

347 
_eof_Œªs
:

348 
cs
 = 
_kegogi_Ëx”_Œªs_rgs
[
_Œªs
];

350 iàĞ
_kegogi_Ëx”_Œªs_aùiÚs
[
_Œªs
] == 0 )

351 
_agaš
;

353 
_aùs
 = 
_kegogi_Ëx”_aùiÚs
 + 
_kegogi_Ëx”_Œªs_aùiÚs
[
_Œªs
];

354 
_Çùs
 = (è*
_aùs
++;

355  
_Çùs
-- > 0 )

357  *
_aùs
++ )

361 { 
m
 = 
p
; }

365 { 
s1
 = 
	`blk2b¡r
(
m
, 
p
-m); }

369 { 
s2
 = 
	`blk2b¡r
(
m
, 
p
-m); }

373 { 
s3
 = 
	`blk2b¡r
(
m
, 
p
-m); }

377 {
‹
 = 
p
+1;}

381 {
aù
 = 1;}

385 {
aù
 = 2;}

389 {
aù
 = 3;}

393 {
aù
 = 4;}

397 {
aù
 = 5;}

401 {
aù
 = 6;}

405 {
aù
 = 7;}

409 {
aù
 = 9;}

413 {
aù
 = 10;}

417 {
aù
 = 11;}

421 {
aù
 = 13;}

425 {
‹
 = 
p
+1;{

426 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKSTRING
, 
s1
);

427 
s1
 = 
s2
 = 
s3
 = 
NULL
;

432 {
‹
 = 
p
+1;{

433 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKPATTERN
, 
s1
);

434 
s1
 = 
s2
 = 
s3
 = 
NULL
;

439 {
‹
 = 
p
+1;{

440 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKNEWLINE
);

441 
s1
 = 
s2
 = 
s3
 = 
NULL
;

446 {
‹
 = 
p
+1;{

447 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKEQUALS
);

448 
s1
 = 
s2
 = 
s3
 = 
NULL
;

453 {
‹
 = 
p
+1;{ }}

457 {
‹
 = 
p
;p--;{

458 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKSTRING
, 
s1
);

459 
s1
 = 
s2
 = 
s3
 = 
NULL
;

464 {
‹
 = 
p
;p--;{

465 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKNUMBER
, 
s1
);

466 
s1
 = 
s2
 = 
s3
 = 
NULL
;

471 {
‹
 = 
p
;p--;{

472 
	`Tok’Li¡_­³nd3
(&
tok’_li¡
, 
TKURL
, 
s1
, 
s2
, 
s3
);

473 
s1
 = 
s2
 = 
s3
 = 
NULL
;

478 {  
aù
 ) {

480 {{
cs
 = 0; 
_agaš
;}}

483 {{
p
 = ((
‹
))-1;}

484 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKDEFAULTS
);

485 
s1
 = 
s2
 = 
s3
 = 
NULL
;

489 {{
p
 = ((
‹
))-1;}

490 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKSEND
);

491 
s1
 = 
s2
 = 
s3
 = 
NULL
;

495 {{
p
 = ((
‹
))-1;}

496 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKEXPECT
);

497 
s1
 = 
s2
 = 
s3
 = 
NULL
;

501 {{
p
 = ((
‹
))-1;}

502 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKSTRING
, 
s1
);

503 
s1
 = 
s2
 = 
s3
 = 
NULL
;

507 {{
p
 = ((
‹
))-1;}

508 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKPATTERN
, 
s1
);

509 
s1
 = 
s2
 = 
s3
 = 
NULL
;

513 {{
p
 = ((
‹
))-1;}

514 
	`Tok’Li¡_­³nd1
(&
tok’_li¡
, 
TKNUMBER
, 
s1
);

515 
s1
 = 
s2
 = 
s3
 = 
NULL
;

519 {{
p
 = ((
‹
))-1;}

520 
	`Tok’Li¡_­³nd3
(&
tok’_li¡
, 
TKURL
, 
s1
, 
s2
, 
s3
);

521 
s1
 = 
s2
 = 
s3
 = 
NULL
;

525 {{
p
 = ((
‹
))-1;}

526 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKDICT_START
);

527 
s1
 = 
s2
 = 
s3
 = 
NULL
;

531 {{
p
 = ((
‹
))-1;}

532 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKDICT_END
);

533 
s1
 = 
s2
 = 
s3
 = 
NULL
;

537 {{
p
 = ((
‹
))-1;}

538 
	`Tok’Li¡_­³nd0
(&
tok’_li¡
, 
TKEQUALS
);

539 
s1
 = 
s2
 = 
s3
 = 
NULL
;

543 {{
p
 = ((
‹
))-1;} }

552 
_agaš
:

553 
_aùs
 = 
_kegogi_Ëx”_aùiÚs
 + 
_kegogi_Ëx”_to_¡©e_aùiÚs
[
cs
];

554 
_Çùs
 = (è*
_aùs
++;

555  
_Çùs
-- > 0 ) {

556  *
_aùs
++ ) {

559 {
ts
 = 0;}

563 {
aù
 = 0;}

569 iàĞ
cs
 == 0 )

570 
_out
;

571 iàĞ++
p
 !ğ
³
 )

572 
_»sume
;

573 
_‹¡_eof
: {}

574 iàĞ
p
 =ğ
eof
 )

576 iàĞ
_kegogi_Ëx”_eof_Œªs
[
cs
] > 0 ) {

577 
_Œªs
 = 
_kegogi_Ëx”_eof_Œªs
[
cs
] - 1;

578 
_eof_Œªs
;

582 
_out
: {}

587  
tok’_li¡
;

589 
”rÜ
:

590 
	`Tok’Li¡_de¡roy
(
tok’_li¡
);

591  
NULL
;

592 
	}
}

	@tools/examples/kegogi/src/kegogi_parser.c

6 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<dbg.h
>

13 
	~"kegogi_·r£r.h
"

14 
	~"kegogi_tok’s.h
"

15 
	~"kegogi.h
"

17 
	#as£¹
(
S
) { \

18 if(!(
S
)) { \

19 
	`debug
(#S); \

20 
	`skex™®l
(-1); \

22 }

	)

37 #iâdeà
INTERFACE


38 
	#INTERFACE
 1

	)

74 
	#YYCODETYPE
 

	)

75 
	#YYNOCODE
 21

	)

76 
	#YYACTIONTYPE
 

	)

77 
	#P¬£TOKENTYPE
 
Tok’
*

	)

79 
	myyš™
;

80 
P¬£TOKENTYPE
 
	myy0
;

81 
P¬am
* 
	myy8
;

82 
P¬amDiù
* 
	myy24
;

83 
Commªd
* 
	myy30
;

84 } 
	tYYMINORTYPE
;

85 #iâdeà
YYSTACKDEPTH


86 
	#YYSTACKDEPTH
 100

	)

88 
	#P¬£ARG_SDECL
 
CommªdLi¡
 *
commªdLi¡
;

	)

89 
	#P¬£ARG_PDECL
 ,
CommªdLi¡
 *
commªdLi¡


	)

90 
	#P¬£ARG_FETCH
 
CommªdLi¡
 *
commªdLi¡
 = 
yypP¬£r
->
	)
commandList

91 
	#P¬£ARG_STORE
 
yypP¬£r
->
commªdLi¡
 = 
	)
commandList

92 
	#YYNSTATE
 25

	)

93 
	#YYNRULE
 12

	)

94 
	#YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

	)

95 
	#YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

	)

96 
	#YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

	)

100 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

110 #iâdeà
yy‹¡ÿ£


111 
	#yy‹¡ÿ£
(
X
)

	)

162 cÚ¡ 
YYACTIONTYPE
 
	gyy_aùiÚ
[] = {

167 cÚ¡ 
YYCODETYPE
 
	gyy_lookah—d
[] = {

172 
	#YY_SHIFT_USE_DFLT
 (-1)

	)

173 
	#YY_SHIFT_MAX
 15

	)

174 cÚ¡ sigÃd 
	gyy_shiá_of¡
[] = {

178 
	#YY_REDUCE_USE_DFLT
 (-12)

	)

179 
	#YY_REDUCE_MAX
 9

	)

180 cÚ¡ sigÃd 
	gyy_»duû_of¡
[] = {

183 cÚ¡ 
YYACTIONTYPE
 
	gyy_deçuÉ
[] = {

188 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

200 #ifdeà
YYFALLBACK


201 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

217 
	syySckEÁry
 {

218 
YYACTIONTYPE
 
	m¡©’o
;

219 
YYCODETYPE
 
	mmajÜ
;

221 
YYMINORTYPE
 
	mmšÜ
;

224 
yySckEÁry
 
	tyySckEÁry
;

228 
	syyP¬£r
 {

229 
	myyidx
;

230 #ifdeà
YYTRACKMAXSTACKDEPTH


231 
	myyidxMax
;

233 
	myy”rút
;

234 
	mP¬£ARG_SDECL


235 #ià
YYSTACKDEPTH
<=0

236 
	myy¡ksz
;

237 
yySckEÁry
 *
	myy¡ack
;

239 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

242 
yyP¬£r
 
	tyyP¬£r
;

244 #iâdeà
NDEBUG


245 
	~<¡dio.h
>

246 
FILE
 *
	gyyT¿ûFILE
 = 0;

247 *
	gyyT¿ûProm±
 = 0;

250 #iâdeà
NDEBUG


268 
	$P¬£T¿û
(
FILE
 *
T¿ûFILE
, *
zT¿ûProm±
){

269 
yyT¿ûFILE
 = 
T¿ûFILE
;

270 
yyT¿ûProm±
 = 
zT¿ûProm±
;

271 ifĞ
yyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

272 ifĞ
yyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

273 
	}
}

276 #iâdeà
NDEBUG


279 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

288 #iâdeà
NDEBUG


291 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

308 #ià
YYSTACKDEPTH
<=0

312 
	$yyGrowSck
(
yyP¬£r
 *
p
){

313 
ÃwSize
;

314 
yySckEÁry
 *
pNew
;

316 
ÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

317 
pNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

318 ifĞ
pNew
 ){

319 
p
->
yy¡ack
 = 
pNew
;

320 
p
->
yy¡ksz
 = 
ÃwSize
;

321 #iâdeà
NDEBUG


322 ifĞ
yyT¿ûFILE
 ){

323 
	`årštf
(
yyT¿ûFILE
,"%sStack growso %dƒntries!\n",

324 
yyT¿ûProm±
, 
p
->
yy¡ksz
);

328 
	}
}

343 *
P¬£AÎoc
(*(*
m®locProc
)(
size_t
)){

344 
yyP¬£r
 *
	gpP¬£r
;

345 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

346 ifĞ
	gpP¬£r
 ){

347 
	gpP¬£r
->
	gyyidx
 = -1;

348 #ifdeà
YYTRACKMAXSTACKDEPTH


349 
	gpP¬£r
->
	gyyidxMax
 = 0;

351 #ià
YYSTACKDEPTH
<=0

352 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

353 
	gpP¬£r
->
	gyy¡ksz
 = 0;

354 
yyGrowSck
(
pP¬£r
);

357  
	gpP¬£r
;

365 
	$yy_de¡ruùÜ
(

366 
yyP¬£r
 *
yypP¬£r
,

367 
YYCODETYPE
 
yymajÜ
,

368 
YYMINORTYPE
 *
yypmšÜ


370 
P¬£ARG_FETCH
;

371  
yymajÜ
 ){

385 
	`ä“
((
yypmšÜ
->
yy30
));

391 
	}
}

401 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

402 
YYCODETYPE
 
yymajÜ
;

403 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

405 ifĞ
pP¬£r
->
yyidx
<0 )  0;

406 #iâdeà
NDEBUG


407 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

408 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

409 
yyT¿ûProm±
,

410 
yyTok’Name
[
yytos
->
majÜ
]);

413 
yymajÜ
 = 
yytos
->
majÜ
;

414 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

415 
pP¬£r
->
yyidx
--;

416  
yymajÜ
;

417 
	}
}

431 
P¬£F»e
(

432 *
p
,

433 (*
ä“Proc
)(*)

435 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

436 ifĞ
pP¬£r
==0 ) ;

437  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

438 #ià
YYSTACKDEPTH
<=0

439 
	`ä“
(
pP¬£r
->
yy¡ack
);

441 (*
ä“Proc
)((*)
pP¬£r
);

442 
	}
}

447 #ifdeà
YYTRACKMAXSTACKDEPTH


448 
	$P¬£SckP—k
(*
p
){

449 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

450  
pP¬£r
->
yyidxMax
;

451 
	}
}

462 
	$yy_fšd_shiá_aùiÚ
(

463 
yyP¬£r
 *
pP¬£r
,

464 
YYCODETYPE
 
iLookAh—d


466 
i
;

467 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

469 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

470  
yy_deçuÉ
[
¡©’o
];

472 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

473 
i
 +ğ
iLookAh—d
;

474 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

475 ifĞ
iLookAh—d
>0 ){

476 #ifdeà
YYFALLBACK


477 
YYCODETYPE
 
iF®lback
;

478 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

479 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

480 #iâdeà
NDEBUG


481 ifĞ
yyT¿ûFILE
 ){

482 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

483 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

486  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

489 #ifdeà
YYWILDCARD


491 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

492 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

493 #iâdeà
NDEBUG


494 ifĞ
yyT¿ûFILE
 ){

495 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

496 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

499  
yy_aùiÚ
[
j
];

504  
yy_deçuÉ
[
¡©’o
];

506  
yy_aùiÚ
[
i
];

508 
	}
}

518 
	$yy_fšd_»duû_aùiÚ
(

519 
¡©’o
,

520 
YYCODETYPE
 
iLookAh—d


522 
i
;

523 #ifdeà
YYERRORSYMBOL


524 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

525  
yy_deçuÉ
[
¡©’o
];

528 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

530 
i
 = 
yy_»duû_of¡
[
¡©’o
];

531 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

532 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

533 
i
 +ğ
iLookAh—d
;

534 #ifdeà
YYERRORSYMBOL


535 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

536  
yy_deçuÉ
[
¡©’o
];

539 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

540 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

542  
yy_aùiÚ
[
i
];

543 
	}
}

548 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

549 
P¬£ARG_FETCH
;

550 
yypP¬£r
->
yyidx
--;

551 #iâdeà
NDEBUG


552 ifĞ
yyT¿ûFILE
 ){

553 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

556  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

561 
	`debug
("There was‡ stack overflow");

564 
P¬£ARG_STORE
;

565 
	}
}

570 
	$yy_shiá
(

571 
yyP¬£r
 *
yypP¬£r
,

572 
yyNewS‹
,

573 
yyMajÜ
,

574 
YYMINORTYPE
 *
yypMšÜ


576 
yySckEÁry
 *
yytos
;

577 
yypP¬£r
->
yyidx
++;

578 #ifdeà
YYTRACKMAXSTACKDEPTH


579 ifĞ
yypP¬£r
->
yyidx
>yypP¬£r->
yyidxMax
 ){

580 
yypP¬£r
->
yyidxMax
 = yypP¬£r->
yyidx
;

583 #ià
YYSTACKDEPTH
>0

584 ifĞ
yypP¬£r
->
yyidx
>=
YYSTACKDEPTH
 ){

585 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

589 ifĞ
yypP¬£r
->
yyidx
>=yypP¬£r->
yy¡ksz
 ){

590 
	`yyGrowSck
(
yypP¬£r
);

591 ifĞ
yypP¬£r
->
yyidx
>=yypP¬£r->
yy¡ksz
 ){

592 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

597 
yytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

598 
yytos
->
¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

599 
yytos
->
majÜ
 = (
YYCODETYPE
)
yyMajÜ
;

600 
yytos
->
mšÜ
 = *
yypMšÜ
;

601 #iâdeà
NDEBUG


602 ifĞ
yyT¿ûFILE
 && 
yypP¬£r
->
yyidx
>0 ){

603 
i
;

604 
	`årštf
(
yyT¿ûFILE
,"%sShiá %d\n",
yyT¿ûProm±
,
yyNewS‹
);

605 
	`årštf
(
yyT¿ûFILE
,"%sSck:",
yyT¿ûProm±
);

606 
i
=1; i<=
yypP¬£r
->
yyidx
; i++)

607 
	`årštf
(
yyT¿ûFILE
," %s",
yyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
majÜ
]);

608 
	`årštf
(
yyT¿ûFILE
,"\n");

611 
	}
}

617 
YYCODETYPE
 
	mlhs
;

618 
	mÄhs
;

619 } 
	gyyRuËInfo
[] = {

634 
yy_acû±
(
yyP¬£r
*);

640 
	$yy_»duû
(

641 
yyP¬£r
 *
yypP¬£r
,

642 
yyruËno


644 
yygÙo
;

645 
yyaù
;

646 
YYMINORTYPE
 
yygÙomšÜ
;

647 
yySckEÁry
 *
yym¥
;

648 
yysize
;

649 
P¬£ARG_FETCH
;

650 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

651 #iâdeà
NDEBUG


652 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

653 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

654 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

655 
yyRuËName
[
yyruËno
]);

674 
yygÙomšÜ
 = 
yyz”omšÜ
;

677  
yyruËno
 ){

689 
idx
 = 
commªdLi¡
->
couÁ
;

690 
	`as£¹
(
idx
 < 
commªdLi¡
->
size
);

691 
commªdLi¡
->
couÁ
++;

692 
commªdLi¡
->
commªds
[
idx
] = *
yym¥
[0].
mšÜ
.
yy30
;

693 
	`ä“
(
yym¥
[0].
mšÜ
.
yy30
);

700 if(
commªdLi¡
->
deçuÉs
 !ğ
NULL
)

701 
	`debug
("You can only specify defaults once");

703 
commªdLi¡
->
deçuÉs
 = 
yym¥
[0].
mšÜ
.
yy24
;

709 { 
yygÙomšÜ
.
yy24
 = 
yym¥
[-1].
mšÜ
.yy24; 
	`P¬amDiù_£t
(yygÙomšÜ.yy24, yym¥[0].mšÜ.
yy8
); }

714 { 
yygÙomšÜ
.
yy24
 = 
	`P¬amDiù_ü—‹
(); }

720 
yygÙomšÜ
.
yy8
 = 
	`P¬am_ü—‹
(
	`b¡rıy
(
yym¥
[-2].
mšÜ
.
yy0
->
s1
), 
PATTERN
, bstrcpy(yymsp[0].minor.yy0->s1));

727 
yygÙomšÜ
.
yy8
 = 
	`P¬am_ü—‹
(
	`b¡rıy
(
yym¥
[-2].
mšÜ
.
yy0
->
s1
), 
STRING
, bstrcpy(yymsp[0].minor.yy0->s1));

734 
yygÙomšÜ
.
yy8
 = 
	`P¬am_ü—‹
(
	`b¡rıy
(
yym¥
[-4].
mšÜ
.
yy0
->
s1
), 
DICT
, yym¥[-1].mšÜ.
yy24
);

740 { 
yygÙomšÜ
.
yy24
 = 
yym¥
[-1].
mšÜ
.yy24; }

746 
yygÙomšÜ
.
yy30
 = 
	`ÿÎoc
((
Commªd
), 1);

747 
yygÙomšÜ
.
yy30
->
£nd
.
m‘hod
 = 
	`b¡rıy
(
yym¥
[-7].
mšÜ
.
yy0
->
s1
);

748 
yygÙomšÜ
.
yy30
->
£nd
.
uri
 = 
	`b¡rıy
(
yym¥
[-6].
mšÜ
.
yy0
->
s1
);

749 
yygÙomšÜ
.
yy30
->
£nd
.
ho¡
 = (
yym¥
[-6].
mšÜ
.
yy0
->
s2
 =ğ
NULL
è? NULL : 
	`b¡rıy
(yymsp[-6].minor.yy0->s2);

750 
yygÙomšÜ
.
yy30
->
£nd
.
pÜt
 = (
yym¥
[-6].
mšÜ
.
yy0
->
s3
 =ğ
NULL
è? NULL : 
	`b¡rıy
(yymsp[-6].minor.yy0->s3);

751 
yygÙomšÜ
.
yy30
->
£nd
.
·¿ms
 = 
yym¥
[-5].
mšÜ
.
yy24
;

752 
yygÙomšÜ
.
yy30
->
ex³ù
.
¡©us_code
 = 
	`b¡rıy
(
yym¥
[-2].
mšÜ
.
yy0
->
s1
);

753 
yygÙomšÜ
.
yy30
->
ex³ù
.
·¿ms
 = 
yym¥
[-1].
mšÜ
.
yy24
;

758  
	`yy‹¡ÿ£
(
yyruËno
==0);

759  
	`yy‹¡ÿ£
(
yyruËno
==3);

760  
	`yy‹¡ÿ£
(
yyruËno
==4);

763 
yygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

764 
yysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

765 
yypP¬£r
->
yyidx
 -ğ
yysize
;

766 
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
YYCODETYPE
)
yygÙo
);

767 ifĞ
yyaù
 < 
YYNSTATE
 ){

768 #ifdeà
NDEBUG


773 ifĞ
yysize
 ){

774 
yypP¬£r
->
yyidx
++;

775 
yym¥
 -ğ
yysize
-1;

776 
yym¥
->
¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

777 
yym¥
->
majÜ
 = (
YYCODETYPE
)
yygÙo
;

778 
yym¥
->
mšÜ
 = 
yygÙomšÜ
;

782 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yygÙo
,&
yygÙomšÜ
);

785 
	`as£¹
Ğ
yyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

786 
	`yy_acû±
(
yypP¬£r
);

788 
	}
}

793 #iâdeà
YYNOERRORRECOVERY


794 
	$yy_·r£_çed
(

795 
yyP¬£r
 *
yypP¬£r


797 
P¬£ARG_FETCH
;

798 #iâdeà
NDEBUG


799 ifĞ
yyT¿ûFILE
 ){

800 
	`årštf
(
yyT¿ûFILE
,"%sFa!\n",
yyT¿ûProm±
);

803  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

806 
P¬£ARG_STORE
;

807 
	}
}

813 
	$yy_syÁax_”rÜ
(

814 
yyP¬£r
 *
yypP¬£r
,

815 
yymajÜ
,

816 
YYMINORTYPE
 
yymšÜ


818 
P¬£ARG_FETCH
;

819 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

822 
	`debug
("There was‡ syntaxƒrror");

825 
P¬£ARG_STORE
;

826 
	}
}

831 
	$yy_acû±
(

832 
yyP¬£r
 *
yypP¬£r


834 
P¬£ARG_FETCH
;

835 #iâdeà
NDEBUG


836 ifĞ
yyT¿ûFILE
 ){

837 
	`årštf
(
yyT¿ûFILE
,"%sAcû±!\n",
yyT¿ûProm±
);

840  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

843 
P¬£ARG_STORE
;

844 
	}
}

865 
	$P¬£
(

866 *
yyp
,

867 
yymajÜ
,

868 
P¬£TOKENTYPE
 
yymšÜ


869 
P¬£ARG_PDECL


871 
YYMINORTYPE
 
yymšÜuniÚ
;

872 
yyaù
;

873 
yy’dofšput
;

874 #ifdeà
YYERRORSYMBOL


875 
yy”rÜh™
 = 0;

877 
yyP¬£r
 *
yypP¬£r
;

880 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

881 ifĞ
yypP¬£r
->
yyidx
<0 ){

882 #ià
YYSTACKDEPTH
<=0

883 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

885 
yymšÜuniÚ
 = 
yyz”omšÜ
;

886 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

890 
yypP¬£r
->
yyidx
 = 0;

891 
yypP¬£r
->
yy”rút
 = -1;

892 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

893 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

895 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

896 
yy’dofšput
 = (
yymajÜ
==0);

897 
P¬£ARG_STORE
;

899 #iâdeà
NDEBUG


900 ifĞ
yyT¿ûFILE
 ){

901 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

906 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

907 ifĞ
yyaù
<
YYNSTATE
 ){

908 
	`as£¹
Ğ!
yy’dofšput
 );

909 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

910 
yypP¬£r
->
yy”rút
--;

911 
yymajÜ
 = 
YYNOCODE
;

912 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

913 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

915 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

916 #ifdeà
YYERRORSYMBOL


917 
yymx
;

919 #iâdeà
NDEBUG


920 ifĞ
yyT¿ûFILE
 ){

921 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

924 #ifdeà
YYERRORSYMBOL


944 ifĞ
yypP¬£r
->
yy”rút
<0 ){

945 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

947 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

948 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

949 #iâdeà
NDEBUG


950 ifĞ
yyT¿ûFILE
 ){

951 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

952 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

955 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

956 
yymajÜ
 = 
YYNOCODE
;

959 
yypP¬£r
->
yyidx
 >= 0 &&

960 
yymx
 !ğ
YYERRORSYMBOL
 &&

961 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

962 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

963 
YYERRORSYMBOL
)è>ğ
YYNSTATE


965 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

967 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

968 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

969 
	`yy_·r£_çed
(
yypP¬£r
);

970 
yymajÜ
 = 
YYNOCODE
;

971 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

972 
YYMINORTYPE
 
u2
;

973 
u2
.
YYERRSYMDT
 = 0;

974 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

977 
yypP¬£r
->
yy”rút
 = 3;

978 
yy”rÜh™
 = 1;

979 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

987 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

988 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

989 
yymajÜ
 = 
YYNOCODE
;

1001 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

1002 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1004 
yypP¬£r
->
yy”rút
 = 3;

1005 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

1006 ifĞ
yy’dofšput
 ){

1007 
	`yy_·r£_çed
(
yypP¬£r
);

1009 
yymajÜ
 = 
YYNOCODE
;

1012 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

1014 
	}
}

1017 
	$·r£_kegogi_fe
(cÚ¡ *
·th
, 
Commªd
 
commªds
[],

1018 
max_num_commªds
, 
P¬amDiù
 **
deçuÉs
) {

1019 
FILE
 *
süt
;

1020 
Tok’Li¡
 *
tok’s
 = 
NULL
;

1021 
b¡ršg
 
bufãr
 = 
NULL
;

1022 *
·r£r
 = 
NULL
;

1024 
CommªdLi¡
 
commªdLi¡
 = {

1025 .
size
 = 
max_num_commªds
,

1026 .
couÁ
 = 0,

1027 .
deçuÉs
 = 
NULL
,

1028 .
commªds
 = commands

1031 
süt
 = 
	`fİ’
(
·th
, "r");

1032 
	`check
(
süt
, "FaedØİ’ fe: %s", 
·th
);

1034 
bufãr
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
süt
);

1035 
	`check_mem
(
bufãr
);

1037 
	`fşo£
(
süt
);

1038 
süt
 = 
NULL
;

1040 
tok’s
 = 
	`g‘_kegogi_tok’s
(
bufãr
);

1041 
	`check_mem
(
tok’s
);

1043 
	`bde¡roy
(
bufãr
);

1044 
bufãr
 = 
NULL
;

1046 
·r£r
 = 
	`P¬£AÎoc
(
m®loc
);

1047 
	`check_mem
(
·r£r
);

1049 
i
;

1050 
i
 = 0; i < 
tok’s
->
couÁ
; i++) {

1051 
	`P¬£
(
·r£r
, 
tok’s
->tok’s[
i
].
ty³
, &tokens->tokens[i],

1052 &
commªdLi¡
);

1054 
	`P¬£
(
·r£r
, 
TKNEWLINE
, 0, &
commªdLi¡
);

1055 
	`P¬£
(
·r£r
, 0, 0, &
commªdLi¡
);

1056 
	`Tok’Li¡_de¡roy
(
tok’s
);

1057 
tok’s
 = 
NULL
;

1059 *
deçuÉs
 = 
commªdLi¡
.defaults;

1060  
commªdLi¡
.
couÁ
;

1062 
”rÜ
:

1063 
	`Tok’Li¡_de¡roy
(
tok’s
);

1064 
	`bde¡roy
(
bufãr
);

1065 if(
süt
è
	`fşo£
(script);

1066 if(
·r£r
è
	`P¬£F»e
Õ¬£r, 
ä“
);

1069 
	}
}

	@tools/examples/kegogi/src/kegogi_parser.h

1 
	#TKNEWLINE
 1

	)

2 
	#TKSTRING
 2

	)

3 
	#TKEQUALS
 3

	)

4 
	#TKPATTERN
 4

	)

5 
	#TKDICT_START
 5

	)

6 
	#TKDICT_END
 6

	)

7 
	#TKDEFAULTS
 7

	)

8 
	#TKSEND
 8

	)

9 
	#TKURL
 9

	)

10 
	#TKEXPECT
 10

	)

11 
	#TKNUMBER
 11

	)

	@tools/examples/kegogi/src/kegogi_parser_extra.c

3 
	$·r£_kegogi_fe
(cÚ¡ *
·th
, 
Commªd
 
commªds
[],

4 
max_num_commªds
, 
P¬amDiù
 **
deçuÉs
) {

5 
FILE
 *
süt
;

6 
Tok’Li¡
 *
tok’s
 = 
NULL
;

7 
b¡ršg
 
bufãr
 = 
NULL
;

8 *
·r£r
 = 
NULL
;

10 
CommªdLi¡
 
commªdLi¡
 = {

11 .
size
 = 
max_num_commªds
,

12 .
couÁ
 = 0,

13 .
deçuÉs
 = 
NULL
,

14 .
commªds
 = commands

17 
süt
 = 
	`fİ’
(
·th
, "r");

18 
	`check
(
süt
, "FaedØİ’ fe: %s", 
·th
);

20 
bufãr
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
süt
);

21 
	`check_mem
(
bufãr
);

23 
	`fşo£
(
süt
);

24 
süt
 = 
NULL
;

26 
tok’s
 = 
	`g‘_kegogi_tok’s
(
bufãr
);

27 
	`check_mem
(
tok’s
);

29 
	`bde¡roy
(
bufãr
);

30 
bufãr
 = 
NULL
;

32 
·r£r
 = 
	`P¬£AÎoc
(
m®loc
);

33 
	`check_mem
(
·r£r
);

35 
i
;

36 
i
 = 0; i < 
tok’s
->
couÁ
; i++) {

37 
	`P¬£
(
·r£r
, 
tok’s
->tok’s[
i
].
ty³
, &tokens->tokens[i],

38 &
commªdLi¡
);

40 
	`P¬£
(
·r£r
, 
TKNEWLINE
, 0, &
commªdLi¡
);

41 
	`P¬£
(
·r£r
, 0, 0, &
commªdLi¡
);

42 
	`Tok’Li¡_de¡roy
(
tok’s
);

43 
tok’s
 = 
NULL
;

45 *
deçuÉs
 = 
commªdLi¡
.defaults;

46  
commªdLi¡
.
couÁ
;

48 
”rÜ
:

49 
	`Tok’Li¡_de¡roy
(
tok’s
);

50 
	`bde¡roy
(
bufãr
);

51 if(
süt
è
	`fşo£
(script);

52 if(
·r£r
è
	`P¬£F»e
Õ¬£r, 
ä“
);

55 
	}
}

	@tools/examples/kegogi/src/kegogi_tokens.c

1 
	~"kegogi_tok’s.h
"

3 
	~<¡dlib.h
>

5 
	~<dbg.h
>

7 
Tok’Li¡
* 
	$Tok’Li¡_ü—‹
(
size
) {

8 
Tok’Li¡
 *
li¡
 = 
	`m®loc
((Tok’Li¡è+ ((
Tok’
è* 
size
));

9 if(!
li¡
è 
NULL
;

11 
li¡
->
size
 = size;

12 
li¡
->
couÁ
 = 0;

14  
li¡
;

15 
	}
}

17 
	$Tok’Li¡_»size
(
Tok’Li¡
** 
li¡P
, 
Ãw_size
) {

18 if(!
li¡P
 || !(*listP))  -1;

19 
Tok’Li¡
 *
Ãw
 = 
	`»®loc
((*
li¡P
),

20 (
Tok’Li¡
è+ ((
Tok’
è* 
Ãw_size
));

21 
	`check_mem
(
Ãw
);

23 
Ãw
->
size
 = 
Ãw_size
;

24 *
li¡P
 = 
Ãw
;

28 
”rÜ
:

29 
	`Tok’Li¡_de¡roy
(*
li¡P
);

31 
	}
}

33 
	$Tok’Li¡_de¡roy
(
Tok’Li¡
* 
li¡
) {

34 if(
li¡
) {

35 
i
;

36 
i
 = 0; i < 
li¡
->
couÁ
; i++) {

37 if(
li¡
->
tok’s
[
i
].
s1
è
	`ä“
(list->tokens[i].s1);

38 if(
li¡
->
tok’s
[
i
].
s2
è
	`ä“
(list->tokens[i].s2);

39 if(
li¡
->
tok’s
[
i
].
s3
è
	`ä“
(list->tokens[i].s3);

41 
	`ä“
(
li¡
);

44 
	}
}

46 
	$Tok’Li¡_­³nd0
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
) {

47  
	`Tok’Li¡_­³nd3
(
li¡P
, 
ty³
, 0, 0, 0);

48 
	}
}

50 
	$Tok’Li¡_­³nd1
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
) {

51  
	`Tok’Li¡_­³nd3
(
li¡P
, 
ty³
, 
s1
, 0, 0);

52 
	}
}

53 
	$Tok’Li¡_­³nd2
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
, b¡ršg 
s2
) {

54  
	`Tok’Li¡_­³nd3
(
li¡P
, 
ty³
, 
s1
, 
s2
, 0);

55 
	}
}

57 
	$Tok’Li¡_­³nd3
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
, b¡ršg 
s2
,

58 
b¡ršg
 
s3
) {

59 
	`check
(
li¡P
 !ğ
NULL
 && *listP != NULL, "Invalid…ointer…assedo‡ppend");

61 
Tok’Li¡
 *
li¡
 = *
li¡P
;

62 if(
li¡
->
couÁ
 + 1 >†i¡->
size
) {

63 
rc
 = 
	`Tok’Li¡_»size
(
li¡P
, 
li¡
->
size
 * 2);

64 
	`check
(
rc
 == 0, "Failedo„esize TokenList");

67 
li¡
 = *
li¡P
;

69 
li¡
->
couÁ
++;

70 
idx
 = 
li¡
->
couÁ
 - 1;

72 
li¡
->
tok’s
[
idx
].
ty³
 =ype;

73 
li¡
->
tok’s
[
idx
].
s1
 = s1;

74 
li¡
->
tok’s
[
idx
].
s2
 = s2;

75 
li¡
->
tok’s
[
idx
].
s3
 = s3;

78 
”rÜ
:

80 
	}
}

	@tools/examples/kegogi/src/kegogi_tokens.h

1 #iâdeà
_KEGOGI_TOKENS_H


2 
	#_KEGOGI_TOKENS_H


	)

4 
	~<b¡ršg.h
>

6 
	tTok’Ty³
;

8 
	sTok’
 {

9 
Tok’Ty³
 
	mty³
;

10 
b¡ršg
 
	ms1
;

11 
b¡ršg
 
	ms2
;

12 
b¡ršg
 
	ms3
;

13 } 
	tTok’
;

15 
	sTok’Li¡
 {

16 
	mcouÁ
;

17 
	msize
;

18 
Tok’
 
	mtok’s
[0];

19 } 
	tTok’Li¡
;

21 *
blk2c¡r
(*
¡¬t
, 
Ën
);

23 
Tok’Li¡
* 
Tok’Li¡_ü—‹
(
size
);

24 
Tok’Li¡_de¡roy
(
Tok’Li¡
* 
li¡
);

25 
Tok’Li¡_­³nd0
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
);

26 
Tok’Li¡_­³nd1
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
);

27 
Tok’Li¡_­³nd2
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
,

28 
b¡ršg
 
s2
);

29 
Tok’Li¡_­³nd3
(
Tok’Li¡
** 
li¡P
, 
Tok’Ty³
 
ty³
, 
b¡ršg
 
s1
,

30 
b¡ršg
 
s2
, b¡ršg 
s3
);

	@tools/examples/kegogi/src/param.c

1 
	~"·¿m.h
"

3 
	~<¡dlib.h
>

5 
	~<adt/diù.h
>

6 
	~<b¡ršg.h
>

7 
	~<dbg.h
>

9 
P¬am
 *
	$P¬am_ü—‹
(
b¡ršg
 
Çme
, 
P¬amTy³
 
ty³
, *
v®
) {

10 
	`check
(
Çme
 !ğ
NULL
 && 
v®
 != NULL, "Null‚ame or val…assedo Param_create");

11 
P¬am
 *
p
 = 
	`ÿÎoc
((*p), 1);

12 
	`check_mem
(
p
);

13 
p
->
Çme
 =‚ame;

14 
p
->
ty³
 =ype;

15 
p
->
ty³
) {

16 
DICT
:

17 
p
->
d©a
.
diù
 = (
P¬amDiù
 *)
v®
;

19 
STRING
:

20 
p
->
d©a
.
¡ršg
 = (
b¡ršg
)
v®
;

22 
PATTERN
:

23 
p
->
d©a
.
·‰”n
 = (
b¡ršg
)
v®
;

26  
p
;

28 
”rÜ
:

29 
	`P¬am_de¡roy
(
p
);

30  
NULL
;

31 
	}
}

33 
P¬am
 *
	$P¬am_cİy
(
P¬am
 *
p
) {

34 if(!
p
è 
NULL
;

35 
P¬am
 *
p2
 = 
	`ÿÎoc
((*p2), 1);

36 
	`check_mem
(
p2
);

38 
p2
->
Çme
 = 
	`b¡rıy
(
p
->name);

39 
	`check_mem
(
p2
->
Çme
);

40 
p2
->
ty³
 = 
p
->type;

42 
p
->
ty³
) {

43 
DICT
:

44 
p2
->
d©a
.
diù
 = 
	`P¬amDiù_cİy
(
p
->data.dict);

45 
	`check_mem
(
p2
->
d©a
.
diù
);

47 
STRING
:

48 
p2
->
d©a
.
¡ršg
 = 
	`b¡rıy
(
p
->data.string);

49 
	`check_mem
(
p2
->
d©a
.
¡ršg
);

51 
PATTERN
:

52 
p2
->
d©a
.
·‰”n
 = 
	`b¡rıy
(
p
->data.pattern);

53 
	`check_mem
(
p2
->
d©a
.
·‰”n
);

57  
p2
;

59 
”rÜ
:

60 
	`P¬am_de¡roy
(
p2
);

61  
NULL
;

62 
	}
}

64 
	$P¬am_de¡roy
(
P¬am
 *
p
) {

65 if(
p
) {

66 if(
p
->
Çme
è
	`bde¡roy
(p->name);

67 
p
->
ty³
) {

68 
DICT
:

69 if(
p
->
d©a
.
diù
è
	`P¬amDiù_de¡roy
(p->data.dict);

71 
STRING
:

72 if(
p
->
d©a
.
¡ršg
è
	`bde¡roy
(p->data.string);

74 
PATTERN
:

75 if(
p
->
d©a
.
·‰”n
è
	`bde¡roy
(p->data.pattern);

78 
	`ä“
(
p
);

80 
	}
}

82 
dnode_t
 *
	$pd_®loc_diù
(*
nÙu£d
) {

83  (
dnode_t
 *)
	`ÿÎoc
((dnode_t), 1);

84 
	}
}

86 
	$pd_ä“_diù
(
dnode_t
 *
node
, *
nÙu£d
) {

88 
	`P¬am_de¡roy
((
P¬am
 *)
	`dnode_g‘
(
node
));

89 
	`ä“
(
node
);

90 
	}
}

92 
P¬amDiù
 *
	$P¬amDiù_ü—‹
() {

93 
P¬amDiù
 *
pd
 = 
	`ÿÎoc
((*pd), 1);

94 
	`check_mem
(
pd
);

95 
pd
->
diù
 = 
	`diù_ü—‹
(
MAX_PARAM_COUNT
, (
diù_comp_t
è
b¡ricmp
);

96 
	`check_mem
(
pd
->
diù
);

98 
	`diù_£t_®loÿtÜ
(
pd
->
diù
, 
pd_®loc_diù
, 
pd_ä“_diù
, 
NULL
);

101  
pd
;

103 
”rÜ
:

104 
	`P¬amDiù_de¡roy
(
pd
);

105  
NULL
;

106 
	}
}

108 
P¬amDiù
 *
	$P¬amDiù_cİy
(
P¬amDiù
 *
pd
) {

109 if(!
pd
è 
NULL
;

111 
P¬amDiù
 *
pd2
 = 
	`P¬amDiù_ü—‹
();

112 
dnode_t
 *
d
;

113 
P¬am
 *
p
, *
p2
;

115 
	`check_mem
(
pd2
);

116 
	`P¬amDiù_fÜ—ch
(
pd
, 
p
, 
d
) {

117 
p2
 = 
	`P¬am_cİy
(
p
);

118 
	`check_mem
(
p2
);

119 
	`P¬amDiù_£t
(
pd2
, 
p2
);

122  
pd2
;

124 
”rÜ
:

125 
	`P¬amDiù_de¡roy
(
pd
);

126  
NULL
;

127 
	}
}

129 
	$P¬amDiù_de¡roy
(
P¬amDiù
 *
pd
) {

130 if(
pd
) {

131 if(
pd
->
diù
) {

132 
	`diù_ä“_nodes
(
pd
->
diù
);

133 
	`diù_de¡roy
(
pd
->
diù
);

135 
	`ä“
(
pd
);

137 
	}
}

139 
	$P¬amDiù_£t
(
P¬amDiù
 *
pd
, 
P¬am
 *
p
) {

140 if(!
pd
 || !
p
) ;

142 
dnode_t
 *
node
 = 
	`diù_lookup
(
pd
->
diù
, 
p
->
Çme
);

143 if(
node
è
	`diù_d–‘e_ä“
(
pd
->
diù
,‚ode);

145 
	`diù_®loc_š£¹
(
pd
->
diù
, 
p
->
Çme
,…);

148 
	}
}

150 
P¬am
 *
	$P¬amDiù_g‘
(
P¬amDiù
 *
pd
, 
b¡ršg
 
Çme
) {

151 if(!
pd
 || !
Çme
è 
NULL
;

153 
dnode_t
 *
node
 = 
	`diù_lookup
(
pd
->
diù
, 
Çme
);

154  
node
 =ğ
NULL
 ? NULL : 
	`dnode_g‘
(node);

155 
	}
}

	@tools/examples/kegogi/src/param.h

1 #iâdeà
_PARAM_H


2 
	#_PARAM_H


	)

4 
	~<b¡ršg.h
>

5 
	~<adt/diù.h
>

7 
	#MAX_PARAM_COUNT
 100

	)

9 
	eP¬amTy³
 {

10 
	mSTRING
,

11 
	mPATTERN
,

12 
	mDICT


13 } 
	tP¬amTy³
;

15 
	sP¬amDiù
 {

16 
diù_t
 *
	mdiù
;

17 } 
	tP¬amDiù
;

19 
	sP¬am
 {

20 
b¡ršg
 
	mÇme
;

21 
P¬amTy³
 
	mty³
;

23 
b¡ršg
 
	m¡ršg
;

24 
b¡ršg
 
	m·‰”n
;

25 
P¬amDiù
 *
	mdiù
;

26 } 
	md©a
;

27 } 
	tP¬am
;

29 
P¬am
 *
P¬am_ü—‹
(
b¡ršg
 
Çme
, 
P¬amTy³
 
ty³
, *
v®
);

30 
P¬am
 *
P¬am_·r£
(
b¡ršg
 
Çme
, **
pP
, **
pPe
);

31 
P¬am
 *
P¬am_cİy
(P¬am *
p
);

32 
P¬am_de¡roy
(
P¬am
 *
p
);

34 
P¬amDiù
 *
P¬amDiù_ü—‹
();

35 
P¬amDiù
 *
P¬amDiù_cİy
();

36 
P¬amDiù_de¡roy
(
P¬amDiù
 *
pd
);

37 
P¬amDiù_£t
(
P¬amDiù
 *
pd
, 
P¬am
 *
p
);

38 
P¬am
 *
P¬amDiù_g‘
(
P¬amDiù
 *
pd
, 
b¡ršg
 
Çme
);

40 
	#P¬amDiù_fÜ—ch
(
pd
, 
p
, 
d
) \

41 
d
 = 
	`diù_fœ¡
(
pd
->
diù
), 
p
 = (d =ğ
NULL
è? NULL : 
	`dnode_g‘
(d); \

42 
d
 !ğ
NULL
; \

43 
d
 = 
	`diù_Ãxt
(
pd
->
diù
, d), 
p
 = (d =ğ
NULL
è? NULL : 
	`dnode_g‘
(d))

	)

	@tools/examples/procer/procer.c

1 
	~<unixy.h
>

2 
	~<dbg.h
>

3 
	~"´oûr.h
"

4 
	~<glob.h
>

5 
	~<adt/t¡.h
>

6 
	~<sigÇl.h
>

7 
	~<¡dlib.h
>

8 
	~<uni¡d.h
>

9 
	~<sys/wa™.h
>

10 
	~<sys/¡©.h
>

12 **
’vœÚ
;

14 
šlše
 
	$h¬d¦“p
(
£c
)

16 
	`sky›ld
();

17 
	`¦“p
(
£c
);

18 
	}
}

21 
šlše
 
	$»dœeù_ouut
(cÚ¡ *
run_log
)

23 
	`äeİ’
(
run_log
, "a+", 
¡dout
);

24 
	`£tbuf
(
¡dout
, 
NULL
);

25 
	`äeİ’
(
run_log
, "a+", 
¡d”r
);

26 
	`£tbuf
(
¡dout
, 
NULL
);

27 
	`äeİ’
("/dev/nuÎ", "r", 
¡dš
);

28 
	}
}

31 
	$AùiÚ_exec
(
AùiÚ
 *
aùiÚ
, 
Profe
 *
´of
)

33 
rc
 = 0;

35 
	`debug
("ACTION: command=%s,…id_file=%s,„estart=%d, depends=%s",

36 
	`bd©a
(
´of
->
commªd
), bd©aÕrof->
pid_fe
),…rof->
»¡¬t
,

37 
	`bd©a
(
aùiÚ
->
d•’ds
));

39 
pid_t
 
pid
 = 
	`fÜk
();

40 
	`check
(
pid
 >= 0, "Fork failed, WTF. How can fork fail?");

42 if(
pid
 == 0) {

43 
rc
 = 
	`Unixy_drİ_´iv
(
aùiÚ
->
´ofe_dœ
);

45 if(
rc
 != 0) {

46 
	`log_”r
("Not fatal, but we couldn't drop…riv for %s",

47 
	`bd©a
(
aùiÚ
->
Çme
));

50 
	`»dœeù_ouut
("run.log");

52 
rc
 = 
	`exeşe
(
	`bd©a
(
´of
->
commªd
), bd©aÕrof->commªd), 
NULL
, 
’vœÚ
);

53 
	`check
(
rc
 !ğ-1, "FaedØexeøcommªd: %s", 
	`bd©a
(
´of
->
commªd
));

55 
¡©us
 = 0;

56 
	`debug
("WAITING FOR CHILD.");

57 
pid
 = 
	`wa™pid
Õid, &
¡©us
, 0);

60 
	`debug
("Command„an‡ndƒxited successfully,‚ow†ooking forhe PID file.");

62 
”rÜ
:

64 
	}
}

67 
	$AùiÚ_sk
(*
v
)

69 
AùiÚ
 *
aùiÚ
 = (AùiÚ *)
v
;

70 
rc
 = 0;

71 
pid_t
 
chd
 = 0;

72 
Profe
 *
´of
 = 
	`Profe_lßd
(
aùiÚ
->
´ofe_dœ
);

74 
	`skÇme
(
	`bd©a
(
aùiÚ
->
Çme
));

76 
	`sk¡©e
("depends");

77 
rc
 = 
	`Ram·¹_wa™
(
aùiÚ
->
befÜe
);

78 
	`check
(
rc
 != -1, "A dependency failedo start, we can't start.");

80 
	`Ram·¹_ruÂšg
(&
aùiÚ
->
aá”
);

82 
	`sk¡©e
("ready");

83 
	`debug
("STARTED %s", 
	`bd©a
(
aùiÚ
->
Çme
));

86 
	`sk¡©e
("starting");

88 if(
	`Unixy_¡l_ruÂšg
(
´of
->
pid_fe
, &
chd
)) {

89 
	`debug
("Look lik% i ®»ady„uÂšg, we'Î ju¡†—v™‡lÚe.", 
	`bd©a
(
aùiÚ
->
Çme
));

91 
	`Unixy_»move_d—d_pidfe
(
´of
->
pid_fe
);

92 
	`AùiÚ_exec
(
aùiÚ
, 
´of
);

95 
	`check
(
	`acûss
(
	`bd©a
(
´of
->
pid_fe
), 
R_OK
) == 0, "%s didn't make…idfile %s.",

96 
	`bd©a
(
aùiÚ
->
Çme
), bd©a(
´of
->
pid_fe
));

98 
	`sk¡©e
("waiting");

99 
	`Unixy_¡l_ruÂšg
(
´of
->
pid_fe
, &
chd
)) {

100 
	`h¬d¦“p
(1);

103 if(!
´of
->
»¡¬t
) {

107 
	`sk¡©e
("restarting");

108 
	`h¬d¦“p
(1);

111 
	`debug
("ACTION % ex™ed.", 
	`bd©a
(
aùiÚ
->
Çme
));

113 
”rÜ
:

114 
	`Ram·¹_çed
(&
aùiÚ
->
aá”
);

116 
	}
}

119 
AùiÚ
 *
	$AùiÚ_ü—‹
(cÚ¡ *
´ofe
)

121 
AùiÚ
 *
aùiÚ
 = 
	`ÿÎoc
((Action), 1);

122 
	`check_mem
(
aùiÚ
);

124 
aùiÚ
->
´ofe_dœ
 = 
	`bäomc¡r
(
´ofe
);

125 
aùiÚ
->
Çme
 = 
	`bTa
×ùiÚ->
´ofe_dœ
,

126 
	`bËngth
(
aùiÚ
->
´ofe_dœ
) -

127 
	`b¡¼chr
(
aùiÚ
->
´ofe_dœ
, '/') - 1);

129 
aùiÚ
->
d•’ds
 = 
	`Profe_»ad_£‰šg
×ùiÚ->
´ofe_dœ
, "depends");

131  
aùiÚ
;

133 
”rÜ
:

134  
NULL
;

135 
	}
}

138 
	$AùiÚ_d•’ds
(
AùiÚ
 *
this_Úe
, AùiÚ *
Ãeds
)

140 
	`check
(
this_Úe
->
wa™šg_couÁ
 < 
MAX_DEPENDS
,

142 
	`bd©a
(
this_Úe
->
Çme
), 
MAX_DEPENDS
);

144 
this_Úe
->
befÜe
[this_Úe->
wa™šg_couÁ
] = &
Ãeds
->
aá”
;

145 
this_Úe
->
wa™šg_couÁ
++;

148 
”rÜ
:

150 
	}
}

153 
	$AùiÚ_¡¬t
(
AùiÚ
 *
aùiÚ
)

155 
	`skü—‹
(
AùiÚ_sk
, 
aùiÚ
, 32 * 1024);

156 
	}
}

158 
	$AùiÚ_d•’d’cy_assign
(*
v®ue
, *
d©a
)

160 
AùiÚ
 *
aùiÚ
 = (AùiÚ *)
v®ue
;

161 
AùiÚ
 *
rg‘
 = 
NULL
;

162 
t¡_t
 *
rg‘s
 = (t¡_ˆ*)
d©a
;

163 
i
 = 0;

165 if(!
aùiÚ
->
d•’ds
) ;

167 
	`debug
("Proûs£d % aùiÚ d•’dšg on: %s", 
	`bd©a
(
aùiÚ
->
Çme
), bd©a×ùiÚ->
d•’ds
));

169 if(
aùiÚ
->
d•’ds
) {

170 
b¡rLi¡
 *
d•_li¡
 = 
	`b¥l™
(
aùiÚ
->
d•’ds
, ' ');

172 
i
 = 0; i < 
d•_li¡
->
qty
; i++) {

173 
b¡ršg
 
d•
 = 
d•_li¡
->
’Œy
[
i
];

175 
rg‘
 = (
AùiÚ
 *)
	`t¡_£¬ch
(
rg‘s
, 
	`bd©a
(
d•
), 
	`bËngth
(dep));

177 if(
rg‘
) {

178 
	`AùiÚ_d•’ds
(
aùiÚ
, 
rg‘
);

180 
	`log_”r
("Could‚ot find dependency %s has on %s.",

181 
	`bd©a
(
aùiÚ
->
Çme
), bd©a(
d•
));

185 
	`b¡rLi¡De¡roy
(
d•_li¡
);

187 
	}
}

189 
	$AùiÚ_¡¬t_®l
(*
v®ue
, *
d©a
)

191 
AùiÚ
 *
aùiÚ
 = (AùiÚ *)
v®ue
;

192 
	`AùiÚ_¡¬t
(
aùiÚ
);

193 
	}
}

196 
	$skmaš
(
¬gc
, *
¬gv
[])

198 
	`dbg_£t_log
(
¡d”r
);

199 
glob_t
 
´ofe_glob
;

200 
rc
 = 0;

201 
i
 = 0;

202 
AùiÚ
 *
aùiÚ
 = 
NULL
;

203 
t¡_t
 *
rg‘s
 = 
NULL
;

204 
b¡ršg
 
pid_fe
 = 
NULL
;

206 
	`check
(
¬gc
 == 3, "USAGE:…rocer <profile_dir> <procer_pid_file>");

207 
pid_fe
 = 
	`bäomc¡r
(
¬gv
[2]);

209 
rc
 = 
	`Unixy_»move_d—d_pidfe
(
pid_fe
);

210 
	`check
(
rc
 =ğ0, "FaedØ»mov%s,…roû¸i ´obably‡Ì—dy„uÂšg.", 
	`bd©a
(
pid_fe
));

212 
rc
 = 
	`Unixy_d«mÚize
();

213 
	`check
(
rc
 == 0, "Couldn't daemonize,hat's‚ot good.");

215 
rc
 = 
	`chdœ
(
¬gv
[1]);

216 
	`check
(
rc
 =ğ0, "Couldn'ˆchªgtØ% ´ofdœ.", 
¬gv
[1]);

218 
rc
 = 
	`Unixy_pid_fe
(
pid_fe
);

219 
	`check
(
rc
 =ğ0, "FaedØmakthPID fe: %s", 
	`bd©a
(
pid_fe
));

221 
FILE
 *
log
 = 
	`fİ’
("error.log", "a+");

222 
	`check
(
log
, "Couldn't openƒrror.log");

223 
	`£tbuf
(
log
, 
NULL
);

224 
	`dbg_£t_log
(
log
);

226 
b¡ršg
 
dœ_glob
 = 
	`bfÜm©
("%s/[A-Za-z0-9]*", 
¬gv
[1]);

227 
	`check
(
dœ_glob
, "Couldn't makehe directory glob.");

229 
rc
 = 
	`glob
(
	`bd©a
(
dœ_glob
), 
GLOB_ERR
, 
NULL
, &
´ofe_glob
);

230 
	`check
(
rc
 == 0, "Failedo find directories inhe…rofiles.");

232 
¡©
 
sb
;

233 
	`debug
("Lßdšg %zu‡ùiÚs.", 
´ofe_glob
.
gl_·thc
);

234 
i
 = 0; i < 
´ofe_glob
.
gl_·thc
; i++) {

235 
rc
 = 
	`l¡©
(
´ofe_glob
.
gl_·thv
[
i
], &
sb
);

236 
	`check
(
rc
 =ğ0, "FaedØ¡© fÜ dœeùÜy: %s", 
´ofe_glob
.
gl_·thv
[
i
]);

238 ià(
sb
.
¡_mode
 & 
S_IFDIR
) {

239 
aùiÚ
 = 
	`AùiÚ_ü—‹
(
´ofe_glob
.
gl_·thv
[
i
]);

240 
rg‘s
 = 
	`t¡_š£¹
Ñ¬g‘s, 
	`bd©a
(
aùiÚ
->
Çme
), 
	`bËngth
(action->name),‡ction);

245 
	`t¡_Œav”£
(
rg‘s
, 
AùiÚ_d•’d’cy_assign
,argets);

246 
	`t¡_Œav”£
(
rg‘s
, 
AùiÚ_¡¬t_®l
, 
NULL
);

248 
	`skex™
(0);

250 
”rÜ
:

251 
	`skex™®l
(1);

252 
	}
}

	@tools/examples/procer/procer.h

1 #iâdeà
_´oûr_h


2 
	#_´oûr_h


	)

4 
	~<b¡ršg.h
>

5 
	~<sk/sk.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

10 
	mMAX_DEPENDS
 = 128

13 
	sRam·¹
 {

14 
R’dez
 
	mwa™
;

15 
	mruÂšg
;

16 
	mçed
;

17 } 
	tRam·¹
;

20 
	sProfe
 {

22 
b¡ršg
 
	mcommªd
;

24 
b¡ršg
 
	mpid_fe
;

26 
	m»¡¬t
;

27 } 
	tProfe
;

31 
	sAùiÚ
 {

33 
b¡ršg
 
	mÇme
;

35 
b¡ršg
 
	m´ofe_dœ
;

37 
b¡ršg
 
	md•’ds
;

40 
Ram·¹
 
	maá”
;

42 
	mwa™šg_couÁ
;

45 
Ram·¹
 *
	mbefÜe
[
MAX_DEPENDS
];

46 } 
	tAùiÚ
;

49 
	#Ram·¹_should_wa™
(
R
è!((R)->
ruÂšg
 || (R)->
çed
)

	)

51 
Ram·¹_wa™
(
Ram·¹
 *
Ú
[]);

53 
Ram·¹_ruÂšg
(
Ram·¹
 *
Ú
);

55 
Ram·¹_nÙruÂšg
(
Ram·¹
 *
Ú
);

57 
Ram·¹_çed
(
Ram·¹
 *
Ú
);

59 
b¡ršg
 
Profe_»ad_£‰šg
(b¡ršg 
·th
, cÚ¡ *
fe
);

61 
Profe_check_£‰šg
(
b¡ršg
 
·th
, cÚ¡ *
fe
);

63 
Profe
 *
Profe_lßd
(
b¡ršg
 
´ofe_dœ
);

	@tools/examples/procer/profile.c

1 
	~"´oûr.h
"

2 
	~<dbg.h
>

4 
b¡ršg
 
	$Profe_»ad_£‰šg
(
b¡ršg
 
·th
, cÚ¡ *
fe
)

6 
b¡ršg
 
rg‘
 = 
	`bfÜm©
("%s/%s", 
	`bd©a
(
·th
), 
fe
);

7 
b¡ršg
 
d©a
 = 
NULL
;

8 
FILE
 *
‹¡_fe
 = 
NULL
;

10 
‹¡_fe
 = 
	`fİ’
(
	`bd©a
(
rg‘
), "r");

11 
	`check
(
‹¡_fe
, "Failedo open %s filehat's„equired.",

12 
	`bd©a
(
rg‘
));

14 
d©a
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
‹¡_fe
, '\n');

15 if(
d©a
è
	`bŒimws
(data);

18 
”rÜ
:

20 if(
‹¡_fe
è
	`fşo£
(test_file);

21 
	`bde¡roy
(
rg‘
);

22  
d©a
;

23 
	}
};

26 
	$Profe_check_£‰šg
(
b¡ršg
 
·th
, cÚ¡ *
fe
)

28 
b¡ršg
 
rg‘
 = 
	`bfÜm©
("%s/%s", 
	`bd©a
(
·th
), 
fe
);

29 
rc
 = 
	`acûss
(
	`bd©a
(
rg‘
), 
R_OK
);

30 
	`bde¡roy
(
rg‘
);

32  
rc
 == 0;

33 
	}
}

36 
Profe
 *
	$Profe_lßd
(
b¡ršg
 
´ofe_dœ
)

38 
Profe
 *
´of
 = 
	`ÿÎoc
((Profile), 1);

39 
	`check_mem
(
´of
);

41 
´of
->
commªd
 = 
	`bfÜm©
("%s/run", 
	`bd©a
(
´ofe_dœ
));

42 
´of
->
pid_fe
 = 
	`Profe_»ad_£‰šg
(
´ofe_dœ
, "pid_file");

43 
´of
->
»¡¬t
 = 
	`Profe_check_£‰šg
(
´ofe_dœ
, "restart");

45  
´of
;

47 
”rÜ
:

48  
NULL
;

49 
	}
}

	@tools/examples/procer/rampart.c

1 
	~"´oûr.h
"

4 
	$Ram·¹_wa™
(
Ram·¹
 *
Ú
[])

6 
i
 = 0;

8 
i
 = 0; 
Ú
[i] !ğ
NULL
; i++) {

9 if(
	`Ram·¹_should_wa™
(
Ú
[
i
])) {

10 
	`sk¦“p
(&(
Ú
[
i
]->
wa™
));

15 
	}
}

17 
	$Ram·¹_ruÂšg
(
Ram·¹
 *
Ú
)

19 
Ú
->
ruÂšg
 = 1;

20 
Ú
->
çed
 = 0;

21 
	`skwakeu·Î
(&
Ú
->
wa™
);

22 
	}
}

24 
	$Ram·¹_nÙruÂšg
(
Ram·¹
 *
Ú
)

26 
Ú
->
ruÂšg
 = 0;

27 
	}
}

29 
	$Ram·¹_çed
(
Ram·¹
 *
Ú
)

31 
Ú
->
ruÂšg
 = 0;

32 
Ú
->
çed
 = 1;

33 
	`skwakeu·Î
(&
Ú
->
wa™
);

34 
	}
}

	@tools/filters/null.c

35 
	~<f‹r.h
>

36 
	~<dbg.h
>

38 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

40  
CLOSE
;

41 
	}
}

44 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

46 
S‹Ev’t
 
¡©es
[] = {
HANDLER
};

47 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

48 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

50  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

52 
”rÜ
:

53  
NULL
;

54 
	}
}

	@tools/lemon/lemon.c

9 
	~<¡dio.h
>

10 
	~<¡d¬g.h
>

11 
	~<¡ršg.h
>

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<as£¹.h
>

16 #iâdeà
__WIN32__


17 #ià
defšed
(
_WIN32
è|| defšed(
WIN32
)

18 
	#__WIN32__


	)

22 #ifdeà
__WIN32__


23 
acûss
();

25 
	~<uni¡d.h
>

29 
	#PRIVATE


	)

31 #ifdeà
TEST


32 
	#MAXRHS
 5

	)

34 
	#MAXRHS
 1000

	)

37 *
msÜt
(*,**,(*)(const *,const *));

44 
	#ËmÚSŒËn
(
X
è(()
	`¡¾’
(X))

	)

46 
aùiÚ
 *
	`AùiÚ_Ãw
();

47 
aùiÚ
 *
	`AùiÚ_sÜt
(action *);

50 
	`FšdRuËP»ûd’ûs
();

51 
	`FšdFœ¡S‘s
();

52 
	`FšdS‹s
();

53 
	`FšdLšks
();

54 
	`FšdFŞlowS‘s
();

55 
	`FšdAùiÚs
();

58 
	`CÚfigli¡_š™
( );

59 
cÚfig
 *
	`CÚfigli¡_add
( );

60 
cÚfig
 *
	`CÚfigli¡_addbasis
( );

61 
	`CÚfigli¡_şosu»
( );

62 
	`CÚfigli¡_sÜt
( );

63 
	`CÚfigli¡_sÜtbasis
( );

64 
cÚfig
 *
	`CÚfigli¡_»tuº
( );

65 
cÚfig
 *
	`CÚfigli¡_basis
( );

66 
	`CÚfigli¡_—t
( );

67 
	`CÚfigli¡_»£t
( );

70 
	`E¼ÜMsg
(const *, ,const *, ...);

73 
	ss_İtiÚs
 {

74 ’um { 
OPT_FLAG
=1, 
OPT_INT
, 
OPT_DBL
, 
OPT_STR
,

75 
OPT_FFLAG
, 
OPT_FINT
, 
OPT_FDBL
, 
OPT_FSTR
} 
ty³
;

76 *
Ïb–
;

77 *
¬g
;

78 *
mes§ge
;

80 
	`O±In™
( );

81 
	`O±NArgs
( );

82 *
	`O±Arg
( );

83 
	`O±E¼
( );

84 
	`O±Pršt
( );

87 
	`P¬£
( );

90 
¶šk
 *
	`Plšk_Ãw
( );

91 
	`Plšk_add
( );

92 
	`Plšk_cİy
( );

93 
	`Plšk_d–‘e
( );

96 
	`R•ršt
( );

97 
	`R•ÜtOuut
( );

98 
	`R•ÜtTabË
( );

99 
	`R•ÜtH—d”
( );

100 
	`Com´essTabËs
( );

101 
	`ResÜtS‹s
( );

104 
	`S‘Size
( );

105 *
	`S‘New
( );

106 
	`S‘F»e
( );

108 
	`S‘Add
( );

109 
	`S‘UniÚ
( );

111 
	#S‘Fšd
(
X
,
Y
è(X[Y]è

	)

118 ’um {
LEMON_FALSE
=0, 
LEMON_TRUE
} 
	tBoŞ—n
;

122 
	ssymbŞ
 {

123 *
Çme
;

124 
šdex
;

126 
TERMINAL
,

127 
NONTERMINAL
,

128 
MULTITERMINAL


129 } 
ty³
;

130 
ruË
 *rule;

131 
symbŞ
 *
çÎback
;

132 
´ec
;

133 
	ee_assoc
 {

134 
LEFT
,

135 
RIGHT
,

136 
NONE
,

137 
UNK


138 } 
assoc
;

139 *
fœ¡£t
;

140 
BoŞ—n
 
Ïmbda
;

141 
u£CÁ
;

142 *
de¡ruùÜ
;

144 
de¡Lš’o
;

145 *
d©©y³
;

147 
dŠum
;

151 
nsubsym
;

152 
symbŞ
 **
subsym
;

157 
	sruË
 {

158 
symbŞ
 *
lhs
;

159 *
lh§lŸs
;

160 
lhsS¹
;

161 
ruËlše
;

162 
Ähs
;

163 
symbŞ
 **
rhs
;

164 **
rh§lŸs
;

165 
lše
;

166 *
code
;

167 
symbŞ
 *
´ecsym
;

168 
šdex
;

169 
BoŞ—n
 
ÿnReduû
;

170 
ruË
 *
Ãxhs
;

171 
ruË
 *
Ãxt
;

179 
	scÚfig
 {

180 
ruË
 *
½
;

181 
dÙ
;

182 *
fws
;

183 
¶šk
 *
åÍ
;

184 
¶šk
 *
b¶p
;

185 
¡©e
 *
¡p
;

187 
COMPLETE
,

188 
INCOMPLETE


189 } 
¡©us
;

190 
cÚfig
 *
Ãxt
;

191 
cÚfig
 *
bp
;

195 
	saùiÚ
 {

196 
symbŞ
 *
¥
;

197 
	ee_aùiÚ
 {

198 
SHIFT
,

199 
ACCEPT
,

200 
REDUCE
,

201 
ERROR
,

202 
SSCONFLICT
,

203 
SRCONFLICT
,

204 
RRCONFLICT
,

205 
SH_RESOLVED
,

206 
RD_RESOLVED
,

207 
NOT_USED


208 } 
ty³
;

210 
¡©e
 *
¡p
;

211 
ruË
 *
½
;

212 } 
x
;

213 
aùiÚ
 *
Ãxt
;

214 
aùiÚ
 *
cŞlide
;

219 
	s¡©e
 {

220 
cÚfig
 *
bp
;

221 
cÚfig
 *
cå
;

222 
¡©’um
;

223 
aùiÚ
 *
­
;

224 
nTknAù
, 
nNtAù
;

225 
iTknOf¡
, 
iNtOf¡
;

226 
iDæt
;

228 
	#NO_OFFSET
 (-2147483647)

	)

233 
	s¶šk
 {

234 
cÚfig
 *
cå
;

235 
¶šk
 *
Ãxt
;

242 
	sËmÚ
 {

243 
¡©e
 **
sÜ‹d
;

244 
ruË
 *rule;

245 
n¡©e
;

246 
ÄuË
;

247 
nsymbŞ
;

248 
Á”mš®
;

249 
symbŞ
 **
symbŞs
;

250 
”rÜút
;

251 
symbŞ
 *
”rsym
;

252 
symbŞ
 *
wdÿrd
;

253 *
Çme
;

254 *
¬g
;

255 *
tok’ty³
;

256 *
v¬ty³
;

257 *
¡¬t
;

258 *
¡acksize
;

259 *
šşude
;

260 *
”rÜ
;

261 *
ov”æow
;

262 *
çu»
;

263 *
acû±
;

264 *
exŒacode
;

265 *
tok’de¡
;

266 *
v¬de¡
;

267 *
f’ame
;

268 *
ouŠame
;

269 *
tok’´efix
;

270 
ncÚæiù
;

271 
bËsize
;

272 
basisæag
;

273 
has_çÎback
;

274 
nŞš’osæag
;

275 *
¬gv0
;

278 
	#MemÜyCheck
(
X
) if((X)==0){ \

279 
	`memÜy_”rÜ
(); \

280 
	`memÜy_”rÜ
(); \

281 
	}

	)
}

298 *
SŒ§ã
();

300 
SŒ§ã_š™
( );

301 
SŒ§ã_š£¹
( );

302 *
SŒ§ã_fšd
( );

306 
symbŞ
 *
SymbŞ_Ãw
();

307 
SymbŞcmµ
( );

308 
SymbŞ_š™
( );

309 
SymbŞ_š£¹
( );

310 
symbŞ
 *
SymbŞ_fšd
( );

311 
symbŞ
 *
SymbŞ_Nth
( );

312 
SymbŞ_couÁ
( );

313 
symbŞ
 **
SymbŞ_¬¿yof
( );

317 
CÚfigcmp
( );

318 
¡©e
 *
S‹_Ãw
();

319 
S‹_š™
( );

320 
S‹_š£¹
( );

321 
¡©e
 *
S‹_fšd
( );

322 
¡©e
 **
S‹_¬¿yof
( );

326 
CÚfigbË_š™
( );

327 
CÚfigbË_š£¹
( );

328 
cÚfig
 *
CÚfigbË_fšd
( );

329 
CÚfigbË_ş—r
( );

336 
aùiÚ
 *
	$AùiÚ_Ãw
(){

337 
aùiÚ
 *
ä“li¡
 = 0;

338 
aùiÚ
 *
Ãw
;

340 ifĞ
ä“li¡
==0 ){

341 
i
;

342 
amt
 = 100;

343 
ä“li¡
 = (
aùiÚ
 *)
	`ÿÎoc
(
amt
, (action));

344 ifĞ
ä“li¡
==0 ){

345 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew…arser‡ction.");

346 
	`ex™
(1);

348 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

349 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

351 
Ãw
 = 
ä“li¡
;

352 
ä“li¡
 = f»–i¡->
Ãxt
;

353  
Ãw
;

354 
	}
}

360 
	$aùiÚcmp
(

361 
aùiÚ
 *
­1
,

362 
aùiÚ
 *
­2


364 
rc
;

365 
rc
 = 
­1
->
¥
->
šdex
 - 
­2
->sp->index;

366 ifĞ
rc
==0 ){

367 
rc
 = ()
­1
->
ty³
 - ()
­2
->type;

369 ifĞ
rc
==0 && 
­1
->
ty³
==
REDUCE
 ){

370 
rc
 = 
­1
->
x
.
½
->
šdex
 - 
­2
->x.rp->index;

372  
rc
;

373 
	}
}

376 
aùiÚ
 *
	$AùiÚ_sÜt
(

377 
aùiÚ
 *
­


379 
­
 = (
aùiÚ
 *)
	`msÜt
((*ïp,(**)&­->
Ãxt
,

380 ((*)(cÚ¡ *,cÚ¡ *))
aùiÚcmp
);

381  
­
;

382 
	}
}

384 
	$AùiÚ_add
(
­p
,
ty³
,
¥
,
¬g
)

385 
aùiÚ
 **
­p
;

386 
e_aùiÚ
 
ty³
;

387 
symbŞ
 *
¥
;

388 *
¬g
;

390 
aùiÚ
 *
Ãw
;

391 
Ãw
 = 
	`AùiÚ_Ãw
();

392 
Ãw
->
Ãxt
 = *
­p
;

393 *
­p
 = 
Ãw
;

394 
Ãw
->
ty³
 =ype;

395 
Ãw
->
¥
 = sp;

396 ifĞ
ty³
==
SHIFT
 ){

397 
Ãw
->
x
.
¡p
 = (
¡©e
 *)
¬g
;

399 
Ãw
->
x
.
½
 = (
ruË
 *)
¬g
;

401 
	}
}

411 
aùb
 
	taùb
;

412 
	saùb
 {

413 
	mnAùiÚ
;

414 
	mnAùiÚAÎoc
;

416 
	mlookah—d
;

417 
	maùiÚ
;

418 } *
	maAùiÚ
,

419 *
	maLookah—d
;

420 
	mmnLookah—d
;

421 
	mmnAùiÚ
;

422 
	mmxLookah—d
;

423 
	mnLookah—d
;

424 
	mnLookah—dAÎoc
;

428 
	#aùb_size
(
X
è((X)->
nAùiÚ
)

	)

431 
	#aùb_yyaùiÚ
(
X
,
N
è((X)->
aAùiÚ
[N].
aùiÚ
)

	)

434 
	#aùb_yylookah—d
(
X
,
N
è((X)->
aAùiÚ
[N].
lookah—d
)

	)

437 
	$aùb_ä“
(
aùb
 *
p
){

438 
	`ä“
Ğ
p
->
aAùiÚ
 );

439 
	`ä“
Ğ
p
->
aLookah—d
 );

440 
	`ä“
Ğ
p
 );

441 
	}
}

444 
aùb
 *
	$aùb_®loc
(){

445 
aùb
 *
p
 = 
	`ÿÎoc
( 1, (*p) );

446 ifĞ
p
==0 ){

447 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew‡cttab.");

448 
	`ex™
(1);

450 
	`mem£t
(
p
, 0, (*p));

451  
p
;

452 
	}
}

456 
	$aùb_aùiÚ
(
aùb
 *
p
, 
lookah—d
, 
aùiÚ
){

457 ifĞ
p
->
nLookah—d
>õ->
nLookah—dAÎoc
 ){

458 
p
->
nLookah—dAÎoc
 += 25;

459 
p
->
aLookah—d
 = 
	`»®loc
(…->aLookahead,

460 (
p
->
aLookah—d
[0])*p->
nLookah—dAÎoc
 );

461 ifĞ
p
->
aLookah—d
==0 ){

462 
	`årštf
(
¡d”r
,"malloc failed\n");

463 
	`ex™
(1);

466 ifĞ
p
->
nLookah—d
==0 ){

467 
p
->
mxLookah—d
 = 
lookah—d
;

468 
p
->
mnLookah—d
 = 
lookah—d
;

469 
p
->
mnAùiÚ
 = 
aùiÚ
;

471 ifĞ
p
->
mxLookah—d
<
lookah—d
 )…->mxLookahead =†ookahead;

472 ifĞ
p
->
mnLookah—d
>
lookah—d
 ){

473 
p
->
mnLookah—d
 = 
lookah—d
;

474 
p
->
mnAùiÚ
 = 
aùiÚ
;

477 
p
->
aLookah—d
[p->
nLookah—d
].
lookah—d
 =†ookahead;

478 
p
->
aLookah—d
[p->
nLookah—d
].
aùiÚ
 =‡ction;

479 
p
->
nLookah—d
++;

480 
	}
}

489 
	$aùb_š£¹
(
aùb
 *
p
){

490 
i
, 
j
, 
k
, 
n
;

491 
	`as£¹
Ğ
p
->
nLookah—d
>0 );

497 
n
 = 
p
->
mxLookah—d
 + 1;

498 ifĞ
p
->
nAùiÚ
 + 
n
 >ğp->
nAùiÚAÎoc
 ){

499 
ŞdAÎoc
 = 
p
->
nAùiÚAÎoc
;

500 
p
->
nAùiÚAÎoc
 =…->
nAùiÚ
 + 
n
 +…->nActionAlloc + 20;

501 
p
->
aAùiÚ
 = 
	`»®loc
(…->aAction,

502 (
p
->
aAùiÚ
[0])*p->
nAùiÚAÎoc
);

503 ifĞ
p
->
aAùiÚ
==0 ){

504 
	`årštf
(
¡d”r
,"malloc failed\n");

505 
	`ex™
(1);

507 
i
=
ŞdAÎoc
; i<
p
->
nAùiÚAÎoc
; i++){

508 
p
->
aAùiÚ
[
i
].
lookah—d
 = -1;

509 
p
->
aAùiÚ
[
i
].
aùiÚ
 = -1;

520 
i
=0; i<
p
->
nAùiÚ
+p->
mnLookah—d
; i++){

521 ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
<0 ){

522 
j
=0; j<
p
->
nLookah—d
; j++){

523 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

524 ifĞ
k
<0 ) ;

525 ifĞ
p
->
aAùiÚ
[
k
].
lookah—d
>=0 ) ;

527 ifĞ
j
<
p
->
nLookah—d
 ) ;

528 
j
=0; j<
p
->
nAùiÚ
; j++){

529 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) ;

531 ifĞ
j
==
p
->
nAùiÚ
 ){

534 }ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
=õ->
mnLookah—d
 ){

535 ifĞ
p
->
aAùiÚ
[
i
].
aùiÚ
!õ->
mnAùiÚ
 ) ;

536 
j
=0; j<
p
->
nLookah—d
; j++){

537 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

538 ifĞ
k
<0 || k>=
p
->
nAùiÚ
 ) ;

539 ifĞ
p
->
aLookah—d
[
j
].
lookah—d
!õ->
aAùiÚ
[
k
].lookahead ) ;

540 ifĞ
p
->
aLookah—d
[
j
].
aùiÚ
!õ->
aAùiÚ
[
k
].action ) ;

542 ifĞ
j
<
p
->
nLookah—d
 ) ;

543 
n
 = 0;

544 
j
=0; j<
p
->
nAùiÚ
; j++){

545 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
<0 ) ;

546 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) 
n
++;

548 ifĞ
n
==
p
->
nLookah—d
 ){

554 
j
=0; j<
p
->
nLookah—d
; j++){

555 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

556 
p
->
aAùiÚ
[
k
] =…->
aLookah—d
[
j
];

557 ifĞ
k
>=
p
->
nAùiÚ
 )…->nAction = k+1;

559 
p
->
nLookah—d
 = 0;

563  
i
 - 
p
->
mnLookah—d
;

564 
	}
}

581 
	$FšdRuËP»ûd’ûs
(
xp
)

582 
ËmÚ
 *
xp
;

584 
ruË
 *
½
;

585 
½
=
xp
->
ruË
;„p;„pôp->
Ãxt
){

586 ifĞ
½
->
´ecsym
==0 ){

587 
i
, 
j
;

588 
i
=0; i<
½
->
Ähs
 &&„p->
´ecsym
==0; i++){

589 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

590 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

591 
j
=0; j<
¥
->
nsubsym
; j++){

592 ifĞ
¥
->
subsym
[
j
]->
´ec
>=0 ){

593 
½
->
´ecsym
 = 
¥
->
subsym
[
j
];

597 }ifĞ
¥
->
´ec
>=0 ){

598 
½
->
´ecsym
 =„p->
rhs
[
i
];

604 
	}
}

611 
	$FšdFœ¡S‘s
(
Ëmp
)

612 
ËmÚ
 *
Ëmp
;

614 
i
, 
j
;

615 
ruË
 *
½
;

616 
´og»ss
;

618 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

619 
Ëmp
->
symbŞs
[
i
]->
Ïmbda
 = 
LEMON_FALSE
;

621 
i
=
Ëmp
->
Á”mš®
; i<Ëmp->
nsymbŞ
; i++){

622 
Ëmp
->
symbŞs
[
i
]->
fœ¡£t
 = 
	`S‘New
();

627 
´og»ss
 = 0;

628 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

629 ifĞ
½
->
lhs
->
Ïmbda
 ) ;

630 
i
=0; i<
½
->
Ähs
; i++){

631 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

632 ifĞ
¥
->
ty³
!=
TERMINAL
 || sp->
Ïmbda
==
LEMON_FALSE
 ) ;

634 ifĞ
i
==
½
->
Ähs
 ){

635 
½
->
lhs
->
Ïmbda
 = 
LEMON_TRUE
;

636 
´og»ss
 = 1;

639 } 
´og»ss
 );

643 
symbŞ
 *
s1
, *
s2
;

644 
´og»ss
 = 0;

645 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

646 
s1
 = 
½
->
lhs
;

647 
i
=0; i<
½
->
Ähs
; i++){

648 
s2
 = 
½
->
rhs
[
i
];

649 ifĞ
s2
->
ty³
==
TERMINAL
 ){

650 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
šdex
);

652 }ifĞ
s2
->
ty³
==
MULTITERMINAL
 ){

653 
j
=0; j<
s2
->
nsubsym
; j++){

654 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
subsym
[
j
]->
šdex
);

657 }ifĞ
s1
==
s2
 ){

658 ifĞ
s1
->
Ïmbda
==
LEMON_FALSE
 ) ;

660 
´og»ss
 +ğ
	`S‘UniÚ
(
s1
->
fœ¡£t
,
s2
->firstset);

661 ifĞ
s2
->
Ïmbda
==
LEMON_FALSE
 ) ;

665 } 
´og»ss
 );

667 
	}
}

673 
PRIVATE
 
¡©e
 *
g‘¡©e
( );

674 
	$FšdS‹s
(
Ëmp
)

675 
ËmÚ
 *
Ëmp
;

677 
symbŞ
 *
¥
;

678 
ruË
 *
½
;

680 
	`CÚfigli¡_š™
();

683 ifĞ
Ëmp
->
¡¬t
 ){

684 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

685 ifĞ
¥
==0 ){

686 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

687 "Th¥ecif›d s¹ symbŞ \"%s\" i nÙ \
‡‚Ú‹rmš® oàthg¿mm¬. \"%s\" wÈbu£d‡ th¡¬ˆ\
 in¡—d.",
Ëmp
->
¡¬t
,Ëmp->
ruË
->
lhs
->
Çme
);

690 
Ëmp
->
”rÜút
++;

691 
¥
 = 
Ëmp
->
ruË
->
lhs
;

694 
¥
 = 
Ëmp
->
ruË
->
lhs
;

700 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

701 
i
;

702 
i
=0; i<
½
->
Ähs
; i++){

703 ifĞ
½
->
rhs
[
i
]==
¥
 ){

704 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

705 "Th¡¬ˆsymbŞ \"%s\" occur Úh\
-hªd sidoà¨ruË. Thi wÈ»suÉ iÀ¨·r£¸which \
‚Ù wÜk…rİ”ly.",
¥
->
Çme
);

708 
Ëmp
->
”rÜút
++;

716 
½
=
¥
->
ruË
;„p;„pôp->
Ãxhs
){

717 
cÚfig
 *
Ãwcå
;

718 
½
->
lhsS¹
 = 1;

719 
Ãwcå
 = 
	`CÚfigli¡_addbasis
(
½
,0);

720 
	`S‘Add
(
Ãwcå
->
fws
,0);

726 ()
	`g‘¡©e
(
Ëmp
);

728 
	}
}

733 
PRIVATE
 
budshiás
( );

734 
PRIVATE
 
¡©e
 *
	$g‘¡©e
(
Ëmp
)

735 
ËmÚ
 *
Ëmp
;

737 
cÚfig
 *
cå
, *
bp
;

738 
¡©e
 *
¡p
;

742 
	`CÚfigli¡_sÜtbasis
();

743 
bp
 = 
	`CÚfigli¡_basis
();

746 
¡p
 = 
	`S‹_fšd
(
bp
);

747 ifĞ
¡p
 ){

751 
cÚfig
 *
x
, *
y
;

752 
x
=
bp
, 
y
=
¡p
->bp; x && y; x=x->bp, y=y->bp){

753 
	`Plšk_cİy
(&
y
->
b¶p
,
x
->bplp);

754 
	`Plšk_d–‘e
(
x
->
åÍ
);

755 
x
->
åÍ
 = x->
b¶p
 = 0;

757 
cå
 = 
	`CÚfigli¡_»tuº
();

758 
	`CÚfigli¡_—t
(
cå
);

761 
	`CÚfigli¡_şosu»
(
Ëmp
);

762 
	`CÚfigli¡_sÜt
();

763 
cå
 = 
	`CÚfigli¡_»tuº
();

764 
¡p
 = 
	`S‹_Ãw
();

765 
	`MemÜyCheck
(
¡p
);

766 
¡p
->
bp
 = bp;

767 
¡p
->
cå
 = cfp;

768 
¡p
->
¡©’um
 = 
Ëmp
->
n¡©e
++;

769 
¡p
->
­
 = 0;

770 
	`S‹_š£¹
(
¡p
,¡p->
bp
);

771 
	`budshiás
(
Ëmp
,
¡p
);

773  
¡p
;

774 
	}
}

779 
	$§me_symbŞ
(
a
,
b
)

780 
symbŞ
 *
a
;

781 
symbŞ
 *
b
;

783 
i
;

784 ifĞ
a
==
b
 )  1;

785 ifĞ
a
->
ty³
!=
MULTITERMINAL
 )  0;

786 ifĞ
b
->
ty³
!=
MULTITERMINAL
 )  0;

787 ifĞ
a
->
nsubsym
!=
b
->nsubsym )  0;

788 
i
=0; i<
a
->
nsubsym
; i++){

789 ifĞ
a
->
subsym
[
i
]!=
b
->subsym[i] )  0;

792 
	}
}

797 
PRIVATE
 
	$budshiás
(
Ëmp
,
¡p
)

798 
ËmÚ
 *
Ëmp
;

799 
¡©e
 *
¡p
;

801 
cÚfig
 *
cå
;

802 
cÚfig
 *
bcå
;

803 
cÚfig
 *
Ãw
;

804 
symbŞ
 *
¥
;

805 
symbŞ
 *
b¥
;

806 
¡©e
 *
Ãw¡p
;

810 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
ècå->
¡©us
 = 
INCOMPLETE
;

813 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

814 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

815 ifĞ
cå
->
dÙ
>=cå->
½
->
Ähs
 ) ;

816 
	`CÚfigli¡_»£t
();

817 
¥
 = 
cå
->
½
->
rhs
[cå->
dÙ
];

822 
bcå
=
cå
; bcå; bcå=bcå->
Ãxt
){

823 ifĞ
bcå
->
¡©us
==
COMPLETE
 ) ;

824 ifĞ
bcå
->
dÙ
>=bcå->
½
->
Ähs
 ) ;

825 
b¥
 = 
bcå
->
½
->
rhs
[bcå->
dÙ
];

826 ifĞ!
	`§me_symbŞ
(
b¥
,
¥
) ) ;

827 
bcå
->
¡©us
 = 
COMPLETE
;

828 
Ãw
 = 
	`CÚfigli¡_addbasis
(
bcå
->
½
,bcå->
dÙ
+1);

829 
	`Plšk_add
(&
Ãw
->
b¶p
,
bcå
);

834 
Ãw¡p
 = 
	`g‘¡©e
(
Ëmp
);

838 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

839 
i
;

840 
i
=0; i<
¥
->
nsubsym
; i++){

841 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
->
subsym
[
i
],(*)
Ãw¡p
);

844 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
,(*)
Ãw¡p
);

847 
	}
}

852 
	$FšdLšks
(
Ëmp
)

853 
ËmÚ
 *
Ëmp
;

855 
i
;

856 
cÚfig
 *
cå
, *
Ùh”
;

857 
¡©e
 *
¡p
;

858 
¶šk
 *
¶p
;

863 
i
=0; i<
Ëmp
->
n¡©e
; i++){

864 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

865 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

866 
cå
->
¡p
 = stp;

872 
i
=0; i<
Ëmp
->
n¡©e
; i++){

873 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

874 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

875 
¶p
=
cå
->
b¶p
;…Í;…ÍõÍ->
Ãxt
){

876 
Ùh”
 = 
¶p
->
cå
;

877 
	`Plšk_add
(&
Ùh”
->
åÍ
,
cå
);

881 
	}
}

888 
	$FšdFŞlowS‘s
(
Ëmp
)

889 
ËmÚ
 *
Ëmp
;

891 
i
;

892 
cÚfig
 *
cå
;

893 
¶šk
 *
¶p
;

894 
´og»ss
;

895 
chªge
;

897 
i
=0; i<
Ëmp
->
n¡©e
; i++){

898 
cå
=
Ëmp
->
sÜ‹d
[
i
]->cå; cå; cå=cå->
Ãxt
){

899 
cå
->
¡©us
 = 
INCOMPLETE
;

904 
´og»ss
 = 0;

905 
i
=0; i<
Ëmp
->
n¡©e
; i++){

906 
cå
=
Ëmp
->
sÜ‹d
[
i
]->cå; cå; cå=cå->
Ãxt
){

907 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

908 
¶p
=
cå
->
åÍ
;…Í;…ÍõÍ->
Ãxt
){

909 
chªge
 = 
	`S‘UniÚ
(
¶p
->
cå
->
fws
,cfp->fws);

910 ifĞ
chªge
 ){

911 
¶p
->
cå
->
¡©us
 = 
INCOMPLETE
;

912 
´og»ss
 = 1;

915 
cå
->
¡©us
 = 
COMPLETE
;

918 } 
´og»ss
 );

919 
	}
}

921 
»sŞve_cÚæiù
();

925 
	$FšdAùiÚs
(
Ëmp
)

926 
ËmÚ
 *
Ëmp
;

928 
i
,
j
;

929 
cÚfig
 *
cå
;

930 
¡©e
 *
¡p
;

931 
symbŞ
 *
¥
;

932 
ruË
 *
½
;

938 
i
=0; i<
Ëmp
->
n¡©e
; i++){

939 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

940 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

941 ifĞ
cå
->
½
->
Ähs
==cå->
dÙ
 ){

942 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

943 ifĞ
	`S‘Fšd
(
cå
->
fws
,
j
) ){

946 
	`AùiÚ_add
(&
¡p
->
­
,
REDUCE
,
Ëmp
->
symbŞs
[
j
],(*)
cå
->
½
);

954 ifĞ
Ëmp
->
¡¬t
 ){

955 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

956 ifĞ
¥
==0 ) s°ğ
Ëmp
->
ruË
->
lhs
;

958 
¥
 = 
Ëmp
->
ruË
->
lhs
;

963 
	`AùiÚ_add
(&
Ëmp
->
sÜ‹d
[0]->
­
,
ACCEPT
,
¥
,0);

966 
i
=0; i<
Ëmp
->
n¡©e
; i++){

967 
aùiÚ
 *
­
, *
Çp
;

968 
¡©e
 *
¡p
;

969 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

971 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

972 
­
=
¡p
->­;‡°&&‡p->
Ãxt
;‡p=ap->next){

973 
Çp
=
­
->
Ãxt
;‚­ &&‚­->
¥
==ap->sp;‚ap=nap->next){

976 
Ëmp
->
ncÚæiù
 +ğ
	`»sŞve_cÚæiù
(
­
,
Çp
,Ëmp->
”rsym
);

982 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
è½->
ÿnReduû
 = 
LEMON_FALSE
;

983 
i
=0; i<
Ëmp
->
n¡©e
; i++){

984 
aùiÚ
 *
­
;

985 
­
=
Ëmp
->
sÜ‹d
[
i
]->­;‡p;‡p÷p->
Ãxt
){

986 ifĞ
­
->
ty³
==
REDUCE
 )‡p->
x
.
½
->
ÿnReduû
 = 
LEMON_TRUE
;

989 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

990 ifĞ
½
->
ÿnReduû
 ) ;

991 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,"This„ule can‚ot be„educed.\n");

992 
Ëmp
->
”rÜút
++;

994 
	}
}

1009 
	$»sŞve_cÚæiù
(
­x
,
­y
,
”rsym
)

1010 
aùiÚ
 *
­x
;

1011 
aùiÚ
 *
­y
;

1012 
symbŞ
 *
”rsym
;

1014 
symbŞ
 *
¥x
, *
¥y
;

1015 
”rút
 = 0;

1016 
	`as£¹
Ğ
­x
->
¥
==
­y
->sp );

1017 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->type==SHIFT ){

1018 
­y
->
ty³
 = 
SSCONFLICT
;

1019 
”rút
++;

1021 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->ty³==
REDUCE
 ){

1022 
¥x
 = 
­x
->
¥
;

1023 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1024 ifĞ
¥y
==0 || 
¥x
->
´ec
<0 || spy->prec<0 ){

1026 
­y
->
ty³
 = 
SRCONFLICT
;

1027 
”rút
++;

1028 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1029 
­y
->
ty³
 = 
RD_RESOLVED
;

1030 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1031 
­x
->
ty³
 = 
SH_RESOLVED
;

1032 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
RIGHT
 ){

1033 
­y
->
ty³
 = 
RD_RESOLVED
;

1034 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
LEFT
 ){

1035 
­x
->
ty³
 = 
SH_RESOLVED
;

1037 
	`as£¹
Ğ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
NONE
 );

1038 
­y
->
ty³
 = 
SRCONFLICT
;

1039 
”rút
++;

1041 }ifĞ
­x
->
ty³
==
REDUCE
 && 
­y
->type==REDUCE ){

1042 
¥x
 = 
­x
->
x
.
½
->
´ecsym
;

1043 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1044 ifĞ
¥x
==0 || 
¥y
==0 || spx->
´ec
<0 ||

1045 
¥y
->
´ec
<0 || 
¥x
->prec==spy->prec ){

1046 
­y
->
ty³
 = 
RRCONFLICT
;

1047 
”rút
++;

1048 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1049 
­y
->
ty³
 = 
RD_RESOLVED
;

1050 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1051 
­x
->
ty³
 = 
RD_RESOLVED
;

1054 
	`as£¹
(

1055 
­x
->
ty³
==
SH_RESOLVED
 ||

1056 
­x
->
ty³
==
RD_RESOLVED
 ||

1057 
­x
->
ty³
==
SSCONFLICT
 ||

1058 
­x
->
ty³
==
SRCONFLICT
 ||

1059 
­x
->
ty³
==
RRCONFLICT
 ||

1060 
­y
->
ty³
==
SH_RESOLVED
 ||

1061 
­y
->
ty³
==
RD_RESOLVED
 ||

1062 
­y
->
ty³
==
SSCONFLICT
 ||

1063 
­y
->
ty³
==
SRCONFLICT
 ||

1064 
­y
->
ty³
==
RRCONFLICT


1070  
”rút
;

1071 
	}
}

1078 
cÚfig
 *
	gä“li¡
 = 0;

1079 
cÚfig
 *
	gcu¼’t
 = 0;

1080 
cÚfig
 **
	gcu¼’‹nd
 = 0;

1081 
cÚfig
 *
	gbasis
 = 0;

1082 
cÚfig
 **
	gbasi£nd
 = 0;

1085 
PRIVATE
 
cÚfig
 *
	$ÃwcÚfig
(){

1086 
cÚfig
 *
Ãw
;

1087 ifĞ
ä“li¡
==0 ){

1088 
i
;

1089 
amt
 = 3;

1090 
ä“li¡
 = (
cÚfig
 *)
	`ÿÎoc
Ğ
amt
, (config) );

1091 ifĞ
ä“li¡
==0 ){

1092 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew configuration.");

1093 
	`ex™
(1);

1095 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

1096 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

1098 
Ãw
 = 
ä“li¡
;

1099 
ä“li¡
 = f»–i¡->
Ãxt
;

1100  
Ãw
;

1101 
	}
}

1104 
PRIVATE
 
	$d–‘ecÚfig
(
Şd
)

1105 
cÚfig
 *
Şd
;

1107 
Şd
->
Ãxt
 = 
ä“li¡
;

1108 
ä“li¡
 = 
Şd
;

1109 
	}
}

1112 
	$CÚfigli¡_š™
(){

1113 
cu¼’t
 = 0;

1114 
cu¼’‹nd
 = &
cu¼’t
;

1115 
basis
 = 0;

1116 
basi£nd
 = &
basis
;

1117 
	`CÚfigbË_š™
();

1119 
	}
}

1122 
	$CÚfigli¡_»£t
(){

1123 
cu¼’t
 = 0;

1124 
cu¼’‹nd
 = &
cu¼’t
;

1125 
basis
 = 0;

1126 
basi£nd
 = &
basis
;

1127 
	`CÚfigbË_ş—r
(0);

1129 
	}
}

1132 
cÚfig
 *
	$CÚfigli¡_add
(
½
,
dÙ
)

1133 
ruË
 *
½
;

1134 
dÙ
;

1136 
cÚfig
 *
cå
, 
mod–
;

1138 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1139 
mod–
.
½
 =„p;

1140 
mod–
.
dÙ
 = dot;

1141 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1142 ifĞ
cå
==0 ){

1143 
cå
 = 
	`ÃwcÚfig
();

1144 
cå
->
½
 =„p;

1145 
cå
->
dÙ
 = dot;

1146 
cå
->
fws
 = 
	`S‘New
();

1147 
cå
->
¡p
 = 0;

1148 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1149 
cå
->
Ãxt
 = 0;

1150 
cå
->
bp
 = 0;

1151 *
cu¼’‹nd
 = 
cå
;

1152 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1153 
	`CÚfigbË_š£¹
(
cå
);

1155  
cå
;

1156 
	}
}

1159 
cÚfig
 *
	$CÚfigli¡_addbasis
(
½
,
dÙ
)

1160 
ruË
 *
½
;

1161 
dÙ
;

1163 
cÚfig
 *
cå
, 
mod–
;

1165 
	`as£¹
Ğ
basi£nd
!=0 );

1166 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1167 
mod–
.
½
 =„p;

1168 
mod–
.
dÙ
 = dot;

1169 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1170 ifĞ
cå
==0 ){

1171 
cå
 = 
	`ÃwcÚfig
();

1172 
cå
->
½
 =„p;

1173 
cå
->
dÙ
 = dot;

1174 
cå
->
fws
 = 
	`S‘New
();

1175 
cå
->
¡p
 = 0;

1176 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1177 
cå
->
Ãxt
 = 0;

1178 
cå
->
bp
 = 0;

1179 *
cu¼’‹nd
 = 
cå
;

1180 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1181 *
basi£nd
 = 
cå
;

1182 
basi£nd
 = &
cå
->
bp
;

1183 
	`CÚfigbË_š£¹
(
cå
);

1185  
cå
;

1186 
	}
}

1189 
	$CÚfigli¡_şosu»
(
Ëmp
)

1190 
ËmÚ
 *
Ëmp
;

1192 
cÚfig
 *
cå
, *
Ãwcå
;

1193 
ruË
 *
½
, *
Ãw½
;

1194 
symbŞ
 *
¥
, *
x¥
;

1195 
i
, 
dÙ
;

1197 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1198 
cå
=
cu¼’t
; cå; cå=cå->
Ãxt
){

1199 
½
 = 
cå
->rp;

1200 
dÙ
 = 
cå
->dot;

1201 ifĞ
dÙ
>=
½
->
Ähs
 ) ;

1202 
¥
 = 
½
->
rhs
[
dÙ
];

1203 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

1204 ifĞ
¥
->
ruË
==0 && sp!=
Ëmp
->
”rsym
 ){

1205 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
lše
,"Nonterminal \"%s\" has‚o„ules.",

1206 
¥
->
Çme
);

1207 
Ëmp
->
”rÜút
++;

1209 
Ãw½
=
¥
->
ruË
;‚ew½;‚ew½òew½->
Ãxhs
){

1210 
Ãwcå
 = 
	`CÚfigli¡_add
(
Ãw½
,0);

1211 
i
=
dÙ
+1; i<
½
->
Ähs
; i++){

1212 
x¥
 = 
½
->
rhs
[
i
];

1213 ifĞ
x¥
->
ty³
==
TERMINAL
 ){

1214 
	`S‘Add
(
Ãwcå
->
fws
,
x¥
->
šdex
);

1216 }ifĞ
x¥
->
ty³
==
MULTITERMINAL
 ){

1217 
k
;

1218 
k
=0; k<
x¥
->
nsubsym
; k++){

1219 
	`S‘Add
(
Ãwcå
->
fws
, 
x¥
->
subsym
[
k
]->
šdex
);

1223 
	`S‘UniÚ
(
Ãwcå
->
fws
,
x¥
->
fœ¡£t
);

1224 ifĞ
x¥
->
Ïmbda
==
LEMON_FALSE
 ) ;

1227 ifĞ
i
==
½
->
Ähs
 ) 
	`Plšk_add
(&
cå
->
åÍ
,
Ãwcå
);

1232 
	}
}

1235 
	$CÚfigli¡_sÜt
(){

1236 
cu¼’t
 = (
cÚfig
 *)
	`msÜt
((*)cu¼’t,(**)&(cu¼’t->
Ãxt
),
CÚfigcmp
);

1237 
cu¼’‹nd
 = 0;

1239 
	}
}

1242 
	$CÚfigli¡_sÜtbasis
(){

1243 
basis
 = (
cÚfig
 *)
	`msÜt
((*)
cu¼’t
,(**)&(cu¼’t->
bp
),
CÚfigcmp
);

1244 
basi£nd
 = 0;

1246 
	}
}

1250 
cÚfig
 *
	$CÚfigli¡_»tuº
(){

1251 
cÚfig
 *
Şd
;

1252 
Şd
 = 
cu¼’t
;

1253 
cu¼’t
 = 0;

1254 
cu¼’‹nd
 = 0;

1255  
Şd
;

1256 
	}
}

1260 
cÚfig
 *
	$CÚfigli¡_basis
(){

1261 
cÚfig
 *
Şd
;

1262 
Şd
 = 
basis
;

1263 
basis
 = 0;

1264 
basi£nd
 = 0;

1265  
Şd
;

1266 
	}
}

1269 
	$CÚfigli¡_—t
(
cå
)

1270 
cÚfig
 *
cå
;

1272 
cÚfig
 *
Ãxtcå
;

1273 ; 
cå
; cå=
Ãxtcå
){

1274 
Ãxtcå
 = 
cå
->
Ãxt
;

1275 
	`as£¹
Ğ
cå
->
åÍ
==0 );

1276 
	`as£¹
Ğ
cå
->
b¶p
==0 );

1277 ifĞ
cå
->
fws
 ) 
	`S‘F»e
(cfp->fws);

1278 
	`d–‘ecÚfig
(
cå
);

1281 
	}
}

1290 
	$fšdb»ak
(
msg
,
mš
,
max
)

1291 *
msg
;

1292 
mš
;

1293 
max
;

1295 
i
,
¥Ù
;

1296 
c
;

1297 
i
=
¥Ù
=
mš
; i<=
max
; i++){

1298 
c
 = 
msg
[
i
];

1299 ifĞ
c
=='\t' ) 
msg
[
i
] = ' ';

1300 ifĞ
c
=='\n' ){ 
msg
[
i
] = ' '; 
¥Ù
 = i; ; }

1301 ifĞ
c
==0 ){ 
¥Ù
 = 
i
; ; }

1302 ifĞ
c
=='-' && 
i
<
max
-1 ) 
¥Ù
 = i+1;

1303 ifĞ
c
==' ' ) 
¥Ù
 = 
i
;

1305  
¥Ù
;

1306 
	}
}

1313 
	#ERRMSGSIZE
 10000

	)

1314 
	#LINEWIDTH
 79

	)

1315 
	#PREFIXLIMIT
 30

	)

1316 
	$E¼ÜMsg
(cÚ¡ *
f’ame
, 
lš’o
, cÚ¡ *
fÜm©
, ...){

1317 
”rmsg
[
ERRMSGSIZE
];

1318 
´efix
[
PREFIXLIMIT
+10];

1319 
”rmsgsize
;

1320 
´efixsize
;

1321 
avaabËwidth
;

1322 
va_li¡
 
­
;

1323 
’d
, 
»¡¬t
, 
ba£
;

1325 
	`va_¡¬t
(
­
, 
fÜm©
);

1327 ifĞ
lš’o
>0 ){

1328 
	`¥rštf
(
´efix
,"%.*s:%d: ",
PREFIXLIMIT
-10,
f’ame
,
lš’o
);

1330 
	`¥rštf
(
´efix
,"%.*s: ",
PREFIXLIMIT
-10,
f’ame
);

1332 
´efixsize
 = 
	`ËmÚSŒËn
(
´efix
);

1333 
avaabËwidth
 = 
LINEWIDTH
 - 
´efixsize
;

1336 
	`v¥rštf
(
”rmsg
,
fÜm©
,
­
);

1337 
	`va_’d
(
­
);

1338 
”rmsgsize
 = 
	`ËmÚSŒËn
(
”rmsg
);

1340  
”rmsgsize
>0 && 
”rmsg
[errmsgsize-1]=='\n' ){

1341 
”rmsg
[--
”rmsgsize
] = 0;

1345 
ba£
 = 0;

1346  
”rmsg
[
ba£
]!=0 ){

1347 
’d
 = 
»¡¬t
 = 
	`fšdb»ak
(&
”rmsg
[
ba£
],0,
avaabËwidth
);

1348 
»¡¬t
 +ğ
ba£
;

1349  
”rmsg
[
»¡¬t
]==' ' )„estart++;

1350 
	`årštf
(
¡dout
,"%s%.*s\n",
´efix
,
’d
,&
”rmsg
[
ba£
]);

1351 
ba£
 = 
»¡¬t
;

1353 
	}
}

1362 
	$memÜy_”rÜ
(){

1363 
	`årštf
(
¡d”r
,"Out of memory. Aborting...\n");

1364 
	`ex™
(1);

1365 
	}
}

1367 
	gnDefše
 = 0;

1368 **
	gazDefše
 = 0;

1373 
	$hªdË_D_İtiÚ
(*
z
){

1374 **
·z
;

1375 
nDefše
++;

1376 
azDefše
 = 
	`»®loc
×zDefše, ×zDefše[0])*
nDefše
);

1377 ifĞ
azDefše
==0 ){

1378 
	`årštf
(
¡d”r
,"out of memory\n");

1379 
	`ex™
(1);

1381 
·z
 = &
azDefše
[
nDefše
-1];

1382 *
·z
 = 
	`m®loc
Ğ
	`ËmÚSŒËn
(
z
)+1 );

1383 ifĞ*
·z
==0 ){

1384 
	`årštf
(
¡d”r
,"out of memory\n");

1385 
	`ex™
(1);

1387 
	`¡rıy
(*
·z
, 
z
);

1388 
z
=*
·z
; *z && *z!='='; z++){}

1389 *
z
 = 0;

1390 
	}
}

1394 
	$maš
(
¬gc
,
¬gv
)

1395 
¬gc
;

1396 **
¬gv
;

1398 
v”siÚ
 = 0;

1399 
½æag
 = 0;

1400 
basisæag
 = 0;

1401 
com´ess
 = 0;

1402 
qu›t
 = 0;

1403 
¡©i¡ics
 = 0;

1404 
mhæag
 = 0;

1405 
nŞš’osæag
 = 0;

1406 
s_İtiÚs
 
İtiÚs
[] = {

1407 {
OPT_FLAG
, "b", (*)&
basisæag
, "Print onlyhe basis in„eport."},

1408 {
OPT_FLAG
, "c", (*)&
com´ess
, "Don't compresshe‡ctionable."},

1409 {
OPT_FSTR
, "D", (*)
hªdË_D_İtiÚ
, "Define‡n %ifdef macro."},

1410 {
OPT_FLAG
, "g", (*)&
½æag
, "Print grammar without‡ctions."},

1411 {
OPT_FLAG
, "m", (*)&
mhæag
, "Output‡ makeheaders compatible file."},

1412 {
OPT_FLAG
, "l", (*)&
nŞš’osæag
, "Do‚ot…rint #line statements."},

1413 {
OPT_FLAG
, "q", (*)&
qu›t
, "(Quiet) Don't…rinthe„eport file."},

1414 {
OPT_FLAG
, "s", (*)&
¡©i¡ics
,

1416 {
OPT_FLAG
, "x", (*)&
v”siÚ
, "Printhe version‚umber."},

1417 {
OPT_FLAG
,0,0,0}

1419 
i
;

1420 
ËmÚ
 
Ëm
;

1422 
	`O±In™
(
¬gv
,
İtiÚs
,
¡d”r
);

1423 ifĞ
v”siÚ
 ){

1424 
	`´štf
("Lemon version 1.0\n");

1425 
	`ex™
(0);

1427 ifĞ
	`O±NArgs
()!=1 ){

1428 
	`årštf
(
¡d”r
,"Exactly one filename‡rgument is„equired.\n");

1429 
	`ex™
(1);

1431 
	`mem£t
(&
Ëm
, 0, (lem));

1432 
Ëm
.
”rÜút
 = 0;

1435 
	`SŒ§ã_š™
();

1436 
	`SymbŞ_š™
();

1437 
	`S‹_š™
();

1438 
Ëm
.
¬gv0
 = 
¬gv
[0];

1439 
Ëm
.
f’ame
 = 
	`O±Arg
(0);

1440 
Ëm
.
basisæag
 = basisflag;

1441 
Ëm
.
nŞš’osæag
 =‚olinenosflag;

1442 
	`SymbŞ_Ãw
("$");

1443 
Ëm
.
”rsym
 = 
	`SymbŞ_Ãw
("error");

1444 
Ëm
.
”rsym
->
u£CÁ
 = 0;

1447 
	`P¬£
(&
Ëm
);

1448 ifĞ
Ëm
.
”rÜút
 ) 
	`ex™
(lem.errorcnt);

1449 ifĞ
Ëm
.
ÄuË
==0 ){

1450 
	`årštf
(
¡d”r
,"Empty grammar.\n");

1451 
	`ex™
(1);

1455 
Ëm
.
nsymbŞ
 = 
	`SymbŞ_couÁ
();

1456 
	`SymbŞ_Ãw
("{default}");

1457 
Ëm
.
symbŞs
 = 
	`SymbŞ_¬¿yof
();

1458 
i
=0; i<=
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1459 
	`qsÜt
(
Ëm
.
symbŞs
,Ëm.
nsymbŞ
+1,(
symbŞ
*),

1460 ((*)())
SymbŞcmµ
);

1461 
i
=0; i<=
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1462 
i
=1; 
	`isuµ”
(
Ëm
.
symbŞs
[i]->
Çme
[0]); i++);

1463 
Ëm
.
Á”mš®
 = 
i
;

1466 ifĞ
½æag
 ){

1467 
	`R•ršt
(&
Ëm
);

1470 
	`S‘Size
(
Ëm
.
Á”mš®
+1);

1473 
	`FšdRuËP»ûd’ûs
(&
Ëm
);

1477 
	`FšdFœ¡S‘s
(&
Ëm
);

1481 
Ëm
.
n¡©e
 = 0;

1482 
	`FšdS‹s
(&
Ëm
);

1483 
Ëm
.
sÜ‹d
 = 
	`S‹_¬¿yof
();

1486 
	`FšdLšks
(&
Ëm
);

1489 
	`FšdFŞlowS‘s
(&
Ëm
);

1492 
	`FšdAùiÚs
(&
Ëm
);

1495 ifĞ
com´ess
==0 ) 
	`Com´essTabËs
(&
Ëm
);

1499 
	`ResÜtS‹s
(&
Ëm
);

1502 ifĞ!
qu›t
 ) 
	`R•ÜtOuut
(&
Ëm
);

1505 
	`R•ÜtTabË
(&
Ëm
, 
mhæag
);

1510 ifĞ!
mhæag
 ) 
	`R•ÜtH—d”
(&
Ëm
);

1512 ifĞ
¡©i¡ics
 ){

1513 
	`´štf
("Parser statistics: %derminals, %d‚onterminals, %d„ules\n",

1514 
Ëm
.
Á”mš®
,†em.
nsymbŞ
 -†em.Á”mš®,†em.
ÄuË
);

1515 
	`´štf
(" %d states, %d…arserableƒntries, %d conflicts\n",

1516 
Ëm
.
n¡©e
,†em.
bËsize
,†em.
ncÚæiù
);

1518 ifĞ
Ëm
.
ncÚæiù
 ){

1519 
	`årštf
(
¡d”r
,"%d…¬sšg cÚæiùs.\n",
Ëm
.
ncÚæiù
);

1521 
	`ex™
(
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1522  (
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1523 
	}
}

1551 
	#NEXT
(
A
è(*(**)((()A)+
off£t
))

	)

1568 *
m”ge
(

1569 *
a
,

1570 *
b
,

1571 (*
cmp
)(const *,const *),

1572 
off£t


1574 *
±r
, *
h—d
;

1576 ifĞ
a
==0 ){

1577 
h—d
 = 
b
;

1578 }ifĞ
b
==0 ){

1579 
h—d
 = 
a
;

1581 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1582 
±r
 = 
a
;

1583 
a
 = 
	`NEXT
(a);

1585 
±r
 = 
b
;

1586 
b
 = 
	`NEXT
(b);

1588 
h—d
 = 
±r
;

1589  
a
 && 
b
 ){

1590 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1591 
	`NEXT
(
±r
èğ
a
;

1592 
±r
 = 
a
;

1593 
a
 = 
	`NEXT
(a);

1595 
	`NEXT
(
±r
èğ
b
;

1596 
±r
 = 
b
;

1597 
b
 = 
	`NEXT
(b);

1600 ifĞ
a
 ) 
	`NEXT
(
±r
) =‡;

1601 
	`NEXT
(
±r
èğ
b
;

1603  
h—d
;

1604 
	}
}

1619 
	#LISTSIZE
 30

	)

1620 *
msÜt
(

1621 *
li¡
,

1622 **
Ãxt
,

1623 (*
cmp
)(const *,const *)

1625 
off£t
;

1626 *
•
;

1627 *
£t
[
LISTSIZE
];

1628 
i
;

1629 
off£t
 = ()
Ãxt
 - ()
li¡
;

1630 
i
=0; i<
LISTSIZE
; i++è
£t
[i] = 0;

1631  
li¡
 ){

1632 
•
 = 
li¡
;

1633 
li¡
 = 
	`NEXT
(list);

1634 
	`NEXT
(
•
) = 0;

1635 
i
=0; i<
LISTSIZE
-1 && 
£t
[i]!=0; i++){

1636 
•
 = 
	`m”ge
Óp,
£t
[
i
],
cmp
,
off£t
);

1637 
£t
[
i
] = 0;

1639 
£t
[
i
] = 
•
;

1641 
•
 = 0;

1642 
i
=0; i<
LISTSIZE
; i++èifĞ
£t
[i] ) 
•
 = 
	`m”ge
Óp,£t[i],
cmp
,
off£t
);

1643  
•
;

1644 
	}
}

1646 **
	g¬gv
;

1647 
s_İtiÚs
 *
	gİ
;

1648 
FILE
 *
	g”r¡»am
;

1650 
	#ISOPT
(
X
è((X)[0]=='-'||(X)[0]=='+'||
	`¡rchr
((X),'=')!=0)

	)

1656 
	$”¾še
(
n
,
k
,
”r
)

1657 
n
;

1658 
k
;

1659 
FILE
 *
”r
;

1661 
¥út
, 
i
;

1662 ifĞ
¬gv
[0] ) 
	`årštf
(
”r
,"%s",argv[0]);

1663 
¥út
 = 
	`ËmÚSŒËn
(
¬gv
[0]) + 1;

1664 
i
=1; i<
n
 && 
¬gv
[i]; i++){

1665 
	`årštf
(
”r
," %s",
¬gv
[
i
]);

1666 
¥út
 +ğ
	`ËmÚSŒËn
(
¬gv
[
i
])+1;

1668 
¥út
 +ğ
k
;

1669 ; 
¬gv
[
i
]; i++è
	`årštf
(
”r
," %s",argv[i]);

1670 ifĞ
¥út
<20 ){

1671 
	`årštf
(
”r
,"\n%*s^-- h”e\n",
¥út
,"");

1673 
	`årštf
(
”r
,"\n%*sh”--^\n",
¥út
-7,"");

1675 
	}
}

1681 
	$¬gšdex
(
n
)

1682 
n
;

1684 
i
;

1685 
dashdash
 = 0;

1686 ifĞ
¬gv
!=0 && *argv!=0 ){

1687 
i
=1; 
¬gv
[i]; i++){

1688 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]) ){

1689 ifĞ
n
==0 )  
i
;

1690 
n
--;

1692 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1696 
	}
}

1698 
	gemsg
[] = "Command†ine syntaxƒrror: ";

1703 
	$hªdËæags
(
i
,
”r
)

1704 
i
;

1705 
FILE
 *
”r
;

1707 
v
;

1708 
”rút
 = 0;

1709 
j
;

1710 
j
=0; 
İ
[j].
Ïb–
; j++){

1711 ifĞ
	`¡ºcmp
(&
¬gv
[
i
][1],
İ
[
j
].
Ïb–
,
	`ËmÚSŒËn
(op[j].label))==0 ) ;

1713 
v
 = 
¬gv
[
i
][0]=='-' ? 1 : 0;

1714 ifĞ
İ
[
j
].
Ïb–
==0 ){

1715 ifĞ
”r
 ){

1716 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1717 
	`”¾še
(
i
,1,
”r
);

1719 
”rút
++;

1720 }ifĞ
İ
[
j
].
ty³
==
OPT_FLAG
 ){

1721 *((*)
İ
[
j
].
¬g
èğ
v
;

1722 }ifĞ
İ
[
j
].
ty³
==
OPT_FFLAG
 ){

1723 (*((*)())(
İ
[
j
].
¬g
))(
v
);

1724 }ifĞ
İ
[
j
].
ty³
==
OPT_FSTR
 ){

1725 (*((*)())(
İ
[
j
].
¬g
))(&
¬gv
[
i
][2]);

1727 ifĞ
”r
 ){

1728 
	`årštf
(
”r
,"%smissšg‡rgum’ˆÚ sw™ch.\n",
emsg
);

1729 
	`”¾še
(
i
,1,
”r
);

1731 
”rút
++;

1733  
”rút
;

1734 
	}
}

1739 
	$hªdËsw™ch
(
i
,
”r
)

1740 
i
;

1741 
FILE
 *
”r
;

1743 
lv
 = 0;

1744 
dv
 = 0.0;

1745 *
sv
 = 0, *
’d
;

1746 *
ı
;

1747 
j
;

1748 
”rút
 = 0;

1749 
ı
 = 
	`¡rchr
(
¬gv
[
i
],'=');

1750 
	`as£¹
Ğ
ı
!=0 );

1751 *
ı
 = 0;

1752 
j
=0; 
İ
[j].
Ïb–
; j++){

1753 ifĞ
	`¡rcmp
(
¬gv
[
i
],
İ
[
j
].
Ïb–
)==0 ) ;

1755 *
ı
 = '=';

1756 ifĞ
İ
[
j
].
Ïb–
==0 ){

1757 ifĞ
”r
 ){

1758 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1759 
	`”¾še
(
i
,0,
”r
);

1761 
”rút
++;

1763 
ı
++;

1764  
İ
[
j
].
ty³
 ){

1765 
OPT_FLAG
:

1766 
OPT_FFLAG
:

1767 ifĞ
”r
 ){

1768 
	`årštf
(
”r
,"%sİtiÚ„equœe ª‡rgum’t.\n",
emsg
);

1769 
	`”¾še
(
i
,0,
”r
);

1771 
”rút
++;

1773 
OPT_DBL
:

1774 
OPT_FDBL
:

1775 
dv
 = 
	`¡¹od
(
ı
,&
’d
);

1776 ifĞ*
’d
 ){

1777 ifĞ
”r
 ){

1778 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀæßtšg-pošˆ¬gum’t.\n",
emsg
);

1779 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1781 
”rút
++;

1784 
OPT_INT
:

1785 
OPT_FINT
:

1786 
lv
 = 
	`¡¹Ş
(
ı
,&
’d
,0);

1787 ifĞ*
’d
 ){

1788 ifĞ
”r
 ){

1789 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀš‹g”‡rgum’t.\n",
emsg
);

1790 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1792 
”rút
++;

1795 
OPT_STR
:

1796 
OPT_FSTR
:

1797 
sv
 = 
ı
;

1800  
İ
[
j
].
ty³
 ){

1801 
OPT_FLAG
:

1802 
OPT_FFLAG
:

1804 
OPT_DBL
:

1805 *(*)(
İ
[
j
].
¬g
èğ
dv
;

1807 
OPT_FDBL
:

1808 (*((*)())(
İ
[
j
].
¬g
))(
dv
);

1810 
OPT_INT
:

1811 *(*)(
İ
[
j
].
¬g
èğ
lv
;

1813 
OPT_FINT
:

1814 (*((*)())(
İ
[
j
].
¬g
))(()
lv
);

1816 
OPT_STR
:

1817 *(**)(
İ
[
j
].
¬g
èğ
sv
;

1819 
OPT_FSTR
:

1820 (*((*)())(
İ
[
j
].
¬g
))(
sv
);

1824  
”rút
;

1825 
	}
}

1827 
	$O±In™
(
a
,
o
,
”r
)

1828 **
a
;

1829 
s_İtiÚs
 *
o
;

1830 
FILE
 *
”r
;

1832 
”rút
 = 0;

1833 
¬gv
 = 
a
;

1834 
İ
 = 
o
;

1835 
”r¡»am
 = 
”r
;

1836 ifĞ
¬gv
 && *¬gv && 
İ
 ){

1837 
i
;

1838 
i
=1; 
¬gv
[i]; i++){

1839 ifĞ
¬gv
[
i
][0]=='+' ||‡rgv[i][0]=='-' ){

1840 
”rút
 +ğ
	`hªdËæags
(
i
,
”r
);

1841 }ifĞ
	`¡rchr
(
¬gv
[
i
],'=') ){

1842 
”rút
 +ğ
	`hªdËsw™ch
(
i
,
”r
);

1846 ifĞ
”rút
>0 ){

1847 
	`årštf
(
”r
,"V®id commªd†šİtiÚ fÜ \"%s\"‡»:\n",*
a
);

1848 
	`O±Pršt
();

1849 
	`ex™
(1);

1852 
	}
}

1854 
	$O±NArgs
(){

1855 
út
 = 0;

1856 
dashdash
 = 0;

1857 
i
;

1858 ifĞ
¬gv
!=0 &&‡rgv[0]!=0 ){

1859 
i
=1; 
¬gv
[i]; i++){

1860 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]èè
út
++;

1861 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1864  
út
;

1865 
	}
}

1867 *
	$O±Arg
(
n
)

1868 
n
;

1870 
i
;

1871 
i
 = 
	`¬gšdex
(
n
);

1872  
i
>=0 ? 
¬gv
[i] : 0;

1873 
	}
}

1875 
	$O±E¼
(
n
)

1876 
n
;

1878 
i
;

1879 
i
 = 
	`¬gšdex
(
n
);

1880 ifĞ
i
>=0 ) 
	`”¾še
(i,0,
”r¡»am
);

1881 
	}
}

1883 
	$O±Pršt
(){

1884 
i
;

1885 
max
, 
Ën
;

1886 
max
 = 0;

1887 
i
=0; 
İ
[i].
Ïb–
; i++){

1888 
Ën
 = 
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
) + 1;

1889  
İ
[
i
].
ty³
 ){

1890 
OPT_FLAG
:

1891 
OPT_FFLAG
:

1893 
OPT_INT
:

1894 
OPT_FINT
:

1895 
Ën
 += 9;

1897 
OPT_DBL
:

1898 
OPT_FDBL
:

1899 
Ën
 += 6;

1901 
OPT_STR
:

1902 
OPT_FSTR
:

1903 
Ën
 += 8;

1906 ifĞ
Ën
>
max
 ) max =†en;

1908 
i
=0; 
İ
[i].
Ïb–
; i++){

1909  
İ
[
i
].
ty³
 ){

1910 
OPT_FLAG
:

1911 
OPT_FFLAG
:

1912 
	`årštf
(
”r¡»am
," -%-*  %s\n",
max
,
İ
[
i
].
Ïb–
,İ[i].
mes§ge
);

1914 
OPT_INT
:

1915 
OPT_FINT
:

1916 
	`årštf
(
”r¡»am
," %s=<š‹g”>%*  %s\n",
İ
[
i
].
Ïb–
,

1917 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-9),"",İ[i].
mes§ge
);

1919 
OPT_DBL
:

1920 
OPT_FDBL
:

1921 
	`årštf
(
”r¡»am
," %s=<»®>%*  %s\n",
İ
[
i
].
Ïb–
,

1922 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-6),"",İ[i].
mes§ge
);

1924 
OPT_STR
:

1925 
OPT_FSTR
:

1926 
	`årštf
(
”r¡»am
," %s=<¡ršg>%*  %s\n",
İ
[
i
].
Ïb–
,

1927 ()(
max
-
	`ËmÚSŒËn
(
İ
[
i
].
Ïb–
)-8),"",İ[i].
mes§ge
);

1931 
	}
}

1938 
	sp¡©e
 {

1939 *
	mf’ame
;

1940 
	mtok’lš’o
;

1941 
	m”rÜút
;

1942 *
	mtok’¡¬t
;

1943 
ËmÚ
 *
	mgp
;

1944 
	ee_¡©e
 {

1945 
	mINITIALIZE
,

1946 
	mWAITING_FOR_DECL_OR_RULE
,

1947 
	mWAITING_FOR_DECL_KEYWORD
,

1948 
	mWAITING_FOR_DECL_ARG
,

1949 
	mWAITING_FOR_PRECEDENCE_SYMBOL
,

1950 
	mWAITING_FOR_ARROW
,

1951 
	mIN_RHS
,

1952 
	mLHS_ALIAS_1
,

1953 
	mLHS_ALIAS_2
,

1954 
	mLHS_ALIAS_3
,

1955 
	mRHS_ALIAS_1
,

1956 
	mRHS_ALIAS_2
,

1957 
	mPRECEDENCE_MARK_1
,

1958 
	mPRECEDENCE_MARK_2
,

1959 
	mRESYNC_AFTER_RULE_ERROR
,

1960 
	mRESYNC_AFTER_DECL_ERROR
,

1961 
	mWAITING_FOR_DESTRUCTOR_SYMBOL
,

1962 
	mWAITING_FOR_DATATYPE_SYMBOL
,

1963 
	mWAITING_FOR_FALLBACK_ID
,

1964 
	mWAITING_FOR_WILDCARD_ID


1965 } 
	m¡©e
;

1966 
symbŞ
 *
	mçÎback
;

1967 
symbŞ
 *
	mlhs
;

1968 *
	mlh§lŸs
;

1969 
	mÄhs
;

1970 
symbŞ
 *
	mrhs
[
MAXRHS
];

1971 *
	m®Ÿs
[
MAXRHS
];

1972 
ruË
 *
	m´evruË
;

1973 *
	mdeşkeywÜd
;

1974 **
	mdeş¬g¦Ù
;

1975 
	mš£¹LšeMaüo
;

1976 *
	mdeşlš’o¦Ù
;

1977 
e_assoc
 
	mdeşassoc
;

1978 
	m´eccouÁ”
;

1979 
ruË
 *
	mfœ¡ruË
;

1980 
ruË
 *
	mÏ¡ruË
;

1984 
	$·r£Ú‘ok’
(
p¥
)

1985 
p¡©e
 *
p¥
;

1987 *
x
;

1988 
x
 = 
	`SŒ§ã
(
p¥
->
tok’¡¬t
);

1990 
	`´štf
("%s:%d: Tok’=[%s] s‹=%d\n",
p¥
->
f’ame
,p¥->
tok’lš’o
,

1991 
x
,
p¥
->
¡©e
);

1993  
p¥
->
¡©e
 ){

1994 
INITIALIZE
:

1995 
p¥
->
´evruË
 = 0;

1996 
p¥
->
´eccouÁ”
 = 0;

1997 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 0;

1998 
p¥
->
gp
->
ÄuË
 = 0;

2000 
WAITING_FOR_DECL_OR_RULE
:

2001 ifĞ
x
[0]=='%' ){

2002 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2003 }ifĞ
	`i¦ow”
(
x
[0]) ){

2004 
p¥
->
lhs
 = 
	`SymbŞ_Ãw
(
x
);

2005 
p¥
->
Ähs
 = 0;

2006 
p¥
->
lh§lŸs
 = 0;

2007 
p¥
->
¡©e
 = 
WAITING_FOR_ARROW
;

2008 }ifĞ
x
[0]=='{' ){

2009 ifĞ
p¥
->
´evruË
==0 ){

2010 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2013 
p¥
->
”rÜút
++;

2014 }ifĞ
p¥
->
´evruË
->
code
!=0 ){

2015 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2018 
p¥
->
”rÜút
++;

2020 
p¥
->
´evruË
->
lše
 =…¥->
tok’lš’o
;

2021 
p¥
->
´evruË
->
code
 = &
x
[1];

2023 }ifĞ
x
[0]=='[' ){

2024 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_1
;

2026 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2028 
x
);

2029 
p¥
->
”rÜút
++;

2032 
PRECEDENCE_MARK_1
:

2033 ifĞ!
	`isuµ”
(
x
[0]) ){

2034 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2036 
p¥
->
”rÜút
++;

2037 }ifĞ
p¥
->
´evruË
==0 ){

2038 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2039 "Th”i nØ´iÜ„uËØassigÀ´eûd’û \"[%s]\".",
x
);

2040 
p¥
->
”rÜút
++;

2041 }ifĞ
p¥
->
´evruË
->
´ecsym
!=0 ){

2042 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2045 
p¥
->
”rÜút
++;

2047 
p¥
->
´evruË
->
´ecsym
 = 
	`SymbŞ_Ãw
(
x
);

2049 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_2
;

2051 
PRECEDENCE_MARK_2
:

2052 ifĞ
x
[0]!=']' ){

2053 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2055 
p¥
->
”rÜút
++;

2057 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2059 
WAITING_FOR_ARROW
:

2060 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2061 
p¥
->
¡©e
 = 
IN_RHS
;

2062 }ifĞ
x
[0]=='(' ){

2063 
p¥
->
¡©e
 = 
LHS_ALIAS_1
;

2065 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2067 
p¥
->
lhs
->
Çme
);

2068 
p¥
->
”rÜút
++;

2069 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2072 
LHS_ALIAS_1
:

2073 ifĞ
	`i§Íha
(
x
[0]) ){

2074 
p¥
->
lh§lŸs
 = 
x
;

2075 
p¥
->
¡©e
 = 
LHS_ALIAS_2
;

2077 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2079 
x
,
p¥
->
lhs
->
Çme
);

2080 
p¥
->
”rÜút
++;

2081 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2084 
LHS_ALIAS_2
:

2085 ifĞ
x
[0]==')' ){

2086 
p¥
->
¡©e
 = 
LHS_ALIAS_3
;

2088 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2089 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2090 
p¥
->
”rÜút
++;

2091 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2094 
LHS_ALIAS_3
:

2095 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2096 
p¥
->
¡©e
 = 
IN_RHS
;

2098 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2100 
p¥
->
lhs
->
Çme
,p¥->
lh§lŸs
);

2101 
p¥
->
”rÜút
++;

2102 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2105 
IN_RHS
:

2106 ifĞ
x
[0]=='.' ){

2107 
ruË
 *
½
;

2108 
½
 = (
ruË
 *)
	`ÿÎoc
( (rule) +

2109 (
symbŞ
*)*
p¥
->
Ähs
 + (*)*psp->nrhs, 1);

2110 ifĞ
½
==0 ){

2111 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2113 
p¥
->
”rÜút
++;

2114 
p¥
->
´evruË
 = 0;

2116 
i
;

2117 
½
->
ruËlše
 = 
p¥
->
tok’lš’o
;

2118 
½
->
rhs
 = (
symbŞ
**)&rp[1];

2119 
½
->
rh§lŸs
 = (**)&Ôp->
rhs
[
p¥
->
Ähs
]);

2120 
i
=0; i<
p¥
->
Ähs
; i++){

2121 
½
->
rhs
[
i
] = 
p¥
->rhs[i];

2122 
½
->
rh§lŸs
[
i
] = 
p¥
->
®Ÿs
[i];

2124 
½
->
lhs
 = 
p¥
->lhs;

2125 
½
->
lh§lŸs
 = 
p¥
->lhsalias;

2126 
½
->
Ähs
 = 
p¥
->nrhs;

2127 
½
->
code
 = 0;

2128 
½
->
´ecsym
 = 0;

2129 
½
->
šdex
 = 
p¥
->
gp
->
ÄuË
++;

2130 
½
->
Ãxhs
 =„p->
lhs
->
ruË
;

2131 
½
->
lhs
->
ruË
 =„p;

2132 
½
->
Ãxt
 = 0;

2133 ifĞ
p¥
->
fœ¡ruË
==0 ){

2134 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 
½
;

2136 
p¥
->
Ï¡ruË
->
Ãxt
 = 
½
;

2137 
p¥
->
Ï¡ruË
 = 
½
;

2139 
p¥
->
´evruË
 = 
½
;

2141 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2142 }ifĞ
	`i§Íha
(
x
[0]) ){

2143 ifĞ
p¥
->
Ähs
>=
MAXRHS
 ){

2144 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2146 
x
);

2147 
p¥
->
”rÜút
++;

2148 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2150 
p¥
->
rhs
[p¥->
Ähs
] = 
	`SymbŞ_Ãw
(
x
);

2151 
p¥
->
®Ÿs
[p¥->
Ähs
] = 0;

2152 
p¥
->
Ähs
++;

2154 }ifĞ(
x
[0]=='|' || x[0]=='/'è&& 
p¥
->
Ähs
>0 ){

2155 
symbŞ
 *
m¥
 = 
p¥
->
rhs
[p¥->
Ähs
-1];

2156 ifĞ
m¥
->
ty³
!=
MULTITERMINAL
 ){

2157 
symbŞ
 *
Üig¥
 = 
m¥
;

2158 
m¥
 = 
	`ÿÎoc
(1,(*msp));

2159 
	`mem£t
(
m¥
, 0, (*msp));

2160 
m¥
->
ty³
 = 
MULTITERMINAL
;

2161 
m¥
->
nsubsym
 = 1;

2162 
m¥
->
subsym
 = 
	`ÿÎoc
(1,(
symbŞ
*));

2163 
m¥
->
subsym
[0] = 
Üig¥
;

2164 
m¥
->
Çme
 = 
Üig¥
->name;

2165 
p¥
->
rhs
[p¥->
Ähs
-1] = 
m¥
;

2167 
m¥
->
nsubsym
++;

2168 
m¥
->
subsym
 = 
	`»®loc
(m¥->subsym, (
symbŞ
*)*m¥->
nsubsym
);

2169 
m¥
->
subsym
[m¥->
nsubsym
-1] = 
	`SymbŞ_Ãw
(&
x
[1]);

2170 ifĞ
	`i¦ow”
(
x
[1]è|| i¦ow”(
m¥
->
subsym
[0]->
Çme
[0]) ){

2171 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2173 
p¥
->
”rÜút
++;

2175 }ifĞ
x
[0]=='(' && 
p¥
->
Ähs
>0 ){

2176 
p¥
->
¡©e
 = 
RHS_ALIAS_1
;

2178 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2179 "IÎeg® ch¬aù” oÀRHS oàruË: \"%s\".",
x
);

2180 
p¥
->
”rÜút
++;

2181 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2184 
RHS_ALIAS_1
:

2185 ifĞ
	`i§Íha
(
x
[0]) ){

2186 
p¥
->
®Ÿs
[p¥->
Ähs
-1] = 
x
;

2187 
p¥
->
¡©e
 = 
RHS_ALIAS_2
;

2189 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2191 
x
,
p¥
->
rhs
[p¥->
Ähs
-1]->
Çme
);

2192 
p¥
->
”rÜút
++;

2193 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2196 
RHS_ALIAS_2
:

2197 ifĞ
x
[0]==')' ){

2198 
p¥
->
¡©e
 = 
IN_RHS
;

2200 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2201 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2202 
p¥
->
”rÜút
++;

2203 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2206 
WAITING_FOR_DECL_KEYWORD
:

2207 ifĞ
	`i§Íha
(
x
[0]) ){

2208 
p¥
->
deşkeywÜd
 = 
x
;

2209 
p¥
->
deş¬g¦Ù
 = 0;

2210 
p¥
->
deşlš’o¦Ù
 = 0;

2211 
p¥
->
š£¹LšeMaüo
 = 1;

2212 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2213 ifĞ
	`¡rcmp
(
x
,"name")==0 ){

2214 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
Çme
);

2215 
p¥
->
š£¹LšeMaüo
 = 0;

2216 }ifĞ
	`¡rcmp
(
x
,"include")==0 ){

2217 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
šşude
);

2218 }ifĞ
	`¡rcmp
(
x
,"code")==0 ){

2219 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
exŒacode
);

2220 }ifĞ
	`¡rcmp
(
x
,"token_destructor")==0 ){

2221 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’de¡
;

2222 }ifĞ
	`¡rcmp
(
x
,"default_destructor")==0 ){

2223 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
v¬de¡
;

2224 }ifĞ
	`¡rcmp
(
x
,"token_prefix")==0 ){

2225 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’´efix
;

2226 
p¥
->
š£¹LšeMaüo
 = 0;

2227 }ifĞ
	`¡rcmp
(
x
,"syntax_error")==0 ){

2228 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
”rÜ
);

2229 }ifĞ
	`¡rcmp
(
x
,"parse_accept")==0 ){

2230 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
acû±
);

2231 }ifĞ
	`¡rcmp
(
x
,"parse_failure")==0 ){

2232 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
çu»
);

2233 }ifĞ
	`¡rcmp
(
x
,"stack_overflow")==0 ){

2234 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
ov”æow
);

2235 }ifĞ
	`¡rcmp
(
x
,"extra_argument")==0 ){

2236 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¬g
);

2237 
p¥
->
š£¹LšeMaüo
 = 0;

2238 }ifĞ
	`¡rcmp
(
x
,"token_type")==0 ){

2239 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
tok’ty³
);

2240 
p¥
->
š£¹LšeMaüo
 = 0;

2241 }ifĞ
	`¡rcmp
(
x
,"default_type")==0 ){

2242 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
v¬ty³
);

2243 
p¥
->
š£¹LšeMaüo
 = 0;

2244 }ifĞ
	`¡rcmp
(
x
,"stack_size")==0 ){

2245 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡acksize
);

2246 
p¥
->
š£¹LšeMaüo
 = 0;

2247 }ifĞ
	`¡rcmp
(
x
,"start_symbol")==0 ){

2248 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡¬t
);

2249 
p¥
->
š£¹LšeMaüo
 = 0;

2250 }ifĞ
	`¡rcmp
(
x
,"left")==0 ){

2251 
p¥
->
´eccouÁ”
++;

2252 
p¥
->
deşassoc
 = 
LEFT
;

2253 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2254 }ifĞ
	`¡rcmp
(
x
,"right")==0 ){

2255 
p¥
->
´eccouÁ”
++;

2256 
p¥
->
deşassoc
 = 
RIGHT
;

2257 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2258 }ifĞ
	`¡rcmp
(
x
,"nonassoc")==0 ){

2259 
p¥
->
´eccouÁ”
++;

2260 
p¥
->
deşassoc
 = 
NONE
;

2261 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2262 }ifĞ
	`¡rcmp
(
x
,"destructor")==0 ){

2263 
p¥
->
¡©e
 = 
WAITING_FOR_DESTRUCTOR_SYMBOL
;

2264 }ifĞ
	`¡rcmp
(
x
,"type")==0 ){

2265 
p¥
->
¡©e
 = 
WAITING_FOR_DATATYPE_SYMBOL
;

2266 }ifĞ
	`¡rcmp
(
x
,"fallback")==0 ){

2267 
p¥
->
çÎback
 = 0;

2268 
p¥
->
¡©e
 = 
WAITING_FOR_FALLBACK_ID
;

2269 }ifĞ
	`¡rcmp
(
x
,"wildcard")==0 ){

2270 
p¥
->
¡©e
 = 
WAITING_FOR_WILDCARD_ID
;

2272 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2273 "UnknowÀdeş¬©iÚ keywÜd: \"%%%s\".",
x
);

2274 
p¥
->
”rÜút
++;

2275 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2278 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2279 "IÎeg® deş¬©iÚ keywÜd: \"%s\".",
x
);

2280 
p¥
->
”rÜút
++;

2281 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2284 
WAITING_FOR_DESTRUCTOR_SYMBOL
:

2285 ifĞ!
	`i§Íha
(
x
[0]) ){

2286 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2288 
p¥
->
”rÜút
++;

2289 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2291 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2292 
p¥
->
deş¬g¦Ù
 = &
¥
->
de¡ruùÜ
;

2293 
p¥
->
deşlš’o¦Ù
 = &
¥
->
de¡Lš’o
;

2294 
p¥
->
š£¹LšeMaüo
 = 1;

2295 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2298 
WAITING_FOR_DATATYPE_SYMBOL
:

2299 ifĞ!
	`i§Íha
(
x
[0]) ){

2300 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2302 
p¥
->
”rÜút
++;

2303 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2305 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2306 
p¥
->
deş¬g¦Ù
 = &
¥
->
d©©y³
;

2307 
p¥
->
š£¹LšeMaüo
 = 0;

2308 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2311 
WAITING_FOR_PRECEDENCE_SYMBOL
:

2312 ifĞ
x
[0]=='.' ){

2313 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2314 }ifĞ
	`isuµ”
(
x
[0]) ){

2315 
symbŞ
 *
¥
;

2316 
¥
 = 
	`SymbŞ_Ãw
(
x
);

2317 ifĞ
¥
->
´ec
>=0 ){

2318 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2319 "SymbŞ \"%s\" ha ®»ady bgiv’‡…»ûd’û.",
x
);

2320 
p¥
->
”rÜút
++;

2322 
¥
->
´ec
 = 
p¥
->
´eccouÁ”
;

2323 
¥
->
assoc
 = 
p¥
->
deşassoc
;

2326 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2327 "Cª'ˆassigÀ¨´eûd’ûØ\"%s\".",
x
);

2328 
p¥
->
”rÜút
++;

2331 
WAITING_FOR_DECL_ARG
:

2332 ifĞ
x
[0]=='{' || x[0]=='\"' || 
	`i§Êum
(x[0]) ){

2333 *
zOld
, *
zNew
, *
zBuf
, *
z
;

2334 
nOld
, 
n
, 
nLše
, 
nNew
, 
nBack
;

2335 
addLšeMaüo
;

2336 
zLše
[50];

2337 
zNew
 = 
x
;

2338 ifĞ
zNew
[0]=='"' || zNew[0]=='{' ) zNew++;

2339 
nNew
 = 
	`ËmÚSŒËn
(
zNew
);

2340 ifĞ*
p¥
->
deş¬g¦Ù
 ){

2341 
zOld
 = *
p¥
->
deş¬g¦Ù
;

2343 
zOld
 = "";

2345 
nOld
 = 
	`ËmÚSŒËn
(
zOld
);

2346 
n
 = 
nOld
 + 
nNew
 + 20;

2347 
addLšeMaüo
 = !
p¥
->
gp
->
nŞš’osæag
 &&…¥->
š£¹LšeMaüo
 &&

2348 (
p¥
->
deşlš’o¦Ù
==0 ||…sp->decllinenoslot[0]!=0);

2349 ifĞ
addLšeMaüo
 ){

2350 
z
=
p¥
->
f’ame
, 
nBack
=0; *z; z++){

2351 ifĞ*
z
=='\\' ) 
nBack
++;

2353 
	`¥rštf
(
zLše
, "#lš%d ", 
p¥
->
tok’lš’o
);

2354 
nLše
 = 
	`ËmÚSŒËn
(
zLše
);

2355 
n
 +ğ
nLše
 + 
	`ËmÚSŒËn
(
p¥
->
f’ame
è+ 
nBack
;

2357 *
p¥
->
deş¬g¦Ù
 = 
zBuf
 = 
	`»®loc
(*p¥->deş¬g¦Ù, 
n
);

2358 
zBuf
 +ğ
nOld
;

2359 ifĞ
addLšeMaüo
 ){

2360 ifĞ
nOld
 && 
zBuf
[-1]!='\n' ){

2361 *(
zBuf
++) = '\n';

2363 
	`memıy
(
zBuf
, 
zLše
, 
nLše
);

2364 
zBuf
 +ğ
nLše
;

2365 *(
zBuf
++) = '"';

2366 
z
=
p¥
->
f’ame
; *z; z++){

2367 ifĞ*
z
=='\\' ){

2368 *(
zBuf
++) = '\\';

2370 *(
zBuf
++èğ*
z
;

2372 *(
zBuf
++) = '"';

2373 *(
zBuf
++) = '\n';

2375 ifĞ
p¥
->
deşlš’o¦Ù
 &&…sp->decllinenoslot[0]==0 ){

2376 
p¥
->
deşlš’o¦Ù
[0] =…¥->
tok’lš’o
;

2378 
	`memıy
(
zBuf
, 
zNew
, 
nNew
);

2379 
zBuf
 +ğ
nNew
;

2380 *
zBuf
 = 0;

2381 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2383 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2384 "IÎeg®‡rgum’ˆtØ%%%s: %s",
p¥
->
deşkeywÜd
,
x
);

2385 
p¥
->
”rÜút
++;

2386 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2389 
WAITING_FOR_FALLBACK_ID
:

2390 ifĞ
x
[0]=='.' ){

2391 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2392 }ifĞ!
	`isuµ”
(
x
[0]) ){

2393 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2394 "%%çÎback‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2395 
p¥
->
”rÜút
++;

2397 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2398 ifĞ
p¥
->
çÎback
==0 ){

2399 
p¥
->
çÎback
 = 
¥
;

2400 }ifĞ
¥
->
çÎback
 ){

2401 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2402 "MÜthª oÃ f®lback‡ssigÃdØtok’ %s", 
x
);

2403 
p¥
->
”rÜút
++;

2405 
¥
->
çÎback
 = 
p¥
->fallback;

2406 
p¥
->
gp
->
has_çÎback
 = 1;

2410 
WAITING_FOR_WILDCARD_ID
:

2411 ifĞ
x
[0]=='.' ){

2412 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2413 }ifĞ!
	`isuµ”
(
x
[0]) ){

2414 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2415 "%%wdÿrd‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2416 
p¥
->
”rÜút
++;

2418 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2419 ifĞ
p¥
->
gp
->
wdÿrd
==0 ){

2420 
p¥
->
gp
->
wdÿrd
 = 
¥
;

2422 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2423 "ExŒ¨wdÿrdØtok’: %s", 
x
);

2424 
p¥
->
”rÜút
++;

2428 
RESYNC_AFTER_RULE_ERROR
:

2431 
RESYNC_AFTER_DECL_ERROR
:

2432 ifĞ
x
[0]=='.' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2433 ifĞ
x
[0]=='%' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2436 
	}
}

2443 
	$´•roûss_šput
(*
z
){

2444 
i
, 
j
, 
k
, 
n
;

2445 
exşude
 = 0;

2446 
¡¬t
 = 0;

2447 
lš’o
 = 1;

2448 
¡¬t_lš’o
 = 1;

2449 
i
=0; 
z
[i]; i++){

2450 ifĞ
z
[
i
]=='\n' ) 
lš’o
++;

2451 ifĞ
z
[
i
]!='%' || (i>0 && z[i-1]!='\n') ) ;

2452 ifĞ
	`¡ºcmp
(&
z
[
i
],"%’dif",6)==0 && 
	`is¥aû
(z[i+6]) ){

2453 ifĞ
exşude
 ){

2454 
exşude
--;

2455 ifĞ
exşude
==0 ){

2456 
j
=
¡¬t
; j<
i
; j++èifĞ
z
[j]!='\n' ) z[j] = ' ';

2459 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2460 }ifĞ(
	`¡ºcmp
(&
z
[
i
],"%ifdef",6)==0 && 
	`is¥aû
(z[i+6]))

2461 || (
	`¡ºcmp
(&
z
[
i
],"%iâdef",7)==0 && 
	`is¥aû
(z[i+7])) ){

2462 ifĞ
exşude
 ){

2463 
exşude
++;

2465 
j
=
i
+7; 
	`is¥aû
(
z
[j]); j++){}

2466 
n
=0; 
z
[
j
+n] && !
	`is¥aû
(z[j+n]);‚++){}

2467 
exşude
 = 1;

2468 
k
=0; k<
nDefše
; k++){

2469 ifĞ
	`¡ºcmp
(
azDefše
[
k
],&
z
[
j
],
n
)==0 && 
	`ËmÚSŒËn
(azDefine[k])==n ){

2470 
exşude
 = 0;

2474 ifĞ
z
[
i
+3]=='n' ) 
exşude
 = !exclude;

2475 ifĞ
exşude
 ){

2476 
¡¬t
 = 
i
;

2477 
¡¬t_lš’o
 = 
lš’o
;

2480 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2483 ifĞ
exşude
 ){

2484 
	`årštf
(
¡d”r
,"uÁ”mš©ed %%ifdeà¡¬tšg oÀlš%d\n", 
¡¬t_lš’o
);

2485 
	`ex™
(1);

2487 
	}
}

2494 
	$P¬£
(
gp
)

2495 
ËmÚ
 *
gp
;

2497 
p¡©e
 
ps
;

2498 
FILE
 *
å
;

2499 *
febuf
;

2500 
fesize
;

2501 
lš’o
;

2502 
c
;

2503 *
ı
, *
Ãxtı
;

2504 
¡¬še
 = 0;

2506 
	`mem£t
(&
ps
, '\0', (ps));

2507 
ps
.
gp
 = gp;

2508 
ps
.
f’ame
 = 
gp
->filename;

2509 
ps
.
”rÜút
 = 0;

2510 
ps
.
¡©e
 = 
INITIALIZE
;

2513 
å
 = 
	`fİ’
(
ps
.
f’ame
,"rb");

2514 ifĞ
å
==0 ){

2515 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't openhis file for„eading.");

2516 
gp
->
”rÜút
++;

2519 
	`f£ek
(
å
,0,2);

2520 
fesize
 = 
	`á–l
(
å
);

2521 
	`»wšd
(
å
);

2522 
febuf
 = (*)
	`m®loc
Ğ
fesize
+1 );

2523 ifĞ
febuf
==0 ){

2524 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't‡llocate %d of memoryo holdhis file.",

2525 
fesize
+1);

2526 
gp
->
”rÜút
++;

2529 ifĞ
	`ä—d
(
febuf
,1,
fesize
,
å
)!=filesize ){

2530 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't„ead in‡ll %d bytes ofhis file.",

2531 
fesize
);

2532 
	`ä“
(
febuf
);

2533 
gp
->
”rÜút
++;

2536 
	`fşo£
(
å
);

2537 
febuf
[
fesize
] = 0;

2540 
	`´•roûss_šput
(
febuf
);

2543 
lš’o
 = 1;

2544 
ı
=
febuf
; (
c
= *cp)!=0; ){

2545 ifĞ
c
=='\n' ) 
lš’o
++;

2546 ifĞ
	`is¥aû
(
c
è){ 
ı
++; ; }

2547 ifĞ
c
=='/' && 
ı
[1]=='/' ){

2548 
ı
+=2;

2549  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2552 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2553 
ı
+=2;

2554  (
c
ğ*
ı
)!=0 && (c!='/' || cp[-1]!='*') ){

2555 ifĞ
c
=='\n' ) 
lš’o
++;

2556 
ı
++;

2558 ifĞ
c
 ) 
ı
++;

2561 
ps
.
tok’¡¬t
 = 
ı
;

2562 
ps
.
tok’lš’o
 = 
lš’o
;

2563 ifĞ
c
=='\"' ){

2564 
ı
++;

2565  (
c
ğ*
ı
)!=0 && c!='\"' ){

2566 ifĞ
c
=='\n' ) 
lš’o
++;

2567 
ı
++;

2569 ifĞ
c
==0 ){

2570 
	`E¼ÜMsg
(
ps
.
f’ame
,
¡¬še
,

2572 
ps
.
”rÜút
++;

2573 
Ãxtı
 = 
ı
;

2575 
Ãxtı
 = 
ı
+1;

2577 }ifĞ
c
=='{' ){

2578 
Ëv–
;

2579 
ı
++;

2580 
Ëv–
=1; (
c
ğ*
ı
)!=0 && (level>1 || c!='}'); cp++){

2581 ifĞ
c
=='\n' ) 
lš’o
++;

2582 ifĞ
c
=='{' ) 
Ëv–
++;

2583 ifĞ
c
=='}' ) 
Ëv–
--;

2584 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2585 
´evc
;

2586 
ı
 = &cp[2];

2587 
´evc
 = 0;

2588  (
c
ğ*
ı
)!=0 && (c!='/' || 
´evc
!='*') ){

2589 ifĞ
c
=='\n' ) 
lš’o
++;

2590 
´evc
 = 
c
;

2591 
ı
++;

2593 }ifĞ
c
=='/' && 
ı
[1]=='/' ){

2594 
ı
 = &cp[2];

2595  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2596 ifĞ
c
 ) 
lš’o
++;

2597 }ifĞ
c
=='\'' || c=='\"' ){

2598 
¡¬tch¬
, 
´evc
;

2599 
¡¬tch¬
 = 
c
;

2600 
´evc
 = 0;

2601 
ı
++; (
c
ğ*ı)!=0 && (c!=
¡¬tch¬
 || 
´evc
=='\\'); cp++){

2602 ifĞ
c
=='\n' ) 
lš’o
++;

2603 ifĞ
´evc
=='\\' )…revc = 0;

2604 
´evc
 = 
c
;

2608 ifĞ
c
==0 ){

2609 
	`E¼ÜMsg
(
ps
.
f’ame
,ps.
tok’lš’o
,

2611 
ps
.
”rÜút
++;

2612 
Ãxtı
 = 
ı
;

2614 
Ãxtı
 = 
ı
+1;

2616 }ifĞ
	`i§Êum
(
c
) ){

2617  (
c
ğ*
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2618 
Ãxtı
 = 
ı
;

2619 }ifĞ
c
==':' && 
ı
[1]==':' && cp[2]=='=' ){

2620 
ı
 += 3;

2621 
Ãxtı
 = 
ı
;

2622 }ifĞ(
c
=='/' || c=='|'è&& 
	`i§Íha
(
ı
[1]) ){

2623 
ı
 += 2;

2624  (
c
 = *
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2625 
Ãxtı
 = 
ı
;

2627 
ı
++;

2628 
Ãxtı
 = 
ı
;

2630 
c
 = *
ı
;

2631 *
ı
 = 0;

2632 
	`·r£Ú‘ok’
(&
ps
);

2633 *
ı
 = 
c
;

2634 
ı
 = 
Ãxtı
;

2636 
	`ä“
(
febuf
);

2637 
gp
->
ruË
 = 
ps
.
fœ¡ruË
;

2638 
gp
->
”rÜút
 = 
ps
.errorcnt;

2639 
	}
}

2645 
¶šk
 *
	g¶šk_ä“li¡
 = 0;

2648 
¶šk
 *
	$Plšk_Ãw
(){

2649 
¶šk
 *
Ãw
;

2651 ifĞ
¶šk_ä“li¡
==0 ){

2652 
i
;

2653 
amt
 = 100;

2654 
¶šk_ä“li¡
 = (
¶šk
 *)
	`ÿÎoc
Ğ
amt
, (plink) );

2655 ifĞ
¶šk_ä“li¡
==0 ){

2656 
	`årštf
(
¡d”r
,

2658 
	`ex™
(1);

2660 
i
=0; i<
amt
-1; i++è
¶šk_ä“li¡
[i].
Ãxt
 = &plink_freelist[i+1];

2661 
¶šk_ä“li¡
[
amt
-1].
Ãxt
 = 0;

2663 
Ãw
 = 
¶šk_ä“li¡
;

2664 
¶šk_ä“li¡
 =…lšk_ä“li¡->
Ãxt
;

2665  
Ãw
;

2666 
	}
}

2669 
	$Plšk_add
(
¶µ
,
cå
)

2670 
¶šk
 **
¶µ
;

2671 
cÚfig
 *
cå
;

2673 
¶šk
 *
Ãw
;

2674 
Ãw
 = 
	`Plšk_Ãw
();

2675 
Ãw
->
Ãxt
 = *
¶µ
;

2676 *
¶µ
 = 
Ãw
;

2677 
Ãw
->
cå
 = cfp;

2678 
	}
}

2681 
	$Plšk_cİy
(
to
,
äom
)

2682 
¶šk
 **
to
;

2683 
¶šk
 *
äom
;

2685 
¶šk
 *
Ãxl
;

2686  
äom
 ){

2687 
Ãxl
 = 
äom
->
Ãxt
;

2688 
äom
->
Ãxt
 = *
to
;

2689 *
to
 = 
äom
;

2690 
äom
 = 
Ãxl
;

2692 
	}
}

2695 
	$Plšk_d–‘e
(
¶p
)

2696 
¶šk
 *
¶p
;

2698 
¶šk
 *
Ãxl
;

2700  
¶p
 ){

2701 
Ãxl
 = 
¶p
->
Ãxt
;

2702 
¶p
->
Ãxt
 = 
¶šk_ä“li¡
;

2703 
¶šk_ä“li¡
 = 
¶p
;

2704 
¶p
 = 
Ãxl
;

2706 
	}
}

2716 
PRIVATE
 *
	$fe_mak’ame
(
Ëmp
,
suffix
)

2717 
ËmÚ
 *
Ëmp
;

2718 *
suffix
;

2720 *
Çme
;

2721 *
ı
;

2723 
Çme
 = 
	`m®loc
Ğ
	`ËmÚSŒËn
(
Ëmp
->
f’ame
è+†emÚSŒËn(
suffix
) + 5 );

2724 ifĞ
Çme
==0 ){

2725 
	`årštf
(
¡d”r
,"Can't‡llocate space for‡ filename.\n");

2726 
	`ex™
(1);

2728 
	`¡rıy
(
Çme
,
Ëmp
->
f’ame
);

2729 
ı
 = 
	`¡¼chr
(
Çme
,'.');

2730 ifĞ
ı
 ) *cp = 0;

2731 
	`¡rÿt
(
Çme
,
suffix
);

2732  
Çme
;

2733 
	}
}

2738 
PRIVATE
 
FILE
 *
	$fe_İ’
(
Ëmp
,
suffix
,
mode
)

2739 
ËmÚ
 *
Ëmp
;

2740 *
suffix
;

2741 *
mode
;

2743 
FILE
 *
å
;

2745 ifĞ
Ëmp
->
ouŠame
 ) 
	`ä“
(lemp->outname);

2746 
Ëmp
->
ouŠame
 = 
	`fe_mak’ame
Öemp, 
suffix
);

2747 
å
 = 
	`fİ’
(
Ëmp
->
ouŠame
,
mode
);

2748 ifĞ
å
==0 && *
mode
=='w' ){

2749 
	`årštf
(
¡d”r
,"Cª'ˆİ’ f\"%s\".\n",
Ëmp
->
ouŠame
);

2750 
Ëmp
->
”rÜút
++;

2753  
å
;

2754 
	}
}

2758 
	$R•ršt
(
Ëmp
)

2759 
ËmÚ
 *
Ëmp
;

2761 
ruË
 *
½
;

2762 
symbŞ
 *
¥
;

2763 
i
, 
j
, 
maxËn
, 
Ën
, 
ncŞumns
, 
sk
;

2764 
	`´štf
("// R•ršˆoàšpuˆf\"%s\".\n// SymbŞs:\n",
Ëmp
->
f’ame
);

2765 
maxËn
 = 10;

2766 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2767 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2768 
Ën
 = 
	`ËmÚSŒËn
(
¥
->
Çme
);

2769 ifĞ
Ën
>
maxËn
 ) maxlen =†en;

2771 
ncŞumns
 = 76/(
maxËn
+5);

2772 ifĞ
ncŞumns
<1 )‚columns = 1;

2773 
sk
 = (
Ëmp
->
nsymbŞ
 + 
ncŞumns
 - 1)/ncolumns;

2774 
i
=0; i<
sk
; i++){

2775 
	`´štf
("//");

2776 
j
=
i
; j<
Ëmp
->
nsymbŞ
; j+=
sk
){

2777 
¥
 = 
Ëmp
->
symbŞs
[
j
];

2778 
	`as£¹
Ğ
¥
->
šdex
==
j
 );

2779 
	`´štf
(" %3d %-*.*s",
j
,
maxËn
,maxËn,
¥
->
Çme
);

2781 
	`´štf
("\n");

2783 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

2784 
	`´štf
("%s",
½
->
lhs
->
Çme
);

2786 
	`´štf
(" ::=");

2787 
i
=0; i<
½
->
Ähs
; i++){

2788 
¥
 = 
½
->
rhs
[
i
];

2789 
	`´štf
(" %s", 
¥
->
Çme
);

2790 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

2791 
j
=1; j<
¥
->
nsubsym
; j++){

2792 
	`´štf
("|%s", 
¥
->
subsym
[
j
]->
Çme
);

2797 
	`´štf
(".");

2798 ifĞ
½
->
´ecsym
 ) 
	`´štf
(" [%s]",½->´ecsym->
Çme
);

2800 
	`´štf
("\n");

2802 
	}
}

2804 
	$CÚfigPršt
(
å
,
cå
)

2805 
FILE
 *
å
;

2806 
cÚfig
 *
cå
;

2808 
ruË
 *
½
;

2809 
symbŞ
 *
¥
;

2810 
i
, 
j
;

2811 
½
 = 
cå
->rp;

2812 
	`årštf
(
å
,"% ::=",
½
->
lhs
->
Çme
);

2813 
i
=0; i<=
½
->
Ähs
; i++){

2814 ifĞ
i
==
cå
->
dÙ
 ) 
	`årštf
(
å
," *");

2815 ifĞ
i
==
½
->
Ähs
 ) ;

2816 
¥
 = 
½
->
rhs
[
i
];

2817 
	`årštf
(
å
," %s", 
¥
->
Çme
);

2818 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

2819 
j
=1; j<
¥
->
nsubsym
; j++){

2820 
	`årštf
(
å
,"|%s",
¥
->
subsym
[
j
]->
Çme
);

2824 
	}
}

2829 
PRIVATE
 
	$S‘Pršt
(
out
,
£t
,
Ëmp
)

2830 
FILE
 *
out
;

2831 *
£t
;

2832 
ËmÚ
 *
Ëmp
;

2834 
i
;

2835 *
¥aûr
;

2836 
¥aûr
 = "";

2837 
	`årštf
(
out
,"%12s[","");

2838 
i
=0; i<
Ëmp
->
Á”mš®
; i++){

2839 ifĞ
	`S‘Fšd
(
£t
,
i
) ){

2840 
	`årštf
(
out
,"%s%s",
¥aûr
,
Ëmp
->
symbŞs
[
i
]->
Çme
);

2841 
¥aûr
 = " ";

2844 
	`årštf
(
out
,"]\n");

2845 
	}
}

2848 
PRIVATE
 
	$PlškPršt
(
out
,
¶p
,
g
)

2849 
FILE
 *
out
;

2850 
¶šk
 *
¶p
;

2851 *
g
;

2853  
¶p
 ){

2854 
	`årštf
(
out
,"%12s% (¡©%2dè","",
g
,
¶p
->
cå
->
¡p
->
¡©’um
);

2855 
	`CÚfigPršt
(
out
,
¶p
->
cå
);

2856 
	`årštf
(
out
,"\n");

2857 
¶p
 =…Í->
Ãxt
;

2859 
	}
}

2865 
	$PrštAùiÚ
(
aùiÚ
 *
­
, 
FILE
 *
å
, 
šd’t
){

2866 
»suÉ
 = 1;

2867  
­
->
ty³
 ){

2868 
SHIFT
:

2869 
	`årštf
(
å
,"%* shiá %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
¡©’um
);

2871 
REDUCE
:

2872 
	`årštf
(
å
,"%* »duû %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2874 
ACCEPT
:

2875 
	`årštf
(
å
,"%* acû±",
šd’t
,
­
->
¥
->
Çme
);

2877 
ERROR
:

2878 
	`årštf
(
å
,"%* ”rÜ",
šd’t
,
­
->
¥
->
Çme
);

2880 
SRCONFLICT
:

2881 
RRCONFLICT
:

2882 
	`årštf
(
å
,"%*s„educe %-3d ** Parsing conflict **",

2883 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2885 
SSCONFLICT
:

2886 
	`årštf
(
å
,"%*s shift %d ** Parsing conflict **",

2887 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
¡©’um
);

2889 
SH_RESOLVED
:

2890 
RD_RESOLVED
:

2891 
NOT_USED
:

2892 
»suÉ
 = 0;

2895  
»suÉ
;

2896 
	}
}

2899 
	$R•ÜtOuut
(
Ëmp
)

2900 
ËmÚ
 *
Ëmp
;

2902 
i
;

2903 
¡©e
 *
¡p
;

2904 
cÚfig
 *
cå
;

2905 
aùiÚ
 *
­
;

2906 
FILE
 *
å
;

2908 
å
 = 
	`fe_İ’
(
Ëmp
,".out","wb");

2909 ifĞ
å
==0 ) ;

2910 
i
=0; i<
Ëmp
->
n¡©e
; i++){

2911 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

2912 
	`årštf
(
å
,"S‹ %d:\n",
¡p
->
¡©’um
);

2913 ifĞ
Ëmp
->
basisæag
 ) 
cå
=
¡p
->
bp
;

2914 
cå
=
¡p
->cfp;

2915  
cå
 ){

2916 
buf
[20];

2917 ifĞ
cå
->
dÙ
==cå->
½
->
Ähs
 ){

2918 
	`¥rštf
(
buf
,"(%d)",
cå
->
½
->
šdex
);

2919 
	`årštf
(
å
," %5 ",
buf
);

2921 
	`årštf
(
å
," ");

2923 
	`CÚfigPršt
(
å
,
cå
);

2924 
	`årštf
(
å
,"\n");

2926 
	`S‘Pršt
(
å
,
cå
->
fws
,
Ëmp
);

2927 
	`PlškPršt
(
å
,
cå
->
åÍ
,"To ");

2928 
	`PlškPršt
(
å
,
cå
->
b¶p
,"From");

2930 ifĞ
Ëmp
->
basisæag
 ) 
cå
=cå->
bp
;

2931 
cå
=cå->
Ãxt
;

2933 
	`årštf
(
å
,"\n");

2934 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

2935 ifĞ
	`PrštAùiÚ
(
­
,
å
,30èè
	`årštf
(fp,"\n");

2937 
	`årštf
(
å
,"\n");

2939 
	`årštf
(
å
, "----------------------------------------------------\n");

2940 
	`årštf
(
å
, "Symbols:\n");

2941 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2942 
j
;

2943 
symbŞ
 *
¥
;

2945 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2946 
	`årštf
(
å
, " %3d: %s", 
i
, 
¥
->
Çme
);

2947 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

2948 
	`årštf
(
å
, ":");

2949 ifĞ
¥
->
Ïmbda
 ){

2950 
	`årštf
(
å
, " <lambda>");

2952 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

2953 ifĞ
¥
->
fœ¡£t
 && 
	`S‘Fšd
(¥->fœ¡£t, 
j
) ){

2954 
	`årštf
(
å
, " %s", 
Ëmp
->
symbŞs
[
j
]->
Çme
);

2958 
	`årštf
(
å
, "\n");

2960 
	`fşo£
(
å
);

2962 
	}
}

2966 
PRIVATE
 *
	$·th£¬ch
(
¬gv0
,
Çme
,
modemask
)

2967 *
¬gv0
;

2968 *
Çme
;

2969 
modemask
;

2971 *
·thli¡
;

2972 *
·th
,*
ı
;

2973 
c
;

2975 #ifdeà
__WIN32__


2976 
ı
 = 
	`¡¼chr
(
¬gv0
,'\\');

2978 
ı
 = 
	`¡¼chr
(
¬gv0
,'/');

2980 ifĞ
ı
 ){

2981 
c
 = *
ı
;

2982 *
ı
 = 0;

2983 
·th
 = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
¬gv0
è+†emÚSŒËn(
Çme
) + 2 );

2984 ifĞ
·th
 ) 
	`¥rštf
Õ©h,"%s/%s",
¬gv0
,
Çme
);

2985 *
ı
 = 
c
;

2987 *
	`g‘’v
();

2988 
·thli¡
 = 
	`g‘’v
("PATH");

2989 ifĞ
·thli¡
==0 )…athlist = ".:/bin:/usr/bin";

2990 
·th
 = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
·thli¡
)+ËmÚSŒËn(
Çme
)+2 );

2991 ifĞ
·th
!=0 ){

2992  *
·thli¡
 ){

2993 
ı
 = 
	`¡rchr
(
·thli¡
,':');

2994 ifĞ
ı
==0 ) c°ğ&
·thli¡
[
	`ËmÚSŒËn
(pathlist)];

2995 
c
 = *
ı
;

2996 *
ı
 = 0;

2997 
	`¥rštf
(
·th
,"%s/%s",
·thli¡
,
Çme
);

2998 *
ı
 = 
c
;

2999 ifĞ
c
==0 ) 
·thli¡
 = "";

3000 
·thli¡
 = &
ı
[1];

3001 ifĞ
	`acûss
(
·th
,
modemask
)==0 ) ;

3005  
·th
;

3006 
	}
}

3012 
PRIVATE
 
	$compu‹_aùiÚ
(
Ëmp
,
­
)

3013 
ËmÚ
 *
Ëmp
;

3014 
aùiÚ
 *
­
;

3016 
aù
;

3017  
­
->
ty³
 ){

3018 
SHIFT
: 
aù
 = 
­
->
x
.
¡p
->
¡©’um
; ;

3019 
REDUCE
: 
aù
 = 
­
->
x
.
½
->
šdex
 + 
Ëmp
->
n¡©e
; ;

3020 
ERROR
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
; ;

3021 
ACCEPT
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 1; ;

3022 : 
aù
 = -1; ;

3024  
aù
;

3025 
	}
}

3027 
	#LINESIZE
 1000

	)

3037 
PRIVATE
 
	$É_xãr
(
Çme
,
š
,
out
,
lš’o
)

3038 *
Çme
;

3039 
FILE
 *
š
;

3040 
FILE
 *
out
;

3041 *
lš’o
;

3043 
i
, 
iS¹
;

3044 
lše
[
LINESIZE
];

3045  
	`fg‘s
(
lše
,
LINESIZE
,
š
) && (line[0]!='%' ||†ine[1]!='%') ){

3046 (*
lš’o
)++;

3047 
iS¹
 = 0;

3048 ifĞ
Çme
 ){

3049 
i
=0; 
lše
[i]; i++){

3050 ifĞ
lše
[
i
]=='P' && 
	`¡ºcmp
(&line[i],"Parse",5)==0

3051 && (
i
==0 || !
	`i§Íha
(
lše
[i-1]))

3053 ifĞ
i
>
iS¹
 ) 
	`årštf
(
out
,"%.*s",i-iS¹,&
lše
[iStart]);

3054 
	`årštf
(
out
,"%s",
Çme
);

3055 
i
 += 4;

3056 
iS¹
 = 
i
+1;

3060 
	`årštf
(
out
,"%s",&
lše
[
iS¹
]);

3062 
	}
}

3066 
PRIVATE
 
FILE
 *
	$É_İ’
(
Ëmp
)

3067 
ËmÚ
 *
Ëmp
;

3069 
‹m¶©’ame
[] = "lempar.c";

3070 
buf
[1000];

3071 
FILE
 *
š
;

3072 *
ÉÇme
;

3073 *
ı
;

3075 
ı
 = 
	`¡¼chr
(
Ëmp
->
f’ame
,'.');

3076 ifĞ
ı
 ){

3077 
	`¥rštf
(
buf
,"%.*s.É",()(
ı
-
Ëmp
->
f’ame
),lemp->filename);

3079 
	`¥rštf
(
buf
,"%s.É",
Ëmp
->
f’ame
);

3081 ifĞ
	`acûss
(
buf
,004)==0 ){

3082 
ÉÇme
 = 
buf
;

3083 }ifĞ
	`acûss
(
‹m¶©’ame
,004)==0 ){

3084 
ÉÇme
 = 
‹m¶©’ame
;

3086 
ÉÇme
 = 
	`·th£¬ch
(
Ëmp
->
¬gv0
,
‹m¶©’ame
,0);

3088 ifĞ
ÉÇme
==0 ){

3089 
	`årštf
(
¡d”r
,"Can't findhe…arser driveremplate file \"%s\".\n",

3090 
‹m¶©’ame
);

3091 
Ëmp
->
”rÜút
++;

3094 
š
 = 
	`fİ’
(
ÉÇme
,"rb");

3095 ifĞ
š
==0 ){

3096 
	`årštf
(
¡d”r
,"Cª'ˆİ’h‹m¶©f\"%s\".\n",
‹m¶©’ame
);

3097 
Ëmp
->
”rÜút
++;

3100  
š
;

3101 
	}
}

3104 
PRIVATE
 
	$É_lšedœ
(
out
,
lš’o
,
f’ame
)

3105 
FILE
 *
out
;

3106 
lš’o
;

3107 *
f’ame
;

3109 
	`årštf
(
out
,"#lš%d \"",
lš’o
);

3110  *
f’ame
 ){

3111 ifĞ*
f’ame
 =ğ'\\' ) 
	`putc
('\\',
out
);

3112 
	`putc
(*
f’ame
,
out
);

3113 
f’ame
++;

3115 
	`årštf
(
out
,"\"\n");

3116 
	}
}

3119 
PRIVATE
 
	$É_´št
(
out
,
Ëmp
,
¡r
,
lš’o
)

3120 
FILE
 *
out
;

3121 
ËmÚ
 *
Ëmp
;

3122 *
¡r
;

3123 *
lš’o
;

3125 ifĞ
¡r
==0 ) ;

3126  *
¡r
 ){

3127 
	`putc
(*
¡r
,
out
);

3128 ifĞ*
¡r
=='\n' ) (*
lš’o
)++;

3129 
¡r
++;

3131 ifĞ
¡r
[-1]!='\n' ){

3132 
	`putc
('\n',
out
);

3133 (*
lš’o
)++;

3135 ià(!
Ëmp
->
nŞš’osæag
) {

3136 (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,
Ëmp
->
ouŠame
);

3139 
	}
}

3145 
	$em™_de¡ruùÜ_code
(
out
,
¥
,
Ëmp
,
lš’o
)

3146 
FILE
 *
out
;

3147 
symbŞ
 *
¥
;

3148 
ËmÚ
 *
Ëmp
;

3149 *
lš’o
;

3151 *
ı
 = 0;

3153 ifĞ
¥
->
ty³
==
TERMINAL
 ){

3154 
ı
 = 
Ëmp
->
tok’de¡
;

3155 ifĞ
ı
==0 ) ;

3156 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3157 }ifĞ
¥
->
de¡ruùÜ
 ){

3158 
ı
 = 
¥
->
de¡ruùÜ
;

3159 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3160 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,
¥
->
de¡Lš’o
,Ëmp->
f’ame
); }

3161 }ifĞ
Ëmp
->
v¬de¡
 ){

3162 
ı
 = 
Ëmp
->
v¬de¡
;

3163 ifĞ
ı
==0 ) ;

3164 
	`årštf
(
out
,"{\n"); (*
lš’o
)++;

3166 
	`as£¹
( 0 );

3168 ; *
ı
; cp++){

3169 ifĞ*
ı
=='$' && cp[1]=='$' ){

3170 
	`årštf
(
out
,"(yypmšÜ->yy%d)",
¥
->
dŠum
);

3171 
ı
++;

3174 ifĞ*
ı
=='\n' ) (*
lš’o
)++;

3175 
	`åutc
(*
ı
,
out
);

3177 
	`årštf
(
out
,"\n"); (*
lš’o
)++;

3178 ià(!
Ëmp
->
nŞš’osæag
) {

3179 (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,
Ëmp
->
ouŠame
);

3181 
	`årštf
(
out
,"}\n"); (*
lš’o
)++;

3183 
	}
}

3188 
	$has_de¡ruùÜ
(
¥
, 
Ëmp
)

3189 
symbŞ
 *
¥
;

3190 
ËmÚ
 *
Ëmp
;

3192 
»t
;

3193 ifĞ
¥
->
ty³
==
TERMINAL
 ){

3194 
»t
 = 
Ëmp
->
tok’de¡
!=0;

3196 
»t
 = 
Ëmp
->
v¬de¡
!=0 || 
¥
->
de¡ruùÜ
!=0;

3198  
»t
;

3199 
	}
}

3213 
PRIVATE
 *
	$­³nd_¡r
(*
zText
, 
n
, 
p1
, 
p2
){

3214 *
z
 = 0;

3215 
®loûd
 = 0;

3216 
u£d
 = 0;

3217 
c
;

3218 
zIÁ
[40];

3220 ifĞ
zText
==0 ){

3221 
u£d
 = 0;

3222  
z
;

3224 ifĞ
n
<=0 ){

3225 ifĞ
n
<0 ){

3226 
u£d
 +ğ
n
;

3227 
	`as£¹
Ğ
u£d
>=0 );

3229 
n
 = 
	`ËmÚSŒËn
(
zText
);

3231 ifĞ
n
+(
zIÁ
)*2+
u£d
 >ğ
®loûd
 ){

3232 
®loûd
 = 
n
 + (
zIÁ
)*2 + 
u£d
 + 200;

3233 
z
 = 
	`»®loc
(z, 
®loûd
);

3235 ifĞ
z
==0 )  "";

3236  
n
-- > 0 ){

3237 
c
 = *(
zText
++);

3238 ifĞ
c
=='%' && 
n
>0 && 
zText
[0]=='d' ){

3239 
	`¥rštf
(
zIÁ
, "%d", 
p1
);

3240 
p1
 = 
p2
;

3241 
	`¡rıy
(&
z
[
u£d
], 
zIÁ
);

3242 
u£d
 +ğ
	`ËmÚSŒËn
(&
z
[used]);

3243 
zText
++;

3244 
n
--;

3246 
z
[
u£d
++] = 
c
;

3249 
z
[
u£d
] = 0;

3250  
z
;

3251 
	}
}

3258 
PRIVATE
 
	$Œª¦©e_code
(
ËmÚ
 *
Ëmp
, 
ruË
 *
½
){

3259 *
ı
, *
xp
;

3260 
i
;

3261 
lhsu£d
 = 0;

3262 
u£d
[
MAXRHS
];

3264 
i
=0; i<
½
->
Ähs
; i++è
u£d
[i] = 0;

3265 
lhsu£d
 = 0;

3267 ifĞ
½
->
code
==0 ){

3268 
½
->
code
 = "\n";

3269 
½
->
lše
 =„p->
ruËlše
;

3272 
	`­³nd_¡r
(0,0,0,0);

3273 
ı
=
½
->
code
; *cp; cp++){

3274 ifĞ
	`i§Íha
(*
ı
è&& (ı==
½
->
code
 || (!
	`i§Êum
(cp[-1]) && cp[-1]!='_')) ){

3275 
§ved
;

3276 
xp
ğ&
ı
[1]; 
	`i§Êum
(*xp) || *xp=='_'; xp++);

3277 
§ved
 = *
xp
;

3278 *
xp
 = 0;

3279 ifĞ
½
->
lh§lŸs
 && 
	`¡rcmp
(
ı
,rp->lhsalias)==0 ){

3280 
	`­³nd_¡r
("yygÙomšÜ.yy%d",0,
½
->
lhs
->
dŠum
,0);

3281 
ı
 = 
xp
;

3282 
lhsu£d
 = 1;

3284 
i
=0; i<
½
->
Ähs
; i++){

3285 ifĞ
½
->
rh§lŸs
[
i
] && 
	`¡rcmp
(
ı
,rp->rhsalias[i])==0 ){

3286 ifĞ
ı
!=
½
->
code
 && cp[-1]=='@' ){

3289 
	`­³nd_¡r
("yym¥[%d].majÜ",-1,
i
-
½
->
Ähs
+1,0);

3291 
symbŞ
 *
¥
 = 
½
->
rhs
[
i
];

3292 
dŠum
;

3293 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

3294 
dŠum
 = 
¥
->
subsym
[0]->dtnum;

3296 
dŠum
 = 
¥
->dtnum;

3298 
	`­³nd_¡r
("yym¥[%d].mšÜ.yy%d",0,
i
-
½
->
Ähs
+1, 
dŠum
);

3300 
ı
 = 
xp
;

3301 
u£d
[
i
] = 1;

3306 *
xp
 = 
§ved
;

3308 
	`­³nd_¡r
(
ı
, 1, 0, 0);

3312 ifĞ
½
->
lh§lŸs
 && !
lhsu£d
 ){

3313 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3315 
½
->
lh§lŸs
,½->
lhs
->
Çme
,rp->lhsalias);

3316 
Ëmp
->
”rÜút
++;

3321 
i
=0; i<
½
->
Ähs
; i++){

3322 ifĞ
½
->
rh§lŸs
[
i
] && !
u£d
[i] ){

3323 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3325 
½
->
rh§lŸs
[
i
],½->
rhs
[i]->
Çme
,rp->rhsalias[i]);

3326 
Ëmp
->
”rÜút
++;

3327 }ifĞ
½
->
rh§lŸs
[
i
]==0 ){

3328 ifĞ
	`has_de¡ruùÜ
(
½
->
rhs
[
i
],
Ëmp
) ){

3329 
	`­³nd_¡r
(" yy_destructor(yypParser,%d,&yymsp[%d].minor);\n", 0,

3330 
½
->
rhs
[
i
]->
šdex
,i-½->
Ähs
+1);

3336 ifĞ
½
->
code
 ){

3337 
ı
 = 
	`­³nd_¡r
(0,0,0,0);

3338 
½
->
code
 = 
	`SŒ§ã
(
ı
?cp:"");

3340 
	}
}

3346 
PRIVATE
 
	$em™_code
(
out
,
½
,
Ëmp
,
lš’o
)

3347 
FILE
 *
out
;

3348 
ruË
 *
½
;

3349 
ËmÚ
 *
Ëmp
;

3350 *
lš’o
;

3352 *
ı
;

3355 ifĞ
½
->
code
 ){

3356 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,
½
->
lše
,Ëmp->
f’ame
); }

3357 
	`årštf
(
out
,"{%s",
½
->
code
);

3358 
ı
=
½
->
code
; *cp; cp++){

3359 ifĞ*
ı
=='\n' ) (*
lš’o
)++;

3361 
	`årštf
(
out
,"}\n"); (*
lš’o
)++;

3362 ià(!
Ëmp
->
nŞš’osæag
è{ (*
lš’o
)++; 
	`É_lšedœ
(
out
,*lš’o,Ëmp->
ouŠame
); }

3366 
	}
}

3375 
	$´št_¡ack_uniÚ
(
out
,
Ëmp
,
¶š’o
,
mhæag
)

3376 
FILE
 *
out
;

3377 
ËmÚ
 *
Ëmp
;

3378 *
¶š’o
;

3379 
mhæag
;

3381 
lš’o
 = *
¶š’o
;

3382 **
ty³s
;

3383 
¬¿ysize
;

3384 
maxd’gth
;

3385 *
¡ddt
;

3386 
i
,
j
;

3387 
hash
;

3388 *
Çme
;

3391 
¬¿ysize
 = 
Ëmp
->
nsymbŞ
 * 2;

3392 
ty³s
 = (**)
	`ÿÎoc
Ğ
¬¿ysize
, (*) );

3393 
i
=0; i<
¬¿ysize
; i++è
ty³s
[i] = 0;

3394 
maxd’gth
 = 0;

3395 ifĞ
Ëmp
->
v¬ty³
 ){

3396 
maxd’gth
 = 
	`ËmÚSŒËn
(
Ëmp
->
v¬ty³
);

3398 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3399 
Ën
;

3400 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3401 ifĞ
¥
->
d©©y³
==0 ) ;

3402 
Ën
 = 
	`ËmÚSŒËn
(
¥
->
d©©y³
);

3403 ifĞ
Ën
>
maxd’gth
 ) maxdtlength =†en;

3405 
¡ddt
 = (*)
	`m®loc
Ğ
maxd’gth
*2 + 1 );

3406 ifĞ
ty³s
==0 || 
¡ddt
==0 ){

3407 
	`årštf
(
¡d”r
,"Out of memory.\n");

3408 
	`ex™
(1);

3417 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3418 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3419 *
ı
;

3420 ifĞ
¥
==
Ëmp
->
”rsym
 ){

3421 
¥
->
dŠum
 = 
¬¿ysize
+1;

3424 ifĞ
¥
->
ty³
!=
NONTERMINAL
 || (¥->
d©©y³
==0 && 
Ëmp
->
v¬ty³
==0) ){

3425 
¥
->
dŠum
 = 0;

3428 
ı
 = 
¥
->
d©©y³
;

3429 ifĞ
ı
==0 ) c°ğ
Ëmp
->
v¬ty³
;

3430 
j
 = 0;

3431  
	`is¥aû
(*
ı
) ) cp++;

3432  *
ı
 ) 
¡ddt
[
j
++] = *cp++;

3433  
j
>0 && 
	`is¥aû
(
¡ddt
[j-1]) ) j--;

3434 
¡ddt
[
j
] = 0;

3435 ifĞ
Ëmp
->
tok’ty³
 && 
	`¡rcmp
(
¡ddt
,†emp->tokentype)==0 ){

3436 
¥
->
dŠum
 = 0;

3439 
hash
 = 0;

3440 
j
=0; 
¡ddt
[j]; j++){

3441 
hash
 = hash*53 + 
¡ddt
[
j
];

3443 
hash
 = (hash & 0x7fffffff)%
¬¿ysize
;

3444  
ty³s
[
hash
] ){

3445 ifĞ
	`¡rcmp
(
ty³s
[
hash
],
¡ddt
)==0 ){

3446 
¥
->
dŠum
 = 
hash
 + 1;

3449 
hash
++;

3450 ifĞ
hash
>=
¬¿ysize
 ) hash = 0;

3452 ifĞ
ty³s
[
hash
]==0 ){

3453 
¥
->
dŠum
 = 
hash
 + 1;

3454 
ty³s
[
hash
] = (*)
	`m®loc
Ğ
	`ËmÚSŒËn
(
¡ddt
)+1 );

3455 ifĞ
ty³s
[
hash
]==0 ){

3456 
	`årštf
(
¡d”r
,"Out of memory.\n");

3457 
	`ex™
(1);

3459 
	`¡rıy
(
ty³s
[
hash
],
¡ddt
);

3464 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3465 
lš’o
 = *
¶š’o
;

3466 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++; }

3467 
	`årštf
(
out
,"#defš%sTOKENTYPE %s\n",
Çme
,

3468 
Ëmp
->
tok’ty³
?Ëmp->tok’ty³:"void*"); 
lš’o
++;

3469 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++; }

3470 
	`årštf
(
out
,"ty³deàuniÚ {\n"); 
lš’o
++;

3471 
	`årštf
(
out
," iÁ yyš™;\n"); 
lš’o
++;

3472 
	`årštf
(
out
," %sTOKENTYPE yy0;\n",
Çme
); 
lš’o
++;

3473 
i
=0; i<
¬¿ysize
; i++){

3474 ifĞ
ty³s
[
i
]==0 ) ;

3475 
	`årštf
(
out
," % yy%d;\n",
ty³s
[
i
],i+1); 
lš’o
++;

3476 
	`ä“
(
ty³s
[
i
]);

3478 ifĞ
Ëmp
->
”rsym
->
u£CÁ
 ){

3479 
	`årštf
(
out
," iÁ yy%d;\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3481 
	`ä“
(
¡ddt
);

3482 
	`ä“
(
ty³s
);

3483 
	`årštf
(
out
,"} YYMINORTYPE;\n"); 
lš’o
++;

3484 *
¶š’o
 = 
lš’o
;

3485 
	}
}

3491 cÚ¡ *
	$mšimum_size_ty³
(
lwr
, 
u´
){

3492 ifĞ
lwr
>=0 ){

3493 ifĞ
u´
<=255 ){

3495 }ifĞ
u´
<65535 ){

3500 }ifĞ
lwr
>=-127 && 
u´
<=127 ){

3502 }ifĞ
lwr
>=-32767 && 
u´
<32767 ){

3507 
	}
}

3515 
	sax£t
 {

3516 
¡©e
 *
	m¡p
;

3517 
	misTkn
;

3518 
	mnAùiÚ
;

3524 
	$ax£t_com·»
(cÚ¡ *
a
, cÚ¡ *
b
){

3525 
ax£t
 *
p1
 = (ax£t*)
a
;

3526 
ax£t
 *
p2
 = (ax£t*)
b
;

3527  
p2
->
nAùiÚ
 - 
p1
->nAction;

3528 
	}
}

3533 
	$wr™eRuËText
(
FILE
 *
out
, 
ruË
 *
½
){

3534 
j
;

3535 
	`årštf
(
out
,"% ::=", 
½
->
lhs
->
Çme
);

3536 
j
=0; j<
½
->
Ähs
; j++){

3537 
symbŞ
 *
¥
 = 
½
->
rhs
[
j
];

3538 
	`årštf
(
out
," %s", 
¥
->
Çme
);

3539 ifĞ
¥
->
ty³
==
MULTITERMINAL
 ){

3540 
k
;

3541 
k
=1; k<
¥
->
nsubsym
; k++){

3542 
	`årštf
(
out
,"|%s",
¥
->
subsym
[
k
]->
Çme
);

3546 
	}
}

3550 
	$R•ÜtTabË
(
Ëmp
, 
mhæag
)

3551 
ËmÚ
 *
Ëmp
;

3552 
mhæag
;

3554 
FILE
 *
out
, *
š
;

3555 
lše
[
LINESIZE
];

3556 
lš’o
;

3557 
¡©e
 *
¡p
;

3558 
aùiÚ
 *
­
;

3559 
ruË
 *
½
;

3560 
aùb
 *
pAùb
;

3561 
i
, 
j
, 
n
;

3562 *
Çme
;

3563 
mnTknOf¡
, 
mxTknOf¡
;

3564 
mnNtOf¡
, 
mxNtOf¡
;

3565 
ax£t
 *
ax
;

3567 
š
 = 
	`É_İ’
(
Ëmp
);

3568 ifĞ
š
==0 ) ;

3569 
out
 = 
	`fe_İ’
(
Ëmp
,".c","wb");

3570 ifĞ
out
==0 ){

3571 
	`fşo£
(
š
);

3574 
lš’o
 = 1;

3575 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3578 
	`É_´št
(
out
,
Ëmp
,Ëmp->
šşude
,&
lš’o
);

3579 ifĞ
mhæag
 ){

3580 *
Çme
 = 
	`fe_mak’ame
(
Ëmp
, ".h");

3581 
	`årštf
(
out
,"#šşud\"%s\"\n", 
Çme
); 
lš’o
++;

3582 
	`ä“
(
Çme
);

3584 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3587 ifĞ
mhæag
 ){

3588 *
´efix
;

3589 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3590 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3591 
´efix
 = "";

3592 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

3593 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

3594 
lš’o
++;

3596 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3598 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3601 
	`årštf
(
out
,"#define YYCODETYPE %s\n",

3602 
	`mšimum_size_ty³
(0, 
Ëmp
->
nsymbŞ
+1)); 
lš’o
++;

3603 
	`årštf
(
out
,"#defšYYNOCODE %d\n",
Ëmp
->
nsymbŞ
+1); 
lš’o
++;

3604 
	`årštf
(
out
,"#define YYACTIONTYPE %s\n",

3605 
	`mšimum_size_ty³
(0, 
Ëmp
->
n¡©e
+Ëmp->
ÄuË
+5)); 
lš’o
++;

3606 ifĞ
Ëmp
->
wdÿrd
 ){

3607 
	`årštf
(
out
,"#define YYWILDCARD %d\n",

3608 
Ëmp
->
wdÿrd
->
šdex
); 
lš’o
++;

3610 
	`´št_¡ack_uniÚ
(
out
,
Ëmp
,&
lš’o
,
mhæag
);

3611 
	`årštf
(
out
, "#iâdeàYYSTACKDEPTH\n"); 
lš’o
++;

3612 ifĞ
Ëmp
->
¡acksize
 ){

3613 
	`årštf
(
out
,"#defšYYSTACKDEPTH %s\n",
Ëmp
->
¡acksize
); 
lš’o
++;

3615 
	`årštf
(
out
,"#defšYYSTACKDEPTH 100\n"); 
lš’o
++;

3617 
	`årštf
(
out
, "#’dif\n"); 
lš’o
++;

3618 ifĞ
mhæag
 ){

3619 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3621 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3622 ifĞ
Ëmp
->
¬g
 &&†emp->arg[0] ){

3623 
i
;

3624 
i
 = 
	`ËmÚSŒËn
(
Ëmp
->
¬g
);

3625  
i
>=1 && 
	`is¥aû
(
Ëmp
->
¬g
[i-1]) ) i--;

3626  
i
>=1 && (
	`i§Êum
(
Ëmp
->
¬g
[i-1]) ||†emp->arg[i-1]=='_') ) i--;

3627 
	`årštf
(
out
,"#defš%sARG_SDECL %s;\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3628 
	`årštf
(
out
,"#defš%sARG_PDECL ,%s\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3629 
	`årštf
(
out
,"#define %sARG_FETCH %s = yypParser->%s\n",

3630 
Çme
,
Ëmp
->
¬g
,&Ëmp->¬g[
i
]); 
lš’o
++;

3631 
	`årštf
(
out
,"#define %sARG_STORE yypParser->%s = %s\n",

3632 
Çme
,&
Ëmp
->
¬g
[
i
],&Ëmp->¬g[i]); 
lš’o
++;

3634 
	`årštf
(
out
,"#defš%sARG_SDECL\n",
Çme
); 
lš’o
++;

3635 
	`årštf
(
out
,"#defš%sARG_PDECL\n",
Çme
); 
lš’o
++;

3636 
	`årštf
(
out
,"#defš%sARG_FETCH\n",
Çme
); 
lš’o
++;

3637 
	`årštf
(
out
,"#defš%sARG_STORE\n",
Çme
); 
lš’o
++;

3639 ifĞ
mhæag
 ){

3640 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3642 
	`årštf
(
out
,"#defšYYNSTATE %d\n",
Ëmp
->
n¡©e
); 
lš’o
++;

3643 
	`årštf
(
out
,"#defšYYNRULE %d\n",
Ëmp
->
ÄuË
); 
lš’o
++;

3644 ifĞ
Ëmp
->
”rsym
->
u£CÁ
 ){

3645 
	`årštf
(
out
,"#defšYYERRORSYMBOL %d\n",
Ëmp
->
”rsym
->
šdex
); 
lš’o
++;

3646 
	`årštf
(
out
,"#defšYYERRSYMDT yy%d\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3648 ifĞ
Ëmp
->
has_çÎback
 ){

3649 
	`årštf
(
out
,"#defšYYFALLBACK 1\n"); 
lš’o
++;

3651 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3666 
ax
 = 
	`ÿÎoc
(
Ëmp
->
n¡©e
*2, (ax[0]));

3667 ifĞ
ax
==0 ){

3668 
	`årštf
(
¡d”r
,"malloc failed\n");

3669 
	`ex™
(1);

3671 
i
=0; i<
Ëmp
->
n¡©e
; i++){

3672 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3673 
ax
[
i
*2].
¡p
 = stp;

3674 
ax
[
i
*2].
isTkn
 = 1;

3675 
ax
[
i
*2].
nAùiÚ
 = 
¡p
->
nTknAù
;

3676 
ax
[
i
*2+1].
¡p
 = stp;

3677 
ax
[
i
*2+1].
isTkn
 = 0;

3678 
ax
[
i
*2+1].
nAùiÚ
 = 
¡p
->
nNtAù
;

3680 
mxTknOf¡
 = 
mnTknOf¡
 = 0;

3681 
mxNtOf¡
 = 
mnNtOf¡
 = 0;

3687 
	`qsÜt
(
ax
, 
Ëmp
->
n¡©e
*2, ×x[0]), 
ax£t_com·»
);

3688 
pAùb
 = 
	`aùb_®loc
();

3689 
i
=0; i<
Ëmp
->
n¡©e
*2 && 
ax
[i].
nAùiÚ
>0; i++){

3690 
¡p
 = 
ax
[
i
].stp;

3691 ifĞ
ax
[
i
].
isTkn
 ){

3692 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3693 
aùiÚ
;

3694 ifĞ
­
->
¥
->
šdex
>=
Ëmp
->
Á”mš®
 ) ;

3695 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3696 ifĞ
aùiÚ
<0 ) ;

3697 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3699 
¡p
->
iTknOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3700 ifĞ
¡p
->
iTknOf¡
<
mnTknOf¡
 ) mnTknOfst = stp->iTknOfst;

3701 ifĞ
¡p
->
iTknOf¡
>
mxTknOf¡
 ) mxTknOfst = stp->iTknOfst;

3703 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3704 
aùiÚ
;

3705 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ) ;

3706 ifĞ
­
->
¥
->
šdex
==
Ëmp
->
nsymbŞ
 ) ;

3707 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3708 ifĞ
aùiÚ
<0 ) ;

3709 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3711 
¡p
->
iNtOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3712 ifĞ
¡p
->
iNtOf¡
<
mnNtOf¡
 ) mnNtOfst = stp->iNtOfst;

3713 ifĞ
¡p
->
iNtOf¡
>
mxNtOf¡
 ) mxNtOfst = stp->iNtOfst;

3716 
	`ä“
(
ax
);

3719 
	`årštf
(
out
,"¡©iøcÚ¡ YYACTIONTYPE yy_aùiÚ[] = {\n"); 
lš’o
++;

3720 
n
 = 
	`aùb_size
(
pAùb
);

3721 
i
=
j
=0; i<
n
; i++){

3722 
aùiÚ
 = 
	`aùb_yyaùiÚ
(
pAùb
, 
i
);

3723 ifĞ
aùiÚ
<0 )‡ùiÚ = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 2;

3724 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3725 
	`årštf
(
out
, " %4d,", 
aùiÚ
);

3726 ifĞ
j
==9 || 
i
==
n
-1 ){

3727 
	`årštf
(
out
, "\n"); 
lš’o
++;

3728 
j
 = 0;

3730 
j
++;

3733 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3736 
	`årštf
(
out
,"¡©iøcÚ¡ YYCODETYPE yy_lookah—d[] = {\n"); 
lš’o
++;

3737 
i
=
j
=0; i<
n
; i++){

3738 
Ï
 = 
	`aùb_yylookah—d
(
pAùb
, 
i
);

3739 ifĞ
Ï
<0 )†¨ğ
Ëmp
->
nsymbŞ
;

3740 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3741 
	`årštf
(
out
, " %4d,", 
Ï
);

3742 ifĞ
j
==9 || 
i
==
n
-1 ){

3743 
	`årštf
(
out
, "\n"); 
lš’o
++;

3744 
j
 = 0;

3746 
j
++;

3749 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3752 
	`årštf
(
out
, "#defšYY_SHIFT_USE_DFLT (%d)\n", 
mnTknOf¡
-1); 
lš’o
++;

3753 
n
 = 
Ëmp
->
n¡©e
;

3754  
n
>0 && 
Ëmp
->
sÜ‹d
[n-1]->
iTknOf¡
==
NO_OFFSET
 )‚--;

3755 
	`årštf
(
out
, "#defšYY_SHIFT_MAX %d\n", 
n
-1); 
lš’o
++;

3756 
	`årštf
(
out
, "static const %s yy_shift_ofst[] = {\n",

3757 
	`mšimum_size_ty³
(
mnTknOf¡
-1, 
mxTknOf¡
)); 
lš’o
++;

3758 
i
=
j
=0; i<
n
; i++){

3759 
of¡
;

3760 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3761 
of¡
 = 
¡p
->
iTknOf¡
;

3762 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnTknOf¡
 - 1;

3763 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3764 
	`årštf
(
out
, " %4d,", 
of¡
);

3765 ifĞ
j
==9 || 
i
==
n
-1 ){

3766 
	`årštf
(
out
, "\n"); 
lš’o
++;

3767 
j
 = 0;

3769 
j
++;

3772 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3775 
	`årštf
(
out
, "#defšYY_REDUCE_USE_DFLT (%d)\n", 
mnNtOf¡
-1); 
lš’o
++;

3776 
n
 = 
Ëmp
->
n¡©e
;

3777  
n
>0 && 
Ëmp
->
sÜ‹d
[n-1]->
iNtOf¡
==
NO_OFFSET
 )‚--;

3778 
	`årštf
(
out
, "#defšYY_REDUCE_MAX %d\n", 
n
-1); 
lš’o
++;

3779 
	`årštf
(
out
, "static const %s yy_reduce_ofst[] = {\n",

3780 
	`mšimum_size_ty³
(
mnNtOf¡
-1, 
mxNtOf¡
)); 
lš’o
++;

3781 
i
=
j
=0; i<
n
; i++){

3782 
of¡
;

3783 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3784 
of¡
 = 
¡p
->
iNtOf¡
;

3785 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnNtOf¡
 - 1;

3786 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3787 
	`årštf
(
out
, " %4d,", 
of¡
);

3788 ifĞ
j
==9 || 
i
==
n
-1 ){

3789 
	`årštf
(
out
, "\n"); 
lš’o
++;

3790 
j
 = 0;

3792 
j
++;

3795 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3798 
	`årštf
(
out
, "¡©iøcÚ¡ YYACTIONTYPE yy_deçuÉ[] = {\n"); 
lš’o
++;

3799 
n
 = 
Ëmp
->
n¡©e
;

3800 
i
=
j
=0; i<
n
; i++){

3801 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3802 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3803 
	`årštf
(
out
, " %4d,", 
¡p
->
iDæt
);

3804 ifĞ
j
==9 || 
i
==
n
-1 ){

3805 
	`årštf
(
out
, "\n"); 
lš’o
++;

3806 
j
 = 0;

3808 
j
++;

3811 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3812 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3816 ifĞ
Ëmp
->
has_çÎback
 ){

3817 
mx
 = 
Ëmp
->
Á”mš®
 - 1;

3818  
mx
>0 && 
Ëmp
->
symbŞs
[mx]->
çÎback
==0 ){ mx--; }

3819 
i
=0; i<=
mx
; i++){

3820 
symbŞ
 *
p
 = 
Ëmp
->
symbŞs
[
i
];

3821 ifĞ
p
->
çÎback
==0 ){

3822 
	`årštf
(
out
, " 0, /* %10 =>‚Ùhšg */\n", 
p
->
Çme
);

3824 
	`årštf
(
out
, " %3d, /* %10 => % */\n", 
p
->
çÎback
->
šdex
,

3825 
p
->
Çme
,…->
çÎback
->name);

3827 
lš’o
++;

3830 
	`É_xãr
(
Ëmp
->
Çme
, 
š
, 
out
, &
lš’o
);

3834 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3835 
	`¥rštf
(
lše
,"\"%s\",",
Ëmp
->
symbŞs
[
i
]->
Çme
);

3836 
	`årštf
(
out
," %-15s",
lše
);

3837 ifĞ(
i
&3)==3 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3839 ifĞ(
i
&3)!=0 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3840 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3846 
i
=0, 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
, i++){

3847 
	`as£¹
Ğ
½
->
šdex
==
i
 );

3848 
	`årštf
(
out
," /* %3d */ \"", 
i
);

3849 
	`wr™eRuËText
(
out
, 
½
);

3850 
	`årštf
(
out
,"\",\n"); 
lš’o
++;

3852 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3858 ifĞ
Ëmp
->
tok’de¡
 ){

3859 
Úû
 = 1;

3860 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3861 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3862 ifĞ
¥
==0 || sp->
ty³
!=
TERMINAL
 ) ;

3863 ifĞ
Úû
 ){

3864 
	`årštf
(
out
, " /* TERMINAL De¡ruùÜ */\n"); 
lš’o
++;

3865 
Úû
 = 0;

3867 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3869 
i
=0; i<
Ëmp
->
nsymbŞ
 &&†emp->
symbŞs
[i]->
ty³
!=
TERMINAL
; i++);

3870 ifĞ
i
<
Ëmp
->
nsymbŞ
 ){

3871 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3872 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3875 ifĞ
Ëmp
->
v¬de¡
 ){

3876 
symbŞ
 *
dæt_¥
 = 0;

3877 
Úû
 = 1;

3878 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3879 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3880 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 ||

3881 
¥
->
šdex
<=0 || sp->
de¡ruùÜ
!=0 ) ;

3882 ifĞ
Úû
 ){

3883 
	`årštf
(
out
, " /* DeçuÉ NON-TERMINAL De¡ruùÜ */\n"); 
lš’o
++;

3884 
Úû
 = 0;

3886 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3887 
dæt_¥
 = 
¥
;

3889 ifĞ
dæt_¥
!=0 ){

3890 
	`em™_de¡ruùÜ_code
(
out
,
dæt_¥
,
Ëmp
,&
lš’o
);

3892 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3894 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3895 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3896 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 || sp->
de¡ruùÜ
==0 ) ;

3897 
	`årštf
(
out
," ca£ %d: /* % */\n", 
¥
->
šdex
, sp->
Çme
); 
lš’o
++;

3900 
j
=
i
+1; j<
Ëmp
->
nsymbŞ
; j++){

3901 
symbŞ
 *
¥2
 = 
Ëmp
->
symbŞs
[
j
];

3902 ifĞ
¥2
 && sp2->
ty³
!=
TERMINAL
 && sp2->
de¡ruùÜ


3903 && 
¥2
->
dŠum
==
¥
->dtnum

3904 && 
	`¡rcmp
(
¥
->
de¡ruùÜ
,
¥2
->destructor)==0 ){

3905 
	`årštf
(
out
," case %d: /* %s */\n",

3906 
¥2
->
šdex
, sp2->
Çme
); 
lš’o
++;

3907 
¥2
->
de¡ruùÜ
 = 0;

3911 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3912 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3914 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3917 
	`É_´št
(
out
,
Ëmp
,Ëmp->
ov”æow
,&
lš’o
);

3918 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3925 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3926 
	`årštf
(
out
," { %d, %d },\n",
½
->
lhs
->
šdex
,½->
Ähs
); 
lš’o
++;

3928 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3931 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3932 
	`Œª¦©e_code
(
Ëmp
, 
½
);

3935 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3936 
ruË
 *
½2
;

3937 ifĞ
½
->
code
==0 ) ;

3938 ifĞ
½
->
code
[0]=='\n' &&„p->code[1]==0 ) ;

3939 
	`årštf
(
out
," ca£ %d: /* ", 
½
->
šdex
);

3940 
	`wr™eRuËText
(
out
, 
½
);

3941 
	`årštf
(
out
, " */\n"); 
lš’o
++;

3942 
½2
=
½
->
Ãxt
;„p2;„p2=rp2->next){

3943 ifĞ
½2
->
code
==
½
->code ){

3944 
	`årštf
(
out
," ca£ %d: /* ", 
½2
->
šdex
);

3945 
	`wr™eRuËText
(
out
, 
½2
);

3946 
	`årštf
(
out
," */ yy‹¡ÿ£(yyruËno==%d);\n", 
½2
->
šdex
); 
lš’o
++;

3947 
½2
->
code
 = 0;

3950 
	`em™_code
(
out
,
½
,
Ëmp
,&
lš’o
);

3951 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3952 
½
->
code
 = 0;

3956 
	`årštf
(
out
," deçuÉ:\n"); 
lš’o
++;

3957 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3958 ifĞ
½
->
code
==0 ) ;

3959 
	`as£¹
Ğ
½
->
code
[0]=='\n' &&„p->code[1]==0 );

3960 
	`årštf
(
out
," /* (%dè", 
½
->
šdex
);

3961 
	`wr™eRuËText
(
out
, 
½
);

3962 
	`årštf
(
out
, " */ yy‹¡ÿ£(yyruËno==%d);\n", 
½
->
šdex
); 
lš’o
++;

3964 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3965 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3968 
	`É_´št
(
out
,
Ëmp
,Ëmp->
çu»
,&
lš’o
);

3969 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3972 
	`É_´št
(
out
,
Ëmp
,Ëmp->
”rÜ
,&
lš’o
);

3973 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3976 
	`É_´št
(
out
,
Ëmp
,Ëmp->
acû±
,&
lš’o
);

3977 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3980 
	`É_´št
(
out
,
Ëmp
,Ëmp->
exŒacode
,&
lš’o
);

3982 
	`fşo£
(
š
);

3983 
	`fşo£
(
out
);

3985 
	}
}

3988 
	$R•ÜtH—d”
(
Ëmp
)

3989 
ËmÚ
 *
Ëmp
;

3991 
FILE
 *
out
, *
š
;

3992 *
´efix
;

3993 
lše
[
LINESIZE
];

3994 
·‰”n
[
LINESIZE
];

3995 
i
;

3997 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3998 
´efix
 = "";

3999 
š
 = 
	`fe_İ’
(
Ëmp
,".h","rb");

4000 ifĞ
š
 ){

4001 
i
=1; i<
Ëmp
->
Á”mš®
 && 
	`fg‘s
(
lše
,
LINESIZE
,
š
); i++){

4002 
	`¥rštf
(
·‰”n
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

4003 ifĞ
	`¡rcmp
(
lše
,
·‰”n
) ) ;

4005 
	`fşo£
(
š
);

4006 ifĞ
i
==
Ëmp
->
Á”mš®
 ){

4011 
out
 = 
	`fe_İ’
(
Ëmp
,".h","wb");

4012 ifĞ
out
 ){

4013 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

4014 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

4016 
	`fşo£
(
out
);

4019 
	}
}

4028 
	$Com´essTabËs
(
Ëmp
)

4029 
ËmÚ
 *
Ëmp
;

4031 
¡©e
 *
¡p
;

4032 
aùiÚ
 *
­
, *
­2
;

4033 
ruË
 *
½
, *
½2
, *
rbe¡
;

4034 
nbe¡
, 
n
;

4035 
i
;

4036 
u£sWdÿrd
;

4038 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4039 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

4040 
nbe¡
 = 0;

4041 
rbe¡
 = 0;

4042 
u£sWdÿrd
 = 0;

4044 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4045 ifĞ
­
->
ty³
==
SHIFT
 &&‡p->
¥
==
Ëmp
->
wdÿrd
 ){

4046 
u£sWdÿrd
 = 1;

4048 ifĞ
­
->
ty³
!=
REDUCE
 ) ;

4049 
½
 = 
­
->
x
.rp;

4050 ifĞ
½
->
lhsS¹
 ) ;

4051 ifĞ
½
==
rbe¡
 ) ;

4052 
n
 = 1;

4053 
­2
=
­
->
Ãxt
;‡p2;‡p2=ap2->next){

4054 ifĞ
­2
->
ty³
!=
REDUCE
 ) ;

4055 
½2
 = 
­2
->
x
.
½
;

4056 ifĞ
½2
==
rbe¡
 ) ;

4057 ifĞ
½2
==
½
 ) 
n
++;

4059 ifĞ
n
>
nbe¡
 ){

4060 
nbe¡
 = 
n
;

4061 
rbe¡
 = 
½
;

4069 ifĞ
nbe¡
<1 || 
u£sWdÿrd
 ) ;

4073 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4074 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 ) ;

4076 
	`as£¹
Ğ
­
 );

4077 
­
->
¥
 = 
	`SymbŞ_Ãw
("{default}");

4078 
­
÷p->
Ãxt
;‡p;‡p=ap->next){

4079 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 )‡p->ty³ = 
NOT_USED
;

4081 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

4083 
	}
}

4092 
	$¡©eResÜtCom·»
(cÚ¡ *
a
, cÚ¡ *
b
){

4093 cÚ¡ 
¡©e
 *
pA
 = *(cÚ¡ ¡©e**)
a
;

4094 cÚ¡ 
¡©e
 *
pB
 = *(cÚ¡ ¡©e**)
b
;

4095 
n
;

4097 
n
 = 
pB
->
nNtAù
 - 
pA
->nNtAct;

4098 ifĞ
n
==0 ){

4099 
n
 = 
pB
->
nTknAù
 - 
pA
->nTknAct;

4101  
n
;

4102 
	}
}

4109 
	$ResÜtS‹s
(
Ëmp
)

4110 
ËmÚ
 *
Ëmp
;

4112 
i
;

4113 
¡©e
 *
¡p
;

4114 
aùiÚ
 *
­
;

4116 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4117 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

4118 
¡p
->
nTknAù
 = s->
nNtAù
 = 0;

4119 
¡p
->
iDæt
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
;

4120 
¡p
->
iTknOf¡
 = 
NO_OFFSET
;

4121 
¡p
->
iNtOf¡
 = 
NO_OFFSET
;

4122 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

4123 ifĞ
	`compu‹_aùiÚ
(
Ëmp
,
­
)>=0 ){

4124 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ){

4125 
¡p
->
nTknAù
++;

4126 }ifĞ
­
->
¥
->
šdex
<
Ëmp
->
nsymbŞ
 ){

4127 
¡p
->
nNtAù
++;

4129 
¡p
->
iDæt
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

4134 
	`qsÜt
(&
Ëmp
->
sÜ‹d
[1],†emp->
n¡©e
-1, (lemp->sorted[0]),

4135 
¡©eResÜtCom·»
);

4136 
i
=0; i<
Ëmp
->
n¡©e
; i++){

4137 
Ëmp
->
sÜ‹d
[
i
]->
¡©’um
 = i;

4139 
	}
}

4147 
	gsize
 = 0;

4150 
	$S‘Size
(
n
)

4151 
n
;

4153 
size
 = 
n
+1;

4154 
	}
}

4157 *
	$S‘New
(){

4158 *
s
;

4159 
s
 = (*)
	`ÿÎoc
Ğ
size
, 1);

4160 ifĞ
s
==0 ){

4161 
	`memÜy_”rÜ
();

4162 
	`memÜy_”rÜ
();

4164  
s
;

4165 
	}
}

4168 
	$S‘F»e
(
s
)

4169 *
s
;

4171 
	`ä“
(
s
);

4172 
	}
}

4176 
	$S‘Add
(
s
,
e
)

4177 *
s
;

4178 
e
;

4180 
rv
;

4181 
	`as£¹
Ğ
e
>=0 &&ƒ<
size
 );

4182 
rv
 = 
s
[
e
];

4183 
s
[
e
] = 1;

4184  !
rv
;

4185 
	}
}

4188 
	$S‘UniÚ
(
s1
,
s2
)

4189 *
s1
;

4190 *
s2
;

4192 
i
, 
´og»ss
;

4193 
´og»ss
 = 0;

4194 
i
=0; i<
size
; i++){

4195 ifĞ
s2
[
i
]==0 ) ;

4196 ifĞ
s1
[
i
]==0 ){

4197 
´og»ss
 = 1;

4198 
s1
[
i
] = 1;

4201  
´og»ss
;

4202 
	}
}

4216 
PRIVATE
 
	$¡rhash
(
x
)

4217 *
x
;

4219 
h
 = 0;

4220  *
x
è
h
 = h*13 + *(x++);

4221  
h
;

4222 
	}
}

4228 *
	$SŒ§ã
(
y
)

4229 *
y
;

4231 *
z
;

4233 ifĞ
y
==0 )  0;

4234 
z
 = 
	`SŒ§ã_fšd
(
y
);

4235 ifĞ
z
==0 && (z=
	`m®loc
Ğ
	`ËmÚSŒËn
(
y
)+1 ))!=0 ){

4236 
	`¡rıy
(
z
,
y
);

4237 
	`SŒ§ã_š£¹
(
z
);

4239 
	`MemÜyCheck
(
z
);

4240  
z
;

4241 
	}
}

4246 
	ss_x1
 {

4247 
	msize
;

4250 
	mcouÁ
;

4251 
s_x1node
 *
	mtbl
;

4252 
s_x1node
 **
	mht
;

4258 
	ss_x1node
 {

4259 *
	md©a
;

4260 
s_x1node
 *
	mÃxt
;

4261 
s_x1node
 **
	mäom
;

4262 } 
	tx1node
;

4265 
s_x1
 *
	gx1a
;

4268 
	$SŒ§ã_š™
(){

4269 ifĞ
x1a
 ) ;

4270 
x1a
 = (
s_x1
*)
	`m®loc
( (s_x1) );

4271 ifĞ
x1a
 ){

4272 
x1a
->
size
 = 1024;

4273 
x1a
->
couÁ
 = 0;

4274 
x1a
->
tbl
 = (
x1node
*)
	`m®loc
(

4275 ((
x1node
) + (x1node*))*1024 );

4276 ifĞ
x1a
->
tbl
==0 ){

4277 
	`ä“
(
x1a
);

4278 
x1a
 = 0;

4280 
i
;

4281 
x1a
->
ht
 = (
x1node
**)&(x1a->
tbl
[1024]);

4282 
i
=0; i<1024; i++è
x1a
->
ht
[i] = 0;

4285 
	}
}

4288 
	$SŒ§ã_š£¹
(
d©a
)

4289 *
d©a
;

4291 
x1node
 *
Å
;

4292 
h
;

4293 
ph
;

4295 ifĞ
x1a
==0 )  0;

4296 
ph
 = 
	`¡rhash
(
d©a
);

4297 
h
 = 
ph
 & (
x1a
->
size
-1);

4298 
Å
 = 
x1a
->
ht
[
h
];

4299  
Å
 ){

4300 ifĞ
	`¡rcmp
(
Å
->
d©a
,data)==0 ){

4305 
Å
 =‚p->
Ãxt
;

4307 ifĞ
x1a
->
couÁ
>=x1a->
size
 ){

4309 
i
,
size
;

4310 
s_x1
 
¬¿y
;

4311 
¬¿y
.
size
 = sizğ
x1a
->size*2;

4312 
¬¿y
.
couÁ
 = 
x1a
->count;

4313 
¬¿y
.
tbl
 = (
x1node
*)
	`m®loc
(

4314 ((
x1node
è+ (x1node*))*
size
 );

4315 ifĞ
¬¿y
.
tbl
==0 )  0;

4316 
¬¿y
.
ht
 = (
x1node
**)&×¼ay.
tbl
[
size
]);

4317 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4318 
i
=0; i<
x1a
->
couÁ
; i++){

4319 
x1node
 *
ŞdÅ
, *
ÃwÅ
;

4320 
ŞdÅ
 = &(
x1a
->
tbl
[
i
]);

4321 
h
 = 
	`¡rhash
(
ŞdÅ
->
d©a
è& (
size
-1);

4322 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4323 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4324 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4325 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4326 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4327 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4329 
	`ä“
(
x1a
->
tbl
);

4330 *
x1a
 = 
¬¿y
;

4333 
h
 = 
ph
 & (
x1a
->
size
-1);

4334 
Å
 = &(
x1a
->
tbl
[x1a->
couÁ
++]);

4335 
Å
->
d©a
 = data;

4336 ifĞ
x1a
->
ht
[
h
] ) x1a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4337 
Å
->
Ãxt
 = 
x1a
->
ht
[
h
];

4338 
x1a
->
ht
[
h
] = 
Å
;

4339 
Å
->
äom
 = &(
x1a
->
ht
[
h
]);

4341 
	}
}

4345 *
	$SŒ§ã_fšd
(
key
)

4346 *
key
;

4348 
h
;

4349 
x1node
 *
Å
;

4351 ifĞ
x1a
==0 )  0;

4352 
h
 = 
	`¡rhash
(
key
è& (
x1a
->
size
-1);

4353 
Å
 = 
x1a
->
ht
[
h
];

4354  
Å
 ){

4355 ifĞ
	`¡rcmp
(
Å
->
d©a
,
key
)==0 ) ;

4356 
Å
 =‚p->
Ãxt
;

4358  
Å
 ?‚p->
d©a
 : 0;

4359 
	}
}

4364 
symbŞ
 *
	$SymbŞ_Ãw
(
x
)

4365 *
x
;

4367 
symbŞ
 *
¥
;

4369 
¥
 = 
	`SymbŞ_fšd
(
x
);

4370 ifĞ
¥
==0 ){

4371 
¥
 = (
symbŞ
 *)
	`ÿÎoc
(1, (symbol) );

4372 
	`MemÜyCheck
(
¥
);

4373 
¥
->
Çme
 = 
	`SŒ§ã
(
x
);

4374 
¥
->
ty³
 = 
	`isuµ”
(*
x
è? 
TERMINAL
 : 
NONTERMINAL
;

4375 
¥
->
ruË
 = 0;

4376 
¥
->
çÎback
 = 0;

4377 
¥
->
´ec
 = -1;

4378 
¥
->
assoc
 = 
UNK
;

4379 
¥
->
fœ¡£t
 = 0;

4380 
¥
->
Ïmbda
 = 
LEMON_FALSE
;

4381 
¥
->
de¡ruùÜ
 = 0;

4382 
¥
->
de¡Lš’o
 = 0;

4383 
¥
->
d©©y³
 = 0;

4384 
¥
->
u£CÁ
 = 0;

4385 
	`SymbŞ_š£¹
(
¥
,¥->
Çme
);

4387 
¥
->
u£CÁ
++;

4388  
¥
;

4389 
	}
}

4401 
	$SymbŞcmµ
(
symbŞ
 **
a
, symbŞ **
b
){

4402 
i1
 = (**
a
).
šdex
 + 10000000*((**a).
Çme
[0]>'Z');

4403 
i2
 = (**
b
).
šdex
 + 10000000*((**b).
Çme
[0]>'Z');

4404  
i1
-
i2
;

4405 
	}
}

4410 
	ss_x2
 {

4411 
	msize
;

4414 
	mcouÁ
;

4415 
s_x2node
 *
	mtbl
;

4416 
s_x2node
 **
	mht
;

4422 
	ss_x2node
 {

4423 
symbŞ
 *
	md©a
;

4424 *
	mkey
;

4425 
s_x2node
 *
	mÃxt
;

4426 
s_x2node
 **
	mäom
;

4427 } 
	tx2node
;

4430 
s_x2
 *
	gx2a
;

4433 
	$SymbŞ_š™
(){

4434 ifĞ
x2a
 ) ;

4435 
x2a
 = (
s_x2
*)
	`m®loc
( (s_x2) );

4436 ifĞ
x2a
 ){

4437 
x2a
->
size
 = 128;

4438 
x2a
->
couÁ
 = 0;

4439 
x2a
->
tbl
 = (
x2node
*)
	`m®loc
(

4440 ((
x2node
) + (x2node*))*128 );

4441 ifĞ
x2a
->
tbl
==0 ){

4442 
	`ä“
(
x2a
);

4443 
x2a
 = 0;

4445 
i
;

4446 
x2a
->
ht
 = (
x2node
**)&(x2a->
tbl
[128]);

4447 
i
=0; i<128; i++è
x2a
->
ht
[i] = 0;

4450 
	}
}

4453 
	$SymbŞ_š£¹
(
d©a
,
key
)

4454 
symbŞ
 *
d©a
;

4455 *
key
;

4457 
x2node
 *
Å
;

4458 
h
;

4459 
ph
;

4461 ifĞ
x2a
==0 )  0;

4462 
ph
 = 
	`¡rhash
(
key
);

4463 
h
 = 
ph
 & (
x2a
->
size
-1);

4464 
Å
 = 
x2a
->
ht
[
h
];

4465  
Å
 ){

4466 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ){

4471 
Å
 =‚p->
Ãxt
;

4473 ifĞ
x2a
->
couÁ
>=x2a->
size
 ){

4475 
i
,
size
;

4476 
s_x2
 
¬¿y
;

4477 
¬¿y
.
size
 = sizğ
x2a
->size*2;

4478 
¬¿y
.
couÁ
 = 
x2a
->count;

4479 
¬¿y
.
tbl
 = (
x2node
*)
	`m®loc
(

4480 ((
x2node
è+ (x2node*))*
size
 );

4481 ifĞ
¬¿y
.
tbl
==0 )  0;

4482 
¬¿y
.
ht
 = (
x2node
**)&×¼ay.
tbl
[
size
]);

4483 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4484 
i
=0; i<
x2a
->
couÁ
; i++){

4485 
x2node
 *
ŞdÅ
, *
ÃwÅ
;

4486 
ŞdÅ
 = &(
x2a
->
tbl
[
i
]);

4487 
h
 = 
	`¡rhash
(
ŞdÅ
->
key
è& (
size
-1);

4488 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4489 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4490 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4491 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4492 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4493 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4494 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4496 
	`ä“
(
x2a
->
tbl
);

4497 *
x2a
 = 
¬¿y
;

4500 
h
 = 
ph
 & (
x2a
->
size
-1);

4501 
Å
 = &(
x2a
->
tbl
[x2a->
couÁ
++]);

4502 
Å
->
key
 = key;

4503 
Å
->
d©a
 = data;

4504 ifĞ
x2a
->
ht
[
h
] ) x2a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4505 
Å
->
Ãxt
 = 
x2a
->
ht
[
h
];

4506 
x2a
->
ht
[
h
] = 
Å
;

4507 
Å
->
äom
 = &(
x2a
->
ht
[
h
]);

4509 
	}
}

4513 
symbŞ
 *
	$SymbŞ_fšd
(
key
)

4514 *
key
;

4516 
h
;

4517 
x2node
 *
Å
;

4519 ifĞ
x2a
==0 )  0;

4520 
h
 = 
	`¡rhash
(
key
è& (
x2a
->
size
-1);

4521 
Å
 = 
x2a
->
ht
[
h
];

4522  
Å
 ){

4523 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ) ;

4524 
Å
 =‚p->
Ãxt
;

4526  
Å
 ?‚p->
d©a
 : 0;

4527 
	}
}

4530 
symbŞ
 *
	$SymbŞ_Nth
(
n
)

4531 
n
;

4533 
symbŞ
 *
d©a
;

4534 ifĞ
x2a
 && 
n
>0 &&‚<=x2a->
couÁ
 ){

4535 
d©a
 = 
x2a
->
tbl
[
n
-1].data;

4537 
d©a
 = 0;

4539  
d©a
;

4540 
	}
}

4543 
	$SymbŞ_couÁ
()

4545  
x2a
 ? x2a->
couÁ
 : 0;

4546 
	}
}

4551 
symbŞ
 **
	$SymbŞ_¬¿yof
()

4553 
symbŞ
 **
¬¿y
;

4554 
i
,
size
;

4555 ifĞ
x2a
==0 )  0;

4556 
size
 = 
x2a
->
couÁ
;

4557 
¬¿y
 = (
symbŞ
 **)
	`ÿÎoc
(
size
, (symbol *));

4558 ifĞ
¬¿y
 ){

4559 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x2a
->
tbl
[i].
d©a
;

4561  
¬¿y
;

4562 
	}
}

4565 
	$CÚfigcmp
(
a
,
b
)

4566 
cÚfig
 *
a
;

4567 
cÚfig
 *
b
;

4569 
x
;

4570 
x
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4571 ifĞ
x
==0 ) x = 
a
->
dÙ
 - 
b
->dot;

4572  
x
;

4573 
	}
}

4576 
PRIVATE
 
	$¡©ecmp
(
a
,
b
)

4577 
cÚfig
 *
a
;

4578 
cÚfig
 *
b
;

4580 
rc
;

4581 
rc
=0;„c==0 && 
a
 && 
b
;‡÷->
bp
, b=b->bp){

4582 
rc
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4583 ifĞ
rc
==0 )„øğ
a
->
dÙ
 - 
b
->dot;

4585 ifĞ
rc
==0 ){

4586 ifĞ
a
 ) 
rc
 = 1;

4587 ifĞ
b
 ) 
rc
 = -1;

4589  
rc
;

4590 
	}
}

4593 
PRIVATE
 
	$¡©ehash
(
a
)

4594 
cÚfig
 *
a
;

4596 
h
=0;

4597  
a
 ){

4598 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4599 
a
 =‡->
bp
;

4601  
h
;

4602 
	}
}

4605 
¡©e
 *
	$S‹_Ãw
()

4607 
¡©e
 *
Ãw
;

4608 
Ãw
 = (
¡©e
 *)
	`ÿÎoc
(1, (state) );

4609 
	`MemÜyCheck
(
Ãw
);

4610  
Ãw
;

4611 
	}
}

4616 
	ss_x3
 {

4617 
	msize
;

4620 
	mcouÁ
;

4621 
s_x3node
 *
	mtbl
;

4622 
s_x3node
 **
	mht
;

4628 
	ss_x3node
 {

4629 
¡©e
 *
	md©a
;

4630 
cÚfig
 *
	mkey
;

4631 
s_x3node
 *
	mÃxt
;

4632 
s_x3node
 **
	mäom
;

4633 } 
	tx3node
;

4636 
s_x3
 *
	gx3a
;

4639 
	$S‹_š™
(){

4640 ifĞ
x3a
 ) ;

4641 
x3a
 = (
s_x3
*)
	`m®loc
( (s_x3) );

4642 ifĞ
x3a
 ){

4643 
x3a
->
size
 = 128;

4644 
x3a
->
couÁ
 = 0;

4645 
x3a
->
tbl
 = (
x3node
*)
	`m®loc
(

4646 ((
x3node
) + (x3node*))*128 );

4647 ifĞ
x3a
->
tbl
==0 ){

4648 
	`ä“
(
x3a
);

4649 
x3a
 = 0;

4651 
i
;

4652 
x3a
->
ht
 = (
x3node
**)&(x3a->
tbl
[128]);

4653 
i
=0; i<128; i++è
x3a
->
ht
[i] = 0;

4656 
	}
}

4659 
	$S‹_š£¹
(
d©a
,
key
)

4660 
¡©e
 *
d©a
;

4661 
cÚfig
 *
key
;

4663 
x3node
 *
Å
;

4664 
h
;

4665 
ph
;

4667 ifĞ
x3a
==0 )  0;

4668 
ph
 = 
	`¡©ehash
(
key
);

4669 
h
 = 
ph
 & (
x3a
->
size
-1);

4670 
Å
 = 
x3a
->
ht
[
h
];

4671  
Å
 ){

4672 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ){

4677 
Å
 =‚p->
Ãxt
;

4679 ifĞ
x3a
->
couÁ
>=x3a->
size
 ){

4681 
i
,
size
;

4682 
s_x3
 
¬¿y
;

4683 
¬¿y
.
size
 = sizğ
x3a
->size*2;

4684 
¬¿y
.
couÁ
 = 
x3a
->count;

4685 
¬¿y
.
tbl
 = (
x3node
*)
	`m®loc
(

4686 ((
x3node
è+ (x3node*))*
size
 );

4687 ifĞ
¬¿y
.
tbl
==0 )  0;

4688 
¬¿y
.
ht
 = (
x3node
**)&×¼ay.
tbl
[
size
]);

4689 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4690 
i
=0; i<
x3a
->
couÁ
; i++){

4691 
x3node
 *
ŞdÅ
, *
ÃwÅ
;

4692 
ŞdÅ
 = &(
x3a
->
tbl
[
i
]);

4693 
h
 = 
	`¡©ehash
(
ŞdÅ
->
key
è& (
size
-1);

4694 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4695 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4696 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4697 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4698 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4699 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4700 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4702 
	`ä“
(
x3a
->
tbl
);

4703 *
x3a
 = 
¬¿y
;

4706 
h
 = 
ph
 & (
x3a
->
size
-1);

4707 
Å
 = &(
x3a
->
tbl
[x3a->
couÁ
++]);

4708 
Å
->
key
 = key;

4709 
Å
->
d©a
 = data;

4710 ifĞ
x3a
->
ht
[
h
] ) x3a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4711 
Å
->
Ãxt
 = 
x3a
->
ht
[
h
];

4712 
x3a
->
ht
[
h
] = 
Å
;

4713 
Å
->
äom
 = &(
x3a
->
ht
[
h
]);

4715 
	}
}

4719 
¡©e
 *
	$S‹_fšd
(
key
)

4720 
cÚfig
 *
key
;

4722 
h
;

4723 
x3node
 *
Å
;

4725 ifĞ
x3a
==0 )  0;

4726 
h
 = 
	`¡©ehash
(
key
è& (
x3a
->
size
-1);

4727 
Å
 = 
x3a
->
ht
[
h
];

4728  
Å
 ){

4729 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ) ;

4730 
Å
 =‚p->
Ãxt
;

4732  
Å
 ?‚p->
d©a
 : 0;

4733 
	}
}

4738 
¡©e
 **
	$S‹_¬¿yof
()

4740 
¡©e
 **
¬¿y
;

4741 
i
,
size
;

4742 ifĞ
x3a
==0 )  0;

4743 
size
 = 
x3a
->
couÁ
;

4744 
¬¿y
 = (
¡©e
 **)
	`m®loc
Ğ(¡©*)*
size
 );

4745 ifĞ
¬¿y
 ){

4746 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x3a
->
tbl
[i].
d©a
;

4748  
¬¿y
;

4749 
	}
}

4752 
PRIVATE
 
	$cÚfighash
(
a
)

4753 
cÚfig
 *
a
;

4755 
h
=0;

4756 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4757  
h
;

4758 
	}
}

4763 
	ss_x4
 {

4764 
	msize
;

4767 
	mcouÁ
;

4768 
s_x4node
 *
	mtbl
;

4769 
s_x4node
 **
	mht
;

4775 
	ss_x4node
 {

4776 
cÚfig
 *
	md©a
;

4777 
s_x4node
 *
	mÃxt
;

4778 
s_x4node
 **
	mäom
;

4779 } 
	tx4node
;

4782 
s_x4
 *
	gx4a
;

4785 
	$CÚfigbË_š™
(){

4786 ifĞ
x4a
 ) ;

4787 
x4a
 = (
s_x4
*)
	`m®loc
( (s_x4) );

4788 ifĞ
x4a
 ){

4789 
x4a
->
size
 = 64;

4790 
x4a
->
couÁ
 = 0;

4791 
x4a
->
tbl
 = (
x4node
*)
	`m®loc
(

4792 ((
x4node
) + (x4node*))*64 );

4793 ifĞ
x4a
->
tbl
==0 ){

4794 
	`ä“
(
x4a
);

4795 
x4a
 = 0;

4797 
i
;

4798 
x4a
->
ht
 = (
x4node
**)&(x4a->
tbl
[64]);

4799 
i
=0; i<64; i++è
x4a
->
ht
[i] = 0;

4802 
	}
}

4805 
	$CÚfigbË_š£¹
(
d©a
)

4806 
cÚfig
 *
d©a
;

4808 
x4node
 *
Å
;

4809 
h
;

4810 
ph
;

4812 ifĞ
x4a
==0 )  0;

4813 
ph
 = 
	`cÚfighash
(
d©a
);

4814 
h
 = 
ph
 & (
x4a
->
size
-1);

4815 
Å
 = 
x4a
->
ht
[
h
];

4816  
Å
 ){

4817 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,data)==0 ){

4822 
Å
 =‚p->
Ãxt
;

4824 ifĞ
x4a
->
couÁ
>=x4a->
size
 ){

4826 
i
,
size
;

4827 
s_x4
 
¬¿y
;

4828 
¬¿y
.
size
 = sizğ
x4a
->size*2;

4829 
¬¿y
.
couÁ
 = 
x4a
->count;

4830 
¬¿y
.
tbl
 = (
x4node
*)
	`m®loc
(

4831 ((
x4node
è+ (x4node*))*
size
 );

4832 ifĞ
¬¿y
.
tbl
==0 )  0;

4833 
¬¿y
.
ht
 = (
x4node
**)&×¼ay.
tbl
[
size
]);

4834 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4835 
i
=0; i<
x4a
->
couÁ
; i++){

4836 
x4node
 *
ŞdÅ
, *
ÃwÅ
;

4837 
ŞdÅ
 = &(
x4a
->
tbl
[
i
]);

4838 
h
 = 
	`cÚfighash
(
ŞdÅ
->
d©a
è& (
size
-1);

4839 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4840 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4841 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4842 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4843 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4844 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4846 
	`ä“
(
x4a
->
tbl
);

4847 *
x4a
 = 
¬¿y
;

4850 
h
 = 
ph
 & (
x4a
->
size
-1);

4851 
Å
 = &(
x4a
->
tbl
[x4a->
couÁ
++]);

4852 
Å
->
d©a
 = data;

4853 ifĞ
x4a
->
ht
[
h
] ) x4a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4854 
Å
->
Ãxt
 = 
x4a
->
ht
[
h
];

4855 
x4a
->
ht
[
h
] = 
Å
;

4856 
Å
->
äom
 = &(
x4a
->
ht
[
h
]);

4858 
	}
}

4862 
cÚfig
 *
	$CÚfigbË_fšd
(
key
)

4863 
cÚfig
 *
key
;

4865 
h
;

4866 
x4node
 *
Å
;

4868 ifĞ
x4a
==0 )  0;

4869 
h
 = 
	`cÚfighash
(
key
è& (
x4a
->
size
-1);

4870 
Å
 = 
x4a
->
ht
[
h
];

4871  
Å
 ){

4872 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,
key
)==0 ) ;

4873 
Å
 =‚p->
Ãxt
;

4875  
Å
 ?‚p->
d©a
 : 0;

4876 
	}
}

4880 
	$CÚfigbË_ş—r
(
f
)

4881 (*
f
)( );

4883 
i
;

4884 ifĞ
x4a
==0 || x4a->
couÁ
==0 ) ;

4885 ifĞ
f
 ) 
i
=0; i<
x4a
->
couÁ
; i++è(*f)(x4a->
tbl
[i].
d©a
);

4886 
i
=0; i<
x4a
->
size
; i++èx4a->
ht
[i] = 0;

4887 
x4a
->
couÁ
 = 0;

4889 
	}
}

	@tools/lemon/lempar.c

6 
	~<¡dio.h
>

7 %% /* 
	$yy·r£
 */ 
	`yyËx
()

18 
	}
%%

21 #iâdeà
INTERFACE


22 
	#INTERFACE
 1

	)

58 %% /* 
	$yy·r£
 */ 
	`yyËx
()

59 #
defše
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

60 #
defše
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

61 #
defše
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

65 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

75 #
iâdef
 
yy‹¡ÿ£


76 #
defše
 
	`yy‹¡ÿ£
(
X
)

77 #
’dif


127 
	}
%%

128 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

140 #ifdeà
YYFALLBACK


141 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

142 %% /* 
	$yy·r£
 */ 
	`yyËx
()

144 #
’dif


158 
	syySckEÁry
 {

159 
YYACTIONTYPE
 
	m¡©’o
;

160 
YYCODETYPE
 
	mmajÜ
;

162 
YYMINORTYPE
 
	mmšÜ
;

165 
yySckEÁry
 
	tyySckEÁry
;

169 
	syyP¬£r
 {

170 
	myyidx
;

171 #
ifdef
 
YYTRACKMAXSTACKDEPTH


172 
	myyidxMax
;

173 #
’dif


174 
	myy”rút
;

175 
	mP¬£ARG_SDECL


176 #
YYSTACKDEPTH
<=0

177 
	myy¡ksz
;

178 
yySckEÁry
 *
	myy¡ack
;

180 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

181 #
’dif


183 
yyP¬£r
 
	tyyP¬£r
;

185 #
iâdef
 
NDEBUG


186 #
šşude
 <
¡dio
.
h
>

187 
FILE
 *
	gyyT¿ûFILE
 = 0;

188 *
	gyyT¿ûProm±
 = 0;

189 #
’dif


191 #
iâdef
 
NDEBUG


209 
	`P¬£T¿û
(
FILE
 *
	gT¿ûFILE
, *
	gzT¿ûProm±
){

210 
	gyyT¿ûFILE
 = 
T¿ûFILE
;

211 
	gyyT¿ûProm±
 = 
zT¿ûProm±
;

212 ifĞ
	gyyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

213 ifĞ
	gyyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

215 #
’dif


217 #
iâdef
 
NDEBUG


220 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

221 
	}
%%

225 #iâdeà
NDEBUG


228 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

229 %% /* 
	$yy·r£
 */ 
	`yyËx
()

231 #
’dif


234 #
YYSTACKDEPTH
<=0

238 
	`yyGrowSck
(
yyP¬£r
 *
	gp
){

239 
	gÃwSize
;

240 
yySckEÁry
 *
	gpNew
;

242 
	gÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

243 
	gpNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

244 ifĞ
	gpNew
 ){

245 
	gp
->
	gyy¡ack
 = 
pNew
;

246 
	gp
->
	gyy¡ksz
 = 
ÃwSize
;

247 #
iâdef
 
NDEBUG


248 ifĞ
	gyyT¿ûFILE
 ){

249 
	`årštf
(
	gyyT¿ûFILE
,"%sStack growso %dƒntries!\n",

250 
	gyyT¿ûProm±
, 
	gp
->
	gyy¡ksz
);

252 #
’dif


255 #
’dif


269 *
	`P¬£AÎoc
(*(*
	gm®locProc
)(
	gsize_t
)){

270 
yyP¬£r
 *
	gpP¬£r
;

271 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

272 ifĞ
	gpP¬£r
 ){

273 
	gpP¬£r
->
	gyyidx
 = -1;

274 #
ifdef
 
YYTRACKMAXSTACKDEPTH


275 
	gpP¬£r
->
	gyyidxMax
 = 0;

276 #
’dif


277 #
YYSTACKDEPTH
<=0

278 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

279 
	gpP¬£r
->
	gyy¡ksz
 = 0;

280 
	`yyGrowSck
(
	gpP¬£r
);

281 #
’dif


283  
	gpP¬£r
;

291 
	`yy_de¡ruùÜ
(

292 
yyP¬£r
 *
	gyypP¬£r
,

293 
YYCODETYPE
 
	gyymajÜ
,

294 
YYMINORTYPE
 *
	gyypmšÜ


296 
	gP¬£ARG_FETCH
;

297  
	gyymajÜ
 ){

308 
	}
%%

321 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

322 
YYCODETYPE
 
yymajÜ
;

323 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

325 ifĞ
pP¬£r
->
yyidx
<0 )  0;

326 #iâdeà
NDEBUG


327 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

328 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

329 
yyT¿ûProm±
,

330 
yyTok’Name
[
yytos
->
majÜ
]);

333 
yymajÜ
 = 
yytos
->
majÜ
;

334 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

335 
pP¬£r
->
yyidx
--;

336  
yymajÜ
;

337 
	}
}

351 
P¬£F»e
(

352 *
p
,

353 (*
ä“Proc
)(*)

355 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

356 ifĞ
pP¬£r
==0 ) ;

357  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

358 #ià
YYSTACKDEPTH
<=0

359 
	`ä“
(
pP¬£r
->
yy¡ack
);

361 (*
ä“Proc
)((*)
pP¬£r
);

362 
	}
}

367 #ifdeà
YYTRACKMAXSTACKDEPTH


368 
	$P¬£SckP—k
(*
p
){

369 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

370  
pP¬£r
->
yyidxMax
;

371 
	}
}

382 
	$yy_fšd_shiá_aùiÚ
(

383 
yyP¬£r
 *
pP¬£r
,

384 
YYCODETYPE
 
iLookAh—d


386 
i
;

387 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

389 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

390  
yy_deçuÉ
[
¡©’o
];

392 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

393 
i
 +ğ
iLookAh—d
;

394 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

395 ifĞ
iLookAh—d
>0 ){

396 #ifdeà
YYFALLBACK


397 
YYCODETYPE
 
iF®lback
;

398 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

399 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

400 #iâdeà
NDEBUG


401 ifĞ
yyT¿ûFILE
 ){

402 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

403 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

406  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

409 #ifdeà
YYWILDCARD


411 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

412 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

413 #iâdeà
NDEBUG


414 ifĞ
yyT¿ûFILE
 ){

415 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

416 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

419  
yy_aùiÚ
[
j
];

424  
yy_deçuÉ
[
¡©’o
];

426  
yy_aùiÚ
[
i
];

428 
	}
}

438 
	$yy_fšd_»duû_aùiÚ
(

439 
¡©’o
,

440 
YYCODETYPE
 
iLookAh—d


442 
i
;

443 #ifdeà
YYERRORSYMBOL


444 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

445  
yy_deçuÉ
[
¡©’o
];

448 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

450 
i
 = 
yy_»duû_of¡
[
¡©’o
];

451 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

452 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

453 
i
 +ğ
iLookAh—d
;

454 #ifdeà
YYERRORSYMBOL


455 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

456  
yy_deçuÉ
[
¡©’o
];

459 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

460 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

462  
yy_aùiÚ
[
i
];

463 
	}
}

468 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

469 
P¬£ARG_FETCH
;

470 
yypP¬£r
->
yyidx
--;

471 #iâdeà
NDEBUG


472 ifĞ
yyT¿ûFILE
 ){

473 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

476  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

479 %% /* 
	$yy·r£
 */ 
	`yyËx
()

480 
P¬£ARG_STORE
;

481 
	}
}

486 
	`yy_shiá
(

487 
yyP¬£r
 *
	gyypP¬£r
,

488 
	gyyNewS‹
,

489 
	gyyMajÜ
,

490 
YYMINORTYPE
 *
	gyypMšÜ


492 
yySckEÁry
 *
	gyytos
;

493 
	gyypP¬£r
->
	gyyidx
++;

494 #
ifdef
 
YYTRACKMAXSTACKDEPTH


495 ifĞ
	gyypP¬£r
->
	gyyidx
>yypP¬£r->
	gyyidxMax
 ){

496 
	gyypP¬£r
->
	gyyidxMax
 = 
yypP¬£r
->
yyidx
;

498 #
’dif


499 #
YYSTACKDEPTH
>0

500 ifĞ
	gyypP¬£r
->
	gyyidx
>=
YYSTACKDEPTH
 ){

501 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

505 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

506 
	`yyGrowSck
(
yypP¬£r
);

507 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

508 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

512 #
’dif


513 
	gyytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

514 
	gyytos
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

515 
	gyytos
->
	gmajÜ
 = (
YYCODETYPE
)
yyMajÜ
;

516 
	gyytos
->
	gmšÜ
 = *
yypMšÜ
;

517 #
iâdef
 
NDEBUG


518 ifĞ
	gyyT¿ûFILE
 && 
	gyypP¬£r
->
	gyyidx
>0 ){

519 
	gi
;

520 
	`årštf
(
	gyyT¿ûFILE
,"%sShiá %d\n",
	gyyT¿ûProm±
,
	gyyNewS‹
);

521 
	`årštf
(
	gyyT¿ûFILE
,"%sSck:",
	gyyT¿ûProm±
);

522 
	gi
=1; i<=
yypP¬£r
->
yyidx
; i++)

523 
	`årštf
(
	gyyT¿ûFILE
," %s",
	gyyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
	gmajÜ
]);

524 
	`årštf
(
	gyyT¿ûFILE
,"\n");

526 #
’dif


533 
YYCODETYPE
 
	mlhs
;

534 
	mÄhs
;

535 } 
	gyyRuËInfo
[] = {

536 
	}
%%

539 
yy_acû±
(
yyP¬£r
*);

545 
	$yy_»duû
(

546 
yyP¬£r
 *
yypP¬£r
,

547 
yyruËno


549 
yygÙo
;

550 
yyaù
;

551 
YYMINORTYPE
 
yygÙomšÜ
;

552 
yySckEÁry
 *
yym¥
;

553 
yysize
;

554 
P¬£ARG_FETCH
;

555 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

556 #iâdeà
NDEBUG


557 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

558 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

559 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

560 
yyRuËName
[
yyruËno
]);

579 
yygÙomšÜ
 = 
yyz”omšÜ
;

582  
yyruËno
 ){

591 %% /* 
	$yy·r£
 */ 
	`yyËx
()

592 
	}
};

593 
	gyygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

594 
	gyysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

595 
	gyypP¬£r
->
	gyyidx
 -ğ
yysize
;

596 
	gyyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
	gYYCODETYPE
)
	gyygÙo
);

597 ifĞ
	gyyaù
 < 
	gYYNSTATE
 ){

598 #
ifdef
 
NDEBUG


603 ifĞ
	gyysize
 ){

604 
	gyypP¬£r
->
	gyyidx
++;

605 
	gyym¥
 -ğ
yysize
-1;

606 
	gyym¥
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

607 
	gyym¥
->
	gmajÜ
 = (
YYCODETYPE
)
yygÙo
;

608 
	gyym¥
->
	gmšÜ
 = 
yygÙomšÜ
;

610 #
’dif


612 
	`yy_shiá
(
	gyypP¬£r
,
	gyyaù
,
	gyygÙo
,&
	gyygÙomšÜ
);

615 
	`as£¹
Ğ
	gyyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

616 
	`yy_acû±
(
	gyypP¬£r
);

623 #
iâdef
 
YYNOERRORRECOVERY


624 
	`yy_·r£_çed
(

625 
yyP¬£r
 *
	gyypP¬£r


627 
	gP¬£ARG_FETCH
;

628 #
iâdef
 
NDEBUG


629 ifĞ
	gyyT¿ûFILE
 ){

630 
	`årštf
(
	gyyT¿ûFILE
,"%sFa!\n",
	gyyT¿ûProm±
);

632 #
’dif


633  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

636 
	}
%%

637 
	gP¬£ARG_STORE
;

644 
	$yy_syÁax_”rÜ
(

645 
yyP¬£r
 *
yypP¬£r
,

646 
yymajÜ
,

647 
YYMINORTYPE
 
yymšÜ


649 
P¬£ARG_FETCH
;

650 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

651 %% /* 
	$yy·r£
 */ 
	`yyËx
()

652 
P¬£ARG_STORE
;

653 
	}
}

658 
	`yy_acû±
(

659 
yyP¬£r
 *
	gyypP¬£r


661 
	gP¬£ARG_FETCH
;

662 #
iâdef
 
NDEBUG


663 ifĞ
	gyyT¿ûFILE
 ){

664 
	`årštf
(
	gyyT¿ûFILE
,"%sAcû±!\n",
	gyyT¿ûProm±
);

666 #
’dif


667  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

670 
	}
%%

671 
	gP¬£ARG_STORE
;

693 
	$P¬£
(

694 *
yyp
,

695 
yymajÜ
,

696 
P¬£TOKENTYPE
 
yymšÜ


697 
P¬£ARG_PDECL


699 
YYMINORTYPE
 
yymšÜuniÚ
;

700 
yyaù
;

701 
yy’dofšput
;

702 #ifdeà
YYERRORSYMBOL


703 
yy”rÜh™
 = 0;

705 
yyP¬£r
 *
yypP¬£r
;

708 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

709 ifĞ
yypP¬£r
->
yyidx
<0 ){

710 #ià
YYSTACKDEPTH
<=0

711 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

713 
yymšÜuniÚ
 = 
yyz”omšÜ
;

714 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

718 
yypP¬£r
->
yyidx
 = 0;

719 
yypP¬£r
->
yy”rút
 = -1;

720 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

721 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

723 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

724 
yy’dofšput
 = (
yymajÜ
==0);

725 
P¬£ARG_STORE
;

727 #iâdeà
NDEBUG


728 ifĞ
yyT¿ûFILE
 ){

729 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

734 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

735 ifĞ
yyaù
<
YYNSTATE
 ){

736 
	`as£¹
Ğ!
yy’dofšput
 );

737 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

738 
yypP¬£r
->
yy”rút
--;

739 
yymajÜ
 = 
YYNOCODE
;

740 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

741 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

743 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

744 #ifdeà
YYERRORSYMBOL


745 
yymx
;

747 #iâdeà
NDEBUG


748 ifĞ
yyT¿ûFILE
 ){

749 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

752 #ifdeà
YYERRORSYMBOL


772 ifĞ
yypP¬£r
->
yy”rút
<0 ){

773 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

775 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

776 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

777 #iâdeà
NDEBUG


778 ifĞ
yyT¿ûFILE
 ){

779 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

780 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

783 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

784 
yymajÜ
 = 
YYNOCODE
;

787 
yypP¬£r
->
yyidx
 >= 0 &&

788 
yymx
 !ğ
YYERRORSYMBOL
 &&

789 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

790 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

791 
YYERRORSYMBOL
)è>ğ
YYNSTATE


793 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

795 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

796 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

797 
	`yy_·r£_çed
(
yypP¬£r
);

798 
yymajÜ
 = 
YYNOCODE
;

799 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

800 
YYMINORTYPE
 
u2
;

801 
u2
.
YYERRSYMDT
 = 0;

802 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

805 
yypP¬£r
->
yy”rút
 = 3;

806 
yy”rÜh™
 = 1;

807 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

815 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

816 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

817 
yymajÜ
 = 
YYNOCODE
;

829 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

830 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

832 
yypP¬£r
->
yy”rút
 = 3;

833 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

834 ifĞ
yy’dofšput
 ){

835 
	`yy_·r£_çed
(
yypP¬£r
);

837 
yymajÜ
 = 
YYNOCODE
;

840 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

842 
	}
}

	@tools/m2sh/lempar.c

6 
	~<¡dio.h
>

7 %% /* 
	$yy·r£
 */ 
	`yyËx
()

18 
	}
%%

21 #iâdeà
INTERFACE


22 
	#INTERFACE
 1

	)

58 %% /* 
	$yy·r£
 */ 
	`yyËx
()

59 #
defše
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

60 #
defše
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

61 #
defše
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

65 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

75 #
iâdef
 
yy‹¡ÿ£


76 #
defše
 
	`yy‹¡ÿ£
(
X
)

77 #
’dif


127 
	}
%%

128 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

140 #ifdeà
YYFALLBACK


141 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

142 %% /* 
	$yy·r£
 */ 
	`yyËx
()

144 #
’dif


158 
	syySckEÁry
 {

159 
YYACTIONTYPE
 
	m¡©’o
;

160 
YYCODETYPE
 
	mmajÜ
;

162 
YYMINORTYPE
 
	mmšÜ
;

165 
yySckEÁry
 
	tyySckEÁry
;

169 
	syyP¬£r
 {

170 
	myyidx
;

171 #
ifdef
 
YYTRACKMAXSTACKDEPTH


172 
	myyidxMax
;

173 #
’dif


174 
	myy”rút
;

175 
	mP¬£ARG_SDECL


176 #
YYSTACKDEPTH
<=0

177 
	myy¡ksz
;

178 
yySckEÁry
 *
	myy¡ack
;

180 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

181 #
’dif


183 
yyP¬£r
 
	tyyP¬£r
;

185 #
iâdef
 
NDEBUG


186 #
šşude
 <
¡dio
.
h
>

187 
FILE
 *
	gyyT¿ûFILE
 = 0;

188 *
	gyyT¿ûProm±
 = 0;

189 #
’dif


191 #
iâdef
 
NDEBUG


209 
	`P¬£T¿û
(
FILE
 *
	gT¿ûFILE
, *
	gzT¿ûProm±
){

210 
	gyyT¿ûFILE
 = 
T¿ûFILE
;

211 
	gyyT¿ûProm±
 = 
zT¿ûProm±
;

212 ifĞ
	gyyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

213 ifĞ
	gyyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

215 #
’dif


217 #
iâdef
 
NDEBUG


220 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

221 
	}
%%

225 #iâdeà
NDEBUG


228 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

229 %% /* 
	$yy·r£
 */ 
	`yyËx
()

231 #
’dif


234 #
YYSTACKDEPTH
<=0

238 
	`yyGrowSck
(
yyP¬£r
 *
	gp
){

239 
	gÃwSize
;

240 
yySckEÁry
 *
	gpNew
;

242 
	gÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

243 
	gpNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

244 ifĞ
	gpNew
 ){

245 
	gp
->
	gyy¡ack
 = 
pNew
;

246 
	gp
->
	gyy¡ksz
 = 
ÃwSize
;

247 #
iâdef
 
NDEBUG


248 ifĞ
	gyyT¿ûFILE
 ){

249 
	`årštf
(
	gyyT¿ûFILE
,"%sStack growso %dƒntries!\n",

250 
	gyyT¿ûProm±
, 
	gp
->
	gyy¡ksz
);

252 #
’dif


255 #
’dif


269 *
	`P¬£AÎoc
(*(*
	gm®locProc
)(
	gsize_t
)){

270 
yyP¬£r
 *
	gpP¬£r
;

271 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

272 ifĞ
	gpP¬£r
 ){

273 
	gpP¬£r
->
	gyyidx
 = -1;

274 #
ifdef
 
YYTRACKMAXSTACKDEPTH


275 
	gpP¬£r
->
	gyyidxMax
 = 0;

276 #
’dif


277 #
YYSTACKDEPTH
<=0

278 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

279 
	gpP¬£r
->
	gyy¡ksz
 = 0;

280 
	`yyGrowSck
(
	gpP¬£r
);

281 #
’dif


283  
	gpP¬£r
;

291 
	`yy_de¡ruùÜ
(

292 
yyP¬£r
 *
	gyypP¬£r
,

293 
YYCODETYPE
 
	gyymajÜ
,

294 
YYMINORTYPE
 *
	gyypmšÜ


296 
	gP¬£ARG_FETCH
;

297  
	gyymajÜ
 ){

308 
	}
%%

321 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

322 
YYCODETYPE
 
yymajÜ
;

323 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

325 ifĞ
pP¬£r
->
yyidx
<0 )  0;

326 #iâdeà
NDEBUG


327 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

328 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

329 
yyT¿ûProm±
,

330 
yyTok’Name
[
yytos
->
majÜ
]);

333 
yymajÜ
 = 
yytos
->
majÜ
;

334 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

335 
pP¬£r
->
yyidx
--;

336  
yymajÜ
;

337 
	}
}

351 
P¬£F»e
(

352 *
p
,

353 (*
ä“Proc
)(*)

355 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

356 ifĞ
pP¬£r
==0 ) ;

357  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

358 #ià
YYSTACKDEPTH
<=0

359 
	`ä“
(
pP¬£r
->
yy¡ack
);

361 (*
ä“Proc
)((*)
pP¬£r
);

362 
	}
}

367 #ifdeà
YYTRACKMAXSTACKDEPTH


368 
	$P¬£SckP—k
(*
p
){

369 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

370  
pP¬£r
->
yyidxMax
;

371 
	}
}

382 
	$yy_fšd_shiá_aùiÚ
(

383 
yyP¬£r
 *
pP¬£r
,

384 
YYCODETYPE
 
iLookAh—d


386 
i
;

387 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

389 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

390  
yy_deçuÉ
[
¡©’o
];

392 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

393 
i
 +ğ
iLookAh—d
;

394 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

395 ifĞ
iLookAh—d
>0 ){

396 #ifdeà
YYFALLBACK


397 
YYCODETYPE
 
iF®lback
;

398 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

399 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

400 #iâdeà
NDEBUG


401 ifĞ
yyT¿ûFILE
 ){

402 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

403 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

406  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

409 #ifdeà
YYWILDCARD


411 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

412 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

413 #iâdeà
NDEBUG


414 ifĞ
yyT¿ûFILE
 ){

415 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

416 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

419  
yy_aùiÚ
[
j
];

424  
yy_deçuÉ
[
¡©’o
];

426  
yy_aùiÚ
[
i
];

428 
	}
}

438 
	$yy_fšd_»duû_aùiÚ
(

439 
¡©’o
,

440 
YYCODETYPE
 
iLookAh—d


442 
i
;

443 #ifdeà
YYERRORSYMBOL


444 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

445  
yy_deçuÉ
[
¡©’o
];

448 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

450 
i
 = 
yy_»duû_of¡
[
¡©’o
];

451 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

452 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

453 
i
 +ğ
iLookAh—d
;

454 #ifdeà
YYERRORSYMBOL


455 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

456  
yy_deçuÉ
[
¡©’o
];

459 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

460 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

462  
yy_aùiÚ
[
i
];

463 
	}
}

468 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

469 
P¬£ARG_FETCH
;

470 
yypP¬£r
->
yyidx
--;

471 #iâdeà
NDEBUG


472 ifĞ
yyT¿ûFILE
 ){

473 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

476  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

479 %% /* 
	$yy·r£
 */ 
	`yyËx
()

480 
P¬£ARG_STORE
;

481 
	}
}

486 
	`yy_shiá
(

487 
yyP¬£r
 *
	gyypP¬£r
,

488 
	gyyNewS‹
,

489 
	gyyMajÜ
,

490 
YYMINORTYPE
 *
	gyypMšÜ


492 
yySckEÁry
 *
	gyytos
;

493 
	gyypP¬£r
->
	gyyidx
++;

494 #
ifdef
 
YYTRACKMAXSTACKDEPTH


495 ifĞ
	gyypP¬£r
->
	gyyidx
>yypP¬£r->
	gyyidxMax
 ){

496 
	gyypP¬£r
->
	gyyidxMax
 = 
yypP¬£r
->
yyidx
;

498 #
’dif


499 #
YYSTACKDEPTH
>0

500 ifĞ
	gyypP¬£r
->
	gyyidx
>=
YYSTACKDEPTH
 ){

501 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

505 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

506 
	`yyGrowSck
(
yypP¬£r
);

507 ifĞ
	gyypP¬£r
->
	gyyidx
>=
yypP¬£r
->
yy¡ksz
 ){

508 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

512 #
’dif


513 
	gyytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

514 
	gyytos
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

515 
	gyytos
->
	gmajÜ
 = (
YYCODETYPE
)
yyMajÜ
;

516 
	gyytos
->
	gmšÜ
 = *
yypMšÜ
;

517 #
iâdef
 
NDEBUG


518 ifĞ
	gyyT¿ûFILE
 && 
	gyypP¬£r
->
	gyyidx
>0 ){

519 
	gi
;

520 
	`årštf
(
	gyyT¿ûFILE
,"%sShiá %d\n",
	gyyT¿ûProm±
,
	gyyNewS‹
);

521 
	`årštf
(
	gyyT¿ûFILE
,"%sSck:",
	gyyT¿ûProm±
);

522 
	gi
=1; i<=
yypP¬£r
->
yyidx
; i++)

523 
	`årštf
(
	gyyT¿ûFILE
," %s",
	gyyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
	gmajÜ
]);

524 
	`årštf
(
	gyyT¿ûFILE
,"\n");

526 #
’dif


533 
YYCODETYPE
 
	mlhs
;

534 
	mÄhs
;

535 } 
	gyyRuËInfo
[] = {

536 
	}
%%

539 
yy_acû±
(
yyP¬£r
*);

545 
	$yy_»duû
(

546 
yyP¬£r
 *
yypP¬£r
,

547 
yyruËno


549 
yygÙo
;

550 
yyaù
;

551 
YYMINORTYPE
 
yygÙomšÜ
;

552 
yySckEÁry
 *
yym¥
;

553 
yysize
;

554 
P¬£ARG_FETCH
;

555 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

556 #iâdeà
NDEBUG


557 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

558 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

559 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

560 
yyRuËName
[
yyruËno
]);

579 
yygÙomšÜ
 = 
yyz”omšÜ
;

582  
yyruËno
 ){

591 %% /* 
	$yy·r£
 */ 
	`yyËx
()

592 
	}
};

593 
	gyygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

594 
	gyysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

595 
	gyypP¬£r
->
	gyyidx
 -ğ
yysize
;

596 
	gyyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
	gYYCODETYPE
)
	gyygÙo
);

597 ifĞ
	gyyaù
 < 
	gYYNSTATE
 ){

598 #
ifdef
 
NDEBUG


603 ifĞ
	gyysize
 ){

604 
	gyypP¬£r
->
	gyyidx
++;

605 
	gyym¥
 -ğ
yysize
-1;

606 
	gyym¥
->
	g¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

607 
	gyym¥
->
	gmajÜ
 = (
YYCODETYPE
)
yygÙo
;

608 
	gyym¥
->
	gmšÜ
 = 
yygÙomšÜ
;

610 #
’dif


612 
	`yy_shiá
(
	gyypP¬£r
,
	gyyaù
,
	gyygÙo
,&
	gyygÙomšÜ
);

615 
	`as£¹
Ğ
	gyyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

616 
	`yy_acû±
(
	gyypP¬£r
);

623 #
iâdef
 
YYNOERRORRECOVERY


624 
	`yy_·r£_çed
(

625 
yyP¬£r
 *
	gyypP¬£r


627 
	gP¬£ARG_FETCH
;

628 #
iâdef
 
NDEBUG


629 ifĞ
	gyyT¿ûFILE
 ){

630 
	`årštf
(
	gyyT¿ûFILE
,"%sFa!\n",
	gyyT¿ûProm±
);

632 #
’dif


633  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

636 
	}
%%

637 
	gP¬£ARG_STORE
;

644 
	$yy_syÁax_”rÜ
(

645 
yyP¬£r
 *
yypP¬£r
,

646 
yymajÜ
,

647 
YYMINORTYPE
 
yymšÜ


649 
P¬£ARG_FETCH
;

650 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

651 %% /* 
	$yy·r£
 */ 
	`yyËx
()

652 
P¬£ARG_STORE
;

653 
	}
}

658 
	`yy_acû±
(

659 
yyP¬£r
 *
	gyypP¬£r


661 
	gP¬£ARG_FETCH
;

662 #
iâdef
 
NDEBUG


663 ifĞ
	gyyT¿ûFILE
 ){

664 
	`årštf
(
	gyyT¿ûFILE
,"%sAcû±!\n",
	gyyT¿ûProm±
);

666 #
’dif


667  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

670 
	}
%%

671 
	gP¬£ARG_STORE
;

693 
	$P¬£
(

694 *
yyp
,

695 
yymajÜ
,

696 
P¬£TOKENTYPE
 
yymšÜ


697 
P¬£ARG_PDECL


699 
YYMINORTYPE
 
yymšÜuniÚ
;

700 
yyaù
;

701 
yy’dofšput
;

702 #ifdeà
YYERRORSYMBOL


703 
yy”rÜh™
 = 0;

705 
yyP¬£r
 *
yypP¬£r
;

708 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

709 ifĞ
yypP¬£r
->
yyidx
<0 ){

710 #ià
YYSTACKDEPTH
<=0

711 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

713 
yymšÜuniÚ
 = 
yyz”omšÜ
;

714 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

718 
yypP¬£r
->
yyidx
 = 0;

719 
yypP¬£r
->
yy”rút
 = -1;

720 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

721 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

723 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

724 
yy’dofšput
 = (
yymajÜ
==0);

725 
P¬£ARG_STORE
;

727 #iâdeà
NDEBUG


728 ifĞ
yyT¿ûFILE
 ){

729 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

734 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

735 ifĞ
yyaù
<
YYNSTATE
 ){

736 
	`as£¹
Ğ!
yy’dofšput
 );

737 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

738 
yypP¬£r
->
yy”rút
--;

739 
yymajÜ
 = 
YYNOCODE
;

740 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

741 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

743 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

744 #ifdeà
YYERRORSYMBOL


745 
yymx
;

747 #iâdeà
NDEBUG


748 ifĞ
yyT¿ûFILE
 ){

749 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

752 #ifdeà
YYERRORSYMBOL


772 ifĞ
yypP¬£r
->
yy”rút
<0 ){

773 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

775 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

776 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

777 #iâdeà
NDEBUG


778 ifĞ
yyT¿ûFILE
 ){

779 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

780 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

783 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

784 
yymajÜ
 = 
YYNOCODE
;

787 
yypP¬£r
->
yyidx
 >= 0 &&

788 
yymx
 !ğ
YYERRORSYMBOL
 &&

789 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

790 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

791 
YYERRORSYMBOL
)è>ğ
YYNSTATE


793 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

795 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

796 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

797 
	`yy_·r£_çed
(
yypP¬£r
);

798 
yymajÜ
 = 
YYNOCODE
;

799 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

800 
YYMINORTYPE
 
u2
;

801 
u2
.
YYERRSYMDT
 = 0;

802 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

805 
yypP¬£r
->
yy”rút
 = 3;

806 
yy”rÜh™
 = 1;

807 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

815 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

816 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

817 
yymajÜ
 = 
YYNOCODE
;

829 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

830 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

832 
yypP¬£r
->
yy”rút
 = 3;

833 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

834 ifĞ
yy’dofšput
 ){

835 
	`yy_·r£_çed
(
yypP¬£r
);

837 
yymajÜ
 = 
YYNOCODE
;

840 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

842 
	}
}

	@tools/m2sh/src/ast.c

35 
	~"a¡.h
"

36 
	~<¡dlib.h
>

37 
	~<dbg.h
>

38 
	~<as£¹.h
>

41 
V®ue
 *
	$V®ue_ü—‹
(
V®ueTy³
 
ty³
, *
d©a
) {

42 
V®ue
 *
v®
 = 
	`m®loc
((Value));

43 
v®
->
ty³
 =ype;

44 
v®
->
ty³
) {

45 
VAL_QSTRING
: 
v®
->
as
.
¡ršg
 = 
d©a
;

47 
VAL_PATTERN
: 
v®
->
as
.
·‰”n
 = 
d©a
;

49 
VAL_NUMBER
: 
v®
->
as
.
numb”
 = 
d©a
;

51 
VAL_CLASS
: 
v®
->
as
.
şs
 = 
d©a
;

53 
VAL_LIST
: 
v®
->
as
.
li¡
 = 
d©a
;

55 
VAL_HASH
: 
v®
->
as
.
hash
 = 
d©a
;

57 
VAL_IDENT
: 
v®
->
as
.
id’t
 = 
d©a
;

59 
VAL_REF
: 
v®
->
as
.
»f
 = 
d©a
;

62 
	`£Áš–
("UnknowÀv®uty³: %d", 
v®
->
ty³
);

65  
v®
;

67 
”rÜ
:

68  
v®
;

69 
	}
}

71 cÚ¡ *
	gVALUE_NAMES
[] = {

76 cÚ¡ *
	$V®ue_ty³_Çme
(
V®ueTy³
 
ty³
)

78  
VALUE_NAMES
[
ty³
];

79 
	}
}

81 
V®ue
 *
	$V®ue_»sŞve
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
v®
)

83 if(
	`V®ue_is
(
v®
, 
REF
)) {

84 
Paœ
 *
·œ
 = 
	`t¡_£¬ch
(
£‰šgs
, 
	`bd©a
(
v®
->
as
.
»f
->
d©a
), 
	`bËngth
(val->as.ref->data));

85 
	`check
(
·œ
 !ğ
NULL
, "Couldn'ˆfšd v¬ŸbË‚amed: %s", 
	`bd©a
(
v®
->
as
.
»f
->
d©a
));

86  
	`Paœ_v®ue
(
·œ
);

88  
v®
;

91 
”rÜ
:

92  
NULL
;

93 
	}
}

95 
	$AST_w®k_li¡
(
t¡_t
 *
£‰šgs
, 
li¡_t
 *
d©a
, 
a¡_w®k_cb
 
cb
)

97 
Êode_t
 *
n
 = 
NULL
;

98 
rc
 = 0;

100 
n
 = 
	`li¡_fœ¡
(
d©a
);‚ !ğ
NULL
;‚ = 
	`li¡_Ãxt
(data,‚)) {

101 
V®ue
 *
»f
 = 
	`Êode_g‘
(
n
);

102 
	`check
(
»f
, "List got‡ NULL value in it. Huh?");

104 
V®ue
 *
found
 = 
	`V®ue_»sŞve
(
£‰šgs
, 
»f
);

106 
	`check
(
found
, "Inv®id„eã»nû: %s", 
	`bd©a
(
»f
->
as
.»f->
d©a
));

107 
rc
 = 
	`cb
(
£‰šgs
, 
found
);

108 
	`check_debug
(
rc
 == 0, "Failure…rocessing config file. Aborting.");

113 
”rÜ
:

115 
	}
}

117 
gb¡ršg
 
	gDEFAULT_ROOT
 = 
bsStic
("servers");

119 
	$AST_w®k
(
t¡_t
 *
£‰šgs
, 
a¡_w®k_cb
 
cb
)

121 
Paœ
 *
n
 = 
	`t¡_£¬ch
(
£‰šgs
, 
	`bd©a
(&
DEFAULT_ROOT
), 
	`bËngth
(&DEFAULT_ROOT));

122 
	`check
(
n
, "You didn't set‡ %s variableo say what servers you want.",

123 
	`bd©a
(&
DEFAULT_ROOT
));

125 
V®ue
 *
v®
 = 
	`Paœ_v®ue
(
n
);

126 
	`check
(
v®
->
ty³
 =ğ
VAL_LIST
, "servers variable should be‡†ist of server configso†oad.");

128  
	`AST_w®k_li¡
(
£‰šgs
, 
v®
->
as
.
li¡
, 
cb
);

130 
”rÜ
:

132 
	}
}

134 
	sASTSÿnD©a
 {

135 
t¡_t
 *
	m£‰šgs
;

136 
a¡_hash_w®k_cb
 
	mcb
;

137 
	m”rÜ
;

140 
	$a¡_hash_Œav”£_cb
(*
v®ue
, *
d©a
)

143 
Paœ
 
·œ
 = *((Paœ *)
v®ue
);

144 
ASTSÿnD©a
 *
sÿn
 = 
d©a
;

147 if(
	`V®ue_is
(
·œ
.
v®ue
, 
REF
)) {

148 
·œ
.
v®ue
 = 
	`V®ue_»sŞve
(
sÿn
->
£‰šgs
,…air.value);

151 
rc
 = 
sÿn
->
	`cb
(sÿn->
£‰šgs
, &
·œ
);

152 
sÿn
->
”rÜ
 = sÿn->”rÜ =ğ0 ? 
rc
 : scan->error;

153 
	}
}

155 
	$AST_w®k_hash
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
d©a
, 
a¡_hash_w®k_cb
 
cb
)

157 
ASTSÿnD©a
 
sÿn
 = {.
£‰šgs
 = s‘tšgs, .
cb
 = cb, .
”rÜ
 = 0};

158 
	`t¡_Œav”£
(
d©a
->
as
.
hash
, 
a¡_hash_Œav”£_cb
, &
sÿn
);

159  
sÿn
.
”rÜ
;

160 
	}
}

163 
V®ue
 *
	$AST_g‘
(
t¡_t
 *
£‰šgs
,¡_ˆ*
ä
, 
b¡ršg
 
Çme
, 
V®ueTy³
 
ty³
)

165 
Paœ
 *
·œ
 = 
	`t¡_£¬ch
(
ä
, 
	`bd©a
(
Çme
), 
	`bËngth
(name));

166 
	`check_debug
(
·œ
, "Couldn'ˆfšd v¬ŸbË % oàty³ %s", 
	`bd©a
(
Çme
), 
	`V®ue_ty³_Çme
(
ty³
));

168 
V®ue
 *
v®
 = 
	`Paœ_v®ue
(
·œ
);

170 if(
	`V®ue_is
(
v®
, 
REF
)) {

171 
v®
 = 
	`V®ue_»sŞve
(
£‰šgs
, val);

172 
	`check
(
v®
, "Couldn't find variable %s ofype %s",

173 
	`bd©a
(
Çme
), 
	`V®ue_ty³_Çme
(
ty³
));

176 
	`check
(
v®
->
ty³
 ==ype, "Invalidype for %s, should be %s‚ot %s",

177 
	`bd©a
(
Çme
), 
	`V®ue_ty³_Çme
(
ty³
), V®ue_ty³_Çme(
v®
->type));

179  
v®
;

181 
”rÜ
:

182  
NULL
;

183 
	}
}

186 
b¡ršg
 
	$AST_g‘_b¡r
(
t¡_t
 *
£‰šgs
,¡_ˆ*
ä
, 
b¡ršg
 
Çme
, 
V®ueTy³
 
ty³
)

188 
V®ue
 *
v®
 = 
	`AST_g‘
(
£‰šgs
, 
ä
, 
Çme
, 
ty³
);

190 
	`check
(
v®
 !ğ
NULL
, "The server is missinghe '%s' variable.",

191 
	`bd©a
(
Çme
));

193  
v®
->
as
.
¡ršg
->
d©a
;

195 
”rÜ
:

196  
NULL
;

197 
	}
}

199 cÚ¡ *
	$AST_¡r
(
t¡_t
 *
£‰šgs
,¡_ˆ*
ä
, cÚ¡ *
Çme
, 
Tok’Ty³
 
ty³
)

201 
b¡ršg
 
key
 = 
	`bäomc¡r
(
Çme
);

202 
b¡ršg
 
v®
 = 
	`AST_g‘_b¡r
(
£‰šgs
, 
ä
, 
key
, 
ty³
);

203 
	`bde¡roy
(
key
);

204  
	`bd©a
(
v®
);

205 
	}
}

207 
	$CÏss_de¡roy
(
CÏss
 *
şs
)

209 
	`Tok’_de¡roy
(
şs
->
id’t
);

210 
	`AST_de¡roy
(
şs
->
·¿ms
);

211 
	`ä“
(
şs
);

212 
	}
}

215 
AST_de¡roy_v®ue
(
V®ue
 *
v®
);

217 
	$AST_de¡roy_li¡
(
li¡_t
 *
d©a
)

219 
Êode_t
 *
n
 = 
NULL
;

221 
n
 = 
	`li¡_fœ¡
(
d©a
);‚ !ğ
NULL
;‚ = 
	`li¡_Ãxt
(data,‚)) {

222 
	`AST_de¡roy_v®ue
((
V®ue
 *)
	`Êode_g‘
(
n
));

225 
	`li¡_de¡roy_nodes
(
d©a
);

226 
	`li¡_de¡roy
(
d©a
);

228 
	}
}

230 
	$AST_de¡roy_v®ue
(
V®ue
 *
v®
)

232 
v®
->
ty³
) {

233 
VAL_QSTRING
: 
	`Tok’_de¡roy
(
v®
->
as
.
¡ršg
);

235 
VAL_PATTERN
: 
	`Tok’_de¡roy
(
v®
->
as
.
·‰”n
);

237 
VAL_NUMBER
: 
	`Tok’_de¡roy
(
v®
->
as
.
numb”
);

239 
VAL_CLASS
: 
	`CÏss_de¡roy
(
v®
->
as
.
şs
);

241 
VAL_LIST
: 
	`AST_de¡roy_li¡
(
v®
->
as
.
li¡
);

243 
VAL_HASH
: 
	`AST_de¡roy
(
v®
->
as
.
hash
);

245 
VAL_IDENT
: 
	`Tok’_de¡roy
(
v®
->
as
.
id’t
);

247 
VAL_REF
: 
	`Tok’_de¡roy
(
v®
->
as
.
»f
);

250 
	`log_”r
("UnknowÀv®uty³ ID: %d. T–ÈZed.", 
v®
->
ty³
);

253 
	`ä“
(
v®
);

254 
	}
}

256 
	$AST_de¡roy_cb
(*
v®ue
, *
d©a
)

258 
Paœ
 *
·œ
 = (Paœ *)
v®ue
;

260 
	`AST_de¡roy_v®ue
(
	`Paœ_v®ue
(
·œ
));

261 
	`Tok’_de¡roy
(
·œ
->
key
);

262 
	`ä“
(
·œ
);

263 
	}
}

265 
	$AST_de¡roy
(
t¡_t
 *
£‰šgs
)

267 
	`t¡_Œav”£
(
£‰šgs
, 
AST_de¡roy_cb
, 
NULL
);

268 
	`t¡_de¡roy
(
£‰šgs
);

269 
	}
}

	@tools/m2sh/src/ast.h

1 #iâdeà
_m2sh_a¡_h


2 
	#_m2sh_a¡_h


	)

4 
	~<adt/li¡.h
>

5 
	~<adt/t¡.h
>

6 
	~"·r£r.h
"

7 
	~"cÚfig_fe.h
"

9 
	gV®ue
;

11 
	sPaœ
 {

12 
Tok’
 *
	mkey
;

13 
V®ue
 *
	mv®ue
;

14 } 
	tPaœ
;

16 
	#Paœ_key
(
P
è((P)->
key
->
d©a
)

	)

17 
	#Paœ_v®ue
(
P
è((P)->
v®ue
)

	)

19 
	sCÏss
 {

20 
Tok’
 *
	mid’t
;

21 
t¡_t
 *
	m·¿ms
;

22 
	mid
;

23 } 
	tCÏss
;

25 
	eV®ueTy³
 {

26 
	mVAL_QSTRING
=0, 
	mVAL_PATTERN
, 
	mVAL_NUMBER
, 
	mVAL_CLASS
, 
	mVAL_LIST
, 
	mVAL_HASH
, 
	mVAL_IDENT
, 
	mVAL_REF


27 } 
	tV®ueTy³
;

29 
	sV®ue
 {

30 
V®ueTy³
 
	mty³
;

32 *
	md©a
;

33 
Tok’
 *
	m¡ršg
;

34 
Tok’
 *
	m·‰”n
;

35 
Tok’
 *
	mnumb”
;

36 
CÏss
 *
	mşs
;

37 
li¡_t
 *
	mli¡
;

38 
t¡_t
 *
	mhash
;

39 
Tok’
 *
	mid’t
;

40 
Tok’
 *
	m»f
;

41 } 
	mas
;

42 } 
	tV®ue
;

44 cÚ¡ *
V®ue_ty³_Çme
(
V®ueTy³
 
ty³
);

46 
V®ue
 *
V®ue_ü—‹
(
V®ueTy³
 
ty³
, *
d©a
);

47 
	#V®ue_is
(
V
, 
T
è((V)->
ty³
 =ğ(
VAL_
##T))

	)

49 (*
	ta¡_w®k_cb
)(
	tt¡_t
 *
	t£‰šgs
, 
	tV®ue
 *
	tv®
);

50 (*
	ta¡_hash_w®k_cb
)(
	tt¡_t
 *
	t£‰šgs
, 
	tPaœ
 *
	t·œ
);

52 
	`AST_w®k
(
t¡_t
 *
£‰šgs
, 
a¡_w®k_cb
 
cb
);

53 
	`AST_w®k_li¡
(
t¡_t
 *
£‰šgs
, 
li¡_t
 *
d©a
, 
a¡_w®k_cb
 
cb
);

54 
	`AST_w®k_hash
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
d©a
, 
a¡_hash_w®k_cb
 
cb
);

56 
	#CÏss_id’t
(
C
è((C)->
id’t
->
d©a
)

	)

57 
	#CÏss_·¿ms
(
C
è((C)->
·¿ms
)

	)

59 
V®ue
 *
	`AST_g‘
(
t¡_t
 *
£‰šgs
,¡_ˆ*
ä
, 
b¡ršg
 
Çme
, 
V®ueTy³
 
ty³
);

60 
b¡ršg
 
	`AST_g‘_b¡r
(
t¡_t
 *
£‰šgs
,¡_ˆ*
ä
, b¡ršg 
Çme
, 
V®ueTy³
 
ty³
);

61 cÚ¡ *
	`AST_¡r
(
t¡_t
 *
£‰šgs
,¡_ˆ*
ä
, cÚ¡ *
Çme
, 
Tok’Ty³
 
ty³
);

63 
	`AST_de¡roy
(
t¡_t
 *
£‰šgs
);

	@tools/m2sh/src/cli.c

42 
	~<¡dio.h
>

43 
	~<¡ršg.h
>

44 
	~"şi.h
"

45 
	~<dbg.h
>

46 
	~"a¡.h
"

47 
	~<¡dlib.h
>

49 
	#TKBASE
(
N
, 
S
, 
E
è
‹mp
 = 
	`Tok’_ü—‹
(
TK
##N, S, ()(E - S));\

50 
fsm
->
tok’s
[fsm->
tok’_couÁ
++] = 
‹mp
;

	)

52 
	#TK
(
N
è
	`TKBASE
(N, 
fsm
->
ts
, fsm->
‹
)

	)

53 
	#TKSTR
(
N
è
	`TKBASE
(N, 
fsm
->
ts
+1, fsm->
‹
-3)

	)

54 
	#TKOPT
(
C
è
	`TKBASE
(
OPTION
, 
fsm
->
ts
+(C), fsm->
‹
-(C*2))

	)

62 cÚ¡ 
	g·¿ms_¡¬t
 = 4;

63 cÚ¡ 
	g·¿ms_fœ¡_fš®
 = 4;

64 cÚ¡ 
	g·¿ms_”rÜ
 = -1;

66 cÚ¡ 
	g·¿ms_’_maš
 = 4;

71 
	$şi_·¿ms_š™
Ğ
·¿ms
 *
fsm
 )

73 
fsm
->
aù
 = -1;

74 
fsm
->
tok’_couÁ
 = 0;

75 
fsm
->
cu¹k
 = 0;

79 
fsm
->
cs
 = 
·¿ms_¡¬t
;

80 
fsm
->
ts
 = 0;

81 
fsm
->
‹
 = 0;

82 
fsm
->
aù
 = 0;

86 
	}
}

88 
	$şi_·¿ms_execu‹
Ğ
·¿ms
 *
fsm
, 
b¡ršg
 
d©a
)

90 cÚ¡ *
p
 = 
	`bd©a
(
d©a
);

91 cÚ¡ *
³
 = 
	`bd©aofs
(
d©a
, 
	`bËngth
(data));

92 cÚ¡ *
eof
 = 
³
;

93 
Tok’
 *
‹mp
 = 
NULL
;

98 iàĞ
p
 =ğ
³
 )

99 
_‹¡_eof
;

100  
fsm
->
cs
 )

102 
Œ0
:

104 {{
p
 = (Ğ
fsm
->
‹
))-1;}{ 
	`TK
(
BLOB
); }}

105 
¡4
;

106 
Œ2
:

108 { 
fsm
->
‹
 = 
p
+1;{ 
	`TKSTR
(
QSTRING
); }}

109 
¡4
;

110 
Œ7
:

112 { 
fsm
->
‹
 = 
p
+1;}

113 
¡4
;

114 
Œ13
:

116 {  
fsm
->
aù
 ) {

118 {{
p
 = (Ğ
fsm
->
‹
))-1;} 
	`TKSTR
(
QSTRING
); }

121 {{
p
 = (Ğ
fsm
->
‹
))-1;} 
	`TK
(
BLOB
); }

125 
¡4
;

126 
Œ14
:

128 { 
fsm
->
‹
 = 
p
;p--;{ 
	`TK
(
BLOB
); }}

129 
¡4
;

130 
Œ21
:

132 { 
fsm
->
‹
 = 
p
;p--;{ 
	`TKOPT
(2); }}

133 
¡4
;

134 
Œ22
:

136 { 
fsm
->
‹
 = 
p
;p--;{ 
	`TKOPT
(1); }}

137 
¡4
;

138 
Œ23
:

140 { 
fsm
->
‹
 = 
p
;p--;{ 
	`TK
(
IDENT
); }}

141 
¡4
;

142 
Œ24
:

144 { 
fsm
->
‹
 = 
p
;p--;{ 
	`TK
(
NUMBER
); }}

145 
¡4
;

146 
¡4
:

148 { 
fsm
->
ts
 = 0;}

149 iàĞ++
p
 =ğ
³
 )

150 
_‹¡_eof4
;

153 { 
fsm
->
ts
 = 
p
;}

155  (*
p
) ) {

156 32: 
Œ7
;

157 34: 
Œ8
;

158 39: 
Œ9
;

159 45: 
¡10
;

160 46: 
¡14
;

161 95: 
¡14
;

163 iàĞ(*
p
) < 48 ) {

164 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

165 
Œ7
;

166 } iàĞ(*
p
) > 57 ) {

167 iàĞ(*
p
) > 90 ) {

168 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

169 
¡14
;

170 } iàĞ(*
p
) >= 65 )

171 
¡14
;

173 
¡15
;

174 
Œ6
;

175 
Œ6
:

177 { 
fsm
->
‹
 = 
p
+1;}

179 { 
fsm
->
aù
 = 7;}

180 
¡5
;

181 
Œ15
:

183 { 
fsm
->
‹
 = 
p
+1;}

185 { 
fsm
->
aù
 = 3;}

186 
¡5
;

187 
¡5
:

188 iàĞ++
p
 =ğ
³
 )

189 
_‹¡_eof5
;

192 iàĞ(*
p
) == 32 )

193 
Œ13
;

194 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

195 
Œ13
;

196 
Œ6
;

197 
Œ8
:

199 { 
fsm
->
‹
 = 
p
+1;}

200 
¡6
;

201 
¡6
:

202 iàĞ++
p
 =ğ
³
 )

203 
_‹¡_eof6
;

206  (*
p
) ) {

207 32: 
¡0
;

208 34: 
Œ15
;

209 92: 
Œ16
;

211 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

212 
¡0
;

213 
Œ8
;

214 
¡0
:

215 iàĞ++
p
 =ğ
³
 )

216 
_‹¡_eof0
;

218  (*
p
) ) {

219 34: 
Œ2
;

220 92: 
¡1
;

222 
¡0
;

223 
¡1
:

224 iàĞ++
p
 =ğ
³
 )

225 
_‹¡_eof1
;

227 
¡0
;

228 
Œ16
:

230 { 
fsm
->
‹
 = 
p
+1;}

231 
¡7
;

232 
¡7
:

233 iàĞ++
p
 =ğ
³
 )

234 
_‹¡_eof7
;

237 iàĞ(*
p
) == 32 )

238 
¡0
;

239 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

240 
¡0
;

241 
Œ8
;

242 
Œ9
:

244 { 
fsm
->
‹
 = 
p
+1;}

245 
¡8
;

246 
¡8
:

247 iàĞ++
p
 =ğ
³
 )

248 
_‹¡_eof8
;

251  (*
p
) ) {

252 32: 
¡2
;

253 39: 
Œ15
;

254 92: 
Œ17
;

256 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

257 
¡2
;

258 
Œ9
;

259 
¡2
:

260 iàĞ++
p
 =ğ
³
 )

261 
_‹¡_eof2
;

263  (*
p
) ) {

264 39: 
Œ2
;

265 92: 
¡3
;

267 
¡2
;

268 
¡3
:

269 iàĞ++
p
 =ğ
³
 )

270 
_‹¡_eof3
;

272 
¡2
;

273 
Œ17
:

275 { 
fsm
->
‹
 = 
p
+1;}

276 
¡9
;

277 
¡9
:

278 iàĞ++
p
 =ğ
³
 )

279 
_‹¡_eof9
;

282 iàĞ(*
p
) == 32 )

283 
¡2
;

284 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

285 
¡2
;

286 
Œ9
;

287 
¡10
:

288 iàĞ++
p
 =ğ
³
 )

289 
_‹¡_eof10
;

291  (*
p
) ) {

292 32: 
Œ14
;

293 45: 
¡11
;

294 46: 
¡13
;

295 95: 
¡13
;

297 iàĞ(*
p
) < 65 ) {

298 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

299 
Œ14
;

300 } iàĞ(*
p
) > 90 ) {

301 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

302 
¡13
;

304 
¡13
;

305 
Œ6
;

306 
¡11
:

307 iàĞ++
p
 =ğ
³
 )

308 
_‹¡_eof11
;

310  (*
p
) ) {

311 32: 
Œ14
;

312 46: 
¡12
;

313 95: 
¡12
;

315 iàĞ(*
p
) < 65 ) {

316 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

317 
Œ14
;

318 } iàĞ(*
p
) > 90 ) {

319 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

320 
¡12
;

322 
¡12
;

323 
Œ6
;

324 
¡12
:

325 iàĞ++
p
 =ğ
³
 )

326 
_‹¡_eof12
;

328  (*
p
) ) {

329 32: 
Œ21
;

330 46: 
¡12
;

331 95: 
¡12
;

333 iàĞ(*
p
) < 48 ) {

334 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

335 
Œ21
;

336 } iàĞ(*
p
) > 57 ) {

337 iàĞ(*
p
) > 90 ) {

338 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

339 
¡12
;

340 } iàĞ(*
p
) >= 65 )

341 
¡12
;

343 
¡12
;

344 
Œ6
;

345 
¡13
:

346 iàĞ++
p
 =ğ
³
 )

347 
_‹¡_eof13
;

349  (*
p
) ) {

350 32: 
Œ22
;

351 46: 
¡13
;

352 95: 
¡13
;

354 iàĞ(*
p
) < 48 ) {

355 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

356 
Œ22
;

357 } iàĞ(*
p
) > 57 ) {

358 iàĞ(*
p
) > 90 ) {

359 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

360 
¡13
;

361 } iàĞ(*
p
) >= 65 )

362 
¡13
;

364 
¡13
;

365 
Œ6
;

366 
¡14
:

367 iàĞ++
p
 =ğ
³
 )

368 
_‹¡_eof14
;

370  (*
p
) ) {

371 32: 
Œ23
;

372 46: 
¡14
;

373 95: 
¡14
;

375 iàĞ(*
p
) < 48 ) {

376 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

377 
Œ23
;

378 } iàĞ(*
p
) > 57 ) {

379 iàĞ(*
p
) > 90 ) {

380 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

381 
¡14
;

382 } iàĞ(*
p
) >= 65 )

383 
¡14
;

385 
¡14
;

386 
Œ6
;

387 
¡15
:

388 iàĞ++
p
 =ğ
³
 )

389 
_‹¡_eof15
;

391 iàĞ(*
p
) == 32 )

392 
Œ24
;

393 iàĞ(*
p
) > 13 ) {

394 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

395 
¡15
;

396 } iàĞ(*
p
) >= 9 )

397 
Œ24
;

398 
Œ6
;

400 
_‹¡_eof4
: 
fsm
->
cs
 = 4; 
_‹¡_eof
;

401 
_‹¡_eof5
: 
fsm
->
cs
 = 5; 
_‹¡_eof
;

402 
_‹¡_eof6
: 
fsm
->
cs
 = 6; 
_‹¡_eof
;

403 
_‹¡_eof0
: 
fsm
->
cs
 = 0; 
_‹¡_eof
;

404 
_‹¡_eof1
: 
fsm
->
cs
 = 1; 
_‹¡_eof
;

405 
_‹¡_eof7
: 
fsm
->
cs
 = 7; 
_‹¡_eof
;

406 
_‹¡_eof8
: 
fsm
->
cs
 = 8; 
_‹¡_eof
;

407 
_‹¡_eof2
: 
fsm
->
cs
 = 2; 
_‹¡_eof
;

408 
_‹¡_eof3
: 
fsm
->
cs
 = 3; 
_‹¡_eof
;

409 
_‹¡_eof9
: 
fsm
->
cs
 = 9; 
_‹¡_eof
;

410 
_‹¡_eof10
: 
fsm
->
cs
 = 10; 
_‹¡_eof
;

411 
_‹¡_eof11
: 
fsm
->
cs
 = 11; 
_‹¡_eof
;

412 
_‹¡_eof12
: 
fsm
->
cs
 = 12; 
_‹¡_eof
;

413 
_‹¡_eof13
: 
fsm
->
cs
 = 13; 
_‹¡_eof
;

414 
_‹¡_eof14
: 
fsm
->
cs
 = 14; 
_‹¡_eof
;

415 
_‹¡_eof15
: 
fsm
->
cs
 = 15; 
_‹¡_eof
;

417 
_‹¡_eof
: {}

418 iàĞ
p
 =ğ
eof
 )

420  
fsm
->
cs
 ) {

421 5: 
Œ13
;

422 6: 
Œ14
;

423 0: 
Œ0
;

424 1: 
Œ0
;

425 7: 
Œ14
;

426 8: 
Œ14
;

427 2: 
Œ0
;

428 3: 
Œ0
;

429 9: 
Œ14
;

430 10: 
Œ14
;

431 11: 
Œ14
;

432 12: 
Œ21
;

433 13: 
Œ22
;

434 14: 
Œ23
;

435 15: 
Œ24
;

442 
	}
}

444 
	$şi_·¿ms_fšish
Ğ
·¿ms
 *
fsm
 )

446 iàĞ
fsm
->
cs
 =ğ
·¿ms_”rÜ
 )

448 iàĞ
fsm
->
cs
 >ğ
·¿ms_fœ¡_fš®
 )

451 
	}
}

453 
šlše
 
b¡ršg
 
	$m©ch_»Ëa£
(
·¿ms
 *
p
, 
ty³
, 
»Ëa£
)

455 
	`check
(
p
->
cu¹k
 <…->
tok’_couÁ
, "Expecting more options, but‚othing†eft.");

456 
Tok’
 *
tk
 = 
p
->
tok’s
[p->
cu¹k
++];

458 
	`check_debug
(
tk
->
ty³
 ==ype, "Expecting %d but got %d.",ype,k->type);

460 
b¡ršg
 
v®
 = 
tk
->
d©a
;

462 if(
»Ëa£
) {

463 
tk
->
d©a
 = 
NULL
;

466  
v®
;

468 
”rÜ
:

469  
NULL
;

470 
	}
}

472 
šlše
 
b¡ršg
 
	$m©ch
(
·¿ms
 *
p
, 
ty³
)

474  
	`m©ch_»Ëa£
(
p
, 
ty³
, 1);

475 
	}
}

478 
šlše
 
	$³ek
(
·¿ms
 *
p
)

480 if(
p
->
cu¹k
 >ğp->
tok’_couÁ
) {

483  
p
->
tok’s
[p->
cu¹k
]->
ty³
;

485 
	}
}

487 
šlše
 
	$Commªd_İtiÚ
(
Commªd
 *
cmd
, 
·¿ms
 *
p
)

489 
b¡ršg
 
key
 = 
	`m©ch_»Ëa£
(
p
, 
TKOPTION
, 0);

490 
	`check
(
key
, "Should have matched‡n option.");

492 
b¡ršg
 
v®ue
 = 
NULL
;

493 
Ãxt
 = 
	`³ek
(
p
);

495 if(
Ãxt
 =ğ
TKOPTION
 ||‚ext == -1) {

497 
v®ue
 = 
	`bäomc¡r
("");

500 
v®ue
 = 
	`m©ch
(
p
, 
Ãxt
);

503 
	`hash_®loc_š£¹
(
cmd
->
İtiÚs
, 
	`bd©a
(
key
), 
v®ue
);

506 
”rÜ
:

507 
cmd
->
”rÜ
 = 1;

509 
	}
}

511 
šlše
 
	$Commªd_exŒa
(
Commªd
 *
cmd
, 
Ãxt
, 
·¿ms
 *
p
)

513 
b¡ršg
 
exŒa
 = 
	`m©ch_»Ëa£
(
p
, 
Ãxt
, 0);

514 
	`li¡_­³nd
(
cmd
->
exŒa
, 
	`Êode_ü—‹
(extra));

515 
	}
}

517 
hnode_t
 *
	$cmd_hnode_®loc
(*
ignÜed
)

519  
	`ÿÎoc
((
hnode_t
), 1);

520 
	}
}

522 
	$cmd_hnode_ä“
(
hnode_t
 *
h
, *
ignÜed
)

524 
	`bde¡roy
(
	`hnode_g‘
(
h
));

525 
	`hnode_de¡roy
(
h
);

526 
	}
}

528 
šlše
 
	$Commªd_·r£
(
·¿ms
 *
p
, 
Commªd
 *
cmd
)

530 
Ãxt
 = 0;

533 
	`memıy
(
cmd
->
tok’s
, 
p
->tok’s, 
MAX_TOKENS
);

534 
cmd
->
tok’_couÁ
 = 
p
->token_count;

536 
cmd
->
İtiÚs
 = 
	`hash_ü—‹
(
HASHCOUNT_T_MAX
, 0, 0);

537 
	`check_mem
(
cmd
->
İtiÚs
);

538 
	`hash_£t_®loÿtÜ
(
cmd
->
İtiÚs
, 
cmd_hnode_®loc
, 
cmd_hnode_ä“
, 
NULL
);

540 
cmd
->
exŒa
 = 
	`li¡_ü—‹
(
LISTCOUNT_T_MAX
);

541 
	`check_mem
(
cmd
->
exŒa
);

543 
Ãxt
 = 
	`³ek
(
p
);

544 if(
Ãxt
 =ğ
TKIDENT
 ||‚exˆ=ğ
TKBLOB
) {

545 
cmd
->
´ogÇme
 = 
	`m©ch
(
p
, 
Ãxt
);

546 
	`check
(
cmd
->
´ogÇme
, "No…rogram‚ame given in command.");

548 
	`£Áš–
("Expectedhe‚ame ofhe…rogram you're„unning‚ot: %s",

549 
	`bd©a
(
	`m©ch
(
p
, 
Ãxt
)));

552 
cmd
->
Çme
 = 
	`m©ch
(
p
, 
TKIDENT
);

553 
	`check
(
cmd
->
Çme
, "No command‚ame given. Use m2sh helpo figure out what's‡vailable.");

555 
Ãxt
 = 
	`³ek
(
p
);‚exˆ!ğ-1 && !
cmd
->
”rÜ
;‚ext =…eek(p)) {

556 if(
Ãxt
 =ğ
TKOPTION
) {

557 
	`Commªd_İtiÚ
(
cmd
, 
p
);

559 
	`Commªd_exŒa
(
cmd
, 
Ãxt
, 
p
);

563 
	`check
(
p
->
cu¹k
 =ğp->
tok’_couÁ
, "Didn't…arsehe whole command†ine, only: %d of %d",…->curtk,…->token_count);

567 
”rÜ
:

568 
cmd
->
”rÜ
 = 1;

570 
	}
}

572 
gb¡ršg
 
	gDEFAULT_COMMAND
 = 
bsStic
("shell");

574 
	$şi_·¿ms_·r£_¬gs
(
b¡ršg
 
¬gs
, 
Commªd
 *
cmd
)

576 
·¿ms
…arams;

577 
cmd
->
”rÜ
 = 0;

578 
cmd
->
tok’_couÁ
 = 0;

580 
	`şi_·¿ms_š™
(&
·¿ms
);

582 
	`şi_·¿ms_execu‹
(&
·¿ms
, 
¬gs
);

584 
rc
 = 
	`şi_·¿ms_fšish
(&
·¿ms
);

585 
	`check
(
rc
 == 1, "error…rocessing‡rguments: %d",„c);

587 if(
·¿ms
.
tok’_couÁ
 < 2) {

588 
·¿ms
.
tok’s
[·¿ms.
tok’_couÁ
++] = 
	`Tok’_ü—‹
(

589 
TKIDENT
, 
	`bd©a
(&
DEFAULT_COMMAND
), 
	`bËngth
(&DEFAULT_COMMAND));

592  
	`Commªd_·r£
(&
·¿ms
, 
cmd
);

594 
”rÜ
:

595 
cmd
->
”rÜ
 = 1;

597 
	}
}

	@tools/m2sh/src/cli.h

1 #iâdeà
_m2sh_şi_h


2 
	#_m2sh_şi_h


	)

4 
	~<b¡ršg.h
>

5 
	~"a¡.h
"

6 
	~"commªds.h
"

8 
	eCLITok’s
 {

9 
	mTKBLOB
 = 
TKCOLON
 + 100,

10 
	mTKOPTION


13 
	s·¿ms


15 
	mcs
;

16 cÚ¡ *
	mts
;

17 cÚ¡ *
	m‹
;

18 
	maù
;

20 
Tok’
 *
	mtok’s
[
MAX_TOKENS
];

21 
	mtok’_couÁ
;

22 
	mcu¹k
;

25 
şi_·¿ms_š™
Ğ
·¿ms
 *
fsm
 );

26 
şi_·¿ms_execu‹
Ğ
·¿ms
 *
fsm
, 
b¡ršg
 
d©a
);

27 
şi_·¿ms_fšish
Ğ
·¿ms
 *
fsm
 );

28 
şi_·¿ms_·r£_¬gs
(
b¡ršg
 
¬gs
, 
Commªd
 *
cmd
);

	@tools/m2sh/src/commands.c

35 
	~"cÚfig_fe.h
"

36 
	~"şi.h
"

37 
	~"commªds.h
"

38 
	~<dbg.h
>

39 
	~<¡dio.h
>

40 
	~"lš’oi£.h
"

41 
	~<¡dlib.h
>

42 
	~<cÚfig/db.h
>

43 
	~<sys/ty³s.h
>

44 
	~<sigÇl.h
>

45 
	~<uni¡d.h
>

46 
	~<as£¹.h
>

47 
	~<sk/sk.h
>

48 
	~<»gi¡”.h
>

49 
	~<Š‘¡ršgs.h
>

50 
	~<Š‘¡ršgs_im¶.h
>

51 
	~<·‰”n.h
>

53 (*
	tCommªd_hªdËr_cb
)(
	tCommªd
 *
	tcmd
);

55 
	sCommªdHªdËr
 {

56 cÚ¡ *
Çme
;

57 cÚ¡ *
h–p
;

58 
Commªd_hªdËr_cb
 
cb
;

59 } 
	tCommªdHªdËr
;

61 
	#check_fe
(
S
, 
N
, 
P
è
	`check
(
	`acûss
((cÚ¡ *)(S)->
d©a
, (P)è=ğ0, "Cª'ˆacûs % '%s'…rİ”ly.", N, 
	`bd©a
((S)))

	)

62 
	#check_no_exŒa
(
C
è
	`check
(
	`li¡_couÁ
((C)->
exŒa
è=ğ0, "Commªd Úlyak--İtiÚ styË‡rgum’ts, you hav%dƒxŒa.", (îi¡_couÁ((C)->exŒa))

	)

64 
	$´št_d©um
(
Šs_v®ue_t
 *
cŞ
)

66 
	`Šs_g‘_ty³
(
cŞ
)) {

67 
Šs_g_¡ršg
:

68 
	`´štf
("%s", 
	`bd©a
(
cŞ
->
v®ue
.
¡ršg
));

70 
Šs_g_numb”
:

71 
	`´štf
("%ld", 
cŞ
->
v®ue
.
numb”
);

73 
Šs_g_æßt
:

74 
	`´štf
("%f", 
cŞ
->
v®ue
.
åošt
);

76 
Šs_g_nuÎ
:

77 
	`´štf
("(null)");

79 
Šs_g_boŞ
:

80 
	`´štf
("%s", 
cŞ
->
v®ue
.
boŞ
 ? "true" : "false");

83 
	`´štf
("NA");

85 
	}
}

88 
šlše
 
	$log_aùiÚ
(
b¡ršg
 
db_fe
, b¡ršg 
wh©
, b¡ršg 
why
, b¡ršg 
wh”e
, b¡ršg 
how
)

90 
rc
 = 0;

91 
Šs_v®ue_t
 *
»s
 = 
NULL
;

92 
b¡ršg
 
who
 = 
NULL
;

93 *
u£r
 = 
	`g‘logš
(è=ğ
NULL
 ? 
	`g‘’v
("LOGNAME") : getlogin();

94 
	`check
(
u£r
 !ğ
NULL
, "getlogin failed‡nd‚o LOGNAMEƒnv variable, how'd you dohat?");

95 
who
 = 
	`bäomc¡r
(
u£r
);

97 if(
	`acûss
((cÚ¡ *)
db_fe
->
d©a
, 
R_OK
 | 
W_OK
) != 0) {

102 
rc
 = 
	`DB_š™
(
	`bd©a
(
db_fe
));

103 
	`check
(
rc
 =ğ0, "FaedØİ’ db: %s", 
	`bd©a
(
db_fe
));

105 if(!
wh”e
) {

106 
Çme_buf
[128] = {0};

107 
rc
 = 
	`g‘ho¡Çme
(
Çme_buf
, 127);

108 
	`check
(
rc
 == 0, "Failedo get your machines hostname, use -whereo force it.");

109 
wh”e
 = 
	`bäomc¡r
(
Çme_buf
);

112 
»s
 = 
	`DB_exec
("INSERT INTO†og (who, what,†ocation, how, why) VALUES (%Q, %Q, %Q, %Q, %Q)",

113 
	`bd©a
(
who
), bd©a(
wh©
), bd©a(
wh”e
), bd©a(
how
), bd©a(
why
));

114 
	`check
(
»s
 !ğ
NULL
, "Failedo‡dd†og message, you're flying blind.");

115 
	`Šs_v®ue_de¡roy
(
»s
);

117 if(
	`bi£qc¡r
(
who
, "root")) {

118 
	`log_w¬n
("You shouldn'ˆbruÂšghšg a %s. U£‡ saã u£¸š¡—d.", 
	`bd©a
(
who
));

121 
	`bde¡roy
(
who
);

122 
	`bde¡roy
(
wh”e
);

123 
	`DB_şo£
();

126 
”rÜ
:

127 if(
who
è
	`bde¡roy
(who);

128 if(
wh”e
è
	`bde¡roy
(where);

129 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

130 
	`DB_şo£
();

132 
	}
}

136 
šlše
 
b¡ršg
 
	$İtiÚ
(
Commªd
 *
cmd
, cÚ¡ *
Çme
, cÚ¡ *
def
)

138 
hnode_t
 *
v®
 = 
	`hash_lookup
(
cmd
->
İtiÚs
, 
Çme
);

140 if(
def
 !ğ
NULL
) {

141 if(
v®
 =ğ
NULL
) {

143 
	`log_w¬n
("NØİtiÚ --% giv’, usšg \"%s\"‡ thdeçuÉ.", 
Çme
, 
def
);

145 
b¡ršg
 
»suÉ
 = 
	`bäomc¡r
(
def
);

146 
	`hash_®loc_š£¹
(
cmd
->
İtiÚs
, 
Çme
, 
»suÉ
);

147  
»suÉ
;

149  
	`hnode_g‘
(
v®
);

152  
v®
 =ğ
NULL
 ? NULL : 
	`hnode_g‘
(val);

154 
	}
}

156 
	$Commªd_lßd
(
Commªd
 *
cmd
)

158 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", "config.sqlite");

159 
b¡ršg
 
cÚf_fe
 = 
	`İtiÚ
(
cmd
, "config", "mongrel2.conf");

160 
b¡ršg
 
wh©
 = 
NULL
;

161 
b¡ršg
 
why
 = 
NULL
;

163 
	`check_fe
(
cÚf_fe
, "cÚfig fe", 
R_OK
);

165 
	`CÚfig_lßd
(
	`bd©a
(
cÚf_fe
), bd©a(
db_fe
));

167 
wh©
 = 
	`bäomc¡r
("load");

168 
why
 = 
	`bäomc¡r
("command");

170 
	`log_aùiÚ
(
db_fe
, 
wh©
, 
why
, 
NULL
, 
cÚf_fe
);

172 
”rÜ
:

173 
	`bde¡roy
(
wh©
);

174 
	`bde¡roy
(
why
);

176 
	}
}

179 
šlše
 
lš’oi£_ruÂ”
(cÚ¡ *
´om±
, (*
ÿÎback
)(
b¡ršg
 
¬g
, *
d©a
), *data)

181 *
lše
 = 
NULL
;

182 
b¡ršg
 
¬gs
 = 
NULL
;

183 *
home_dœ
 = 
	`g‘’v
("HOME");

184 
b¡ršg
 
hi¡_fe
 = 
NULL
;

186 if(
home_dœ
 !ğ
NULL
) {

187 
hi¡_fe
 = 
	`bfÜm©
("%s/.m2sh", 
home_dœ
);

188 
	`lš’oi£Hi¡ÜyLßd
(
	`bd©a
(
hi¡_fe
));

190 
	`log_w¬n
("You don't have‡ HOMEƒnvironment variable. Oh well,‚o history.");

191 
hi¡_fe
 = 
NULL
;

194 (
lše
 = 
	`lš’oi£
(
´om±
)è!ğ
NULL
) {

195 ià(
lše
[0] != '\0') {

196 
¬gs
 = 
	`bfÜm©
("%s", 
lše
);

197 
	`ÿÎback
(
¬gs
, 
d©a
);

198 
	`bde¡roy
(
¬gs
);

200 if(
hi¡_fe
) {

201 
	`lš’oi£Hi¡ÜyAdd
(
lše
);

202 
	`lš’oi£Hi¡ÜySave
(
	`bd©a
(
hi¡_fe
));

206 
	`ä“
(
lše
);

209 
	`bde¡roy
(
hi¡_fe
);

211 
	}
}

214 
	$run_commªd
(
b¡ršg
 
lše
, *
ignÜed
)

216 
b¡ršg
 
¬gs
 = 
	`bfÜm©
("m2sh %s", 
	`bd©a
(
lše
));

217 
rc
 = 
	`Commªd_run
(
¬gs
);

219 
	`bde¡roy
(
¬gs
);

220  
rc
;

221 
	}
}

224 
	$Commªd_sh–l
(
Commªd
 *
cmd
)

226  
	`lš’oi£_ruÂ”
("mÚg»l2> ", 
run_commªd
, 
NULL
);

227 
	}
}

230 
šlše
 
	$sim¶e_qu”y_´št
(
b¡ršg
 
db_fe
, cÚ¡ *
sql
)

232 
rc
 = 0;

234 
rc
 = 
	`DB_š™
(
	`bd©a
(
db_fe
));

235 
	`check
(
rc
 !ğ-1, "FaedØİ’ d©aba£ %s", 
	`bd©a
(
db_fe
));

237 
Šs_v®ue_t
 *
»s
 = 
	`DB_exec
(
sql
);

238 
	`check
(
»s
 !ğ
NULL
, "Qu”y faed: %s.", 
	`bd©a
(
db_fe
));

240 
cŞs
 = 0;

241 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

242 
	`check
(
cŞs
 > 0, "Invalid query, it has‚o columns, which is‡ bug.");

243 
	`check
(
rows
 != -1, "Invalid query„esult,…robably‚ot‡able.");

245 if(
rows
 == 0) {

246 
	`log_w¬n
("No„esultso display.");

248 
cŞ_i
 = 0;

249 
row_i
 = 0;

250 
row_i
 = 0;„ow_˜< 
rows
;„ow_i ++) {

251 
cŞ_i
 = 0; cŞ_˜< 
cŞs
; col_i++) {

252 
	`´št_d©um
(
	`DB_g‘
(
»s
, 
row_i
, 
cŞ_i
));

253 
	`´štf
(" ");

255 
	`´štf
("\n");

259 
	`DB_şo£
();

262 
”rÜ
:

263 
	`DB_şo£
();

265 
	}
}

267 
	$Commªd_£rv”s
(
Commªd
 *
cmd
)

269 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", "config.sqlite");

271 
	`check_fe
(
db_fe
, "cÚfig d©aba£", 
R_OK
 | 
W_OK
);

273 
	`´štf
("SERVERS:\n------\n");

274  
	`sim¶e_qu”y_´št
(
db_fe
, "SELECT‚ame, default_host, uuid from server");

276 
”rÜ
:

278 
	}
}

282 
	$Commªd_ho¡s
(
Commªd
 *
cmd
)

284 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", "config.sqlite");

285 
b¡ršg
 
£rv”
 = 
	`İtiÚ
(
cmd
, "£rv”", 
NULL
);

286 *
sql
 = 
NULL
;

287 
rc
 = 0;

289 
	`check_fe
(
db_fe
, "cÚfig d©aba£", 
R_OK
 | 
W_OK
);

290 
	`check
(
£rv”
, "You‚eedo give‡ -server ofhe servero†ist hosts from.");

292 
sql
 = 
	`sql™e3_m´štf
("SELECT id,‚amäom ho¡ wh”£rv”_id = (£Ëù id from s”v” wh”Çmğ%Q)", 
	`bd©a
(
£rv”
));

294 
	`´štf
("HOSTS iÀ%s:\n-----\n", 
	`bd©a
(
£rv”
));

295 
rc
 = 
	`sim¶e_qu”y_´št
(
db_fe
, 
sql
);

297 
”rÜ
:

298 if(
sql
è
	`sql™e3_ä“
(sql);

299  
rc
;

300 
	}
}

303 
	$Commªd_acûss_logs
(
Commªd
 *
cmd
)

305 
b¡ršg
 
log_f’ame
 = 
	`İtiÚ
(
cmd
, "log", "logs/access.log");

307 
FILE
 *
log_fe
 = 
	`fİ’
(
	`bd©a
(
log_f’ame
), "r");

308 
lše_numb”
 = 0;

309 
b¡ršg
 
lše
;

311 (
lše
 = 
	`bg‘s
((
bNg‘c
è
fg‘c
, 
log_fe
, '\n')è!ğ
NULL
) {

312 
lše_numb”
++;

314 
Šs_v®ue_t
 *
log_™em
 = 
	`Šs_·r£
(
	`bd©a
(
lše
), 
	`bËngth
Öše), 
NULL
);

316 ià(!
log_™em
 ||†og_™em->
ty³
 !ğ
Šs_g_li¡
) {

317 
	`årštf
(
¡d”r
, "M®fÜmed†og†še: %d.\n", 
lše_numb”
);

321 
d¬¿y_t
 *
’Œ›s
 = 
log_™em
->
v®ue
.
li¡
;

323 
b¡ršg
 
ho¡Çme
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 0))->
v®ue
.
¡ršg
;

324 
b¡ršg
 
»mÙe_addr
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 1))->
v®ue
.
¡ršg
;

325 
»mÙe_pÜt
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 2))->
v®ue
.
numb”
;

326 
time¡amp
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 3))->
v®ue
.
¡ršg
;

327 
b¡ršg
 
»que¡_m‘hod
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 4))->
v®ue
.
¡ršg
;

328 
b¡ršg
 
»que¡_·th
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 5))->
v®ue
.
¡ršg
;

329 
b¡ršg
 
v”siÚ
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 6))->
v®ue
.
¡ršg
;

330 
¡©us
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 7))->
v®ue
.
numb”
;

331 
size
 = ((
Šs_v®ue_t
 *)
	`d¬¿y_g‘
(
’Œ›s
, 8))->
v®ue
.
numb”
;

333 
	`´štf
("[%ld] %s:%ld %s \"%s %s %s\" %ld %ld\n",

334 
time¡amp
,

335 
	`bd©a
(
»mÙe_addr
),

336 
»mÙe_pÜt
,

337 
	`bd©a
(
ho¡Çme
),

338 
	`bd©a
(
»que¡_m‘hod
),

339 
	`bd©a
(
»que¡_·th
),

340 
	`bd©a
(
v”siÚ
),

341 
¡©us
,

342 
size
);

344 
	`Šs_v®ue_de¡roy
(
log_™em
);

348 
	}
}

351 
	$Commªd_rou‹s
(
Commªd
 *
cmd
)

353 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", "config.sqlite");

354 
b¡ršg
 
£rv”
 = 
	`İtiÚ
(
cmd
, "£rv”", 
NULL
);

355 
b¡ršg
 
ho¡
 = 
	`İtiÚ
(
cmd
, "ho¡", 
NULL
);

356 
b¡ršg
 
ho¡_id
 = 
	`İtiÚ
(
cmd
, "id", 
NULL
);

357 *
sql
 = 
NULL
;

358 
rc
 = 0;

360 
	`check_fe
(
db_fe
, "cÚfig d©aba£", 
R_OK
 | 
W_OK
);

362 if(
ho¡_id
) {

363 
	`´štf
("ROUTES iÀho¡ id %s\n-----\n", 
	`bd©a
(
ho¡_id
));

364 
sql
 = 
	`sql™e3_m´štf
("SELECT…©h from„ou‹ wh”ho¡_id=%q", 
	`bd©a
(
ho¡_id
));

366 
	`check
(
£rv”
, "Must sethe -server‚ame you want or use -id.");

367 
	`check
(
ho¡
, "Must sethe -host inhat server you want or use -id.");

369 
	`´štf
("ROUTES iÀho¡ %s, s”v” %s\n-----\n", 
	`bd©a
(
ho¡
), bd©a(
£rv”
));

371 
sql
 = 
	`sql™e3_m´štf
("SELECT„oute.path from„oute, host, server where "

373 "ho¡.£rv”_id = s”v”.id", 
	`bd©a
(
ho¡
), bd©a(
£rv”
));

376 
rc
 = 
	`sim¶e_qu”y_´št
(
db_fe
, 
sql
);

378 
”rÜ
:

379 if(
sql
è
	`sql™e3_ä“
(sql);

380  
rc
;

381 
	}
}

384 
	$Commªd_comm™
(
Commªd
 *
cmd
)

386 
b¡ršg
 
wh©
 = 
	`İtiÚ
(
cmd
, "what", "");

387 
b¡ršg
 
why
 = 
	`İtiÚ
(
cmd
, "why", 
NULL
);

388 
b¡ršg
 
wh”e
 = 
	`İtiÚ
(
cmd
, "wh”e", 
NULL
);

389 
b¡ršg
 
how
 = 
	`İtiÚ
(
cmd
, "how", "m2sh");

390 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", "config.sqlite");

392 
	`check_fe
(
db_fe
, "cÚfig d©aba£", 
R_OK
 | 
W_OK
);

394  
	`log_aùiÚ
(
db_fe
, 
wh©
, 
why
, 
wh”e
, 
how
);

396 
”rÜ
:

398 
	}
}

401 
	$Commªd_log
(
Commªd
 *
cmd
)

403 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", "config.sqlite");

404 
	`check_fe
(
db_fe
, "cÚfig d©aba£", 
R_OK
 | 
W_OK
);

406 
	`´štf
("LOG MESSAGES:\n------\n");

407  
	`sim¶e_qu”y_´št
(
db_fe
, "SELECT happened_at, who,†ocation, how, what, why FROM†og ORDER BY happened_at");

409 
”rÜ
:

411 
	}
}

413 
	sS”v”Run
 {

414 
	m¿n
;

415 
b¡ršg
 
	mdb_fe
;

416 
b¡ršg
 
	mcÚfig_u¾
;

417 
b¡ršg
 
	mcÚfig_¡yË
;

418 
b¡ršg
 
	muuid
;

419 cÚ¡ *
	msudo
;

420 
	mmurd”
;

424 
šlše
 
exec_£rv”_İ”©iÚs
(
Commªd
 *
cmd
,

425 (*
ÿÎback
)(
S”v”Run
 *, 
Šs_v®ue_t
 *), cÚ¡ *
£Ëù
)

427 
rc
 = 0;

428 
Šs_v®ue_t
 *
»s
 = 
NULL
;

430 
b¡ršg
 
db_fe
 = 
	`İtiÚ
(
cmd
, "db", 
NULL
);

431 
b¡ršg
 
cÚf_u¾
 = 
	`İtiÚ
(
cmd
, "u¾", 
NULL
);

432 
b¡ršg
 
cÚf_¡yË
 = 
	`İtiÚ
(
cmd
, "¡yË", 
NULL
);

433 
b¡ršg
 
uuid
 = 
	`İtiÚ
(
cmd
, "uuid", 
NULL
);

435 if(
cÚf_u¾
 =ğ
NULL
 && 
db_fe
 == NULL) {

436 
db_fe
 = 
	`bäomc¡r
("config.sqlite");

439 
	`check
(
db_fe
 !ğ
NULL
 || (
cÚf_u¾
 !ğNULL && 
cÚf_¡yË
 != NULL),

442 
S”v”Run
 
run
 = {

443 .
¿n
 = 0,

444 .
db_fe
 = db_file,

445 .
cÚfig_u¾
 = 
cÚf_u¾
,

446 .
cÚfig_¡yË
 = 
cÚf_¡yË
,

447 .
sudo
 = "",

448 .
uuid
 = uuid,

449 .
murd”
 = 0

452 
b¡ršg
 
Çme
 = 
	`İtiÚ
(
cmd
, "Çme", 
NULL
);

453 
b¡ršg
 
ho¡
 = 
	`İtiÚ
(
cmd
, "ho¡", 
NULL
);

454 
b¡ršg
 
sudo
 = 
	`İtiÚ
(
cmd
, "sudo", 
NULL
);

455 
b¡ršg
 
ev”y
 = 
	`İtiÚ
(
cmd
, "ev”y", 
NULL
);

456 
run
.
murd”
 = 
	`İtiÚ
(
cmd
, "murd”", 
NULL
) != NULL;

458 
	`check
(!(
Çme
 && 
uuid
 && 
ho¡
), "Just one…lease,‚ot‡ll ofhe options.");

460 if(
sudo
) {

461 
run
.
sudo
 = 
	`bi£qc¡r
(sudo, ""è? "sudo" : 
	`bd©a
(sudo);

463 
run
.
sudo
 = "";

466 if(
uuid
 =ğ
NULL
) {

467 
	`check
(
db_fe
 !ğ
NULL
, "There is‚o uuid,‡nd‚o database given,‚eed‡ uuid.");

469 
rc
 = 
	`DB_š™
(
	`bd©a
(
db_fe
));

470 
	`check
(
rc
 =ğ0, "FaedØİ’ db: %s", 
	`bd©a
(
db_fe
));

472 if(
ev”y
) {

473 
»s
 = 
	`DB_exec
("SELECT % FROM s”v”", 
£Ëù
);

474 } if(
Çme
) {

475 
»s
 = 
	`DB_exec
("SELECT % FROM s”v” wh”Çmğ%Q", 
£Ëù
, 
	`bd©a
(
Çme
));

476 } if(
ho¡
) {

477 
»s
 = 
	`DB_exec
("SELECT % FROM s”v” wh”deçuÉ_ho¡ = %Q", 
£Ëù
, 
	`bd©a
(
ho¡
));

478 } if(
uuid
) {

480 
»s
 = 
	`DB_exec
("SELECT % FROM s”v” wh”uuid = %Q", 
£Ëù
, 
	`bd©a
(
uuid
));

482 
	`£Áš–
("You must giveƒither -name, -uuid, or -hosto start‡ server.");

485 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
,

489 
	`check
(
	`ÿÎback
(&
run
, 
»s
) != -1, "Failedo„un internal operation.");

491 if(!
run
.
¿n
) {

492 
”ºo
 = 0;

494 if(
ev”y
) {

495 
	`log_”r
("You specified -every server but didn't†oad‡ny. Not configured„ight?");

496 } if(
ho¡
) {

497 
	`log_”r
("Could‚Ù†ßd s”v” w™h ho¡ '%s' from db %s.", 
	`bd©a
(
ho¡
), bd©a(
db_fe
));

498 } if(
uuid
) {

499 
	`log_”r
("Could‚Ù†ßd s”v” w™h uuid '%s' from db %s.", 
	`bd©a
(
uuid
), bd©a(
db_fe
));

500 } if(
Çme
) {

501 
	`log_”r
("Could‚Ù†ßd s”v”‚amed '%s' from db %s.", 
	`bd©a
(
Çme
), bd©a(
db_fe
));

503 
	`log_”r
("Well†ooks†ike you broke something,…lease„eport what you dido mongrel2.org.");

506 
	`£Áš–
("Error†oadinghe„equested server, see‡bove for why.");

509 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

510 
	`DB_şo£
();

513 
”rÜ
:

514 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

515 
	`DB_şo£
();

517 
	}
}

520 
	$run_£rv”
(
S”v”Run
 *
r
, 
Šs_v®ue_t
 *
»s
)

522 
r
->
¿n
 = 0;

523 
b¡ršg
 
cÚfig
 = 
NULL
;

524 
b¡ršg
 
moduË
 = 
NULL
;

525 
b¡ršg
 
uuid
 = 
NULL
;

527 if(
r
->
db_fe
) {

528 
	`DB_check
(
»s
, 0, 1, 
Šs_g_¡ršg
);

529 
Šs_v®ue_t
 *
uuid_v®
 = 
	`DB_g‘
(
»s
, 0, 0);

531 
cÚfig
 = 
	`b¡rıy
(
r
->
db_fe
);

532 
moduË
 = 
	`bäomc¡r
("");

533 
uuid
 = 
	`b¡rıy
(
uuid_v®
->
v®ue
.
¡ršg
);

535 
cÚfig
 = 
	`b¡rıy
(
r
->
cÚfig_u¾
);

536 
moduË
 = 
	`b¡rıy
(
r
->
cÚfig_¡yË
);

537 
uuid
 = 
	`b¡rıy
(
r
->uuid);

540 
b¡ršg
 
commªd
 = 
	`bfÜm©
("%s mongrel2 %s %s %s",

541 
r
->
sudo
, 
	`bd©a
(
cÚfig
), bd©a(
uuid
), bd©a(
moduË
));

543 
	`sy¡em
(
	`bd©a
(
commªd
));

545 
	`bde¡roy
(
commªd
);

546 
	`bde¡roy
(
cÚfig
);

547 
	`bde¡roy
(
moduË
);

549 
r
->
¿n
 = 1;

552 
”rÜ
:

554 
	}
}

556 
	$Commªd_¡¬t
(
Commªd
 *
cmd
)

558  
	`exec_£rv”_İ”©iÚs
(
cmd
, 
run_£rv”
, "uuid");

559 
	}
}

561 
b¡ršg
 
	$»ad_pid_fe
(
b¡ršg
 
pid_·th
)

563 
FILE
 *
pid_fe
 = 
	`fİ’
(
	`bd©a
(
pid_·th
), "r");

564 
b¡ršg
 
pid
 = 
NULL
;

566 if(
pid_fe
 =ğ
NULL
) {

567  
NULL
;

569 
pid
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
pid_fe
);

570 
	`fşo£
(
pid_fe
);…id_fğ
NULL
;

573  
pid
;

574 
	}
}

576 
	$loÿ‹_pid_fe
(
Šs_v®ue_t
 *
»s
)

578 
b¡ršg
 
pid
 = 
NULL
;

579 
b¡ršg
 
pid_·th
 = 
NULL
;

581 
cŞs
 = 0;

582 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

583 
	`check
(
rows
 =ğ1 && 
cŞs
 == 2, "Wrong‚umber of„esults.");

585 
Šs_v®ue_t
 *
chroÙ
 = 
	`DB_g‘
(
»s
, 0, 0);

586 
	`check
(
	`Šs_g‘_ty³
(
chroÙ
è=ğ
Šs_g_¡ršg
, "Wrong„esult for server chroot, should be‡ string.");

588 
Šs_v®ue_t
 *
pid_fe
 = 
	`DB_g‘
(
»s
, 0, 1);

589 
	`check
(
	`Šs_g‘_ty³
(
pid_fe
è=ğ
Šs_g_¡ršg
, "Wrong„esult for server…id_file, should be‡ string.");

591 
pid_·th
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
chroÙ
->
v®ue
.
¡ršg
), bd©a(
pid_fe
->value.string));

593 
pid
 = 
	`»ad_pid_fe
(
pid_·th
);

594 
	`check
(
pid
, "Couldn'ˆ»adhPID from %s", 
	`bd©a
(
pid_·th
));

596 
»suÉ
 = 
	`©oi
((cÚ¡ *)
pid
->
d©a
);

598 
	`bde¡roy
(
pid
);

599 
	`bde¡roy
(
pid_·th
);

600  
»suÉ
;

602 
”rÜ
:

603 
	`bde¡roy
(
pid
);

604 
	`bde¡roy
(
pid_·th
);

606 
	}
}

608 
	$kl_£rv”
(
S”v”Run
 *
r
, 
Šs_v®ue_t
 *
»s
, 
sigÇl
)

610 
pid
 = 
	`loÿ‹_pid_fe
(
»s
);

611 
	`check
(
pid
 != -1, "Failedo„eadhe…id_file.");

613 
rc
 = 
	`kl
(
pid
, 
sigÇl
);

614 
	`check
(
rc
 =ğ0, "FaedØ¡İ s”v” w™h PID: %d", 
pid
);

616 
r
->
¿n
 = 1;

619 
”rÜ
:

620 
r
->
¿n
 = 0;

622 
	}
}

624 
	$¡İ_£rv”
(
S”v”Run
 *
r
, 
Šs_v®ue_t
 *
»s
)

626 
sigÇl
 = 
r
->
murd”
 ? 
SIGTERM
 : 
SIGINT
;

627  
	`kl_£rv”
(
r
, 
»s
, 
sigÇl
);

628 
	}
}

631 
	$Commªd_¡İ
(
Commªd
 *
cmd
)

633  
	`exec_£rv”_İ”©iÚs
(
cmd
, 
¡İ_£rv”
, "chroot,…id_file");

634 
	}
}

636 
	$»lßd_£rv”
(
S”v”Run
 *
r
, 
Šs_v®ue_t
 *
»s
)

638  
	`kl_£rv”
(
r
, 
»s
, 
SIGHUP
);

639 
	}
}

642 
	$Commªd_»lßd
(
Commªd
 *
cmd
)

644  
	`exec_£rv”_İ”©iÚs
(
cmd
, 
»lßd_£rv”
, "chroot,…id_file");

645 
	}
}

647 
	$check_£rv”
(
S”v”Run
 *
r
, 
Šs_v®ue_t
 *
»s
)

649 
rc
 = 0;

650 
pid
 = 
	`loÿ‹_pid_fe
(
»s
);

652 if(
pid
 == -1) {

653 
	`´štf
("mongrel2 is‚ot„unning because…id_file isn'there.\n");

654 
r
->
¿n
 = 1;

658 
rc
 = 
	`kl
(
pid
, 0);

660 if(
rc
 != 0) {

661 
	`´štf
("mÚg»l2‡ˆPID %d i NOT„uÂšg.\n", 
pid
);

663 
	`´štf
("mÚg»l2‡ˆPID %d„uÂšg.\n", 
pid
);

666 
r
->
¿n
 = 1;

668 
	}
}

670 
	$Commªd_ruÂšg
(
Commªd
 *
cmd
)

672  
	`exec_£rv”_İ”©iÚs
(
cmd
, 
check_£rv”
, "chroot,…id_file");

673 
	}
}

676 
	$b¡ršg_ä“
(*
d©a
, *
hšt
)

678 
	`bde¡roy
((
b¡ršg
)
hšt
);

679 
	}
}

681 
gb¡ršg
 
	gTOKENS
 = 
bsStic
(" \t\n=");

682 
gb¡ršg
 
	gNUMBER_PATTERN
 = 
bsStic
("[\\-0-9]+");

684 
b¡ršg
 
	$·r£_šput
(
b¡ršg
 
šbuf
)

686 
size_t
 
Ën
 = 0;

687 
i
 = 0;

688 *
d©a
 = 
NULL
;

689 
b¡ršg
 
»suÉ
 = 
NULL
;

690 
Šs_v®ue_t
 *
»q
 = 
	`Šs_Ãw_li¡
();

691 
Šs_v®ue_t
 *
¬gs
 = 
	`Šs_Ãw_diù
();

692 
Šs_v®ue_t
 *
v®ue
 = 
NULL
;

694 
	`bŒimws
(
šbuf
);

695 
b¡rLi¡
 *
li¡
 = 
	`b¥l™s
(
šbuf
, &
TOKENS
);

696 
	`check
((
li¡
->
qty
 + 1) % 2 == 0, "USAGE: command‡rg1=val1‡rg2=val2");

698 
	`Šs_add_to_li¡
(
»q
,

699 
	`Šs_·r£_¡ršg
(
	`bd©a
(
li¡
->
’Œy
[0]), 
	`bËngth
(list->entry[0])));

701 
i
 = 1; i < 
li¡
->
qty
; i += 2) {

702 
b¡ršg
 
key_¡r
 = 
li¡
->
’Œy
[
i
];

703 
b¡ršg
 
v®_¡r
 = 
li¡
->
’Œy
[
i
+1];

704 
Šs_v®ue_t
 *
key
 = 
	`Šs_·r£_¡ršg
(
	`bd©a
(
key_¡r
), 
	`bËngth
(key_str));

706 if(
	`b¡ršg_m©ch
(
v®_¡r
, &
NUMBER_PATTERN
)) {

707 
v®ue
 = 
	`Šs_·r£_š‹g”
(
	`bd©a
(
v®_¡r
), 
	`bËngth
(val_str));

709 
v®ue
 = 
	`Šs_·r£_¡ršg
(
	`bd©a
(
v®_¡r
), 
	`bËngth
(val_str));

712 
	`Šs_add_to_diù
(
¬gs
, 
key
, 
v®ue
);

715 
	`Šs_add_to_li¡
(
»q
, 
¬gs
);

717 
d©a
 = 
	`Šs_»nd”
(
»q
, &
Ën
);

718 
	`check
(
d©a
 !ğ
NULL
, "Didn't„endero‡ valid TNetstring.");

719 
	`check
(
Ën
 > 0, "Didn't create‡ valid TNetstring.");

721 
»suÉ
 = 
	`blk2b¡r
(
d©a
, 
Ën
);

722 
	`check
(
»suÉ
 !ğ
NULL
, "Couldn't converto string.");

724 
	`Šs_v®ue_de¡roy
(
»q
);

725 
	`b¡rLi¡De¡roy
(
li¡
);

726 
	`ä“
(
d©a
);

727  
»suÉ
;

729 
”rÜ
:

731 if(
»q
è
	`Šs_v®ue_de¡roy
(req);

732 if(
li¡
è
	`b¡rLi¡De¡roy
(list);

733 if(
d©a
è
	`ä“
(data);

734 if(
»suÉ
è
	`bde¡roy
(result);

736  
NULL
;

737 
	}
}

739 
gb¡ršg
 
	gERROR_KEY
 = 
bsStic
("error");

740 
gb¡ršg
 
	gHEADERS_KEY
 = 
bsStic
("headers");

741 
gb¡ršg
 
	gROWS_KEY
 = 
bsStic
("rows");

743 
	$di¥Ïy_m­_¡yË
(
Šs_v®ue_t
 *
h—d”s
,ns_v®ue_ˆ*
bË
)

745 
i
 = 0;

746 
cŞs
 = 0;

747 
rows
 = 
	`DB_couÁs
(
bË
, &
cŞs
);

748 
	`check
(
rows
 != -1, "Invalid query„esult,…robably‚ot‡able.");

749 
d¬¿y_t
 *
Çmes
 = 
h—d”s
->
v®ue
.
li¡
;

751 
	`check
(
cŞs
 =ğ
	`d¬¿y_’d
(
Çmes
),

754 if(
rows
 == 1) {

755 
i
 = 0; i < 
cŞs
; i++)

757 
Šs_v®ue_t
 *
h
 = 
	`d¬¿y_g‘
(
Çmes
, 
i
);

758 
Šs_v®ue_t
 *
v®
 = 
	`DB_g‘
(
bË
, 0, 
i
);

759 
	`check
(
	`Šs_g‘_ty³
(
h
è=ğ
Šs_g_¡ršg
, "Headers should be strings.");

760 
	`check
(
	`Šs_g‘_ty³
(
v®
è!ğ
Šs_g_šv®id
,

761 "Inv®id v®ufÜ cŞumÀ%d oà»suÉ.", 
i
);

763 
	`´št_d©um
(
h
);

764 
	`´štf
(": ");

765 
	`´št_d©um
(
v®
);

766 
	`´štf
("\n");

769 
	`£Áš–
("Askedo display somethinghat's‚ot in map style.");

772 
”rÜ
:

774 
	}
}

777 
	$di¥Ïy_bË_¡yË
(
Šs_v®ue_t
 *
h—d”s
,ns_v®ue_ˆ*
bË
)

779 
cŞ_i
 = 0;

780 
row_i
 = 0;

781 
cŞ_i
 = 0; cŞ_˜< 
	`d¬¿y_’d
(
h—d”s
->
v®ue
.
li¡
); col_i++)

783 
Šs_v®ue_t
 *
h
 = 
	`d¬¿y_g‘
(
h—d”s
->
v®ue
.
li¡
, 
cŞ_i
);

784 
	`check
(
	`Šs_g‘_ty³
(
h
è=ğ
Šs_g_¡ršg
,

785 "H—d” should b¡ršgs,‚Ù: %c", 
	`Šs_g‘_ty³
(
h
));

786 
	`´štf
("%  ", 
	`bd©a
(
h
->
v®ue
.
¡ršg
));

788 
	`´štf
("\n");

790 
cŞs
 = 0;

791 
rows
 = 
	`DB_couÁs
(
bË
, &
cŞs
);

792 
	`check
(
rows
 != -1, "Invalid query„esults,…robably‚ot inable format.");

794 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

795 
cŞ_i
 = 0; cŞ_˜< 
cŞs
; col_i++) {

796 
Šs_v®ue_t
 *
cŞ
 = 
	`DB_g‘
(
bË
, 
row_i
, 
cŞ_i
);

797 
	`´št_d©um
(
cŞ
);

798 
	`´štf
(" ");

800 
	`´štf
("\n");

802 
	`´štf
("\n");

804 
”rÜ
:

806 
	}
}

808 
	$di¥Ïy_»¥Ú£
(cÚ¡ *
msg
, 
size_t
 
Ën
)

810 
Šs_v®ue_t
 *
»¥
 = 
	`Šs_·r£
(
msg
, 
Ën
, 
NULL
);

811 
hnode_t
 *
node
 = 
NULL
;

813 
	`check
(
	`Šs_g‘_ty³
(
»¥
è=ğ
Šs_g_diù
, "Server„eturned‡n invalid„esponse, must be‡ dict.");

815 
node
 = 
	`hash_lookup
(
»¥
->
v®ue
.
diù
, &
ERROR_KEY
);

817 if(
node
) {

818 
Šs_v®ue_t
 *
v®
 = 
	`hnode_g‘
(
node
);

819 
	`´štf
("ERROR: %s\n", 
	`bd©a
(
v®
->
v®ue
.
¡ršg
));

821 
node
 = 
	`hash_lookup
(
»¥
->
v®ue
.
diù
, &
HEADERS_KEY
);

822 
	`check
(
node
 !ğ
NULL
, "Server„eturned‡n invalid„esponse,‚eed‡ 'headers'.");

823 
Šs_v®ue_t
 *
h—d”s
 = 
	`hnode_g‘
(
node
);

824 
	`check
(
	`Šs_g‘_ty³
(
h—d”s
è=ğ
Šs_g_li¡
, "Headers must be‡†ist, server is screwed up.");

826 
node
 = 
	`hash_lookup
(
»¥
->
v®ue
.
diù
, &
ROWS_KEY
);

827 
	`check
(
node
 !ğ
NULL
, "Server„eturned‡n invalid„esponse,‚eed‡ 'rows'.");

828 
Šs_v®ue_t
 *
rows
 = 
	`hnode_g‘
(
node
);

829 
	`check
(
	`Šs_g‘_ty³
(
rows
è=ğ
Šs_g_li¡
, "Rows must be‡†ist, server is screwed up.");

831 if(
	`d¬¿y_’d
(
rows
->
v®ue
.
li¡
) == 1) {

832 
	`di¥Ïy_m­_¡yË
(
h—d”s
, 
rows
);

834 
	`di¥Ïy_bË_¡yË
(
h—d”s
, 
rows
);

838 
”rÜ
:

839 
	`Šs_v®ue_de¡roy
(
»¥
);

841 
	}
}

843 
	$£nd_»cv_cÚŒŞ
(
b¡ršg
 
¬gs
, *
sock‘
)

845 
rc
 = 0;

846 
zmq_msg_t
 *
outmsg
 = 
NULL
;

847 
zmq_msg_t
 *
šmsg
 = 
NULL
;

849 
outmsg
 = 
	`ÿÎoc
((
zmq_msg_t
), 1);

850 
	`check_mem
(
outmsg
);

851 
šmsg
 = 
	`ÿÎoc
((
zmq_msg_t
), 1);

852 
	`check_mem
(
šmsg
);

854 
rc
 = 
	`zmq_msg_š™
(
outmsg
);

855 
	`check
(
rc
 == 0, "Failedo initialize outgoing message.");

856 
rc
 = 
	`zmq_msg_š™
(
šmsg
);

857 
	`check
(
rc
 == 0, "Failedo initialize incoming message.");

859 
b¡ršg
 
»que¡
 = 
	`·r£_šput
(
¬gs
);

860 
	`check
(
»que¡
 !ğ
NULL
, "Invalid command,ry‡gain.");

863 
rc
 = 
	`zmq_msg_š™_d©a
(
outmsg
, 
	`bd©a
(
»que¡
), 
	`bËngth
Ôeque¡)+1, 
b¡ršg_ä“
,„equest);

864 
	`check
(
rc
 == 0, "Failedo init outgoing message.");

866 
rc
 = 
	`mq£nd
(
sock‘
, 
outmsg
, 0);

867 
	`check
(
rc
 == 0, "Failedo send messageo control…ort.");

868 
	`ä“
(
outmsg
);

871 
rc
 = 
	`mq»cv
(
sock‘
, 
šmsg
, 0);

872 
	`check
(
rc
 == 0, "Failedo„eceive message from control…ort.");

874 
	`di¥Ïy_»¥Ú£
((cÚ¡ *)
	`zmq_msg_d©a
(
šmsg
), 
	`zmq_msg_size
(inmsg));

876 
	`fæush
(
¡dout
);

877 
	`ä“
(
šmsg
);

881 
”rÜ
:

882 if(
outmsg
è
	`ä“
(outmsg);

883 if(
šmsg
è
	`ä“
(inmsg);

885 
	}
}

887 
	$cÚŒŞ_£rv”
(
S”v”Run
 *
r
, 
Šs_v®ue_t
 *
»s
)

889 
rc
 = 0;

890 *
sock‘
 = 
NULL
;

891 
b¡ršg
 
´om±
 = 
NULL
;

892 
b¡ršg
 
cÚŒŞ
 = 
NULL
;

893 
r
->
¿n
 = 1;

894 
cŞs
 = 0;

895 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

897 
	`check
(
rows
 != -1, "Invalid data giveno internal„outine control_server.");

898 
	`check
(
rows
 == 1, "Ambiguous server select,ƒxpected 1 but got %d.",„ows);

900 
b¡ršg
 
£rv”_Çme
 = 
	`DB_g‘_as
(
»s
, 0, 0, 
¡ršg
);

901 
b¡ršg
 
chroÙ
 = 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
);

903 
	`check
(
£rv”_Çme
 !ğ
NULL
 && 
chroÙ
 != NULL,

906 
´om±
 = 
	`bfÜm©
("m2 [%s]> ", 
	`bd©a
(
£rv”_Çme
));

907 
cÚŒŞ
 = 
	`bfÜm©
("c://%s/run/cÚŒŞ", 
	`bd©a
(
chroÙ
));

908 
	`log_šfo
("CÚÃùšgØcÚŒŞ…Üˆ%s", 
	`bd©a
(
cÚŒŞ
));

910 
	`mqš™
(1);

911 
	`Regi¡”_š™
();

913 
sock‘
 = 
	`mqsock‘
(
ZMQ_REQ
);

914 
	`check
(
sock‘
 !ğ
NULL
, "Failedo create REQ socket.");

916 
rc
 = 
	`zmq_cÚÃù
(
sock‘
, 
	`bd©a
(
cÚŒŞ
));

917 
	`check
(
rc
 == 0, "Failedo connecto control…ort.");

919 
rc
 = 
	`lš’oi£_ruÂ”
(
	`bd©a
(
´om±
), 
£nd_»cv_cÚŒŞ
, 
sock‘
);

921 
	`bde¡roy
(
´om±
);

922 
	`bde¡roy
(
cÚŒŞ
);

923 
	`zmq_şo£
(
sock‘
);

924 
	`zmq_‹rm
(
ZMQ_CTX
);

925  
rc
;

927 
”rÜ
:

928 if(
´om±
è
	`bde¡roy
(prompt);

929 if(
cÚŒŞ
è
	`bde¡roy
(control);

930 if(
sock‘
è
	`zmq_şo£
(socket);

932 
	}
}

934 
	$Commªd_cÚŒŞ
(
Commªd
 *
cmd
)

936  
	`exec_£rv”_İ”©iÚs
(
cmd
, 
cÚŒŞ_£rv”
, "name, chroot");

937 
	}
}

939 
	$Commªd_v”siÚ
(
Commªd
 *
cmd
)

941 
	~<v”siÚ.h
>

942 
	`´štf
("%s\n", 
VERSION
);

943 #undeà
VERSION


946 
	}
}

948 
	$Commªd_uuid
(
Commªd
 *
cmd
)

950  
	`sy¡em
("uuidgen");

951 
	}
}

954 
Commªd_h–p
(
Commªd
 *
cmd
);

956 
CommªdHªdËr
 
	gCOMMAND_MAPPING
[] = {

957 {.
Çme
 = "lßd", .
	gcb
 = 
Commªd_lßd
,

958 .
	gh–p
 = "Load‡ config."},

959 {.
	gÇme
 = "cÚfig", .
	gcb
 = 
Commªd_lßd
,

960 .
	gh–p
 = "Alias for†oad." },

961 {.
	gÇme
 = "sh–l", .
	gcb
 = 
Commªd_sh–l
,

962 .
	gh–p
 = "Starts‡n interactive shell." },

963 {.
	gÇme
 = "acûss", .
	gcb
 = 
Commªd_acûss_logs
,

964 .
	gh–p
 = "Printshe‡ccess†og."},

965 {.
	gÇme
 = "£rv”s", .
	gcb
 = 
Commªd_£rv”s
,

966 .
	gh–p
 = "Listshe servers in‡ config database." },

967 {.
	gÇme
 = "ho¡s", .
	gcb
 = 
Commªd_ho¡s
,

968 .
	gh–p
 = "Listshe hosts in‡ server." },

969 {.
	gÇme
 = "rou‹s", .
	gcb
 = 
Commªd_rou‹s
,

970 .
	gh–p
 = "Listshe„outes in‡ host." },

971 {.
	gÇme
 = "comm™", .
	gcb
 = 
Commªd_comm™
,

972 .
	gh–p
 = "Adds‡ messageohe†og." },

973 {.
	gÇme
 = "log", .
	gcb
 = 
Commªd_log
,

974 .
	gh–p
 = "Printshe commit†og." },

975 {.
	gÇme
 = "¡¬t", .
	gcb
 = 
Commªd_¡¬t
,

976 .
	gh–p
 = "Starts‡ server." },

977 {.
	gÇme
 = "¡İ", .
	gcb
 = 
Commªd_¡İ
,

978 .
	gh–p
 = "Stops‡ server." },

979 {.
	gÇme
 = "»lßd", .
	gcb
 = 
Commªd_»lßd
,

980 .
	gh–p
 = "Reloads‡ server." },

981 {.
	gÇme
 = "ruÂšg", .
	gcb
 = 
Commªd_ruÂšg
,

982 .
	gh–p
 = "Tells you what's„unning." },

983 {.
	gÇme
 = "cÚŒŞ", .
	gcb
 = 
Commªd_cÚŒŞ
,

984 .
	gh–p
 = "Connectsohe control…ort." },

985 {.
	gÇme
 = "v”siÚ", .
	gcb
 = 
Commªd_v”siÚ
,

986 .
	gh–p
 = "Printshe Mongrel2‡nd m2sh version." },

987 {.
	gÇme
 = "h–p", .
	gcb
 = 
Commªd_h–p
,

988 .
	gh–p
 = "Get help,†ists commands." },

989 {.
	gÇme
 = "uuid", .
	gcb
 = 
Commªd_uuid
,

990 .
	gh–p
 = "Prints out‡„andomly generated UUID." },

991 {.
	gÇme
 = 
NULL
, .
	gcb
 = NULL, .
	gh–p
 = NULL}

995 
	$Commªd_h–p
(
Commªd
 *
cmd
)

997 
CommªdHªdËr
 *
hªdËr
;

999 
Êode_t
 *
ex
 = 
	`li¡_fœ¡
(
cmd
->
exŒa
);

1001 if(
ex
) {

1002 
b¡ršg
 
¬g
 = 
	`Êode_g‘
(
ex
);

1004 
hªdËr
 = 
COMMAND_MAPPING
; hªdËr->
Çme
 !ğ
NULL
; handler++) {

1005 if(
	`bi£qc¡r
(
¬g
, 
hªdËr
->
Çme
)) {

1006 
	`´štf
("%s\t%s\n", 
hªdËr
->
Çme
, hªdËr->
h–p
);

1011 
	`´štf
("NØh–°fÜ %s. U£ m2sh h–°tØ£¨li¡.", 
	`bd©a
(
¬g
));

1013 
	`´štf
("Mongrel2 m2sh hashese commands‡vailable:\n\n");

1015 
hªdËr
 = 
COMMAND_MAPPING
; hªdËr->
Çme
 !ğ
NULL
; handler++) {

1016 
	`´štf
("%8  %s\n", 
hªdËr
->
Çme
, hªdËr->
h–p
);

1021 
	}
}

1023 
	$Commªd_de¡roy
(
Commªd
 *
cmd
)

1025 
i
 = 0;

1027 
	`bde¡roy
(
cmd
->
´ogÇme
);

1028 
	`bde¡roy
(
cmd
->
Çme
);

1030 if(
cmd
->
exŒa
) {

1031 
	`li¡_de¡roy_nodes
(
cmd
->
exŒa
);

1032 
	`li¡_de¡roy
(
cmd
->
exŒa
);

1035 if(
cmd
->
İtiÚs
) {

1036 
	`hash_ä“_nodes
(
cmd
->
İtiÚs
);

1037 
	`hash_de¡roy
(
cmd
->
İtiÚs
);

1041 
i
 = 0; i < 
cmd
->
tok’_couÁ
; i++) {

1042 
	`Tok’_de¡roy
(
cmd
->
tok’s
[
i
]);

1045 
	`ä“
(
cmd
);

1046 
	}
}

1049 
	$Commªd_run
(
b¡ršg
 
¬gum’ts
)

1051 
Commªd
 *
cmd
 = 
	`ÿÎoc
(1, (Command));

1052 
CommªdHªdËr
 *
hªdËr
;

1053 
rc
 = 0;

1055 
	`check
(
	`şi_·¿ms_·r£_¬gs
(
¬gum’ts
, 
cmd
) != -1, "USAGE: m2sh <command> [options]");

1056 
	`check_no_exŒa
(
cmd
);

1058 
hªdËr
 = 
COMMAND_MAPPING
; hªdËr->
Çme
 !ğ
NULL
; handler++)

1060 if(
	`bi£qc¡r
(
cmd
->
Çme
, 
hªdËr
->name)) {

1061 
rc
 = 
hªdËr
->
	`cb
(
cmd
);

1062 
	`Commªd_de¡roy
(
cmd
);

1063  
rc
;

1067 
	`log_”r
("INVALID COMMAND. Use m2sh helpo find out what's‡vailable.");

1069 
”rÜ
:

1070 
	`Commªd_de¡roy
(
cmd
);

1072 
	}
}

	@tools/m2sh/src/commands.h

1 #iâdeà
_m2sh_commªds_h


2 
	#_m2sh_commªds_h


	)

4 
	~<b¡ršg.h
>

5 
	~<adt/hash.h
>

6 
	~<adt/li¡.h
>

7 
	~"tok’.h
"

9 
Commªd_run
(
b¡ršg
 
¬gum’ts
);

11 
	#MAX_TOKENS
 100

	)

13 
	sCommªd
 {

14 
b¡ršg
 
	m´ogÇme
;

15 
b¡ršg
 
	mÇme
;

16 
hash_t
 *
	mİtiÚs
;

17 
li¡_t
 *
	mexŒa
;

18 
	m”rÜ
;

19 
Tok’
 *
	mtok’s
[
MAX_TOKENS
];

20 
	mtok’_couÁ
;

21 } 
	tCommªd
;

	@tools/m2sh/src/config_file.c

35 
	~<cÚfig/db.h
>

36 
	~"cÚ¡ªts.h
"

37 
	~<b¡ršg.h
>

38 
	~"cÚfig_fe.h
"

39 
	~"a¡.h
"

40 
	~<dbg.h
>

41 
	~<¡dlib.h
>

44 
	#CONFIRM_TYPE
(
N
è
	`check
(
	`V®ue_is
(
v®
, 
CLASS
), "Not‡ class.");\

45 
	`check
(
	`bi£qc¡r
(
	`CÏss_id’t
(
v®
->
as
.
şs
), 
N
), "Should b¨" #N ".");

	)

47 
	gSERVER_ID
 = 0;

48 
	gHOST_ID
 = 0;

50 
gb¡ršg
 
	gCACHE_TTL
 = 
bsStic
("cache_ttl");

52 
	$Dœ_lßd
(
t¡_t
 *
£‰šgs
,¡_ˆ*
·¿ms
)

54 cÚ¡ *
ba£
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "ba£", 
VAL_QSTRING
);

56 
Šs_v®ue_t
 *
»s
 = 
	`DB_exec
(
	`bd©a
(&
DIR_SQL
), 
ba£
,

57 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "šdex_fe", 
VAL_QSTRING
),

58 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "deçuÉ_ùy³", 
VAL_QSTRING
));

59 
	`check
(
»s
 !ğ
NULL
, "Inv®id d©aba£, couldn'ˆqu”y fÜ dœeùÜy: %s", 
ba£
);

60 
	`Šs_v®ue_de¡roy
(
»s
);

62 if(
	`t¡_£¬ch
(
·¿ms
, 
	`bd©a
(&
CACHE_TTL
), 
	`bËngth
(&CACHE_TTL))) {

63 cÚ¡ *
ÿche_‰l
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "ÿche_‰l", 
VAL_NUMBER
);

65 if(
ÿche_‰l
 && cache_ttl[0] != '0') {

66 
»s
 = 
	`DB_exec
(
	`bd©a
(&
DIR_CACHE_TTL_SQL
), 
ÿche_‰l
);

67 
	`check
(
»s
 !ğ
NULL
, "Inv®id d©aba£, couldn'ˆ£ˆÿche_‰Èš dœeùÜy: %s", 
ba£
);

68 
	`Šs_v®ue_de¡roy
(
»s
);

72  
	`DB_Ï¡id
();

74 
”rÜ
:

75 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

77 
	}
}

79 
gb¡ršg
 
	gRAW_PAYLOAD
 = 
bsStic
("raw_payload");

80 
gb¡ršg
 
	gPROTOCOL
 = 
bsStic
("protocol");

82 
	$HªdËr_lßd
(
t¡_t
 *
£‰šgs
,¡_ˆ*
·¿ms
)

84 cÚ¡ *
£nd_¥ec
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "£nd_¥ec", 
VAL_QSTRING
);

85 
Šs_v®ue_t
 *
»s
 = 
NULL
;

87 
»s
 = 
	`DB_exec
(
	`bd©a
(&
HANDLER_SQL
),

88 
£nd_¥ec
,

89 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "£nd_id’t", 
VAL_QSTRING
),

90 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "»cv_¥ec", 
VAL_QSTRING
),

91 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "»cv_id’t", 
VAL_QSTRING
));

92 
	`check
(
»s
 !ğ
NULL
, "FaedØlßd HªdËr: %s", 
£nd_¥ec
);

93 
	`Šs_v®ue_de¡roy
(
»s
);

95 if(
	`t¡_£¬ch
(
·¿ms
, 
	`bd©a
(&
RAW_PAYLOAD
), 
	`bËngth
(&RAW_PAYLOAD))) {

96 cÚ¡ *
¿w_·ylßd
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "¿w_·ylßd", 
VAL_NUMBER
);

98 if(
¿w_·ylßd
 &&„aw_payload[0] == '1') {

99 
	`DB_exec
(
	`bd©a
(&
HANDLER_RAW_SQL
));

100 
	`check
(
»s
 !ğ
NULL
, "Invalid database, can't set„aw…ayload.");

101 
	`Šs_v®ue_de¡roy
(
»s
);

105 if(
	`t¡_£¬ch
(
·¿ms
, 
	`bd©a
(&
PROTOCOL
), 
	`bËngth
(&PROTOCOL))) {

106 cÚ¡ *
´ÙocŞ
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "´ÙocŞ", 
VAL_QSTRING
);

107 
´ÙocŞ
 =…rÙocŞ !ğ
NULL
 ?…rotocol : "json";

109 
»s
 = 
	`DB_exec
(
	`bd©a
(&
HANDLER_PROTOCOL_SQL
), 
´ÙocŞ
);

110 
	`check
(
»s
 !ğ
NULL
, "Inv®id SQL w™h you¸´ÙocŞ s‘tšg: '%s'", 
´ÙocŞ
);

111 
	`Šs_v®ue_de¡roy
(
»s
);

114  
	`DB_Ï¡id
();

116 
”rÜ
:

118 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

120 
	}
}

123 
	$Proxy_lßd
(
t¡_t
 *
£‰šgs
,¡_ˆ*
·¿ms
)

125 cÚ¡ *
addr
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "addr", 
VAL_QSTRING
);

126 cÚ¡ *
pÜt
 = 
	`AST_¡r
(
£‰šgs
, 
·¿ms
, "pÜt", 
VAL_NUMBER
);

128 
Šs_v®ue_t
 *
»s
 = 
	`DB_exec
(
	`bd©a
(&
PROXY_SQL
), 
addr
, 
pÜt
);

129 
	`check
(
»s
 !ğ
NULL
, "FaedØlßd Proxy: %s:%s", 
addr
, 
pÜt
);

130  
	`DB_Ï¡id
();

132 
”rÜ
:

133 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

135 
	}
}

137 
	$Mim‘y³s_impÜt
()

139 *
zE¼Msg
 = 
NULL
;

140 
rc
 = 
	`sql™e3_exec
(
CONFIG_DB
, 
	`bd©a
(&
MIMETYPES_DEFAULT_SQL
), 
NULL
, NULL, &
zE¼Msg
);

141 
	`check
(
rc
 =ğ
SQLITE_OK
, "FaedØlßd in™ŸÈschema: %s", 
zE¼Msg
);

144 
”rÜ
:

145 if(
zE¼Msg
è
	`sql™e3_ä“
(zErrMsg);

147 
	}
}

149 
	$Mim‘y³s_lßd
(
t¡_t
 *
£‰šgs
, 
Paœ
 *
·œ
)

151 cÚ¡ *
ext
 = 
	`bd©a
(
	`Paœ_key
(
·œ
));

152 
V®ue
 *
v®
 = 
	`Paœ_v®ue
(
·œ
);

153 
	`check
(
v®
, "E¼Ü†ßdšg Mim‘y³ %s", 
	`bd©a
(
	`Paœ_key
(
·œ
)));

155 
Šs_v®ue_t
 *
»s
 = 
NULL
;

157 
»s
 = 
	`DB_exec
(
	`bd©a
(&
MIMETYPE_SQL
),

158 
ext
,ƒxt, 
	`bd©a
(
v®
->
as
.
¡ršg
->
d©a
));

160 
	`check
(
»s
 !ğ
NULL
, "Failedo‡dd mimetype: %s=%s",

161 
ext
, 
	`bd©a
(
v®
->
as
.
¡ršg
->
d©a
));

163 
	`Šs_v®ue_de¡roy
(
»s
);

166 
”rÜ
:

167 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

169 
	}
}

171 
	$S‘tšgs_lßd
(
t¡_t
 *
£‰šgs
, 
Paœ
 *
·œ
)

173 cÚ¡ *
Çme
 = 
	`bd©a
(
	`Paœ_key
(
·œ
));

174 
V®ue
 *
v®
 = 
	`Paœ_v®ue
(
·œ
);

175 
	`check
(
v®
, "E¼Ü†ßdšg S‘tšg %s", 
	`bd©a
(
	`Paœ_key
(
·œ
)));

177 
Šs_v®ue_t
 *
»s
 = 
NULL
;

179 
»s
 = 
	`DB_exec
(
	`bd©a
(&
SETTING_SQL
), 
Çme
, bd©a(
v®
->
as
.
¡ršg
->
d©a
));

181 
	`check
(
»s
 !ğ
NULL
, "Failedo‡dd setting: %s=%s",

182 
Çme
, 
	`bd©a
(
v®
->
as
.
¡ršg
->
d©a
));

184 
	`Šs_v®ue_de¡roy
(
»s
);

187 
”rÜ
:

188 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

190 
	}
}

193 
	$Rou‹_lßd
(
t¡_t
 *
£‰šgs
, 
Paœ
 *
·œ
)

195 cÚ¡ *
Çme
 = 
	`bd©a
(
	`Paœ_key
(
·œ
));

196 
Šs_v®ue_t
 *
»s
 = 
NULL
;

197 
V®ue
 *
v®
 = 
	`Paœ_v®ue
(
·œ
);

198 
b¡ršg
 
ty³
 = 
NULL
;

199 
rc
 = 0;

201 
	`check
(
v®
, "E¼Ü†ßdšg„ou‹: %s", 
	`bd©a
(
	`Paœ_key
(
·œ
)));

202 
	`check
(
	`V®ue_is
(
v®
, 
CLASS
), "Expected‡ Class but got‡ %s instead.",

203 
	`V®ue_ty³_Çme
(
v®
->
ty³
));

204 
CÏss
 *
şs
 = 
v®
->
as
.cls;

205 
ty³
 = 
	`b¡rıy
(
	`CÏss_id’t
(
şs
));

206 
	`btŞow”
(
ty³
);

208 if(
şs
->
id
 == -1) {

209 if(
	`bi£qc¡r
(
ty³
, "dir")) {

210 
rc
 = 
	`Dœ_lßd
(
£‰šgs
, 
şs
->
·¿ms
);

211 } if(
	`bi£qc¡r
(
ty³
, "proxy")) {

212 
rc
 = 
	`Proxy_lßd
(
£‰šgs
, 
şs
->
·¿ms
);

213 } if(
	`bi£qc¡r
(
ty³
, "handler")) {

214 
rc
 = 
	`HªdËr_lßd
(
£‰šgs
, 
şs
->
·¿ms
);

216 
	`£Áš–
("Inv®idy³ oàrou‹¬g‘: %s", 
	`bd©a
(
	`CÏss_id’t
(
şs
)));

219 
	`check
(
rc
 !ğ-1, "FaedØü—‹¬g‘ fÜ„ou‹ %s", 
Çme
);

220 
şs
->
id
 = 
rc
;

223 
»s
 = 
	`DB_exec
(
	`bd©a
(&
ROUTE_SQL
), 
Çme
, 
HOST_ID
, 
şs
->
id
, bd©a(
ty³
));

224 
	`check
(
»s
 !ğ
NULL
, "Failedo intialize„oute.");

226 
	`Šs_v®ue_de¡roy
(
»s
);

227 
	`bde¡roy
(
ty³
);

230 
”rÜ
:

231 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

232 if(
ty³
è
	`bde¡roy
(type);

234 
	}
}

236 
gb¡ršg
 
	gMATCHING_PARAM
 = 
bsStic
("matching");

238 
	$Ho¡_lßd
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
v®
)

240 
	`CONFIRM_TYPE
("Host");

241 
CÏss
 *
şs
 = 
v®
->
as
.cls;

242 
Šs_v®ue_t
 *
»s
 = 
NULL
;

243 
gb¡ršg
 
ROUTES_VAR
 = 
	`bsStic
("routes");

245 cÚ¡ *
Çme
 = 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "Çme", 
VAL_QSTRING
);

246 cÚ¡ *
m©chšg
 = 
Çme
;

247 
	`check
(
Çme
, "No‚ame set for Host.");

249 if(
	`t¡_£¬ch
(
şs
->
·¿ms
, 
	`bd©a
(&
MATCHING_PARAM
), 
	`bËngth
(&MATCHING_PARAM))) {

251 
m©chšg
 = 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, 
	`bd©a
(&
MATCHING_PARAM
), 
VAL_QSTRING
);

254 
»s
 = 
	`DB_exec
(
	`bd©a
(&
HOST_SQL
), 
SERVER_ID
, 
Çme
, 
m©chšg
);

255 
	`check
(
»s
 !ğ
NULL
, "FaedØ¡ÜHo¡: %s", 
Çme
);

256 
	`Šs_v®ue_de¡roy
(
»s
);

258 
şs
->
id
 = 
HOST_ID
 = 
	`DB_Ï¡id
();

260 
V®ue
 *
rou‹s
 = 
	`AST_g‘
(
£‰šgs
, 
şs
->
·¿ms
, &
ROUTES_VAR
, 
VAL_HASH
);

261 
	`check
(
rou‹s
, "Didn'ˆfšd‡ny„ou‹ fÜ %s", 
Çme
);

263 
	`AST_w®k_hash
(
£‰šgs
, 
rou‹s
, 
Rou‹_lßd
);

267 
”rÜ
:

268 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

270 
	}
}

272 
gb¡ršg
 
	gBIND_ADDR
 = 
bsStic
("bind_addr");

273 
gb¡ršg
 
	gUSE_SSL
 = 
bsStic
("use_ssl");

275 
	$S”v”_lßd
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
v®
)

277 
	`CONFIRM_TYPE
("Server");

278 
CÏss
 *
şs
 = 
v®
->
as
.cls;

279 
Šs_v®ue_t
 *
»s
 = 
NULL
;

280 
gb¡ršg
 
HOSTS_VAR
 = 
	`bsStic
("hosts");

281 cÚ¡ *
bšd_addr
 = 
NULL
;

282 cÚ¡ *
u£_s¦
 = 
NULL
;

284 if(
	`t¡_£¬ch
(
şs
->
·¿ms
, 
	`bd©a
(&
BIND_ADDR
), 
	`bËngth
(&BIND_ADDR))) {

285 
bšd_addr
 = 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, 
	`bd©a
(&
BIND_ADDR
), 
VAL_QSTRING
);

287 
bšd_addr
 = "0.0.0.0";

290 if(
	`t¡_£¬ch
(
şs
->
·¿ms
, 
	`bd©a
(&
USE_SSL
), 
	`bËngth
(&USE_SSL))) {

291 
u£_s¦
 = 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, 
	`bd©a
(&
USE_SSL
), 
VAL_NUMBER
);

293 
u£_s¦
 = "0";

296 
»s
 = 
	`DB_exec
(
	`bd©a
(&
SERVER_SQL
),

297 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "uuid", 
VAL_QSTRING
),

298 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "acûss_log", 
VAL_QSTRING
),

299 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "”rÜ_log", 
VAL_QSTRING
),

300 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "pid_fe", 
VAL_QSTRING
),

301 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "chroÙ", 
VAL_QSTRING
),

302 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "deçuÉ_ho¡", 
VAL_QSTRING
),

303 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "Çme", 
VAL_QSTRING
),

304 
bšd_addr
,

305 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "pÜt", 
VAL_NUMBER
),

306 
u£_s¦


308 
	`check
(
»s
 !ğ
NULL
, "FaedØexeøSQL: %s", 
	`bd©a
(&
SERVER_SQL
));

309 
	`Šs_v®ue_de¡roy
(
»s
);

311 
şs
->
id
 = 
SERVER_ID
 = 
	`DB_Ï¡id
();

313 
V®ue
 *
ho¡s
 = 
	`AST_g‘
(
£‰šgs
, 
şs
->
·¿ms
, &
HOSTS_VAR
, 
VAL_LIST
);

314 
	`check
(
ho¡s
 !ğ
NULL
, "Could‚ot find Server.hosts setting in host %s:%s",

315 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "uuid", 
VAL_QSTRING
),

316 
	`AST_¡r
(
£‰šgs
, 
şs
->
·¿ms
, "Çme", 
VAL_QSTRING
));

318 
	`AST_w®k_li¡
(
£‰šgs
, 
ho¡s
->
as
.
li¡
, 
Ho¡_lßd
);

322 
”rÜ
:

323 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

325 
	}
}

327 
šlše
 
	$CÚfig_£tup
(cÚ¡ *
db_fe
)

329 
	`DB_š™
(
db_fe
);

330 
Šs_v®ue_t
 *
»s
 = 
	`DB_exec
("begin");

331 
	`check
(
»s
 !ğ
NULL
, "Couldn't startransaction.");

332 
	`Šs_v®ue_de¡roy
(
»s
);

334 *
zE¼Msg
 = 
NULL
;

336 
rc
 = 
	`sql™e3_exec
(
CONFIG_DB
, 
	`bd©a
(&
CONFIG_SCHEMA
), 
NULL
, NULL, &
zE¼Msg
);

337 
	`check
(
rc
 =ğ
SQLITE_OK
, "FaedØlßd in™ŸÈschema: %s", 
zE¼Msg
);

341 
”rÜ
:

342 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

343 if(
zE¼Msg
è
	`sql™e3_ä“
(zErrMsg);

345 
	}
}

348 
šlše
 
	$CÚfig_comm™
()

350  
	`DB_exec
("comm™"è=ğ
NULL
 ? -1 : 0;

351 
	}
}

354 
	$CÚfig_lßd
(cÚ¡ *
cÚfig_fe
, cÚ¡ *
db_fe
)

356 
rc
 = 0;

357 
t¡_t
 *
£‰šgs
 = 
NULL
;

358 
gb¡ršg
 
SETTINGS_VAR
 = 
	`bsStic
("settings");

359 
gb¡ršg
 
MIMETYPES_VAR
 = 
	`bsStic
("mimetypes");

361 
£‰šgs
 = 
	`P¬£_cÚfig_fe
(
cÚfig_fe
);

362 
	`check
(
£‰šgs
 !ğ
NULL
, "E¼Ü…¬sšg cÚfig fe: %s.", 
cÚfig_fe
);

364 
rc
 = 
	`CÚfig_£tup
(
db_fe
);

365 
	`check
(
rc
 =ğ0, "FaedØcÚfigu» cÚfig db: %s", 
db_fe
);

367 
rc
 = 
	`AST_w®k
(
£‰šgs
, 
S”v”_lßd
);

368 
	`check
(
rc
 =ğ0, "FaedØ´oûs thcÚfig fe: %s", 
cÚfig_fe
);

370 
V®ue
 *
£t
 = 
	`AST_g‘
(
£‰šgs
, s‘tšgs, &
SETTINGS_VAR
, 
VAL_HASH
);

372 if(
£t
) {

373 
rc
 = 
	`AST_w®k_hash
(
£‰šgs
, 
£t
, 
S‘tšgs_lßd
);

374 
	`check
(
rc
 == 0, "Failedo†oadhe settings. Aborting.");

377 
rc
 = 
	`Mim‘y³s_impÜt
();

378 
	`check
(
rc
 == 0, "Failedo import default mimetypes.");

380 
V®ue
 *
mime
 = 
	`AST_g‘
(
£‰šgs
, s‘tšgs, &
MIMETYPES_VAR
, 
VAL_HASH
);

381 if(
mime
) {

382 
	`AST_w®k_hash
(
£‰šgs
, 
mime
, 
Mim‘y³s_lßd
);

383 
	`check
(
rc
 == 0, "Failedo†oadhe mimetypes. Aborting.");

386 
rc
 = 
	`CÚfig_comm™
();

387 
	`check
(
rc
 =ğ0, "FaedØcomm™ cÚfig db: %s", 
db_fe
);

389 
	`AST_de¡roy
(
£‰šgs
);

390 
	`DB_şo£
();

392 
”rÜ
:

393 
	`AST_de¡roy
(
£‰šgs
);

394 
	`DB_şo£
();

396 
	}
}

	@tools/m2sh/src/config_file.h

1 #iâdeà
_m2sh_cÚfig_fe_h


2 
	#_m2sh_cÚfig_fe_h


	)

4 
	~<b¡ršg.h
>

5 
	~<adt/t¡.h
>

6 
	~"tok’.h
"

8 
t¡_t
 *
P¬£_cÚfig_¡ršg
(
b¡ršg
 
cÚ‹Á
);

10 
t¡_t
 *
P¬£_cÚfig_fe
(cÚ¡ *
·th
);

12 
	sP¬£rS‹
 {

13 
t¡_t
 *
	m£‰šgs
;

14 
	mlše_numb”
;

15 
	m”rÜ
;

16 } 
	tP¬£rS‹
;

18 
	gPaœ
;

19 
	gV®ue
;

21 
Dœ_lßd
(
t¡_t
 *
£‰šgs
,¡_ˆ*
·¿ms
);

23 
HªdËr_lßd
(
t¡_t
 *
£‰šgs
,¡_ˆ*
·¿ms
);

25 
Proxy_lßd
(
t¡_t
 *
£‰šgs
,¡_ˆ*
·¿ms
);

27 
S‘tšgs_lßd
(
t¡_t
 *
£‰šgs
, 
Paœ
 *
·œ
);

29 
Rou‹_lßd
(
t¡_t
 *
£‰šgs
, 
Paœ
 *
·œ
);

31 
Ho¡_lßd
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
v®
);

33 
S”v”_lßd
(
t¡_t
 *
£‰šgs
, 
V®ue
 *
v®
);

35 
CÚfig_lßd
(cÚ¡ *
cÚfig_fe
, cÚ¡ *
db_fe
);

	@tools/m2sh/src/constants.c

35 
	~"cÚ¡ªts.h
"

37 
gb¡ršg
 
	gCONFIG_SCHEMA
 = 
bsStic
(

118 
gb¡ršg
 
	gSERVER_SQL
 = 
bsStic
("INSERT INTO server (uuid,‡ccess_log,ƒrror_log,…id_file, chroot, default_host,‚ame, bind_addr,…ort, use_ssl) VALUES (%Q, %Q, %Q, %Q, %Q, %Q, %Q, %Q, %s, %s);");

120 
gb¡ršg
 
	gHOST_SQL
 = 
bsStic
("INSERT INTO host (server_id,‚ame, matching) VALUES (%d, %Q, %Q);");

122 
gb¡ršg
 
	gSETTING_SQL
 = 
bsStic
("INSERT INTO setting (key, value) VALUES (%Q, %Q);");

123 
gb¡ršg
 
	gMIMETYPE_SQL
 = 
bsStic
("DELETE from mimetype whereƒxtension=%Q; INSERT INTO mimetype (extension, mimetype) VALUES (%Q, %Q);");

125 
gb¡ršg
 
	gDIR_SQL
 = 
bsStic
("INSERT INTO directory (base, index_file, default_ctype) VALUES (%Q, %Q, %Q);");

126 
gb¡ršg
 
	gDIR_CACHE_TTL_SQL
 = 
bsStic
("UPDATE directory SET cache_ttl=%Q WHERE id=last_insert_rowid();");

128 
gb¡ršg
 
	gPROXY_SQL
 = 
bsStic
("INSERT INTO…roxy (addr,…ort) VALUES (%Q, %Q);");

130 
gb¡ršg
 
	gHANDLER_SQL
 = 
bsStic
("INSERT INTO handler (send_spec, send_ident,„ecv_spec,„ecv_ident) VALUES (%Q, %Q, %Q, %Q);");

132 
gb¡ršg
 
	gROUTE_SQL
 = 
bsStic
("INSERT INTO„oute (path, host_id,arget_id,arget_type) VALUES (%Q, %d, %d, %Q);");

134 
gb¡ršg
 
	gHANDLER_RAW_SQL
 = 
bsStic
("UPDATE handler SET„aw_payload=1 WHERE id=last_insert_rowid();");

135 
gb¡ršg
 
	gHANDLER_PROTOCOL_SQL
 = 
bsStic
("UPDATE handler SET…rotocol=%Q WHERE id=last_insert_rowid();");

138 
	~"mim‘y³s.csql
"

	@tools/m2sh/src/constants.h

1 #iâdeà
_m2sh_cÚ¡ªts_h


2 
	#_m2sh_cÚ¡ªts_h


	)

4 
	~<b¡ršg.h
>

5 
gb¡ršg
 
CONFIG_SCHEMA
;

6 
gb¡ršg
 
SERVER_SQL
;

7 
gb¡ršg
 
HOST_SQL
;

8 
gb¡ršg
 
SETTING_SQL
;

9 
gb¡ršg
 
MIMETYPE_SQL
;

10 
gb¡ršg
 
DIR_SQL
;

11 
gb¡ršg
 
DIR_CACHE_TTL_SQL
;

12 
gb¡ršg
 
PROXY_SQL
;

13 
gb¡ršg
 
HANDLER_SQL
;

14 
gb¡ršg
 
ROUTE_SQL
;

15 
gb¡ršg
 
MIMETYPES_DEFAULT_SQL
;

16 
gb¡ršg
 
HANDLER_RAW_SQL
;

17 
gb¡ršg
 
HANDLER_PROTOCOL_SQL
;

	@tools/m2sh/src/lexer.c

37 
	~"cÚfig_fe.h
"

38 
	~"·r£r.h
"

40 
	~<¡dio.h
>

41 
	~<as£¹.h
>

42 
	~<b¡ršg.h
>

43 
	~<dbg.h
>

44 
	~<adt/li¡.h
>

45 
	~<¡dlib.h
>

47 *
P¬£AÎoc
(*(*
m®locProc
)(
size_t
));

48 
P¬£F»e
(*
p
, (*
ä“Proc
)(*));

50 
	`P¬£
(

51 *
yyp
,

52 
yymajÜ
,

53 
Tok’
 *
yymšÜ
,

54 
P¬£rS‹
 *
¡©e


57 
	#TKBASE
(
N
, 
S
, 
E
è
‹mp
 = 
	`Tok’_ü—‹
(
TK
##N, S, ()(E - S));\

58 
	`P¬£
(
·r£r
, 
TK
##
N
, 
‹mp
, &
¡©e
);\

59 if(
¡©e
.
”rÜ
è”rÜ;

	)

61 
	#TK
(
N
è
	`TKBASE
(N, 
ts
, 
‹
)

	)

62 
	#TKSTR
(
N
è
	`TKBASE
(N, 
ts
+1, 
‹
-3)

	)

70 cÚ¡ 
m2sh_Ëx”_¡¬t
 = 8;

71 cÚ¡ 
m2sh_Ëx”_fœ¡_fš®
 = 8;

72 cÚ¡ 
m2sh_Ëx”_”rÜ
 = 0;

74 cÚ¡ 
m2sh_Ëx”_’_maš
 = 8;

79 
	$P¬£_´št_”rÜ
(cÚ¡ *
mes§ge
, 
b¡ršg
 
cÚ‹Á
, 
©
, 
lše_numb”
)

81 
´ev_Æ
 = 
	`b¡¼ch½
(
cÚ‹Á
, '\n', 
©
);

82 
Ãxt_Æ
 = 
	`b¡rch½
(
cÚ‹Á
, '\n', 
©
);

84 if(
´ev_Æ
 < 0) {

85 
	`log_”r
("% AT '%c' oÀlš%d:\n%.*s\n%*s", 
mes§ge
,

86 
	`bch¬
(
cÚ‹Á
, 
©
), 
lše_numb”
-1,

87 
Ãxt_Æ
, 
	`bd©a
(
cÚ‹Á
),

88 
©
, "^");

90 
	`log_”r
("% AT '%c' oÀlš%d:%.*s\n%*s", 
mes§ge
,

91 
	`bch¬
(
cÚ‹Á
, 
©
), 
lše_numb”
,

92 
Ãxt_Æ
 - 
´ev_Æ
, 
	`bd©aofs
(
cÚ‹Á
,…rev_nl),

93 
©
 - 
´ev_Æ
, "^");

95 
	}
}

97 
t¡_t
 *
	$P¬£_cÚfig_¡ršg
(
b¡ršg
 
cÚ‹Á
)

99 
Tok’
 *
‹mp
 = 
NULL
;

100 *
·r£r
 = 
	`P¬£AÎoc
(
m®loc
);

101 
	`check_mem
(
·r£r
);

102 
P¬£rS‹
 
¡©e
 = {.
£‰šgs
 = 
NULL
, .
”rÜ
 = 0, .
lše_numb”
 = 1};

104 *
p
 = 
	`bd©a
(
cÚ‹Á
);

105 *
³
 = 
	`bd©aofs
(
cÚ‹Á
, 
	`bËngth
(content) - 1);

106 *
eof
 = 
³
;

107 
cs
 = -1;

108 
aù
 = -1;

109 *
ts
 = 
NULL
;

110 *
‹
 = 
NULL
;

115 
cs
 = 
m2sh_Ëx”_¡¬t
;

116 
ts
 = 0;

117 
‹
 = 0;

118 
aù
 = 0;

125 iàĞ
p
 =ğ
³
 )

126 
_‹¡_eof
;

127  
cs
 )

129 
Œ1
:

131 {
‹
 = 
p
+1;{ 
	`TKSTR
(
QSTRING
) }}

132 
¡8
;

133 
Œ4
:

135 {
‹
 = 
p
+1;}

136 
¡8
;

137 
Œ9
:

139 {
‹
 = 
p
+1;{ 
	`TKSTR
(
PATTERN
) }}

140 
¡8
;

141 
Œ10
:

143 {
‹
 = 
p
+1;}

144 
¡8
;

145 
Œ12
:

147 {
‹
 = 
p
+1;{ 
¡©e
.
lše_numb”
++; }}

148 
¡8
;

149 
Œ13
:

151 {
‹
 = 
p
+1;{ 
	`TK
(
LPAREN
) }}

152 
¡8
;

153 
Œ14
:

155 {
‹
 = 
p
+1;{ 
	`TK
(
RPAREN
) }}

156 
¡8
;

157 
Œ15
:

159 {
‹
 = 
p
+1;{ 
	`TK
(
COMMA
) }}

160 
¡8
;

161 
Œ17
:

163 {
‹
 = 
p
+1;{ 
	`TK
(
COLON
) }}

164 
¡8
;

165 
Œ18
:

167 {
‹
 = 
p
+1;{ 
	`TK
(
EQ
) }}

168 
¡8
;

169 
Œ20
:

171 {
‹
 = 
p
+1;{ 
	`TK
(
LBRACE
) }}

172 
¡8
;

173 
Œ21
:

175 {
‹
 = 
p
+1;{ 
	`TK
(
RBRACE
) }}

176 
¡8
;

177 
Œ23
:

179 {
‹
 = 
p
+1;{ 
	`TK
(
LBRACKET
) }}

180 
¡8
;

181 
Œ24
:

183 {
‹
 = 
p
+1;{ 
	`TK
(
RBRACKET
) }}

184 
¡8
;

185 
Œ25
:

187 {
‹
 = 
p
;p--;{ 
	`TK
(
NUMBER
) }}

188 
¡8
;

189 
Œ26
:

191 {  
aù
 ) {

193 {{
p
 = ((
‹
))-1;} 
	`TK
(
CLASS
) }

196 {{
p
 = ((
‹
))-1;} 
	`TK
(
IDENT
) }

200 
¡8
;

201 
Œ28
:

203 {
‹
 = 
p
;p--;{ 
	`TK
(
IDENT
) }}

204 
¡8
;

205 
¡8
:

207 {
ts
 = 0;}

208 iàĞ++
p
 =ğ
³
 )

209 
_‹¡_eof8
;

212 {
ts
 = 
p
;}

214  (*
p
) ) {

215 10: 
Œ12
;

216 32: 
Œ10
;

217 34: 
¡1
;

218 35: 
¡3
;

219 39: 
¡4
;

220 40: 
Œ13
;

221 41: 
Œ14
;

222 44: 
Œ15
;

223 58: 
Œ17
;

224 61: 
Œ18
;

225 91: 
Œ20
;

226 93: 
Œ21
;

227 96: 
¡6
;

228 123: 
Œ23
;

229 125: 
Œ24
;

231 iàĞ(*
p
) < 48 ) {

232 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

233 
Œ10
;

234 } iàĞ(*
p
) > 57 ) {

235 iàĞ(*
p
) > 90 ) {

236 iàĞ95 <ğ(*
p
) && (*p) <= 122 )

237 
¡11
;

238 } iàĞ(*
p
) >= 65 )

239 
Œ19
;

241 
¡9
;

242 
¡0
;

243 
¡0
:

244 
cs
 = 0;

245 
_out
;

246 
¡1
:

247 iàĞ++
p
 =ğ
³
 )

248 
_‹¡_eof1
;

250  (*
p
) ) {

251 34: 
Œ1
;

252 92: 
¡2
;

254 
¡1
;

255 
¡2
:

256 iàĞ++
p
 =ğ
³
 )

257 
_‹¡_eof2
;

259 
¡1
;

260 
¡3
:

261 iàĞ++
p
 =ğ
³
 )

262 
_‹¡_eof3
;

264 iàĞ(*
p
) == 10 )

265 
Œ4
;

266 
¡3
;

267 
¡4
:

268 iàĞ++
p
 =ğ
³
 )

269 
_‹¡_eof4
;

271  (*
p
) ) {

272 39: 
Œ1
;

273 92: 
¡5
;

275 
¡4
;

276 
¡5
:

277 iàĞ++
p
 =ğ
³
 )

278 
_‹¡_eof5
;

280 
¡4
;

281 
¡9
:

282 iàĞ++
p
 =ğ
³
 )

283 
_‹¡_eof9
;

285 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

286 
¡9
;

287 
Œ25
;

288 
Œ19
:

290 {
‹
 = 
p
+1;}

292 {
aù
 = 17;}

293 
¡10
;

294 
Œ27
:

296 {
‹
 = 
p
+1;}

298 {
aù
 = 16;}

299 
¡10
;

300 
¡10
:

301 iàĞ++
p
 =ğ
³
 )

302 
_‹¡_eof10
;

305 iàĞ(*
p
) == 95 )

306 
¡11
;

307 iàĞ(*
p
) < 65 ) {

308 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

309 
¡11
;

310 } iàĞ(*
p
) > 90 ) {

311 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

312 
Œ27
;

314 
Œ27
;

315 
Œ26
;

316 
¡11
:

317 iàĞ++
p
 =ğ
³
 )

318 
_‹¡_eof11
;

320 iàĞ(*
p
) == 95 )

321 
¡11
;

322 iàĞ(*
p
) < 65 ) {

323 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

324 
¡11
;

325 } iàĞ(*
p
) > 90 ) {

326 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

327 
¡11
;

329 
¡11
;

330 
Œ28
;

331 
¡6
:

332 iàĞ++
p
 =ğ
³
 )

333 
_‹¡_eof6
;

335  (*
p
) ) {

336 92: 
¡7
;

337 96: 
Œ9
;

339 
¡6
;

340 
¡7
:

341 iàĞ++
p
 =ğ
³
 )

342 
_‹¡_eof7
;

344 
¡6
;

346 
_‹¡_eof8
: 
cs
 = 8; 
_‹¡_eof
;

347 
_‹¡_eof1
: 
cs
 = 1; 
_‹¡_eof
;

348 
_‹¡_eof2
: 
cs
 = 2; 
_‹¡_eof
;

349 
_‹¡_eof3
: 
cs
 = 3; 
_‹¡_eof
;

350 
_‹¡_eof4
: 
cs
 = 4; 
_‹¡_eof
;

351 
_‹¡_eof5
: 
cs
 = 5; 
_‹¡_eof
;

352 
_‹¡_eof9
: 
cs
 = 9; 
_‹¡_eof
;

353 
_‹¡_eof10
: 
cs
 = 10; 
_‹¡_eof
;

354 
_‹¡_eof11
: 
cs
 = 11; 
_‹¡_eof
;

355 
_‹¡_eof6
: 
cs
 = 6; 
_‹¡_eof
;

356 
_‹¡_eof7
: 
cs
 = 7; 
_‹¡_eof
;

358 
_‹¡_eof
: {}

359 iàĞ
p
 =ğ
eof
 )

361  
cs
 ) {

362 9: 
Œ25
;

363 10: 
Œ26
;

364 11: 
Œ28
;

368 
_out
: {}

374 if(
¡©e
.
”rÜ
) {

375 
	`P¬£_´št_”rÜ
("SYNTAX ERROR", 
cÚ‹Á
,

376 ()(
ts
 - 
	`bd©a
(
cÚ‹Á
)), ++
¡©e
.
lše_numb”
);

377 } ifĞ
cs
 ==

382 
	`P¬£_´št_”rÜ
("INVALID CHARACTER", 
cÚ‹Á
,

383 ()(
ts
 - 
	`bd©a
(
cÚ‹Á
)), ++
¡©e
.
lše_numb”
);

384 } ifĞ
cs
 >=

389 
	`P¬£
(
·r£r
, 
TKEOF
, 
NULL
, &
¡©e
);

391 
	`log_”r
("INCOMPLETE CONFIG FILE. There‚eedso be moreohis.");

394 
	`P¬£
(
·r£r
, 0, 0, &
¡©e
);

395 
	`P¬£F»e
(
·r£r
, 
ä“
);

397  
¡©e
.
£‰šgs
;

399 
”rÜ
:

400 if(
¡©e
.
”rÜ
) {

401 
	`P¬£_´št_”rÜ
("SYNTAX ERROR", 
cÚ‹Á
,

402 ()(
ts
 - 
	`bd©a
(
cÚ‹Á
)), ++
¡©e
.
lše_numb”
);

404 
	`P¬£F»e
(
·r£r
, 
ä“
);

405  
NULL
;

406 
	}
}

409 
t¡_t
 *
	$P¬£_cÚfig_fe
(cÚ¡ *
·th
)

411 
FILE
 *
süt
;

412 
b¡ršg
 
bufãr
 = 
NULL
;

413 
t¡_t
 *
£‰šgs
 = 
NULL
;

415 
süt
 = 
	`fİ’
(
·th
, "r");

416 
	`check
(
süt
, "FaedØİ’ fe: %s", 
·th
);

418 
bufãr
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
süt
);

419 
	`check_mem
(
bufãr
);

421 
	`fşo£
(
süt
); süˆğ
NULL
;

424 
	`bcÚch¬
(
bufãr
, '\n');

426 
£‰šgs
 = 
	`P¬£_cÚfig_¡ršg
(
bufãr
);

427 
	`check
(
£‰šgs
 !ğ
NULL
, "FaedØ·r£ fe: %s", 
·th
);

429 
	`bde¡roy
(
bufãr
);

430 
bufãr
 = 
NULL
;

432  
£‰šgs
;

434 
”rÜ
:

435 
	`bde¡roy
(
bufãr
);

436 if(
süt
è
	`fşo£
(script);

437  
NULL
;

438 
	}
}

	@tools/m2sh/src/linenoise.c

72 
	~<‹rmios.h
>

73 
	~<uni¡d.h
>

74 
	~<¡dlib.h
>

75 
	~<¡dio.h
>

76 
	~<”ºo.h
>

77 
	~<¡ršg.h
>

78 
	~<¡dlib.h
>

79 
	~<sys/ty³s.h
>

80 
	~<sys/ioùl.h
>

81 
	~<uni¡d.h
>

83 
	#LINENOISE_DEFAULT_HISTORY_MAX_LEN
 100

	)

84 
	#LINENOISE_MAX_LINE
 4096

	)

85 *
	gunsuµÜ‹d_‹rm
[] = {"dumb","cÚs25",
NULL
};

87 
‹rmios
 
	gÜig_‹rmios
;

88 
	g¿wmode
 = 0;

89 
	g©ex™_»gi¡”ed
 = 0;

90 
	ghi¡Üy_max_Ën
 = 
LINENOISE_DEFAULT_HISTORY_MAX_LEN
;

91 
	ghi¡Üy_Ën
 = 0;

92 **
	ghi¡Üy
 = 
NULL
;

94 
lš’oi£AtEx™
();

95 
lš’oi£Hi¡ÜyAdd
(cÚ¡ *
lše
);

97 
	$isUnsuµÜ‹dT”m
() {

98 *
‹rm
 = 
	`g‘’v
("TERM");

99 
j
;

101 ià(
‹rm
 =ğ
NULL
)  0;

102 
j
 = 0; 
unsuµÜ‹d_‹rm
[j]; j++)

103 ià(!
	`¡rÿ£cmp
(
‹rm
,
unsuµÜ‹d_‹rm
[
j
]))  1;

105 
	}
}

107 
	$ä“Hi¡Üy
() {

108 ià(
hi¡Üy
) {

109 
j
;

111 
j
 = 0; j < 
hi¡Üy_Ën
; j++)

112 
	`ä“
(
hi¡Üy
[
j
]);

113 
	`ä“
(
hi¡Üy
);

115 
	}
}

117 
	$’abËRawMode
(
fd
) {

118 
‹rmios
 
¿w
;

120 ià(!
	`i§‰y
(
STDIN_FILENO
)è
çl
;

121 ià(!
©ex™_»gi¡”ed
) {

122 
	`©ex™
(
lš’oi£AtEx™
);

123 
©ex™_»gi¡”ed
 = 1;

125 ià(
	`tcg‘©Œ
(
fd
,&
Üig_‹rmios
è=ğ-1è
çl
;

127 
¿w
 = 
Üig_‹rmios
;

130 
¿w
.
c_iæag
 &ğ~(
BRKINT
 | 
ICRNL
 | 
INPCK
 | 
ISTRIP
 | 
IXON
);

132 
¿w
.
c_oæag
 &ğ~(
OPOST
);

134 
¿w
.
c_cæag
 |ğ(
CS8
);

137 
¿w
.
c_læag
 &ğ~(
ECHO
 | 
ICANON
 | 
IEXTEN
 | 
ISIG
);

140 
¿w
.
c_cc
[
VMIN
] = 1;„aw.c_cc[
VTIME
] = 0;

143 ià(
	`tc£‰r
(
fd
,
TCSAFLUSH
,&
¿w
è< 0è
çl
;

144 
¿wmode
 = 1;

147 
çl
:

148 
”ºo
 = 
ENOTTY
;

150 
	}
}

152 
	$di§bËRawMode
(
fd
) {

154 ià(
¿wmode
 && 
	`tc£‰r
(
fd
,
TCSAFLUSH
,&
Üig_‹rmios
) != -1)

155 
¿wmode
 = 0;

156 
	}
}

159 
	$lš’oi£AtEx™
() {

160 
	`di§bËRawMode
(
STDIN_FILENO
);

161 
	`ä“Hi¡Üy
();

162 
	}
}

164 
	$g‘CŞumns
() {

165 
wšsize
 
ws
;

167 ià(
	`ioùl
(1, 
TIOCGWINSZ
, &
ws
) == -1)  80;

168  
ws
.
ws_cŞ
;

169 
	}
}

171 
	$»äeshLše
(
fd
, cÚ¡ *
´om±
, *
buf
, 
size_t
 
Ën
, size_ˆ
pos
, size_ˆ
cŞs
) {

172 
£q
[64];

173 
size_t
 
¶’
 = 
	`¡¾’
(
´om±
);

175 (
¶’
+
pos
è>ğ
cŞs
) {

176 
buf
++;

177 
Ën
--;

178 
pos
--;

180 
¶’
+
Ën
 > 
cŞs
) {

181 
Ën
--;

185 
	`¢´štf
(
£q
,64,"\x1b[0G");

186 ià(
	`wr™e
(
fd
,
£q
,
	`¡¾’
(seq)) == -1) ;

188 ià(
	`wr™e
(
fd
,
´om±
,
	`¡¾’
(prompt)) == -1) ;

189 ià(
	`wr™e
(
fd
,
buf
,
Ën
) == -1) ;

191 
	`¢´štf
(
£q
,64,"\x1b[0K");

192 ià(
	`wr™e
(
fd
,
£q
,
	`¡¾’
(seq)) == -1) ;

194 
	`¢´štf
(
£q
,64,"\x1b[0G\x1b[%dC", ()(
pos
+
¶’
));

195 ià(
	`wr™e
(
fd
,
£q
,
	`¡¾’
(seq)) == -1) ;

196 
	}
}

198 
	$lš’oi£Prom±
(
fd
, *
buf
, 
size_t
 
buæ’
, cÚ¡ *
´om±
) {

199 
size_t
 
¶’
 = 
	`¡¾’
(
´om±
);

200 
size_t
 
pos
 = 0;

201 
size_t
 
Ën
 = 0;

202 
size_t
 
cŞs
 = 
	`g‘CŞumns
();

203 
hi¡Üy_šdex
 = 0;

205 
buf
[0] = '\0';

206 
buæ’
--;

210 
	`lš’oi£Hi¡ÜyAdd
("");

212 ià(
	`wr™e
(
fd
,
´om±
,
¶’
) == -1)  -1;

214 
c
;

215 
Ä—d
;

216 
£q
[2];

218 
Ä—d
 = 
	`»ad
(
fd
,&
c
,1);

219 ià(
Ä—d
 <ğ0è 
Ën
;

220 
c
) {

223 
hi¡Üy_Ën
--;

224 
	`ä“
(
hi¡Üy
[
hi¡Üy_Ën
]);

225  (
Ën
 =ğ0 && 
c
 == 4) ? -1 : ()len;

227 
”ºo
 = 
EAGAIN
;

231 ià(
pos
 > 0 && 
Ën
 > 0) {

232 
	`memmove
(
buf
+
pos
-1,buf+pos,
Ën
-pos);

233 
pos
--;

234 
Ën
--;

235 
buf
[
Ën
] = '\0';

236 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

240 ià(
pos
 > 0 &&…o < 
Ën
) {

241 
aux
 = 
buf
[
pos
-1];

242 
buf
[
pos
-1] = buf[pos];

243 
buf
[
pos
] = 
aux
;

244 ià(
pos
 !ğ
Ën
-1)…os++;

245 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

249 
Ëá_¬row
;

251 
right_¬row
;

253 
£q
[1] = 65;

254 
up_down_¬row
;

256 
£q
[1] = 66;

257 
up_down_¬row
;

260 ià(
	`»ad
(
fd
,
£q
,2) == -1) ;

261 ià(
£q
[0] == 91 && seq[1] == 68) {

262 
Ëá_¬row
:

264 ià(
pos
 > 0) {

265 
pos
--;

266 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

268 } ià(
£q
[0] == 91 && seq[1] == 67) {

269 
right_¬row
:

271 ià(
pos
 !ğ
Ën
) {

272 
pos
++;

273 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

275 } ià(
£q
[0] == 91 && (seq[1] == 65 || seq[1] == 66)) {

276 
up_down_¬row
:

278 ià(
hi¡Üy_Ën
 > 1) {

281 
	`ä“
(
hi¡Üy
[
hi¡Üy_Ën
-1-
hi¡Üy_šdex
]);

282 
hi¡Üy
[
hi¡Üy_Ën
-1-
hi¡Üy_šdex
] = 
	`¡rdup
(
buf
);

284 
hi¡Üy_šdex
 +ğ(
£q
[1] == 65) ? 1 : -1;

285 ià(
hi¡Üy_šdex
 < 0) {

286 
hi¡Üy_šdex
 = 0;

288 } ià(
hi¡Üy_šdex
 >ğ
hi¡Üy_Ën
) {

289 
hi¡Üy_šdex
 = 
hi¡Üy_Ën
-1;

292 
	`¡ºıy
(
buf
,
hi¡Üy
[
hi¡Üy_Ën
-1-
hi¡Üy_šdex
],
buæ’
);

293 
buf
[
buæ’
] = '\0';

294 
Ën
 = 
pos
 = 
	`¡¾’
(
buf
);

295 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

300 ià(
Ën
 < 
buæ’
) {

301 ià(
Ën
 =ğ
pos
) {

302 
buf
[
pos
] = 
c
;

303 
pos
++;

304 
Ën
++;

305 
buf
[
Ën
] = '\0';

306 ià(
¶’
+
Ën
 < 
cŞs
) {

309 ià(
	`wr™e
(
fd
,&
c
,1) == -1)  -1;

311 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

314 
	`memmove
(
buf
+
pos
+1,buf+pos,
Ën
-pos);

315 
buf
[
pos
] = 
c
;

316 
Ën
++;

317 
pos
++;

318 
buf
[
Ën
] = '\0';

319 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

324 
buf
[0] = '\0';

325 
pos
 = 
Ën
 = 0;

326 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

329 
buf
[
pos
] = '\0';

330 
Ën
 = 
pos
;

331 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

334 
pos
 = 0;

335 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

338 
pos
 = 
Ën
;

339 
	`»äeshLše
(
fd
,
´om±
,
buf
,
Ën
,
pos
,
cŞs
);

343  
Ën
;

344 
	}
}

346 
	$lš’oi£Raw
(*
buf
, 
size_t
 
buæ’
, cÚ¡ *
´om±
) {

347 
fd
 = 
STDIN_FILENO
;

348 
couÁ
;

350 ià(
buæ’
 == 0) {

351 
”ºo
 = 
EINVAL
;

354 ià(!
	`i§‰y
(
STDIN_FILENO
)) {

355 ià(
	`fg‘s
(
buf
, 
buæ’
, 
¡dš
è=ğ
NULL
)  -1;

356 
couÁ
 = 
	`¡¾’
(
buf
);

357 ià(
couÁ
 && 
buf
[count-1] == '\n') {

358 
couÁ
--;

359 
buf
[
couÁ
] = '\0';

362 ià(
	`’abËRawMode
(
fd
) == -1)  -1;

363 
couÁ
 = 
	`lš’oi£Prom±
(
fd
, 
buf
, 
buæ’
, 
´om±
);

364 
	`di§bËRawMode
(
fd
);

365 
	`´štf
("\n");

367  
couÁ
;

368 
	}
}

370 *
	$lš’oi£
(cÚ¡ *
´om±
) {

371 
buf
[
LINENOISE_MAX_LINE
];

372 
couÁ
;

374 ià(
	`isUnsuµÜ‹dT”m
()) {

375 
size_t
 
Ën
;

377 
	`´štf
("%s",
´om±
);

378 
	`fæush
(
¡dout
);

379 ià(
	`fg‘s
(
buf
,
LINENOISE_MAX_LINE
,
¡dš
è=ğ
NULL
)  NULL;

380 
Ën
 = 
	`¡¾’
(
buf
);

381 
Ën
 && (
buf
[len-1] == '\n' || buf[len-1] == '\r')) {

382 
Ën
--;

383 
buf
[
Ën
] = '\0';

385  
	`¡rdup
(
buf
);

387 
couÁ
 = 
	`lš’oi£Raw
(
buf
,
LINENOISE_MAX_LINE
,
´om±
);

388 ià(
couÁ
 =ğ-1è 
NULL
;

389  
	`¡rdup
(
buf
);

391 
	}
}

394 
	$lš’oi£Hi¡ÜyAdd
(cÚ¡ *
lše
) {

395 *
lšecİy
;

397 ià(
hi¡Üy_max_Ën
 == 0)  0;

398 ià(
hi¡Üy
 =ğ
NULL
) {

399 
hi¡Üy
 = 
	`m®loc
((*)*
hi¡Üy_max_Ën
);

400 ià(
hi¡Üy
 =ğ
NULL
)  0;

401 
	`mem£t
(
hi¡Üy
,0,((*)*
hi¡Üy_max_Ën
));

403 
lšecİy
 = 
	`¡rdup
(
lše
);

404 ià(!
lšecİy
)  0;

405 ià(
hi¡Üy_Ën
 =ğ
hi¡Üy_max_Ën
) {

406 
	`ä“
(
hi¡Üy
[0]);

407 
	`memmove
(
hi¡Üy
,hi¡Üy+1,(*)*(
hi¡Üy_max_Ën
-1));

408 
hi¡Üy_Ën
--;

410 
hi¡Üy
[
hi¡Üy_Ën
] = 
lšecİy
;

411 
hi¡Üy_Ën
++;

413 
	}
}

415 
	$lš’oi£Hi¡ÜyS‘MaxL’
(
Ën
) {

416 **
Ãw
;

418 ià(
Ën
 < 1)  0;

419 ià(
hi¡Üy
) {

420 
tocİy
 = 
hi¡Üy_Ën
;

422 
Ãw
 = 
	`m®loc
((*)*
Ën
);

423 ià(
Ãw
 =ğ
NULL
)  0;

424 ià(
Ën
 < 
tocİy
)ocopy =†en;

425 
	`memıy
(
Ãw
,
hi¡Üy
+(
hi¡Üy_max_Ën
-
tocİy
), (*)*tocopy);

426 
	`ä“
(
hi¡Üy
);

427 
hi¡Üy
 = 
Ãw
;

429 
hi¡Üy_max_Ën
 = 
Ën
;

430 ià(
hi¡Üy_Ën
 > 
hi¡Üy_max_Ën
)

431 
hi¡Üy_Ën
 = 
hi¡Üy_max_Ën
;

433 
	}
}

437 
	$lš’oi£Hi¡ÜySave
(*
f’ame
) {

438 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"w");

439 
j
;

441 ià(
å
 =ğ
NULL
)  -1;

442 
j
 = 0; j < 
hi¡Üy_Ën
; j++)

443 
	`årštf
(
å
,"%s\n",
hi¡Üy
[
j
]);

444 
	`fşo£
(
å
);

446 
	}
}

453 
	$lš’oi£Hi¡ÜyLßd
(*
f’ame
) {

454 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

455 
buf
[
LINENOISE_MAX_LINE
];

457 ià(
å
 =ğ
NULL
)  -1;

459 
	`fg‘s
(
buf
,
LINENOISE_MAX_LINE
,
å
è!ğ
NULL
) {

460 *
p
;

462 
p
 = 
	`¡rchr
(
buf
,'\r');

463 ià(!
p
è°ğ
	`¡rchr
(
buf
,'\n');

464 ià(
p
) *p = '\0';

465 
	`lš’oi£Hi¡ÜyAdd
(
buf
);

467 
	`fşo£
(
å
);

469 
	}
}

	@tools/m2sh/src/linenoise.h

34 #iâdeà
__LINENOISE_H


35 
	#__LINENOISE_H


	)

37 *
lš’oi£
(cÚ¡ *
´om±
);

38 
lš’oi£Hi¡ÜyAdd
(cÚ¡ *
lše
);

39 
lš’oi£Hi¡ÜyS‘MaxL’
(
Ën
);

40 
lš’oi£Hi¡ÜySave
(*
f’ame
);

41 
lš’oi£Hi¡ÜyLßd
(*
f’ame
);

	@tools/m2sh/src/m2sh.c

35 
	~<dbg.h
>

36 
	~<sk/sk.h
>

37 
	~<·‰”n.h
>

38 
	~"commªds.h
"

41 
	$skmaš
(
¬gc
, *
¬gv
[])

43 
	`dbg_£t_log
(
¡d”r
);

44 
i
 = 0;

46 
b¡ršg
 
¬gum’ts
 = 
	`bäomc¡r
(
¬gv
[0]);

48 
i
 = 1; i < 
¬gc
; i++) {

49 
b¡ršg
 
a
 = 
	`bäomc¡r
(
¬gv
[
i
]);

53 if(
	`b¡rchr
(
a
, ' ') != -1) {

54 
	`bÿtc¡r
(
¬gum’ts
, " \"");

55 
	`bcÚÿt
(
¬gum’ts
, 
a
);

56 
	`bÿtc¡r
(
¬gum’ts
, "\"");

58 
	`bÿtc¡r
(
¬gum’ts
, " ");

59 
	`bcÚÿt
(
¬gum’ts
, 
a
);

62 
	`bde¡roy
(
a
);

65 
	`debug
("RUNNING: %s", 
	`bd©a
(
¬gum’ts
));

66 
	`skex™®l
(
	`Commªd_run
(
¬gum’ts
));

67 
	}
}

	@tools/m2sh/src/parser.c

6 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<dbg.h
>

13 
	~"a¡.h
"

14 
	~<sk/sk.h
>

16 
	#as£¹
(
S
èif(!(S)è{ 
	`log_”r
("PARSER ASSERT FAILED: " #S); 
	`skex™®l
(-1); }

	)

31 #iâdeà
INTERFACE


32 
	#INTERFACE
 1

	)

68 
	#YYCODETYPE
 

	)

69 
	#YYNOCODE
 29

	)

70 
	#YYACTIONTYPE
 

	)

71 
	#P¬£TOKENTYPE
 
Tok’
*

	)

73 
	myyš™
;

74 
P¬£TOKENTYPE
 
	myy0
;

75 
t¡_t
 * 
	myy9
;

76 
li¡_t
 * 
	myy18
;

77 
Paœ
* 
	myy27
;

78 
CÏss
 * 
	myy29
;

79 
Paœ
 * 
	myy35
;

80 
V®ue
 * 
	myy48
;

81 } 
	tYYMINORTYPE
;

82 #iâdeà
YYSTACKDEPTH


83 
	#YYSTACKDEPTH
 100

	)

85 
	#P¬£ARG_SDECL
 
P¬£rS‹
 *
¡©e
;

	)

86 
	#P¬£ARG_PDECL
 ,
P¬£rS‹
 *
¡©e


	)

87 
	#P¬£ARG_FETCH
 
P¬£rS‹
 *
¡©e
 = 
yypP¬£r
->
	)
state

88 
	#P¬£ARG_STORE
 
yypP¬£r
->
¡©e
 = 
	)
state

89 
	#YYNSTATE
 40

	)

90 
	#YYNRULE
 26

	)

91 
	#YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

	)

92 
	#YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

	)

93 
	#YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

	)

97 cÚ¡ 
YYMINORTYPE
 
	gyyz”omšÜ
 = { 0 };

107 #iâdeà
yy‹¡ÿ£


108 
	#yy‹¡ÿ£
(
X
)

	)

159 cÚ¡ 
YYACTIONTYPE
 
	gyy_aùiÚ
[] = {

168 cÚ¡ 
YYCODETYPE
 
	gyy_lookah—d
[] = {

177 
	#YY_SHIFT_USE_DFLT
 (-3)

	)

178 
	#YY_SHIFT_MAX
 17

	)

179 cÚ¡ sigÃd 
	gyy_shiá_of¡
[] = {

183 
	#YY_REDUCE_USE_DFLT
 (-22)

	)

184 
	#YY_REDUCE_MAX
 13

	)

185 cÚ¡ sigÃd 
	gyy_»duû_of¡
[] = {

189 cÚ¡ 
YYACTIONTYPE
 
	gyy_deçuÉ
[] = {

195 
	#YY_SZ_ACTTAB
 ()((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

207 #ifdeà
YYFALLBACK


208 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

224 
	syySckEÁry
 {

225 
YYACTIONTYPE
 
	m¡©’o
;

226 
YYCODETYPE
 
	mmajÜ
;

228 
YYMINORTYPE
 
	mmšÜ
;

231 
yySckEÁry
 
	tyySckEÁry
;

235 
	syyP¬£r
 {

236 
	myyidx
;

237 #ifdeà
YYTRACKMAXSTACKDEPTH


238 
	myyidxMax
;

240 
	myy”rút
;

241 
	mP¬£ARG_SDECL


242 #ià
YYSTACKDEPTH
<=0

243 
	myy¡ksz
;

244 
yySckEÁry
 *
	myy¡ack
;

246 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

249 
yyP¬£r
 
	tyyP¬£r
;

251 #iâdeà
NDEBUG


252 
	~<¡dio.h
>

253 
FILE
 *
	gyyT¿ûFILE
 = 0;

254 *
	gyyT¿ûProm±
 = 0;

257 #iâdeà
NDEBUG


275 
	$P¬£T¿û
(
FILE
 *
T¿ûFILE
, *
zT¿ûProm±
){

276 
yyT¿ûFILE
 = 
T¿ûFILE
;

277 
yyT¿ûProm±
 = 
zT¿ûProm±
;

278 ifĞ
yyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

279 ifĞ
yyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

280 
	}
}

283 #iâdeà
NDEBUG


286 cÚ¡ *cÚ¡ 
	gyyTok’Name
[] = {

297 #iâdeà
NDEBUG


300 cÚ¡ *cÚ¡ 
	gyyRuËName
[] = {

331 #ià
YYSTACKDEPTH
<=0

335 
	$yyGrowSck
(
yyP¬£r
 *
p
){

336 
ÃwSize
;

337 
yySckEÁry
 *
pNew
;

339 
ÃwSize
 = 
p
->
yy¡ksz
*2 + 100;

340 
pNew
 = 
	`»®loc
(
p
->
yy¡ack
, 
ÃwSize
*(pNew[0]));

341 ifĞ
pNew
 ){

342 
p
->
yy¡ack
 = 
pNew
;

343 
p
->
yy¡ksz
 = 
ÃwSize
;

344 #iâdeà
NDEBUG


345 ifĞ
yyT¿ûFILE
 ){

346 
	`årštf
(
yyT¿ûFILE
,"%sStack growso %dƒntries!\n",

347 
yyT¿ûProm±
, 
p
->
yy¡ksz
);

351 
	}
}

366 *
P¬£AÎoc
(*(*
m®locProc
)(
size_t
)){

367 
yyP¬£r
 *
	gpP¬£r
;

368 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

369 ifĞ
	gpP¬£r
 ){

370 
	gpP¬£r
->
	gyyidx
 = -1;

371 #ifdeà
YYTRACKMAXSTACKDEPTH


372 
	gpP¬£r
->
	gyyidxMax
 = 0;

374 #ià
YYSTACKDEPTH
<=0

375 
	gpP¬£r
->
	gyy¡ack
 = 
NULL
;

376 
	gpP¬£r
->
	gyy¡ksz
 = 0;

377 
yyGrowSck
(
pP¬£r
);

380  
	gpP¬£r
;

388 
	$yy_de¡ruùÜ
(

389 
yyP¬£r
 *
yypP¬£r
,

390 
YYCODETYPE
 
yymajÜ
,

391 
YYMINORTYPE
 *
yypmšÜ


393 
P¬£ARG_FETCH
;

394  
yymajÜ
 ){

423 
	`Tok’_de¡roy
((
yypmšÜ
->
yy0
));

430 
	`ä“
((
yypmšÜ
->
yy35
));

437 
	`AST_de¡roy
((
yypmšÜ
->
yy9
));

444 
	`ä“
((
yypmšÜ
->
yy27
));

450 
	}
}

460 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

461 
YYCODETYPE
 
yymajÜ
;

462 
yySckEÁry
 *
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

464 ifĞ
pP¬£r
->
yyidx
<0 )  0;

465 #iâdeà
NDEBUG


466 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

467 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

468 
yyT¿ûProm±
,

469 
yyTok’Name
[
yytos
->
majÜ
]);

472 
yymajÜ
 = 
yytos
->
majÜ
;

473 
	`yy_de¡ruùÜ
(
pP¬£r
, 
yymajÜ
, &
yytos
->
mšÜ
);

474 
pP¬£r
->
yyidx
--;

475  
yymajÜ
;

476 
	}
}

490 
P¬£F»e
(

491 *
p
,

492 (*
ä“Proc
)(*)

494 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

495 ifĞ
pP¬£r
==0 ) ;

496  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

497 #ià
YYSTACKDEPTH
<=0

498 
	`ä“
(
pP¬£r
->
yy¡ack
);

500 (*
ä“Proc
)((*)
pP¬£r
);

501 
	}
}

506 #ifdeà
YYTRACKMAXSTACKDEPTH


507 
	$P¬£SckP—k
(*
p
){

508 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

509  
pP¬£r
->
yyidxMax
;

510 
	}
}

521 
	$yy_fšd_shiá_aùiÚ
(

522 
yyP¬£r
 *
pP¬£r
,

523 
YYCODETYPE
 
iLookAh—d


525 
i
;

526 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

528 ifĞ
¡©’o
>
YY_SHIFT_MAX
 || (
i
 = 
yy_shiá_of¡
[¡©’o])==
YY_SHIFT_USE_DFLT
 ){

529  
yy_deçuÉ
[
¡©’o
];

531 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

532 
i
 +ğ
iLookAh—d
;

533 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

534 ifĞ
iLookAh—d
>0 ){

535 #ifdeà
YYFALLBACK


536 
YYCODETYPE
 
iF®lback
;

537 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

538 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

539 #iâdeà
NDEBUG


540 ifĞ
yyT¿ûFILE
 ){

541 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

542 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

545  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

548 #ifdeà
YYWILDCARD


550 
j
 = 
i
 - 
iLookAh—d
 + 
YYWILDCARD
;

551 ifĞ
j
>=0 && j<
YY_SZ_ACTTAB
 && 
yy_lookah—d
[j]==
YYWILDCARD
 ){

552 #iâdeà
NDEBUG


553 ifĞ
yyT¿ûFILE
 ){

554 
	`årštf
(
yyT¿ûFILE
, "%sWILDCARD %s => %s\n",

555 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
YYWILDCARD
]);

558  
yy_aùiÚ
[
j
];

563  
yy_deçuÉ
[
¡©’o
];

565  
yy_aùiÚ
[
i
];

567 
	}
}

577 
	$yy_fšd_»duû_aùiÚ
(

578 
¡©’o
,

579 
YYCODETYPE
 
iLookAh—d


581 
i
;

582 #ifdeà
YYERRORSYMBOL


583 ifĞ
¡©’o
>
YY_REDUCE_MAX
 ){

584  
yy_deçuÉ
[
¡©’o
];

587 
	`as£¹
Ğ
¡©’o
<=
YY_REDUCE_MAX
 );

589 
i
 = 
yy_»duû_of¡
[
¡©’o
];

590 
	`as£¹
Ğ
i
!=
YY_REDUCE_USE_DFLT
 );

591 
	`as£¹
Ğ
iLookAh—d
!=
YYNOCODE
 );

592 
i
 +ğ
iLookAh—d
;

593 #ifdeà
YYERRORSYMBOL


594 ifĞ
i
<0 || i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

595  
yy_deçuÉ
[
¡©’o
];

598 
	`as£¹
Ğ
i
>=0 && i<
YY_SZ_ACTTAB
 );

599 
	`as£¹
Ğ
yy_lookah—d
[
i
]==
iLookAh—d
 );

601  
yy_aùiÚ
[
i
];

602 
	}
}

607 
	$yySckOv”æow
(
yyP¬£r
 *
yypP¬£r
, 
YYMINORTYPE
 *
yypMšÜ
){

608 
P¬£ARG_FETCH
;

609 
yypP¬£r
->
yyidx
--;

610 #iâdeà
NDEBUG


611 ifĞ
yyT¿ûFILE
 ){

612 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

615  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

620 
	`log_”r
("Th”wa ¨¡ack ov”æow‡ˆlše: %d", 
¡©e
->
lše_numb”
);

622 
P¬£ARG_STORE
;

623 
	}
}

628 
	$yy_shiá
(

629 
yyP¬£r
 *
yypP¬£r
,

630 
yyNewS‹
,

631 
yyMajÜ
,

632 
YYMINORTYPE
 *
yypMšÜ


634 
yySckEÁry
 *
yytos
;

635 
yypP¬£r
->
yyidx
++;

636 #ifdeà
YYTRACKMAXSTACKDEPTH


637 ifĞ
yypP¬£r
->
yyidx
>yypP¬£r->
yyidxMax
 ){

638 
yypP¬£r
->
yyidxMax
 = yypP¬£r->
yyidx
;

641 #ià
YYSTACKDEPTH
>0

642 ifĞ
yypP¬£r
->
yyidx
>=
YYSTACKDEPTH
 ){

643 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

647 ifĞ
yypP¬£r
->
yyidx
>=yypP¬£r->
yy¡ksz
 ){

648 
	`yyGrowSck
(
yypP¬£r
);

649 ifĞ
yypP¬£r
->
yyidx
>=yypP¬£r->
yy¡ksz
 ){

650 
	`yySckOv”æow
(
yypP¬£r
, 
yypMšÜ
);

655 
yytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

656 
yytos
->
¡©’o
 = (
YYACTIONTYPE
)
yyNewS‹
;

657 
yytos
->
majÜ
 = (
YYCODETYPE
)
yyMajÜ
;

658 
yytos
->
mšÜ
 = *
yypMšÜ
;

659 #iâdeà
NDEBUG


660 ifĞ
yyT¿ûFILE
 && 
yypP¬£r
->
yyidx
>0 ){

661 
i
;

662 
	`årštf
(
yyT¿ûFILE
,"%sShiá %d\n",
yyT¿ûProm±
,
yyNewS‹
);

663 
	`årštf
(
yyT¿ûFILE
,"%sSck:",
yyT¿ûProm±
);

664 
i
=1; i<=
yypP¬£r
->
yyidx
; i++)

665 
	`årštf
(
yyT¿ûFILE
," %s",
yyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
majÜ
]);

666 
	`årštf
(
yyT¿ûFILE
,"\n");

669 
	}
}

675 
YYCODETYPE
 
	mlhs
;

676 
	mÄhs
;

677 } 
	gyyRuËInfo
[] = {

706 
yy_acû±
(
yyP¬£r
*);

712 
	$yy_»duû
(

713 
yyP¬£r
 *
yypP¬£r
,

714 
yyruËno


716 
yygÙo
;

717 
yyaù
;

718 
YYMINORTYPE
 
yygÙomšÜ
;

719 
yySckEÁry
 *
yym¥
;

720 
yysize
;

721 
P¬£ARG_FETCH
;

722 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

723 #iâdeà
NDEBUG


724 ifĞ
yyT¿ûFILE
 && 
yyruËno
>=0

725 && 
yyruËno
<()((
yyRuËName
)/(yyRuleName[0])) ){

726 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

727 
yyRuËName
[
yyruËno
]);

746 
yygÙomšÜ
 = 
yyz”omšÜ
;

749  
yyruËno
 ){

760 { 
¡©e
->
£‰šgs
 = 
yym¥
[0].
mšÜ
.
yy9
; }

766 
yygÙomšÜ
.
yy9
 = 
	`t¡_š£¹
(
yym¥
[-1].
mšÜ
.yy9, 
	`bd©a
(yym¥[0].mšÜ.
yy35
->
key
->
d©a
), 
	`bËngth
(yymsp[0].minor.yy35->key->data), yymsp[0].minor.yy35);

773 
yygÙomšÜ
.
yy9
 = 
	`t¡_š£¹
(yygÙomšÜ.yy9, 
	`bd©a
(
yym¥
[0].
mšÜ
.
yy35
->
key
->
d©a
), 
	`bËngth
(yymsp[0].minor.yy35->key->data), yymsp[0].minor.yy35);

779 { 
yygÙomšÜ
.
yy9
 = 
yym¥
[-1].
mšÜ
.yy9; 
	`yy_de¡ruùÜ
(
yypP¬£r
,1,&yymsp[0].minor);

785 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_QSTRING
, 
yym¥
[0].
mšÜ
.
yy0
); }

790 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_PATTERN
, 
yym¥
[0].
mšÜ
.
yy0
); }

795 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_NUMBER
, 
yym¥
[0].
mšÜ
.
yy0
); }

800 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_CLASS
, 
yym¥
[0].
mšÜ
.
yy29
); }

805 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_LIST
, 
yym¥
[0].
mšÜ
.
yy18
); }

810 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_HASH
, 
yym¥
[0].
mšÜ
.
yy9
); }

815 { 
yygÙomšÜ
.
yy48
 = 
	`V®ue_ü—‹
(
VAL_REF
, 
yym¥
[0].
mšÜ
.
yy0
); }

821 
yygÙomšÜ
.
yy35
 = 
	`m®loc
((
Paœ
)); yygÙomšÜ.yy35->
key
 = 
yym¥
[-2].
mšÜ
.
yy0
; yygÙomšÜ.yy35->
v®ue
 = yym¥[0].mšÜ.
yy48
;

822 
	`yy_de¡ruùÜ
(
yypP¬£r
,6,&
yym¥
[-1].
mšÜ
);

828 { 
yygÙomšÜ
.
yy29
 = 
	`ÿÎoc
((
CÏss
), 1); yygÙomšÜ.yy29->
id
 = -1; yygÙomšÜ.yy29->
id’t
 = 
yym¥
[-3].
mšÜ
.
yy0
; yygÙomšÜ.yy29->
·¿ms
 = yym¥[-1].mšÜ.
yy9
; 
	`yy_de¡ruùÜ
(
yypP¬£r
,8,&yymsp[-2].minor);

829 
	`yy_de¡ruùÜ
(
yypP¬£r
,9,&
yym¥
[0].
mšÜ
);

835 { 
yygÙomšÜ
.
yy9
 = 
	`t¡_š£¹
(
yym¥
[-2].
mšÜ
.yy9, 
	`bd©a
(yym¥[0].mšÜ.
yy35
->
key
->
d©a
), 
	`bËngth
(yym¥[0].mšÜ.yy35->key->d©a), yym¥[0].mšÜ.yy35); 
	`yy_de¡ruùÜ
(
yypP¬£r
,10,&yymsp[-1].minor);

841 { 
yygÙomšÜ
.
yy9
 = 
	`t¡_š£¹
(
yym¥
[-1].
mšÜ
.yy9, 
	`bd©a
(yym¥[0].mšÜ.
yy35
->
key
->
d©a
), 
	`bËngth
(yymsp[0].minor.yy35->key->data), yymsp[0].minor.yy35); }

845 23: 
	`yy‹¡ÿ£
(
yyruËno
==23);

847 { 
yygÙomšÜ
.
yy9
 = 
NULL
; }

852 { 
yygÙomšÜ
.
yy18
 = 
yym¥
[-1].
mšÜ
.yy18; 
	`yy_de¡ruùÜ
(
yypP¬£r
,11,&yymsp[-2].minor);

853 
	`yy_de¡ruùÜ
(
yypP¬£r
,12,&
yym¥
[0].
mšÜ
);

859 { 
yygÙomšÜ
.
yy18
 = 
yym¥
[-2].
mšÜ
.yy18; 
	`li¡_­³nd
(yygÙomšÜ.yy18, 
	`Êode_ü—‹
(yym¥[0].mšÜ.
yy48
)); 
	`yy_de¡ruùÜ
(
yypP¬£r
,10,&yymsp[-1].minor);

865 { 
yygÙomšÜ
.
yy18
 = 
yym¥
[-1].
mšÜ
.yy18; 
	`li¡_­³nd
(yygÙomšÜ.yy18, 
	`Êode_ü—‹
(yym¥[0].mšÜ.
yy48
)); }

870 { 
yygÙomšÜ
.
yy18
 = 
	`li¡_ü—‹
(
LISTCOUNT_T_MAX
); }

875 { 
yygÙomšÜ
.
yy9
 = 
yym¥
[-1].
mšÜ
.yy9; 
	`yy_de¡ruùÜ
(
yypP¬£r
,13,&yymsp[-2].minor);

876 
	`yy_de¡ruùÜ
(
yypP¬£r
,14,&
yym¥
[0].
mšÜ
);

882 { 
yygÙomšÜ
.
yy9
 = 
	`t¡_š£¹
(
yym¥
[-2].
mšÜ
.yy9, 
	`bd©a
(yym¥[0].mšÜ.
yy27
->
key
->
d©a
), 
	`bËngth
(yym¥[0].mšÜ.yy27->key->d©a), yym¥[0].mšÜ.yy27); 
	`yy_de¡ruùÜ
(
yypP¬£r
,10,&yymsp[-1].minor);

888 { 
yygÙomšÜ
.
yy9
 = 
	`t¡_š£¹
(
yym¥
[-1].
mšÜ
.yy9, 
	`bd©a
(yym¥[0].mšÜ.
yy27
->
key
->
d©a
), 
	`bËngth
(yymsp[0].minor.yy27->key->data), yymsp[0].minor.yy27); }

894 
yygÙomšÜ
.
yy27
 = 
	`m®loc
((
Paœ
)); yygÙomšÜ.yy27->
key
 = 
yym¥
[-2].
mšÜ
.
yy0
; yygÙomšÜ.yy27->
v®ue
 = yym¥[0].mšÜ.
yy48
;

895 
	`yy_de¡ruùÜ
(
yypP¬£r
,15,&
yym¥
[-1].
mšÜ
);

902 
yygÙomšÜ
.
yy27
 = 
	`m®loc
((
Paœ
)); yygÙomšÜ.yy27->
key
 = 
yym¥
[-2].
mšÜ
.
yy0
; yygÙomšÜ.yy27->
v®ue
 = yym¥[0].mšÜ.
yy48
;

903 
	`yy_de¡ruùÜ
(
yypP¬£r
,15,&
yym¥
[-1].
mšÜ
);

910 
yygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

911 
yysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

912 
yypP¬£r
->
yyidx
 -ğ
yysize
;

913 
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yym¥
[-
yysize
].
¡©’o
,(
YYCODETYPE
)
yygÙo
);

914 ifĞ
yyaù
 < 
YYNSTATE
 ){

915 #ifdeà
NDEBUG


920 ifĞ
yysize
 ){

921 
yypP¬£r
->
yyidx
++;

922 
yym¥
 -ğ
yysize
-1;

923 
yym¥
->
¡©’o
 = (
YYACTIONTYPE
)
yyaù
;

924 
yym¥
->
majÜ
 = (
YYCODETYPE
)
yygÙo
;

925 
yym¥
->
mšÜ
 = 
yygÙomšÜ
;

929 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yygÙo
,&
yygÙomšÜ
);

932 
	`as£¹
Ğ
yyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 );

933 
	`yy_acû±
(
yypP¬£r
);

935 
	}
}

940 #iâdeà
YYNOERRORRECOVERY


941 
	$yy_·r£_çed
(

942 
yyP¬£r
 *
yypP¬£r


944 
P¬£ARG_FETCH
;

945 #iâdeà
NDEBUG


946 ifĞ
yyT¿ûFILE
 ){

947 
	`årštf
(
yyT¿ûFILE
,"%sFa!\n",
yyT¿ûProm±
);

950  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

953 
P¬£ARG_STORE
;

954 
	}
}

960 
	$yy_syÁax_”rÜ
(

961 
yyP¬£r
 *
yypP¬£r
,

962 
yymajÜ
,

963 
YYMINORTYPE
 
yymšÜ


965 
P¬£ARG_FETCH
;

966 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

969 ifĞ!
TOKEN
 ) {

970 
	`log_”r
("Reachedheƒnd of file so it seems†ike you‡re missing‡ ')'");

972 
¡©e
->
”rÜ
 = 1;

974 
P¬£ARG_STORE
;

975 
	}
}

980 
	$yy_acû±
(

981 
yyP¬£r
 *
yypP¬£r


983 
P¬£ARG_FETCH
;

984 #iâdeà
NDEBUG


985 ifĞ
yyT¿ûFILE
 ){

986 
	`årštf
(
yyT¿ûFILE
,"%sAcû±!\n",
yyT¿ûProm±
);

989  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

992 
P¬£ARG_STORE
;

993 
	}
}

1014 
	$P¬£
(

1015 *
yyp
,

1016 
yymajÜ
,

1017 
P¬£TOKENTYPE
 
yymšÜ


1018 
P¬£ARG_PDECL


1020 
YYMINORTYPE
 
yymšÜuniÚ
;

1021 
yyaù
;

1022 
yy’dofšput
;

1023 #ifdeà
YYERRORSYMBOL


1024 
yy”rÜh™
 = 0;

1026 
yyP¬£r
 *
yypP¬£r
;

1029 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

1030 ifĞ
yypP¬£r
->
yyidx
<0 ){

1031 #ià
YYSTACKDEPTH
<=0

1032 ifĞ
yypP¬£r
->
yy¡ksz
 <=0 ){

1034 
yymšÜuniÚ
 = 
yyz”omšÜ
;

1035 
	`yySckOv”æow
(
yypP¬£r
, &
yymšÜuniÚ
);

1039 
yypP¬£r
->
yyidx
 = 0;

1040 
yypP¬£r
->
yy”rút
 = -1;

1041 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

1042 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

1044 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

1045 
yy’dofšput
 = (
yymajÜ
==0);

1046 
P¬£ARG_STORE
;

1048 #iâdeà
NDEBUG


1049 ifĞ
yyT¿ûFILE
 ){

1050 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

1055 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
);

1056 ifĞ
yyaù
<
YYNSTATE
 ){

1057 
	`as£¹
Ğ!
yy’dofšput
 );

1058 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

1059 
yypP¬£r
->
yy”rút
--;

1060 
yymajÜ
 = 
YYNOCODE
;

1061 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

1062 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

1064 
	`as£¹
Ğ
yyaù
 =ğ
YY_ERROR_ACTION
 );

1065 #ifdeà
YYERRORSYMBOL


1066 
yymx
;

1068 #iâdeà
NDEBUG


1069 ifĞ
yyT¿ûFILE
 ){

1070 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

1073 #ifdeà
YYERRORSYMBOL


1093 ifĞ
yypP¬£r
->
yy”rút
<0 ){

1094 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1096 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

1097 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

1098 #iâdeà
NDEBUG


1099 ifĞ
yyT¿ûFILE
 ){

1100 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

1101 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

1104 
	`yy_de¡ruùÜ
(
yypP¬£r
, (
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

1105 
yymajÜ
 = 
YYNOCODE
;

1108 
yypP¬£r
->
yyidx
 >= 0 &&

1109 
yymx
 !ğ
YYERRORSYMBOL
 &&

1110 (
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(

1111 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
¡©’o
,

1112 
YYERRORSYMBOL
)è>ğ
YYNSTATE


1114 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

1116 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

1117 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

1118 
	`yy_·r£_çed
(
yypP¬£r
);

1119 
yymajÜ
 = 
YYNOCODE
;

1120 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

1121 
YYMINORTYPE
 
u2
;

1122 
u2
.
YYERRSYMDT
 = 0;

1123 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

1126 
yypP¬£r
->
yy”rút
 = 3;

1127 
yy”rÜh™
 = 1;

1128 #–ià
	`defšed
(
YYNOERRORRECOVERY
)

1136 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1137 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

1138 
yymajÜ
 = 
YYNOCODE
;

1150 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

1151 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1153 
yypP¬£r
->
yy”rút
 = 3;

1154 
	`yy_de¡ruùÜ
(
yypP¬£r
,(
YYCODETYPE
)
yymajÜ
,&
yymšÜuniÚ
);

1155 ifĞ
yy’dofšput
 ){

1156 
	`yy_·r£_çed
(
yypP¬£r
);

1158 
yymajÜ
 = 
YYNOCODE
;

1161 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

1163 
	}
}

	@tools/m2sh/src/parser.h

1 
	#TKEOF
 1

	)

2 
	#TKQSTRING
 2

	)

3 
	#TKPATTERN
 3

	)

4 
	#TKNUMBER
 4

	)

5 
	#TKIDENT
 5

	)

6 
	#TKEQ
 6

	)

7 
	#TKCLASS
 7

	)

8 
	#TKLPAREN
 8

	)

9 
	#TKRPAREN
 9

	)

10 
	#TKCOMMA
 10

	)

11 
	#TKLBRACE
 11

	)

12 
	#TKRBRACE
 12

	)

13 
	#TKLBRACKET
 13

	)

14 
	#TKRBRACKET
 14

	)

15 
	#TKCOLON
 15

	)

	@tools/m2sh/src/token.c

35 
	~<¡dlib.h
>

36 
	~<dbg.h
>

37 
	~"cÚfig_fe.h
"

38 
	~<as£¹.h
>

40 
	$Tok’_de¡roy
(
Tok’
 *
tk
)

42 if(
tk
) {

43 if(
tk
->
d©a
) {

44 
	`bde¡roy
(
tk
->
d©a
);

46 
	`ä“
(
tk
);

48 
	}
}

50 
Tok’
 *
	$Tok’_ü—‹
(
Tok’Ty³
 
ty³
, cÚ¡ *
d©a
, 
Ëngth
)

52 
Tok’
 *
tk
 = 
	`m®loc
((Token));

53 
tk
->
ty³
 =ype;

54 
tk
->
d©a
 = 
	`blk2b¡r
(d©a, 
Ëngth
);

55  
tk
;

56 
	}
}

	@tools/m2sh/src/token.h

1 #iâdeà
_m2sh_tok’_h


2 
	#_m2sh_tok’_h


	)

4 
	tTok’Ty³
;

6 
	sTok’
 {

7 
Tok’Ty³
 
	mty³
;

8 
b¡ršg
 
	md©a
;

9 } 
	tTok’
;

11 
Tok’_de¡roy
(
Tok’
 *
tk
);

13 
Tok’
 *
Tok’_ü—‹
(
Tok’Ty³
 
ty³
, cÚ¡ *
d©a
, 
Ëngth
);

	@tools/m2sh/tests/cli_tests.c

35 
	~"mšun™.h
"

36 
	~"şi.h
"

37 
	~<¡dio.h
>

38 
	~<b¡ršg.h
>

41 *
	$‹¡_·r£r
()

43 
Commªd
 
cmd
;

44 
b¡ršg
 
¬gs
;

46 
¬gs
 = 
	`bäomc¡r
("m2sh stop -db 'config.sqlite' -name 'main'");

47 
	`mu_as£¹
(
	`şi_·¿ms_·r£_¬gs
(
¬gs
, &
cmd
) != -1, "Parse„eturned -1.");

48 
	`mu_as£¹
(!
cmd
.
”rÜ
, "Parsing failed.");

50 
¬gs
 = 
	`bäomc¡r
("m2sh stop -db 'config.sqlite' -name 'main' -now --murder");

51 
	`mu_as£¹
(
	`şi_·¿ms_·r£_¬gs
(
¬gs
, &
cmd
) != -1, "Parse„eturned -1.");

52 
	`mu_as£¹
(!
cmd
.
”rÜ
, "Parsing failed.");

54 
¬gs
 = 
	`bäomc¡r
("m2sh something -db 'config.sqlite' onewohree 4 \"whatever\" --when 12");

55 
	`mu_as£¹
(
	`şi_·¿ms_·r£_¬gs
(
¬gs
, &
cmd
) != -1, "Parse„eturned -1.");

56 
	`mu_as£¹
(!
cmd
.
”rÜ
, "Parsing failed.");

58 
¬gs
 = 
	`bäomc¡r
("m2sh start -db config#sqlite -name main");

59 
	`mu_as£¹
(
	`şi_·¿ms_·r£_¬gs
(
¬gs
, &
cmd
) != -1, "Parse„eturned -1.");

60 
	`mu_as£¹
(!
cmd
.
”rÜ
, "Parsing failed.");

62  
NULL
;

63 
	}
}

65 * 
	$®l_‹¡s
() {

66 
	`mu_su™e_¡¬t
();

68 
	`mu_run_‹¡
(
‹¡_·r£r
);

70  
NULL
;

71 
	}
}

73 
RUN_TESTS
(
®l_‹¡s
);

	@tools/m2sh/tests/minunit.h

1 #iâdeà
_mšun™_h


2 
	#_mšun™_h


	)

4 
	~<¡dio.h
>

5 
	~<dbg.h
>

6 
	~<¡dlib.h
>

8 
	#mu_su™e_¡¬t
(è*
mes§ge
 = 
NULL


	)

11 
	#mu_as£¹
(
‹¡
, 
mes§ge
èià(!Ñe¡)è{ 
	`log_”r
(mes§ge);  mes§ge; }

	)

12 
	#mu_run_‹¡
(
‹¡
è
	`debug
("\n-----%s", " " #‹¡); 
mes§ge
 = 
	`‹¡
(); 
‹¡s_run
++; ià(mes§geè mes§ge;

	)

14 
	#RUN_TESTS
(
Çme
è
	`skmaš
(
¬gc
, *
¬gv
[]) {\

15 
FILE
 *
log_fe
 = 
	`fİ’
("tests/tests.log", "a+");\

16 if(!
log_fe
è{ 
	`´štf
("CAN'T OPEN TEST LOG\n"); 
	`ex™
(1); } \

17 
	`£tbuf
(
log_fe
, 
NULL
);\

18 
	`debug
("----- RUNNING: %s", 
¬gv
[0]);\

19 
	`´štf
("----\nRUNNING: %s\n", 
¬gv
[0]);\

20 *
»suÉ
 = 
	`Çme
();\

21 ià(
»suÉ
 != 0) {\

22 
	`´štf
("FAILED: %s\n", 
»suÉ
);\

25 
	`´štf
("ALL TESTS PASSED\n");\

27 
	`´štf
("Te¡ run: %d\n", 
‹¡s_run
);\

28 
	`ex™
(
»suÉ
 != 0);\

29 }

	)

32 
	g‹¡s_run
;

	@tools/m2sh/tests/parser_tests.c

35 
	~"mšun™.h
"

36 
	~"cÚfig_fe.h
"

37 
	~"·r£r.h
"

38 
	~"a¡.h
"

39 
	~<¡dio.h
>

40 
	~<b¡ršg.h
>

41 
	~<as£¹.h
>

43 
	gCB_FIRED
 = 0;

45 
	$check_ÿÎback
(
t¡_t
 *
·»Á
, 
V®ue
 *
v®
)

47 
	`as£¹
(
·»Á
 && "Should get‡…arent.");

48 
	`as£¹
(
v®
 && "Should get‡ val.");

49 
CB_FIRED
 = 1;

51 
	}
}

53 *
	$‹¡_·r£r
()

55 
t¡_t
 *
£‰šgs
 = 
	`P¬£_cÚfig_fe
("tests/sample.conf");

56 
	`mu_as£¹
(
£‰šgs
, "Error…arsing.");

58 
	`AST_w®k
(
£‰šgs
, 
check_ÿÎback
);

59 
	`AST_de¡roy
(
£‰šgs
);

61  
NULL
;

62 
	}
}

66 * 
	$®l_‹¡s
() {

67 
	`mu_su™e_¡¬t
();

69 
	`mu_run_‹¡
(
‹¡_·r£r
);

71  
NULL
;

72 
	}
}

74 
RUN_TESTS
(
®l_‹¡s
);

	@tools/src/adt/darray.c

35 
	~"adt/d¬¿y.h
"

36 
	~"mem/h®loc.h
"

37 
	~<as£¹.h
>

40 
d¬¿y_t
 *
	$d¬¿y_ü—‹
(
size_t
 
–em’t_size
, size_ˆ
š™Ÿl_max
)

42 
d¬¿y_t
 *
¬¿y
 = 
	`h_m®loc
((darray_t));

43 
	`check_mem
(
¬¿y
);

44 
¬¿y
->
max
 = 
š™Ÿl_max
;

45 
	`check
(
¬¿y
->
max
 > 0, "You must set‡n initial_max > 0.");

47 
¬¿y
->
cÚ‹Ás
 = 
	`h_ÿÎoc
((*), 
š™Ÿl_max
);

48 
	`check_mem
(
¬¿y
->
cÚ‹Ás
);

49 
	`h©ch
(
¬¿y
->
cÚ‹Ás
,‡rray);

51 
¬¿y
->
’d
 = 0;

52 
¬¿y
->
–em’t_size
 =ƒlement_size;

53 
¬¿y
->
ex·nd_¿‹
 = 
DEFAULT_EXPAND_RATE
;

55  
¬¿y
;

57 
”rÜ
:

58 if(
¬¿y
è
	`h_ä“
(array);

59  
NULL
;

60 
	}
}

62 
	$d¬¿y_ş—r
(
d¬¿y_t
 *
¬¿y
)

64 
i
 = 0;

65 if(
¬¿y
->
–em’t_size
 > 0) {

66 
i
 = 0; i < 
¬¿y
->
max
; i++) {

67 if(
¬¿y
->
cÚ‹Ás
[
i
] !ğ
NULL
) {

68 
	`ä“
(
¬¿y
->
cÚ‹Ás
[
i
]);

72 
	}
}

74 
šlše
 
	$d¬¿y_»size
(
d¬¿y_t
 *
¬¿y
, 
size_t
 
Ãwsize
)

76 
¬¿y
->
max
 = 
Ãwsize
;

77 
	`check
(
¬¿y
->
max
 > 0, "The‚ewsize must be > 0.");

78 
¬¿y
->
cÚ‹Ás
 = 
	`h_»®loc
×¼ay->cÚ‹Ás,‡¼ay->
max
 * (*));

79 
	`check_mem
(
¬¿y
->
cÚ‹Ás
);

81 
”rÜ
:

83 
	}
}

85 
	$d¬¿y_ex·nd
(
d¬¿y_t
 *
¬¿y
)

87 
size_t
 
Şd_max
 = 
¬¿y
->
max
;

88 
	`check
(
	`d¬¿y_»size
(
¬¿y
,‡¼ay->
max
 +‡¼ay->
ex·nd_¿‹
) == 0,

90 
¬¿y
->
max
 + (ï¼ay->
ex·nd_¿‹
);

92 
	`mem£t
(
¬¿y
->
cÚ‹Ás
 + 
Şd_max
, 0,‡¼ay->
ex·nd_¿‹
 + 1);

95 
”rÜ
:

97 
	}
}

99 
	$d¬¿y_cÚŒaù
(
d¬¿y_t
 *
¬¿y
)

101 
Ãw_size
 = 
¬¿y
->
’d
 < (ï¼ay->
ex·nd_¿‹
 ? ()array->expand_rate :‡rray->end;

103  
	`d¬¿y_»size
(
¬¿y
, 
Ãw_size
 + 1);

104 
	}
}

107 
	$d¬¿y_de¡roy
(
d¬¿y_t
 *
¬¿y
)

109 
	`d¬¿y_ş—r
(
¬¿y
);

110 
	`h_ä“
(
¬¿y
);

111 
	}
}

113 
	$d¬¿y_push
(
d¬¿y_t
 *
¬¿y
, *
–
)

115 
¬¿y
->
cÚ‹Ás
[¬¿y->
’d
] = 
–
;

116 
¬¿y
->
’d
++;

118 if(
	`d¬¿y_’d
(
¬¿y
è>ğ
	`d¬¿y_max
(array)) {

119  
	`d¬¿y_ex·nd
(
¬¿y
);

123 
	}
}

125 *
	$d¬¿y_pİ
(
d¬¿y_t
 *
¬¿y
)

127 
	`check
(
¬¿y
->
’d
 - 1 > 0, "Attempto…op fromƒmpty‡rray.");

129 *
–
 = 
	`d¬¿y_»move
(
¬¿y
,‡¼ay->
’d
 - 1);

130 
¬¿y
->
’d
--;

132 if(
	`d¬¿y_’d
(
¬¿y
è> (ï¼ay->
ex·nd_¿‹
 && darray_end(array) %‡rray->expand_rate) {

133 
	`d¬¿y_cÚŒaù
(
¬¿y
);

136  
–
;

137 
”rÜ
:

138  
NULL
;

139 
	}
}

	@tools/src/adt/darray.h

1 #iâdeà
_d¬¿y_h


2 
	#_d¬¿y_h


	)

3 
	~"dbg.h
"

4 
	~<¡dlib.h
>

5 
	~<as£¹.h
>

7 
	sd¬¿y_t
 {

8 
	m’d
;

9 
	mmax
;

10 
size_t
 
	m–em’t_size
;

11 
size_t
 
	mex·nd_¿‹
;

12 **
	mcÚ‹Ás
;

13 } 
	td¬¿y_t
;

15 
d¬¿y_t
 *
d¬¿y_ü—‹
(
size_t
 
–em’t_size
, size_ˆ
š™Ÿl_max
);

17 
d¬¿y_de¡roy
(
d¬¿y_t
 *
¬¿y
);

19 
d¬¿y_ş—r
(
d¬¿y_t
 *
¬¿y
);

21 
d¬¿y_ex·nd
(
d¬¿y_t
 *
¬¿y
);

23 
d¬¿y_cÚŒaù
(
d¬¿y_t
 *
¬¿y
);

25 
d¬¿y_push
(
d¬¿y_t
 *
¬¿y
, *
–
);

27 *
d¬¿y_pİ
(
d¬¿y_t
 *
¬¿y
);

29 
	#d¬¿y_Ï¡
(
A
è((A)->
cÚ‹Ás
[(A)->
’d
 - 1])

	)

30 
	#d¬¿y_fœ¡
(
A
è((A)->
cÚ‹Ás
[0])

	)

31 
	#d¬¿y_’d
(
A
è((A)->
’d
)

	)

32 
	#d¬¿y_max
(
A
è((A)->
max
)

	)

34 
	#DEFAULT_EXPAND_RATE
 300

	)

37 
šlše
 
	$d¬¿y_£t
(
d¬¿y_t
 *
¬¿y
, 
i
, *
–
)

39 
	`check
(
i
 < 
¬¿y
->
max
, "darray‡ttempto set…ast max");

40 
¬¿y
->
cÚ‹Ás
[
i
] = 
–
;

41 
”rÜ
:

43 
	}
}

45 
šlše
 *
	$d¬¿y_g‘
(
d¬¿y_t
 *
¬¿y
, 
i
)

47 
	`as£¹
(
i
 < 
¬¿y
->
max
 && "darray‡ttempto get…ast max");

48  
¬¿y
->
cÚ‹Ás
[
i
];

49 
	}
}

51 
šlše
 *
	$d¬¿y_»move
(
d¬¿y_t
 *
¬¿y
, 
i
)

53 *
–
 = 
¬¿y
->
cÚ‹Ás
[
i
];

55 
¬¿y
->
cÚ‹Ás
[
i
] = 
NULL
;

57  
–
;

58 
	}
}

60 
šlše
 *
	$d¬¿y_Ãw
(
d¬¿y_t
 *
¬¿y
)

62 
	`check
(
¬¿y
->
–em’t_size
 > 0, "Can't use darray_new on 0 size darrays.");

64  
	`ÿÎoc
(1, 
¬¿y
->
–em’t_size
);

66 
”rÜ
:

67  
NULL
;

68 
	}
}

	@tools/src/adt/dict.c

21 
	~<¡dlib.h
>

22 
	~<¡ddef.h
>

23 
	~<as£¹.h
>

24 
	#DICT_IMPLEMENTATION


	)

25 
	~"diù.h
"

27 #ifdeà
KAZLIB_RCSID


28 cÚ¡ 
	grcsid
[] = "$Id: dict.c,v 1.40.2.7 2000/11/13 01:36:44 kaz Exp $";

43 
	#Ëá
 
diù_Ëá


	)

44 
	#right
 
diù_right


	)

45 
	#·»Á
 
diù_·»Á


	)

46 
	#cŞÜ
 
diù_cŞÜ


	)

47 
	#key
 
diù_key


	)

48 
	#d©a
 
diù_d©a


	)

50 
	#nnode
 
diù_nnode


	)

51 
	#nodecouÁ
 
diù_nodecouÁ


	)

52 
	#maxcouÁ
 
diù_maxcouÁ


	)

53 
	#com·»
 
diù_com·»


	)

54 
	#®loúode
 
diù_®loúode


	)

55 
	#ä“node
 
diù_ä“node


	)

56 
	#cÚ‹xt
 
diù_cÚ‹xt


	)

57 
	#du³s
 
diù_du³s


	)

59 
	#diù±r
 
diù_diù±r


	)

61 
	#diù_roÙ
(
D
è((D)->
nnode
.
Ëá
)

	)

62 
	#diù_n
(
D
è(&(D)->
nnode
)

	)

63 
	#DICT_DEPTH_MAX
 64

	)

65 
dnode_t
 *
dnode_®loc
(*
cÚ‹xt
);

66 
dnode_ä“
(
dnode_t
 *
node
, *
cÚ‹xt
);

75 
	$rÙ©e_Ëá
(
dnode_t
 *
uµ”
)

77 
dnode_t
 *
low”
, *
lowËá
, *
uµ¬’t
;

79 
low”
 = 
uµ”
->
right
;

80 
uµ”
->
right
 = 
lowËá
 = 
low”
->
Ëá
;

81 
lowËá
->
·»Á
 = 
uµ”
;

83 
low”
->
·»Á
 = 
uµ¬’t
 = 
uµ”
->parent;

88 ià(
uµ”
 =ğ
uµ¬’t
->
Ëá
) {

89 
uµ¬’t
->
Ëá
 = 
low”
;

91 
	`as£¹
 (
uµ”
 =ğ
uµ¬’t
->
right
);

92 
uµ¬’t
->
right
 = 
low”
;

95 
low”
->
Ëá
 = 
uµ”
;

96 
uµ”
->
·»Á
 = 
low”
;

97 
	}
}

104 
	$rÙ©e_right
(
dnode_t
 *
uµ”
)

106 
dnode_t
 *
low”
, *
lowright
, *
uµ¬’t
;

108 
low”
 = 
uµ”
->
Ëá
;

109 
uµ”
->
Ëá
 = 
lowright
 = 
low”
->
right
;

110 
lowright
->
·»Á
 = 
uµ”
;

112 
low”
->
·»Á
 = 
uµ¬’t
 = 
uµ”
->parent;

114 ià(
uµ”
 =ğ
uµ¬’t
->
right
) {

115 
uµ¬’t
->
right
 = 
low”
;

117 
	`as£¹
 (
uµ”
 =ğ
uµ¬’t
->
Ëá
);

118 
uµ¬’t
->
Ëá
 = 
low”
;

121 
low”
->
right
 = 
uµ”
;

122 
uµ”
->
·»Á
 = 
low”
;

123 
	}
}

130 
	$ä“_nodes
(
diù_t
 *
diù
, 
dnode_t
 *
node
, dnode_ˆ*
n
)

132 ià(
node
 =ğ
n
)

134 
	`ä“_nodes
(
diù
, 
node
->
Ëá
, 
n
);

135 
	`ä“_nodes
(
diù
, 
node
->
right
, 
n
);

136 
diù
->
	`ä“node
(
node
, diù->
cÚ‹xt
);

137 
	}
}

148 
	$v”ify_bšŒ“
(
diù_t
 *
diù
)

150 
dnode_t
 *
fœ¡
, *
Ãxt
;

152 
fœ¡
 = 
	`diù_fœ¡
(
diù
);

154 ià(
diù
->
du³s
) {

155 
fœ¡
 && (
Ãxt
 = 
	`diù_Ãxt
(
diù
, first))) {

156 ià(
diù
->
	`com·»
(
fœ¡
->
key
, 
Ãxt
->key) > 0)

158 
fœ¡
 = 
Ãxt
;

161 
fœ¡
 && (
Ãxt
 = 
	`diù_Ãxt
(
diù
, first))) {

162 ià(
diù
->
	`com·»
(
fœ¡
->
key
, 
Ãxt
->key) >= 0)

164 
fœ¡
 = 
Ãxt
;

168 
	}
}

184 
	$v”ify_»dbÏck
(
dnode_t
 *
n
, dnode_ˆ*
roÙ
)

186 
height_Ëá
, 
height_right
;

188 ià(
roÙ
 !ğ
n
) {

189 
height_Ëá
 = 
	`v”ify_»dbÏck
(
n
, 
roÙ
->
Ëá
);

190 
height_right
 = 
	`v”ify_»dbÏck
(
n
, 
roÙ
->
right
);

191 ià(
height_Ëá
 =ğ0 || 
height_right
 == 0)

193 ià(
height_Ëá
 !ğ
height_right
)

195 ià(
roÙ
->
cŞÜ
 =ğ
dnode_»d
) {

196 ià(
roÙ
->
Ëá
->
cŞÜ
 !ğ
dnode_bÏck
)

198 ià(
roÙ
->
right
->
cŞÜ
 !ğ
dnode_bÏck
)

200  
height_Ëá
;

202 ià(
roÙ
->
cŞÜ
 !ğ
dnode_bÏck
)

204  
height_Ëá
 + 1;

207 
	}
}

215 
diùcouÁ_t
 
	$v”ify_node_couÁ
(
dnode_t
 *
n
, dnode_ˆ*
roÙ
)

217 ià(
roÙ
 =ğ
n
)

220  1 + 
	`v”ify_node_couÁ
(
n
, 
roÙ
->
Ëá
)

221 + 
	`v”ify_node_couÁ
(
n
, 
roÙ
->
right
);

222 
	}
}

231 
	$v”ify_diù_has_node
(
dnode_t
 *
n
, dnode_ˆ*
roÙ
, dnode_ˆ*
node
)

233 ià(
roÙ
 !ğ
n
) {

234  
roÙ
 =ğ
node


235 || 
	`v”ify_diù_has_node
(
n
, 
roÙ
->
Ëá
, 
node
)

236 || 
	`v”ify_diù_has_node
(
n
, 
roÙ
->
right
, 
node
);

239 
	}
}

246 
diù_t
 *
	$diù_ü—‹
(
diùcouÁ_t
 
maxcouÁ
, 
diù_comp_t
 
comp
)

248 
diù_t
 *
Ãw
 = 
	`m®loc
( *new);

250 ià(
Ãw
) {

251 
Ãw
->
com·»
 = 
comp
;

252 
Ãw
->
®loúode
 = 
dnode_®loc
;

253 
Ãw
->
ä“node
 = 
dnode_ä“
;

254 
Ãw
->
cÚ‹xt
 = 
NULL
;

255 
Ãw
->
nodecouÁ
 = 0;

256 
Ãw
->
maxcouÁ
 = maxcount;

257 
Ãw
->
nnode
.
Ëá
 = &new->nilnode;

258 
Ãw
->
nnode
.
right
 = &new->nilnode;

259 
Ãw
->
nnode
.
·»Á
 = &new->nilnode;

260 
Ãw
->
nnode
.
cŞÜ
 = 
dnode_bÏck
;

261 
Ãw
->
du³s
 = 0;

263  
Ãw
;

264 
	}
}

270 
	$diù_£t_®loÿtÜ
(
diù_t
 *
diù
, 
dnode_®loc_t
 
®
,

271 
dnode_ä“_t
 
ä
, *
cÚ‹xt
)

273 
	`as£¹
 (
	`diù_couÁ
(
diù
) == 0);

274 
	`as£¹
 ((
®
 =ğ
NULL
 && 
ä
 == NULL) || (al != NULL && fr != NULL));

276 
diù
->
®loúode
 = 
®
 ?‡È: 
dnode_®loc
;

277 
diù
->
ä“node
 = 
ä
 ? f¸: 
dnode_ä“
;

278 
diù
->
cÚ‹xt
 = context;

279 
	}
}

286 
	$diù_de¡roy
(
diù_t
 *
diù
)

288 
	`as£¹
 (
	`diù_i£m±y
(
diù
));

289 
	`ä“
(
diù
);

290 
	}
}

297 
	$diù_ä“_nodes
(
diù_t
 *
diù
)

299 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(dict);

300 
	`ä“_nodes
(
diù
, 
roÙ
, 
n
);

301 
diù
->
nodecouÁ
 = 0;

302 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

303 
diù
->
nnode
.
right
 = &dict->nilnode;

304 
	}
}

310 
	$diù_ä“
(
diù_t
 *
diù
)

312 #ifdeà
KAZLIB_OBSOLESCENT_DEBUG


313 
	`as£¹
 ("callo obsolescent function dict_free()" && 0);

315 
	`diù_ä“_nodes
(
diù
);

316 
	}
}

322 
diù_t
 *
	$diù_š™
(
diù_t
 *
diù
, 
diùcouÁ_t
 
maxcouÁ
, 
diù_comp_t
 
comp
)

324 
diù
->
com·»
 = 
comp
;

325 
diù
->
®loúode
 = 
dnode_®loc
;

326 
diù
->
ä“node
 = 
dnode_ä“
;

327 
diù
->
cÚ‹xt
 = 
NULL
;

328 
diù
->
nodecouÁ
 = 0;

329 
diù
->
maxcouÁ
 = maxcount;

330 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

331 
diù
->
nnode
.
right
 = &dict->nilnode;

332 
diù
->
nnode
.
·»Á
 = &dict->nilnode;

333 
diù
->
nnode
.
cŞÜ
 = 
dnode_bÏck
;

334 
diù
->
du³s
 = 0;

335  
diù
;

336 
	}
}

342 
	$diù_š™_like
(
diù_t
 *
diù
, cÚ¡ diù_ˆ*
‹m¶©e
)

344 
diù
->
com·»
 = 
‹m¶©e
->compare;

345 
diù
->
®loúode
 = 
‹m¶©e
->allocnode;

346 
diù
->
ä“node
 = 
‹m¶©e
->freenode;

347 
diù
->
cÚ‹xt
 = 
‹m¶©e
->context;

348 
diù
->
nodecouÁ
 = 0;

349 
diù
->
maxcouÁ
 = 
‹m¶©e
->maxcount;

350 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

351 
diù
->
nnode
.
right
 = &dict->nilnode;

352 
diù
->
nnode
.
·»Á
 = &dict->nilnode;

353 
diù
->
nnode
.
cŞÜ
 = 
dnode_bÏck
;

354 
diù
->
du³s
 = 
‹m¶©e
->dupes;

356 
	`as£¹
 (
	`diù_sim¬
(
diù
, 
‹m¶©e
));

357 
	}
}

363 
	$diù_ş—r
(
diù_t
 *
diù
)

365 
diù
->
nodecouÁ
 = 0;

366 
diù
->
nnode
.
Ëá
 = &dict->nilnode;

367 
diù
->
nnode
.
right
 = &dict->nilnode;

368 
diù
->
nnode
.
·»Á
 = &dict->nilnode;

369 
	`as£¹
 (
diù
->
nnode
.
cŞÜ
 =ğ
dnode_bÏck
);

370 
	}
}

380 
	$diù_v”ify
(
diù_t
 *
diù
)

382 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(dict);

385 ià(
roÙ
->
cŞÜ
 !ğ
dnode_bÏck
)

387 ià(
n
->
cŞÜ
 !ğ
dnode_bÏck
)

389 ià(
n
->
right
 !=‚il)

392 ià(
n
->
Ëá
->
·»Á
 !=‚il)

395 ià(!
	`v”ify_bšŒ“
(
diù
))

398 ià(!
	`v”ify_»dbÏck
(
n
, 
roÙ
))

400 ià(
	`v”ify_node_couÁ
(
n
, 
roÙ
è!ğ
	`diù_couÁ
(
diù
))

403 
	}
}

410 
	$diù_sim¬
(cÚ¡ 
diù_t
 *
Ëá
, cÚ¡ diù_ˆ*
right
)

412 ià(
Ëá
->
com·»
 !ğ
right
->compare)

415 ià(
Ëá
->
®loúode
 !ğ
right
->allocnode)

418 ià(
Ëá
->
ä“node
 !ğ
right
->freenode)

421 ià(
Ëá
->
cÚ‹xt
 !ğ
right
->context)

424 ià(
Ëá
->
du³s
 !ğ
right
->dupes)

428 
	}
}

437 
dnode_t
 *
	$diù_lookup
(
diù_t
 *
diù
, cÚ¡ *
key
)

439 
dnode_t
 *
roÙ
 = 
	`diù_roÙ
(
diù
);

440 
dnode_t
 *
n
 = 
	`diù_n
(
diù
);

441 
dnode_t
 *
§ved
;

442 
»suÉ
;

446 
roÙ
 !ğ
n
) {

447 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
roÙ
->key);

448 ià(
»suÉ
 < 0)

449 
roÙ
 =„oÙ->
Ëá
;

450 ià(
»suÉ
 > 0)

451 
roÙ
 =„oÙ->
right
;

453 ià(!
diù
->
du³s
) {

454  
roÙ
;

457 
§ved
 = 
roÙ
;

458 
roÙ
 =„oÙ->
Ëá
;

459 
roÙ
 !ğ
n
 && 
diù
->
	`com·»
(
key
,„oot->key))

460 
roÙ
 =„oÙ->
right
;

461 } 
roÙ
 !ğ
n
);

462  
§ved
;

467  
NULL
;

468 
	}
}

475 
dnode_t
 *
	$diù_low”_bound
(
diù_t
 *
diù
, cÚ¡ *
key
)

477 
dnode_t
 *
roÙ
 = 
	`diù_roÙ
(
diù
);

478 
dnode_t
 *
n
 = 
	`diù_n
(
diù
);

479 
dnode_t
 *
‹Á©ive
 = 0;

481 
roÙ
 !ğ
n
) {

482 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
roÙ
->key);

484 ià(
»suÉ
 > 0) {

485 
roÙ
 =„oÙ->
right
;

486 } ià(
»suÉ
 < 0) {

487 
‹Á©ive
 = 
roÙ
;

488 
roÙ
 =„oÙ->
Ëá
;

490 ià(!
diù
->
du³s
) {

491  
roÙ
;

493 
‹Á©ive
 = 
roÙ
;

494 
roÙ
 =„oÙ->
Ëá
;

499  
‹Á©ive
;

500 
	}
}

507 
dnode_t
 *
	$diù_uµ”_bound
(
diù_t
 *
diù
, cÚ¡ *
key
)

509 
dnode_t
 *
roÙ
 = 
	`diù_roÙ
(
diù
);

510 
dnode_t
 *
n
 = 
	`diù_n
(
diù
);

511 
dnode_t
 *
‹Á©ive
 = 0;

513 
roÙ
 !ğ
n
) {

514 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
roÙ
->key);

516 ià(
»suÉ
 < 0) {

517 
roÙ
 =„oÙ->
Ëá
;

518 } ià(
»suÉ
 > 0) {

519 
‹Á©ive
 = 
roÙ
;

520 
roÙ
 =„oÙ->
right
;

522 ià(!
diù
->
du³s
) {

523  
roÙ
;

525 
‹Á©ive
 = 
roÙ
;

526 
roÙ
 =„oÙ->
right
;

531  
‹Á©ive
;

532 
	}
}

542 
	$diù_š£¹
(
diù_t
 *
diù
, 
dnode_t
 *
node
, cÚ¡ *
key
)

544 
dnode_t
 *
wh”e
 = 
	`diù_roÙ
(
diù
), *
n
 = 
	`diù_n
(dict);

545 
dnode_t
 *
·»Á
 = 
n
, *
unşe
, *
g¿nd·
;

546 
»suÉ
 = -1;

548 
node
->
key
 = key;

550 
	`as£¹
 (!
	`diù_isfuÎ
(
diù
));

551 
	`as£¹
 (!
	`diù_cÚšs
(
diù
, 
node
));

552 
	`as£¹
 (!
	`dnode_is_š_a_diù
(
node
));

556 
wh”e
 !ğ
n
) {

557 
·»Á
 = 
wh”e
;

558 
»suÉ
 = 
diù
->
	`com·»
(
key
, 
wh”e
->key);

560 
	`as£¹
 (
diù
->
du³s
 || 
»suÉ
 != 0);

561 ià(
»suÉ
 < 0)

562 
wh”e
 = wh”e->
Ëá
;

564 
wh”e
 = wh”e->
right
;

567 
	`as£¹
 (
wh”e
 =ğ
n
);

569 ià(
»suÉ
 < 0)

570 
·»Á
->
Ëá
 = 
node
;

572 
·»Á
->
right
 = 
node
;

574 
node
->
·»Á
 =…arent;

575 
node
->
Ëá
 = 
n
;

576 
node
->
right
 = 
n
;

578 
diù
->
nodecouÁ
++;

582 
node
->
cŞÜ
 = 
dnode_»d
;

584 
·»Á
->
cŞÜ
 =ğ
dnode_»d
) {

585 
g¿nd·
 = 
·»Á
->parent;

586 ià(
·»Á
 =ğ
g¿nd·
->
Ëá
) {

587 
unşe
 = 
g¿nd·
->
right
;

588 ià(
unşe
->
cŞÜ
 =ğ
dnode_»d
) {

589 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

590 
unşe
->
cŞÜ
 = 
dnode_bÏck
;

591 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

592 
node
 = 
g¿nd·
;

593 
·»Á
 = 
g¿nd·
->parent;

595 ià(
node
 =ğ
·»Á
->
right
) {

596 
	`rÙ©e_Ëá
(
·»Á
);

597 
·»Á
 = 
node
;

598 
	`as£¹
 (
g¿nd·
 =ğ
·»Á
->parent);

601 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

602 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

603 
	`rÙ©e_right
(
g¿nd·
);

607 
unşe
 = 
g¿nd·
->
Ëá
;

608 ià(
unşe
->
cŞÜ
 =ğ
dnode_»d
) {

609 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

610 
unşe
->
cŞÜ
 = 
dnode_bÏck
;

611 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

612 
node
 = 
g¿nd·
;

613 
·»Á
 = 
g¿nd·
->parent;

615 ià(
node
 =ğ
·»Á
->
Ëá
) {

616 
	`rÙ©e_right
(
·»Á
);

617 
·»Á
 = 
node
;

618 
	`as£¹
 (
g¿nd·
 =ğ
·»Á
->parent);

620 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

621 
g¿nd·
->
cŞÜ
 = 
dnode_»d
;

622 
	`rÙ©e_Ëá
(
g¿nd·
);

628 
	`diù_roÙ
(
diù
)->
cŞÜ
 = 
dnode_bÏck
;

630 
	`as£¹
 (
	`diù_v”ify
(
diù
));

631 
	}
}

639 
dnode_t
 *
	$diù_d–‘e
(
diù_t
 *
diù
, 
dnode_t
 *
d–‘e
)

641 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
chd
, *
d–·»Á
 = 
d–‘e
->
·»Á
;

645 
	`as£¹
 (!
	`diù_i£m±y
(
diù
));

646 
	`as£¹
 (
	`diù_cÚšs
(
diù
, 
d–‘e
));

660 ià(
d–‘e
->
Ëá
 !ğ
n
 && d–‘e->
right
 !=‚il) {

661 
dnode_t
 *
Ãxt
 = 
	`diù_Ãxt
(
diù
, 
d–‘e
);

662 
dnode_t
 *
Ãx¬’t
 = 
Ãxt
->
·»Á
;

663 
dnode_cŞÜ_t
 
ÃxtcŞÜ
 = 
Ãxt
->
cŞÜ
;

665 
	`as£¹
 (
Ãxt
 !ğ
n
);

666 
	`as£¹
 (
Ãxt
->
·»Á
 !ğ
n
);

667 
	`as£¹
 (
Ãxt
->
Ëá
 =ğ
n
);

674 
chd
 = 
Ãxt
->
right
;

675 
chd
->
·»Á
 = 
Ãx¬’t
;

677 ià(
Ãx¬’t
->
Ëá
 =ğ
Ãxt
) {

678 
Ãx¬’t
->
Ëá
 = 
chd
;

680 
	`as£¹
 (
Ãx¬’t
->
right
 =ğ
Ãxt
);

681 
Ãx¬’t
->
right
 = 
chd
;

689 
Ãxt
->
·»Á
 = 
d–·»Á
;

690 
Ãxt
->
Ëá
 = 
d–‘e
->left;

691 
Ãxt
->
right
 = 
d–‘e
->right;

692 
Ãxt
->
Ëá
->
·»Á
 =‚ext;

693 
Ãxt
->
right
->
·»Á
 =‚ext;

694 
Ãxt
->
cŞÜ
 = 
d–‘e
->color;

695 
d–‘e
->
cŞÜ
 = 
ÃxtcŞÜ
;

697 ià(
d–·»Á
->
Ëá
 =ğ
d–‘e
) {

698 
d–·»Á
->
Ëá
 = 
Ãxt
;

700 
	`as£¹
 (
d–·»Á
->
right
 =ğ
d–‘e
);

701 
d–·»Á
->
right
 = 
Ãxt
;

705 
	`as£¹
 (
d–‘e
 !ğ
n
);

706 
	`as£¹
 (
d–‘e
->
Ëá
 =ğ
n
 || d–‘e->
right
 ==‚il);

708 
chd
 = (
d–‘e
->
Ëá
 !ğ
n
è? d–‘e->Ëá : d–‘e->
right
;

710 
chd
->
·»Á
 = 
d–·»Á
 = 
d–‘e
->parent;

712 ià(
d–‘e
 =ğ
d–·»Á
->
Ëá
) {

713 
d–·»Á
->
Ëá
 = 
chd
;

715 
	`as£¹
 (
d–‘e
 =ğ
d–·»Á
->
right
);

716 
d–·»Á
->
right
 = 
chd
;

720 
d–‘e
->
·»Á
 = 
NULL
;

721 
d–‘e
->
right
 = 
NULL
;

722 
d–‘e
->
Ëá
 = 
NULL
;

724 
diù
->
nodecouÁ
--;

726 
	`as£¹
 (
	`v”ify_bšŒ“
(
diù
));

730 ià(
d–‘e
->
cŞÜ
 =ğ
dnode_bÏck
) {

731 
dnode_t
 *
·»Á
, *
si¡”
;

733 
	`diù_roÙ
(
diù
)->
cŞÜ
 = 
dnode_»d
;

735 
chd
->
cŞÜ
 =ğ
dnode_bÏck
) {

736 
·»Á
 = 
chd
->parent;

737 ià(
chd
 =ğ
·»Á
->
Ëá
) {

738 
si¡”
 = 
·»Á
->
right
;

739 
	`as£¹
 (
si¡”
 !ğ
n
);

740 ià(
si¡”
->
cŞÜ
 =ğ
dnode_»d
) {

741 
si¡”
->
cŞÜ
 = 
dnode_bÏck
;

742 
·»Á
->
cŞÜ
 = 
dnode_»d
;

743 
	`rÙ©e_Ëá
(
·»Á
);

744 
si¡”
 = 
·»Á
->
right
;

745 
	`as£¹
 (
si¡”
 !ğ
n
);

747 ià(
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_bÏck


748 && 
si¡”
->
right
->
cŞÜ
 =ğ
dnode_bÏck
) {

749 
si¡”
->
cŞÜ
 = 
dnode_»d
;

750 
chd
 = 
·»Á
;

752 ià(
si¡”
->
right
->
cŞÜ
 =ğ
dnode_bÏck
) {

753 
	`as£¹
 (
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_»d
);

754 
si¡”
->
Ëá
->
cŞÜ
 = 
dnode_bÏck
;

755 
si¡”
->
cŞÜ
 = 
dnode_»d
;

756 
	`rÙ©e_right
(
si¡”
);

757 
si¡”
 = 
·»Á
->
right
;

758 
	`as£¹
 (
si¡”
 !ğ
n
);

760 
si¡”
->
cŞÜ
 = 
·»Á
->color;

761 
si¡”
->
right
->
cŞÜ
 = 
dnode_bÏck
;

762 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

763 
	`rÙ©e_Ëá
(
·»Á
);

767 
	`as£¹
 (
chd
 =ğ
·»Á
->
right
);

768 
si¡”
 = 
·»Á
->
Ëá
;

769 
	`as£¹
 (
si¡”
 !ğ
n
);

770 ià(
si¡”
->
cŞÜ
 =ğ
dnode_»d
) {

771 
si¡”
->
cŞÜ
 = 
dnode_bÏck
;

772 
·»Á
->
cŞÜ
 = 
dnode_»d
;

773 
	`rÙ©e_right
(
·»Á
);

774 
si¡”
 = 
·»Á
->
Ëá
;

775 
	`as£¹
 (
si¡”
 !ğ
n
);

777 ià(
si¡”
->
right
->
cŞÜ
 =ğ
dnode_bÏck


778 && 
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_bÏck
) {

779 
si¡”
->
cŞÜ
 = 
dnode_»d
;

780 
chd
 = 
·»Á
;

782 ià(
si¡”
->
Ëá
->
cŞÜ
 =ğ
dnode_bÏck
) {

783 
	`as£¹
 (
si¡”
->
right
->
cŞÜ
 =ğ
dnode_»d
);

784 
si¡”
->
right
->
cŞÜ
 = 
dnode_bÏck
;

785 
si¡”
->
cŞÜ
 = 
dnode_»d
;

786 
	`rÙ©e_Ëá
(
si¡”
);

787 
si¡”
 = 
·»Á
->
Ëá
;

788 
	`as£¹
 (
si¡”
 !ğ
n
);

790 
si¡”
->
cŞÜ
 = 
·»Á
->color;

791 
si¡”
->
Ëá
->
cŞÜ
 = 
dnode_bÏck
;

792 
·»Á
->
cŞÜ
 = 
dnode_bÏck
;

793 
	`rÙ©e_right
(
·»Á
);

799 
chd
->
cŞÜ
 = 
dnode_bÏck
;

800 
	`diù_roÙ
(
diù
)->
cŞÜ
 = 
dnode_bÏck
;

803 
	`as£¹
 (
	`diù_v”ify
(
diù
));

805  
d–‘e
;

806 
	}
}

813 
	$diù_®loc_š£¹
(
diù_t
 *
diù
, cÚ¡ *
key
, *
d©a
)

815 
dnode_t
 *
node
 = 
diù
->
	`®loúode
(diù->
cÚ‹xt
);

817 ià(
node
) {

818 
	`dnode_š™
(
node
, 
d©a
);

819 
	`diù_š£¹
(
diù
, 
node
, 
key
);

823 
	}
}

825 
	$diù_d–‘e_ä“
(
diù_t
 *
diù
, 
dnode_t
 *
node
)

827 
	`diù_d–‘e
(
diù
, 
node
);

828 
diù
->
	`ä“node
(
node
, diù->
cÚ‹xt
);

829 
	}
}

836 
dnode_t
 *
	$diù_fœ¡
(
diù_t
 *
diù
)

838 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(diù), *
Ëá
;

840 ià(
roÙ
 !ğ
n
)

841 (
Ëá
 = 
roÙ
->Ëáè!ğ
n
)

842 
roÙ
 = 
Ëá
;

844  (
roÙ
 =ğ
n
è? 
NULL
 :„oot;

845 
	}
}

852 
dnode_t
 *
	$diù_Ï¡
(
diù_t
 *
diù
)

854 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
roÙ
 = 
	`diù_roÙ
(diù), *
right
;

856 ià(
roÙ
 !ğ
n
)

857 (
right
 = 
roÙ
->rightè!ğ
n
)

858 
roÙ
 = 
right
;

860  (
roÙ
 =ğ
n
è? 
NULL
 :„oot;

861 
	}
}

870 
dnode_t
 *
	$diù_Ãxt
(
diù_t
 *
diù
, 
dnode_t
 *
cu¼
)

872 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
·»Á
, *
Ëá
;

874 ià(
cu¼
->
right
 !ğ
n
) {

875 
cu¼
 = cu¼->
right
;

876 (
Ëá
 = 
cu¼
->Ëáè!ğ
n
)

877 
cu¼
 = 
Ëá
;

878  
cu¼
;

881 
·»Á
 = 
cu¼
->parent;

883 
·»Á
 !ğ
n
 && 
cu¼
 =ğ·»Á->
right
) {

884 
cu¼
 = 
·»Á
;

885 
·»Á
 = 
cu¼
->parent;

888  (
·»Á
 =ğ
n
è? 
NULL
 :…arent;

889 
	}
}

896 
dnode_t
 *
	$diù_´ev
(
diù_t
 *
diù
, 
dnode_t
 *
cu¼
)

898 
dnode_t
 *
n
 = 
	`diù_n
(
diù
), *
·»Á
, *
right
;

900 ià(
cu¼
->
Ëá
 !ğ
n
) {

901 
cu¼
 = cu¼->
Ëá
;

902 (
right
 = 
cu¼
->rightè!ğ
n
)

903 
cu¼
 = 
right
;

904  
cu¼
;

907 
·»Á
 = 
cu¼
->parent;

909 
·»Á
 !ğ
n
 && 
cu¼
 =ğ·»Á->
Ëá
) {

910 
cu¼
 = 
·»Á
;

911 
·»Á
 = 
cu¼
->parent;

914  (
·»Á
 =ğ
n
è? 
NULL
 :…arent;

915 
	}
}

917 
	$diù_®low_du³s
(
diù_t
 *
diù
)

919 
diù
->
du³s
 = 1;

920 
	}
}

922 #undeà
diù_couÁ


923 #undeà
diù_i£m±y


924 #undeà
diù_isfuÎ


925 #undeà
dnode_g‘


926 #undeà
dnode_put


927 #undeà
dnode_g‘key


929 
diùcouÁ_t
 
	$diù_couÁ
(
diù_t
 *
diù
)

931  
diù
->
nodecouÁ
;

932 
	}
}

934 
	$diù_i£m±y
(
diù_t
 *
diù
)

936  
diù
->
nodecouÁ
 == 0;

937 
	}
}

939 
	$diù_isfuÎ
(
diù_t
 *
diù
)

941  
diù
->
nodecouÁ
 =ğdiù->
maxcouÁ
;

942 
	}
}

944 
	$diù_cÚšs
(
diù_t
 *
diù
, 
dnode_t
 *
node
)

946  
	`v”ify_diù_has_node
(
	`diù_n
(
diù
), 
	`diù_roÙ
(diù), 
node
);

947 
	}
}

949 
dnode_t
 *
	$dnode_®loc
(*
cÚ‹xt
)

951  
	`m®loc
( *
	`dnode_®loc
(
NULL
));

952 
	}
}

954 
	$dnode_ä“
(
dnode_t
 *
node
, *
cÚ‹xt
)

956 
	`ä“
(
node
);

957 
	}
}

959 
dnode_t
 *
	$dnode_ü—‹
(*
d©a
)

961 
dnode_t
 *
Ãw
 = 
	`m®loc
( *new);

962 ià(
Ãw
) {

963 
Ãw
->
d©a
 = data;

964 
Ãw
->
·»Á
 = 
NULL
;

965 
Ãw
->
Ëá
 = 
NULL
;

966 
Ãw
->
right
 = 
NULL
;

968  
Ãw
;

969 
	}
}

971 
dnode_t
 *
	$dnode_š™
(
dnode_t
 *
dnode
, *
d©a
)

973 
dnode
->
d©a
 = data;

974 
dnode
->
·»Á
 = 
NULL
;

975 
dnode
->
Ëá
 = 
NULL
;

976 
dnode
->
right
 = 
NULL
;

977  
dnode
;

978 
	}
}

980 
	$dnode_de¡roy
(
dnode_t
 *
dnode
)

982 
	`as£¹
 (!
	`dnode_is_š_a_diù
(
dnode
));

983 
	`ä“
(
dnode
);

984 
	}
}

986 *
	$dnode_g‘
(
dnode_t
 *
dnode
)

988  
dnode
->
d©a
;

989 
	}
}

991 cÚ¡ *
	$dnode_g‘key
(
dnode_t
 *
dnode
)

993  
dnode
->
key
;

994 
	}
}

996 
	$dnode_put
(
dnode_t
 *
dnode
, *
d©a
)

998 
dnode
->
d©a
 = data;

999 
	}
}

1001 
	$dnode_is_š_a_diù
(
dnode_t
 *
dnode
)

1003  (
dnode
->
·»Á
 && dnode->
Ëá
 && dnode->
right
);

1004 
	}
}

1006 
	$diù_´oûss
(
diù_t
 *
diù
, *
cÚ‹xt
, 
dnode_´oûss_t
 
funùiÚ
)

1008 
dnode_t
 *
node
 = 
	`diù_fœ¡
(
diù
), *
Ãxt
;

1010 
node
 !ğ
NULL
) {

1013 
	`as£¹
 (
	`diù_cÚšs
(
diù
, 
node
));

1014 
Ãxt
 = 
	`diù_Ãxt
(
diù
, 
node
);

1015 
	`funùiÚ
(
diù
, 
node
, 
cÚ‹xt
);

1016 
node
 = 
Ãxt
;

1018 
	}
}

1020 
	$lßd_begš_š‹º®
(
diù_lßd_t
 *
lßd
, 
diù_t
 *
diù
)

1022 
lßd
->
diù±r
 = 
diù
;

1023 
lßd
->
nnode
.
Ëá
 = &load->nilnode;

1024 
lßd
->
nnode
.
right
 = &load->nilnode;

1025 
	}
}

1027 
	$diù_lßd_begš
(
diù_lßd_t
 *
lßd
, 
diù_t
 *
diù
)

1029 
	`as£¹
 (
	`diù_i£m±y
(
diù
));

1030 
	`lßd_begš_š‹º®
(
lßd
, 
diù
);

1031 
	}
}

1033 
	$diù_lßd_Ãxt
(
diù_lßd_t
 *
lßd
, 
dnode_t
 *
Ãwnode
, cÚ¡ *
key
)

1035 
diù_t
 *
diù
 = 
lßd
->
diù±r
;

1036 
dnode_t
 *
n
 = &
lßd
->
nnode
;

1038 
	`as£¹
 (!
	`dnode_is_š_a_diù
(
Ãwnode
));

1039 
	`as£¹
 (
diù
->
nodecouÁ
 < diù->
maxcouÁ
);

1041 #iâdeà
NDEBUG


1042 ià(
diù
->
nodecouÁ
 > 0) {

1043 ià(
diù
->
du³s
)

1044 
	`as£¹
 (
diù
->
	`com·»
(
n
->
Ëá
->
key
, key) <= 0);

1046 
	`as£¹
 (
diù
->
	`com·»
(
n
->
Ëá
->
key
, key) < 0);

1050 
Ãwnode
->
key
 = key;

1051 
n
->
right
->
Ëá
 = 
Ãwnode
;

1052 
n
->
right
 = 
Ãwnode
;

1053 
Ãwnode
->
Ëá
 = 
n
;

1054 
diù
->
nodecouÁ
++;

1055 
	}
}

1057 
	$diù_lßd_’d
(
diù_lßd_t
 *
lßd
)

1059 
diù_t
 *
diù
 = 
lßd
->
diù±r
;

1060 
dnode_t
 *
Œ“
[
DICT_DEPTH_MAX
] = { 0 };

1061 
dnode_t
 *
cu¼
, *
diùn
 = 
	`diù_n
(
diù
), *
lßdn
 = &
lßd
->
nnode
, *
Ãxt
;

1062 
dnode_t
 *
com¶‘e
 = 0;

1063 
diùcouÁ_t
 
fuÎcouÁ
 = 
DICTCOUNT_T_MAX
, 
nodecouÁ
 = 
diù
->nodecount;

1064 
diùcouÁ_t
 
bÙrowcouÁ
;

1065 
ba£Ëv–
 = 0, 
Ëv–
 = 0, 
i
;

1067 
	`as£¹
 (
dnode_»d
 =ğ0 && 
dnode_bÏck
 == 1);

1069 
fuÎcouÁ
 >ğ
nodecouÁ
 && fullcount)

1070 
fuÎcouÁ
 >>= 1;

1072 
bÙrowcouÁ
 = 
nodecouÁ
 - 
fuÎcouÁ
;

1074 
cu¼
 = 
lßdn
->
Ëá
; cu¼ !ğlßdn; cu¼ = 
Ãxt
) {

1075 
Ãxt
 = 
cu¼
->
Ëá
;

1077 ià(
com¶‘e
 =ğ
NULL
 && 
bÙrowcouÁ
-- == 0) {

1078 
	`as£¹
 (
ba£Ëv–
 == 0);

1079 
	`as£¹
 (
Ëv–
 == 0);

1080 
ba£Ëv–
 = 
Ëv–
 = 1;

1081 
com¶‘e
 = 
Œ“
[0];

1083 ià(
com¶‘e
 != 0) {

1084 
Œ“
[0] = 0;

1085 
com¶‘e
->
right
 = 
diùn
;

1086 
Œ“
[
Ëv–
] != 0) {

1087 
Œ“
[
Ëv–
]->
right
 = 
com¶‘e
;

1088 
com¶‘e
->
·»Á
 = 
Œ“
[
Ëv–
];

1089 
com¶‘e
 = 
Œ“
[
Ëv–
];

1090 
Œ“
[
Ëv–
++] = 0;

1095 ià(
com¶‘e
 =ğ
NULL
) {

1096 
cu¼
->
Ëá
 = 
diùn
;

1097 
cu¼
->
right
 = 
diùn
;

1098 
cu¼
->
cŞÜ
 = 
Ëv–
 % 2;

1099 
com¶‘e
 = 
cu¼
;

1101 
	`as£¹
 (
Ëv–
 =ğ
ba£Ëv–
);

1102 
Œ“
[
Ëv–
] != 0) {

1103 
Œ“
[
Ëv–
]->
right
 = 
com¶‘e
;

1104 
com¶‘e
->
·»Á
 = 
Œ“
[
Ëv–
];

1105 
com¶‘e
 = 
Œ“
[
Ëv–
];

1106 
Œ“
[
Ëv–
++] = 0;

1109 
cu¼
->
Ëá
 = 
com¶‘e
;

1110 
cu¼
->
cŞÜ
 = (
Ëv–
 + 1) % 2;

1111 
com¶‘e
->
·»Á
 = 
cu¼
;

1112 
Œ“
[
Ëv–
] = 
cu¼
;

1113 
com¶‘e
 = 0;

1114 
Ëv–
 = 
ba£Ëv–
;

1118 ià(
com¶‘e
 =ğ
NULL
)

1119 
com¶‘e
 = 
diùn
;

1121 
i
 = 0; i < 
DICT_DEPTH_MAX
; i++) {

1122 ià(
Œ“
[
i
] != 0) {

1123 
Œ“
[
i
]->
right
 = 
com¶‘e
;

1124 
com¶‘e
->
·»Á
 = 
Œ“
[
i
];

1125 
com¶‘e
 = 
Œ“
[
i
];

1129 
diùn
->
cŞÜ
 = 
dnode_bÏck
;

1130 
diùn
->
right
 = dictnil;

1131 
com¶‘e
->
·»Á
 = 
diùn
;

1132 
com¶‘e
->
cŞÜ
 = 
dnode_bÏck
;

1133 
	`diù_roÙ
(
diù
èğ
com¶‘e
;

1135 
	`as£¹
 (
	`diù_v”ify
(
diù
));

1136 
	}
}

1138 
	$diù_m”ge
(
diù_t
 *
de¡
, diù_ˆ*
sourû
)

1140 
diù_lßd_t
 
lßd
;

1141 
dnode_t
 *
Ëánode
 = 
	`diù_fœ¡
(
de¡
), *
righŠode
 = diù_fœ¡(
sourû
);

1143 
	`as£¹
 (
	`diù_sim¬
(
de¡
, 
sourû
));

1145 ià(
sourû
 =ğ
de¡
)

1148 
de¡
->
nodecouÁ
 = 0;

1149 
	`lßd_begš_š‹º®
(&
lßd
, 
de¡
);

1152 ià(
Ëánode
 !ğ
NULL
 && 
righŠode
 != NULL) {

1153 ià(
de¡
->
	`com·»
(
Ëánode
->
key
, 
righŠode
->key) < 0)

1154 
cİyËá
;

1156 
cİyright
;

1157 } ià(
Ëánode
 !ğ
NULL
) {

1158 
cİyËá
;

1159 } ià(
righŠode
 !ğ
NULL
) {

1160 
cİyright
;

1162 
	`as£¹
 (
Ëánode
 =ğ
NULL
 && 
righŠode
 == NULL);

1166 
cİyËá
:

1168 
dnode_t
 *
Ãxt
 = 
	`diù_Ãxt
(
de¡
, 
Ëánode
);

1169 #iâdeà
NDEBUG


1170 
Ëánode
->
Ëá
 = 
NULL
;

1172 
	`diù_lßd_Ãxt
(&
lßd
, 
Ëánode
,†eánode->
key
);

1173 
Ëánode
 = 
Ãxt
;

1177 
cİyright
:

1179 
dnode_t
 *
Ãxt
 = 
	`diù_Ãxt
(
sourû
, 
righŠode
);

1180 #iâdeà
NDEBUG


1181 
righŠode
->
Ëá
 = 
NULL
;

1183 
	`diù_lßd_Ãxt
(&
lßd
, 
righŠode
,„ighŠode->
key
);

1184 
righŠode
 = 
Ãxt
;

1189 
	`diù_ş—r
(
sourû
);

1190 
	`diù_lßd_’d
(&
lßd
);

1191 
	}
}

	@tools/src/adt/dict.h

1 #undeà
KAZLIB_OPAQUE_DEBUG


23 #iâdeà
DICT_H


24 
	#DICT_H


	)

26 
	~<lim™s.h
>

27 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


28 
	~"sfx.h
"

35 #ifdeà
__ılu¥lus


39 
	tdiùcouÁ_t
;

40 
	#DICTCOUNT_T_MAX
 
ULONG_MAX


	)

46 ’um { 
dnode_»d
, 
dnode_bÏck
 } 
	tdnode_cŞÜ_t
;

48 
	sdnode_t
 {

49 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

50 
dnode_t
 *
diù_Ëá
;

51 
dnode_t
 *
diù_right
;

52 
dnode_t
 *
diù_·»Á
;

53 
dnode_cŞÜ_t
 
diù_cŞÜ
;

54 cÚ¡ *
diù_key
;

55 *
diù_d©a
;

57 
diù_dummy
;

59 } 
	tdnode_t
;

61 (*
diù_comp_t
)(const *, const *);

62 
dnode_t
 *(*
	tdnode_®loc_t
)(*);

63 (*
dnode_ä“_t
)(
	tdnode_t
 *, *);

65 
	sdiù_t
 {

66 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

67 
dnode_t
 
diù_nnode
;

68 
diùcouÁ_t
 
diù_nodecouÁ
;

69 
diùcouÁ_t
 
diù_maxcouÁ
;

70 
diù_comp_t
 
diù_com·»
;

71 
dnode_®loc_t
 
diù_®loúode
;

72 
dnode_ä“_t
 
diù_ä“node
;

73 *
diù_cÚ‹xt
;

74 
diù_du³s
;

76 
diù_dummmy
;

78 } 
	tdiù_t
;

80 (*
dnode_´oûss_t
)(
	tdiù_t
 *, 
	tdnode_t
 *, *);

82 
	sdiù_lßd_t
 {

83 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

84 
diù_t
 *
diù_diù±r
;

85 
dnode_t
 
diù_nnode
;

87 
diù_dummmy
;

89 } 
	tdiù_lßd_t
;

91 
diù_t
 *
diù_ü—‹
(
diùcouÁ_t
, 
diù_comp_t
);

92 
diù_£t_®loÿtÜ
(
diù_t
 *, 
dnode_®loc_t
, 
dnode_ä“_t
, *);

93 
diù_de¡roy
(
diù_t
 *);

94 
diù_ä“_nodes
(
diù_t
 *);

95 
diù_ä“
(
diù_t
 *);

96 
diù_t
 *
diù_š™
(diù_ˆ*, 
diùcouÁ_t
, 
diù_comp_t
);

97 
diù_š™_like
(
diù_t
 *, const dict_t *);

98 
diù_v”ify
(
diù_t
 *);

99 
diù_sim¬
(cÚ¡ 
diù_t
 *, const dict_t *);

100 
dnode_t
 *
diù_lookup
(
diù_t
 *, const *);

101 
dnode_t
 *
diù_low”_bound
(
diù_t
 *, const *);

102 
dnode_t
 *
diù_uµ”_bound
(
diù_t
 *, const *);

103 
diù_š£¹
(
diù_t
 *, 
dnode_t
 *, const *);

104 
dnode_t
 *
diù_d–‘e
(
diù_t
 *, dnode_t *);

105 
diù_®loc_š£¹
(
diù_t
 *, const *, *);

106 
diù_d–‘e_ä“
(
diù_t
 *, 
dnode_t
 *);

107 
dnode_t
 *
diù_fœ¡
(
diù_t
 *);

108 
dnode_t
 *
diù_Ï¡
(
diù_t
 *);

109 
dnode_t
 *
diù_Ãxt
(
diù_t
 *, dnode_t *);

110 
dnode_t
 *
diù_´ev
(
diù_t
 *, dnode_t *);

111 
diùcouÁ_t
 
diù_couÁ
(
diù_t
 *);

112 
diù_i£m±y
(
diù_t
 *);

113 
diù_isfuÎ
(
diù_t
 *);

114 
diù_cÚšs
(
diù_t
 *, 
dnode_t
 *);

115 
diù_®low_du³s
(
diù_t
 *);

116 
dnode_is_š_a_diù
(
dnode_t
 *);

117 
dnode_t
 *
dnode_ü—‹
(*);

118 
dnode_t
 *
dnode_š™
(dnode_t *, *);

119 
dnode_de¡roy
(
dnode_t
 *);

120 *
dnode_g‘
(
dnode_t
 *);

121 cÚ¡ *
dnode_g‘key
(
dnode_t
 *);

122 
dnode_put
(
dnode_t
 *, *);

123 
diù_´oûss
(
diù_t
 *, *, 
dnode_´oûss_t
);

124 
diù_lßd_begš
(
diù_lßd_t
 *, 
diù_t
 *);

125 
diù_lßd_Ãxt
(
diù_lßd_t
 *, 
dnode_t
 *, const *);

126 
diù_lßd_’d
(
diù_lßd_t
 *);

127 
diù_m”ge
(
diù_t
 *, dict_t *);

129 #ià
defšed
(
DICT_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

130 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


131 
	#diù_isfuÎ
(
D
è(
	`SFX_CHECK
(D)->
diù_nodecouÁ
 =ğ(D)->
diù_maxcouÁ
)

	)

133 
	#diù_isfuÎ
(
D
è((D)->
diù_nodecouÁ
 =ğ(D)->
diù_maxcouÁ
)

	)

135 
	#diù_couÁ
(
D
è((D)->
diù_nodecouÁ
)

	)

136 
	#diù_i£m±y
(
D
è((D)->
diù_nodecouÁ
 =ğ0)

	)

137 
	#dnode_g‘
(
N
è((N)->
diù_d©a
)

	)

138 
	#dnode_g‘key
(
N
è((N)->
diù_key
)

	)

139 
	#dnode_put
(
N
, 
X
è((N)->
diù_d©a
 = (X))

	)

142 #ifdeà
__ılu¥lus


	@tools/src/adt/hash.c

21 
	~<¡dlib.h
>

22 
	~<¡ddef.h
>

23 
	~<as£¹.h
>

24 
	~<¡ršg.h
>

25 
	#HASH_IMPLEMENTATION


	)

26 
	~"hash.h
"

28 #ifdeà
KAZLIB_RCSID


29 cÚ¡ 
	grcsid
[] = "$Id: hash.c,v 1.36.2.11 2000/11/13 01:36:45 kaz Exp $";

32 
	#INIT_BITS
 6

	)

33 
	#INIT_SIZE
 (1UL << (
INIT_BITS
)è

	)

34 
	#INIT_MASK
 ((
INIT_SIZE
è- 1)

	)

36 
	#Ãxt
 
hash_Ãxt


	)

37 
	#key
 
hash_key


	)

38 
	#d©a
 
hash_d©a


	)

39 
	#hkey
 
hash_hkey


	)

41 
	#bË
 
hash_bË


	)

42 
	#nchašs
 
hash_nchašs


	)

43 
	#nodecouÁ
 
hash_nodecouÁ


	)

44 
	#maxcouÁ
 
hash_maxcouÁ


	)

45 
	#highm¬k
 
hash_highm¬k


	)

46 
	#lowm¬k
 
hash_lowm¬k


	)

47 
	#com·»
 
hash_com·»


	)

48 
	#funùiÚ
 
hash_funùiÚ


	)

49 
	#®loúode
 
hash_®loúode


	)

50 
	#ä“node
 
hash_ä“node


	)

51 
	#cÚ‹xt
 
hash_cÚ‹xt


	)

52 
	#mask
 
hash_mask


	)

53 
	#dyÇmic
 
hash_dyÇmic


	)

55 
	#bË
 
hash_bË


	)

56 
	#chaš
 
hash_chaš


	)

58 
hnode_t
 *
hnode_®loc
(*
cÚ‹xt
);

59 
hnode_ä“
(
hnode_t
 *
node
, *
cÚ‹xt
);

60 
hash_v®_t
 
hash_fun_deçuÉ
(cÚ¡ *
key
);

61 
hash_comp_deçuÉ
(cÚ¡ *
key1
, cÚ¡ *
key2
);

80 
Fixed
 
our
 
	gu§ge
 -
josh


81 
	$compu‹_b™s
()

83 
hash_v®_t
 
v®
 = 
HASH_VAL_T_MAX
;

84 
b™s
 = 0;

86 
v®
) {

87 
b™s
++;

88 
v®
 >>= 1;

91 
hash_v®_t_b™
 = 
b™s
;

92 
	}
}

99 
	$is_pow”_of_two
(
hash_v®_t
 
¬g
)

101 ià(
¬g
 == 0)

103 (
¬g
 & 1) == 0)

104 
¬g
 >>= 1;

105  (
¬g
 == 1);

106 
	}
}

112 
hash_v®_t
 
	$compu‹_mask
(
hashcouÁ_t
 
size
)

114 
	`as£¹
 (
	`is_pow”_of_two
(
size
));

115 
	`as£¹
 (
size
 >= 2);

117  
size
 - 1;

118 
	}
}

124 
	$ş—r_bË
(
hash_t
 *
hash
)

126 
hash_v®_t
 
i
;

128 
i
 = 0; i < 
hash
->
nchašs
; i++)

129 
hash
->
bË
[
i
] = 
NULL
;

130 
	}
}

160 
	$grow_bË
(
hash_t
 *
hash
)

162 
hnode_t
 **
ÃwbË
;

164 
	`as£¹
 (2 * 
hash
->
nchašs
 > hash->nchains);

166 
ÃwbË
 = 
	`»®loc
(
hash
->
bË
,

167  *
ÃwbË
 * 
hash
->
nchašs
 * 2);

169 ià(
ÃwbË
) {

170 
hash_v®_t
 
mask
 = (
hash
->mask << 1) | 1;

171 
hash_v®_t
 
expo£d_b™
 = 
mask
 ^ 
hash
->mask;

172 
hash_v®_t
 
chaš
;

174 
	`as£¹
 (
mask
 !ğ
hash
->mask);

176 
chaš
 = 0; chaš < 
hash
->
nchašs
; chain++) {

177 
hnode_t
 *
low_chaš
 = 0, *
high_chaš
 = 0, *
h±r
, *
Ãxt
;

179 
h±r
 = 
ÃwbË
[
chaš
]; h±¸!ğ0; h±¸ğ
Ãxt
) {

180 
Ãxt
 = 
h±r
->next;

182 ià(
h±r
->
hkey
 & 
expo£d_b™
) {

183 
h±r
->
Ãxt
 = 
high_chaš
;

184 
high_chaš
 = 
h±r
;

186 
h±r
->
Ãxt
 = 
low_chaš
;

187 
low_chaš
 = 
h±r
;

191 
ÃwbË
[
chaš
] = 
low_chaš
;

192 
ÃwbË
[
chaš
 + 
hash
->
nchašs
] = 
high_chaš
;

195 
hash
->
bË
 = 
ÃwbË
;

196 
hash
->
mask
 = mask;

197 
hash
->
nchašs
 *= 2;

198 
hash
->
lowm¬k
 *= 2;

199 
hash
->
highm¬k
 *= 2;

201 
	`as£¹
 (
	`hash_v”ify
(
hash
));

202 
	}
}

234 
	$shršk_bË
(
hash_t
 *
hash
)

236 
hash_v®_t
 
chaš
, 
nchašs
;

237 
hnode_t
 **
ÃwbË
, *
low_
, *
low_chaš
, *
high_chaš
;

239 
	`as£¹
 (
hash
->
nchašs
 >= 2);

240 
nchašs
 = 
hash
->nchains / 2;

242 
chaš
 = 0; chaš < 
nchašs
; chain++) {

243 
low_chaš
 = 
hash
->
bË
[
chaš
];

244 
high_chaš
 = 
hash
->
bË
[
chaš
 + 
nchašs
];

245 
low_
 = 
low_chaš
;†ow_ &&†ow_->
Ãxt
;†ow_tail =†ow_tail->next)

247 ià(
low_chaš
 != 0)

248 
low_
->
Ãxt
 = 
high_chaš
;

249 ià(
high_chaš
 != 0)

250 
hash
->
bË
[
chaš
] = 
high_chaš
;

252 
	`as£¹
 (
hash
->
bË
[
chaš
] =ğ
NULL
);

254 
ÃwbË
 = 
	`»®loc
(
hash
->
bË
,

255  *
ÃwbË
 * 
nchašs
);

256 ià(
ÃwbË
)

257 
hash
->
bË
 = 
ÃwbË
;

258 
hash
->
mask
 >>= 1;

259 
hash
->
nchašs
 =‚chains;

260 
hash
->
lowm¬k
 /= 2;

261 
hash
->
highm¬k
 /= 2;

262 
	`as£¹
 (
	`hash_v”ify
(
hash
));

263 
	}
}

295 
hash_t
 *
	$hash_ü—‹
(
hashcouÁ_t
 
maxcouÁ
, 
hash_comp_t
 
compfun
,

296 
hash_fun_t
 
hashfun
)

298 
hash_t
 *
hash
;

304 
hash
 = 
	`m®loc
( *hash);

306 ià(
hash
) {

307 
hash
->
bË
 = 
	`m®loc
( *hash->bË * 
INIT_SIZE
);

308 ià(
hash
->
bË
) {

309 
hash
->
nchašs
 = 
INIT_SIZE
;

310 
hash
->
highm¬k
 = 
INIT_SIZE
 * 2;

311 
hash
->
lowm¬k
 = 
INIT_SIZE
 / 2;

312 
hash
->
nodecouÁ
 = 0;

313 
hash
->
maxcouÁ
 = maxcount;

314 
hash
->
com·»
 = 
compfun
 ? compfuÀ: 
hash_comp_deçuÉ
;

315 
hash
->
funùiÚ
 = 
hashfun
 ? hashfuÀ: 
hash_fun_deçuÉ
;

316 
hash
->
®loúode
 = 
hnode_®loc
;

317 
hash
->
ä“node
 = 
hnode_ä“
;

318 
hash
->
cÚ‹xt
 = 
NULL
;

319 
hash
->
mask
 = 
INIT_MASK
;

320 
hash
->
dyÇmic
 = 1;

321 
	`ş—r_bË
(
hash
);

322 
	`as£¹
 (
	`hash_v”ify
(
hash
));

323  
hash
;

325 
	`ä“
(
hash
);

328  
NULL
;

329 
	}
}

335 
	$hash_£t_®loÿtÜ
(
hash_t
 *
hash
, 
hnode_®loc_t
 
®
,

336 
hnode_ä“_t
 
ä
, *
cÚ‹xt
)

338 
	`as£¹
 (
	`hash_couÁ
(
hash
) == 0);

339 
	`as£¹
 ((
®
 =ğ0 && 
ä
 == 0) || (al != 0 && fr != 0));

341 
hash
->
®loúode
 = 
®
 ?‡È: 
hnode_®loc
;

342 
hash
->
ä“node
 = 
ä
 ? f¸: 
hnode_ä“
;

343 
hash
->
cÚ‹xt
 = context;

344 
	}
}

351 
	$hash_ä“_nodes
(
hash_t
 *
hash
)

353 
hsÿn_t
 
hs
;

354 
hnode_t
 *
node
;

355 
	`hash_sÿn_begš
(&
hs
, 
hash
);

356 (
node
 = 
	`hash_sÿn_Ãxt
(&
hs
))) {

357 
	`hash_sÿn_d–‘e
(
hash
, 
node
);

358 
hash
->
	`ä“node
(
node
, hash->
cÚ‹xt
);

360 
hash
->
nodecouÁ
 = 0;

361 
	`ş—r_bË
(
hash
);

362 
	}
}

369 
	$hash_ä“
(
hash_t
 *
hash
)

371 #ifdeà
KAZLIB_OBSOLESCENT_DEBUG


372 
	`as£¹
 ("callo obsolescent function hash_free()" && 0);

374 
	`hash_ä“_nodes
(
hash
);

375 
	`hash_de¡roy
(
hash
);

376 
	}
}

382 
	$hash_de¡roy
(
hash_t
 *
hash
)

384 
	`as£¹
 (
hash_v®_t_b™
 != 0);

385 
	`as£¹
 (
	`hash_i£m±y
(
hash
));

386 
	`ä“
(
hash
->
bË
);

387 
	`ä“
(
hash
);

388 
	}
}

403 
hash_t
 *
	$hash_š™
(
hash_t
 *
hash
, 
hashcouÁ_t
 
maxcouÁ
,

404 
hash_comp_t
 
compfun
, 
hash_fun_t
 
hashfun
, 
hnode_t
 **
bË
,

405 
hashcouÁ_t
 
nchašs
)

411 
	`as£¹
 (
	`is_pow”_of_two
(
nchašs
));

413 
hash
->
bË
 =able;

414 
hash
->
nchašs
 =‚chains;

415 
hash
->
nodecouÁ
 = 0;

416 
hash
->
maxcouÁ
 = maxcount;

417 
hash
->
com·»
 = 
compfun
 ? compfuÀ: 
hash_comp_deçuÉ
;

418 
hash
->
funùiÚ
 = 
hashfun
 ? hashfuÀ: 
hash_fun_deçuÉ
;

419 
hash
->
dyÇmic
 = 0;

420 
hash
->
mask
 = 
	`compu‹_mask
(
nchašs
);

421 
	`ş—r_bË
(
hash
);

423 
	`as£¹
 (
	`hash_v”ify
(
hash
));

425  
hash
;

426 
	}
}

439 
	$hash_sÿn_begš
(
hsÿn_t
 *
sÿn
, 
hash_t
 *
hash
)

441 
hash_v®_t
 
nchašs
 = 
hash
->nchains;

442 
hash_v®_t
 
chaš
;

444 
sÿn
->
bË
 = 
hash
;

448 
chaš
 = 0; chaš < 
nchašs
 && 
hash
->
bË
[chain] == 0; chain++)

451 ià(
chaš
 < 
nchašs
) {

452 
sÿn
->
chaš
 = chain;

453 
sÿn
->
Ãxt
 = 
hash
->
bË
[
chaš
];

455 
sÿn
->
Ãxt
 = 
NULL
;

457 
	}
}

485 
hnode_t
 *
	$hash_sÿn_Ãxt
(
hsÿn_t
 *
sÿn
)

487 
hnode_t
 *
Ãxt
 = 
sÿn
->next;

488 
hash_t
 *
hash
 = 
sÿn
->
bË
;

489 
hash_v®_t
 
chaš
 = 
sÿn
->chain + 1;

490 
hash_v®_t
 
nchašs
 = 
hash
->nchains;

492 
	`as£¹
 (
hash_v®_t_b™
 != 0);

494 ià(
Ãxt
) {

495 ià(
Ãxt
->next) {

496 
sÿn
->
Ãxt
 =‚ext->next;

498 
chaš
 < 
nchašs
 && 
hash
->
bË
[chain] == 0)

499 
chaš
++;

500 ià(
chaš
 < 
nchašs
) {

501 
sÿn
->
chaš
 = chain;

502 
sÿn
->
Ãxt
 = 
hash
->
bË
[
chaš
];

504 
sÿn
->
Ãxt
 = 
NULL
;

508  
Ãxt
;

509 
	}
}

524 
	$hash_š£¹
(
hash_t
 *
hash
, 
hnode_t
 *
node
, cÚ¡ *
key
)

526 
hash_v®_t
 
hkey
, 
chaš
;

528 
	`as£¹
 (
hash_v®_t_b™
 != 0);

529 
	`as£¹
 (
node
->
Ãxt
 =ğ
NULL
);

530 
	`as£¹
 (
hash
->
nodecouÁ
 < hash->
maxcouÁ
);

531 
	`as£¹
 (
	`hash_lookup
(
hash
, 
key
è=ğ
NULL
);

533 ià(
hash
->
dyÇmic
 && hash->
nodecouÁ
 >ğhash->
highm¬k
)

534 
	`grow_bË
(
hash
);

536 
hkey
 = 
hash
->
	`funùiÚ
(
key
);

537 
chaš
 = 
hkey
 & 
hash
->
mask
;

539 
node
->
key
 = key;

540 
node
->
hkey
 = hkey;

541 
node
->
Ãxt
 = 
hash
->
bË
[
chaš
];

542 
hash
->
bË
[
chaš
] = 
node
;

543 
hash
->
nodecouÁ
++;

545 
	`as£¹
 (
	`hash_v”ify
(
hash
));

546 
	}
}

562 
hnode_t
 *
	$hash_lookup
(
hash_t
 *
hash
, cÚ¡ *
key
)

564 
hash_v®_t
 
hkey
, 
chaš
;

565 
hnode_t
 *
ÅŒ
;

567 
hkey
 = 
hash
->
	`funùiÚ
(
key
);

568 
chaš
 = 
hkey
 & 
hash
->
mask
;

570 
ÅŒ
 = 
hash
->
bË
[
chaš
];‚±r;‚±¸ğÅŒ->
Ãxt
) {

571 ià(
ÅŒ
->
hkey
 =ğhkey && 
hash
->
	`com·»
Ò±r->
key
, key) == 0)

572  
ÅŒ
;

575  
NULL
;

576 
	}
}

596 
hnode_t
 *
	$hash_d–‘e
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

598 
hash_v®_t
 
chaš
;

599 
hnode_t
 *
h±r
;

601 
	`as£¹
 (
	`hash_lookup
(
hash
, 
node
->
key
) ==‚ode);

602 
	`as£¹
 (
hash_v®_t_b™
 != 0);

604 ià(
hash
->
dyÇmic
 && hash->
nodecouÁ
 <ğhash->
lowm¬k


605 && 
hash
->
nodecouÁ
 > 
INIT_SIZE
)

606 
	`shršk_bË
(
hash
);

608 
chaš
 = 
node
->
hkey
 & 
hash
->
mask
;

609 
h±r
 = 
hash
->
bË
[
chaš
];

611 ià(
h±r
 =ğ
node
) {

612 
hash
->
bË
[
chaš
] = 
node
->
Ãxt
;

614 
h±r
->
Ãxt
 !ğ
node
) {

615 
	`as£¹
 (
h±r
 != 0);

616 
h±r
 = h±r->
Ãxt
;

618 
	`as£¹
 (
h±r
->
Ãxt
 =ğ
node
);

619 
h±r
->
Ãxt
 = 
node
->next;

622 
hash
->
nodecouÁ
--;

623 
	`as£¹
 (
	`hash_v”ify
(
hash
));

625 
node
->
Ãxt
 = 
NULL
;

626  
node
;

627 
	}
}

629 
	$hash_®loc_š£¹
(
hash_t
 *
hash
, cÚ¡ *
key
, *
d©a
)

631 
hnode_t
 *
node
 = 
hash
->
	`®loúode
(hash->
cÚ‹xt
);

633 ià(
node
) {

634 
	`hnode_š™
(
node
, 
d©a
);

635 
	`hash_š£¹
(
hash
, 
node
, 
key
);

639 
	}
}

641 
	$hash_d–‘e_ä“
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

643 
	`hash_d–‘e
(
hash
, 
node
);

644 
hash
->
	`ä“node
(
node
, hash->
cÚ‹xt
);

645 
	}
}

652 
hnode_t
 *
	$hash_sÿn_d–‘e
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

654 
hash_v®_t
 
chaš
;

655 
hnode_t
 *
h±r
;

657 
	`as£¹
 (
	`hash_lookup
(
hash
, 
node
->
key
) ==‚ode);

658 
	`as£¹
 (
hash_v®_t_b™
 != 0);

660 
chaš
 = 
node
->
hkey
 & 
hash
->
mask
;

661 
h±r
 = 
hash
->
bË
[
chaš
];

663 ià(
h±r
 =ğ
node
) {

664 
hash
->
bË
[
chaš
] = 
node
->
Ãxt
;

666 
h±r
->
Ãxt
 !ğ
node
)

667 
h±r
 = h±r->
Ãxt
;

668 
h±r
->
Ãxt
 = 
node
->next;

671 
hash
->
nodecouÁ
--;

672 
	`as£¹
 (
	`hash_v”ify
(
hash
));

673 
node
->
Ãxt
 = 
NULL
;

675  
node
;

676 
	}
}

682 
	$hash_sÿn_d–ä“
(
hash_t
 *
hash
, 
hnode_t
 *
node
)

684 
	`hash_sÿn_d–‘e
(
hash
, 
node
);

685 
hash
->
	`ä“node
(
node
, hash->
cÚ‹xt
);

686 
	}
}

697 
	$hash_v”ify
(
hash_t
 *
hash
)

699 
hashcouÁ_t
 
couÁ
 = 0;

700 
hash_v®_t
 
chaš
;

701 
hnode_t
 *
h±r
;

703 ià(
hash
->
dyÇmic
) {

704 ià(
hash
->
lowm¬k
 >ğhash->
highm¬k
)

706 ià(!
	`is_pow”_of_two
(
hash
->
highm¬k
))

708 ià(!
	`is_pow”_of_two
(
hash
->
lowm¬k
))

712 
chaš
 = 0; chaš < 
hash
->
nchašs
; chain++) {

713 
h±r
 = 
hash
->
bË
[
chaš
]; h±¸!ğ0; h±¸ğh±r->
Ãxt
) {

714 ià((
h±r
->
hkey
 & 
hash
->
mask
è!ğ
chaš
)

716 
couÁ
++;

720 ià(
couÁ
 !ğ
hash
->
nodecouÁ
)

724 
	}
}

731 #undeà
hash_isfuÎ


732 
	$hash_isfuÎ
(
hash_t
 *
hash
)

734  
hash
->
nodecouÁ
 =ğhash->
maxcouÁ
;

735 
	}
}

742 #undeà
hash_i£m±y


743 
	$hash_i£m±y
(
hash_t
 *
hash
)

745  
hash
->
nodecouÁ
 == 0;

746 
	}
}

748 
hnode_t
 *
	$hnode_®loc
(*
cÚ‹xt
)

750  
	`m®loc
( *
	`hnode_®loc
(
NULL
));

751 
	}
}

753 
	$hnode_ä“
(
hnode_t
 *
node
, *
cÚ‹xt
)

755 
	`ä“
(
node
);

756 
	}
}

763 
hnode_t
 *
	$hnode_ü—‹
(*
d©a
)

765 
hnode_t
 *
node
 = 
	`m®loc
( *node);

766 ià(
node
) {

767 
node
->
d©a
 = data;

768 
node
->
Ãxt
 = 
NULL
;

770  
node
;

771 
	}
}

777 
hnode_t
 *
	$hnode_š™
(
hnode_t
 *
hnode
, *
d©a
)

779 
hnode
->
d©a
 = data;

780 
hnode
->
Ãxt
 = 
NULL
;

781  
hnode
;

782 
	}
}

788 
	$hnode_de¡roy
(
hnode_t
 *
hnode
)

790 
	`ä“
(
hnode
);

791 
	}
}

793 #undeà
hnode_put


794 
	$hnode_put
(
hnode_t
 *
node
, *
d©a
)

796 
node
->
d©a
 = data;

797 
	}
}

799 #undeà
hnode_g‘


800 *
	$hnode_g‘
(
hnode_t
 *
node
)

802  
node
->
d©a
;

803 
	}
}

805 #undeà
hnode_g‘key


806 cÚ¡ *
	$hnode_g‘key
(
hnode_t
 *
node
)

808  
node
->
key
;

809 
	}
}

811 #undeà
hash_couÁ


812 
hashcouÁ_t
 
	$hash_couÁ
(
hash_t
 *
hash
)

814  
hash
->
nodecouÁ
;

815 
	}
}

817 #undeà
hash_size


818 
hashcouÁ_t
 
	$hash_size
(
hash_t
 *
hash
)

820  
hash
->
nchašs
;

821 
	}
}

823 
hash_v®_t
 
	$hash_fun_deçuÉ
(cÚ¡ *
key
)

825 
¿ndbox
[] = {

832 cÚ¡ *
¡r
 = 
key
;

833 
hash_v®_t
 
acc
 = 0;

835 *
¡r
) {

836 
acc
 ^ğ
¿ndbox
[(*
¡r
 +‡cc) & 0xf];

837 
acc
 = (acc << 1) | (acc >> 31);

838 
acc
 &= 0xffffffffU;

839 
acc
 ^ğ
¿ndbox
[((*
¡r
++ >> 4) +‡cc) & 0xf];

840 
acc
 = (acc << 2) | (acc >> 30);

841 
acc
 &= 0xffffffffU;

843  
acc
;

844 
	}
}

846 
	$hash_comp_deçuÉ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

848  
	`¡rcmp
(
key1
, 
key2
);

849 
	}
}

	@tools/src/adt/hash.h

1 #undeà
KAZLIB_OPAQUE_DEBUG


23 #iâdeà
HASH_H


24 
	#HASH_H


	)

26 
	~<lim™s.h
>

27 
	~<¡dšt.h
>

29 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


30 
	~"sfx.h
"

37 #ifdeà
__ılu¥lus


41 
	thashcouÁ_t
;

42 
	#HASHCOUNT_T_MAX
 
ULONG_MAX


	)

44 
ušt32_t
 
	thash_v®_t
;

45 
	#HASH_VAL_T_MAX
 
UINT32_MAX


	)

47 cÚ¡ 
hash_v®_t_b™
 = 32;

49 #iâdeà
HASH_VAL_T_BIT


50 
	#HASH_VAL_T_BIT
 ((è
hash_v®_t_b™
)

	)

77 
	shnode_t
 {

78 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

79 
hnode_t
 *
hash_Ãxt
;

80 cÚ¡ *
hash_key
;

81 *
hash_d©a
;

82 
hash_v®_t
 
hash_hkey
;

84 
hash_dummy
;

86 } 
	thnode_t
;

95 (*
hash_comp_t
)(const *, const *);

109 
hash_v®_t
 (*
	thash_fun_t
)(const *);

115 
hnode_t
 *(*
	thnode_®loc_t
)(*);

116 (*
hnode_ä“_t
)(
	thnode_t
 *, *);

153 
	shash_t
 {

154 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

155 
hnode_t
 **
hash_bË
;

156 
hashcouÁ_t
 
hash_nchašs
;

157 
hashcouÁ_t
 
hash_nodecouÁ
;

158 
hashcouÁ_t
 
hash_maxcouÁ
;

159 
hashcouÁ_t
 
hash_highm¬k
;

160 
hashcouÁ_t
 
hash_lowm¬k
;

161 
hash_comp_t
 
hash_com·»
;

162 
hash_fun_t
 
hash_funùiÚ
;

163 
hnode_®loc_t
 
hash_®loúode
;

164 
hnode_ä“_t
 
hash_ä“node
;

165 *
hash_cÚ‹xt
;

166 
hash_v®_t
 
hash_mask
;

167 
hash_dyÇmic
;

169 
hash_dummy
;

171 } 
	thash_t
;

183 
	shsÿn_t
 {

184 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

185 
hash_t
 *
hash_bË
;

186 
hash_v®_t
 
hash_chaš
;

187 
hnode_t
 *
hash_Ãxt
;

189 
hash_dummy
;

191 } 
	thsÿn_t
;

193 
hash_t
 *
hash_ü—‹
(
hashcouÁ_t
, 
hash_comp_t
, 
hash_fun_t
);

194 
hash_£t_®loÿtÜ
(
hash_t
 *, 
hnode_®loc_t
, 
hnode_ä“_t
, *);

195 
hash_de¡roy
(
hash_t
 *);

196 
hash_ä“_nodes
(
hash_t
 *);

197 
hash_ä“
(
hash_t
 *);

198 
hash_t
 *
hash_š™
(hash_ˆ*, 
hashcouÁ_t
, 
hash_comp_t
,

199 
hash_fun_t
, 
hnode_t
 **, 
hashcouÁ_t
);

200 
hash_š£¹
(
hash_t
 *, 
hnode_t
 *, const *);

201 
hnode_t
 *
hash_lookup
(
hash_t
 *, const *);

202 
hnode_t
 *
hash_d–‘e
(
hash_t
 *, hnode_t *);

203 
hash_®loc_š£¹
(
hash_t
 *, const *, *);

204 
hash_d–‘e_ä“
(
hash_t
 *, 
hnode_t
 *);

206 
hnode_put
(
hnode_t
 *, *);

207 *
hnode_g‘
(
hnode_t
 *);

208 cÚ¡ *
hnode_g‘key
(
hnode_t
 *);

209 
hashcouÁ_t
 
hash_couÁ
(
hash_t
 *);

210 
hashcouÁ_t
 
hash_size
(
hash_t
 *);

212 
hash_isfuÎ
(
hash_t
 *);

213 
hash_i£m±y
(
hash_t
 *);

215 
hash_sÿn_begš
(
hsÿn_t
 *, 
hash_t
 *);

216 
hnode_t
 *
hash_sÿn_Ãxt
(
hsÿn_t
 *);

217 
hnode_t
 *
hash_sÿn_d–‘e
(
hash_t
 *, hnode_t *);

218 
hash_sÿn_d–ä“
(
hash_t
 *, 
hnode_t
 *);

220 
hash_v”ify
(
hash_t
 *);

222 
hnode_t
 *
hnode_ü—‹
(*);

223 
hnode_t
 *
hnode_š™
(hnode_t *, *);

224 
hnode_de¡roy
(
hnode_t
 *);

226 #ià
defšed
(
HASH_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

227 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


228 
	#hash_isfuÎ
(
H
è(
	`SFX_CHECK
(H)->
hash_nodecouÁ
 =ğ(H)->
hash_maxcouÁ
)

	)

230 
	#hash_isfuÎ
(
H
è((H)->
hash_nodecouÁ
 =ğ(H)->
hash_maxcouÁ
)

	)

232 
	#hash_i£m±y
(
H
è((H)->
hash_nodecouÁ
 =ğ0)

	)

233 
	#hash_couÁ
(
H
è((H)->
hash_nodecouÁ
)

	)

234 
	#hash_size
(
H
è((H)->
hash_nchašs
)

	)

235 
	#hnode_g‘
(
N
è((N)->
hash_d©a
)

	)

236 
	#hnode_g‘key
(
N
è((N)->
hash_key
)

	)

237 
	#hnode_put
(
N
, 
V
è((N)->
hash_d©a
 = (V))

	)

240 #ifdeà
__ılu¥lus


	@tools/src/adt/list.c

22 
	~<¡dlib.h
>

23 
	~<¡ddef.h
>

24 
	~<as£¹.h
>

25 
	#LIST_IMPLEMENTATION


	)

26 
	~"li¡.h
"

28 
	#Ãxt
 
li¡_Ãxt


	)

29 
	#´ev
 
li¡_´ev


	)

30 
	#d©a
 
li¡_d©a


	)

32 
	#poŞ
 
li¡_poŞ


	)

33 
	#äe
 
li¡_ä“


	)

34 
	#size
 
li¡_size


	)

36 
	#nnode
 
li¡_nnode


	)

37 
	#nodecouÁ
 
li¡_nodecouÁ


	)

38 
	#maxcouÁ
 
li¡_maxcouÁ


	)

40 
	#li¡_n
(
L
è(&(L)->
nnode
)

	)

41 
	#li¡_fœ¡_´iv
(
L
è((L)->
nnode
.
Ãxt
)

	)

42 
	#li¡_Ï¡_´iv
(
L
è((L)->
nnode
.
´ev
)

	)

43 
	#Êode_Ãxt
(
N
è((N)->
Ãxt
)

	)

44 
	#Êode_´ev
(
N
è((N)->
´ev
)

	)

46 #ifdeà
KAZLIB_RCSID


47 cÚ¡ 
	grcsid
[] = "$Id:†ist.c,v 1.19.2.1 2000/04/17 01:07:21 kaz Exp $";

57 
li¡_t
 *
	$li¡_š™
(
li¡_t
 *
li¡
, 
li¡couÁ_t
 
maxcouÁ
)

59 
	`as£¹
 (
maxcouÁ
 != 0);

60 
li¡
->
nnode
.
Ãxt
 = &list->nilnode;

61 
li¡
->
nnode
.
´ev
 = &list->nilnode;

62 
li¡
->
nodecouÁ
 = 0;

63 
li¡
->
maxcouÁ
 = maxcount;

64  
li¡
;

65 
	}
}

73 
li¡_t
 *
	$li¡_ü—‹
(
li¡couÁ_t
 
maxcouÁ
)

75 
li¡_t
 *
Ãw
 = 
	`m®loc
( *new);

76 ià(
Ãw
) {

77 
	`as£¹
 (
maxcouÁ
 != 0);

78 
Ãw
->
nnode
.
Ãxt
 = &new->nilnode;

79 
Ãw
->
nnode
.
´ev
 = &new->nilnode;

80 
Ãw
->
nodecouÁ
 = 0;

81 
Ãw
->
maxcouÁ
 = maxcount;

83  
Ãw
;

84 
	}
}

91 
	$li¡_de¡roy
(
li¡_t
 *
li¡
)

93 
	`as£¹
 (
	`li¡_i£m±y
(
li¡
));

94 
	`ä“
(
li¡
);

95 
	}
}

103 
	$li¡_de¡roy_nodes
(
li¡_t
 *
li¡
)

105 
Êode_t
 *
Êode
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
n
 = 
	`li¡_n
Öi¡), *
tmp
;

107 
Êode
 !ğ
n
) {

108 
tmp
 = 
Êode
->
Ãxt
;

109 
Êode
->
Ãxt
 = 
NULL
;

110 
Êode
->
´ev
 = 
NULL
;

111 
	`Êode_de¡roy
(
Êode
);

112 
Êode
 = 
tmp
;

115 
	`li¡_š™
(
li¡
,†i¡->
maxcouÁ
);

116 
	}
}

123 
	$li¡_»tuº_nodes
(
li¡_t
 *
li¡
, 
Êod•oŞ_t
 *
poŞ
)

125 
Êode_t
 *
Êode
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
tmp
, *
n
 = 
	`li¡_n
(list);

127 
Êode
 !ğ
n
) {

128 
tmp
 = 
Êode
->
Ãxt
;

129 
Êode
->
Ãxt
 = 
NULL
;

130 
Êode
->
´ev
 = 
NULL
;

131 
	`Êode_»tuº
(
poŞ
, 
Êode
);

132 
Êode
 = 
tmp
;

135 
	`li¡_š™
(
li¡
,†i¡->
maxcouÁ
);

136 
	}
}

142 
	$li¡_šs_aá”
(
li¡_t
 *
li¡
, 
Êode_t
 *
Ãw
,†node_ˆ*
this
)

144 
Êode_t
 *
th©
 = 
this
->
Ãxt
;

146 
	`as£¹
 (
Ãw
 !ğ
NULL
);

147 
	`as£¹
 (!
	`li¡_cÚšs
(
li¡
, 
Ãw
));

148 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
Ãw
));

149 
	`as£¹
 (
this
 =ğ
	`li¡_n
(
li¡
è|| 
	`li¡_cÚšs
(list,his));

150 
	`as£¹
 (
li¡
->
nodecouÁ
 + 1 >†ist->nodecount);

152 
Ãw
->
´ev
 = 
this
;

153 
Ãw
->
Ãxt
 = 
th©
;

154 
th©
->
´ev
 = 
Ãw
;

155 
this
->
Ãxt
 = 
Ãw
;

156 
li¡
->
nodecouÁ
++;

158 
	`as£¹
 (
li¡
->
nodecouÁ
 <ğli¡->
maxcouÁ
);

159 
	}
}

165 
	$li¡_šs_befÜe
(
li¡_t
 *
li¡
, 
Êode_t
 *
Ãw
,†node_ˆ*
this
)

167 
Êode_t
 *
th©
 = 
this
->
´ev
;

169 
	`as£¹
 (
Ãw
 !ğ
NULL
);

170 
	`as£¹
 (!
	`li¡_cÚšs
(
li¡
, 
Ãw
));

171 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
Ãw
));

172 
	`as£¹
 (
this
 =ğ
	`li¡_n
(
li¡
è|| 
	`li¡_cÚšs
(list,his));

173 
	`as£¹
 (
li¡
->
nodecouÁ
 + 1 >†ist->nodecount);

175 
Ãw
->
Ãxt
 = 
this
;

176 
Ãw
->
´ev
 = 
th©
;

177 
th©
->
Ãxt
 = 
Ãw
;

178 
this
->
´ev
 = 
Ãw
;

179 
li¡
->
nodecouÁ
++;

181 
	`as£¹
 (
li¡
->
nodecouÁ
 <ğli¡->
maxcouÁ
);

182 
	}
}

188 
Êode_t
 *
	$li¡_d–‘e
(
li¡_t
 *
li¡
, 
Êode_t
 *
d–
)

190 
Êode_t
 *
Ãxt
 = 
d–
->next;

191 
Êode_t
 *
´ev
 = 
d–
->prev;

193 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
d–
));

195 
´ev
->
Ãxt
 =‚ext;

196 
Ãxt
->
´ev
 =…rev;

197 
li¡
->
nodecouÁ
--;

199 
d–
->
Ãxt
 = d–->
´ev
 = 
NULL
;

201  
d–
;

202 
	}
}

210 
li¡_´oûss
(
li¡_t
 *
li¡
, *
cÚ‹xt
,

211 (* 
funùiÚ
)(
li¡_t
 *
li¡
, 
Êode_t
 *
Êode
, *
cÚ‹xt
))

213 
Êode_t
 *
node
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
Ãxt
, *
n
 = 
	`li¡_n
(list);

215 
node
 !ğ
n
) {

218 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
node
));

219 
Ãxt
 = 
node
->next;

220 
	`funùiÚ
(
li¡
, 
node
, 
cÚ‹xt
);

221 
node
 = 
Ãxt
;

223 
	}
}

229 
Êode_t
 *
	$Êode_ü—‹
(*
d©a
)

231 
Êode_t
 *
Ãw
 = 
	`m®loc
( *new);

232 ià(
Ãw
) {

233 
Ãw
->
d©a
 = data;

234 
Ãw
->
Ãxt
 = 
NULL
;

235 
Ãw
->
´ev
 = 
NULL
;

237  
Ãw
;

238 
	}
}

244 
Êode_t
 *
	$Êode_š™
(
Êode_t
 *
Êode
, *
d©a
)

246 
Êode
->
d©a
 = data;

247 
Êode
->
Ãxt
 = 
NULL
;

248 
Êode
->
´ev
 = 
NULL
;

249  
Êode
;

250 
	}
}

256 
	$Êode_de¡roy
(
Êode_t
 *
Êode
)

258 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
Êode
));

259 
	`ä“
(
Êode
);

260 
	}
}

268 
Êod•oŞ_t
 *
	$Êode_poŞ_š™
(
Êod•oŞ_t
 *
poŞ
, 
Êode_t
 *
nodes
, 
li¡couÁ_t
 
n
)

270 
li¡couÁ_t
 
i
;

272 
	`as£¹
 (
n
 != 0);

274 
poŞ
->poŞ = 
nodes
;

275 
poŞ
->
äe
 = 
nodes
;

276 
poŞ
->
size
 = 
n
;

277 
i
 = 0; i < 
n
 - 1; i++) {

278 
nodes
[
i
].
Ãxt
 =‚odes + i + 1;

280 
nodes
[
i
].
Ãxt
 = 
NULL
;

281 
nodes
[
i
].
´ev
 =‚odes;

282  
poŞ
;

283 
	}
}

289 
Êod•oŞ_t
 *
	$Êode_poŞ_ü—‹
(
li¡couÁ_t
 
n
)

291 
Êod•oŞ_t
 *
poŞ
;

292 
Êode_t
 *
nodes
;

294 
	`as£¹
 (
n
 != 0);

296 
poŞ
 = 
	`m®loc
( *pool);

297 ià(!
poŞ
)

298  
NULL
;

299 
nodes
 = 
	`m®loc
(
n
 *  *nodes);

300 ià(!
nodes
) {

301 
	`ä“
(
poŞ
);

302  
NULL
;

304 
	`Êode_poŞ_š™
(
poŞ
, 
nodes
, 
n
);

305  
poŞ
;

306 
	}
}

312 
	$Êode_poŞ_isäom
(
Êod•oŞ_t
 *
poŞ
, 
Êode_t
 *
node
)

314 
li¡couÁ_t
 
i
;

320 
i
 = 0; i < 
poŞ
->
size
; i++) {

321 ià(
poŞ
->poŞ + 
i
 =ğ
node
)

325 
	}
}

331 
	$Êode_poŞ_de¡roy
(
Êod•oŞ_t
 *
p
)

333 
	`ä“
(
p
->
poŞ
);

334 
	`ä“
(
p
);

335 
	}
}

342 
Êode_t
 *
	$Êode_bÜrow
(
Êod•oŞ_t
 *
poŞ
, *
d©a
)

344 
Êode_t
 *
Ãw
 = 
poŞ
->
äe
;

345 ià(
Ãw
) {

346 
poŞ
->
äe
 = 
Ãw
->
Ãxt
;

347 
Ãw
->
d©a
 = data;

348 
Ãw
->
Ãxt
 = 
NULL
;

349 
Ãw
->
´ev
 = 
NULL
;

351  
Ãw
;

352 
	}
}

359 
	$Êode_»tuº
(
Êod•oŞ_t
 *
poŞ
, 
Êode_t
 *
node
)

361 
	`as£¹
 (
	`Êode_poŞ_isäom
(
poŞ
, 
node
));

362 
	`as£¹
 (!
	`Êode_is_š_a_li¡
(
node
));

364 
node
->
Ãxt
 = 
poŞ
->
äe
;

365 
node
->
´ev
 =‚ode;

366 
poŞ
->
äe
 = 
node
;

367 
	}
}

374 
	$li¡_cÚšs
(
li¡_t
 *
li¡
, 
Êode_t
 *
node
)

376 
Êode_t
 *
n
, *
n
 = 
	`li¡_n
(
li¡
);

378 
n
 = 
	`li¡_fœ¡_´iv
(
li¡
);‚ !ğ
n
;‚ = 
	`Êode_Ãxt
(n)) {

379 ià(
node
 =ğ
n
)

384 
	}
}

392 
	$li¡_exŒaù
(
li¡_t
 *
de¡
,†i¡_ˆ*
sourû
, 
Êode_t
 *
fœ¡
,†node_ˆ*
Ï¡
)

394 
li¡couÁ_t
 
moved
 = 1;

396 
	`as£¹
 (
fœ¡
 =ğ
NULL
 || 
	`li¡_cÚšs
(
sourû
, first));

397 
	`as£¹
 (
Ï¡
 =ğ
NULL
 || 
	`li¡_cÚšs
(
sourû
,†ast));

399 ià(
fœ¡
 =ğ
NULL
 || 
Ï¡
 == NULL)

404 
fœ¡
->
´ev
->
Ãxt
 = 
Ï¡
->next;

405 
Ï¡
->
Ãxt
->
´ev
 = 
fœ¡
->prev;

409 
Ï¡
->
Ãxt
 = &
de¡
->
nnode
;

410 
fœ¡
->
´ev
 = 
de¡
->
nnode
.prev;

411 
de¡
->
nnode
.
´ev
->
Ãxt
 = 
fœ¡
;

412 
de¡
->
nnode
.
´ev
 = 
Ï¡
;

414 
fœ¡
 !ğ
Ï¡
) {

415 
fœ¡
 = fœ¡->
Ãxt
;

416 
	`as£¹
 (
fœ¡
 !ğ
	`li¡_n
(
sourû
));

417 
moved
++;

421 
	`as£¹
 (
sourû
->
nodecouÁ
 - 
moved
 <= source->nodecount);

422 
	`as£¹
 (
de¡
->
nodecouÁ
 + 
moved
 >= dest->nodecount);

425 
	`as£¹
 (
moved
 <ğ
sourû
->
nodecouÁ
);

427 
sourû
->
nodecouÁ
 -ğ
moved
;

428 
de¡
->
nodecouÁ
 +ğ
moved
;

431 
	`as£¹
 (
	`li¡_v”ify
(
sourû
));

432 
	`as£¹
 (
	`li¡_v”ify
(
de¡
));

433 
	}
}

444 
	$li¡_Œªsãr
(
li¡_t
 *
de¡
,†i¡_ˆ*
sourû
, 
Êode_t
 *
fœ¡
)

446 
li¡couÁ_t
 
moved
 = 1;

447 
Êode_t
 *
Ï¡
;

449 
	`as£¹
 (
fœ¡
 =ğ
NULL
 || 
	`li¡_cÚšs
(
sourû
, first));

451 ià(
fœ¡
 =ğ
NULL
)

454 
Ï¡
 = 
sourû
->
nnode
.
´ev
;

456 
sourû
->
nnode
.
´ev
 = 
fœ¡
->prev;

457 
fœ¡
->
´ev
->
Ãxt
 = &
sourû
->
nnode
;

459 
Ï¡
->
Ãxt
 = &
de¡
->
nnode
;

460 
fœ¡
->
´ev
 = 
de¡
->
nnode
.prev;

461 
de¡
->
nnode
.
´ev
->
Ãxt
 = 
fœ¡
;

462 
de¡
->
nnode
.
´ev
 = 
Ï¡
;

464 
fœ¡
 !ğ
Ï¡
) {

465 
fœ¡
 = fœ¡->
Ãxt
;

466 
moved
++;

470 
	`as£¹
 (
sourû
->
nodecouÁ
 - 
moved
 <= source->nodecount);

471 
	`as£¹
 (
de¡
->
nodecouÁ
 + 
moved
 >= dest->nodecount);

474 
	`as£¹
 (
moved
 <ğ
sourû
->
nodecouÁ
);

476 
sourû
->
nodecouÁ
 -ğ
moved
;

477 
de¡
->
nodecouÁ
 +ğ
moved
;

480 
	`as£¹
 (
	`li¡_v”ify
(
sourû
));

481 
	`as£¹
 (
	`li¡_v”ify
(
de¡
));

482 
	}
}

484 
li¡_m”ge
(
li¡_t
 *
de¡
,†i¡_ˆ*
sour
,

485 
	$com·»
 (const *, const *))

487 
Êode_t
 *
dn
, *
¢
, *
Š
;

488 
Êode_t
 *
d_n
 = 
	`li¡_n
(
de¡
), *
s_n
 =†i¡_n(
sour
);

491 ià(
de¡
 =ğ
sour
)

495 
	`as£¹
 (
	`li¡_couÁ
(
sour
è+†i¡_couÁ(
de¡
) >=†ist_count(sour));

498 
	`as£¹
 (
	`li¡_is_sÜ‹d
(
sour
, 
com·»
));

499 
	`as£¹
 (
	`li¡_is_sÜ‹d
(
de¡
, 
com·»
));

501 
dn
 = 
	`li¡_fœ¡_´iv
(
de¡
);

502 
¢
 = 
	`li¡_fœ¡_´iv
(
sour
);

504 
dn
 !ğ
d_n
 && 
¢
 !ğ
s_n
) {

505 ià(
	`com·»
(
	`Êode_g‘
(
dn
),†node_g‘(
¢
)) >= 0) {

506 
Š
 = 
	`Êode_Ãxt
(
¢
);

507 
	`li¡_d–‘e
(
sour
, 
¢
);

508 
	`li¡_šs_befÜe
(
de¡
, 
¢
, 
dn
);

509 
¢
 = 
Š
;

511 
dn
 = 
	`Êode_Ãxt
(dn);

515 ià(
dn
 !ğ
d_n
)

518 ià(
¢
 !ğ
s_n
)

519 
	`li¡_Œªsãr
(
de¡
, 
sour
, 
¢
);

520 
	}
}

522 
li¡_sÜt
(
li¡_t
 *
li¡
, 
	$com·»
(const *, const *))

524 
li¡_t
 
exŒa
;

525 
li¡couÁ_t
 
middË
;

526 
Êode_t
 *
node
;

528 ià(
	`li¡_couÁ
(
li¡
) > 1) {

529 
middË
 = 
	`li¡_couÁ
(
li¡
) / 2;

530 
node
 = 
	`li¡_fœ¡_´iv
(
li¡
);

532 
	`li¡_š™
(&
exŒa
, 
	`li¡_couÁ
(
li¡
è- 
middË
);

534 
middË
--)

535 
node
 = 
	`Êode_Ãxt
(node);

537 
	`li¡_Œªsãr
(&
exŒa
, 
li¡
, 
node
);

538 
	`li¡_sÜt
(
li¡
, 
com·»
);

539 
	`li¡_sÜt
(&
exŒa
, 
com·»
);

540 
	`li¡_m”ge
(
li¡
, &
exŒa
, 
com·»
);

542 
	`as£¹
 (
	`li¡_is_sÜ‹d
(
li¡
, 
com·»
));

543 
	}
}

545 
Êode_t
 *
li¡_fšd
(
li¡_t
 *
li¡
, cÚ¡ *
key
, 
	$com·»
(const *, const *))

547 
Êode_t
 *
node
;

549 
node
 = 
	`li¡_fœ¡_´iv
(
li¡
);‚od!ğ
	`li¡_n
Öi¡);‚odğnode->
Ãxt
) {

550 ià(
	`com·»
(
	`Êode_g‘
(
node
), 
key
) == 0)

551  
node
;

555 
	}
}

562 
li¡_is_sÜ‹d
(
li¡_t
 *
li¡
, 
	$com·»
(const *, const *))

564 
Êode_t
 *
node
, *
Ãxt
, *
n
;

566 
Ãxt
 = 
n
 = 
	`li¡_n
(
li¡
);

567 
node
 = 
	`li¡_fœ¡_´iv
(
li¡
);

569 ià(
node
 !ğ
n
)

570 
Ãxt
 = 
	`Êode_Ãxt
(
node
);

572 ; 
Ãxt
 !ğ
n
; 
node
 =‚ext,‚exˆğ
	`Êode_Ãxt
(next)) {

573 ià(
	`com·»
(
	`Êode_g‘
(
node
),†node_g‘(
Ãxt
)) > 0)

578 
	}
}

585 #undeà
li¡_i£m±y


586 #undeà
li¡_isfuÎ


587 #undeà
Êode_poŞ_i£m±y


588 #undeà
li¡_­³nd


589 #undeà
li¡_´•’d


590 #undeà
li¡_fœ¡


591 #undeà
li¡_Ï¡


592 #undeà
li¡_Ãxt


593 #undeà
li¡_´ev


594 #undeà
li¡_couÁ


595 #undeà
li¡_d–_fœ¡


596 #undeà
li¡_d–_Ï¡


597 #undeà
Êode_put


598 #undeà
Êode_g‘


604 
	$li¡_i£m±y
(
li¡_t
 *
li¡
)

606  
li¡
->
nodecouÁ
 == 0;

607 
	}
}

614 
	$li¡_isfuÎ
(
li¡_t
 *
li¡
)

616  
li¡
->
nodecouÁ
 =ğli¡->
maxcouÁ
;

617 
	}
}

623 
	$Êode_poŞ_i£m±y
(
Êod•oŞ_t
 *
poŞ
)

625  (
poŞ
->
äe
 =ğ
NULL
);

626 
	}
}

632 
	$li¡_­³nd
(
li¡_t
 *
li¡
, 
Êode_t
 *
node
)

634 
	`li¡_šs_befÜe
(
li¡
, 
node
, &li¡->
nnode
);

635 
	}
}

641 
	$li¡_´•’d
(
li¡_t
 *
li¡
, 
Êode_t
 *
node
)

643 
	`li¡_šs_aá”
(
li¡
, 
node
, &li¡->
nnode
);

644 
	}
}

650 
Êode_t
 *
	$li¡_fœ¡
(
li¡_t
 *
li¡
)

652 ià(
li¡
->
nnode
.
Ãxt
 == &list->nilnode)

653  
NULL
;

654  
li¡
->
nnode
.
Ãxt
;

655 
	}
}

661 
Êode_t
 *
	$li¡_Ï¡
(
li¡_t
 *
li¡
)

663 ià(
li¡
->
nnode
.
´ev
 == &list->nilnode)

664  
NULL
;

665  
li¡
->
nnode
.
´ev
;

666 
	}
}

672 
li¡couÁ_t
 
	$li¡_couÁ
(
li¡_t
 *
li¡
)

674  
li¡
->
nodecouÁ
;

675 
	}
}

681 
Êode_t
 *
	$li¡_d–_fœ¡
(
li¡_t
 *
li¡
)

683  
	`li¡_d–‘e
(
li¡
,†i¡->
nnode
.
Ãxt
);

684 
	}
}

690 
Êode_t
 *
	$li¡_d–_Ï¡
(
li¡_t
 *
li¡
)

692  
	`li¡_d–‘e
(
li¡
,†i¡->
nnode
.
´ev
);

693 
	}
}

700 
	$Êode_put
(
Êode_t
 *
Êode
, *
d©a
)

702 
Êode
->
d©a
 = data;

703 
	}
}

709 *
	$Êode_g‘
(
Êode_t
 *
Êode
)

711  
Êode
->
d©a
;

712 
	}
}

719 
Êode_t
 *
	$li¡_Ãxt
(
li¡_t
 *
li¡
, 
Êode_t
 *
Êode
)

721 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
Êode
));

723 ià(
Êode
->
Ãxt
 =ğ
	`li¡_n
(
li¡
))

724  
NULL
;

725  
Êode
->
Ãxt
;

726 
	}
}

732 
Êode_t
 *
	$li¡_´ev
(
li¡_t
 *
li¡
, 
Êode_t
 *
Êode
)

734 
	`as£¹
 (
	`li¡_cÚšs
(
li¡
, 
Êode
));

736 ià(
Êode
->
´ev
 =ğ
	`li¡_n
(
li¡
))

737  
NULL
;

738  
Êode
->
´ev
;

739 
	}
}

745 
	$Êode_is_š_a_li¡
(
Êode_t
 *
Êode
)

747  (
Êode
->
Ãxt
 !ğ
NULL
 ||†node->
´ev
 != NULL);

748 
	}
}

751 
	$li¡_v”ify
(
li¡_t
 *
li¡
)

753 
Êode_t
 *
node
 = 
	`li¡_fœ¡_´iv
(
li¡
), *
n
 = 
	`li¡_n
(list);

754 
li¡couÁ_t
 
couÁ
 = 
	`li¡_couÁ
(
li¡
);

756 ià(
node
->
´ev
 !ğ
n
)

759 ià(
couÁ
 > 
li¡
->
maxcouÁ
)

762 
node
 !ğ
n
 && 
couÁ
--) {

763 ià(
node
->
Ãxt
->
´ev
 !=‚ode)

765 
node
 =‚ode->
Ãxt
;

768 ià(
couÁ
 !ğ0 || 
node
 !ğ
n
)

772 
	}
}

	@tools/src/adt/list.h

1 #undeà
KAZLIB_OPAQUE_DEBUG


23 #iâdeà
LIST_H


24 
	#LIST_H


	)

26 
	~<lim™s.h
>

28 #ifdeà
KAZLIB_SIDEEFFECT_DEBUG


29 
	~"sfx.h
"

30 
	#LIST_SFX_CHECK
(
E
è
	`SFX_CHECK
(E)

	)

32 
	#LIST_SFX_CHECK
(
E
è(E)

	)

39 #ifdeà
__ılu¥lus


43 
	tli¡couÁ_t
;

44 
	#LISTCOUNT_T_MAX
 
ULONG_MAX


	)

46 
	sÊode_t
 {

47 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

48 
Êode_t
 *
li¡_Ãxt
;

49 
Êode_t
 *
li¡_´ev
;

50 *
li¡_d©a
;

52 
li¡_dummy
;

54 } 
	tÊode_t
;

56 
	sÊod•oŞ_t
 {

57 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

58 
Êode_t
 *
li¡_poŞ
;

59 
Êode_t
 *
li¡_ä“
;

60 
li¡couÁ_t
 
li¡_size
;

62 
li¡_dummy
;

64 } 
	tÊod•oŞ_t
;

66 
	sli¡_t
 {

67 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

68 
Êode_t
 
li¡_nnode
;

69 
li¡couÁ_t
 
li¡_nodecouÁ
;

70 
li¡couÁ_t
 
li¡_maxcouÁ
;

72 
li¡_dummy
;

74 } 
	tli¡_t
;

76 
Êode_t
 *
Êode_ü—‹
(*);

77 
Êode_t
 *
Êode_š™
(lnode_t *, *);

78 
Êode_de¡roy
(
Êode_t
 *);

79 
Êode_put
(
Êode_t
 *, *);

80 *
Êode_g‘
(
Êode_t
 *);

81 
Êode_is_š_a_li¡
(
Êode_t
 *);

83 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

84 
	#Êode_put
(
N
, 
D
è((N)->
li¡_d©a
 = (D))

	)

85 
	#Êode_g‘
(
N
è((N)->
li¡_d©a
)

	)

88 
Êod•oŞ_t
 *
Êode_poŞ_š™
Önod•oŞ_ˆ*, 
Êode_t
 *, 
li¡couÁ_t
);

89 
Êod•oŞ_t
 *
Êode_poŞ_ü—‹
(
li¡couÁ_t
);

90 
Êode_poŞ_de¡roy
(
Êod•oŞ_t
 *);

91 
Êode_t
 *
Êode_bÜrow
(
Êod•oŞ_t
 *, *);

92 
Êode_»tuº
(
Êod•oŞ_t
 *, 
Êode_t
 *);

93 
Êode_poŞ_i£m±y
(
Êod•oŞ_t
 *);

94 
Êode_poŞ_isäom
(
Êod•oŞ_t
 *, 
Êode_t
 *);

96 
li¡_t
 *
li¡_š™
Öi¡_ˆ*, 
li¡couÁ_t
);

97 
li¡_t
 *
li¡_ü—‹
(
li¡couÁ_t
);

98 
li¡_de¡roy
(
li¡_t
 *);

99 
li¡_de¡roy_nodes
(
li¡_t
 *);

100 
li¡_»tuº_nodes
(
li¡_t
 *, 
Êod•oŞ_t
 *);

102 
li¡couÁ_t
 
li¡_couÁ
(
li¡_t
 *);

103 
li¡_i£m±y
(
li¡_t
 *);

104 
li¡_isfuÎ
(
li¡_t
 *);

105 
li¡_cÚšs
(
li¡_t
 *, 
Êode_t
 *);

107 
li¡_­³nd
(
li¡_t
 *, 
Êode_t
 *);

108 
li¡_´•’d
(
li¡_t
 *, 
Êode_t
 *);

109 
li¡_šs_befÜe
(
li¡_t
 *, 
Êode_t
 *,†node_t *);

110 
li¡_šs_aá”
(
li¡_t
 *, 
Êode_t
 *,†node_t *);

112 
Êode_t
 *
li¡_fœ¡
(
li¡_t
 *);

113 
Êode_t
 *
li¡_Ï¡
(
li¡_t
 *);

114 
Êode_t
 *
li¡_Ãxt
(
li¡_t
 *,†node_t *);

115 
Êode_t
 *
li¡_´ev
(
li¡_t
 *,†node_t *);

117 
Êode_t
 *
li¡_d–_fœ¡
(
li¡_t
 *);

118 
Êode_t
 *
li¡_d–_Ï¡
(
li¡_t
 *);

119 
Êode_t
 *
li¡_d–‘e
(
li¡_t
 *,†node_t *);

121 
li¡_´oûss
(
li¡_t
 *, *, (*)Öi¡_ˆ*, 
Êode_t
 *, *));

123 
li¡_v”ify
(
li¡_t
 *);

125 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

126 
	#Êode_poŞ_i£m±y
(
P
è((P)->
li¡_ä“
 =ğ0)

	)

127 
	#li¡_couÁ
(
L
è((L)->
li¡_nodecouÁ
)

	)

128 
	#li¡_i£m±y
(
L
è((L)->
li¡_nodecouÁ
 =ğ0)

	)

129 
	#li¡_isfuÎ
(
L
è(
	`LIST_SFX_CHECK
(L)->
li¡_nodecouÁ
 =ğ(L)->
li¡_maxcouÁ
)

	)

130 
	#li¡_Ãxt
(
L
, 
N
è(
	`LIST_SFX_CHECK
(N)->
li¡_Ãxt
 =ğ&(L)->
li¡_nnode
 ? 
NULL
 : (N)->li¡_Ãxt)

	)

131 
	#li¡_´ev
(
L
, 
N
è(
	`LIST_SFX_CHECK
(N)->
li¡_´ev
 =ğ&(L)->
li¡_nnode
 ? 
NULL
 : (N)->li¡_´ev)

	)

132 
	#li¡_fœ¡
(
L
è
	`li¡_Ãxt
(
	`LIST_SFX_CHECK
(L), &(L)->
li¡_nnode
)

	)

133 
	#li¡_Ï¡
(
L
è
	`li¡_´ev
(
	`LIST_SFX_CHECK
(L), &(L)->
li¡_nnode
)

	)

136 #ià
defšed
(
LIST_IMPLEMENTATION
è|| !defšed(
KAZLIB_OPAQUE_DEBUG
)

137 
	#li¡_­³nd
(
L
, 
N
è
	`li¡_šs_befÜe
(
	`LIST_SFX_CHECK
(L), N, &(L)->
li¡_nnode
)

	)

138 
	#li¡_´•’d
(
L
, 
N
è
	`li¡_šs_aá”
(
	`LIST_SFX_CHECK
(L), N, &(L)->
li¡_nnode
)

	)

139 
	#li¡_d–_fœ¡
(
L
è
	`li¡_d–‘e
(
	`LIST_SFX_CHECK
(L), 
	`li¡_fœ¡
(L))

	)

140 
	#li¡_d–_Ï¡
(
L
è
	`li¡_d–‘e
(
	`LIST_SFX_CHECK
(L), 
	`li¡_Ï¡
(L))

	)

145 
li¡_exŒaù
(
li¡_t
 *,†i¡_ˆ*, 
Êode_t
 *,†node_t *);

146 
li¡_Œªsãr
(
li¡_t
 *,†i¡_ˆ*, 
Êode_t
 *
fœ¡
);

147 
li¡_m”ge
(
li¡_t
 *,†ist_t *, (const *, const *));

148 
li¡_sÜt
(
li¡_t
 *, (const *, const *));

149 
Êode_t
 *
li¡_fšd
(
li¡_t
 *, const *, (const *, const *));

150 
li¡_is_sÜ‹d
(
li¡_t
 *, (const *, const *));

152 #ifdeà
__ılu¥lus


	@tools/src/adt/tst.c

35 
	~<¡dlib.h
>

36 
	~"t¡.h
"

37 
	~<¡dio.h
>

38 
	~<as£¹.h
>

39 
	~<dbg.h
>

40 
	~<mem/h®loc.h
>

42 
	st¡_cŞËù_t
 {

43 
li¡_t
 *
	mv®ues
;

44 
t¡_cŞËù_‹¡_cb
 
	m‹¡”
;

45 cÚ¡ *
	mkey
;

46 
size_t
 
	mËn
;

47 } 
	tt¡_cŞËù_t
;

50 
	mMAX_TRAVERSE_SIZE
 = 128

53 
	$t¡_cŞËù_bud
(*
v®ue
, 
t¡_cŞËù_t
 *
»suÉs
)

55 if(!
»suÉs
->
‹¡”
 ||„esuÉs->
	`‹¡”
(
v®ue
,„esuÉs->
key
,„esuÉs->
Ën
)) {

56 
Êode_t
 *
node
 = 
	`Êode_ü—‹
(
v®ue
);

57 
	`li¡_­³nd
(
»suÉs
->
v®ues
, 
node
);

59 
	}
}

62 
li¡_t
 *
	$t¡_cŞËù
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
, 
t¡_cŞËù_‹¡_cb
 
‹¡”
)

64 
t¡_cŞËù_t
 
»suÉs
 = {.
v®ues
 = 
NULL
, .
‹¡”
 =e¡”, .
key
 = 
s
, .
Ën
 =†en};

65 
t¡_t
 *
p
 = 
roÙ
;

66 
t¡_t
 *
Ï¡
 = 
p
;

67 
size_t
 
i
 = 0;

68 
»suÉs
.
v®ues
 = 
	`li¡_ü—‹
(
LISTCOUNT_T_MAX
);

71 
i
 < 
Ën
 && 
p
) {

72 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

73 
p
 =…->
low
;

74 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

75 
i
++;

76 if(
i
 < 
Ën
) {

77 if(
p
->
v®ue
è
Ï¡
 =…;

78 
p
 =…->
equ®
;

81 
p
 =…->
high
;

85 if((
Ï¡
 && 
»suÉs
.
‹¡”
è|| 
p
) {

87 
	`t¡_Œav”£
(
p
 =ğ
NULL
 ? 
Ï¡
 :…, (
t¡_Œav”£_cb
)
t¡_cŞËù_bud
, &
»suÉs
);

90  
»suÉs
.
v®ues
;

91 
	}
}

93 *
	$t¡_£¬ch_suffix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
)

95 if(
Ën
 =ğ0è 
NULL
;

97 
t¡_t
 *
p
 = 
roÙ
;

98 
t¡_t
 *
Ï¡
 = 
NULL
;

99 
i
 = 
Ën
-1;

101 
i
 >ğ0 && 
p
) {

102 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

103 
p
 =…->
low
;

104 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

105 
i
--;

106 if(
i
 >= 0) {

107 if(
p
->
v®ue
è
Ï¡
 =…;

108 
p
 =…->
equ®
;

111 
p
 =…->
high
;

115 
p
 =… ?… : 
Ï¡
;

117 
p
 && !p->
v®ue
) {

118 
p
 =…->
equ®
;

121  
p
 ?…->
v®ue
 : 
NULL
;

122 
	}
}

124 *
	$t¡_£¬ch_´efix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
)

126 if(
Ën
 =ğ0è 
NULL
;

128 
t¡_t
 *
p
 = 
roÙ
;

129 
t¡_t
 *
Ï¡
 = 
NULL
;

130 
size_t
 
i
 = 0;

132 
i
 < 
Ën
 && 
p
) {

133 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

134 
p
 =…->
low
;

135 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

136 
i
++;

137 if(
i
 < 
Ën
) {

138 if(
p
->
v®ue
è
Ï¡
 =…;

139 
p
 =…->
equ®
;

142 
p
 =…->
high
;

146 
p
 =… ?… : 
Ï¡
;

149 
p
 && !p->
v®ue
) {

150 
p
 =…->
equ®
;

153  
p
 ?…->
v®ue
 : 
NULL
;

154 
	}
}

156 *
	$t¡_£¬ch
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
)

158 
t¡_t
 *
p
 = 
roÙ
;

159 
size_t
 
i
 = 0;

161 
i
 < 
Ën
 && 
p
) {

163 ià(
s
[
i
] < 
p
->
¥l™ch¬
) {

164 
p
 =…->
low
;

165 } ià(
s
[
i
] =ğ
p
->
¥l™ch¬
) {

166 
i
++;

167 if(
i
 < 
Ën
è
p
 =…->
equ®
;

169 
p
 =…->
high
;

173 if(
p
) {

174  
p
->
v®ue
;

176  
NULL
;

178 
	}
}

181 
t¡_t
 *
	$t¡_š£¹_ba£
(
t¡_t
 *
roÙ
,¡_ˆ*
p
, cÚ¡ *
s
, 
size_t
 
Ën
, *
v®ue
)

183 ià(
p
 =ğ
NULL
) {

184 
p
 = (
t¡_t
 *è
	`h_ÿÎoc
((tst_t), 1);

186 if(
roÙ
 =ğ
NULL
) {

187 
roÙ
 = 
p
;

189 
	`h©ch
(
p
, 
roÙ
);

192 
p
->
¥l™ch¬
 = *
s
;

195 ià(*
s
 < 
p
->
¥l™ch¬
) {

196 
p
->
low
 = 
	`t¡_š£¹_ba£
(
roÙ
,…->low, 
s
, 
Ën
, 
v®ue
);

197 } ià(*
s
 =ğ
p
->
¥l™ch¬
) {

198 ià(
Ën
 > 1) {

200 
p
->
equ®
 = 
	`t¡_š£¹_ba£
(
roÙ
,…->equ®, 
s
+1, 
Ën
 - 1, 
v®ue
);

202 
	`as£¹
(
p
->
v®ue
 =ğ
NULL
 && "Duplicate insert intost.");

203 
p
->
v®ue
 = value;

206 
p
->
high
 = 
	`t¡_š£¹_ba£
(
roÙ
,…->high, 
s
, 
Ën
, 
v®ue
);

209  
p
;

210 
	}
}

212 
t¡_t
 *
	$t¡_š£¹
(
t¡_t
 *
p
, cÚ¡ *
s
, 
size_t
 
Ën
, *
v®ue
)

214  
	`t¡_š£¹_ba£
(
p
,…, 
s
, 
Ën
, 
v®ue
);

215 
	}
}

218 
t¡_t
 **
	$t¡_»size_queue
(
t¡_t
 **
queue
, 
q_¡¬t
, 
q_size
, 
q_max
, 
Ãw_size
)

220 
i
 = 0;

221 
t¡_t
 ** 
Ãw_queue
 = 
	`ÿÎoc
(Ñ¡_ˆ*), 
Ãw_size
);

222 
	`check
(
Ãw_queue
, "Failedo„eallocate queue forraverse");

224 
i
 = 0; i < 
q_size
; i++) {

225 
Ãw_queue
[
i
] = 
queue
[(˜+ 
q_¡¬t
è% 
q_max
];

228 
	`ä“
(
queue
);

229  
Ãw_queue
;

231 
”rÜ
:

232 
	`ä“
(
queue
);

233  
NULL
;

234 
	}
}

238 
	$t¡_Œav”£
(
t¡_t
 *
p
, 
t¡_Œav”£_cb
 
cb
, *
d©a
)

240 ià(!
p
) ;

242 
q_¡¬t
 = 0;

243 
q_size
 = 0;

244 
q_max
 = 
MAX_TRAVERSE_SIZE
;

245 
t¡_t
 **
queue
 = 
	`ÿÎoc
(Ñ¡_ˆ*), 
MAX_TRAVERSE_SIZE
);

247 
	`check
(
queue
, "Failedo malloc queue forraverse");

249 
queue
[
q_¡¬t
] = 
p
;

250 
q_size
++;

252 
q_size
 > 0) {

253 
t¡_t
 *
cur
 = 
queue
[
q_¡¬t
];

254 
q_¡¬t
 = (q_¡¬ˆ+ 1è% 
q_max
;

255 
q_size
--;

258 if(
q_size
 + 3 > 
q_max
) {

259 
queue
 = 
	`t¡_»size_queue
(queue, 
q_¡¬t
, 
q_size
, 
q_max
, q_max * 2);

260 
q_¡¬t
 = 0;

261 
q_max
 = q_max * 2;

264 if(
cur
->
v®ue
è
	`cb
(cur->v®ue, 
d©a
);

266 if(
cur
->
low
è
queue
[(
q_¡¬t
 + (
q_size
++)è% 
q_max
] = cur->low;

267 if(
cur
->
equ®
è
queue
[(
q_¡¬t
 + (
q_size
++)è% 
q_max
] = cur->equal;

268 if(
cur
->
high
è
queue
[(
q_¡¬t
 + (
q_size
++)è% 
q_max
] = cur->high;

271 
	`ä“
(
queue
);

274 
”rÜ
:

275 if(
queue
è
	`ä“
(queue);

276 
	}
}

279 
	$t¡_de¡roy
(
t¡_t
 *
roÙ
)

281 if(
roÙ
) {

282 
	`h_ä“
(
roÙ
);

284 
	}
}

	@tools/src/adt/tst.h

35 #iâdeà
t¡_h


36 
	#t¡_h


	)

38 
	~<¡dlib.h
>

39 
	~<adt/li¡.h
>

41 
	st¡_t
 {

42 
	m¥l™ch¬
;

43 
t¡_t
 *
	mlow
;

44 
t¡_t
 *
	mequ®
;

45 
t¡_t
 *
	mhigh
;

46 *
	mv®ue
;

47 } 
	tt¡_t
;

50 (*
	tt¡_Œav”£_cb
)(*
	tv®ue
, *
	td©a
);

51 (*
	tt¡_cŞËù_‹¡_cb
)(*
	tv®ue
, cÚ¡ *
	t·th
, 
	tsize_t
 
	tËn
);

56 *
	`t¡_£¬ch_suffix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
);

58 *
	`t¡_£¬ch
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
);

60 *
	`t¡_£¬ch_´efix
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
);

62 
t¡_t
 *
	`t¡_š£¹
Ñ¡_ˆ*
p
, cÚ¡ *
s
, 
size_t
 
Ën
, *
v®ue
);

64 
	`t¡_Œav”£
(
t¡_t
 *
p
, 
t¡_Œav”£_cb
 
cb
, *
d©a
);

66 
li¡_t
 *
	`t¡_cŞËù
(
t¡_t
 *
roÙ
, cÚ¡ *
s
, 
size_t
 
Ën
, 
t¡_cŞËù_‹¡_cb
 
‹¡”
);

68 
	`t¡_de¡roy
(
t¡_t
 *
roÙ
);

	@tools/src/bsd_specific.c

35 
	~<¡ddef.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/uio.h
>

39 
	~<sk/sk.h
>

40 
	~<dbg.h
>

43 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
)

48 
	$bsd_£ndfe
(
out_fd
, 
š_fd
, 
off_t
 *
off£t
, 
size_t
 
couÁ
) {

49 
off_t
 
my_couÁ
 = 
couÁ
;

50 
rc
;

55 
	`fdwa™
(
out_fd
, 'w');

56 #ià
	`defšed
(
__APPLE__
)

57 
rc
 = 
	`£ndfe
(
š_fd
, 
out_fd
, *
off£t
, &
my_couÁ
, 
NULL
, 0);

58 #–ià
	`defšed
(
__F»eBSD__
)

59 
rc
 = 
	`£ndfe
(
š_fd
, 
out_fd
, *
off£t
, 
couÁ
, 
NULL
, &
my_couÁ
, 0);

61 *
off£t
 +ğ
my_couÁ
;

62 } 
rc
 !ğ0 && 
”ºo
 == 35);

64 
	`check
(
rc
 == 0, "OS X sendfile wrapper failed");

66  
my_couÁ
;

68 
”rÜ
:

70 
	}
}

74 
fd»cv
(
fd
, *
buf
, 
n
);

75 
fd£nd
(
fd
, *
buf
, 
n
);

77 
	#BSD_SENDFILE_BUF_SIZE
 16384

	)

78 
	~<uni¡d.h
>

82 
	$bsd_£ndfe
(
out_fd
, 
š_fd
, 
off_t
 *
off£t
, 
size_t
 
couÁ
) {

83 
buf
[
BSD_SENDFILE_BUF_SIZE
];

84 
»t
 = -1;

85 
off_t
 
Üig_off£t
 = 0;

86 
cur
 = 0;

87 
»m
 = 
couÁ
;

88 
£Á
 = 0;

89 
size_t
 
tÙ
 = 0;

91 
	`check
(
»m
 > 0, "Possible integer overflow in count.");

93 ià(
off£t
 !ğ
NULL
) {

94 
Üig_off£t
 = 
	`l£ek
(
š_fd
, 0, 
SEEK_CUR
);

95 
	`check
(
Üig_off£t
 >= 0, "lseek failure when determining current…osition");

96 
	`check
(
	`l£ek
(
š_fd
, *
off£t
, 
SEEK_SET
) >= 0, "lseek failure when setting‚ew…osition");

99 
tÙ
 = 0, 
»m
 = 
couÁ
, 
cur
 =„em; cur != 0 &&ot < count;ot += cur,„em -= cur) {

100 ià(
»m
 >ğ
BSD_SENDFILE_BUF_SIZE
) {

101 
cur
 = 
BSD_SENDFILE_BUF_SIZE
;

103 
cur
 = 
»m
;

106 
cur
 = 
	`fd»ad
(
š_fd
, 
buf
, cur);

107 
	`check
(
cur
 >= 0, "Internal sendfileƒmulation failed: fdread: %i", cur);

109 ià(
cur
 != 0) {

110 
£Á
 = 
	`fdwr™e
(
out_fd
, 
buf
, 
cur
);

111 
	`check
(
£Á
 =ğ
cur
, "Internal sendfileƒmulation failed: fdread: %i, fdwrite: %i", cur, sent);

115 
»t
 = 
tÙ
;

117 
”rÜ
:

118 ià(
off£t
 !ğ
NULL
) {

119 ià(
»t
 != -1) {

120 *
off£t
 +ğ
tÙ
;

122 
	`l£ek
(
š_fd
, 
Üig_off£t
, 
SEEK_SET
);

124  
»t
;

125 
	}
}

	@tools/src/bsd_specific.h

35 #iâdeà
_MAC_SPECIFIC_H


36 
	#_MAC_SPECIFIC_H


	)

37 
	~<sys/ty³s.h
>

39 
bsd_£ndfe
(
out_fd
, 
š_fd
, 
off_t
 *
off£t
, 
size_t
 
couÁ
);

	@tools/src/bstr/bsafe.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~"b§ã.h
"

21 
	gb§ãShouldEx™
 = 1;

23 * 
¡rıy
 (*
d¡
, cÚ¡ *
¤c
);

24 * 
¡rÿt
 (*
d¡
, cÚ¡ *
¤c
);

26 * 
	$¡rıy
 (*
d¡
, cÚ¡ *
¤c
) {

27 
d¡
 = dst;

28 
¤c
 = src;

29 
	`årštf
 (
¡d”r
, "bsafeƒrror: strcpy() is‚ot safe, use bstrcpy instead.\n");

30 ià(
b§ãShouldEx™
è
	`ex™
 (-1);

31  
NULL
;

32 
	}
}

34 * 
	$¡rÿt
 (*
d¡
, cÚ¡ *
¤c
) {

35 
d¡
 = dst;

36 
¤c
 = src;

37 
	`årštf
 (
¡d”r
, "bsafeƒrror: strcat() is‚ot safe, use bstrcat instead.\n");

38 ià(
b§ãShouldEx™
è
	`ex™
 (-1);

39  
NULL
;

40 
	}
}

42 #ià!
defšed
 (
__GNUC__
è&& (!defšed(
_MSC_VER
) || (_MSC_VER <= 1310))

43 * (
	gg‘s
è(* 
	gbuf
) {

44 
	gbuf
 = 
buf
;

45 
årštf
 (
¡d”r
, "bsafeƒrror: gets() is‚ot safe, use bgets.\n");

46 ià(
	gb§ãShouldEx™
è
ex™
 (-1);

47  
	gNULL
;

60 * (
	g¡ºÿt
è(*
	gd¡
, cÚ¡ *
	g¤c
, 
size_t
 
	gn
) {

61 
	gd¡
 = 
d¡
;

62 
	g¤c
 = 
¤c
;

63 
	gn
 = 
n
;

64 
årštf
 (
¡d”r
, "bsafeƒrror: strncat() is‚ot safe, use bstrcathen btrunc\n\tor cstr2tbstr, btrunchen bstrcat instead.\n");

65 ià(
	gb§ãShouldEx™
è
ex™
 (-1);

66  
	gNULL
;

69 * (
	g¡¹ok
è(*
	gs1
, cÚ¡ *
	gs2
) {

70 
	gs1
 = 
s1
;

71 
	gs2
 = 
s2
;

72 
årštf
 (
¡d”r
, "bsafeƒrror: strtok() is‚ot safe, use bsplit or bsplits instead.\n");

73 ià(
	gb§ãShouldEx™
è
ex™
 (-1);

74  
	gNULL
;

	@tools/src/bstr/bsafe.h

17 #iâdeà
BSTRLIB_BSAFE_INCLUDE


18 
	#BSTRLIB_BSAFE_INCLUDE


	)

20 #ifdeà
__ılu¥lus


24 #ià!
defšed
 (
__GNUC__
è&& (!defšed(
_MSC_VER
) || (_MSC_VER <= 1310))

26 * (
g‘s
è(* 
buf
);

30 * (
¡ºÿt
è(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
n
);

31 * (
¡¹ok
è(*
s1
, cÚ¡ *
s2
);

34 #undeà
¡rıy


35 #undeà
¡rÿt


36 
	#¡rıy
(
a
,
b
è
	`b§ã_¡rıy
×,b)

	)

37 
	#¡rÿt
(
a
,
b
è
	`b§ã_¡rÿt
×,b)

	)

39 #ifdeà
__ılu¥lus


	@tools/src/bstr/bstraux.c

1 #ifdeà
_MSC_VER


2 
	#_CRT_SECURE_NO_WARNINGS


	)

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<lim™s.h
>

24 
	~<ùy³.h
>

25 
	~<¡dšt.h
>

26 
	~"b¡¾ib.h
"

27 
	~"b¡¿ux.h
"

33 
b¡ršg
 
	$bTa
 (
b¡ršg
 
b
, 
n
) {

34 ià(
b
 =ğ
NULL
 || 
n
 < 0 || (b->
mËn
 < b->
¦’
 && b->mlen > 0))  NULL;

35 ià(
n
 >ğ
b
->
¦’
è 
	`b¡rıy
 (b);

36  
	`bmid¡r
 (
b
, b->
¦’
 - 
n
,‚);

37 
	}
}

43 
b¡ršg
 
	$bH—d
 (
b¡ršg
 
b
, 
n
) {

44 ià(
b
 =ğ
NULL
 || 
n
 < 0 || (b->
mËn
 < b->
¦’
 && b->mlen > 0))  NULL;

45 ià(
n
 >ğ
b
->
¦’
è 
	`b¡rıy
 (b);

46  
	`bmid¡r
 (
b
, 0, 
n
);

47 
	}
}

53 
	$bFl
 (
b¡ršg
 
b
, 
c
, 
Ën
) {

54 ià(
b
 =ğ
NULL
 || 
Ën
 < 0 || (b->
mËn
 < b->
¦’
 && b->mËÀ> 0)è -
__LINE__
;

55 
b
->
¦’
 = 0;

56  
	`b£t¡r
 (
b
, 
Ën
, 
NULL
, 
c
);

57 
	}
}

63 
	$bR•liÿ‹
 (
b¡ršg
 
b
, 
n
) {

64  
	`b·‰”n
 (
b
, 
n
 * b->
¦’
);

65 
	}
}

71 
	$bRev”£
 (
b¡ršg
 
b
) {

72 
i
, 
n
, 
m
;

73 
t
;

75 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->¦’è -
__LINE__
;

76 
n
 = 
b
->
¦’
;

77 ià(2 <ğ
n
) {

78 
m
 = (()
n
) >> 1;

79 
n
--;

80 
i
=0; i < 
m
; i++) {

81 
t
 = 
b
->
d©a
[
n
 - 
i
];

82 
b
->
d©a
[
n
 - 
i
] = b->data[i];

83 
b
->
d©a
[
i
] = 
t
;

87 
	}
}

94 
	$bIn£¹Chrs
 (
b¡ršg
 
b
, 
pos
, 
Ën
, 
c
, 
fl
) {

95 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->¦’ || 
pos
 < 0 || 
Ën
 <ğ0è -
__LINE__
;

97 ià(
pos
 > 
b
->
¦’


98 && 0 > 
	`b£t¡r
 (
b
, 
pos
, 
NULL
, 
fl
)è -
__LINE__
;

100 ià(0 > 
	`b®loc
 (
b
, b->
¦’
 + 
Ën
)è -
__LINE__
;

101 ià(
pos
 < 
b
->
¦’
è
	`memmove
 (b->
d©a
 +…o + 
Ën
, b->data +…os, b->slen -…os);

102 
	`mem£t
 (
b
->
d©a
 + 
pos
, 
c
, 
Ën
);

103 
b
->
¦’
 +ğ
Ën
;

104 
b
->
d©a
[b->
¦’
] = () '\0';

105  
BSTR_OK
;

106 
	}
}

112 
	$bJu¡ifyLeá
 (
b¡ršg
 
b
, 
¥aû
) {

113 
j
, 
i
, 
s
, 
t
;

114 
c
 = (è
¥aû
;

116 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->¦’è -
__LINE__
;

117 ià(
¥aû
 !ğ(è
c
è 
BSTR_OK
;

119 
s
=
j
=
i
=0; i < 
b
->
¦’
; i++) {

120 
t
 = 
s
;

121 
s
 = 
c
 !ğ(
b
->
d©a
[
j
] = b->d©a[
i
]);

122 
j
 +ğ(
t
|
s
);

124 ià(
j
 > 0 && 
b
->
d©a
[j-1] =ğ
c
) j--;

126 
b
->
d©a
[
j
] = () '\0';

127 
b
->
¦’
 = 
j
;

128  
BSTR_OK
;

129 
	}
}

135 
	$bJu¡ifyRight
 (
b¡ršg
 
b
, 
width
, 
¥aû
) {

136 
»t
;

137 ià(
width
 <ğ0è -
__LINE__
;

138 ià(0 > (
»t
 = 
	`bJu¡ifyLeá
 (
b
, 
¥aû
))) „et;

139 ià(
b
->
¦’
 <ğ
width
)

140  
	`bIn£¹Chrs
 (
b
, 0, 
width
 - b->
¦’
, (è
¥aû
, () space);

141  
BSTR_OK
;

142 
	}
}

149 
	$bJu¡ifyC’‹r
 (
b¡ršg
 
b
, 
width
, 
¥aû
) {

150 
»t
;

151 ià(
width
 <ğ0è -
__LINE__
;

152 ià(0 > (
»t
 = 
	`bJu¡ifyLeá
 (
b
, 
¥aû
))) „et;

153 ià(
b
->
¦’
 <ğ
width
)

154  
	`bIn£¹Chrs
 (
b
, 0, (
width
 - b->
¦’
 + 1è>> 1, (è
¥aû
, () space);

155  
BSTR_OK
;

156 
	}
}

164 
	$bJu¡ifyM¬gš
 (
b¡ršg
 
b
, 
width
, 
¥aû
) {

165 
b¡rLi¡
 * 
¦
;

166 
i
, 
l
, 
c
;

168 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 =ğ0 || b->mËÀ< b->¦’è -
__LINE__
;

169 ià(
NULL
 =ğ(
¦
 = 
	`b¥l™
 (
b
, (è
¥aû
))è -
__LINE__
;

170 
l
=
c
=
i
=0; i < 
¦
->
qty
; i++) {

171 ià(
¦
->
’Œy
[
i
]->
¦’
 > 0) {

172 
c
 ++;

173 
l
 +ğ
¦
->
’Œy
[
i
]->
¦’
;

177 ià(
l
 + 
c
 >ğ
width
 || c < 2) {

178 
	`b¡rLi¡De¡roy
 (
¦
);

179  
	`bJu¡ifyLeá
 (
b
, 
¥aû
);

182 
b
->
¦’
 = 0;

183 
i
=0; i < 
¦
->
qty
; i++) {

184 ià(
¦
->
’Œy
[
i
]->
¦’
 > 0) {

185 ià(
b
->
¦’
 > 0) {

186 
s
 = (
width
 - 
l
 + (
c
 / 2)) / c;

187 
	`bIn£¹Chrs
 (
b
, b->
¦’
, 
s
, (è
¥aû
, () space);

188 
l
 +ğ
s
;

190 
	`bcÚÿt
 (
b
, 
¦
->
’Œy
[
i
]);

191 
c
--;

192 ià(
c
 <= 0) ;

196 
	`b¡rLi¡De¡roy
 (
¦
);

197  
BSTR_OK
;

198 
	}
}

200 
size_t
 
	$»adNÙhšg
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

201 
buff
 = buff;

202 
–size
 =ƒlsize;

203 
ÃËm
 =‚elem;

204 
·rm
 =…arm;

206 
	}
}

213 
bSŒ—m
 * 
	$bsFromB¡r
 (
cÚ¡_b¡ršg
 
b
) {

214 
bSŒ—m
 * 
s
 = 
	`bsİ’
 ((
bN»ad
è
»adNÙhšg
, 
NULL
);

215 
	`bsuÄ—d
 (
s
, 
b
);

216  
s
;

217 
	}
}

219 
size_t
 
	$»adRef
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

220 
gb¡ršg
 * 
t
 = (gb¡ršg *è
·rm
;

221 
size_t
 
tsz
 = 
–size
 * 
ÃËm
;

223 ià(
tsz
 > (
size_t
è
t
->
¦’
)sz = (size_t)->slen;

224 ià(
tsz
 > 0) {

225 
	`memıy
 (
buff
, 
t
->
d©a
, 
tsz
);

226 
t
->
¦’
 -ğ(è
tsz
;

227 
t
->
d©a
 +ğ
tsz
;

228  
tsz
 / 
–size
;

231 
	}
}

239 
bSŒ—m
 * 
	$bsFromB¡rRef
 (
gb¡ršg
 * 
t
) {

240 ià(!
t
è 
NULL
;

241  
	`bsİ’
 ((
bN»ad
è
»adRef
, 
t
);

242 
	}
}

254 * 
	$bSŒ2N‘SŒ
 (
cÚ¡_b¡ršg
 
b
) {

255 
size_t
 
numËn
 =  (
b
->
¦’
) * 3 + 1;

256 
¡ºum
[
numËn
+1];

257 
b¡ršg
 
s
;

258 * 
buff
;

260 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0)  NULL;

261 
	`¢´štf
(
¡ºum
, 
numËn
+1, "%d:", 
b
->
¦’
);

262 ià(
NULL
 =ğ(
s
 = 
	`bäomc¡r
 (
¡ºum
))

263 || 
	`bcÚÿt
 (
s
, 
b
è=ğ
BSTR_ERR
 || 
	`bcÚch¬
 (s, () ',') == BSTR_ERR) {

264 
	`bde¡roy
 (
s
);

265  
NULL
;

267 
buff
 = 
s
->
d©a
;

268 
	`bc¡rä“
 ((*è
s
);

269  (*è
buff
;

270 
	}
}

279 
b¡ršg
 
	$bN‘SŒ2B¡r
 (cÚ¡ * 
buff
) {

280 
i
, 
x
;

281 
b¡ršg
 
b
;

282 ià(
buff
 =ğ
NULL
)  NULL;

283 
x
 = 0;

284 
i
=0; 
buff
[i] != ':'; i++) {

285 
v
 = 
buff
[
i
] - '0';

286 ià(
v
 > 9 || 
x
 > ((
INT_MAX
 - (sigÃd )vè/ 10)è 
NULL
;

287 
x
 = (x * 10è+ 
v
;

291 ià(
buff
[
i
 + 1 + 
x
] !ğ','è 
NULL
;

293 ià(
NULL
 =ğ(
b
 = 
	`bäomc¡r
 ("")))  NULL;

294 ià(
	`b®loc
 (
b
, 
x
 + 1è!ğ
BSTR_OK
) {

295 
	`bde¡roy
 (
b
);

296  
NULL
;

298 
	`memıy
 (
b
->
d©a
, 
buff
 + 
i
 + 1, 
x
);

299 
b
->
d©a
[
x
] = () '\0';

300 
b
->
¦’
 = 
x
;

301  
b
;

302 
	}
}

304 
	gb64ETabË
[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

310 
b¡ršg
 
	$bBa£64Encode
 (
cÚ¡_b¡ršg
 
b
) {

311 
i
, 
c0
, 
c1
, 
c2
, 
c3
;

312 
b¡ršg
 
out
;

314 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

316 
out
 = 
	`bäomc¡r
 ("");

317 
i
=0; i + 2 < 
b
->
¦’
; i += 3) {

318 
c0
 = 
b
->
d©a
[
i
] >> 2;

319 
c1
 = ((
b
->
d©a
[
i
] << 4) |

320 (
b
->
d©a
[
i
+1] >> 4)) & 0x3F;

321 
c2
 = ((
b
->
d©a
[
i
+1] << 2) |

322 (
b
->
d©a
[
i
+2] >> 6)) & 0x3F;

323 
c3
 = 
b
->
d©a
[
i
+2] & 0x3F;

324 ià(
	`bcÚch¬
 (
out
, 
b64ETabË
[
c0
]) < 0 ||

325 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c1
]) < 0 ||

326 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c2
]) < 0 ||

327 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c3
]) < 0) {

328 
	`bde¡roy
 (
out
);

329  
NULL
;

333 
i
 + 2 - 
b
->
¦’
) {

334 0: 
c0
 = 
b
->
d©a
[
i
] >> 2;

335 
c1
 = ((
b
->
d©a
[
i
] << 4) |

336 (
b
->
d©a
[
i
+1] >> 4)) & 0x3F;

337 
c2
 = (
b
->
d©a
[
i
+1] << 2) & 0x3F;

338 ià(
	`bcÚch¬
 (
out
, 
b64ETabË
[
c0
]) < 0 ||

339 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c1
]) < 0 ||

340 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c2
]) < 0 ||

341 
	`bcÚch¬
 (
out
, () '=') < 0) {

342 
	`bde¡roy
 (
out
);

343  
NULL
;

346 1: 
c0
 = 
b
->
d©a
[
i
] >> 2;

347 
c1
 = (
b
->
d©a
[
i
] << 4) & 0x3F;

348 ià(
	`bcÚch¬
 (
out
, 
b64ETabË
[
c0
]) < 0 ||

349 
	`bcÚch¬
 (
out
, 
b64ETabË
[
c1
]) < 0 ||

350 
	`bcÚch¬
 (
out
, () '=') < 0 ||

351 
	`bcÚch¬
 (
out
, () '=') < 0) {

352 
	`bde¡roy
 (
out
);

353  
NULL
;

359  
out
;

360 
	}
}

362 
	#B64_PAD
 (-2)

	)

363 
	#B64_ERR
 (-1)

	)

365 
	$ba£64DecodeSymbŞ
 (
®pha
) {

366 ià((
®pha
 >= 'A') && (alpha <= 'Z'))  ()(alpha - 'A');

367 ià((
®pha
 >= 'a') && (alpha <= 'z'))

368  26 + ()(
®pha
 - 'a');

369 ià((
®pha
 >= '0') && (alpha <= '9'))

370  52 + ()(
®pha
 - '0');

371 ià(
®pha
 == '+')  62;

372 ià(
®pha
 == '/')  63;

373 ià(
®pha
 =ğ'='è 
B64_PAD
;

374  
B64_ERR
;

375 
	}
}

382 
b¡ršg
 
	$bBa£64DecodeEx
 (
cÚ¡_b¡ršg
 
b
, * 
boŞTruncE¼Ü
) {

383 
i
, 
v
;

384 
c0
, 
c1
, 
c2
;

385 
b¡ršg
 
out
;

387 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

388 ià(
boŞTruncE¼Ü
) *boolTruncError = 0;

389 
out
 = 
	`bäomc¡r
 ("");

390 
i
 = 0;

393 ià(
i
 >ğ
b
->
¦’
è 
out
;

394 ià(
b
->
d©a
[
i
] == '=') {

395 ià(
boŞTruncE¼Ü
) {

396 *
boŞTruncE¼Ü
 = 1;

397  
out
;

399 
	`bde¡roy
 (
out
);

400  
NULL
;

402 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

403 
i
++;

404 } 
v
 < 0);

405 
c0
 = (è(
v
 << 2);

407 ià(
i
 >ğ
b
->
¦’
 || b->
d©a
[i] == '=') {

408 ià(
boŞTruncE¼Ü
) {

409 *
boŞTruncE¼Ü
 = 1;

410  
out
;

412 
	`bde¡roy
 (
out
);

413  
NULL
;

415 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

416 
i
++;

417 } 
v
 < 0);

418 
c0
 |ğ(è(
v
 >> 4);

419 
c1
 = (è(
v
 << 4);

421 ià(
i
 >ğ
b
->
¦’
) {

422 ià(
boŞTruncE¼Ü
) {

423 *
boŞTruncE¼Ü
 = 1;

424  
out
;

426 
	`bde¡roy
 (
out
);

427  
NULL
;

429 ià(
b
->
d©a
[
i
] == '=') {

430 
i
++;

431 ià(
i
 >ğ
b
->
¦’
 || b->
d©a
[i] !ğ'=' || 
	`bcÚch¬
 (
out
, 
c0
) < 0) {

432 ià(
boŞTruncE¼Ü
) {

433 *
boŞTruncE¼Ü
 = 1;

434  
out
;

436 
	`bde¡roy
 (
out
);

437  
NULL
;

439  
out
;

441 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

442 
i
++;

443 } 
v
 < 0);

444 
c1
 |ğ(è(
v
 >> 2);

445 
c2
 = (è(
v
 << 6);

447 ià(
i
 >ğ
b
->
¦’
) {

448 ià(
boŞTruncE¼Ü
) {

449 *
boŞTruncE¼Ü
 = 1;

450  
out
;

452 
	`bde¡roy
 (
out
);

453  
NULL
;

455 ià(
b
->
d©a
[
i
] == '=') {

456 ià(
	`bcÚch¬
 (
out
, 
c0
è< 0 || bcÚch¬ (out, 
c1
) < 0) {

457 ià(
boŞTruncE¼Ü
) {

458 *
boŞTruncE¼Ü
 = 1;

459  
out
;

461 
	`bde¡roy
 (
out
);

462  
NULL
;

464 ià(
boŞTruncE¼Ü
) *boolTruncError = 0;

465  
out
;

467 
v
 = 
	`ba£64DecodeSymbŞ
 (
b
->
d©a
[
i
]);

468 
i
++;

469 } 
v
 < 0);

470 
c2
 |ğ(è(
v
);

471 ià(
	`bcÚch¬
 (
out
, 
c0
) < 0 ||

472 
	`bcÚch¬
 (
out
, 
c1
) < 0 ||

473 
	`bcÚch¬
 (
out
, 
c2
) < 0) {

474 ià(
boŞTruncE¼Ü
) {

475 *
boŞTruncE¼Ü
 = -1;

476  
out
;

478 
	`bde¡roy
 (
out
);

479  
NULL
;

482 
	}
}

484 
	#UU_DECODE_BYTE
(
b
è(((bè=ğ(sigÃd )'`'è? 0 : (bè- (sigÃd )' ')

	)

486 
	sbUuInOut
 {

487 
b¡ršg
 
	m¤c
, 
	md¡
;

488 * 
	mbadlšes
;

491 
	#UU_MAX_LINELEN
 45

	)

493 
	$bUuDecLše
 (* 
·rm
, 
ofs
, 
Ën
) {

494 
bUuInOut
 * 
io
 = (bUuInOuˆ*è
·rm
;

495 
b¡ršg
 
s
 = 
io
->
¤c
;

496 
b¡ršg
 
t
 = 
io
->
d¡
;

497 
i
, 
Î’
, 
ÙËn
, 
»t
, 
c0
, 
c1
, 
c2
, 
c3
, 
d0
, 
d1
, 
d2
, 
d3
;

499 ià(
Ën
 == 0)  0;

500 
Î’
 = 
	`UU_DECODE_BYTE
 (
s
->
d©a
[
ofs
]);

501 
»t
 = 0;

503 
ÙËn
 = 
t
->
¦’
;

505 ià(((è
Î’
è> 
UU_MAX_LINELEN
è{ 
»t
 = -
__LINE__
;

506 
bl
;

509 
Î’
 +ğ
t
->
¦’
;

511 
i
=1; i < 
s
->
¦’
 && 
t
->¦’ < 
Î’
;i += 4) {

512 
outoù‘
[3];

513 
c0
 = 
	`UU_DECODE_BYTE
 (
d0
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+0, ' ' - 1));

514 
c1
 = 
	`UU_DECODE_BYTE
 (
d1
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+1, ' ' - 1));

515 
c2
 = 
	`UU_DECODE_BYTE
 (
d2
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+2, ' ' - 1));

516 
c3
 = 
	`UU_DECODE_BYTE
 (
d3
 = (è
	`bch¬e
 (
s
, 
i
+
ofs
+3, ' ' - 1));

518 ià(((è(
c0
|
c1
è>ğ0x40)è{ ià(!
»t
è»ˆğ-
__LINE__
;

519 ià(
d0
 > 0x60 || (d0 < (' ' - 1è&& !
	`is¥aû
 (d0)) ||

520 
d1
 > 0x60 || (d1 < (' ' - 1è&& !
	`is¥aû
 (d1))) {

521 
t
->
¦’
 = 
ÙËn
;

522 
bl
;

524 
c0
 = 
c1
 = 0;

526 
outoù‘
[0] = (è((
c0
 << 2è| ((è
c1
 >> 4));

527 ià(
t
->
¦’
+1 >ğ
Î’
) {

528 ià(0 > 
	`bcÚch¬
 (
t
, (è
outoù‘
[0])è -
__LINE__
;

531 ià((è
c2
 >ğ0x40è{ ià(!
»t
è»ˆğ-
__LINE__
;

532 ià(
d2
 > 0x60 || (d2 < (' ' - 1è&& !
	`is¥aû
 (d2))) {

533 
t
->
¦’
 = 
ÙËn
;

534 
bl
;

536 
c2
 = 0;

538 
outoù‘
[1] = (è((
c1
 << 4è| ((è
c2
 >> 2));

539 ià(
t
->
¦’
+2 >ğ
Î’
) {

540 ià(0 > 
	`bÿtblk
 (
t
, 
outoù‘
, 2)è -
__LINE__
;

543 ià((è
c3
 >ğ0x40è{ ià(!
»t
è»ˆğ-
__LINE__
;

544 ià(
d3
 > 0x60 || (d3 < (' ' - 1è&& !
	`is¥aû
 (d3))) {

545 
t
->
¦’
 = 
ÙËn
;

546 
bl
;

548 
c3
 = 0;

550 
outoù‘
[2] = (è((
c2
 << 6è| ((è
c3
));

551 ià(0 > 
	`bÿtblk
 (
t
, 
outoù‘
, 3)è -
__LINE__
;

553 ià(
t
->
¦’
 < 
Î’
è{ ià(0 =ğ
»t
è»ˆğ-
__LINE__
;

554 
t
->
¦’
 = 
ÙËn
;

556 
bl
:;

557 ià(
»t
 && 
io
->
badlšes
) {

558 (*
io
->
badlšes
)++;

561  
»t
;

562 
	}
}

574 #ifdeà
_MSC_VER


575 #´agm¨
w¬nšg
(
di§bË
:4204)

578 
b¡ršg
 
	$bUuDecodeEx
 (
cÚ¡_b¡ršg
 
¤c
, * 
badlšes
) {

579 
gb¡ršg
 
t
;

580 
bSŒ—m
 * 
s
;

581 
bSŒ—m
 * 
d
;

582 
b¡ršg
 
b
;

584 ià(!
¤c
è 
NULL
;

585 
t
 = *
¤c
;

586 
s
 = 
	`bsFromB¡rRef
 (&
t
);

587 ià(!
s
è 
NULL
;

588 
d
 = 
	`bsUuDecode
 (
s
, 
badlšes
);

589 
b
 = 
	`bäomc¡¿Îoc
 (256, "");

590 ià(
NULL
 =ğ
b
 || 0 > 
	`b¤—d
 (b, 
d
, 
INT_MAX
)) {

591 
	`bde¡roy
 (
b
);

592 
b
 = 
NULL
;

595 
	`bsşo£
(
d
);

596 
	`bsşo£
(
s
);

597  
b
;

598 
	}
}

600 
	sbsUuCtx
 {

601 
bUuInOut
 
	mio
;

602 
bSŒ—m
 * 
	msIÅ
;

605 
size_t
 
	$bsUuDecodeP¬t
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

606 
gb¡ršg
 
eŞ
 = 
	`bsStic
 ("\r\n");

607 
bsUuCtx
 * 
luuCtx
 = (bsUuCtx *è
·rm
;

608 
size_t
 
tsz
;

609 
l
, 
Ì‘
;

611 ià(
NULL
 =ğ
buff
 || NULL =ğ
·rm
)  0;

612 
tsz
 = 
–size
 * 
ÃËm
;

614 
CheckIÁ”ÇlBufãr
:;

616 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
è> 
tsz
) {

617 
	`memıy
 (
buff
, 
luuCtx
->
io
.
d¡
->
d©a
, 
tsz
);

618 
	`bd–‘e
 (
luuCtx
->
io
.
d¡
, 0, (è
tsz
);

619  
ÃËm
;

622 
DecodeMÜe
:;

623 ià(0 <ğ(
l
 = 
	`bšchr
 (
luuCtx
->
io
.
¤c
, 0, &
eŞ
))) {

624 
Ş
 = 0;

625 
gb¡ršg
 
t
;

626 
b¡ršg
 
s
 = 
luuCtx
->
io
.
¤c
;

627 
luuCtx
->
io
.
¤c
 = &
t
;

630 ià(
l
 > 
Ş
) {

631 
	`bmid2tb¡r
 (
t
, 
s
, 
Ş
, 
l
 - ol);

632 
Ì‘
 = 
	`bUuDecLše
 (&
luuCtx
->
io
, 0, 
t
.
¦’
);

633 ià(0 > 
Ì‘
) {

634 
luuCtx
->
io
.
¤c
 = 
s
;

635 
DÚe
;

638 
Ş
 = 
l
 + 1;

639 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
è> 
tsz
) ;

640 
l
 = 
	`bšchr
 (
s
, 
Ş
, &
eŞ
);

641 } 
BSTR_ERR
 !ğ
l
);

642 
	`bd–‘e
 (
s
, 0, 
Ş
);

643 
luuCtx
->
io
.
¤c
 = 
s
;

644 
CheckIÁ”ÇlBufãr
;

647 ià(
BSTR_ERR
 !ğ
	`b¤—da
 (
luuCtx
->
io
.
¤c
,†uuCtx->
sIÅ
, 
	`bsbufæ’gth
 (luuCtx->sIÅ, 
BSTR_BS_BUFF_LENGTH_GET
))) {

648 
DecodeMÜe
;

651 
	`bUuDecLše
 (&
luuCtx
->
io
, 0,†uuCtx->io.
¤c
->
¦’
);

653 
DÚe
:;

655 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
) > 0) {

656 ià(((
size_t
è
luuCtx
->
io
.
d¡
->
¦’
è> 
tsz
è
CheckIÁ”ÇlBufãr
;

657 
	`memıy
 (
buff
, 
luuCtx
->
io
.
d¡
->
d©a
,†uuCtx->io.d¡->
¦’
);

658 
tsz
 = 
luuCtx
->
io
.
d¡
->
¦’
 / 
–size
;

659 
luuCtx
->
io
.
d¡
->
¦’
 = 0;

660 ià(
tsz
 > 0) sz;

664 
	`bde¡roy
 (
luuCtx
->
io
.
d¡
);

665 
	`bde¡roy
 (
luuCtx
->
io
.
¤c
);

666 
	`ä“
 (
luuCtx
);

668 
	}
}

680 
bSŒ—m
 * 
	$bsUuDecode
 (
bSŒ—m
 * 
sIÅ
, * 
badlšes
) {

681 
bsUuCtx
 * 
luuCtx
 = (bsUuCtx *è
	`m®loc
 ( (bsUuCtx));

682 
bSŒ—m
 * 
sOut
;

684 ià(
NULL
 =ğ
luuCtx
)  NULL;

686 
luuCtx
->
io
.
¤c
 = 
	`bäomc¡r
 ("");

687 
luuCtx
->
io
.
d¡
 = 
	`bäomc¡r
 ("");

688 ià(
NULL
 =ğ
luuCtx
->
io
.
d¡
 || NULL =ğluuCtx->io.
¤c
) {

689 
CËªUpFau»ToAÎoÿ‹
:;

690 
	`bde¡roy
 (
luuCtx
->
io
.
d¡
);

691 
	`bde¡roy
 (
luuCtx
->
io
.
¤c
);

692 
	`ä“
 (
luuCtx
);

693  
NULL
;

695 
luuCtx
->
io
.
badlšes
 = badlines;

696 ià(
badlšes
) *badlines = 0;

698 
luuCtx
->
sIÅ
 = sInp;

700 
sOut
 = 
	`bsİ’
 ((
bN»ad
è
bsUuDecodeP¬t
, 
luuCtx
);

701 ià(
NULL
 =ğ
sOut
è
CËªUpFau»ToAÎoÿ‹
;

702  
sOut
;

703 
	}
}

705 
	#UU_ENCODE_BYTE
(
b
è(è(((bè=ğ0è? '`' : ((bè+ ' '))

	)

712 
b¡ršg
 
	$bUuEncode
 (
cÚ¡_b¡ršg
 
¤c
) {

713 
b¡ršg
 
out
;

714 
i
, 
j
, 
jm
;

715 
c0
, 
c1
, 
c2
;

716 ià(
¤c
 =ğ
NULL
 || src->
¦’
 < 0 || src->
d©a
 == NULL)  NULL;

717 ià((
out
 = 
	`bäomc¡r
 ("")è=ğ
NULL
)  NULL;

718 
i
=0; i < 
¤c
->
¦’
; i +ğ
UU_MAX_LINELEN
) {

719 ià((
jm
 = 
i
 + 
UU_MAX_LINELEN
è> 
¤c
->
¦’
) jm = src->slen;

720 ià(
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 (
jm
 - 
i
)) < 0) {

721 
	`b¡rF»e
 (
out
);

724 
j
 = 
i
; j < 
jm
; j += 3) {

725 
c0
 = (è
	`bch¬
 (
¤c
, 
j
 );

726 
c1
 = (è
	`bch¬
 (
¤c
, 
j
 + 1);

727 
c2
 = (è
	`bch¬
 (
¤c
, 
j
 + 2);

728 ià(
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 ( (
c0
 & 0xFC) >> 2)) < 0 ||

729 
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 (((
c0
 & 0x03è<< 4è| ((
c1
 & 0xF0) >> 4))) < 0 ||

730 
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 (((
c1
 & 0x0Fè<< 2è| ((
c2
 & 0xC0) >> 6))) < 0 ||

731 
	`bcÚch¬
 (
out
, 
	`UU_ENCODE_BYTE
 ( (
c2
 & 0x3F))) < 0) {

732 
	`b¡rF»e
 (
out
);

733 
End
;

736 ià(
	`bcÚch¬
 (
out
, () '\r') < 0 || bconchar (out, () '\n') < 0) {

737 
	`b¡rF»e
 (
out
);

741 
End
:;

742  
out
;

743 
	}
}

751 
b¡ršg
 
	$bYEncode
 (
cÚ¡_b¡ršg
 
¤c
) {

752 
i
;

753 
b¡ršg
 
out
;

754 
c
;

756 ià(
¤c
 =ğ
NULL
 || src->
¦’
 < 0 || src->
d©a
 == NULL)  NULL;

757 ià((
out
 = 
	`bäomc¡r
 ("")è=ğ
NULL
)  NULL;

758 
i
=0; i < 
¤c
->
¦’
; i++) {

759 
c
 = ()(
¤c
->
d©a
[
i
] + 42);

760 ià(
c
 == '=' || c == '\0' || c == '\r' || c == '\n') {

761 ià(0 > 
	`bcÚch¬
 (
out
, () '=')) {

762 
	`bde¡roy
 (
out
);

763  
NULL
;

765 
c
 += () 64;

767 ià(0 > 
	`bcÚch¬
 (
out
, 
c
)) {

768 
	`bde¡roy
 (
out
);

769  
NULL
;

772  
out
;

773 
	}
}

780 
	#MAX_OB_LEN
 (64)

	)

782 
b¡ršg
 
	$bYDecode
 (
cÚ¡_b¡ršg
 
¤c
) {

783 
i
;

784 
b¡ršg
 
out
;

785 
c
;

786 
où‘buff
[
MAX_OB_LEN
];

787 
obl
;

789 ià(
¤c
 =ğ
NULL
 || src->
¦’
 < 0 || src->
d©a
 == NULL)  NULL;

790 ià((
out
 = 
	`bäomc¡r
 ("")è=ğ
NULL
)  NULL;

792 
obl
 = 0;

794 
i
=0; i < 
¤c
->
¦’
; i++) {

795 ià('=' =ğ(
c
 = 
¤c
->
d©a
[
i
])) {

796 
i
++;

797 ià(
i
 >ğ
¤c
->
¦’
) {

798 
	`bde¡roy
 (
out
);

799  
NULL
;

801 
c
 = (è(
¤c
->
d©a
[
i
] - 64);

803 ià('\0' =ğ
c
) {

804 
	`bde¡roy
 (
out
);

805  
NULL
;

809 ià(
c
 == '\r' || c == '\n') ;

812 
où‘buff
[
obl
] = (è((è
c
 - 42);

813 
obl
++;

815 ià(
obl
 >ğ
MAX_OB_LEN
) {

816 ià(0 > 
	`bÿtblk
 (
out
, 
où‘buff
, 
obl
)) {

817 
	`bde¡roy
 (
out
);

818  
NULL
;

820 
obl
 = 0;

824 ià(0 > 
	`bÿtblk
 (
out
, 
où‘buff
, 
obl
)) {

825 
	`bde¡roy
 (
out
);

826 
out
 = 
NULL
;

828  
out
;

829 
	}
}

838 
b¡ršg
 
	$bSŒfTime
 (cÚ¡ * 
fmt
, cÚ¡ 
tm
 * 
tim•Œ
) {

839 #ià
	`defšed
 (
__TURBOC__
è&& !defšed (
__BORLANDC__
)

840 
gb¡ršg
 
ns
 = 
	`bsStic
 ("bStrfTime Not supported");

841 
fmt
 = fmt;

842 
tim•Œ
 =imeptr;

843  &
ns
;

845 
b¡ršg
 
buff
;

846 
n
;

847 
size_t
 
r
;

849 ià(
fmt
 =ğ
NULL
)  NULL;

855 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))) < 16)‚ = 16;

856 
buff
 = 
	`bäomc¡¿Îoc
 (
n
+2, "");

859 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

860 
	`bde¡roy
 (
buff
);

861  
NULL
;

864 
r
 = 
	`¡ráime
 ((*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
tim•Œ
);

866 ià(
r
 > 0) {

867 
buff
->
¦’
 = (è
r
;

871 
n
 +=‚;

874  
buff
;

876 
	}
}

886 
	$bS‘C¡rCh¬
 (
b¡ršg
 
b
, 
pos
, 
c
) {

887 ià(
NULL
 =ğ
b
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen)

888  
BSTR_ERR
;

889 ià(
pos
 < 0 ||…o > 
b
->
¦’
è 
BSTR_ERR
;

891 ià(
pos
 =ğ
b
->
¦’
) {

892 ià('\0' !ğ
c
è 
	`bcÚch¬
 (
b
, c);

896 
b
->
d©a
[
pos
] = (è
c
;

897 ià('\0' =ğ
c
è
b
->
¦’
 = 
pos
;

900 
	}
}

909 
	$bS‘Ch¬
 (
b¡ršg
 
b
, 
pos
, 
c
) {

910 ià(
NULL
 =ğ
b
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen)

911  
BSTR_ERR
;

912 ià(
pos
 < 0 ||…o > 
b
->
¦’
è 
BSTR_ERR
;

914 ià(
pos
 =ğ
b
->
¦’
) {

915  
	`bcÚch¬
 (
b
, 
c
);

918 
b
->
d©a
[
pos
] = (è
c
;

920 
	}
}

922 
	#INIT_SECURE_INPUT_LENGTH
 (256)

	)

925 
	#BWS_BUFF_SZ
 (1024)

	)

927 
	sbwr™eSŒ—m
 {

928 
b¡ršg
 
	mbuff
;

929 * 
	m·rm
;

930 
bNwr™e
 
	mwr™eFn
;

931 
	misEOF
;

932 
	mmšBuffSz
;

941 
bwr™eSŒ—m
 * 
	$bwsO³n
 (
bNwr™e
 
wr™eFn
, * 
·rm
) {

942 
bwr™eSŒ—m
 * 
ws
;

944 ià(
NULL
 =ğ
wr™eFn
)  NULL;

945 
ws
 = (
bwr™eSŒ—m
 *è
	`m®loc
 ( (bwriteStream));

946 ià(
ws
) {

947 ià(
NULL
 =ğ(
ws
->
buff
 = 
	`bäomc¡r
 (""))) {

948 
	`ä“
 (
ws
);

949 
ws
 = 
NULL
;

951 
ws
->
·rm
 =…arm;

952 
ws
->
wr™eFn
 = writeFn;

953 
ws
->
isEOF
 = 0;

954 
ws
->
mšBuffSz
 = 
BWS_BUFF_SZ
;

957  
ws
;

958 
	}
}

960 
	#š‹º®_bwswr™eout
(
ws
,
b
è{ \

	)

961 ià((
	gb
)->
	g¦’
 > 0) { \

962 ià(1 !ğ(
ws
->
wr™eFn
 ((
b
)->
d©a
, (b)->
¦’
, 1, ws->
·rm
))) { \

963 
	gws
->
	gisEOF
 = 1; \

964  
	gBSTR_ERR
; \

973 
	$bwsWr™eFlush
 (
bwr™eSŒ—m
 * 
ws
) {

974 ià(
NULL
 =ğ
ws
 || ws->
isEOF
 || 0 >ğws->
mšBuffSz
 ||

975 
NULL
 =ğ
ws
->
wr™eFn
 || NULL =ğws->
buff
è 
BSTR_ERR
;

976 
	`š‹º®_bwswr™eout
 (
ws
, ws->
buff
);

977 
ws
->
buff
->
¦’
 = 0;

979 
	}
}

987 
	$bwsWr™eB¡r
 (
bwr™eSŒ—m
 * 
ws
, 
cÚ¡_b¡ršg
 
b
) {

988 
gb¡ršg
 
t
;

989 
l
;

991 ià(
NULL
 =ğ
ws
 || NULL =ğ
b
 || NULL =ğws->
buff
 ||

992 
ws
->
isEOF
 || 0 >ğws->
mšBuffSz
 || 
NULL
 =ğws->
wr™eFn
)

993  
BSTR_ERR
;

996 ià(
b
->
¦’
 > 0 && 
ws
->
buff
->
mËn
 - ws->buff->slen > b->slen) {

997 
gb¡ršg
 
em±y
 = 
	`bsStic
 ("");

998 ià(0 > 
	`bcÚÿt
 (
ws
->
buff
, 
b
)è 
BSTR_ERR
;

999  
	`bwsWr™eB¡r
 (
ws
, &
em±y
);

1002 ià(0 > (
l
 = 
ws
->
mšBuffSz
 - ws->
buff
->
¦’
)) {

1003 
	`š‹º®_bwswr™eout
 (
ws
, ws->
buff
);

1004 
ws
->
buff
->
¦’
 = 0;

1005 
l
 = 
ws
->
mšBuffSz
;

1008 ià(
b
->
¦’
 < 
l
è 
	`bcÚÿt
 (
ws
->
buff
, b);

1010 ià(0 > 
	`bÿtblk
 (
ws
->
buff
, 
b
->
d©a
, 
l
)è 
BSTR_ERR
;

1011 
	`š‹º®_bwswr™eout
 (
ws
, ws->
buff
);

1012 
ws
->
buff
->
¦’
 = 0;

1014 
	`bmid2tb¡r
 (
t
, (
b¡ršg
è
b
, 
l
, b->
¦’
);

1016 ià(
t
.
¦’
 >ğ
ws
->
mšBuffSz
) {

1017 
	`š‹º®_bwswr™eout
 (
ws
, &
t
);

1021  
	`bassign
 (
ws
->
buff
, &
t
);

1022 
	}
}

1029 
	$bwsWr™eBlk
 (
bwr™eSŒ—m
 * 
ws
, * 
blk
, 
Ën
) {

1030 
gb¡ršg
 
t
;

1031 ià(
NULL
 =ğ
blk
 || 
Ën
 < 0è 
BSTR_ERR
;

1032 
	`blk2tb¡r
 (
t
, 
blk
, 
Ën
);

1033  
	`bwsWr™eB¡r
 (
ws
, &
t
);

1034 
	}
}

1041 
	$bwsIsEOF
 (cÚ¡ 
bwr™eSŒ—m
 * 
ws
) {

1042 ià(
NULL
 =ğ
ws
 || NULL =ğws->
buff
 || 0 > ws->
mšBuffSz
 ||

1043 
NULL
 =ğ
ws
->
wr™eFn
è 
BSTR_ERR
;

1044  
ws
->
isEOF
;

1045 
	}
}

1052 
	$bwsBuffL’gth
 (
bwr™eSŒ—m
 * 
ws
, 
sz
) {

1053 
ŞdSz
;

1054 ià(
ws
 =ğ
NULL
 || 
sz
 < 0è 
BSTR_ERR
;

1055 
ŞdSz
 = 
ws
->
mšBuffSz
;

1056 ià(
sz
 > 0è
ws
->
mšBuffSz
 = sz;

1057  
ŞdSz
;

1058 
	}
}

1066 * 
	$bwsClo£
 (
bwr™eSŒ—m
 * 
ws
) {

1067 * 
·rm
;

1068 ià(
NULL
 =ğ
ws
 || NULL =ğws->
buff
 || 0 >ğws->
mšBuffSz
 ||

1069 
NULL
 =ğ
ws
->
wr™eFn
)  NULL;

1070 
	`bwsWr™eFlush
 (
ws
);

1071 
·rm
 = 
ws
->parm;

1072 
ws
->
·rm
 = 
NULL
;

1073 
ws
->
mšBuffSz
 = -1;

1074 
ws
->
wr™eFn
 = 
NULL
;

1075 
	`b¡rF»e
 (
ws
->
buff
);

1076 
	`ä“
 (
ws
);

1077  
·rm
;

1078 
	}
}

1082 cÚ¡ 
	gFNV_PRIME
 = 16777619;

1083 cÚ¡ 
	gFNV_OFFSET_BASIS
 = 2166136261;

1086 
ušt32_t
 
	$b¡r_hash_fun
(cÚ¡ *
kv
)

1088 
b¡ršg
 
key
 = (b¡ršg)
kv
;

1089 cÚ¡ *
¡r
 = (cÚ¡ *)
	`bd©a
(
key
);

1091 
ušt32_t
 
acc
 = 
FNV_OFFSET_BASIS
;

1093 *
¡r
) {

1094 
acc
 ^ğ*
¡r
;

1095 
acc
 *ğ
FNV_PRIME
;

1096 
¡r
++;

1099  
acc
;

1100 
	}
}

	@tools/src/bstr/bstraux.h

16 #iâdeà
BSTRAUX_INCLUDE


17 
	#BSTRAUX_INCLUDE


	)

19 
	~<¡dšt.h
>

20 
	~<time.h
>

21 
	~"b¡¾ib.h
"

23 #ifdeà
__ılu¥lus


28 
	#b¡rDeş¬e
(
b
è
	`b¡ršg
 (bèğ
NULL
;

	)

29 
	#b¡rF»e
(
b
è{ià((bè!ğ
NULL
 && (b)->
¦’
 >ğ0 && (b)->
mËn
 >ğ(b)->¦’è{ 
	`bde¡roy
 (b); (bèğNULL; }}

	)

32 
	#bAssign
(
a
,
b
è((
bassign
)(×), (b)))

	)

33 
	#bSubs
(
b
,
pos
,
Ën
,
a
,
c
è((
b»¶aû
)((b),Õos),Ö’),×),()(c)))

	)

34 
	#bSŒchr
(
b
,
c
è((
b¡rchr
)((b), (c)))

	)

35 
	#bSŒchrFa¡
(
b
,
c
è((
b¡rchr
)((b), (c)))

	)

36 
	#bC©C¡r
(
b
,
s
è((
bÿtc¡r
)((b), (s)))

	)

37 
	#bC©Blk
(
b
,
s
,
Ën
è((
bÿtblk
)((b),(s),Ö’)))

	)

38 
	#bC©Stic
(
b
,
s
è
	`bC©Blk
 ((b), ("" s ""),  (sè- 1)

	)

39 
	#bTrunc
(
b
,
n
è((
bŒunc
)((b), (n)))

	)

40 
	#bR•ÏûAÎ
(
b
,
fšd
,
»¶
,
pos
è((
bfšd»¶aû
)((b),(fšd),Ô•l),Õos)))

	)

41 
	#bUµ”ÿ£
(
b
è((
btouµ”
)(b))

	)

42 
	#bLow”ÿ£
(
b
è((
btŞow”
)(b))

	)

43 
	#bCa£ËssCmp
(
a
,
b
è((
b¡ricmp
)(×), (b)))

	)

44 
	#bCa£ËssNCmp
(
a
,
b
,
n
è((
b¡ºicmp
)(×), (b), (n)))

	)

45 
	#bBa£64Decode
(
b
è(
	`bBa£64DecodeEx
 ((b), 
NULL
))

	)

46 
	#bUuDecode
(
b
è(
	`bUuDecodeEx
 ((b), 
NULL
))

	)

49 
bSŒ—m
 * 
bsFromB¡r
 (
cÚ¡_b¡ršg
 
b
);

50 
b¡ršg
 
bTa
 (b¡ršg 
b
, 
n
);

51 
b¡ršg
 
bH—d
 (b¡ršg 
b
, 
n
);

52 
bS‘C¡rCh¬
 (
b¡ršg
 
a
, 
pos
, 
c
);

53 
bS‘Ch¬
 (
b¡ršg
 
b
, 
pos
, 
c
);

54 
bFl
 (
b¡ršg
 
a
, 
c
, 
Ën
);

55 
bR•liÿ‹
 (
b¡ršg
 
b
, 
n
);

56 
bRev”£
 (
b¡ršg
 
b
);

57 
bIn£¹Chrs
 (
b¡ršg
 
b
, 
pos
, 
Ën
, 
c
, 
fl
);

58 
b¡ršg
 
bSŒfTime
 (cÚ¡ * 
fmt
, cÚ¡ 
tm
 * 
tim•Œ
);

59 
	#bAscTime
(
t
è(
	`bSŒfTime
 ("%c\n", (t)))

	)

60 
	#bCTime
(
t
è(Ñè? 
	`bAscTime
 (
	`loÿÉime
 (t)è: 
NULL
)

	)

63 
bJu¡ifyLeá
 (
b¡ršg
 
b
, 
¥aû
);

64 
bJu¡ifyRight
 (
b¡ršg
 
b
, 
width
, 
¥aû
);

65 
bJu¡ifyM¬gš
 (
b¡ršg
 
b
, 
width
, 
¥aû
);

66 
bJu¡ifyC’‹r
 (
b¡ršg
 
b
, 
width
, 
¥aû
);

69 
ušt32_t
 
b¡r_hash_fun
(cÚ¡ *
kv
);

72 * 
bSŒ2N‘SŒ
 (
cÚ¡_b¡ršg
 
b
);

73 
b¡ršg
 
bN‘SŒ2B¡r
 (cÚ¡ * 
buf
);

74 
b¡ršg
 
bBa£64Encode
 (
cÚ¡_b¡ršg
 
b
);

75 
b¡ršg
 
bBa£64DecodeEx
 (
cÚ¡_b¡ršg
 
b
, * 
boŞTruncE¼Ü
);

76 
bSŒ—m
 * 
bsUuDecode
 (bSŒ—m * 
sIÅ
, * 
badlšes
);

77 
b¡ršg
 
bUuDecodeEx
 (
cÚ¡_b¡ršg
 
¤c
, * 
badlšes
);

78 
b¡ršg
 
bUuEncode
 (
cÚ¡_b¡ršg
 
¤c
);

79 
b¡ršg
 
bYEncode
 (
cÚ¡_b¡ršg
 
¤c
);

80 
b¡ršg
 
bYDecode
 (
cÚ¡_b¡ršg
 
¤c
);

83 (* 
	gbNwr™e
è(cÚ¡ * 
	tbuf
, 
	tsize_t
 
	t–size
, size_ˆ
	tÃËm
, * 
	t·rm
);

85 
bwr™eSŒ—m
 * 
bwsO³n
 (
bNwr™e
 
wr™eFn
, * 
·rm
);

86 
bwsWr™eB¡r
 (
bwr™eSŒ—m
 * 
¡»am
, 
cÚ¡_b¡ršg
 
b
);

87 
bwsWr™eBlk
 (
bwr™eSŒ—m
 * 
¡»am
, * 
blk
, 
Ën
);

88 
bwsWr™eFlush
 (
bwr™eSŒ—m
 * 
¡»am
);

89 
bwsIsEOF
 (cÚ¡ 
bwr™eSŒ—m
 * 
¡»am
);

90 
bwsBuffL’gth
 (
bwr™eSŒ—m
 * 
¡»am
, 
sz
);

91 * 
bwsClo£
 (
bwr™eSŒ—m
 * 
¡»am
);

94 
	#bSecu»De¡roy
(
b
è{ \

	)

95 
b¡ršg
 
	gb¡r__tmp
 = (
b
); \

96 ià(
	gb¡r__tmp
 && b¡r__tmp->
	gmËn
 > 0 && b¡r__tmp->
	gd©a
) { \

97 (è
mem£t
 (
b¡r__tmp
->
d©a
, 0, (
size_t
èb¡r__tmp->
mËn
); \

98 
bde¡roy
 (
b¡r__tmp
); \

101 
	#bSecu»Wr™ePrÙeù
(
t
è{ \

	)

102 ià((
	gt
).
	gmËn
 >= 0) { \

103 ià((
t
).
mËn
 > (t).
¦’
)) { \

104 (è
mem£t
 ((
t
).
d©a
 + (t).
¦’
, 0, (
size_t
èÑ).
mËn
 - (t).slen); \

106 (
	gt
).
	gmËn
 = -1; \

110 #ifdeà
__ılu¥lus


	@tools/src/bstr/bstrlib.c

14 #ià
defšed
 (
_MSC_VER
)

16 
	#_CRT_SECURE_NO_WARNINGS


	)

19 
	~<¡dio.h
>

20 
	~<¡ddef.h
>

21 
	~<¡d¬g.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<ùy³.h
>

25 
	~"b¡¾ib.h
"

29 #ià
defšed
(
MEMORY_DEBUG
è|| defšed(
BSTRLIB_MEMORY_DEBUG
)

30 
	~"memdbg.h
"

33 #iâdeà
b¡r__®loc


34 
	#b¡r__®loc
(
x
è
	`m®loc
 (x)

	)

37 #iâdeà
b¡r__ä“


38 
	#b¡r__ä“
(
p
è
	`ä“
 (p)

	)

41 #iâdeà
b¡r__»®loc


42 
	#b¡r__»®loc
(
p
,
x
è
	`»®loc
 (Õ), (x))

	)

45 #iâdeà
b¡r__memıy


46 
	#b¡r__memıy
(
d
,
s
,
l
è
	`memıy
 ((d), (s), (l))

	)

49 #iâdeà
b¡r__memmove


50 
	#b¡r__memmove
(
d
,
s
,
l
è
	`memmove
 ((d), (s), (l))

	)

53 #iâdeà
b¡r__mem£t


54 
	#b¡r__mem£t
(
d
,
c
,
l
è
	`mem£t
 ((d), (c), (l))

	)

57 #iâdeà
b¡r__memcmp


58 
	#b¡r__memcmp
(
d
,
c
,
l
è
	`memcmp
 ((d), (c), (l))

	)

61 #iâdeà
b¡r__memchr


62 
	#b¡r__memchr
(
s
,
c
,
l
è
	`memchr
 ((s), (c), (l))

	)

67 
	#bBlockCİy
(
D
,
S
,
L
è{ ià((Lè> 0è
	`b¡r__memmove
 ((D),(S),(L)); }

	)

71 
	$¢­UpSize
 (
i
) {

72 ià(
i
 < 8) {

73 
i
 = 8;

75 
j
;

76 
j
 = (è
i
;

78 
j
 |= (j >> 1);

79 
j
 |= (j >> 2);

80 
j
 |= (j >> 4);

81 
j
 |= (j >> 8);

82 #ià(
UINT_MAX
 != 0xffff)

83 
j
 |= (j >> 16);

84 #ià(
UINT_MAX
 > 0xffffffffUL)

85 
j
 |= (j >> 32);

89 
j
++;

90 ià((è
j
 >ğ
i
) i = () j;

92  
i
;

93 
	}
}

99 
	$b®loc
 (
b¡ršg
 
b
, 
Ş’
) {

100 
Ën
;

101 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 || b->
mËn
 <= 0 ||

102 
b
->
mËn
 < b->
¦’
 || 
Ş’
 <= 0) {

103  
BSTR_ERR
;

106 ià(
Ş’
 >ğ
b
->
mËn
) {

107 * 
x
;

109 ià((
Ën
 = 
	`¢­UpSize
 (
Ş’
)è<ğ
b
->
mËn
è 
BSTR_OK
;

112 ià(7 * 
b
->
mËn
 < 8 * b->
¦’
) {

117 
»®locSŒ©egy
:;

119 
x
 = (*è
	`b¡r__»®loc
 (
b
->
d©a
, (
size_t
è
Ën
);

120 ià(
x
 =ğ
NULL
) {

125 ià(
NULL
 =ğ(
x
 = (*è
	`b¡r__»®loc
 (
b
->
d©a
, (
size_t
è(
Ën
 = 
Ş’
)))) {

126  
BSTR_ERR
;

135 ià(
NULL
 =ğ(
x
 = (*è
	`b¡r__®loc
 ((
size_t
è
Ën
))) {

140 
»®locSŒ©egy
;

143 ià(
b
->
¦’
è
	`b¡r__memıy
 ((*è
x
, (*èb->
d©a
, (
size_t
) b->slen);

144 
	`b¡r__ä“
 (
b
->
d©a
);

147 
b
->
d©a
 = 
x
;

148 
b
->
mËn
 = 
Ën
;

149 
b
->
d©a
[b->
¦’
] = () '\0';

152  
BSTR_OK
;

153 
	}
}

161 
	$b®locmš
 (
b¡ršg
 
b
, 
Ën
) {

162 * 
s
;

164 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || (b->
¦’
+1è< 0 || b->
mËn
 <= 0 ||

165 
b
->
mËn
 < b->
¦’
 || 
Ën
 <= 0) {

166  
BSTR_ERR
;

169 ià(
Ën
 < 
b
->
¦’
 + 1)†en = b->slen + 1;

171 ià(
Ën
 !ğ
b
->
mËn
) {

172 
s
 = (*è
	`b¡r__»®loc
 (
b
->
d©a
, (
size_t
è
Ën
);

173 ià(
NULL
 =ğ
s
è 
BSTR_ERR
;

174 
s
[
b
->
¦’
] = () '\0';

175 
b
->
d©a
 = 
s
;

176 
b
->
mËn
 = 
Ën
;

179  
BSTR_OK
;

180 
	}
}

187 
b¡ršg
 
	$bäomc¡r
 (cÚ¡ * 
¡r
) {

188 
b¡ršg
 
b
;

189 
i
;

190 
size_t
 
j
;

192 ià(
¡r
 =ğ
NULL
)  NULL;

193 
j
 = (
¡¾’
è(
¡r
);

194 
i
 = 
	`¢­UpSize
 ((è(
j
 + (2 - (j != 0))));

195 ià(
i
 <ğ(è
j
è 
NULL
;

197 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

198 ià(
NULL
 =ğ
b
)  NULL;

199 
b
->
¦’
 = (è
j
;

200 ià(
NULL
 =ğ(
b
->
d©a
 = (*è
	`b¡r__®loc
 (b->
mËn
 = 
i
))) {

201 
	`b¡r__ä“
 (
b
);

202  
NULL
;

205 
	`b¡r__memıy
 (
b
->
d©a
, 
¡r
, 
j
+1);

206  
b
;

207 
	}
}

215 
b¡ršg
 
	$bäomc¡¿Îoc
 (
mËn
, cÚ¡ * 
¡r
) {

216 
b¡ršg
 
b
;

217 
i
;

218 
size_t
 
j
;

220 ià(
¡r
 =ğ
NULL
)  NULL;

221 
j
 = (
¡¾’
è(
¡r
);

222 
i
 = 
	`¢­UpSize
 ((è(
j
 + (2 - (j != 0))));

223 ià(
i
 <ğ(è
j
è 
NULL
;

225 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

226 ià(
b
 =ğ
NULL
)  NULL;

227 
b
->
¦’
 = (è
j
;

228 ià(
i
 < 
mËn
) i = mlen;

230 ià(
NULL
 =ğ(
b
->
d©a
 = (*è
	`b¡r__®loc
 (b->
mËn
 = 
i
))) {

231 
	`b¡r__ä“
 (
b
);

232  
NULL
;

235 
	`b¡r__memıy
 (
b
->
d©a
, 
¡r
, 
j
+1);

236  
b
;

237 
	}
}

244 
b¡ršg
 
	$blk2b¡r
 (cÚ¡ * 
blk
, 
Ën
) {

245 
b¡ršg
 
b
;

246 
i
;

248 ià(
blk
 =ğ
NULL
 || 
Ën
 < 0)  NULL;

249 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

250 ià(
b
 =ğ
NULL
)  NULL;

251 
b
->
¦’
 = 
Ën
;

253 
i
 = 
Ën
 + (2 - (len != 0));

254 
i
 = 
	`¢­UpSize
 (i);

256 
b
->
mËn
 = 
i
;

258 
b
->
d©a
 = (*è
	`b¡r__®loc
 ((
size_t
èb->
mËn
);

259 ià(
b
->
d©a
 =ğ
NULL
) {

260 
	`b¡r__ä“
 (
b
);

261  
NULL
;

264 ià(
Ën
 > 0è
	`b¡r__memıy
 (
b
->
d©a
, 
blk
, (
size_t
)†en);

265 
b
->
d©a
[
Ën
] = () '\0';

267  
b
;

268 
	}
}

277 * 
	$b¡r2c¡r
 (
cÚ¡_b¡ršg
 
b
, 
z
) {

278 
i
, 
l
;

279 * 
r
;

281 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

282 
l
 = 
b
->
¦’
;

283 
r
 = (*è
	`b¡r__®loc
 ((
size_t
è(
l
 + 1));

284 ià(
r
 =ğ
NULL
) „;

286 
i
=0; i < 
l
; i ++) {

287 
r
[
i
] = (è((
b
->
d©a
[i] =ğ'\0'è? 
z
 : () (b->data[i]));

290 
r
[
l
] = () '\0';

292  
r
;

293 
	}
}

306 
	$bc¡rä“
 (* 
s
) {

307 ià(
s
) {

308 
	`b¡r__ä“
 (
s
);

309  
BSTR_OK
;

311  
BSTR_ERR
;

312 
	}
}

318 
	$bcÚÿt
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
) {

319 
Ën
, 
d
;

320 
b¡ršg
 
aux
 = (b¡ršgè
b1
;

322 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 =ğNULL || b1->d©¨=ğNULLè 
BSTR_ERR
;

324 
d
 = 
b0
->
¦’
;

325 
Ën
 = 
b1
->
¦’
;

326 ià((
d
 | (
b0
->
mËn
 - dè| 
Ën
 | (d +†’)è< 0è 
BSTR_ERR
;

328 ià(
b0
->
mËn
 <ğ
d
 + 
Ën
 + 1) {

329 
±rdiff_t
 
pd
 = 
b1
->
d©a
 - 
b0
->data;

330 ià(0 <ğ
pd
 &&…d < 
b0
->
mËn
) {

331 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b1
))è 
BSTR_ERR
;

333 ià(
	`b®loc
 (
b0
, 
d
 + 
Ën
 + 1è!ğ
BSTR_OK
) {

334 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

335  
BSTR_ERR
;

339 
	`bBlockCİy
 (&
b0
->
d©a
[
d
], &
aux
->d©a[0], (
size_t
è
Ën
);

340 
b0
->
d©a
[
d
 + 
Ën
] = () '\0';

341 
b0
->
¦’
 = 
d
 + 
Ën
;

342 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

343  
BSTR_OK
;

344 
	}
}

350 
	$bcÚch¬
 (
b¡ršg
 
b
, 
c
) {

351 
d
;

353 ià(
b
 =ğ
NULL
è 
BSTR_ERR
;

354 
d
 = 
b
->
¦’
;

355 ià((
d
 | (
b
->
mËn
 - d)è< 0 || 
	`b®loc
 (b, d + 2è!ğ
BSTR_OK
è 
BSTR_ERR
;

356 
b
->
d©a
[
d
] = (è
c
;

357 
b
->
d©a
[
d
 + 1] = () '\0';

358 
b
->
¦’
++;

359  
BSTR_OK
;

360 
	}
}

366 
	$bÿtc¡r
 (
b¡ršg
 
b
, cÚ¡ * 
s
) {

367 * 
d
;

368 
i
, 
l
;

370 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 || b->
mËn
 < b->slen

371 || 
b
->
mËn
 <ğ0 || 
s
 =ğ
NULL
è 
BSTR_ERR
;

374 
l
 = 
b
->
mËn
 - b->
¦’
;

375 
d
 = (*è&
b
->
d©a
[b->
¦’
];

376 
i
=0; i < 
l
; i++) {

377 ià((*
d
++ = *
s
++) == '\0') {

378 
b
->
¦’
 +ğ
i
;

379  
BSTR_OK
;

382 
b
->
¦’
 +ğ
i
;

385  
	`bÿtblk
 (
b
, (cÚ¡ *è
s
, (è
	`¡¾’
 (s));

386 
	}
}

392 
	$bÿtblk
 (
b¡ršg
 
b
, cÚ¡ * 
s
, 
Ën
) {

393 
Æ
;

395 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 || b->
mËn
 < b->slen

396 || 
b
->
mËn
 <ğ0 || 
s
 =ğ
NULL
 || 
Ën
 < 0è 
BSTR_ERR
;

398 ià(0 > (
Æ
 = 
b
->
¦’
 + 
Ën
)è 
BSTR_ERR
;

399 ià(
b
->
mËn
 <ğ
Æ
 && 0 > 
	`b®loc
 (b,‚È+ 1)è 
BSTR_ERR
;

401 
	`bBlockCİy
 (&
b
->
d©a
[b->
¦’
], 
s
, (
size_t
è
Ën
);

402 
b
->
¦’
 = 
Æ
;

403 
b
->
d©a
[
Æ
] = () '\0';

404  
BSTR_OK
;

405 
	}
}

411 
b¡ršg
 
	$b¡rıy
 (
cÚ¡_b¡ršg
 
b
) {

412 
b¡ršg
 
b0
;

413 
i
,
j
;

416 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

418 
b0
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

419 ià(
b0
 =ğ
NULL
) {

421  
NULL
;

424 
i
 = 
b
->
¦’
;

425 
j
 = 
	`¢­UpSize
 (
i
 + 1);

427 
b0
->
d©a
 = (*è
	`b¡r__®loc
 (
j
);

428 ià(
b0
->
d©a
 =ğ
NULL
) {

429 
j
 = 
i
 + 1;

430 
b0
->
d©a
 = (*è
	`b¡r__®loc
 (
j
);

431 ià(
b0
->
d©a
 =ğ
NULL
) {

433 
	`b¡r__ä“
 (
b0
);

434  
NULL
;

438 
b0
->
mËn
 = 
j
;

439 
b0
->
¦’
 = 
i
;

441 ià(
i
è
	`b¡r__memıy
 ((*è
b0
->
d©a
, (*è
b
->data, i);

442 
b0
->
d©a
[b0->
¦’
] = () '\0';

444  
b0
;

445 
	}
}

451 
	$bassign
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
) {

452 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0)

453  
BSTR_ERR
;

454 ià(
b
->
¦’
 != 0) {

455 ià(
	`b®loc
 (
a
, 
b
->
¦’
è!ğ
BSTR_OK
è 
BSTR_ERR
;

456 
	`b¡r__memmove
 (
a
->
d©a
, 
b
->d©a, b->
¦’
);

458 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

459 
a
->
¦’
 < 0 ||‡->
mËn
 == 0)

460  
BSTR_ERR
;

462 
a
->
d©a
[
b
->
¦’
] = () '\0';

463 
a
->
¦’
 = 
b
->slen;

464  
BSTR_OK
;

465 
	}
}

473 
	$bassignmid¡r
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
) {

474 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0)

475  
BSTR_ERR
;

477 ià(
Ëá
 < 0) {

478 
Ën
 +ğ
Ëá
;

479 
Ëá
 = 0;

482 ià(
Ën
 > 
b
->
¦’
 - 
Ëá
)†en = b->slen -†eft;

484 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

485 
a
->
¦’
 < 0 ||‡->
mËn
 == 0)

486  
BSTR_ERR
;

488 ià(
Ën
 > 0) {

489 ià(
	`b®loc
 (
a
, 
Ën
è!ğ
BSTR_OK
è 
BSTR_ERR
;

490 
	`b¡r__memmove
 (
a
->
d©a
, 
b
->d©¨+ 
Ëá
, 
Ën
);

491 
a
->
¦’
 = 
Ën
;

493 
a
->
¦’
 = 0;

495 
a
->
d©a
[a->
¦’
] = () '\0';

496  
BSTR_OK
;

497 
	}
}

505 
	$bassignc¡r
 (
b¡ršg
 
a
, cÚ¡ * 
¡r
) {

506 
i
;

507 
size_t
 
Ën
;

508 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

509 
a
->
¦’
 < 0 ||‡->
mËn
 =ğ0 || 
NULL
 =ğ
¡r
)

510  
BSTR_ERR
;

512 
i
=0; i < 
a
->
mËn
; i++) {

513 ià('\0' =ğ(
a
->
d©a
[
i
] = 
¡r
[i])) {

514 
a
->
¦’
 = 
i
;

515  
BSTR_OK
;

519 
a
->
¦’
 = 
i
;

520 
Ën
 = 
	`¡¾’
 (
¡r
 + 
i
);

521 ià(
Ën
 > 
INT_MAX
 || 
i
 +†en + 1 > INT_MAX ||

522 0 > 
	`b®loc
 (
a
, (è(
i
 + 
Ën
 + 1))è 
BSTR_ERR
;

523 
	`bBlockCİy
 (
a
->
d©a
 + 
i
, 
¡r
 + i, (
size_t
è
Ën
 + 1);

524 
a
->
¦’
 +ğ(è
Ën
;

525  
BSTR_OK
;

526 
	}
}

534 
	$bassignblk
 (
b¡ršg
 
a
, cÚ¡ * 
s
, 
Ën
) {

535 ià(
a
 =ğ
NULL
 ||‡->
d©a
 =ğNULL ||‡->
mËn
 <‡->
¦’
 ||

536 
a
->
¦’
 < 0 ||‡->
mËn
 =ğ0 || 
NULL
 =ğ
s
 || 
Ën
 + 1 < 1)

537  
BSTR_ERR
;

538 ià(
Ën
 + 1 > 
a
->
mËn
 && 0 > 
	`b®loc
 (a,†’ + 1)è 
BSTR_ERR
;

539 
	`bBlockCİy
 (
a
->
d©a
, 
s
, (
size_t
è
Ën
);

540 
a
->
d©a
[
Ën
] = () '\0';

541 
a
->
¦’
 = 
Ën
;

542  
BSTR_OK
;

543 
	}
}

549 
	$bŒunc
 (
b¡ršg
 
b
, 
n
) {

550 ià(
n
 < 0 || 
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

551 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

552 ià(
b
->
¦’
 > 
n
) {

553 
b
->
¦’
 = 
n
;

554 
b
->
d©a
[
n
] = () '\0';

556  
BSTR_OK
;

557 
	}
}

559 
	#upÿ£
(
c
è(
	`touµ”
 ((èc))

	)

560 
	#downÿ£
(
c
è(
	`tŞow”
 ((èc))

	)

561 
	#w¥aû
(
c
è(
	`is¥aû
 ((èc))

	)

567 
	$btouµ”
 (
b¡ršg
 
b
) {

568 
i
, 
Ën
;

569 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

570 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

571 
i
=0, 
Ën
 = 
b
->
¦’
; i <†en; i++) {

572 
b
->
d©a
[
i
] = (è
	`upÿ£
 (b->data[i]);

574  
BSTR_OK
;

575 
	}
}

581 
	$btŞow”
 (
b¡ršg
 
b
) {

582 
i
, 
Ën
;

583 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

584 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

585 
i
=0, 
Ën
 = 
b
->
¦’
; i <†en; i++) {

586 
b
->
d©a
[
i
] = (è
	`downÿ£
 (b->data[i]);

588  
BSTR_OK
;

589 
	}
}

600 
	$b¡ricmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

601 
i
, 
v
, 
n
;

603 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 ||

604 
	`bd©a
 (
b1
è=ğ
NULL
 || b1->
¦’
 < 0è 
SHRT_MIN
;

605 ià((
n
 = 
b0
->
¦’
è> 
b1
->slen)‚ = b1->slen;

606 ià(
b0
->
¦’
 =ğ
b1
->¦’ && b0->
d©a
 =ğb1->d©aè 
BSTR_OK
;

608 
i
 = 0; i < 
n
; i ++) {

609 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
i
])

610 - (è
	`downÿ£
 (
b1
->
d©a
[
i
]);

611 ià(0 !ğ
v
)  v;

614 ià(
b0
->
¦’
 > 
n
) {

615 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
n
]);

616 ià(
v
)  v;

617  
UCHAR_MAX
 + 1;

619 ià(
b1
->
¦’
 > 
n
) {

620 
v
 = - (è
	`downÿ£
 (
b1
->
d©a
[
n
]);

621 ià(
v
)  v;

622  - (è(
UCHAR_MAX
 + 1);

624  
BSTR_OK
;

625 
	}
}

637 
	$b¡ºicmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
) {

638 
i
, 
v
, 
m
;

640 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 ||

641 
	`bd©a
 (
b1
è=ğ
NULL
 || b1->
¦’
 < 0 || 
n
 < 0è 
SHRT_MIN
;

642 
m
 = 
n
;

643 ià(
m
 > 
b0
->
¦’
) m = b0->slen;

644 ià(
m
 > 
b1
->
¦’
) m = b1->slen;

646 ià(
b0
->
d©a
 !ğ
b1
->data) {

647 
i
 = 0; i < 
m
; i ++) {

648 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
i
]);

649 
v
 -ğ(è
	`downÿ£
 (
b1
->
d©a
[
i
]);

650 ià(
v
 !ğ0è 
b0
->
d©a
[
i
] - 
b1
->data[i];

654 ià(
n
 =ğ
m
 || 
b0
->
¦’
 =ğ
b1
->¦’è 
BSTR_OK
;

656 ià(
b0
->
¦’
 > 
m
) {

657 
v
 = (è
	`downÿ£
 (
b0
->
d©a
[
m
]);

658 ià(
v
)  v;

659  
UCHAR_MAX
 + 1;

662 
v
 = - (è
	`downÿ£
 (
b1
->
d©a
[
m
]);

663 ià(
v
)  v;

664  - (è(
UCHAR_MAX
 + 1);

665 
	}
}

675 
	$bi£qÿ£Ëss
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

676 
i
, 
n
;

678 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 ||

679 
	`bd©a
 (
b1
è=ğ
NULL
 || b1->
¦’
 < 0è 
BSTR_ERR
;

680 ià(
b0
->
¦’
 !ğ
b1
->¦’è 
BSTR_OK
;

681 ià(
b0
->
d©a
 =ğ
b1
->d©¨|| b0->
¦’
 == 0)  1;

682 
i
=0, 
n
=
b0
->
¦’
; i <‚; i++) {

683 ià(
b0
->
d©a
[
i
] !ğ
b1
->data[i]) {

684 
c
 = (è
	`downÿ£
 (
b0
->
d©a
[
i
]);

685 ià(
c
 !ğ(è
	`downÿ£
 (
b1
->
d©a
[
i
]))  0;

689 
	}
}

700 
	$bis¡emeqÿ£Ëssblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
) {

701 
i
;

703 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 || NULL =ğ
blk
 || 
Ën
 < 0)

704  
BSTR_ERR
;

705 ià(
b0
->
¦’
 < 
Ën
è 
BSTR_OK
;

706 ià(
b0
->
d©a
 =ğ(cÚ¡ *è
blk
 || 
Ën
 == 0)  1;

708 
i
 = 0; i < 
Ën
; i ++) {

709 ià(
b0
->
d©a
[
i
] !ğ((cÚ¡ *è
blk
)[i]) {

710 ià(
	`downÿ£
 (
b0
->
d©a
[
i
]) !=

711 
	`downÿ£
 (((cÚ¡ *è
blk
)[
i
]))  0;

715 
	}
}

722 
	$bÉrimws
 (
b¡ršg
 
b
) {

723 
i
, 
Ën
;

725 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

726 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

728 
Ën
 = 
b
->
¦’
, 
i
 = 0; i <†en; i++) {

729 ià(!
	`w¥aû
 (
b
->
d©a
[
i
])) {

730  
	`bd–‘e
 (
b
, 0, 
i
);

734 
b
->
d©a
[0] = () '\0';

735 
b
->
¦’
 = 0;

736  
BSTR_OK
;

737 
	}
}

744 
	$b¹rimws
 (
b¡ršg
 
b
) {

745 
i
;

747 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

748 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

750 
i
 = 
b
->
¦’
 - 1; i >= 0; i--) {

751 ià(!
	`w¥aû
 (
b
->
d©a
[
i
])) {

752 ià(
b
->
mËn
 > 
i
èb->
d©a
[i+1] = () '\0';

753 
b
->
¦’
 = 
i
 + 1;

754  
BSTR_OK
;

758 
b
->
d©a
[0] = () '\0';

759 
b
->
¦’
 = 0;

760  
BSTR_OK
;

761 
	}
}

768 
	$bŒimws
 (
b¡ršg
 
b
) {

769 
i
, 
j
;

771 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
mËn
 < b->
¦’
 ||

772 
b
->
¦’
 < 0 || b->
mËn
 <ğ0è 
BSTR_ERR
;

774 
i
 = 
b
->
¦’
 - 1; i >= 0; i--) {

775 ià(!
	`w¥aû
 (
b
->
d©a
[
i
])) {

776 ià(
b
->
mËn
 > 
i
èb->
d©a
[i+1] = () '\0';

777 
b
->
¦’
 = 
i
 + 1;

778 
j
 = 0; 
	`w¥aû
 (
b
->
d©a
[j]); j++) {}

779  
	`bd–‘e
 (
b
, 0, 
j
);

783 
b
->
d©a
[0] = () '\0';

784 
b
->
¦’
 = 0;

785  
BSTR_OK
;

786 
	}
}

795 
	$bi£q
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

796 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 == NULL || b1->data == NULL ||

797 
b0
->
¦’
 < 0 || 
b1
->¦’ < 0è 
BSTR_ERR
;

798 ià(
b0
->
¦’
 !ğ
b1
->¦’è 
BSTR_OK
;

799 ià(
b0
->
d©a
 =ğ
b1
->d©¨|| b0->
¦’
 == 0)  1;

800  !
	`b¡r__memcmp
 (
b0
->
d©a
, 
b1
->d©a, b0->
¦’
);

801 
	}
}

811 
	$bis¡emeqblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
) {

812 
i
;

814 ià(
	`bd©a
 (
b0
è=ğ
NULL
 || b0->
¦’
 < 0 || NULL =ğ
blk
 || 
Ën
 < 0)

815  
BSTR_ERR
;

816 ià(
b0
->
¦’
 < 
Ën
è 
BSTR_OK
;

817 ià(
b0
->
d©a
 =ğ(cÚ¡ *è
blk
 || 
Ën
 == 0)  1;

819 
i
 = 0; i < 
Ën
; i ++) {

820 ià(
b0
->
d©a
[
i
] !ğ((cÚ¡ *è
blk
)[i]è 
BSTR_OK
;

823 
	}
}

836 
	$bi£qc¡r
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
) {

837 
i
;

838 ià(
b
 =ğ
NULL
 || 
s
 =ğNULL || b->
d©a
 =ğNULL || b->
¦’
 < 0è 
BSTR_ERR
;

839 
i
=0; i < 
b
->
¦’
; i++) {

840 ià(
s
[
i
] =ğ'\0' || 
b
->
d©a
[i] !ğ(ès[i]è 
BSTR_OK
;

842  
s
[
i
] == '\0';

843 
	}
}

857 
	$bi£qc¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
) {

858 
i
;

859 ià(
b
 =ğ
NULL
 || 
s
 =ğNULL || b->
d©a
 =ğNULL || b->
¦’
 < 0è 
BSTR_ERR
;

860 
i
=0; i < 
b
->
¦’
; i++) {

861 ià(
s
[
i
] == '\0' ||

862 (
b
->
d©a
[
i
] !ğ(è
s
[i] &&

863 
	`downÿ£
 (
b
->
d©a
[
i
]è!ğ(èdownÿ£ (
s
[i])))

864  
BSTR_OK
;

866  
s
[
i
] == '\0';

867 
	}
}

883 
	$b¡rcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
) {

884 
i
, 
v
, 
n
;

886 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 == NULL || b1->data == NULL ||

887 
b0
->
¦’
 < 0 || 
b1
->¦’ < 0è 
SHRT_MIN
;

888 
n
 = 
b0
->
¦’
; iàÒ > 
b1
->slen)‚ = b1->slen;

889 ià(
b0
->
¦’
 =ğ
b1
->¦’ && (b0->
d©a
 == b1->data || b0->slen == 0))

890  
BSTR_OK
;

892 
i
 = 0; i < 
n
; i ++) {

893 
v
 = ((è
b0
->
d©a
[
i
]è- ((è
b1
->data[i]);

894 ià(
v
 != 0)  v;

895 ià(
b0
->
d©a
[
i
] =ğ(è'\0'è 
BSTR_OK
;

898 ià(
b0
->
¦’
 > 
n
)  1;

899 ià(
b1
->
¦’
 > 
n
)  -1;

900  
BSTR_OK
;

901 
	}
}

913 
	$b¡ºcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
) {

914 
i
, 
v
, 
m
;

916 ià(
b0
 =ğ
NULL
 || 
b1
 =ğNULL || b0->
d©a
 == NULL || b1->data == NULL ||

917 
b0
->
¦’
 < 0 || 
b1
->¦’ < 0è 
SHRT_MIN
;

918 
m
 = 
n
;

919 ià(
m
 > 
b0
->
¦’
) m = b0->slen;

920 ià(
m
 > 
b1
->
¦’
) m = b1->slen;

922 ià(
b0
->
d©a
 !ğ
b1
->data) {

923 
i
 = 0; i < 
m
; i ++) {

924 
v
 = ((è
b0
->
d©a
[
i
]è- ((è
b1
->data[i]);

925 ià(
v
 != 0)  v;

926 ià(
b0
->
d©a
[
i
] =ğ(è'\0'è 
BSTR_OK
;

930 ià(
n
 =ğ
m
 || 
b0
->
¦’
 =ğ
b1
->¦’è 
BSTR_OK
;

932 ià(
b0
->
¦’
 > 
m
)  1;

934 
	}
}

943 
b¡ršg
 
	$bmid¡r
 (
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
) {

945 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
d©a
 == NULL)  NULL;

947 ià(
Ëá
 < 0) {

948 
Ën
 +ğ
Ëá
;

949 
Ëá
 = 0;

952 ià(
Ën
 > 
b
->
¦’
 - 
Ëá
)†en = b->slen -†eft;

954 ià(
Ën
 <ğ0è 
	`bäomc¡r
 ("");

955  
	`blk2b¡r
 (
b
->
d©a
 + 
Ëá
, 
Ën
);

956 
	}
}

965 
	$bd–‘e
 (
b¡ršg
 
b
, 
pos
, 
Ën
) {

967 ià(
pos
 < 0) {

968 
Ën
 +ğ
pos
;

969 
pos
 = 0;

972 ià(
Ën
 < 0 || 
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 < 0 ||

973 
b
->
mËn
 < b->
¦’
 || b->mlen <= 0)

974  
BSTR_ERR
;

975 ià(
Ën
 > 0 && 
pos
 < 
b
->
¦’
) {

976 ià(
pos
 + 
Ën
 >ğ
b
->
¦’
) {

977 
b
->
¦’
 = 
pos
;

979 
	`bBlockCİy
 ((*è(
b
->
d©a
 + 
pos
),

980 (*è(
b
->
d©a
 + 
pos
 + 
Ën
),

981 
b
->
¦’
 - (
pos
+
Ën
));

982 
b
->
¦’
 -ğ
Ën
;

984 
b
->
d©a
[b->
¦’
] = () '\0';

986  
BSTR_OK
;

987 
	}
}

996 
	$bde¡roy
 (
b¡ršg
 
b
) {

997 ià(
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 <= 0 || b->mlen < b->slen ||

998 
b
->
d©a
 =ğ
NULL
)

999  
BSTR_ERR
;

1001 
	`b¡r__ä“
 (
b
->
d©a
);

1006 
b
->
¦’
 = -1;

1007 
b
->
mËn
 = -
__LINE__
;

1008 
b
->
d©a
 = 
NULL
;

1010 
	`b¡r__ä“
 (
b
);

1011  
BSTR_OK
;

1012 
	}
}

1023 
	$bš¡r
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1024 
j
, 
ii
, 
Î
, 
lf
;

1025 * 
d0
;

1026 
c0
;

1027 * 
d1
;

1028 
c1
;

1029 
i
;

1031 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1032 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1033 ià(
b1
->
¦’
 =ğ
pos
è (
b2
->¦’ =ğ0)?pos:
BSTR_ERR
;

1034 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1035 ià(
b2
->
¦’
 =ğ0è 
pos
;

1038 ià((
lf
 = 
b1
->
¦’
 - 
b2
->¦’ + 1è<ğ
pos
è 
BSTR_ERR
;

1041 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 == 0)  0;

1043 
i
 = 
pos
;

1045 
d0
 = 
b2
->
d©a
;

1046 
d1
 = 
b1
->
d©a
;

1047 
Î
 = 
b2
->
¦’
;

1050 
c0
 = 
d0
[0];

1051 ià(1 =ğ
Î
) {

1052 ;
i
 < 
lf
; i++èià(
c0
 =ğ
d1
[i])  i;

1053  
BSTR_ERR
;

1056 
c1
 = 
c0
;

1057 
j
 = 0;

1058 
lf
 = 
b1
->
¦’
 - 1;

1060 
ii
 = -1;

1061 ià(
i
 < 
lf
) do {

1063 ià(
c1
 !ğ
d1
[
i
]) {

1064 ià(
c1
 !ğ
d1
[1+
i
]) {

1065 
i
 += 2;

1068 
i
++;

1072 ià(0 =ğ
j
è
ii
 = 
i
;

1075 
j
++;

1076 
i
++;

1079 ià(
j
 < 
Î
) {

1080 
c1
 = 
d0
[
j
];

1084 
N0
:;

1087 ià(
i
 =ğ
ii
+
j
)  ii;

1090 
i
 -ğ
j
;

1091 
j
 = 0;

1092 
c1
 = 
c0
;

1093 } 
i
 < 
lf
);

1096 ià(
i
 =ğ
lf
 && 
Î
 =ğ
j
+1 && 
c1
 =ğ
d1
[i]è
N0
;

1098  
BSTR_ERR
;

1099 
	}
}

1110 
	$bš¡¼
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1111 
j
, 
i
, 
l
;

1112 * 
d0
, * 
d1
;

1114 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1115 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1116 ià(
b1
->
¦’
 =ğ
pos
 && 
b2
->slen == 0) …os;

1117 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1118 ià(
b2
->
¦’
 =ğ0è 
pos
;

1121 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 =ğ0 && b2->
¦’
 <= b1->slen)  0;

1123 
i
 = 
pos
;

1124 ià((
l
 = 
b1
->
¦’
 - 
b2
->¦’è< 0è 
BSTR_ERR
;

1127 ià(
l
 + 1 <ğ
i
) i =†;

1128 
j
 = 0;

1130 
d0
 = 
b2
->
d©a
;

1131 
d1
 = 
b1
->
d©a
;

1132 
l
 = 
b2
->
¦’
;

1135 ià(
d0
[
j
] =ğ
d1
[
i
 + j]) {

1136 
j
 ++;

1137 ià(
j
 >ğ
l
è 
i
;

1139 
i
 --;

1140 ià(
i
 < 0) ;

1141 
j
=0;

1145  
BSTR_ERR
;

1146 
	}
}

1157 
	$bš¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1158 
j
, 
i
, 
l
, 
Î
;

1159 * 
d0
, * 
d1
;

1161 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1162 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1163 ià(
b1
->
¦’
 =ğ
pos
è (
b2
->¦’ =ğ0)?pos:
BSTR_ERR
;

1164 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1165 ià(
b2
->
¦’
 =ğ0è 
pos
;

1167 
l
 = 
b1
->
¦’
 - 
b2
->slen + 1;

1170 ià(
l
 <ğ
pos
è 
BSTR_ERR
;

1173 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 =ğ0è 
BSTR_OK
;

1175 
i
 = 
pos
;

1176 
j
 = 0;

1178 
d0
 = 
b2
->
d©a
;

1179 
d1
 = 
b1
->
d©a
;

1180 
Î
 = 
b2
->
¦’
;

1183 ià(
d0
[
j
] =ğ
d1
[
i
 + j] || 
	`downÿ£
 (d0[j]) == downcase (d1[i + j])) {

1184 
j
 ++;

1185 ià(
j
 >ğ
Î
è 
i
;

1187 
i
 ++;

1188 ià(
i
 >ğ
l
) ;

1189 
j
=0;

1193  
BSTR_ERR
;

1194 
	}
}

1205 
	$bš¡¼ÿ£Ëss
 (
cÚ¡_b¡ršg
 
b1
, 
pos
, cÚ¡_b¡ršg 
b2
) {

1206 
j
, 
i
, 
l
;

1207 * 
d0
, * 
d1
;

1209 ià(
b1
 =ğ
NULL
 || b1->
d©a
 =ğNULL || b1->
¦’
 < 0 ||

1210 
b2
 =ğ
NULL
 || b2->
d©a
 =ğNULL || b2->
¦’
 < 0è 
BSTR_ERR
;

1211 ià(
b1
->
¦’
 =ğ
pos
 && 
b2
->slen == 0) …os;

1212 ià(
b1
->
¦’
 < 
pos
 ||…o < 0è 
BSTR_ERR
;

1213 ià(
b2
->
¦’
 =ğ0è 
pos
;

1216 ià(
b1
->
d©a
 =ğ
b2
->d©¨&& 
pos
 =ğ0 && b2->
¦’
 <ğb1->¦’è 
BSTR_OK
;

1218 
i
 = 
pos
;

1219 ià((
l
 = 
b1
->
¦’
 - 
b2
->¦’è< 0è 
BSTR_ERR
;

1222 ià(
l
 + 1 <ğ
i
) i =†;

1223 
j
 = 0;

1225 
d0
 = 
b2
->
d©a
;

1226 
d1
 = 
b1
->
d©a
;

1227 
l
 = 
b2
->
¦’
;

1230 ià(
d0
[
j
] =ğ
d1
[
i
 + j] || 
	`downÿ£
 (d0[j]) == downcase (d1[i + j])) {

1231 
j
 ++;

1232 ià(
j
 >ğ
l
è 
i
;

1234 
i
 --;

1235 ià(
i
 < 0) ;

1236 
j
=0;

1240  
BSTR_ERR
;

1241 
	}
}

1249 
	$b¡rch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
) {

1250 * 
p
;

1252 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 <ğ
pos
 ||…o < 0è 
BSTR_ERR
;

1253 
p
 = (*è
	`b¡r__memchr
 ((
b
->
d©a
 + 
pos
), (è
c
, (b->
¦’
 -…os));

1254 ià(
p
è (èÕ - 
b
->
d©a
);

1255  
BSTR_ERR
;

1256 
	}
}

1263 
	$b¡¼ch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
) {

1264 
i
;

1266 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 <ğ
pos
 ||…o < 0è 
BSTR_ERR
;

1267 
i
=
pos
; i >= 0; i--) {

1268 ià(
b
->
d©a
[
i
] =ğ(è
c
)  i;

1270  
BSTR_ERR
;

1271 
	}
}

1273 #ià!
defšed
 (
BSTRLIB_AGGRESSIVE_MEMORY_FOR_SPEED_TRADEOFF
)

1274 
	#LONG_LOG_BITS_QTY
 (3)

	)

1275 
	#LONG_BITS_QTY
 (1 << 
LONG_LOG_BITS_QTY
)

	)

1276 
	#LONG_TYPE
 

	)

1278 
	#CFCLEN
 ((1 << 
CHAR_BIT
è/ 
LONG_BITS_QTY
)

	)

1279 
	sch¬F›ld
 { 
LONG_TYPE
 
	mcÚ‹Á
[
CFCLEN
]; };

1280 
	#‹¡InCh¬F›ld
(
cf
,
c
è((cf)->
cÚ‹Á
[(cè>> 
LONG_LOG_BITS_QTY
] & ((()1è<< ((cè& (
LONG_BITS_QTY
-1))))

	)

1281 
	#£tInCh¬F›ld
(
cf
,
idx
è{ \

	)

1282 
	gc
 = (è(
idx
); \

1283 (
	gcf
)->
	gcÚ‹Á
[
c
 >> 
LONG_LOG_BITS_QTY
] |ğ(
LONG_TYPE
è(1uÈ<< (ø& (
LONG_BITS_QTY
-1))); \

1288 
	#CFCLEN
 (1 << 
CHAR_BIT
)

	)

1289 
	sch¬F›ld
 { 
	mcÚ‹Á
[
CFCLEN
]; };

1290 
	#‹¡InCh¬F›ld
(
cf
,
c
è((cf)->
cÚ‹Á
[(è(c)])

	)

1291 
	#£tInCh¬F›ld
(
cf
,
idx
è(cf)->
cÚ‹Á
[(è(idx)] = ~0

	)

1296 
	$budCh¬F›ld
 (
ch¬F›ld
 * 
cf
, 
cÚ¡_b¡ršg
 
b
) {

1297 
i
;

1298 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || b->
¦’
 <ğ0è 
BSTR_ERR
;

1299 
	`mem£t
 ((*è
cf
->
cÚ‹Á
, 0,  (
ch¬F›ld
));

1300 
i
=0; i < 
b
->
¦’
; i++) {

1301 
	`£tInCh¬F›ld
 (
cf
, 
b
->
d©a
[
i
]);

1303  
BSTR_OK
;

1304 
	}
}

1306 
	$šv”tCh¬F›ld
 (
ch¬F›ld
 * 
cf
) {

1307 
i
;

1308 
i
=0; i < 
CFCLEN
; i++è
cf
->
cÚ‹Á
[i] = ~cf->content[i];

1309 
	}
}

1312 
	$bšchrCF
 (cÚ¡ * 
d©a
, 
Ën
, 
pos
, cÚ¡ 
ch¬F›ld
 * 
cf
) {

1313 
i
;

1314 
i
=
pos
; i < 
Ën
; i++) {

1315 
c
 = (è
d©a
[
i
];

1316 ià(
	`‹¡InCh¬F›ld
 (
cf
, 
c
)è 
i
;

1318  
BSTR_ERR
;

1319 
	}
}

1327 
	$bšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1328 
ch¬F›ld
 
chrs
;

1329 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 == NULL ||

1330 
b0
->
¦’
 <ğ
pos
è 
BSTR_ERR
;

1331 ià(1 =ğ
b1
->
¦’
è 
	`b¡rch½
 (
b0
, b1->
d©a
[0], 
pos
);

1332 ià(0 > 
	`budCh¬F›ld
 (&
chrs
, 
b1
)è 
BSTR_ERR
;

1333  
	`bšchrCF
 (
b0
->
d©a
, b0->
¦’
, 
pos
, &
chrs
);

1334 
	}
}

1337 
	$bšch¼CF
 (cÚ¡ * 
d©a
, 
pos
, cÚ¡ 
ch¬F›ld
 * 
cf
) {

1338 
i
;

1339 
i
=
pos
; i >= 0; i--) {

1340 
c
 = (è
d©a
[
i
];

1341 ià(
	`‹¡InCh¬F›ld
 (
cf
, 
c
)è 
i
;

1343  
BSTR_ERR
;

1344 
	}
}

1352 
	$bšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1353 
ch¬F›ld
 
chrs
;

1354 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 =ğNULL || 
b1
 == NULL ||

1355 
b0
->
¦’
 < 
pos
è 
BSTR_ERR
;

1356 ià(
pos
 =ğ
b0
->
¦’
)…os--;

1357 ià(1 =ğ
b1
->
¦’
è 
	`b¡¼ch½
 (
b0
, b1->
d©a
[0], 
pos
);

1358 ià(0 > 
	`budCh¬F›ld
 (&
chrs
, 
b1
)è 
BSTR_ERR
;

1359  
	`bšch¼CF
 (
b0
->
d©a
, 
pos
, &
chrs
);

1360 
	}
}

1368 
	$bnšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1369 
ch¬F›ld
 
chrs
;

1370 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 == NULL ||

1371 
b0
->
¦’
 <ğ
pos
è 
BSTR_ERR
;

1372 ià(
	`budCh¬F›ld
 (&
chrs
, 
b1
è< 0è 
BSTR_ERR
;

1373 
	`šv”tCh¬F›ld
 (&
chrs
);

1374  
	`bšchrCF
 (
b0
->
d©a
, b0->
¦’
, 
pos
, &
chrs
);

1375 
	}
}

1383 
	$bnšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
) {

1384 
ch¬F›ld
 
chrs
;

1385 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
d©a
 == NULL ||

1386 
b0
->
¦’
 < 
pos
è 
BSTR_ERR
;

1387 ià(
pos
 =ğ
b0
->
¦’
)…os--;

1388 ià(
	`budCh¬F›ld
 (&
chrs
, 
b1
è< 0è 
BSTR_ERR
;

1389 
	`šv”tCh¬F›ld
 (&
chrs
);

1390  
	`bšch¼CF
 (
b0
->
d©a
, 
pos
, &
chrs
);

1391 
	}
}

1400 
	$b£t¡r
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
) {

1401 
d
, 
ÃwËn
;

1402 
±rdiff_t
 
pd
;

1403 
b¡ršg
 
aux
 = (b¡ršgè
b1
;

1405 ià(
pos
 < 0 || 
b0
 =ğ
NULL
 || b0->
¦’
 < 0 || NULL =ğb0->
d©a
 ||

1406 
b0
->
mËn
 < b0->
¦’
 || b0->mËÀ<ğ0è 
BSTR_ERR
;

1407 ià(
b1
 !ğ
NULL
 && (b1->
¦’
 < 0 || b1->
d©a
 =ğNULL)è 
BSTR_ERR
;

1409 
d
 = 
pos
;

1412 ià(
NULL
 !ğ
aux
) {

1413 ià((
pd
 = (
±rdiff_t
è(
b1
->
d©a
 - 
b0
->d©a)è>ğ0 &&…d < (±rdiff_tèb0->
mËn
) {

1414 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b1
))è 
BSTR_ERR
;

1416 
d
 +ğ
aux
->
¦’
;

1420 ià(
	`b®loc
 (
b0
, 
d
 + 1è!ğ
BSTR_OK
) {

1421 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

1422  
BSTR_ERR
;

1425 
ÃwËn
 = 
b0
->
¦’
;

1428 ià(
pos
 > 
ÃwËn
) {

1429 
	`b¡r__mem£t
 (
b0
->
d©a
 + b0->
¦’
, (è
fl
, (
size_t
è(
pos
 - b0->slen));

1430 
ÃwËn
 = 
pos
;

1434 ià(
aux
 !ğ
NULL
) {

1435 
	`bBlockCİy
 ((*è(
b0
->
d©a
 + 
pos
), (*è
aux
->d©a,‡ux->
¦’
);

1436 ià(
aux
 !ğ
b1
è
	`bde¡roy
 (aux);

1440 ià(
d
 > 
ÃwËn
)‚ewlen = d;

1442 
b0
->
¦’
 = 
ÃwËn
;

1443 
b0
->
d©a
[
ÃwËn
] = () '\0';

1445  
BSTR_OK
;

1446 
	}
}

1455 
	$bš£¹
 (
b¡ršg
 
b1
, 
pos
, 
cÚ¡_b¡ršg
 
b2
, 
fl
) {

1456 
d
, 
l
;

1457 
±rdiff_t
 
pd
;

1458 
b¡ršg
 
aux
 = (b¡ršgè
b2
;

1460 ià(
pos
 < 0 || 
b1
 =ğ
NULL
 || 
b2
 =ğNULL || b1->
¦’
 < 0 ||

1461 
b2
->
¦’
 < 0 || 
b1
->
mËn
 < b1->¦’ || b1->mËÀ<ğ0è 
BSTR_ERR
;

1464 ià((
pd
 = (
±rdiff_t
è(
b2
->
d©a
 - 
b1
->d©a)è>ğ0 &&…d < (±rdiff_tèb1->
mËn
) {

1465 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b2
))è 
BSTR_ERR
;

1469 
d
 = 
b1
->
¦’
 + 
aux
->slen;

1470 
l
 = 
pos
 + 
aux
->
¦’
;

1471 ià((
d
|
l
è< 0è 
BSTR_ERR
;

1473 ià(
l
 > 
d
) {

1475 ià(
	`b®loc
 (
b1
, 
l
 + 1è!ğ
BSTR_OK
) {

1476 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1477  
BSTR_ERR
;

1479 
	`b¡r__mem£t
 (
b1
->
d©a
 + b1->
¦’
, (è
fl
, (
size_t
è(
pos
 - b1->slen));

1480 
b1
->
¦’
 = 
l
;

1483 ià(
	`b®loc
 (
b1
, 
d
 + 1è!ğ
BSTR_OK
) {

1484 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1485  
BSTR_ERR
;

1487 
	`bBlockCİy
 (
b1
->
d©a
 + 
l
, b1->d©¨+ 
pos
, 
d
 -†);

1488 
b1
->
¦’
 = 
d
;

1490 
	`bBlockCİy
 (
b1
->
d©a
 + 
pos
, 
aux
->d©a,‡ux->
¦’
);

1491 
b1
->
d©a
[b1->
¦’
] = () '\0';

1492 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1493  
BSTR_OK
;

1494 
	}
}

1502 
	$b»¶aû
 (
b¡ršg
 
b1
, 
pos
, 
Ën
, 
cÚ¡_b¡ršg
 
b2
,

1503 
fl
) {

1504 
¶
, 
»t
;

1505 
±rdiff_t
 
pd
;

1506 
b¡ršg
 
aux
 = (b¡ršgè
b2
;

1508 ià(
pos
 < 0 || 
Ën
 < 0 || (
¶
 =…o +†’è< 0 || 
b1
 =ğ
NULL
 ||

1509 
b2
 =ğ
NULL
 || 
b1
->
d©a
 == NULL || b2->data == NULL ||

1510 
b1
->
¦’
 < 0 || 
b2
->¦’ < 0 || b1->
mËn
 < b1->slen ||

1511 
b1
->
mËn
 <ğ0è 
BSTR_ERR
;

1514 ià(
¶
 >ğ
b1
->
¦’
) {

1515 ià((
»t
 = 
	`b£t¡r
 (
b1
, 
pos
, 
b2
, 
fl
)) < 0) „et;

1516 ià(
pos
 + 
b2
->
¦’
 < 
b1
->slen) {

1517 
b1
->
¦’
 = 
pos
 + 
b2
->slen;

1518 
b1
->
d©a
[b1->
¦’
] = () '\0';

1520  
»t
;

1524 ià((
pd
 = (
±rdiff_t
è(
b2
->
d©a
 - 
b1
->d©a)è>ğ0 &&…d < (±rdiff_tèb1->
¦’
) {

1525 ià(
NULL
 =ğ(
aux
 = 
	`b¡rıy
 (
b2
))è 
BSTR_ERR
;

1528 ià(
aux
->
¦’
 > 
Ën
) {

1529 ià(
	`b®loc
 (
b1
, b1->
¦’
 + 
aux
->¦’ - 
Ën
è!ğ
BSTR_OK
) {

1530 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1531  
BSTR_ERR
;

1535 ià(
aux
->
¦’
 !ğ
Ën
è
	`b¡r__memmove
 (
b1
->
d©a
 + 
pos
 +‡ux->slen, b1->data +…os +†en, b1->slen - (pos +†en));

1536 
	`b¡r__memıy
 (
b1
->
d©a
 + 
pos
, 
aux
->d©a,‡ux->
¦’
);

1537 
b1
->
¦’
 +ğ
aux
->¦’ - 
Ën
;

1538 
b1
->
d©a
[b1->
¦’
] = () '\0';

1539 ià(
aux
 !ğ
b2
è
	`bde¡roy
 (aux);

1540  
BSTR_OK
;

1541 
	}
}

1550 (*
	tš¡r_â±r
è(
	tcÚ¡_b¡ršg
 
	ts1
, 
	tpos
, cÚ¡_b¡ršg 
	ts2
);

1552 
	#INITIAL_STATIC_FIND_INDEX_COUNT
 32

	)

1554 
	$fšd»¶aû’gše
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
, 
š¡r_â±r
 
š¡r
) {

1555 
i
, 
»t
, 
¦’
, 
mËn
, 
d–
, 
acc
;

1556 * 
d
;

1557 
¡©ic_d
[
INITIAL_STATIC_FIND_INDEX_COUNT
+1];

1558 
±rdiff_t
 
pd
;

1559 
b¡ršg
 
auxf
 = (b¡ršgè
fšd
;

1560 
b¡ršg
 
auxr
 = (b¡ršgè
»¶
;

1562 ià(
b
 =ğ
NULL
 || b->
d©a
 =ğNULL || 
fšd
 == NULL ||

1563 
fšd
->
d©a
 =ğ
NULL
 || 
»¶
 == NULL ||„epl->data == NULL ||

1564 
pos
 < 0 || 
fšd
->
¦’
 <ğ0 || 
b
->
mËn
 < 0 || b->slen > b->mlen ||

1565 
b
->
mËn
 <ğ0 || b->
¦’
 < 0 || 
»¶
->¦’ < 0è 
BSTR_ERR
;

1566 ià(
pos
 > 
b
->
¦’
 - 
fšd
->¦’è 
BSTR_OK
;

1569 
pd
 = (
±rdiff_t
è(
fšd
->
d©a
 - 
b
->data);

1570 ià((
±rdiff_t
è(
pos
 - 
fšd
->
¦’
è< 
pd
 &&…d < (±rdiff_tè
b
->slen) {

1571 ià(
NULL
 =ğ(
auxf
 = 
	`b¡rıy
 (
fšd
))è 
BSTR_ERR
;

1575 
pd
 = (
±rdiff_t
è(
»¶
->
d©a
 - 
b
->data);

1576 ià((
±rdiff_t
è(
pos
 - 
»¶
->
¦’
è< 
pd
 &&…d < (±rdiff_tè
b
->slen) {

1577 ià(
NULL
 =ğ(
auxr
 = 
	`b¡rıy
 (
»¶
))) {

1578 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1579  
BSTR_ERR
;

1583 
d–
 = 
auxf
->
¦’
 - 
auxr
->slen;

1587 ià(
d–
 == 0) {

1588 (
pos
 = 
	`š¡r
 (
b
,…os, 
auxf
)) >= 0) {

1589 
	`b¡r__memıy
 (
b
->
d©a
 + 
pos
, 
auxr
->d©a,‡uxr->
¦’
);

1590 
pos
 +ğ
auxf
->
¦’
;

1592 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1593 ià(
auxr
 !ğ
»¶
è
	`bde¡roy
 (auxr);

1594  
BSTR_OK
;

1598 ià(
d–
 > 0) {

1599 
acc
 = 0;

1601 (
i
 = 
	`š¡r
 (
b
, 
pos
, 
auxf
)) >= 0) {

1602 ià(
acc
 && 
i
 > 
pos
)

1603 
	`b¡r__memmove
 (
b
->
d©a
 + 
pos
 - 
acc
, b->d©¨+…os, 
i
 -…os);

1604 ià(
auxr
->
¦’
)

1605 
	`b¡r__memıy
 (
b
->
d©a
 + 
i
 - 
acc
, 
auxr
->d©a,‡uxr->
¦’
);

1606 
acc
 +ğ
d–
;

1607 
pos
 = 
i
 + 
auxf
->
¦’
;

1610 ià(
acc
) {

1611 
i
 = 
b
->
¦’
;

1612 ià(
i
 > 
pos
)

1613 
	`b¡r__memmove
 (
b
->
d©a
 + 
pos
 - 
acc
, b->d©¨+…os, 
i
 -…os);

1614 
b
->
¦’
 -ğ
acc
;

1615 
b
->
d©a
[b->
¦’
] = () '\0';

1618 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1619 ià(
auxr
 !ğ
»¶
è
	`bde¡roy
 (auxr);

1620  
BSTR_OK
;

1637 
mËn
 = 
INITIAL_STATIC_FIND_INDEX_COUNT
;

1638 
d
 = (*è
¡©ic_d
;

1639 
acc
 = 
¦’
 = 0;

1641 (
pos
 = 
	`š¡r
 (
b
,…os, 
auxf
)) >= 0) {

1642 ià(
¦’
 >ğ
mËn
 - 1) {

1643 
¦
, *
t
;

1645 
mËn
 += mlen;

1646 
¦
 =  (*è* 
mËn
;

1647 ià(
¡©ic_d
 =ğ
d
èd = 
NULL
;

1648 ià(
mËn
 <ğ0 || 
¦
 < mËÀ|| 
NULL
 =ğ(
t
 = (*è
	`b¡r__»®loc
 (
d
, sl))) {

1649 
»t
 = 
BSTR_ERR
;

1650 
dÚe
;

1652 ià(
NULL
 =ğ
d
è
	`b¡r__memıy
 (
t
, 
¡©ic_d
,  (static_d));

1653 
d
 = 
t
;

1655 
d
[
¦’
] = 
pos
;

1656 
¦’
++;

1657 
acc
 -ğ
d–
;

1658 
pos
 +ğ
auxf
->
¦’
;

1659 ià(
pos
 < 0 || 
acc
 < 0) {

1660 
»t
 = 
BSTR_ERR
;

1661 
dÚe
;

1666 
d
[
¦’
] = 
b
->slen;

1668 ià(
BSTR_OK
 =ğ(
»t
 = 
	`b®loc
 (
b
, b->
¦’
 + 
acc
 + 1))) {

1669 
b
->
¦’
 +ğ
acc
;

1670 
i
 = 
¦’
-1; i >= 0; i--) {

1671 
s
, 
l
;

1672 
s
 = 
d
[
i
] + 
auxf
->
¦’
;

1673 
l
 = 
d
[
i
+1] - 
s
;

1674 ià(
l
) {

1675 
	`b¡r__memmove
 (
b
->
d©a
 + 
s
 + 
acc
, b->d©¨+ s, 
l
);

1677 ià(
auxr
->
¦’
) {

1678 
	`b¡r__memmove
 (
b
->
d©a
 + 
s
 + 
acc
 - 
auxr
->
¦’
,

1679 
auxr
->
d©a
,‡uxr->
¦’
);

1681 
acc
 +ğ
d–
;

1683 
b
->
d©a
[b->
¦’
] = () '\0';

1686 
dÚe
:;

1687 ià(
¡©ic_d
 =ğ
d
èd = 
NULL
;

1688 
	`b¡r__ä“
 (
d
);

1689 ià(
auxf
 !ğ
fšd
è
	`bde¡roy
 (auxf);

1690 ià(
auxr
 !ğ
»¶
è
	`bde¡roy
 (auxr);

1691  
»t
;

1692 
	}
}

1700 
	$bfšd»¶aû
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
) {

1701  
	`fšd»¶aû’gše
 (
b
, 
fšd
, 
»¶
, 
pos
, 
bš¡r
);

1702 
	}
}

1710 
	$bfšd»¶aûÿ£Ëss
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
) {

1711  
	`fšd»¶aû’gše
 (
b
, 
fšd
, 
»¶
, 
pos
, 
bš¡rÿ£Ëss
);

1712 
	}
}

1721 
	$bš£¹ch
 (
b¡ršg
 
b
, 
pos
, 
Ën
, 
fl
) {

1722 
d
, 
l
, 
i
;

1724 ià(
pos
 < 0 || 
b
 =ğ
NULL
 || b->
¦’
 < 0 || b->
mËn
 < b->slen ||

1725 
b
->
mËn
 <ğ0 || 
Ën
 < 0è 
BSTR_ERR
;

1728 
d
 = 
b
->
¦’
 + 
Ën
;

1729 
l
 = 
pos
 + 
Ën
;

1730 ià((
d
|
l
è< 0è 
BSTR_ERR
;

1732 ià(
l
 > 
d
) {

1734 ià(
	`b®loc
 (
b
, 
l
 + 1è!ğ
BSTR_OK
è 
BSTR_ERR
;

1735 
pos
 = 
b
->
¦’
;

1736 
b
->
¦’
 = 
l
;

1739 ià(
	`b®loc
 (
b
, 
d
 + 1è!ğ
BSTR_OK
è 
BSTR_ERR
;

1740 
i
 = 
d
 - 1; i >ğ
l
; i--) {

1741 
b
->
d©a
[
i
] = b->d©a[˜- 
Ën
];

1743 
b
->
¦’
 = 
d
;

1746 
i
=
pos
; i < 
l
; i++è
b
->
d©a
[i] = 
fl
;

1747 
b
->
d©a
[b->
¦’
] = () '\0';

1748  
BSTR_OK
;

1749 
	}
}

1758 
	$b·‰”n
 (
b¡ršg
 
b
, 
Ën
) {

1759 
i
, 
d
;

1761 
d
 = 
	`bËngth
 (
b
);

1762 ià(
d
 <ğ0 || 
Ën
 < 0 || 
	`b®loc
 (
b
,†’ + 1è!ğ
BSTR_OK
è 
BSTR_ERR
;

1763 ià(
Ën
 > 0) {

1764 ià(
d
 =ğ1è 
	`b£t¡r
 (
b
, 
Ën
, 
NULL
, b->
d©a
[0]);

1765 
i
 = 
d
; i < 
Ën
; i++è
b
->
d©a
[i] = b->data[i - d];

1767 
b
->
d©a
[
Ën
] = () '\0';

1768 
b
->
¦’
 = 
Ën
;

1769  
BSTR_OK
;

1770 
	}
}

1772 
	#BS_BUFF_SZ
 (1024)

	)

1780 
	$b»ada
 (
b¡ršg
 
b
, 
bN»ad
 
»adPŒ
, * 
·rm
) {

1781 
i
, 
l
, 
n
;

1783 ià(
b
 =ğ
NULL
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen ||

1784 
b
->
mËn
 <ğ0 || 
»adPŒ
 =ğ
NULL
è 
BSTR_ERR
;

1786 
i
 = 
b
->
¦’
;

1787 
n
=
i
+16; ;‚ +ğ(Ò < 
BS_BUFF_SZ
) ?‚ : BS_BUFF_SZ)) {

1788 ià(
BSTR_OK
 !ğ
	`b®loc
 (
b
, 
n
 + 1)è 
BSTR_ERR
;

1789 
l
 = (è
	`»adPŒ
 ((*è(
b
->
d©a
 + 
i
), 1, 
n
 - i, 
·rm
);

1790 
i
 +ğ
l
;

1791 
b
->
¦’
 = 
i
;

1792 ià(
i
 < 
n
) ;

1795 
b
->
d©a
[
i
] = () '\0';

1796  
BSTR_OK
;

1797 
	}
}

1805 
b¡ršg
 
	$b»ad
 (
bN»ad
 
»adPŒ
, * 
·rm
) {

1806 
b¡ršg
 
buff
;

1808 ià(0 > 
	`b»ada
 (
buff
 = 
	`bäomc¡r
 (""), 
»adPŒ
, 
·rm
)) {

1809 
	`bde¡roy
 (
buff
);

1810  
NULL
;

1812  
buff
;

1813 
	}
}

1828 
	$bassigng‘s
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
) {

1829 
c
, 
d
, 
e
;

1831 ià(
b
 =ğ
NULL
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen ||

1832 
b
->
mËn
 <ğ0 || 
g‘cPŒ
 =ğ
NULL
è 
BSTR_ERR
;

1833 
d
 = 0;

1834 
e
 = 
b
->
mËn
 - 2;

1836 (
c
 = 
	`g‘cPŒ
 (
·rm
)) >= 0) {

1837 ià(
d
 > 
e
) {

1838 
b
->
¦’
 = 
d
;

1839 ià(
	`b®loc
 (
b
, 
d
 + 2è!ğ
BSTR_OK
è 
BSTR_ERR
;

1840 
e
 = 
b
->
mËn
 - 2;

1842 
b
->
d©a
[
d
] = (è
c
;

1843 
d
++;

1844 ià(
c
 =ğ
‹rmš©Ü
) ;

1847 
b
->
d©a
[
d
] = () '\0';

1848 
b
->
¦’
 = 
d
;

1850  
d
 =ğ0 && 
c
 < 0;

1851 
	}
}

1866 
	$bg‘§
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
) {

1867 
c
, 
d
, 
e
;

1869 ià(
b
 =ğ
NULL
 || b->
mËn
 <ğ0 || b->
¦’
 < 0 || b->mlen < b->slen ||

1870 
b
->
mËn
 <ğ0 || 
g‘cPŒ
 =ğ
NULL
è 
BSTR_ERR
;

1871 
d
 = 
b
->
¦’
;

1872 
e
 = 
b
->
mËn
 - 2;

1874 (
c
 = 
	`g‘cPŒ
 (
·rm
)) >= 0) {

1875 ià(
d
 > 
e
) {

1876 
b
->
¦’
 = 
d
;

1877 ià(
	`b®loc
 (
b
, 
d
 + 2è!ğ
BSTR_OK
è 
BSTR_ERR
;

1878 
e
 = 
b
->
mËn
 - 2;

1880 
b
->
d©a
[
d
] = (è
c
;

1881 
d
++;

1882 ià(
c
 =ğ
‹rmš©Ü
) ;

1885 
b
->
d©a
[
d
] = () '\0';

1886 
b
->
¦’
 = 
d
;

1888  
d
 =ğ0 && 
c
 < 0;

1889 
	}
}

1902 
b¡ršg
 
	$bg‘s
 (
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
) {

1903 
b¡ršg
 
buff
;

1905 ià(0 > 
	`bg‘§
 (
buff
 = 
	`bäomc¡r
 (""), 
g‘cPŒ
, 
·rm
, 
‹rmš©Ü
è|| 0 >ğbuff->
¦’
) {

1906 
	`bde¡roy
 (
buff
);

1907 
buff
 = 
NULL
;

1909  
buff
;

1910 
	}
}

1912 
	sbSŒ—m
 {

1913 
b¡ršg
 
	mbuff
;

1914 * 
	m·rm
;

1915 
bN»ad
 
	m»adFnPŒ
;

1916 
	misEOF
;

1917 
	mmaxBuffSz
;

1926 
bSŒ—m
 * 
	$bsİ’
 (
bN»ad
 
»adPŒ
, * 
·rm
) {

1927 
bSŒ—m
 * 
s
;

1929 ià(
»adPŒ
 =ğ
NULL
)  NULL;

1930 
s
 = (
bSŒ—m
 *è
	`b¡r__®loc
 ( (bStream));

1931 ià(
s
 =ğ
NULL
)  NULL;

1932 
s
->
·rm
 =…arm;

1933 
s
->
buff
 = 
	`bäomc¡r
 ("");

1934 
s
->
»adFnPŒ
 = 
»adPŒ
;

1935 
s
->
maxBuffSz
 = 
BS_BUFF_SZ
;

1936 
s
->
isEOF
 = 0;

1937  
s
;

1938 
	}
}

1945 
	$bsbufæ’gth
 (
bSŒ—m
 * 
s
, 
sz
) {

1946 
ŞdSz
;

1947 ià(
s
 =ğ
NULL
 || 
sz
 < 0è 
BSTR_ERR
;

1948 
ŞdSz
 = 
s
->
maxBuffSz
;

1949 ià(
sz
 > 0è
s
->
maxBuffSz
 = sz;

1950  
ŞdSz
;

1951 
	}
}

1953 
	$b£of
 (cÚ¡ 
bSŒ—m
 * 
s
) {

1954 ià(
s
 =ğ
NULL
 || s->
»adFnPŒ
 =ğNULLè 
BSTR_ERR
;

1955  
s
->
isEOF
 && (s->
buff
->
¦’
 == 0);

1956 
	}
}

1963 * 
	$bsşo£
 (
bSŒ—m
 * 
s
) {

1964 * 
·rm
;

1965 ià(
s
 =ğ
NULL
)  NULL;

1966 
s
->
»adFnPŒ
 = 
NULL
;

1967 ià(
s
->
buff
è
	`bde¡roy
 (s->buff);

1968 
s
->
buff
 = 
NULL
;

1969 
·rm
 = 
s
->parm;

1970 
s
->
·rm
 = 
NULL
;

1971 
s
->
isEOF
 = 1;

1972 
	`b¡r__ä“
 (
s
);

1973  
·rm
;

1974 
	}
}

1983 
	$b¤—dÊa
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
) {

1984 
i
, 
l
, 
»t
, 
¾o
;

1985 * 
b
;

1986 
gb¡ršg
 
x
;

1988 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0 ||

1989 
r
->
¦’
 < 0 ||„->
mËn
 <„->¦’è 
BSTR_ERR
;

1990 
l
 = 
s
->
buff
->
¦’
;

1991 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

1992 
b
 = (*è
s
->
buff
->
d©a
;

1993 
x
.
d©a
 = (*è
b
;

1996 
b
[
l
] = 
‹rmš©Ü
;

1997 
i
=0; 
b
[i] !ğ
‹rmš©Ü
; i++) ;

1998 ià(
i
 < 
l
) {

1999 
x
.
¦’
 = 
i
 + 1;

2000 
»t
 = 
	`bcÚÿt
 (
r
, &
x
);

2001 
s
->
buff
->
¦’
 = 
l
;

2002 ià(
BSTR_OK
 =ğ
»t
è
	`bd–‘e
 (
s
->
buff
, 0, 
i
 + 1);

2003  
BSTR_OK
;

2006 
¾o
 = 
r
->
¦’
;

2009 
x
.
¦’
 = 
l
;

2010 ià(
BSTR_OK
 !ğ
	`bcÚÿt
 (
r
, &
x
)è 
BSTR_ERR
;

2015 ià(
BSTR_OK
 !ğ
	`b®loc
 (
r
,„->
¦’
 + 
s
->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2016 
b
 = (*è(
r
->
d©a
 +„->
¦’
);

2017 
l
 = (è
s
->
	`»adFnPŒ
 (
b
, 1, s->
maxBuffSz
, s->
·rm
);

2018 ià(
l
 <= 0) {

2019 
r
->
d©a
[r->
¦’
] = () '\0';

2020 
s
->
buff
->
¦’
 = 0;

2021 
s
->
isEOF
 = 1;

2023  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
¾o
);

2025 
b
[
l
] = 
‹rmš©Ü
;

2026 
i
=0; 
b
[i] !ğ
‹rmš©Ü
; i++) ;

2027 ià(
i
 < 
l
) ;

2028 
r
->
¦’
 +ğ
l
;

2032 
i
++;

2033 
r
->
¦’
 +ğ
i
;

2034 
s
->
buff
->
¦’
 = 
l
 - 
i
;

2035 
	`b¡r__memıy
 (
s
->
buff
->
d©a
, 
b
 + 
i
, 
l
 - i);

2036 
r
->
d©a
[r->
¦’
] = () '\0';

2037  
BSTR_OK
;

2038 
	}
}

2047 
	$b¤—dÊ§
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
) {

2048 
i
, 
l
, 
»t
, 
¾o
;

2049 * 
b
;

2050 
gb¡ršg
 
x
;

2051 
ch¬F›ld
 
cf
;

2053 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL || 
‹rm
 == NULL ||

2054 
‹rm
->
d©a
 =ğ
NULL
 || 
r
->
mËn
 <ğ0 ||„->
¦’
 < 0 ||

2055 
r
->
mËn
 <„->
¦’
è 
BSTR_ERR
;

2056 ià(
‹rm
->
¦’
 =ğ1è 
	`b¤—dÊa
 (
r
, 
s
,”m->
d©a
[0]);

2057 ià(
‹rm
->
¦’
 < 1 || 
	`budCh¬F›ld
 (&
cf
,”m)è 
BSTR_ERR
;

2059 
l
 = 
s
->
buff
->
¦’
;

2060 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2061 
b
 = (*è
s
->
buff
->
d©a
;

2062 
x
.
d©a
 = 
b
;

2065 
b
[
l
] = 
‹rm
->
d©a
[0];

2066 
i
=0; !
	`‹¡InCh¬F›ld
 (&
cf
, 
b
[i]); i++) ;

2067 ià(
i
 < 
l
) {

2068 
x
.
¦’
 = 
i
 + 1;

2069 
»t
 = 
	`bcÚÿt
 (
r
, &
x
);

2070 
s
->
buff
->
¦’
 = 
l
;

2071 ià(
BSTR_OK
 =ğ
»t
è
	`bd–‘e
 (
s
->
buff
, 0, 
i
 + 1);

2072  
BSTR_OK
;

2075 
¾o
 = 
r
->
¦’
;

2078 
x
.
¦’
 = 
l
;

2079 ià(
BSTR_OK
 !ğ
	`bcÚÿt
 (
r
, &
x
)è 
BSTR_ERR
;

2084 ià(
BSTR_OK
 !ğ
	`b®loc
 (
r
,„->
¦’
 + 
s
->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2085 
b
 = (*è(
r
->
d©a
 +„->
¦’
);

2086 
l
 = (è
s
->
	`»adFnPŒ
 (
b
, 1, s->
maxBuffSz
, s->
·rm
);

2087 ià(
l
 <= 0) {

2088 
r
->
d©a
[r->
¦’
] = () '\0';

2089 
s
->
buff
->
¦’
 = 0;

2090 
s
->
isEOF
 = 1;

2092  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
¾o
);

2095 
b
[
l
] = 
‹rm
->
d©a
[0];

2096 
i
=0; !
	`‹¡InCh¬F›ld
 (&
cf
, 
b
[i]); i++) ;

2097 ià(
i
 < 
l
) ;

2098 
r
->
¦’
 +ğ
l
;

2102 
i
++;

2103 
r
->
¦’
 +ğ
i
;

2104 
s
->
buff
->
¦’
 = 
l
 - 
i
;

2105 
	`b¡r__memıy
 (
s
->
buff
->
d©a
, 
b
 + 
i
, 
l
 - i);

2106 
r
->
d©a
[r->
¦’
] = () '\0';

2107  
BSTR_OK
;

2108 
	}
}

2118 
	$b¤—da
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
n
) {

2119 
l
, 
»t
, 
Ü¦’
;

2120 * 
b
;

2121 
gb¡ršg
 
x
;

2123 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0

2124 || 
r
->
¦’
 < 0 ||„->
mËn
 <„->¦’ || 
n
 <ğ0è 
BSTR_ERR
;

2126 
n
 +ğ
r
->
¦’
;

2127 ià(
n
 <ğ0è 
BSTR_ERR
;

2129 
l
 = 
s
->
buff
->
¦’
;

2131 
Ü¦’
 = 
r
->
¦’
;

2133 ià(0 =ğ
l
) {

2134 ià(
s
->
isEOF
è 
BSTR_ERR
;

2135 ià(
r
->
mËn
 > 
n
) {

2136 
l
 = (è
s
->
	`»adFnPŒ
 (
r
->
d©a
 +„->
¦’
, 1, 
n
 -„->¦’, s->
·rm
);

2137 ià(0 >ğ
l
 ||† > 
n
 - 
r
->
¦’
) {

2138 
s
->
isEOF
 = 1;

2139  
BSTR_ERR
;

2141 
r
->
¦’
 +ğ
l
;

2142 
r
->
d©a
[r->
¦’
] = () '\0';

2147 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2148 
b
 = (*è
s
->
buff
->
d©a
;

2149 
x
.
d©a
 = (*è
b
;

2152 ià(
l
 + 
r
->
¦’
 >ğ
n
) {

2153 
x
.
¦’
 = 
n
 - 
r
->slen;

2154 
»t
 = 
	`bcÚÿt
 (
r
, &
x
);

2155 
s
->
buff
->
¦’
 = 
l
;

2156 ià(
BSTR_OK
 =ğ
»t
è
	`bd–‘e
 (
s
->
buff
, 0, 
x
.
¦’
);

2157  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
Ü¦’
);

2160 
x
.
¦’
 = 
l
;

2161 ià(
BSTR_OK
 !ğ
	`bcÚÿt
 (
r
, &
x
)) ;

2163 
l
 = 
n
 - 
r
->
¦’
;

2164 ià(
l
 > 
s
->
maxBuffSz
)† = s->maxBuffSz;

2166 
l
 = (è
s
->
	`»adFnPŒ
 (
b
, 1,†, s->
·rm
);

2168 } 
l
 > 0);

2169 ià(
l
 < 0)† = 0;

2170 ià(
l
 =ğ0è
s
->
isEOF
 = 1;

2171 
s
->
buff
->
¦’
 = 
l
;

2172  
BSTR_ERR
 & -(
r
->
¦’
 =ğ
Ü¦’
);

2173 
	}
}

2182 
	$b¤—dÊ
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
) {

2183 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0)

2184  
BSTR_ERR
;

2185 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2186 
r
->
¦’
 = 0;

2187  
	`b¤—dÊa
 (
r
, 
s
, 
‹rmš©Ü
);

2188 
	}
}

2197 
	$b¤—dÊs
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
) {

2198 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL || 
‹rm
 == NULL

2199 || 
‹rm
->
d©a
 =ğ
NULL
 || 
r
->
mËn
 <ğ0è 
BSTR_ERR
;

2200 ià(
‹rm
->
¦’
 =ğ1è 
	`b¤—dÊ
 (
r
, 
s
,”m->
d©a
[0]);

2201 ià(
‹rm
->
¦’
 < 1è 
BSTR_ERR
;

2202 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2203 
r
->
¦’
 = 0;

2204  
	`b¤—dÊ§
 (
r
, 
s
, 
‹rm
);

2205 
	}
}

2215 
	$b¤—d
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
n
) {

2216 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULL || 
r
 =ğNULL ||„->
mËn
 <= 0

2217 || 
n
 <ğ0è 
BSTR_ERR
;

2218 ià(
BSTR_OK
 !ğ
	`b®loc
 (
s
->
buff
, s->
maxBuffSz
 + 1)è 
BSTR_ERR
;

2219 
r
->
¦’
 = 0;

2220  
	`b¤—da
 (
r
, 
s
, 
n
);

2221 
	}
}

2229 
	$bsuÄ—d
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
b
) {

2230 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULLè 
BSTR_ERR
;

2231  
	`bš£¹
 (
s
->
buff
, 0, 
b
, () '?');

2232 
	}
}

2239 
	$b¥“k
 (
b¡ršg
 
r
, cÚ¡ 
bSŒ—m
 * 
s
) {

2240 ià(
s
 =ğ
NULL
 || s->
buff
 =ğNULLè 
BSTR_ERR
;

2241  
	`bassign
 (
r
, 
s
->
buff
);

2242 
	}
}

2250 
b¡ršg
 
	$bjoš
 (cÚ¡ 
b¡rLi¡
 * 
bl
, 
cÚ¡_b¡ršg
 
£p
) {

2251 
b¡ršg
 
b
;

2252 
i
, 
c
, 
v
;

2254 ià(
bl
 =ğ
NULL
 || bl->
qty
 < 0)  NULL;

2255 ià(
£p
 !ğ
NULL
 && (£p->
¦’
 < 0 || s•->
d©a
 == NULL))  NULL;

2257 
i
 = 0, 
c
 = 1; i < 
bl
->
qty
; i++) {

2258 
v
 = 
bl
->
’Œy
[
i
]->
¦’
;

2259 ià(
v
 < 0è 
NULL
;

2260 
c
 +ğ
v
;

2261 ià(
c
 < 0è 
NULL
;

2264 ià(
£p
 !ğ
NULL
è
c
 +ğ(
bl
->
qty
 - 1è* s•->
¦’
;

2266 
b
 = (
b¡ršg
è
	`b¡r__®loc
 ( (
gb¡ršg
));

2267 ià(
NULL
 =ğ
b
)  NULL;

2268 
b
->
d©a
 = (*è
	`b¡r__®loc
 (
c
);

2269 ià(
b
->
d©a
 =ğ
NULL
) {

2270 
	`b¡r__ä“
 (
b
);

2271  
NULL
;

2274 
b
->
mËn
 = 
c
;

2275 
b
->
¦’
 = 
c
-1;

2277 
i
 = 0, 
c
 = 0; i < 
bl
->
qty
; i++) {

2278 ià(
i
 > 0 && 
£p
 !ğ
NULL
) {

2279 
	`b¡r__memıy
 (
b
->
d©a
 + 
c
, 
£p
->d©a, s•->
¦’
);

2280 
c
 +ğ
£p
->
¦’
;

2282 
v
 = 
bl
->
’Œy
[
i
]->
¦’
;

2283 
	`b¡r__memıy
 (
b
->
d©a
 + 
c
, 
bl
->
’Œy
[
i
]->d©a, 
v
);

2284 
c
 +ğ
v
;

2286 
b
->
d©a
[
c
] = () '\0';

2287  
b
;

2288 
	}
}

2290 
	#BSSSC_BUFF_LEN
 (256)

	)

2309 
bs¥l™scb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

2310 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm) {

2311 
ch¬F›ld
 
chrs
;

2312 
b¡ršg
 
buff
;

2313 
i
, 
p
, 
»t
;

2315 ià(
cb
 =ğ
NULL
 || 
s
 =ğNULL || s->
»adFnPŒ
 == NULL

2316 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2318 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡r
 (""))è 
BSTR_ERR
;

2320 ià(
¥l™SŒ
->
¦’
 == 0) {

2321 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
) >= 0) ;

2322 ià((
»t
 = 
	`cb
 (
·rm
, 0, 
buff
)) > 0)

2323 
»t
 = 0;

2325 
	`budCh¬F›ld
 (&
chrs
, 
¥l™SŒ
);

2326 
»t
 = 
p
 = 
i
 = 0;

2328 ià(
i
 >ğ
buff
->
¦’
) {

2329 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
);

2330 ià(
i
 >ğ
buff
->
¦’
) {

2331 ià(0 < (
»t
 = 
	`cb
 (
·rm
, 
p
, 
buff
)))„et = 0;

2335 ià(
	`‹¡InCh¬F›ld
 (&
chrs
, 
buff
->
d©a
[
i
])) {

2336 
gb¡ršg
 
t
;

2337 
c
;

2339 
	`blk2tb¡r
 (
t
, 
buff
->
d©a
 + 
i
 + 1, buff->
¦’
 - (i + 1));

2340 ià((
»t
 = 
	`bsuÄ—d
 (
s
, &
t
)) < 0) ;

2341 
buff
->
¦’
 = 
i
;

2342 
c
 = 
buff
->
d©a
[
i
];

2343 
buff
->
d©a
[
i
] = () '\0';

2344 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
buff
)) < 0) ;

2345 
buff
->
d©a
[
i
] = 
c
;

2346 
buff
->
¦’
 = 0;

2347 
p
 +ğ
i
 + 1;

2348 
i
 = -1;

2350 
i
++;

2354 
	`bde¡roy
 (
buff
);

2355  
»t
;

2356 
	}
}

2375 
bs¥l™¡rcb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

2376 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm) {

2377 
b¡ršg
 
buff
;

2378 
i
, 
p
, 
»t
;

2380 ià(
cb
 =ğ
NULL
 || 
s
 =ğNULL || s->
»adFnPŒ
 == NULL

2381 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2383 ià(
¥l™SŒ
->
¦’
 =ğ1è 
	`bs¥l™scb
 (
s
, s¶™SŒ, 
cb
, 
·rm
);

2385 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡r
 (""))è 
BSTR_ERR
;

2387 ià(
¥l™SŒ
->
¦’
 == 0) {

2388 
i
=0; 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
) >= 0; i++) {

2389 ià((
»t
 = 
	`cb
 (
·rm
, 0, 
buff
)) < 0) {

2390 
	`bde¡roy
 (
buff
);

2391  
»t
;

2393 
buff
->
¦’
 = 0;

2395  
BSTR_OK
;

2397 
»t
 = 
p
 = 
i
 = 0;

2398 
i
=
p
=0;;) {

2399 ià((
»t
 = 
	`bš¡r
 (
buff
, 0, 
¥l™SŒ
)) >= 0) {

2400 
gb¡ršg
 
t
;

2401 
	`blk2tb¡r
 (
t
, 
buff
->
d©a
, 
»t
);

2402 
i
 = 
»t
 + 
¥l™SŒ
->
¦’
;

2403 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, &
t
)) < 0) ;

2404 
p
 +ğ
i
;

2405 
	`bd–‘e
 (
buff
, 0, 
i
);

2407 
	`b¤—da
 (
buff
, 
s
, 
BSSSC_BUFF_LEN
);

2408 ià(
	`b£of
 (
s
)) {

2409 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
buff
)) > 0)„et = 0;

2416 
	`bde¡roy
 (
buff
);

2417  
»t
;

2418 
	}
}

2424 
b¡rLi¡
 * 
	$b¡rLi¡C»©e
 () {

2425 
b¡rLi¡
 * 
¦
 = (b¡rLi¡ *è
	`b¡r__®loc
 ( (bstrList));

2426 ià(
¦
) {

2427 
¦
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (1* (bstring));

2428 ià(!
¦
->
’Œy
) {

2429 
	`b¡r__ä“
 (
¦
);

2430 
¦
 = 
NULL
;

2432 
¦
->
qty
 = 0;

2433 
¦
->
mËn
 = 1;

2436  
¦
;

2437 
	}
}

2443 
	$b¡rLi¡De¡roy
 (
b¡rLi¡
 * 
¦
) {

2444 
i
;

2445 ià(
¦
 =ğ
NULL
 || sl->
qty
 < 0è 
BSTR_ERR
;

2446 
i
=0; i < 
¦
->
qty
; i++) {

2447 ià(
¦
->
’Œy
[
i
]) {

2448 
	`bde¡roy
 (
¦
->
’Œy
[
i
]);

2449 
¦
->
’Œy
[
i
] = 
NULL
;

2452 
¦
->
qty
 = -1;

2453 
¦
->
mËn
 = -1;

2454 
	`b¡r__ä“
 (
¦
->
’Œy
);

2455 
¦
->
’Œy
 = 
NULL
;

2456 
	`b¡r__ä“
 (
¦
);

2457  
BSTR_OK
;

2458 
	}
}

2465 
	$b¡rLi¡AÎoc
 (
b¡rLi¡
 * 
¦
, 
msz
) {

2466 
b¡ršg
 * 
l
;

2467 
smsz
;

2468 
size_t
 
nsz
;

2469 ià(!
¦
 || 
msz
 <ğ0 || !¦->
’Œy
 || sl->
qty
 < 0 || sl->
mËn
 <ğ0 || sl->qty > sl->mËnè 
BSTR_ERR
;

2470 ià(
¦
->
mËn
 >ğ
msz
è 
BSTR_OK
;

2471 
smsz
 = 
	`¢­UpSize
 (
msz
);

2472 
nsz
 = ((
size_t
è
smsz
è*  (
b¡ršg
);

2473 ià(
nsz
 < (
size_t
è
smsz
è 
BSTR_ERR
;

2474 
l
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
¦
->
’Œy
, 
nsz
);

2475 ià(!
l
) {

2476 
smsz
 = 
msz
;

2477 
nsz
 = ((
size_t
è
smsz
è*  (
b¡ršg
);

2478 
l
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
¦
->
’Œy
, 
nsz
);

2479 ià(!
l
è 
BSTR_ERR
;

2481 
¦
->
mËn
 = 
smsz
;

2482 
¦
->
’Œy
 = 
l
;

2483  
BSTR_OK
;

2484 
	}
}

2491 
	$b¡rLi¡AÎocMš
 (
b¡rLi¡
 * 
¦
, 
msz
) {

2492 
b¡ršg
 * 
l
;

2493 
size_t
 
nsz
;

2494 ià(!
¦
 || 
msz
 <ğ0 || !¦->
’Œy
 || sl->
qty
 < 0 || sl->
mËn
 <ğ0 || sl->qty > sl->mËnè 
BSTR_ERR
;

2495 ià(
msz
 < 
¦
->
qty
) msz = sl->qty;

2496 ià(
¦
->
mËn
 =ğ
msz
è 
BSTR_OK
;

2497 
nsz
 = ((
size_t
è
msz
è*  (
b¡ršg
);

2498 ià(
nsz
 < (
size_t
è
msz
è 
BSTR_ERR
;

2499 
l
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
¦
->
’Œy
, 
nsz
);

2500 ià(!
l
è 
BSTR_ERR
;

2501 
¦
->
mËn
 = 
msz
;

2502 
¦
->
’Œy
 = 
l
;

2503  
BSTR_OK
;

2504 
	}
}

2521 
b¥l™cb
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
, 
pos
,

2522 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm) {

2523 
i
, 
p
, 
»t
;

2525 ià(
cb
 =ğ
NULL
 || 
¡r
 =ğNULL || 
pos
 < 0 ||…o > sŒ->
¦’
)

2526  
BSTR_ERR
;

2528 
p
 = 
pos
;

2530 
i
=
p
; i < 
¡r
->
¦’
; i++) {

2531 ià(
¡r
->
d©a
[
i
] =ğ
¥l™Ch¬
) ;

2533 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
i
 -…)) < 0) „et;

2534 
p
 = 
i
 + 1;

2535 } 
p
 <ğ
¡r
->
¦’
);

2536  
BSTR_OK
;

2537 
	}
}

2555 
b¥l™scb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

2556 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm) {

2557 
ch¬F›ld
 
chrs
;

2558 
i
, 
p
, 
»t
;

2560 ià(
cb
 =ğ
NULL
 || 
¡r
 =ğNULL || 
pos
 < 0 ||…o > sŒ->
¦’


2561 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2562 ià(
¥l™SŒ
->
¦’
 == 0) {

2563 ià((
»t
 = 
	`cb
 (
·rm
, 0, 
¡r
->
¦’
)) > 0)„et = 0;

2564  
»t
;

2567 ià(
¥l™SŒ
->
¦’
 == 1)

2568  
	`b¥l™cb
 (
¡r
, 
¥l™SŒ
->
d©a
[0], 
pos
, 
cb
, 
·rm
);

2570 
	`budCh¬F›ld
 (&
chrs
, 
¥l™SŒ
);

2572 
p
 = 
pos
;

2574 
i
=
p
; i < 
¡r
->
¦’
; i++) {

2575 ià(
	`‹¡InCh¬F›ld
 (&
chrs
, 
¡r
->
d©a
[
i
])) ;

2577 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
i
 -…)) < 0) „et;

2578 
p
 = 
i
 + 1;

2579 } 
p
 <ğ
¡r
->
¦’
);

2580  
BSTR_OK
;

2581 
	}
}

2599 
b¥l™¡rcb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

2600 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm) {

2601 
i
, 
p
, 
»t
;

2603 ià(
cb
 =ğ
NULL
 || 
¡r
 =ğNULL || 
pos
 < 0 ||…o > sŒ->
¦’


2604 || 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0è 
BSTR_ERR
;

2606 ià(0 =ğ
¥l™SŒ
->
¦’
) {

2607 
i
=
pos
; i < 
¡r
->
¦’
; i++) {

2608 ià((
»t
 = 
	`cb
 (
·rm
, 
i
, 1)) < 0) „et;

2610  
BSTR_OK
;

2613 ià(
¥l™SŒ
->
¦’
 == 1)

2614  
	`b¥l™cb
 (
¡r
, 
¥l™SŒ
->
d©a
[0], 
pos
, 
cb
, 
·rm
);

2616 
i
=
p
=
pos
; i <ğ
¡r
->
¦’
 - 
¥l™SŒ
->slen; i++) {

2617 ià(0 =ğ
	`b¡r__memcmp
 (
¥l™SŒ
->
d©a
, 
¡r
->d©¨+ 
i
, s¶™SŒ->
¦’
)) {

2618 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
i
 -…)) < 0) „et;

2619 
i
 +ğ
¥l™SŒ
->
¦’
;

2620 
p
 = 
i
;

2623 ià((
»t
 = 
	`cb
 (
·rm
, 
p
, 
¡r
->
¦’
 -…)) < 0) „et;

2624  
BSTR_OK
;

2625 
	}
}

2627 
	sg’B¡rLi¡
 {

2628 
b¡ršg
 
	mb
;

2629 
b¡rLi¡
 * 
	mbl
;

2632 
	$bscb
 (* 
·rm
, 
ofs
, 
Ën
) {

2633 
g’B¡rLi¡
 * 
g
 = (g’B¡rLi¡ *è
·rm
;

2634 ià(
g
->
bl
->
qty
 >ğg->bl->
mËn
) {

2635 
mËn
 = 
g
->
bl
->mlen * 2;

2636 
b¡ršg
 * 
tbl
;

2638 
g
->
bl
->
qty
 >ğ
mËn
) {

2639 ià(
mËn
 < 
g
->
bl
->mËnè 
BSTR_ERR
;

2640 
mËn
 += mlen;

2643 
tbl
 = (
b¡ršg
 *è
	`b¡r__»®loc
 (
g
->
bl
->
’Œy
,  (b¡ršgè* 
mËn
);

2644 ià(
tbl
 =ğ
NULL
è 
BSTR_ERR
;

2646 
g
->
bl
->
’Œy
 = 
tbl
;

2647 
g
->
bl
->
mËn
 = mlen;

2650 
g
->
bl
->
’Œy
[g->bl->
qty
] = 
	`bmid¡r
 (g->
b
, 
ofs
, 
Ën
);

2651 
g
->
bl
->
qty
++;

2652  
BSTR_OK
;

2653 
	}
}

2660 
b¡rLi¡
 * 
	$b¥l™
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
) {

2661 
g’B¡rLi¡
 
g
;

2663 ià(
¡r
 =ğ
NULL
 || sŒ->
d©a
 =ğNULL || sŒ->
¦’
 < 0)  NULL;

2665 
g
.
bl
 = (
b¡rLi¡
 *è
	`b¡r__®loc
 ( (bstrList));

2666 ià(
g
.
bl
 =ğ
NULL
)  NULL;

2667 
g
.
bl
->
mËn
 = 4;

2668 
g
.
bl
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (g.bl->
mËn
 *  (bstring));

2669 ià(
NULL
 =ğ
g
.
bl
->
’Œy
) {

2670 
	`b¡r__ä“
 (
g
.
bl
);

2671  
NULL
;

2674 
g
.
b
 = (
b¡ršg
è
¡r
;

2675 
g
.
bl
->
qty
 = 0;

2676 ià(
	`b¥l™cb
 (
¡r
, 
¥l™Ch¬
, 0, 
bscb
, &
g
) < 0) {

2677 
	`b¡rLi¡De¡roy
 (
g
.
bl
);

2678  
NULL
;

2680  
g
.
bl
;

2681 
	}
}

2688 
b¡rLi¡
 * 
	$b¥l™¡r
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
) {

2689 
g’B¡rLi¡
 
g
;

2691 ià(
¡r
 =ğ
NULL
 || sŒ->
d©a
 =ğNULL || sŒ->
¦’
 < 0)  NULL;

2693 
g
.
bl
 = (
b¡rLi¡
 *è
	`b¡r__®loc
 ( (bstrList));

2694 ià(
g
.
bl
 =ğ
NULL
)  NULL;

2695 
g
.
bl
->
mËn
 = 4;

2696 
g
.
bl
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (g.bl->
mËn
 *  (bstring));

2697 ià(
NULL
 =ğ
g
.
bl
->
’Œy
) {

2698 
	`b¡r__ä“
 (
g
.
bl
);

2699  
NULL
;

2702 
g
.
b
 = (
b¡ršg
è
¡r
;

2703 
g
.
bl
->
qty
 = 0;

2704 ià(
	`b¥l™¡rcb
 (
¡r
, 
¥l™SŒ
, 0, 
bscb
, &
g
) < 0) {

2705 
	`b¡rLi¡De¡roy
 (
g
.
bl
);

2706  
NULL
;

2708  
g
.
bl
;

2709 
	}
}

2717 
b¡rLi¡
 * 
	$b¥l™s
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
) {

2718 
g’B¡rLi¡
 
g
;

2720 iàĞ
¡r
 =ğ
NULL
 || sŒ->
¦’
 < 0 || sŒ->
d©a
 == NULL ||

2721 
¥l™SŒ
 =ğ
NULL
 || s¶™SŒ->
¦’
 < 0 || s¶™SŒ->
d©a
 == NULL)

2722  
NULL
;

2724 
g
.
bl
 = (
b¡rLi¡
 *è
	`b¡r__®loc
 ( (bstrList));

2725 ià(
g
.
bl
 =ğ
NULL
)  NULL;

2726 
g
.
bl
->
mËn
 = 4;

2727 
g
.
bl
->
’Œy
 = (
b¡ršg
 *è
	`b¡r__®loc
 (g.bl->
mËn
 *  (bstring));

2728 ià(
NULL
 =ğ
g
.
bl
->
’Œy
) {

2729 
	`b¡r__ä“
 (
g
.
bl
);

2730  
NULL
;

2732 
g
.
b
 = (
b¡ršg
è
¡r
;

2733 
g
.
bl
->
qty
 = 0;

2735 ià(
	`b¥l™scb
 (
¡r
, 
¥l™SŒ
, 0, 
bscb
, &
g
) < 0) {

2736 
	`b¡rLi¡De¡roy
 (
g
.
bl
);

2737  
NULL
;

2739  
g
.
bl
;

2740 
	}
}

2742 #ià
defšed
 (
__TURBOC__
è&& !defšed (
__BORLANDC__
)

2743 #iâdeà
BSTRLIB_NOVSNP


2744 
	#BSTRLIB_NOVSNP


	)

2749 #ià
defšed
(
__WATCOMC__
è|| defšed(
_MSC_VER
)

2750 
	#exv¢´štf
(
r
,
b
,
n
,
f
,
a
è{¸ğ
	`_v¢´štf
 (b,n,f,a);}

	)

2752 #ifdeà
BSTRLIB_NOVSNP


2755 
	#exv¢´štf
(
r
,
b
,
n
,
f
,
a
è{
	`v¥rštf
 (b,f,a);„ = -1;}

	)

2756 
	#START_VSNBUFF
 (256)

	)

2759 #ià
defšed
(
__GNUC__
è&& !defšed(
__APPLE__
)

2762 
v¢´štf
 (*
buf
, 
size_t
 
couÁ
, cÚ¡ *
fÜm©
, 
va_li¡
 
¬g
);

2765 
	#exv¢´štf
(
r
,
b
,
n
,
f
,
a
è{¸ğ
	`v¢´štf
 (b,n,f,a);}

	)

2769 #ià!
defšed
 (
BSTRLIB_NOVSNP
)

2771 #iâdeà
START_VSNBUFF


2772 
	#START_VSNBUFF
 (16)

	)

2790 
	$bfÜm©a
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...) {

2791 
va_li¡
 
¬gli¡
;

2792 
b¡ršg
 
buff
;

2793 
n
, 
r
;

2795 ià(
b
 =ğ
NULL
 || 
fmt
 =ğNULL || b->
d©a
 =ğNULL || b->
mËn
 <= 0

2796 || 
b
->
¦’
 < 0 || b->¦’ > b->
mËn
è 
BSTR_ERR
;

2802 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))è< 
START_VSNBUFF
)‚ = START_VSNBUFF;

2803 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))) {

2804 
n
 = 1;

2805 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))è 
BSTR_ERR
;

2809 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

2810 
	`exv¢´štf
 (
r
, (*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
¬gli¡
);

2811 
	`va_’d
 (
¬gli¡
);

2813 
buff
->
d©a
[
n
] = () '\0';

2814 
buff
->
¦’
 = (è(
¡¾’
è((*èbuff->
d©a
);

2816 ià(
buff
->
¦’
 < 
n
) ;

2818 ià(
r
 > 
n
)‚ =„; n +=‚;

2820 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

2821 
	`bde¡roy
 (
buff
);

2822  
BSTR_ERR
;

2826 
r
 = 
	`bcÚÿt
 (
b
, 
buff
);

2827 
	`bde¡roy
 (
buff
);

2828  
r
;

2829 
	}
}

2838 
	$bassignfÜm©
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...) {

2839 
va_li¡
 
¬gli¡
;

2840 
b¡ršg
 
buff
;

2841 
n
, 
r
;

2843 ià(
b
 =ğ
NULL
 || 
fmt
 =ğNULL || b->
d©a
 =ğNULL || b->
mËn
 <= 0

2844 || 
b
->
¦’
 < 0 || b->¦’ > b->
mËn
è 
BSTR_ERR
;

2850 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))è< 
START_VSNBUFF
)‚ = START_VSNBUFF;

2851 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))) {

2852 
n
 = 1;

2853 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))è 
BSTR_ERR
;

2857 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

2858 
	`exv¢´štf
 (
r
, (*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
¬gli¡
);

2859 
	`va_’d
 (
¬gli¡
);

2861 
buff
->
d©a
[
n
] = () '\0';

2862 
buff
->
¦’
 = (è(
¡¾’
è((*èbuff->
d©a
);

2864 ià(
buff
->
¦’
 < 
n
) ;

2866 ià(
r
 > 
n
)‚ =„; n +=‚;

2868 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

2869 
	`bde¡roy
 (
buff
);

2870  
BSTR_ERR
;

2874 
r
 = 
	`bassign
 (
b
, 
buff
);

2875 
	`bde¡roy
 (
buff
);

2876  
r
;

2877 
	}
}

2886 
b¡ršg
 
	$bfÜm©
 (cÚ¡ * 
fmt
, ...) {

2887 
va_li¡
 
¬gli¡
;

2888 
b¡ršg
 
buff
;

2889 
n
, 
r
;

2891 ià(
fmt
 =ğ
NULL
)  NULL;

2897 ià((
n
 = (è(2*
	`¡¾’
 (
fmt
))è< 
START_VSNBUFF
)‚ = START_VSNBUFF;

2898 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, ""))) {

2899 
n
 = 1;

2900 ià(
NULL
 =ğ(
buff
 = 
	`bäomc¡¿Îoc
 (
n
 + 2, "")))  NULL;

2904 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

2905 
	`exv¢´štf
 (
r
, (*è
buff
->
d©a
, 
n
 + 1, 
fmt
, 
¬gli¡
);

2906 
	`va_’d
 (
¬gli¡
);

2908 
buff
->
d©a
[
n
] = () '\0';

2909 
buff
->
¦’
 = (è(
¡¾’
è((*èbuff->
d©a
);

2911 ià(
buff
->
¦’
 < 
n
) ;

2913 ià(
r
 > 
n
)‚ =„; n +=‚;

2915 ià(
BSTR_OK
 !ğ
	`b®loc
 (
buff
, 
n
 + 2)) {

2916 
	`bde¡roy
 (
buff
);

2917  
NULL
;

2921  
buff
;

2922 
	}
}

2944 
	$bvcfÜm©a
 (
b¡ršg
 
b
, 
couÁ
, cÚ¡ * 
fmt
, 
va_li¡
 
¬g
) {

2945 
n
, 
r
, 
l
;

2947 ià(
b
 =ğ
NULL
 || 
fmt
 =ğNULL || 
couÁ
 <ğ0 || b->
d©a
 == NULL

2948 || 
b
->
mËn
 <ğ0 || b->
¦’
 < 0 || b->¦’ > b->mËnè 
BSTR_ERR
;

2950 ià(
couÁ
 > (
n
 = 
b
->
¦’
 + couÁè+ 2è 
BSTR_ERR
;

2951 ià(
BSTR_OK
 !ğ
	`b®loc
 (
b
, 
n
 + 2)è 
BSTR_ERR
;

2953 
	`exv¢´štf
 (
r
, (*è
b
->
d©a
 + b->
¦’
, 
couÁ
 + 2, 
fmt
, 
¬g
);

2956 
l
 = 
b
->
¦’
;† <ğ
n
;†++) {

2957 ià('\0' =ğ
b
->
d©a
[
l
]) {

2958 
b
->
¦’
 = 
l
;

2959  
BSTR_OK
;

2966 
b
->
d©a
[b->
¦’
] = '\0';

2967 ià(
r
 > 
couÁ
 + 1) {

2968 
n
 = 
r
;

2970 
n
 = 
couÁ
 + count;

2971 ià(
couÁ
 > 
n
èÀğ
INT_MAX
;

2973 
n
 = -n;

2975 ià(
n
 > 
BSTR_ERR
-1)‚ = BSTR_ERR-1;

2976  
n
;

2977 
	}
}

	@tools/src/bstr/bstrlib.h

15 #iâdeà
BSTRLIB_INCLUDE


16 
	#BSTRLIB_INCLUDE


	)

18 #ifdeà
__ılu¥lus


22 
	~<¡d¬g.h
>

23 
	~<¡ršg.h
>

24 
	~<lim™s.h
>

25 
	~<ùy³.h
>

27 #ià!
defšed
 (
BSTRLIB_VSNP_OK
è&& !defšed (
BSTRLIB_NOVSNP
)

28 #ià
defšed
 (
__TURBOC__
è&& !defšed (
__BORLANDC__
)

29 
	#BSTRLIB_NOVSNP


	)

33 
	#BSTR_ERR
 (-1)

	)

34 
	#BSTR_OK
 (0)

	)

35 
	#BSTR_BS_BUFF_LENGTH_GET
 (0)

	)

37 
gb¡ršg
 * 
	tb¡ršg
;

38 cÚ¡ 
	tgb¡ršg
 * 
	tcÚ¡_b¡ršg
;

41 
	#c¡r2b¡r
 
bäomc¡r


	)

42 
b¡ršg
 
bäomc¡r
 (cÚ¡ * 
¡r
);

43 
b¡ršg
 
bäomc¡¿Îoc
 (
mËn
, cÚ¡ * 
¡r
);

44 
b¡ršg
 
blk2b¡r
 (cÚ¡ * 
blk
, 
Ën
);

45 * 
b¡r2c¡r
 (
cÚ¡_b¡ršg
 
s
, 
z
);

46 
bc¡rä“
 (* 
s
);

47 
b¡ršg
 
b¡rıy
 (
cÚ¡_b¡ršg
 
b1
);

48 
bassign
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
);

49 
bassignmid¡r
 (
b¡ršg
 
a
, 
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
);

50 
bassignc¡r
 (
b¡ršg
 
a
, cÚ¡ * 
¡r
);

51 
bassignblk
 (
b¡ršg
 
a
, cÚ¡ * 
s
, 
Ën
);

54 
bde¡roy
 (
b¡ršg
 
b
);

57 
b®loc
 (
b¡ršg
 
s
, 
Ën
);

58 
b®locmš
 (
b¡ršg
 
b
, 
Ën
);

61 
b¡ršg
 
bmid¡r
 (
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
);

64 
bcÚÿt
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
);

65 
bcÚch¬
 (
b¡ršg
 
b0
, 
c
);

66 
bÿtc¡r
 (
b¡ršg
 
b
, cÚ¡ * 
s
);

67 
bÿtblk
 (
b¡ršg
 
b
, cÚ¡ * 
s
, 
Ën
);

68 
bš£¹
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
fl
);

69 
bš£¹ch
 (
b¡ršg
 
s1
, 
pos
, 
Ën
, 
fl
);

70 
b»¶aû
 (
b¡ršg
 
b1
, 
pos
, 
Ën
, 
cÚ¡_b¡ršg
 
b2
, 
fl
);

71 
bd–‘e
 (
b¡ršg
 
s1
, 
pos
, 
Ën
);

72 
b£t¡r
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
);

73 
bŒunc
 (
b¡ršg
 
b
, 
n
);

76 
b¡ricmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

77 
b¡ºicmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
);

78 
bi£qÿ£Ëss
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

79 
bis¡emeqÿ£Ëssblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
);

80 
bi£q
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

81 
bis¡emeqblk
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡ * 
blk
, 
Ën
);

82 
bi£qc¡r
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
);

83 
bi£qc¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
);

84 
b¡rcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
);

85 
b¡ºcmp
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
);

86 
bš¡r
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

87 
bš¡¼
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

88 
bš¡rÿ£Ëss
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

89 
bš¡¼ÿ£Ëss
 (
cÚ¡_b¡ršg
 
s1
, 
pos
, cÚ¡_b¡ršg 
s2
);

90 
b¡rch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
);

91 
b¡¼ch½
 (
cÚ¡_b¡ršg
 
b
, 
c
, 
pos
);

92 
	#b¡rchr
(
b
,
c
è
	`b¡rch½
 ((b), (c), 0)

	)

93 
	#b¡¼chr
(
b
,
c
è
	`b¡¼ch½
 ((b), (c), 
	`bËngth
(b)-1)

	)

94 
bšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

95 
bšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

96 
bnšchr
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

97 
bnšch¼
 (
cÚ¡_b¡ršg
 
b0
, 
pos
, cÚ¡_b¡ršg 
b1
);

98 
bfšd»¶aû
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
);

99 
bfšd»¶aûÿ£Ëss
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶
, 
pos
);

102 
	sb¡rLi¡
 {

103 
	gqty
, 
	gmËn
;

104 
b¡ršg
 * 
	g’Œy
;

106 
b¡rLi¡
 * 
b¡rLi¡C»©e
 ();

107 
b¡rLi¡De¡roy
 (
b¡rLi¡
 * 
¦
);

108 
b¡rLi¡AÎoc
 (
b¡rLi¡
 * 
¦
, 
msz
);

109 
b¡rLi¡AÎocMš
 (
b¡rLi¡
 * 
¦
, 
msz
);

112 
b¡rLi¡
 * 
b¥l™
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
);

113 
b¡rLi¡
 * 
b¥l™s
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
);

114 
b¡rLi¡
 * 
b¥l™¡r
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
);

115 
b¡ršg
 
bjoš
 (cÚ¡ 
b¡rLi¡
 * 
bl
, 
cÚ¡_b¡ršg
 
£p
);

116 
b¥l™cb
 (
cÚ¡_b¡ršg
 
¡r
, 
¥l™Ch¬
, 
pos
,

117 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm);

118 
b¥l™scb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

119 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm);

120 
b¥l™¡rcb
 (
cÚ¡_b¡ršg
 
¡r
, cÚ¡_b¡ršg 
¥l™SŒ
, 
pos
,

121 (* 
cb
è(* 
·rm
, 
ofs
, 
Ën
), *…arm);

124 
b·‰”n
 (
b¡ršg
 
b
, 
Ën
);

125 
btouµ”
 (
b¡ršg
 
b
);

126 
btŞow”
 (
b¡ršg
 
b
);

127 
bÉrimws
 (
b¡ršg
 
b
);

128 
b¹rimws
 (
b¡ršg
 
b
);

129 
bŒimws
 (
b¡ršg
 
b
);

132 #ià!
defšed
 (
BSTRLIB_NOVSNP
)

133 
b¡ršg
 
bfÜm©
 (cÚ¡ * 
fmt
, ...);

134 
bfÜm©a
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...);

135 
bassignfÜm©
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, ...);

136 
bvcfÜm©a
 (
b¡ršg
 
b
, 
couÁ
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gli¡
);

138 
	#bvfÜm©a
(
»t
, 
b
, 
fmt
, 
Ï¡¬g
è{ \

	)

139 
b¡ršg
 
	gb¡¹mp_b
 = (
b
); \

140 cÚ¡ * 
	gb¡¹mp_fmt
 = (
fmt
); \

141 
	gb¡¹mp_r
 = 
BSTR_ERR
, 
	gb¡¹mp_sz
 = 16; \

143 
va_li¡
 
	gb¡¹mp_¬gli¡
; \

144 
va_¡¬t
 (
b¡¹mp_¬gli¡
, 
Ï¡¬g
); \

145 
	gb¡¹mp_r
 = 
bvcfÜm©a
 (
b¡¹mp_b
, 
b¡¹mp_sz
, 
b¡¹mp_fmt
, 
b¡¹mp_¬gli¡
); \

146 
va_’d
 (
b¡¹mp_¬gli¡
); \

147 ià(
	gb¡¹mp_r
 >= 0) { \

148 
b¡¹mp_r
 = 
BSTR_OK
; \

150 } ià(-
	gb¡¹mp_r
 <ğ
b¡¹mp_sz
) { \

151 
b¡¹mp_r
 = 
BSTR_ERR
; \

154 
	gb¡¹mp_sz
 = -
b¡¹mp_r
; \

156 
	g»t
 = 
b¡¹mp_r
; \

161 (*
	gbNg‘c
è(*
	t·rm
);

162 
size_t
 (* 
	tbN»ad
è(*
	tbuff
, 
	tsize_t
 
	t–size
, size_ˆ
	tÃËm
, *
	t·rm
);

165 
b¡ršg
 
bg‘s
 (
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
);

166 
b¡ršg
 
b»ad
 (
bN»ad
 
»adPŒ
, * 
·rm
);

167 
bg‘§
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
);

168 
bassigng‘s
 (
b¡ršg
 
b
, 
bNg‘c
 
g‘cPŒ
, * 
·rm
, 
‹rmš©Ü
);

169 
b»ada
 (
b¡ršg
 
b
, 
bN»ad
 
»adPŒ
, * 
·rm
);

172 
bSŒ—m
 * 
bsİ’
 (
bN»ad
 
»adPŒ
, * 
·rm
);

173 * 
bsşo£
 (
bSŒ—m
 * 
s
);

174 
bsbufæ’gth
 (
bSŒ—m
 * 
s
, 
sz
);

175 
b¤—dÊ
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
);

176 
b¤—dÊs
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
);

177 
b¤—d
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
n
);

178 
b¤—dÊa
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
‹rmš©Ü
);

179 
b¤—dÊ§
 (
b¡ršg
 
r
, 
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
‹rm
);

180 
b¤—da
 (
b¡ršg
 
b
, 
bSŒ—m
 * 
s
, 
n
);

181 
bsuÄ—d
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
b
);

182 
b¥“k
 (
b¡ršg
 
r
, cÚ¡ 
bSŒ—m
 * 
s
);

183 
bs¥l™scb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

184 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm);

185 
bs¥l™¡rcb
 (
bSŒ—m
 * 
s
, 
cÚ¡_b¡ršg
 
¥l™SŒ
,

186 (* 
cb
è(* 
·rm
, 
ofs
, 
cÚ¡_b¡ršg
 
’Œy
), *…arm);

187 
b£of
 (cÚ¡ 
bSŒ—m
 * 
s
);

189 
	sgb¡ršg
 {

190 
	gmËn
;

191 
	g¦’
;

192 * 
	gd©a
;

196 
	#bËngthe
(
b
, 
e
è(((bè=ğ(*)0 || (b)->
¦’
 < 0è? ()Óè: ((b)->¦’))

	)

197 
	#bËngth
(
b
è(
	`bËngthe
 ((b), 0))

	)

198 
	#bd©aof£
(
b
, 
o
, 
e
è(((bè=ğ(*)0 || (b)->
d©a
 =ğ(*)0è? (*)Óè: ((*)(b)->d©aè+ (o))

	)

199 
	#bd©aofs
(
b
, 
o
è(
	`bd©aof£
 ((b), (o), (*)0))

	)

200 
	#bd©«
(
b
, 
e
è(
	`bd©aof£
 (b, 0,ƒ))

	)

201 
	#bd©a
(
b
è(
	`bd©aofs
 (b, 0))

	)

202 
	#bch¬e
(
b
, 
p
, 
e
è(((()Õ)è< ()
	`bËngth
(b)è? ((b)->
d©a
[Õ)]è: (e))

	)

203 
	#bch¬
(
b
, 
p
è
	`bch¬e
 ((b), (p), '\0')

	)

206 
	#bsSticMËn
(
q
,
m
è{(m), (è(q)-1, (*è("" q "")}

	)

207 #ià
defšed
(
_MSC_VER
)

209 
	#bsStic
(
q
è
	`bsSticMËn
(q,-32)

	)

211 #iâdeà
bsStic


212 
	#bsStic
(
q
è
	`bsSticMËn
(q,-
__LINE__
)

	)

216 
	#bsSticBlkP¬ms
(
q
è((*)("" q "")), ((è(q)-1)

	)

219 
	#c¡r2tb¡r
 
btäomc¡r


	)

220 
	#btäomc¡r
(
t
,
s
è{ \

	)

221 (
	gt
).
	gd©a
 = (*è(
s
); \

222 (
	gt
).
	g¦’
 = ((
t
).
d©a
è? ((è(
¡¾’
) ((*)(t).data)) : 0; \

223 (
	gt
).
	gmËn
 = -1; \

225 
	#blk2tb¡r
(
t
,
s
,
l
è{ \

	)

226 (
	gt
).
	gd©a
 = (*è(
s
); \

227 (
	gt
).
	g¦’
 = 
l
; \

228 (
	gt
).
	gmËn
 = -1; \

230 
	#btäomblk
(
t
,
s
,
l
è
	`blk2tb¡r
Ñ,s,l)

	)

231 
	#bmid2tb¡r
(
t
,
b
,
p
,
l
è{ \

	)

232 
cÚ¡_b¡ršg
 
	gb¡¹mp_s
 = (
b
); \

233 ià(
	gb¡¹mp_s
 && b¡¹mp_s->
	gd©a
 && b¡¹mp_s->
	g¦’
 >= 0) { \

234 
b¡¹mp_Ëá
 = (
p
); \

235 
	gb¡¹mp_Ën
 = (
l
); \

236 ià(
	gb¡¹mp_Ëá
 < 0) { \

237 
	gb¡¹mp_Ën
 +ğ
b¡¹mp_Ëá
; \

238 
	gb¡¹mp_Ëá
 = 0; \

240 ià(
	gb¡¹mp_Ën
 > 
	gb¡¹mp_s
->
	g¦’
 - 
	gb¡¹mp_Ëá
) \

241 
	gb¡¹mp_Ën
 = 
b¡¹mp_s
->
¦’
 - 
b¡¹mp_Ëá
; \

242 ià(
	gb¡¹mp_Ën
 <= 0) { \

243 (
t
).
d©a
 = (*)""; \

244 (
	gt
).
	g¦’
 = 0; \

246 (
	gt
).
	gd©a
 = 
b¡¹mp_s
->
d©a
 + 
b¡¹mp_Ëá
; \

247 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
; \

250 (
	gt
).
	gd©a
 = (*)""; \

251 (
	gt
).
	g¦’
 = 0; \

253 (
	gt
).
	gmËn
 = -
__LINE__
; \

255 
	#btäomblkÉrimws
(
t
,
s
,
l
è{ \

	)

256 
	gb¡¹mp_idx
 = 0, 
	gb¡¹mp_Ën
 = (
l
); \

257 * 
	gb¡¹mp_s
 = (
s
); \

258 ià(
	gb¡¹mp_s
 && 
	gb¡¹mp_Ën
 >= 0) { \

259 ; 
	gb¡¹mp_idx
 < 
	gb¡¹mp_Ën
; bstrtmp_idx++) { \

260 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_idx
])) ; \

263 (
	gt
).
	gd©a
 = 
b¡¹mp_s
 + 
b¡¹mp_idx
; \

264 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
 - 
b¡¹mp_idx
; \

265 (
	gt
).
	gmËn
 = -
__LINE__
; \

267 
	#btäomblk¹rimws
(
t
,
s
,
l
è{ \

	)

268 
	gb¡¹mp_Ën
 = (
l
) - 1; \

269 * 
	gb¡¹mp_s
 = (
s
); \

270 ià(
	gb¡¹mp_s
 && 
	gb¡¹mp_Ën
 >= 0) { \

271 ; 
	gb¡¹mp_Ën
 >= 0; bstrtmp_len--) { \

272 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_Ën
])) ; \

275 (
	gt
).
	gd©a
 = 
b¡¹mp_s
; \

276 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
 + 1; \

277 (
	gt
).
	gmËn
 = -
__LINE__
; \

279 
	#btäomblkŒimws
(
t
,
s
,
l
è{ \

	)

280 
	gb¡¹mp_idx
 = 0, 
	gb¡¹mp_Ën
 = (
l
) - 1; \

281 * 
	gb¡¹mp_s
 = (
s
); \

282 ià(
	gb¡¹mp_s
 && 
	gb¡¹mp_Ën
 >= 0) { \

283 ; 
	gb¡¹mp_idx
 <ğ
b¡¹mp_Ën
; bstrtmp_idx++) { \

284 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_idx
])) ; \

286 ; 
	gb¡¹mp_Ën
 >ğ
b¡¹mp_idx
; bstrtmp_len--) { \

287 ià(!
is¥aû
 (
b¡¹mp_s
[
b¡¹mp_Ën
])) ; \

290 (
	gt
).
	gd©a
 = 
b¡¹mp_s
 + 
b¡¹mp_idx
; \

291 (
	gt
).
	g¦’
 = 
b¡¹mp_Ën
 + 1 - 
b¡¹mp_idx
; \

292 (
	gt
).
	gmËn
 = -
__LINE__
; \

296 
	#bwr™•rÙeù
(
t
è{ ià(Ñ).
mËn
 >ğ0èÑ).mËÀğ-1; }

	)

297 
	#bwr™—Îow
(
t
è{ ià(Ñ).
mËn
 =ğ-1èÑ).mËÀğÑ).
¦’
 + (Ñ).¦’ =ğ0); }

	)

298 
	#biswr™•rÙeùed
(
t
è(Ñ).
mËn
 <ğ0)

	)

300 #ifdeà
__ılu¥lus


	@tools/src/bstring.h

35 #iâdeà
_b¡ršg_h


36 
	#_b¡ršg_h


	)

38 
	~<b¡r/b¡¾ib.h
>

39 
	~<b¡r/b¡¿ux.h
>

	@tools/src/cache.c

35 
	~"ÿche.h
"

37 
	~<¡dio.h
>

38 
	~<¡dlib.h
>

39 
	~<lim™s.h
>

41 
	~"dbg.h
"

43 
Cache
 *
	$Cache_ü—‹
(
size
, 
ÿche_lookup_cb
 
lookup
, 
ÿche_eviù_cb
 
eviù
)

45 
Cache
 *
ÿche
 = 
NULL
;

46 
size_t
 
exŒa_size
 = 0;

47 
i
 = 0;

49 
	`check
(
lookup
, "lookup…assedo cache_create is NULL");

51 if(
size
 > 
MIN_CACHE_SIZE
) {

52 
exŒa_size
 = (
size
 - 
MIN_CACHE_SIZE
è* (
ÿche_’Œy
);

55 
ÿche
 = 
	`ÿÎoc
((
Cache
è+ 
exŒa_size
, 1);

56 
	`check_mem
(
ÿche
);

58 
ÿche
->
size
 = size;

59 
ÿche
->
lookup
 =†ookup;

60 
ÿche
->
eviù
 =ƒvict;

62 
i
 = 0; i < 
size
; i++) {

63 
ÿche
->
¬r
[
i
].
g
 = 
INT_MAX
;

66  
ÿche
;

68 
”rÜ
:

69  
NULL
;

70 
	}
}

72 
	$Cache_de¡roy
(
Cache
 *
ÿche
)

74 
i
 = 0;

75 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_destroy");

77 if(
ÿche
->
eviù
) {

78 
i
 = 0; i < 
ÿche
->
size
; i++) {

79 if(
ÿche
->
¬r
[
i
].
d©a
) {

80 
ÿche
->
	`eviù
(ÿche->
¬r
[
i
].
d©a
);

85 
	`ä“
(
ÿche
);

87 
”rÜ
:

89 
	}
}

91 *
	$Cache_lookup
(
Cache
 *
ÿche
, *
key
)

93 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_lookup");

95 *
rd©a
 = 
NULL
;

96 
i
 = 0;

98 
i
 = 0; i < 
ÿche
->
size
; i++) {

99 if(
ÿche
->
¬r
[
i
].
g
 > 0) {

100 
ÿche
->
¬r
[
i
].
g
--;

103 
rd©a
 = 
ÿche
->
¬r
[
i
].
d©a
;

105 if(
rd©a
 && 
ÿche
->
	`lookup
Ôd©a, 
key
)) {

106 
ÿche
->
¬r
[
i
].
g
 = 
INT_MAX
;

109 
rd©a
 = 
NULL
;

112 
i
 = i + 1; i < 
ÿche
->
size
; i++) {

113 if(
ÿche
->
¬r
[
i
].
g
 > 0) {

114 
ÿche
->
¬r
[
i
].
g
--;

118  
rd©a
;

120 
”rÜ
:

121  
NULL
;

122 
	}
}

124 
	$Cache_add
(
Cache
 *
ÿche
, *
d©a
)

126 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_add");

127 
	`check
(
d©a
, "Cannot‡dd NULL‡s datao cache");

129 
i
 = 0;

130 
mš_idx
 = 0;

131 
mš_g
 = 
ÿche
->
¬r
[
mš_idx
].
g
;

133 if(
ÿche
->
¬r
[0].
g
 > 0) {

134 
ÿche
->
¬r
[0].
g
--;

137 
i
 = 1; i < 
ÿche
->
size
; i++) {

138 if(
ÿche
->
¬r
[
i
].
g
 < 
mš_g
) {

139 
mš_g
 = 
ÿche
->
¬r
[
i
].
g
;

140 
mš_idx
 = 
i
;

143 if(
ÿche
->
¬r
[
i
].
g
 > 0) {

144 
ÿche
->
¬r
[
i
].
g
--;

148 if(
ÿche
->
¬r
[
mš_idx
].
d©a
 && cache->
eviù
) {

149 
ÿche
->
	`eviù
(ÿche->
¬r
[
mš_idx
].
d©a
);

152 
ÿche
->
¬r
[
mš_idx
].
d©a
 = data;

153 
ÿche
->
¬r
[
mš_idx
].
g
 = 
INT_MAX
;

155 
”rÜ
:

157 
	}
}

159 
	$Cache_eviù_objeù
(
Cache
 *
ÿche
, *
obj
)

161 
i
 = 0;

163 
	`check
(
ÿche
, "NULL cache‡rgumento Cache_evict_object");

164 
	`check
(
obj
, "NULL obj‡rgumento Cache_evict_object");

166 
i
 = 0; i < 
ÿche
->
size
; i++) {

167 if(
ÿche
->
¬r
[
i
].
d©a
 =ğ
obj
) {

168 if(
ÿche
->
eviù
) {

169 
ÿche
->
	`eviù
(ÿche->
¬r
[
i
].
d©a
);

172 
ÿche
->
¬r
[
i
].
d©a
 = 
NULL
;

173 
ÿche
->
¬r
[
i
].
g
 = 0;

177 
”rÜ
:

179 
	}
}

	@tools/src/cache.h

1 #iâdeà
_CACHE_H


2 
	#_CACHE_H


	)

4 
	#MIN_CACHE_SIZE
 16

	)

7 (*
	tÿche_lookup_cb
)(*
	td©a
, *
	tkey
);

8 (*
	tÿche_eviù_cb
)(*
	td©a
);

10 
	sÿche_’Œy
 {

11 
g
;

12 *
d©a
;

15 
	sCache
 {

16 
ÿche_lookup_cb
 
lookup
;

17 
ÿche_eviù_cb
 
eviù
;

18 
size
;

21 
ÿche_’Œy
 
¬r
[
MIN_CACHE_SIZE
];

22 } 
	tCache
;

24 
Cache
 *
	`Cache_ü—‹
(
size
, 
ÿche_lookup_cb
 
lookup
, 
ÿche_eviù_cb
 
eviù
);

25 
	`Cache_de¡roy
(
Cache
 *
ÿche
);

26 *
	`Cache_lookup
(
Cache
 *
ÿche
, *
key
);

27 
	`Cache_add
(
Cache
 *
ÿche
, *
d©a
);

28 
	`Cache_eviù_objeù
(
Cache
 *
ÿche
, *
obj
);

	@tools/src/config/config.c

34 
	~"cÚfig/cÚfig.h
"

36 
	~<as£¹.h
>

37 
	~<¡d¬g.h
>

38 
	~<¡dlib.h
>

39 
	~<¡ršg.h
>

40 
	~<sigÇl.h
>

42 
	~<sql™e3.h
>

44 
	~"adt/t¡.h
"

45 
	~"dœ.h
"

46 
	~"dbg.h
"

47 
	~"mime.h
"

48 
	~"´oxy.h
"

49 
	~"£rv”.h
"

50 
	~"£‰šg.h
"

51 
	~"cÚfig/moduË.h
"

52 
	~"cÚfig/db.h
"

53 
	~<dlfú.h
>

56 
HªdËr
 *
	$CÚfig_lßd_hªdËr
(
hªdËr_id
)

58 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_hªdËr
(
hªdËr_id
);

60 
	`DB_check
(
»s
, 0, 7,

61 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,ns_tag_string,

62 
Šs_g_¡ršg
, 
Šs_g_numb”
,ns_tag_string);

64 
HªdËr
 *
hªdËr
 = 
	`HªdËr_ü—‹
(

65 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

66 
	`DB_g‘_as
(
»s
, 0, 2, 
¡ršg
),

67 
	`DB_g‘_as
(
»s
, 0, 3, 
¡ršg
),

68 
	`DB_g‘_as
(
»s
, 0, 4, 
¡ršg
)

70 
	`check
(
hªdËr
 !ğ
NULL
, "FaedØü—‹ hªdË¸id %d.", 
hªdËr_id
);

72 if(
	`DB_g‘_as
(
»s
, 0, 5, 
numb”
) == 1) {

73 
hªdËr
->
¿w
 = 1;

76 if(
	`bi£qc¡r
(
	`DB_g‘_as
(
»s
, 0, 6, 
¡ršg
), "tnetstring")) {

77 
hªdËr
->
´ÙocŞ
 = 
HANDLER_PROTO_TNET
;

80 
	`log_šfo
("Loaded handler %d:%s:%s:%s:%s",

81 
hªdËr_id
, 
	`bd©a
(
hªdËr
->
£nd_¥ec
),

82 
	`bd©a
(
hªdËr
->
£nd_id’t
),

83 
	`bd©a
(
hªdËr
->
»cv_¥ec
),

84 
	`bd©a
(
hªdËr
->
»cv_id’t
));

86 
	`Šs_v®ue_de¡roy
(
»s
);

87  
hªdËr
;

88 
”rÜ
:

89 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

90  
NULL
;

91 
	}
}

94 
Proxy
 *
	$CÚfig_lßd_´oxy
(
´oxy_id
)

96 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_´oxy
(
´oxy_id
);

98 
	`DB_check
(
»s
, 0, 3,

99 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_number);

101 
Proxy
 *
´oxy
 = 
	`Proxy_ü—‹
(

102 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

103 
	`DB_g‘_as
(
»s
, 0, 2, 
numb”
)

105 
	`check
(
´oxy
 !ğ
NULL
, "FaedØü—‹…roxy w™h id %d.", 
´oxy_id
);

107 
	`log_šfo
("Loaded…roxy %d:%s:%d",

108 
´oxy_id
, 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

110 
	`Šs_v®ue_de¡roy
(
»s
);

111  
´oxy
;

112 
”rÜ
:

113 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

114  
NULL
;

115 
	}
}

118 
Dœ
 *
	$CÚfig_lßd_dœ
(
dœ_id
)

120 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_dœ
(
dœ_id
);

122 
	`DB_check
(
»s
, 0, 5,

123 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,

124 
Šs_g_¡ršg
, 
Šs_g_numb”
);

126 
Dœ
 *
dœ
 = 
	`Dœ_ü—‹
(

127 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

128 
	`DB_g‘_as
(
»s
, 0, 2, 
¡ršg
),

129 
	`DB_g‘_as
(
»s
, 0, 3, 
¡ršg
),

130 
	`DB_g‘_as
(
»s
, 0, 4, 
numb”
)

132 
	`check
(
dœ
 !ğ
NULL
, "FaedØü—‹ dœeùÜy id %d.", 
dœ_id
);

134 
	`log_šfo
("Loaded directory %d:%s:%s",

135 
dœ_id
, 
	`bd©a
(
dœ
->
ba£
), bd©a(dœ->
šdex_fe
));

137 
	`Šs_v®ue_de¡roy
(
»s
);

138  
dœ
;

139 
”rÜ
:

140 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

141  
NULL
;

142 
	}
}

144 
šlše
 
HªdËr
 *
	$CÚfig_push_unique_hªdËr
(
S”v”
 *
¤v
, 
HªdËr
 *
hªdËr
)

146 
i
 = 0;

151 
i
 = 0; i < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); i++) {

152 
HªdËr
 *
‹¡
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
i
);

153 
§me_£nd
 = 
	`bi£q
(
‹¡
->
£nd_¥ec
, 
hªdËr
->send_spec);

154 
§me_»cv
 = 
	`bi£q
(
‹¡
->
»cv_¥ec
, 
hªdËr
->recv_spec);

156 if(
§me_£nd
 && 
§me_»cv
) {

157 
	`HªdËr_de¡roy
(
hªdËr
);

159  
‹¡
;

160 } if(
§me_£nd
) {

161 
	`log_w¬n
("You havewo handlers withhe same send_spec: %s",

162 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

163 } if(
§me_»cv
) {

164 
	`log_w¬n
("You havewo handlers withhe same„ecv_spec: %s",

165 
	`bd©a
(
hªdËr
->
»cv_¥ec
));

171 
	`d¬¿y_push
(
¤v
->
hªdËrs
, 
hªdËr
);

172  
hªdËr
;

173 
	}
}

175 
	$CÚfig_lßd_rou‹s
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
, 
ho¡_id
, 
£rv”_id
)

177 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_rou‹s
(
ho¡_id
, 
£rv”_id
);

178 
cŞs
 = 0;

179 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

180 
row_i
 = 0;

181 
rc
 = 0;

183 if(
rows
 == 0) {

184 
	`log_w¬n
("Server has‚o„outes, it won't do‡nything without‡t†east one.");

185 
	`Šs_v®ue_de¡roy
(
»s
);

189 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

190 
	`DB_check
(
»s
, 
row_i
, 4,

191 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_number,ns_tag_string);

193 
rou‹_id
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 0, 
numb”
);

194 
b¡ršg
 
·th
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 1, 
¡ršg
);

195 
id
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 2, 
numb”
);

196 
b¡ršg
 
ty³
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 3, 
¡ršg
);

197 *
rg‘
 = 
NULL
;

198 
Back’dTy³
 
back’d_ty³
 = 0;

200 if(
	`bi£qc¡r
(
ty³
, "dir")) {

201 
rg‘
 = 
	`CÚfig_lßd_dœ
(
id
);

202 
back’d_ty³
 = 
BACKEND_DIR
;

203 } if(
	`bi£qc¡r
(
ty³
, "proxy")) {

204 
rg‘
 = 
	`CÚfig_lßd_´oxy
(
id
);

205 
back’d_ty³
 = 
BACKEND_PROXY
;

206 } if(
	`bi£qc¡r
(
ty³
, "handler")) {

207 
HªdËr
 *
‹mp
 = 
	`CÚfig_lßd_hªdËr
(
id
);

208 
rg‘
 = 
	`CÚfig_push_unique_hªdËr
(
¤v
, 
‹mp
);

209 
	`check
(
rg‘
 !ğ
NULL
, "Fau»…ushšg hªdË¸%d:%s.", 
id
, 
	`bd©a
(
·th
));

210 
back’d_ty³
 = 
BACKEND_HANDLER
;

212 
	`£Áš–
("Invalid backendype: %s for„oute %d:%s.",

213 
	`bd©a
(
ty³
), 
rou‹_id
, bd©a(
·th
));

216 
	`check
(
rg‘
 !ğ
NULL
, "Failedo†oad backendype: %s for„oute %d:%s.",

217 
	`bd©a
(
ty³
), 
rou‹_id
, bd©a(
·th
));

220 
rc
 = 
	`Ho¡_add_back’d
(
ho¡
, 
·th
, 
back’d_ty³
, 
rg‘
);

221 
	`check
(
rc
 == 0, "Failedo‡dd„oute %so host %s.",

222 
	`bd©a
(
·th
), bd©a(
ho¡
->
Çme
));

224 
	`log_šfo
("Loaded„oute %d:%s:%s for host %d:%s",

225 
rou‹_id
, 
	`bd©a
(
·th
), bd©a(
ty³
),

226 
ho¡_id
, 
	`bd©a
(
ho¡
->
Çme
));

229 
	`Šs_v®ue_de¡roy
(
»s
);

230  
row_i
;

232 
”rÜ
:

233 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

235 
	}
}

237 
	$CÚfig_lßd_ho¡s
(
S”v”
 *
¤v
, 
£rv”_id
)

239 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_ho¡s
(
£rv”_id
);

240 
cŞs
 = 0;

241 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

242 
row_i
 = 0;

243 
rc
 = 0;

245 if(
rows
 == 0) {

246 
	`log_w¬n
("No hosts configured for server, I hope you know what you're doing.");

247 
	`Šs_v®ue_de¡roy
(
»s
);

251 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

252 
	`DB_check
(
»s
, 
row_i
, 4,

253 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,ns_tag_number);

255 
Ho¡
 *
ho¡
 = 
	`Ho¡_ü—‹
(

256 
	`DB_g‘_as
(
»s
, 
row_i
, 1, 
¡ršg
),

257 
	`DB_g‘_as
(
»s
, 
row_i
, 2, 
¡ršg
)

259 
	`check_mem
(
ho¡
);

261 
ho¡_id
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 0, 
numb”
);

262 
rc
 = 
	`CÚfig_lßd_rou‹s
(
¤v
, 
ho¡
, 
ho¡_id
, 
£rv”_id
);

263 
	`check
(
rc
 !ğ-1, "FaedØlßd„ou‹ fÜ ho¡ %s.", 
	`bd©a
(
ho¡
->
Çme
));

265 
rc
 = 
	`S”v”_add_ho¡
(
¤v
, 
ho¡
);

266 
	`check
(
rc
 == 0, "Failedo‡dd host %s:%so server.",

267 
	`bd©a
(
ho¡
->
Çme
), bd©a(ho¡->
m©chšg
));

269 if(
	`bi£q
(
¤v
->
deçuÉ_ho¡Çme
, 
ho¡
->
Çme
)) {

270 
¤v
->
deçuÉ_ho¡
 = 
ho¡
;

274 
	`log_šfo
("Lßded %d ho¡ fÜ s”v” %d:%s", 
row_i
, 
£rv”_id
, 
	`bd©a
(
¤v
->
uuid
));

276 
	`Šs_v®ue_de¡roy
(
»s
);

279 
”rÜ
:

280 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

283 
	}
}

285 
S”v”
 *
	$CÚfig_lßd_£rv”
(cÚ¡ *
uuid
)

287 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_£rv”
(
uuid
);

288 
rc
 = 0;

290 
	`DB_check
(
»s
, 0, 10,

291 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string,ns_tag_string,ns_tag_number,

292 
Šs_g_¡ršg
,ns_g_¡ršg,ns_g_¡ršg,ns_g_¡ršg, 
Šs_g_numb”
);

294 
£rv”_id
 = 
	`DB_g‘_as
(
»s
, 0, 0, 
numb”
);

296 
S”v”
 *
¤v
 = 
	`S”v”_ü—‹
(

297 
	`DB_g‘_as
(
»s
, 0, 1, 
¡ršg
),

298 
	`DB_g‘_as
(
»s
, 0, 2, 
¡ršg
),

299 
	`DB_g‘_as
(
»s
, 0, 3, 
¡ršg
),

300 
	`DB_g‘_as
(
»s
, 0, 4, 
numb”
),

301 
	`DB_g‘_as
(
»s
, 0, 5, 
¡ršg
),

302 
	`DB_g‘_as
(
»s
, 0, 6, 
¡ršg
),

303 
	`DB_g‘_as
(
»s
, 0, 7, 
¡ršg
),

304 
	`DB_g‘_as
(
»s
, 0, 8, 
¡ršg
),

305 
	`DB_g‘_as
(
»s
, 0, 9, 
numb”
)

307 
	`check
(
¤v
 !ğ
NULL
, "FaedØü—‹ s”v” %s", 
uuid
);

310 
rc
 = 
	`CÚfig_lßd_ho¡s
(
¤v
, 
£rv”_id
);

311 
	`check
(
rc
 =ğ0, "FaedØlßdhho¡ fÜ s”v”: %s", 
	`bd©a
(
¤v
->
uuid
));

313 
	`Šs_v®ue_de¡roy
(
»s
);

314  
¤v
;

316 
”rÜ
:

317 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

318  
NULL
;

319 
	}
}

322 
sim¶e_qu”y_run
(
Šs_v®ue_t
 *
»s
,

323 (*
ÿÎback
)(cÚ¡ *
key
, cÚ¡ *
v®ue
))

325 
row_i
 = 0;

326 
cŞs
 = 0;

327 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

328 
	`check
(
rows
 != -1, "Results‡re‚ot‡able.");

330 if(
rows
 > 0) {

331 
row_i
 = 0;„ow_˜< 
rows
;„ow_i++) {

332 
	`DB_check
(
»s
, 
row_i
, 3,

333 
Šs_g_numb”
, 
Šs_g_¡ršg
,ns_tag_string);

335 
b¡ršg
 
key
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 1, 
¡ršg
);

336 
b¡ršg
 
v®ue
 = 
	`DB_g‘_as
(
»s
, 
row_i
, 2, 
¡ršg
);

338 
rc
 = 
	`ÿÎback
(
	`bd©a
(
key
), bd©a(
v®ue
));

339 
	`check_debug
(
rc
 == 0, "Load callback failed.");

343  
row_i
;

344 
”rÜ
:

346 
	}
}

348 
	$CÚfig_lßd_mim‘y³s
()

350 
rc
 = -1;

351 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_mim‘y³s
();

352 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Wrongype,ƒxpected valid„ows.");

354 
rc
 = 
	`sim¶e_qu”y_run
(
»s
, 
MIME_add_ty³
);

355 
	`check
(
rc
 != -1, "Failed‡dding your settings,†ook‡t…reviousƒrrors for clues.");

357 
”rÜ
:

358 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

359  
rc
;

360 
	}
}

363 
	$CÚfig_lßd_£‰šgs
()

365 
Šs_v®ue_t
 *
»s
 = 
CONFIG_MODULE
.
	`lßd_£‰šgs
();

366 
rc
 = -1;

367 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Wrongype,ƒxpected valid„ows.");

368 
rc
 = 
	`sim¶e_qu”y_run
(
»s
, 
S‘tšg_add
);

369 
	`check
(
rc
 != -1, "Failed‡dding your settings,†ook‡t…reviousƒrrors for clues.");

371 
”rÜ
:

372 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

373  
rc
;

374 
	}
}

376 
	$CÚfig_š™_db
(cÚ¡ *
·th
)

378  
CONFIG_MODULE
.
	`š™
(
·th
);

379 
	}
}

381 
	$CÚfig_şo£_db
()

383 
CONFIG_MODULE
.
	`şo£
();

384 
	}
}

386 
	#SET_MODULE_FUNC
(
N
è
CONFIG_MODULE
.N = 
	`dlsym
(
lib
, "config_" #N);\

387 
	`check
(
CONFIG_MODULE
.
N
 !ğ
NULL
, "CÚfig moduË % dÛ¢'ˆhavª " #N " funùiÚ.", 
lßd_·th
);

	)

390 
	$CÚfig_moduË_lßd
(cÚ¡ *
lßd_·th
)

392 *
lib
 = 
	`dlİ’
(
lßd_·th
, 
RTLD_LAZY
 | 
RTLD_LOCAL
);

393 
	`check
(
lib
 !ğ
NULL
, "FaedØlßd cÚfig moduË %s: %s.", 
lßd_·th
, 
	`dË¼Ü
());

395 
	`SET_MODULE_FUNC
(
š™
);

396 
	`SET_MODULE_FUNC
(
şo£
);

397 
	`SET_MODULE_FUNC
(
lßd_hªdËr
);

398 
	`SET_MODULE_FUNC
(
lßd_´oxy
);

399 
	`SET_MODULE_FUNC
(
lßd_dœ
);

400 
	`SET_MODULE_FUNC
(
lßd_rou‹s
);

401 
	`SET_MODULE_FUNC
(
lßd_ho¡s
);

402 
	`SET_MODULE_FUNC
(
lßd_£rv”
);

403 
	`SET_MODULE_FUNC
(
lßd_mim‘y³s
);

404 
	`SET_MODULE_FUNC
(
lßd_£‰šgs
);

407 
”rÜ
:

409 
	}
}

	@tools/src/config/config.h

35 #iâdeà
__cÚfig_h__


36 
	#__cÚfig_h__


	)

38 
	~"£rv”.h
"

40 
CÚfig_š™_db
(cÚ¡ *
·th
);

42 
S”v”
 *
CÚfig_lßd_£rv”
(cÚ¡ *
uuid
);

44 
CÚfig_lßd_mim‘y³s
();

46 
CÚfig_lßd_£‰šgs
();

48 
CÚfig_şo£_db
();

50 
CÚfig_moduË_lßd
(cÚ¡ *
lßd_·th
);

	@tools/src/config/db.c

35 
	~<¡dio.h
>

36 
	~<¡dlib.h
>

37 
	~<sql™e3.h
>

38 
	~"dbg.h
"

39 
	~"cÚfig/db.h
"

40 
	~"as£¹.h
"

41 
	~<¡d¬g.h
>

42 
	~"Š‘¡ršgs_im¶.h
"

44 
sql™e3
 *
	gCONFIG_DB
 = 
NULL
;

46 
	$DB_š™
(cÚ¡ *
·th
)

48 
	`check
(
CONFIG_DB
 =ğ
NULL
, "Must closehe config db first,ell Zed.");

49  
	`sql™e3_İ’
(
·th
, &
CONFIG_DB
);

50 
”rÜ
:

52 
	}
}

55 
	$DB_şo£
()

57 if(
CONFIG_DB
) {

58 
	`sql™e3_şo£
(
CONFIG_DB
);

59 
CONFIG_DB
 = 
NULL
;

61 
	}
}

64 
šlše
 
Šs_v®ue_t
 *
	$DB_cÚv”t_cŞumn
(
sql™e3_¡mt
 *
¡mt
)

66 
cŞ
 = 0;

67 
Šs_v®ue_t
 *
–
 = 
NULL
;

68 
Šs_v®ue_t
 *
row
 = 
	`Šs_Ãw_li¡
();

69 
	`check_mem
(
row
);

71 
cŞ
 = 0; cŞ < 
	`sql™e3_cŞumn_couÁ
(
¡mt
); col++) {

72 
	`sql™e3_cŞumn_ty³
(
¡mt
, 
cŞ
)) {

73 
SQLITE_INTEGER
:

74 
–
 = 
	`Šs_Ãw_š‹g”
(
	`sql™e3_cŞumn_št
(
¡mt
, 
cŞ
));

76 
SQLITE_FLOAT
:

77 
–
 = 
	`Šs_Ãw_æßt
(
	`sql™e3_cŞumn_doubË
(
¡mt
, 
cŞ
));

79 
SQLITE_TEXT
:

80 
–
 = 
	`Šs_·r£_¡ršg
(

81 (cÚ¡ *)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 
cŞ
),

82 
	`sql™e3_cŞumn_by‹s
(
¡mt
, 
cŞ
));

84 
SQLITE_BLOB
:

85 
–
 = 
	`Šs_·r£_¡ršg
(

86 
	`sql™e3_cŞumn_blob
(
¡mt
, 
cŞ
),

87 
	`sql™e3_cŞumn_by‹s
(
¡mt
, 
cŞ
));

89 
SQLITE_NULL
:

90 
–
 = 
	`Šs_g‘_nuÎ
();

96 
	`check
(
–
 !ğ
NULL
, "Got‡ NULL for‡ column");

97 
	`Šs_add_to_li¡
(
row
, 
–
);

100  
row
;

102 
”rÜ
:

103 if(
row
è
	`Šs_v®ue_de¡roy
(row);

104 if(
–
è
	`Šs_v®ue_de¡roy
(el);

105  
NULL
;

106 
	}
}

108 
	$DB_v®id_schema
(
Šs_v®ue_t
 *
»s
, 
row
, 
ncŞs
, ...)

110 
va_li¡
 
¬gp
;

111 
	`va_¡¬t
(
¬gp
, 
ncŞs
);

112 
i
 = 0;

114 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Invalid„esult set, must be‡†ist.");

115 
rows
 = 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
);

116 
	`check
(
rows
 != -1, "Result isn't in‡able format.");

117 
	`check
(
row
 < 
rows
, "Row is…astƒnd of„esult set: %d > %d",„ow,„ows);

120 
Šs_v®ue_t
 *
row_d©a
 = 
	`d¬¿y_g‘
(
»s
->
v®ue
.
li¡
, 
row
);

123 
	`check
(
	`Šs_g‘_ty³
(
row_d©a
è=ğ
Šs_g_li¡
, "Inv®id„ow %d, mu¡ b¨li¡.", 
row
);

124 
cŞs
 = 
	`d¬¿y_’d
(
row_d©a
->
v®ue
.
li¡
);

125 
	`check
(
cŞs
 =ğ
ncŞs
, "Expected %d columns, but„esult set has %d.", cols,‚cols);

127 
i
 = 0; i < 
ncŞs
; i++) {

128 
Šs_ty³_g
 
ex³ùšg
 = 
	`va_¬g
(
¬gp
,ns_type_tag);

129 
Šs_v®ue_t
 *
ûÎ
 = 
	`DB_g‘
(
»s
, 
row
, 
i
);

130 
	`check
(
	`Šs_g‘_ty³
(
ûÎ
è=ğ
ex³ùšg
,

131 "Row %d, CŞumÀ%d ha wrÚgy³.", 
row
, 
i
);

134 
	`va_’d
(
¬gp
);

136 
”rÜ
:

138 
	`va_’d
(
¬gp
);

140 
	}
}

155 
Šs_v®ue_t
 *
	$DB_exec
(cÚ¡ *
qu”y
, ...)

157 
va_li¡
 
¬gp
;

158 
	`va_¡¬t
(
¬gp
, 
qu”y
);

159 *
zE¼Msg
 = 
NULL
;

160 
Šs_v®ue_t
 *
»s
 = 
NULL
;

161 
rc
 = 0;

162 
sql™e3_¡mt
 *
¡mt
 = 
NULL
;

163 cÚ¡ *
sql_
 = 
NULL
;

164 *
sql
 = 
NULL
;

166 
	`check
(
CONFIG_DB
 !ğ
NULL
, "The config database is‚ot open.");

168 
sql
 = 
	`sql™e3_vm´štf
(
qu”y
, 
¬gp
);

169 
	`check_mem
(
sql
);

171 
rc
 = 
	`sql™e3_´•¬e_v2
(
CONFIG_DB
, 
sql
, -1, &
¡mt
, &
sql_
);

172 
	`check
(
rc
 =ğ
SQLITE_OK
, "SQLƒ¼Ü \"%s\"‡t: '%s'", 
	`sql™e3_”rmsg
(
CONFIG_DB
), 
sql_
);

176 
rc
 = 
	`sql™e3_¡•
(
¡mt
);

178 if(
rc
 =ğ
SQLITE_DONE
) {

179 if(
	`sql™e3_cŞumn_couÁ
(
¡mt
) == 0) {

181 
»s
 = 
	`Šs_g‘_nuÎ
();

184 
»s
 = 
	`Šs_Ãw_li¡
();

186 } if(
rc
 =ğ
SQLITE_ROW
) {

188 
»s
 = 
	`Šs_Ãw_li¡
();

191 
Šs_v®ue_t
 *
row
 = 
	`DB_cÚv”t_cŞumn
(
¡mt
);

192 
	`check
(
row
 !ğ
NULL
, "FaedØcÚv”ˆDB cŞumÀfÜ sql: '%s'", 
sql
);

193 
	`Šs_add_to_li¡
(
»s
, 
row
);

194 } (
rc
 = 
	`sql™e3_¡•
(
¡mt
)è=ğ
SQLITE_ROW
);

197 
	`check
(
rc
 !ğ
SQLITE_ERROR
, "Fau»ƒxecutšg sql: %s", 
	`sql™e3_”rmsg
(
CONFIG_DB
));

199 
	`sql™e3_ä“
(
sql
);

200 
	`sql™e3_fš®ize
(
¡mt
);

201 
	`va_’d
(
¬gp
);

202  
»s
;

204 
”rÜ
:

205 
	`va_’d
(
¬gp
);

206 if(
¡mt
è
	`sql™e3_fš®ize
(stmt);

207 if(
zE¼Msg
è
	`sql™e3_ä“
(zErrMsg);

208 if(
sql
è
	`sql™e3_ä“
(sql);

209 if(
»s
è
	`Šs_v®ue_de¡roy
(res);

210  
NULL
;

211 
	}
}

218 
Šs_v®ue_t
 *
	$DB_g‘
(
Šs_v®ue_t
 *
»s
, 
row
, 
cŞ
)

220 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Result should be‡†ist.");

221 
	`check
(
row
 < 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
),

222 "Row %d…a¡ƒnd oà»suÉ s‘†’gth: %d", 
row
,

223 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
));

225 
Šs_v®ue_t
 *
r
 = 
	`d¬¿y_g‘
(
»s
->
v®ue
.
li¡
, 
row
);

226 
	`check
(
	`Šs_g‘_ty³
(
r
è=ğ
Šs_g_li¡
, "Row %d should b¨li¡.", 
row
);

227 
	`check
(
cŞ
 < 
	`d¬¿y_’d
(
r
->
v®ue
.
li¡
),

228 "CŞumÀ%d…a¡ƒnd oà»suÉ s‘†’gth: %d", 
cŞ
,

229 
	`d¬¿y_’d
(
r
->
v®ue
.
li¡
));

231  
	`d¬¿y_g‘
(
r
->
v®ue
.
li¡
, 
cŞ
);

232 
”rÜ
:

233  
NULL
;

234 
	}
}

242 
	$DB_couÁs
(
Šs_v®ue_t
 *
»s
, *
cŞs
)

244 
rows
 = 0;

246 if(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_nuÎ
) {

247 *
cŞs
 = 0;

249 
	`check
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Result should get‡†ist.");

250 
rows
 = 
	`d¬¿y_’d
(
»s
->
v®ue
.
li¡
);

252 if(
rows
) {

253 
Šs_v®ue_t
 *
fœ¡_row
 = 
	`d¬¿y_g‘
(
»s
->
v®ue
.
li¡
, 0);

254 
	`check
(
	`Šs_g‘_ty³
(
fœ¡_row
è=ğ
Šs_g_li¡
,

256 *
cŞs
 = 
	`d¬¿y_’d
(
fœ¡_row
->
v®ue
.
li¡
);

258 *
cŞs
 = 0;

262  
rows
;

263 
”rÜ
:

265 
	}
}

268 
	$DB_Ï¡id
()

270  ()
	`sql™e3_Ï¡_š£¹_rowid
(
CONFIG_DB
);

271 
	}
}

	@tools/src/config/db.h

35 #iâdeà
_db_h


36 
	#_db_h


	)

38 
	~<sql™e3.h
>

39 
	~"Š‘¡ršgs.h
"

41 
DB_š™
(cÚ¡ *
·th
);

43 
DB_şo£
();

45 
Šs_v®ue_t
 *
DB_exec
(cÚ¡ *
qu”y
, ...);

47 
Šs_v®ue_t
 *
DB_g‘
Ñns_v®ue_ˆ*
»s
, 
row
, 
cŞ
);

49 
DB_couÁs
(
Šs_v®ue_t
 *
»s
, *
cŞs
);

51 
DB_v®id_schema
(
Šs_v®ue_t
 *
»s
, 
row
, 
ncŞs
, ...);

53 
DB_Ï¡id
();

55 
	#DB_g‘_as
(
RES
, 
ROW
, 
COL
, 
TYPE
è(
	`DB_g‘
((RES), (ROW), (COL))->
v®ue
.TYPE)

	)

57 
sql™e3
 *
CONFIG_DB
;

59 
	#DB_check
(
RES
, 
ROW
, 
COLS
, ...è
	`check
(
	`DB_v®id_schema
((RES), (ROW), (COLS), ##
__VA_ARGS__
), "Inv®id schem¨fÜ„ow, should be: " #__VA_ARGS__)

	)

	@tools/src/config/module.c

35 
	~"cÚfig/moduË.h
"

36 
	~"cÚfig/db.h
"

38 
	$deçuÉ_š™
(cÚ¡ *
·th
)

40  
	`DB_š™
(
·th
);

41 
	}
}

43 
	$deçuÉ_şo£
()

45 
	`DB_şo£
();

46 
	}
}

48 
Šs_v®ue_t
 *
	$deçuÉ_lßd_hªdËr
(
hªdËr_id
)

50 cÚ¡ *
HANDLER_QUERY
 = "SELECT id, send_spec, send_ident,„ecv_spec,„ecv_ident,„aw_payload,…rotocol FROM handler WHERE id=%d";

51  
	`DB_exec
(
HANDLER_QUERY
, 
hªdËr_id
);

52 
	}
}

54 
Šs_v®ue_t
 *
	$deçuÉ_lßd_´oxy
(
´oxy_id
)

56 cÚ¡ *
PROXY_QUERY
 = "SELECT id,‡ddr,…ort FROM…roxy WHERE id=%d";

57  
	`DB_exec
(
PROXY_QUERY
, 
´oxy_id
);

58 
	}
}

60 
Šs_v®ue_t
 *
	$deçuÉ_lßd_dœ
(
dœ_id
)

62 cÚ¡ *
DIR_QUERY
 = "SELECT id, base, index_file, default_ctype, cache_ttl FROM directory WHERE id=%d";

63  
	`DB_exec
(
DIR_QUERY
, 
dœ_id
);

64 
	}
}

66 
Šs_v®ue_t
 *
	$deçuÉ_lßd_rou‹s
(
ho¡_id
, 
£rv”_id
)

68 cÚ¡ *
ROUTE_QUERY
 = "SELECT„oute.id,„oute.path,„oute.target_id,„oute.target_type "

72  
	`DB_exec
(
ROUTE_QUERY
, 
ho¡_id
, 
£rv”_id
);

73 
	}
}

75 
Šs_v®ue_t
 *
	$deçuÉ_lßd_ho¡s
(
£rv”_id
)

77 cÚ¡ *
HOST_QUERY
 = "SELECT id,‚ame, matching, server_id FROM host WHERE server_id = %d";

78  
	`DB_exec
(
HOST_QUERY
, 
£rv”_id
);

79 
	}
}

81 
Šs_v®ue_t
 *
	$deçuÉ_lßd_£rv”
(cÚ¡ *
uuid
)

83 cÚ¡ *
SERVER_QUERY
 = "SELECT id, uuid, default_host, bind_addr,…ort, chroot,‡ccess_log,ƒrror_log,…id_file, use_ssl FROM server WHERE uuid=%Q";

85  
	`DB_exec
(
SERVER_QUERY
, 
uuid
);

86 
	}
}

89 
Šs_v®ue_t
 *
	$deçuÉ_lßd_mim‘y³s
()

91 cÚ¡ *
MIME_QUERY
 = "SELECT id,ƒxtension, mimetype FROM mimetype";

92  
	`DB_exec
(
MIME_QUERY
);

93 
	}
}

95 
Šs_v®ue_t
 *
	$deçuÉ_lßd_£‰šgs
()

97 cÚ¡ *
SETTINGS_QUERY
 = "SELECT id, key, value FROM setting";

98  
	`DB_exec
(
SETTINGS_QUERY
);

99 
	}
}

102 
CÚfigModuË
 
	gCONFIG_MODULE
 = {

103 .
š™
 = 
deçuÉ_š™
,

104 .
	gşo£
 = 
deçuÉ_şo£
,

105 .
	glßd_hªdËr
 = 
deçuÉ_lßd_hªdËr
,

106 .
	glßd_´oxy
 = 
deçuÉ_lßd_´oxy
,

107 .
	glßd_dœ
 = 
deçuÉ_lßd_dœ
,

108 .
	glßd_rou‹s
 = 
deçuÉ_lßd_rou‹s
,

109 .
	glßd_ho¡s
 = 
deçuÉ_lßd_ho¡s
,

110 .
	glßd_£rv”
 = 
deçuÉ_lßd_£rv”
,

111 .
	glßd_mim‘y³s
 = 
deçuÉ_lßd_mim‘y³s
,

112 .
	glßd_£‰šgs
 = 
deçuÉ_lßd_£‰šgs


	@tools/src/config/module.h

1 #iâdeà
_moduË_h


2 
	#_moduË_h


	)

4 
	~"Š‘¡ršgs.h
"

6 
	sCÚfigModuË
 {

7 (*
	mš™
)(cÚ¡ *
	m·th
);

8 (*
	mşo£
)();

9 
	mŠs_v®ue_t
 *(*
	mlßd_hªdËr
)(
	mhªdËr_id
);

10 
	mŠs_v®ue_t
 *(*
	mlßd_´oxy
)(
	m´oxy_id
);

11 
	mŠs_v®ue_t
 *(*
	mlßd_dœ
)(
	mdœ_id
);

12 
	mŠs_v®ue_t
 *(*
	mlßd_rou‹s
)(
	mho¡_id
, 
	m£rv”_id
);

13 
	mŠs_v®ue_t
 *(*
	mlßd_ho¡s
)(
	m£rv”_id
);

14 
	mŠs_v®ue_t
 *(*
	mlßd_£rv”
)(cÚ¡ *
	muuid
);

15 
	mŠs_v®ue_t
 *(*
	mlßd_mim‘y³s
)();

16 
	mŠs_v®ue_t
 *(*
	mlßd_£‰šgs
)();

17 } 
	tCÚfigModuË
;

19 
CÚfigModuË
 
CONFIG_MODULE
;

	@tools/src/connection.c

35 
	~<as£¹.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

39 
	~"cÚÃùiÚ.h
"

40 
	~"h‰p11/h‰pş›Á_·r£r.h
"

41 
	~"dbg.h
"

42 
	~"ev’ts.h
"

43 
	~"»gi¡”.h
"

44 
	~"·‰”n.h
"

45 
	~"dœ.h
"

46 
	~"»¥Ú£.h
"

47 
	~"mem/h®loc.h
"

48 
	~"£‰šg.h
"

49 
	~"log.h
"

50 
	~"u¶ßd.h
"

51 
	~"f‹r.h
"

53 
gb¡ršg
 
	gPING_PATTERN
 = 
bsStic
("@[a-z/]- {\"type\":\\s*\"ping\"}");

55 
gb¡ršg
 
	gPOLICY_XML_REQUEST
 = 
bsStic
("<policy-file-request");

57 
	gMAX_CONTENT_LENGTH
 = 20 * 1024;

58 
	gBUFFER_SIZE
 = 4 * 1024;

59 
	gCONNECTION_STACK
 = 32 * 1024;

60 
	gCLIENT_READ_RETRIES
 = 5;

63 
šlše
 
	$CÚÃùiÚ_back’d_ev’t
(
Back’d
 *
found
, 
CÚÃùiÚ
 *
cÚn
)

65 
found
->
ty³
) {

66 
BACKEND_HANDLER
:

67  
HANDLER
;

68 
BACKEND_DIR
:

69  
DIRECTORY
;

70 
BACKEND_PROXY
:

71  
PROXY
;

73 
	`”rÜ_»¥Ú£
(
cÚn
, 501, "Inv®id back’dy³: %d", 
found
->
ty³
);

76 
”rÜ
:

77  
CLOSE
;

78 
	}
}

82 
	$cÚÃùiÚ_£nd_sock‘_»¥Ú£
(
CÚÃùiÚ
 *
cÚn
)

84 if(
	`Re¥Ú£_£nd_sock‘_pŞicy
(
cÚn
) > 0) {

85  
RESP_SENT
;

87  
CLOSE
;

89 
	}
}

92 
	$cÚÃùiÚ_rou‹_»que¡
(
CÚÃùiÚ
 *
cÚn
)

94 
Ho¡
 *
ho¡
 = 
NULL
;

95 
Rou‹
 *
rou‹
 = 
NULL
;

97 
b¡ršg
 
·th
 = 
	`Reque¡_·th
(
cÚn
->
»q
);

99 if(
cÚn
->
»q
->
ho¡_Çme
) {

100 
ho¡
 = 
	`S”v”_m©ch_back’d
(
cÚn
->
£rv”
, cÚn->
»q
->
ho¡_Çme
);

102 
ho¡
 = 
cÚn
->
£rv”
->
deçuÉ_ho¡
;

105 
	`”rÜ_uÆess
(
ho¡
, 
cÚn
, 404, "Reque¡ fÜ‡ ho¡ wdÚ'ˆhav»gi¡”ed: %s", 
	`bd©a
(cÚn->
»q
->
ho¡_Çme
));

107 
Back’d
 *
found
 = 
	`Ho¡_m©ch_back’d
(
ho¡
, 
·th
, &
rou‹
);

108 
	`”rÜ_uÆess
(
found
, 
cÚn
, 404, "HªdË¸nÙ found: %s", 
	`bd©a
(
·th
));

110 
	`Reque¡_£t_aùiÚ
(
cÚn
->
»q
, 
found
);

112 
cÚn
->
»q
->
rg‘_ho¡
 = 
ho¡
;

113 
cÚn
->
»q
->
·‰”n
 = 
rou‹
->pattern;

114 
cÚn
->
»q
->
´efix
 = 
rou‹
->prefix;

116  
	`CÚÃùiÚ_back’d_ev’t
(
found
, 
cÚn
);

118 
”rÜ
:

119  
CLOSE
;

120 
	}
}

124 
	$cÚÃùiÚ_msg_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
)

126 
HªdËr
 *
hªdËr
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
, handler);

127 
rc
 = 0;

128 
h—d”_Ën
 = 
	`Reque¡_h—d”_Ëngth
(
cÚn
->
»q
);

130 
body_Ën
 = 
	`Reque¡_cÚ‹Á_Ëngth
(
cÚn
->
»q
);

132 
	`check
(
hªdËr
, "JSON„equest doesn't match‡ny handler: %s",

133 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

135 if(
	`·‰”n_m©ch
(
	`IOBuf_¡¬t
(
cÚn
->
iob
), 
h—d”_Ën
 + 
body_Ën
, 
	`bd©a
(&
PING_PATTERN
))) {

136 
	`Regi¡”_pšg
(
	`IOBuf_fd
(
cÚn
->
iob
));

138 
	`check
(
body_Ën
 >= 0, "Parsingƒrror, body†engthƒnded up being: %d", body_len);

139 
b¡ršg
 
·ylßd
 = 
NULL
;

141 if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_TNET
) {

142 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

143 
	`IOBuf_fd
(
cÚn
->
iob
), 
	`IOBuf_¡¬t
(cÚn->iobè+ 
h—d”_Ën
,

144 
body_Ën
 - 1);

145 } if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_JSON
) {

146 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

147 
	`IOBuf_fd
(
cÚn
->
iob
), 
	`IOBuf_¡¬t
(cÚn->iobè+ 
h—d”_Ën
,

148 
body_Ën
 - 1);

150 
	`£Áš–
("Inv®id…rÙocŞy³: %d", 
hªdËr
->
´ÙocŞ
);

153 
	`debug
("SENT: %s", 
	`bd©a
(
·ylßd
));

154 
	`check
(
·ylßd
 !ğ
NULL
, "Failedo generate…ayload.");

155 
	`check
(
hªdËr
->
£nd_sock‘
 !ğ
NULL
, "Handler socket is NULL,ell Zed.");

157 
rc
 = 
	`HªdËr_d–iv”
(
hªdËr
->
£nd_sock‘
, 
	`bd©a
(
·ylßd
), 
	`bËngth
(payload));

158 
	`ä“
(
·ylßd
);

160 
	`check
(
rc
 =ğ0, "FaedØd–iv”ØhªdËr: %s", 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

164 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
iob
, 
h—d”_Ën
 + 
body_Ën
) != -1, "Final commit failed.");

166  
REQ_SENT
;

168 
”rÜ
:

169  
CLOSE
;

170 
	}
}

173 
	$CÚÃùiÚ_£nd_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, *
body
, 
cÚ‹Á_Ën
)

175 
rc
 = 0;

176 
b¡ršg
 
·ylßd
 = 
NULL
;

178 
	`”rÜ_uÆess
(
hªdËr
->
ruÂšg
, 
cÚn
, 502, "Handler shutdown whileryingo deliver: %s",

179 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

181 if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_TNET
) {

182 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

183 
	`IOBuf_fd
(
cÚn
->
iob
), 
body
, 
cÚ‹Á_Ën
);

184 } if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_JSON
) {

185 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
cÚn
->
»q
, 
hªdËr
->
£nd_id’t
,

186 
	`IOBuf_fd
(
cÚn
->
iob
), 
body
, 
cÚ‹Á_Ën
);

188 
	`£Áš–
("Inv®id…rÙocŞy³: %d", 
hªdËr
->
´ÙocŞ
);

191 
	`debug
("SENT: %s", 
	`bd©a
(
·ylßd
));

192 
	`check
(
·ylßd
, "Failedo create…ayload for„equest.");

194 
	`debug
("HTTP TO HANDLER: %.*s", 
	`bËngth
(
·ylßd
è- 
cÚ‹Á_Ën
, 
	`bd©a
(payload));

196 
rc
 = 
	`HªdËr_d–iv”
(
hªdËr
->
£nd_sock‘
, 
	`bd©a
(
·ylßd
), 
	`bËngth
(payload));

197 
	`ä“
(
·ylßd
);…aylßd = 
NULL
;

199 
	`”rÜ_uÆess
(
rc
 !ğ-1, 
cÚn
, 502, "Failedo delivero handler: %s",

200 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

204 
”rÜ
:

205 if(
·ylßd
è
	`ä“
(payload);

207 
	}
}

210 
gb¡ršg
 
	gUPGRADE
 = 
bsStic
("upgrade");

211 
gb¡ršg
 
	gCONNECTION
 = 
bsStic
("connection");

212 cÚ¡ 
	gWEBSOCKET_ARBITRARY_BODY_SIZE
 = 8;

214 
šlše
 
	$is_websock‘
(
CÚÃùiÚ
 *
cÚn
)

216  
	`Reque¡_g‘
(
cÚn
->
»q
, &
UPGRADE
è!ğ
NULL
 &&

217 
	`Reque¡_g‘
(
cÚn
->
»q
, &
CONNECTION
è!ğ
NULL
;

218 
	}
}

220 
	$cÚÃùiÚ_h‰p_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
)

222 
cÚ‹Á_Ën
 = 
	`Reque¡_cÚ‹Á_Ëngth
(
cÚn
->
»q
);

223 
rc
 = 0;

224 *
body
 = 
NULL
;

226 
HªdËr
 *
hªdËr
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
, handler);

227 
	`”rÜ_uÆess
(
hªdËr
, 
cÚn
, 404, "NØaùiÚ fÜ„eque¡: %s", 
	`bd©a
(
	`Reque¡_·th
(cÚn->
»q
)));

230 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
iob
, 
	`Reque¡_h—d”_Ëngth
(cÚn->
»q
)) != -1, "Finaly commit failed streaminghe connectiono http handlers.");

233 if(
	`is_websock‘
(
cÚn
)) {

234 
cÚ‹Á_Ën
 = 
	`IOBuf_ava
(
cÚn
->
iob
);

235 
	`check
(
cÚ‹Á_Ën
 =ğ
WEBSOCKET_ARBITRARY_BODY_SIZE
, "Purported websocket but body does‚ot have 8 bytes");

238 if(
cÚ‹Á_Ën
 == 0) {

239 
body
 = "";

240 
rc
 = 
	`CÚÃùiÚ_£nd_to_hªdËr
(
cÚn
, 
hªdËr
, 
body
, 
cÚ‹Á_Ën
);

241 
	`check_debug
(
rc
 == 0, "Failedo deliverohe handler.");

242 } if(
cÚ‹Á_Ën
 > 
MAX_CONTENT_LENGTH
) {

243 
rc
 = 
	`U¶ßd_fe
(
cÚn
, 
hªdËr
, 
cÚ‹Á_Ën
);

244 
	`check
(
rc
 == 0, "Failedo upload file.");

246 
	`debug
("READ ALL CALLED w™h cÚ‹Á_Ën: %d,‡nd MAX_CONTENT_LENGTH: %d", 
cÚ‹Á_Ën
, 
MAX_CONTENT_LENGTH
);

248 
body
 = 
	`IOBuf_»ad_®l
(
cÚn
->
iob
, 
cÚ‹Á_Ën
, 
CLIENT_READ_RETRIES
);

249 
	`check
(
body
 !ğ
NULL
, "Client closedhe connection during upload.");

251 
rc
 = 
	`CÚÃùiÚ_£nd_to_hªdËr
(
cÚn
, 
hªdËr
, 
body
, 
cÚ‹Á_Ën
);

252 
	`check_debug
(
rc
 == 0, "Failedo deliverohe handler.");

255 
	`Log_»que¡
(
cÚn
, 200, 
cÚ‹Á_Ën
);

257  
REQ_SENT
;

259 
”rÜ
:

260  
CLOSE
;

261 
	}
}

264 
	$cÚÃùiÚ_h‰p_to_dœeùÜy
(
CÚÃùiÚ
 *
cÚn
)

266 
Dœ
 *
dœ
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
, dir);

268 
rc
 = 
	`Dœ_£rve_fe
(
dœ
, 
cÚn
->
»q
, conn);

269 
	`check_debug
(
rc
 =ğ0, "FaedØ£rvfe: %s", 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

271 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
iob
,

272 
	`Reque¡_h—d”_Ëngth
(
cÚn
->
»q
è+ 
	`Reque¡_cÚ‹Á_Ëngth
(conn->req)) != -1, "Finaly commit failed sending from directory.");

275 
	`Log_»que¡
(
cÚn
, cÚn->
»q
->
¡©us_code
, cÚn->»q->
»¥Ú£_size
);

277 if(
cÚn
->
şo£
) {

278  
CLOSE
;

280  
RESP_SENT
;

283 
”rÜ
:

284  
CLOSE
;

285 
	}
}

290 
	$cÚÃùiÚ_h‰p_to_´oxy
(
CÚÃùiÚ
 *
cÚn
)

292 
Proxy
 *
´oxy
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
,…roxy);

293 
	`check
(
´oxy
 !ğ
NULL
, "Should have‡…roxy backend.");

295 
	`debug
("CONNECT TO: %s:%d", 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

297 
´oxy_fd
 = 
	`ÃtdŸl
(1, 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

298 
	`check
(
´oxy_fd
 != -1, "Failedo connecto…roxy backend %s:%d",

299 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

301 if(!
cÚn
->
´oxy_iob
) {

302 
cÚn
->
´oxy_iob
 = 
	`IOBuf_ü—‹
(
BUFFER_SIZE
, 
´oxy_fd
, 
IOBUF_SOCKET
);

303 
	`check_mem
(
cÚn
->
´oxy_iob
);

306 if(!
cÚn
->
ş›Á
) {

307 
cÚn
->
ş›Á
 = 
	`h_ÿÎoc
((
h‰pş›Á_·r£r
), 1);

308 
	`check_mem
(
cÚn
->
ş›Á
);

309 
	`h©ch
(
cÚn
->
ş›Á
, conn);

312  
CONNECT
;

314 
”rÜ
:

315  
FAILED
;

316 
	}
}

320 
	$cÚÃùiÚ_´oxy_d–iv”
(
CÚÃùiÚ
 *
cÚn
)

322 
rc
 = 0;

323 
tÙ®_Ën
 = 
	`Reque¡_h—d”_Ëngth
(
cÚn
->
»q
è+ 
	`Reque¡_cÚ‹Á_Ëngth
(conn->req);

325 *
buf
 = 
	`IOBuf_»ad_®l
(
cÚn
->
iob
, 
tÙ®_Ën
, 
CLIENT_READ_RETRIES
);

326 
	`check
(
buf
 !ğ
NULL
, "Failedo„ead fromhe client socketo…roxy.");

328 
rc
 = 
	`IOBuf_£nd
(
cÚn
->
´oxy_iob
, 
	`IOBuf_¡¬t
(cÚn->
iob
), 
tÙ®_Ën
);

329 
	`check
(
rc
 > 0, "Failedo sendo…roxy.");

331  
REQ_SENT
;

333 
”rÜ
:

334  
REMOTE_CLOSE
;

335 
	}
}

339 
	$cÚÃùiÚ_´oxy_»¶y_·r£
(
CÚÃùiÚ
 *
cÚn
)

341 
rc
 = 0;

342 
tÙ®
 = 0;

343 
Proxy
 *
´oxy
 = 
	`Reque¡_g‘_aùiÚ
(
cÚn
->
»q
,…roxy);

344 
h‰pş›Á_·r£r
 *
ş›Á
 = 
cÚn
->client;

346 
rc
 = 
	`Proxy_»ad_ªd_·r£
(
cÚn
);

347 
	`check
(
rc
 != -1, "Failedo„ead from…roxy server: %s:%d",

348 
	`bd©a
(
´oxy
->
£rv”
),…roxy->
pÜt
);

350 if(
ş›Á
->
chunked
) {

352 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
ş›Á
->
body_¡¬t
);

353 
	`check_debug
(
rc
 != -1, "Failed streaming headero client.");

358 
rc
 = 
	`Proxy_¡»am_chunks
(
cÚn
);

359 
	`check
(
rc
 != -1, "Failedo stream chunkedƒncodingo client.");

360 } 
rc
 == 0);

362 } if(
ş›Á
->
cÚ‹Á_Ën
 >= 0) {

363 
tÙ®
 = 
ş›Á
->
body_¡¬t
 + cl›Á->
cÚ‹Á_Ën
;

364 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
tÙ®
);

365 
	`check
(
rc
 != -1, "Failed streaming‚on-chunked„esponse.");

366 } if(
ş›Á
->
¡©us
 == 204 || client->status == 304) {

369 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
ş›Á
->
body_¡¬t
);

370 
	`check
(
rc
 != -1, "Failed streaming‚on-chunked„esponse.");

371 } if(
ş›Á
->
şo£
 || cl›Á->
cÚ‹Á_Ën
 == -1) {

372 
	`debug
("Response„equested‡„ead until close.");

373 
	`check
(
	`Proxy_¡»am_to_şo£
(
cÚn
) != -1, "Failed streamingo client.");

375 
	`£Áš–
("Should‚ot„eachhis code, Tell Zed.");

378 
	`Log_»que¡
(
cÚn
, 
ş›Á
->
¡©us
, cl›Á->
cÚ‹Á_Ën
);

380 if(
ş›Á
->
şo£
) {

381  
REMOTE_CLOSE
;

383  
REQ_RECV
;

386 
”rÜ
:

387  
FAILED
;

388 
	}
}

391 
	$cÚÃùiÚ_´oxy_»q_·r£
(
CÚÃùiÚ
 *
cÚn
)

393 
rc
 = 0;

394 
Ho¡
 *
rg‘_ho¡
 = 
cÚn
->
»q
->target_host;

395 
Back’d
 *
»q_aùiÚ
 = 
cÚn
->
»q
->
aùiÚ
;

397 
	`check_debug
(!
	`IOBuf_şo£d
(
cÚn
->
iob
), "Client closed, goodbye.");

399 
rc
 = 
	`CÚÃùiÚ_»ad_h—d”
(
cÚn
, cÚn->
»q
);

401 
	`check_debug
(
rc
 > 0, "Failedo„ead‡nother header.");

402 
	`”rÜ_uÆess
(
	`Reque¡_is_h‰p
(
cÚn
->
»q
), conn, 400,

405 
Back’d
 *
found
 = 
	`Ho¡_m©ch_back’d
(
rg‘_ho¡
, 
	`Reque¡_·th
(
cÚn
->
»q
), 
NULL
);

406 
	`”rÜ_uÆess
(
found
, 
cÚn
, 404,

407 "HªdË¸nÙ found: %s", 
	`bd©a
(
	`Reque¡_·th
(
cÚn
->
»q
)));

410 if(
found
 !ğ
»q_aùiÚ
) {

411 
	`Reque¡_£t_aùiÚ
(
cÚn
->
»q
, 
found
);

412  
	`CÚÃùiÚ_back’d_ev’t
(
found
, 
cÚn
);

414  
HTTP_REQ
;

417 
	`”rÜ_»¥Ú£
(
cÚn
, 500, "Invalid code branch,ell Zed.");

418 
”rÜ
:

419  
REMOTE_CLOSE
;

420 
	}
}

424 
	$cÚÃùiÚ_´oxy_çed
(
CÚÃùiÚ
 *
cÚn
)

426 
	`Re¥Ú£_£nd_¡©us
(
cÚn
, &
HTTP_502
);

428  
CLOSE
;

429 
	}
}

432 
	$cÚÃùiÚ_´oxy_şo£
(
CÚÃùiÚ
 *
cÚn
)

434 
	`IOBuf_de¡roy
(
cÚn
->
´oxy_iob
);

435 
cÚn
->
´oxy_iob
 = 
NULL
;

437  
CLOSE
;

438 
	}
}

440 
šlše
 
	$şo£_Ü_”rÜ
(
CÚÃùiÚ
 *
cÚn
, 
Ãxt
)

443 
	`IOBuf_de¡roy
(
cÚn
->
´oxy_iob
);

444 
cÚn
->
´oxy_iob
 = 
NULL
;

446 
	`check_debug
(
	`Regi¡”_discÚÃù
(
	`IOBuf_fd
(
cÚn
->
iob
)) != -1,

447 "Regi¡” discÚÃù didn'ˆwÜk fÜ %d", 
	`IOBuf_fd
(
cÚn
->
iob
));

449 
”rÜ
:

451  
Ãxt
;

452 
	}
}

455 
	$cÚÃùiÚ_şo£
(
CÚÃùiÚ
 *
cÚn
)

457  
	`şo£_Ü_”rÜ
(
cÚn
, 0);

458 
	}
}

462 
	$cÚÃùiÚ_”rÜ
(
CÚÃùiÚ
 *
cÚn
)

464  
	`şo£_Ü_”rÜ
(
cÚn
, 
CLOSE
);

465 
	}
}

468 
	$cÚÃùiÚ_id’tify_»que¡
(
CÚÃùiÚ
 *
cÚn
)

470 
Ãxt
 = 
CLOSE
;

472 if(
	`Reque¡_is_xml
(
cÚn
->
»q
)) {

473 if(
	`bi£q
(
	`Reque¡_·th
(
cÚn
->
»q
), &
POLICY_XML_REQUEST
)) {

474 
	`debug
("XML POLICY CONNECTION");

475 
cÚn
->
ty³
 = 
CONN_TYPE_SOCKET
;

476 
	`skÇme
("XML");

477 
Ãxt
 = 
SOCKET_REQ
;

479 
	`debug
("XML MESSAGE");

480 
cÚn
->
ty³
 = 
CONN_TYPE_MSG
;

481 
	`skÇme
("MSG");

482 
Ãxt
 = 
MSG_REQ
;

484 } if(
	`Reque¡_is_jsÚ
(
cÚn
->
»q
)) {

485 
	`debug
("JSON SOCKET MESSAGE");

486 
cÚn
->
ty³
 = 
CONN_TYPE_MSG
;

487 
	`skÇme
("MSG");

488 
Ãxt
 = 
MSG_REQ
;

489 } if(
	`Reque¡_is_h‰p
(
cÚn
->
»q
)) {

490 
	`debug
("HTTP MESSAGE");

491 
cÚn
->
ty³
 = 
CONN_TYPE_HTTP
;

492 
	`skÇme
("HTTP");

493 
Ãxt
 = 
HTTP_REQ
;

495 
	`”rÜ_»¥Ú£
(
cÚn
, 500, "Invalid code branch,ell Zed.");

498  
Ãxt
;

500 
”rÜ
:

501  
CLOSE
;

503 
	}
}

506 
	$cÚÃùiÚ_·r£
(
CÚÃùiÚ
 *
cÚn
)

508 if(
	`CÚÃùiÚ_»ad_h—d”
(
cÚn
, cÚn->
»q
) > 0) {

509  
REQ_RECV
;

511  
CLOSE
;

513 
	}
}

515 
S‹AùiÚs
 
	gCONN_ACTIONS
 = {

516 .
”rÜ
 = 
cÚÃùiÚ_”rÜ
,

517 .
	gşo£
 = 
cÚÃùiÚ_şo£
,

518 .
	g·r£
 = 
cÚÃùiÚ_·r£
,

519 .
	g»gi¡”_»que¡
 = 
cÚÃùiÚ_id’tify_»que¡
,

520 .
	gid’tify_»que¡
 = 
cÚÃùiÚ_id’tify_»que¡
,

521 .
	grou‹_»que¡
 = 
cÚÃùiÚ_rou‹_»que¡
,

522 .
	g£nd_sock‘_»¥Ú£
 = 
cÚÃùiÚ_£nd_sock‘_»¥Ú£
,

523 .
	gmsg_to_hªdËr
 = 
cÚÃùiÚ_msg_to_hªdËr
,

524 .
	gh‰p_to_hªdËr
 = 
cÚÃùiÚ_h‰p_to_hªdËr
,

525 .
	gh‰p_to_´oxy
 = 
cÚÃùiÚ_h‰p_to_´oxy
,

526 .
	gh‰p_to_dœeùÜy
 = 
cÚÃùiÚ_h‰p_to_dœeùÜy
,

527 .
	g´oxy_d–iv”
 = 
cÚÃùiÚ_´oxy_d–iv”
,

528 .
	g´oxy_çed
 = 
cÚÃùiÚ_´oxy_çed
,

529 .
	g´oxy_»¶y_·r£
 = 
cÚÃùiÚ_´oxy_»¶y_·r£
,

530 .
	g´oxy_»q_·r£
 = 
cÚÃùiÚ_´oxy_»q_·r£
,

531 .
	g´oxy_şo£
 = 
cÚÃùiÚ_´oxy_şo£


536 
	$CÚÃùiÚ_de¡roy
(
CÚÃùiÚ
 *
cÚn
)

538 if(
cÚn
) {

539 
	`Reque¡_de¡roy
(
cÚn
->
»q
);

540 
cÚn
->
»q
 = 
NULL
;

541 
	`IOBuf_de¡roy
(
cÚn
->
iob
);

542 
	`IOBuf_de¡roy
(
cÚn
->
´oxy_iob
);

543 
	`h_ä“
(
cÚn
);

545 
	}
}

548 
CÚÃùiÚ
 *
	$CÚÃùiÚ_ü—‹
(
S”v”
 *
¤v
, 
fd
, 
½Üt
,

549 cÚ¡ *
»mÙe
)

551 
CÚÃùiÚ
 *
cÚn
 = 
	`h_ÿÎoc
((Connection), 1);

552 
	`check_mem
(
cÚn
);

554 
cÚn
->
£rv”
 = 
¤v
;

556 
cÚn
->
½Üt
 =„port;

557 
	`memıy
(
cÚn
->
»mÙe
,„emÙe, 
IPADDR_SIZE
);

558 
cÚn
->
»mÙe
[
IPADDR_SIZE
] = '\0';

559 
cÚn
->
ty³
 = 0;

561 
cÚn
->
»q
 = 
	`Reque¡_ü—‹
();

562 
	`check_mem
(
cÚn
->
»q
);

564 if(
¤v
 !ğ
NULL
 && srv->
u£_s¦
) {

565 
cÚn
->
iob
 = 
	`IOBuf_ü—‹
(
BUFFER_SIZE
, 
fd
, 
IOBUF_SSL
);

566 
	`check
(
cÚn
->
iob
 !ğ
NULL
, "Failedo createhe SSL IOBuf.");

568 
	`s¦_£t_own_û¹
(&
cÚn
->
iob
->
s¦
, &
¤v
->
own_û¹
, &¤v->
r§_key
);

569 
	`s¦_£t_dh_·¿m
(&
cÚn
->
iob
->
s¦
, 
¤v
->
dhm_P
, srv->
dhm_G
);

570 
	`s¦_£t_ch”s
(&
cÚn
->
iob
->
s¦
, 
¤v
->
ch”s
);

572 
cÚn
->
iob
 = 
	`IOBuf_ü—‹
(
BUFFER_SIZE
, 
fd
, 
IOBUF_SOCKET
);

575  
cÚn
;

577 
”rÜ
:

578 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

579  
NULL
;

580 
	}
}

583 
	$CÚÃùiÚ_acû±
(
CÚÃùiÚ
 *
cÚn
)

585 
	`check
(
	`Regi¡”_cÚÃù
(
	`IOBuf_fd
(
cÚn
->
iob
), (*)conn) != -1,

588 
	`check
(
	`skü—‹
(
CÚÃùiÚ_sk
, 
cÚn
, 
CONNECTION_STACK
) != -1,

592 
”rÜ
:

594 
	}
}

598 
	$CÚÃùiÚ_sk
(*
v
)

600 
CÚÃùiÚ
 *
cÚn
 = (CÚÃùiÚ *)
v
;

601 
i
 = 0;

602 
Ãxt
 = 0;

604 
	`S‹_š™
(&
cÚn
->
¡©e
, &
CONN_ACTIONS
);

606 
i
 = 0, 
Ãxt
 = 
OPEN
;‚exˆ!ğ
CLOSE
; i++) {

608 if(
	`F‹r_aùiv©ed
()) {

609 
Ãxt
 = 
	`F‹r_run
Òext, 
cÚn
);

610 
	`check
(
Ãxt
 >ğ
CLOSE
 &&‚exˆ< 
EVENT_END
,

611 "!!! Inv®id‚exˆev’t[%d]: %d from f‹r!", 
i
, 
Ãxt
);

614 
Ãxt
 = 
	`S‹_exec
(&
cÚn
->
¡©e
,‚ext, (*)conn);

616 
	`check
(
Ãxt
 >ğ
CLOSE
 &&‚exˆ< 
EVENT_END
,

617 "!!! Inv®id‚exˆev’t[%d]: %d, T–ÈZED!", 
i
, 
Ãxt
);

619 if(
cÚn
->
iob
 && !cÚn->iob->
şo£d
) {

620 
	`Regi¡”_pšg
(
	`IOBuf_fd
(
cÚn
->
iob
));

624 
”rÜ
:

625 
	`S‹_exec
(&
cÚn
->
¡©e
, 
CLOSE
, (*)conn);

626 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

627 
	`skex™
(0);

628 
	}
}

630 
	$CÚÃùiÚ_d–iv”_¿w
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
)

632  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
buf
), 
	`bËngth
(buf));

633 
	}
}

635 
	$CÚÃùiÚ_d–iv”
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
)

637 
rc
 = 0;

639 
b¡ršg
 
b64_buf
 = 
	`bBa£64Encode
(
buf
);

640 
	`as£¹
(
b64_buf
 !ğ
NULL
 && "WTF!");

641 
	`as£¹
(
cÚn
->
iob
 !ğ
NULL
 && "WTF! NO IOBUF!");

642 
rc
 = 
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
b64_buf
), 
	`bËngth
(b64_buf)+1);

643 
	`check_debug
(
rc
 =ğ
	`bËngth
(
b64_buf
)+1, "FaedØwr™’tœmes§gtØcÚÀ%d", 
	`IOBuf_fd
(
cÚn
->
iob
));

645 
	`bde¡roy
(
b64_buf
);

648 
”rÜ
:

649 
	`bde¡roy
(
b64_buf
);

651 
	}
}

654 
šlše
 
	$check_should_şo£
(
CÚÃùiÚ
 *
cÚn
, 
Reque¡
 *
»q
)

656 if(
»q
->
v”siÚ
 && 
	`bi£qc¡r
(req->version, "HTTP/1.0")) {

657 
	`debug
("HTTP 1.0„eque¡ comšg iÀäom %s", 
cÚn
->
»mÙe
);

658 
cÚn
->
şo£
 = 1;

660 
b¡ršg
 
cÚn_şo£
 = 
	`Reque¡_g‘
(
»q
, &
HTTP_CONNECTION
);

662 if(
cÚn_şo£
 && 
	`bi£qc¡rÿ£Ëss
(conn_close, "close")) {

663 
cÚn
->
şo£
 = 1;

665 
cÚn
->
şo£
 = 0;

668 
	}
}

671 
	$CÚÃùiÚ_»ad_h—d”
(
CÚÃùiÚ
 *
cÚn
, 
Reque¡
 *
»q
)

673 *
d©a
 = 
	`IOBuf_¡¬t
(
cÚn
->
iob
);

674 
ava
 = 
	`IOBuf_ava
(
cÚn
->
iob
);

675 
rc
 = 0;

676 
size_t
 
Å¬£d
 = 0;

677 
Œ›s
 = 0;

679 
	`Reque¡_¡¬t
(
»q
);

681 
Œ›s
 = 0; 
rc
 =ğ0 &&r› < 
CLIENT_READ_RETRIES
;ries++) {

682 if(
ava
 > 0) {

683 
rc
 = 
	`Reque¡_·r£
(
»q
, 
d©a
, 
ava
, &
Å¬£d
);

686 if(
rc
 == 0) {

687 
d©a
 = 
	`IOBuf_»ad_some
(
cÚn
->
iob
, &
ava
);

688 
	`check_debug
(!
	`IOBuf_şo£d
(
cÚn
->
iob
), "Client closed during„ead.");

692 
	`”rÜ_uÆess
(
Œ›s
 < 
CLIENT_READ_RETRIES
, 
cÚn
,

694 
	`”rÜ_uÆess
(
rc
 =ğ1, 
cÚn
, 400, "Error…arsing„equest.");

697 
	`Reque¡_£t
(
cÚn
->
»q
, 
	`b¡rıy
(&
HTTP_X_FORWARDED_FOR
),

698 
	`bäomc¡r
(
cÚn
->
»mÙe
), 1);

700 
	`check_should_şo£
(
cÚn
, cÚn->
»q
);

702  
Å¬£d
;

704 
”rÜ
:

707 
	}
}

710 
	$CÚÃùiÚ_š™
()

712 
MAX_CONTENT_LENGTH
 = 
	`S‘tšg_g‘_št
("limits.content_length", 20 * 1024);

713 
BUFFER_SIZE
 = 
	`S‘tšg_g‘_št
("limits.buffer_size", 4 * 1024);

714 
CONNECTION_STACK
 = 
	`S‘tšg_g‘_št
("limits.connection_stack_size", 32 * 1024);

715 
CLIENT_READ_RETRIES
 = 
	`S‘tšg_g‘_št
("limits.client_read_retries", 5);

718 
	`log_šfo
("MAX†imits.content_length=%d,†imits.buffer_size=%d,†imits.connection_stack_size=%d,†imits.client_read_retries=%d",

719 
MAX_CONTENT_LENGTH
, 
BUFFER_SIZE
, 
CONNECTION_STACK
,

720 
CLIENT_READ_RETRIES
);

722 
PROXY_READ_RETRIES
 = 
	`S‘tšg_g‘_št
("limits.proxy_read_retries", 100);

723 
PROXY_READ_RETRY_WARN
 = 
	`S‘tšg_g‘_št
("limits.proxy_read_retry_warn", 10);

725 
	`log_šfo
("MAX†imits.proxy_read_retries=%d,†imits.proxy_read_retry_warn=%d",

726 
PROXY_READ_RETRIES
, 
PROXY_READ_RETRY_WARN
);

727 
	}
}

	@tools/src/connection.h

35 #iâdeà
_li¡’”_h


36 
	#_li¡’”_h


	)

38 
	~"£rv”.h
"

39 
	~"»que¡.h
"

40 
	~"¡©e.h
"

41 
	~"´oxy.h
"

42 
	~"io.h
"

43 
	~"adt/hash.h
"

45 
CONNECTION_STACK
;

46 
BUFFER_SIZE
;

47 
MAX_CONTENT_LENGTH
;

50 
	mCONN_TYPE_HTTP
=1,

51 
	mCONN_TYPE_MSG
,

52 
	mCONN_TYPE_SOCKET


55 
	sCÚÃùiÚ
 {

56 
S”v”
 *
	m£rv”
;

57 
Reque¡
 *
	m»q
;

59 
IOBuf
 *
	miob
;

60 
IOBuf
 *
	m´oxy_iob
;

62 
	m½Üt
;

63 
S‹
 
	m¡©e
;

64 
h‰pş›Á_·r£r
 *
	mş›Á
;

65 
	mşo£
;

66 
	mty³
;

67 
hash_t
 *
	mf‹r_¡©e
;

68 
	m»mÙe
[
IPADDR_SIZE
+1];

69 } 
	tCÚÃùiÚ
;

71 
CÚÃùiÚ_de¡roy
(
CÚÃùiÚ
 *
cÚn
);

73 
CÚÃùiÚ
 *
CÚÃùiÚ_ü—‹
(
S”v”
 *
¤v
, 
fd
, 
½Üt
,

74 cÚ¡ *
»mÙe
);

76 
CÚÃùiÚ_acû±
(
CÚÃùiÚ
 *
cÚn
);

78 
CÚÃùiÚ_sk
(*
v
);

80 
	gHªdËr
;

81 
CÚÃùiÚ_£nd_to_hªdËr
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, *
body
, 
cÚ‹Á_Ën
);

83 
CÚÃùiÚ_d–iv”_¿w
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
);

85 
CÚÃùiÚ_d–iv”
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
buf
);

87 
CÚÃùiÚ_»ad_h—d”
(
CÚÃùiÚ
 *
cÚn
, 
Reque¡
 *
»q
);

89 
CÚÃùiÚ_š™
();

	@tools/src/control.c

35 
	~"cÚŒŞ.h
"

36 
	~"b¡ršg.h
"

37 
	~"sk/sk.h
"

38 
	~"»gi¡”.h
"

39 
	~"£rv”.h
"

40 
	~"dbg.h
"

41 
	~<¡dlib.h
>

42 
	~<time.h
>

43 
	~"£‰šg.h
"

44 
	~<sigÇl.h
>

45 
	~"Š‘¡ršgs.h
"

46 
	~"Š‘¡ršgs_im¶.h
"

47 
	~"v”siÚ.h
"

49 
S”v”
 *
SERVER
;

51 
	$c¡r_ä“
(*
d©a
, *
hšt
)

53 
	`ä“
(
d©a
);

54 
	}
}

56 
	gCONTROL_RUNNING
 = 1;

57 *
	gCONTROL_SOCKET
 = 
NULL
;

60 
gb¡ršg
 
	gINVALID_FORMAT_ERR
 = 
bsStic
("101:4:code,15:INVALID_REQUEST,5:error,63:Invalid„equest format, must be‡†ist withwoƒlements in it.,}");

61 
gb¡ršg
 
	gINVALID_DATA_ERR
 = 
bsStic
("97:4:code,12:INVALID_DATA,5:error,62:Invalid data,ƒxpecting‡†ist with‡ string‡nd‡ hash in it.,}");

62 
gb¡ršg
 
	gCALLBACK_RETURN_ERR
 = 
bsStic
("91:4:code,15:CALLBACK_RETURN,5:error,53:Callback failed‡nd„eturned NULL, should‚ot happen.,}");

63 
gb¡ršg
 
	gCALLBACK_NOT_FOUND_ERR
 = 
bsStic
("74:4:code,18:CALLBACK_NOT_FOUND,5:error,33:Callback„equested was‚ot found.,}");

64 
gb¡ršg
 
	gSIGNAL_FAILED_ERR
 = 
bsStic
("75:4:code,13:SIGNAL_FAILED,5:error,39:raise call failed, can't signal…rocess,}");

65 
gb¡ršg
 
	gINVALID_ARGUMENT_ERR
 = 
bsStic
("61:4:code,16:INVALID_ARGUMENT,5:error,22:Invalid‡rgumentype.,}");

66 
gb¡ršg
 
	gNOT_CONNECTED_ERR
 = 
bsStic
("57:4:code,13:NOT_CONNECTED,5:error,21:Socket‚ot connected.,}");

69 
	#check_cÚŒŞ_”r
(
A
, 
E
, 
M
, ...èif(!(A)è{ 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(E), 
	`bËngth
(E), 
NULL
); 
	`log_w¬n
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

71 
	gŠs_v®ue_t
 *(*
	tÿÎback_t
)(
	tb¡ršg
 
	tÇme
, 
	thash_t
 *
	t¬gs
);

73 
	sÿÎback_li¡_t
 {

74 
gb¡ršg
 
	mÇme
;

75 
gb¡ršg
 
	mh–p
;

76 
ÿÎback_t
 
	mÿÎback
;

77 } 
	tÿÎback_li¡_t
;

79 
ÿÎback_li¡_t
 
	gCALLBACKS
[];

81 
šlše
 
Šs_v®ue_t
 *
	$»ad_mes§ge
(*
sock
)

83 
Šs_v®ue_t
 *
»q
 = 
NULL
;

84 
rc
 = 0;

86 
zmq_msg_t
 *
šmsg
 = 
	`ÿÎoc
((zmq_msg_t), 1);

87 
rc
 = 
	`zmq_msg_š™
(
šmsg
);

88 
	`check
(
rc
 == 0, "init failed.");

90 
rc
 = 
	`mq»cv
(
sock
, 
šmsg
, 0);

91 
	`check
(
rc
 == 0, "Receive on control failed.");

93 
»q
 = 
	`Šs_·r£
(
	`zmq_msg_d©a
(
šmsg
), 
	`zmq_msg_size
(šmsg), 
NULL
);

95 if(
»q
 =ğ
NULL
) {

96 
»q
 = 
	`Šs_g‘_nuÎ
();

99 
	`check
(
»q
, "Failedo createhe„equest string.");

101 
	`zmq_msg_şo£
(
šmsg
);

102 
	`ä“
(
šmsg
);

104  
»q
;

106 
”rÜ
:

107 if(
šmsg
) {

108 
	`zmq_msg_şo£
(
šmsg
);

109 
	`ä“
(
šmsg
);

112  
NULL
;

113 
	}
}

116 
šlše
 
	$£nd_»¶y
(*
sock
, 
Šs_v®ue_t
 *
»p
)

118 
rc
 = 0;

119 
size_t
 
Ën
 = 0;

121 
zmq_msg_t
 *
outmsg
 = 
	`ÿÎoc
((zmq_msg_t), 1);

122 
	`check_mem
(
outmsg
);

124 
rc
 = 
	`zmq_msg_š™
(
outmsg
);

125 
	`check
(
rc
 == 0, "Cannot‡llocate zmq msg.");

127 *
outbuf
 = 
	`Šs_»nd”
(
»p
, &
Ën
);

128 
	`check
(
outbuf
 !ğ
NULL
, "Failedo„ender control…ort„eply.");

129 
	`check
(
Ën
 > 0, "Control…ort„eply isoo small.");

131 
rc
 = 
	`zmq_msg_š™_d©a
(
outmsg
, 
outbuf
, 
Ën
, 
c¡r_ä“
, 
»p
);

132 
	`check
(
rc
 == 0, "Failedo init„eply data.");

134 
rc
 = 
	`mq£nd
(
sock
, 
outmsg
, 0);

135 
	`check
(
rc
 == 0, "Failedo deliver 0mq messageo„equestor.");

136 
	`ä“
(
outmsg
);

139 
”rÜ
:

140 
	`ä“
(
outmsg
);

142 
	}
}

151 
šlše
 
Šs_v®ue_t
 *
	$basic_»¥Ú£
(
b¡ršg
 
key
, b¡ršg 
v®ue
)

153 
Šs_v®ue_t
 *
»suÉs
 = 
	`Šs_Ãw_diù
();

154 
Šs_v®ue_t
 *
h—d”s
 = 
	`Šs_Ãw_li¡
();

155 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

156 
Šs_v®ue_t
 *
cŞs
 = 
	`Šs_Ãw_li¡
();

158 
	`Šs_add_to_li¡
(
h—d”s
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(
key
), 
	`bËngth
(key)));

159 
	`Šs_add_to_li¡
(
cŞs
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(
v®ue
), 
	`bËngth
(value)));

160 
	`Šs_add_to_li¡
(
rows
, 
cŞs
);

162 
	`bde¡roy
(
key
);

163 
	`bde¡roy
(
v®ue
);

165 
	`Šs_diù_£tc¡r
(
»suÉs
, "h—d”s", 
h—d”s
);

166 
	`Šs_diù_£tc¡r
(
»suÉs
, "rows", 
rows
);

168  
»suÉs
;

169 
	}
}

172 
šlše
 
Šs_v®ue_t
 *
	$g‘_¬g
(
hash_t
 *
¬gs
, cÚ¡ *
Çme
)

174 
b¡ršg
 
key
 = 
	`bäomc¡r
(
Çme
);

175 
hnode_t
 *
node
 = 
	`hash_lookup
(
¬gs
, 
key
);

176 
	`bde¡roy
(
key
);

178 
	`check
(
node
 !ğ
NULL
, "Missšg‡rgum’ˆ% š c®l.", 
Çme
);

180 
Šs_v®ue_t
 *
v®
 = 
	`hnode_g‘
(
node
);

181 
	`check
(
v®
 !ğ
NULL
, "Got‡‚ull for‡ dict in‡rguments.");

183  
v®
;

184 
”rÜ
:

185  
NULL
;

186 
	}
}

188 
Šs_v®ue_t
 *
	$sigÇl_£rv”_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

190 
rc
 = -1;

191 
Šs_v®ue_t
 *
»suÉ
 = 
NULL
;

193 if(
	`bi£qc¡r
(
Çme
, "stop")) {

194 
rc
 = 
	`¿i£
(
SIGINT
);

195 } if(
	`bi£qc¡r
(
Çme
, "reload")) {

196 
rc
 = 
	`¿i£
(
SIGHUP
);

197 } if(
	`bi£qc¡r
(
Çme
, "terminate")) {

198 
rc
 = 
	`¿i£
(
SIGTERM
);

200 
rc
 = -1;

203 
	`check_cÚŒŞ_”r
(
rc
 =ğ0, &
SIGNAL_FAILED_ERR
, "Signal failed.");

205 
»suÉ
 = 
	`basic_»¥Ú£
(
	`bäomc¡r
("msg"), bfromcstr("signal sento server"));

207 
”rÜ
:

208  
»suÉ
;

209 
	}
}

212 
Šs_v®ue_t
 *
	$v”siÚ_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

214  
	`basic_»¥Ú£
(
	`bäomc¡r
("v”siÚ"), bäomc¡r(
VERSION
));

215 
	}
}

217 
Šs_v®ue_t
 *
	$h–p_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

219 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

220 
Šs_v®ue_t
 *
h—d”s
 = 
	`Šs_Ãw_li¡
();

221 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

223 
	`Šs_add_to_li¡
(
h—d”s
, 
	`Šs_·r£_¡ršg
("Çme", 
	`¡¾’
("name")));

224 
	`Šs_add_to_li¡
(
h—d”s
, 
	`Šs_·r£_¡ršg
("h–p", 
	`¡¾’
("help")));

225 
	`Šs_diù_£tc¡r
(
»suÉ
, "h—d”s", 
h—d”s
);

227 
ÿÎback_li¡_t
 *
cb–
 = 
NULL
;

229 
cb–
 = 
CALLBACKS
; cb–->
ÿÎback
 !ğ
NULL
; cbel++) {

230 
Šs_v®ue_t
 *
cŞ
 = 
	`Šs_Ãw_li¡
();

231 
	`Šs_add_to_li¡
(
cŞ
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(&
cb–
->
Çme
), 
	`bËngth
(&cbel->name)));

232 
	`Šs_add_to_li¡
(
cŞ
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(&
cb–
->
h–p
), 
	`bËngth
(&cbel->help)));

233 
	`Šs_add_to_li¡
(
rows
, 
cŞ
);

236 
	`Šs_diù_£tc¡r
(
»suÉ
, "rows", 
rows
);

238  
»suÉ
;

239 
	}
}

241 
Šs_v®ue_t
 *
	$cÚŒŞ_¡İ_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

243 
CONTROL_RUNNING
 = 0;

245  
	`basic_»¥Ú£
(
	`bäomc¡r
("msg"), bfromcstr("stoppinghe control…ort"));

246 
	}
}

248 
Šs_v®ue_t
 *
	$kl_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

250 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

252 
Šs_v®ue_t
 *
¬g
 = 
	`g‘_¬g
(
¬gs
, "id");

253 
	`check_cÚŒŞ_”r
(
¬g
 !ğ
NULL
, &
INVALID_ARGUMENT_ERR
, "Missing‡rgument 'id'.");

254 
	`check_cÚŒŞ_”r
(
	`Šs_g‘_ty³
(
¬g
è=ğ
Šs_g_numb”
, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

256 
id
 = 
¬g
->
v®ue
.
numb”
;

257 
	`check_cÚŒŞ_”r
(
id
 >ğ0 && id < 
MAX_REGISTERED_FDS
, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

260 
fd
 = 
	`Regi¡”_fd_fÜ_id
(
id
);

261 
	`check_cÚŒŞ_”r
(
fd
 >ğ0, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

262 
	`check_cÚŒŞ_”r
(
	`Regi¡”_fd_exi¡s
(
fd
), &
NOT_CONNECTED_ERR
, "Socket‚ot connected.");

264 
	`Regi¡”_discÚÃù
(
fd
);

266 
	`Šs_v®ue_de¡roy
(
»suÉ
);

268  
	`basic_»¥Ú£
(
	`bäomc¡r
("status"), bfromcstr("OK"));

270 
”rÜ
:

271  
»suÉ
;

272 
	}
}

275 
Šs_v®ue_t
 *
	$¡©us_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

277 
Šs_v®ue_t
 *
v®
 = 
	`g‘_¬g
(
¬gs
, "what");

278 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

280 
	`check_cÚŒŞ_”r
(
v®
 !ğ
NULL
, &
INVALID_ARGUMENT_ERR
, "Missing‡rgument what.");

281 
	`check_cÚŒŞ_”r
(
v®
->
ty³
 =ğ
Šs_g_¡ršg
, &
INVALID_ARGUMENT_ERR
, "Argumentypeƒrror.");

282 
b¡ršg
 
wh©
 = 
v®
->
v®ue
.
¡ršg
;

284 if(
	`bi£qc¡r
(
wh©
, "tasks")) {

285 
	`Šs_v®ue_de¡roy
(
»suÉ
);

286  
	`skg‘šfo
();

287 } if(
	`bi£qc¡r
(
wh©
, "net")) {

288 
	`Šs_v®ue_de¡roy
(
»suÉ
);

289  
	`Regi¡”_šfo
();

291 
b¡ršg
 
”r
 = 
	`bäomc¡r
("Expected‡rgument what=['net'|'tasks'].");

292 
	`Šs_diù_£tc¡r
(
»suÉ
, "”rÜ", 
	`Šs_·r£_¡ršg
(
	`bd©a
(
”r
), 
	`bËngth
(err)));

293 
	`bde¡roy
(
”r
);

296 
”rÜ
:

297  
»suÉ
;

298 
	}
}

300 
gb¡ršg
 
	gINFO_HEADERS
 = 
bsStic
("92:4:port,9:bind_addr,4:uuid,6:chroot,10:access_log,9:error_log,8:pid_file,16:default_hostname,]");

302 
Šs_v®ue_t
 *
	$šfo_cb
(
b¡ršg
 
Çme
, 
hash_t
 *
¬gs
)

304 if(
	`bi£qc¡r
(
Çme
, "time")) {

305  
	`basic_»¥Ú£
(
	`bäomc¡r
("time"), 
	`bfÜm©
("%d", ()
	`time
(
NULL
)));

306 } if(
	`bi£qc¡r
(
Çme
, "uuid")) {

307  
	`basic_»¥Ú£
(
	`bäomc¡r
("uuid"), 
	`b¡rıy
(
SERVER
->
uuid
));

309 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

310 
Šs_v®ue_t
 *
cŞs
 = 
	`Šs_Ãw_li¡
();

311 
	`Šs_add_to_li¡
(
cŞs
, 
	`Šs_Ãw_š‹g”
(
SERVER
->
pÜt
));

312 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
bšd_addr
);

313 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
uuid
);

314 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
chroÙ
);

315 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
acûss_log
);

316 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
”rÜ_log
);

317 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
pid_fe
);

318 
	`Šs_li¡_add¡r
(
cŞs
, 
SERVER
->
deçuÉ_ho¡Çme
);

320 
	`Šs_add_to_li¡
(
rows
, 
cŞs
);

321  
	`Šs_¡ªd¬d_bË
(&
INFO_HEADERS
, 
rows
);

323 
	}
}

326 
ÿÎback_li¡_t
 
	gCALLBACKS
[] = {

327 {.
Çme
 = 
bsStic
("stop"),

328 .
	gh–p
 = 
bsStic
("¡İh£rv” (SIGINT)"), .
	gÿÎback
 = 
sigÇl_£rv”_cb
},

329 {.
	gÇme
 = 
bsStic
("reload"),

330 .
	gh–p
 = 
bsStic
("»lßdh£rv”"), .
	gÿÎback
 = 
sigÇl_£rv”_cb
},

331 {.
	gÇme
 = 
bsStic
("help"),

332 .
	gh–p
 = 
bsStic
("thi commªd"), .
	gÿÎback
 = 
h–p_cb
},

333 {.
	gÇme
 = 
bsStic
("control_stop"),

334 .
	gh–p
 = 
bsStic
("¡İ cÚŒŞ…Üt"), .
	gÿÎback
 = 
cÚŒŞ_¡İ_cb
},

335 {.
	gÇme
 = 
bsStic
("kill"),

336 .
	gh–p
 = 
bsStic
("kÈ¨cÚÃùiÚ"), .
	gÿÎback
 = 
kl_cb
},

337 {.
	gÇme
 = 
bsStic
("status"),

338 .
	gh–p
 = 
bsStic
("¡©us, wh©=['Ãt'|'sks']"), .
	gÿÎback
 = 
¡©us_cb
},

339 {.
	gÇme
 = 
bsStic
("terminate"),

340 .
	gh–p
 = 
bsStic
("‹rmš©th£rv” (SIGTERM)"), .
	gÿÎback
 = 
sigÇl_£rv”_cb
},

341 {.
	gÇme
 = 
bsStic
("time"),

342 .
	gh–p
 = 
bsStic
("th£rv”' time"), .
	gÿÎback
 = 
šfo_cb
},

343 {.
	gÇme
 = 
bsStic
("uuid"),

344 .
	gh–p
 = 
bsStic
("th£rv”' uuid"), .
	gÿÎback
 = 
šfo_cb
},

345 {.
	gÇme
 = 
bsStic
("info"),

346 .
	gh–p
 = 
bsStic
("šfÜm©iÚ‡bouˆthi £rv”"), .
	gÿÎback
 = 
šfo_cb
},

348 {.
	gÇme
 = 
bsStic
(""), .
	gh–p
 = bsStic(""), .
	gÿÎback
 = 
NULL
},

352 
Šs_v®ue_t
 *
	$CÚŒŞ_execu‹
(
Šs_v®ue_t
 *
»q
, 
ÿÎback_li¡_t
 *
ÿÎbacks
)

354 
Šs_v®ue_t
 *
»suÉ
 = 
NULL
;

355 
Šs_v®ue_t
 *
ÿÎ
 = 
NULL
;

356 
Šs_v®ue_t
 *
¬gs
 = 
NULL
;

357 
ÿÎback_li¡_t
 *
cb–
 = 
NULL
;

360 
	`check_cÚŒŞ_”r
(
»q
->
ty³
 =ğ
Šs_g_li¡
, &
INVALID_FORMAT_ERR
, "Invalid„equest format.");

362 
ÿÎ
 = 
	`d¬¿y_g‘
(
»q
->
v®ue
.
li¡
, 0);

363 
	`check_cÚŒŞ_”r
(
ÿÎ
 !ğ
NULL
, &
INVALID_DATA_ERR
, "Invalid first‡rgument.");

364 
	`check_cÚŒŞ_”r
(
ÿÎ
->
ty³
 =ğ
Šs_g_¡ršg
, &
INVALID_DATA_ERR
, "First‡rgument must be string.");

367 
¬gs
 = 
	`d¬¿y_g‘
(
»q
->
v®ue
.
li¡
, 1);

368 
	`check_cÚŒŞ_”r
(
¬gs
 !ğ
NULL
, &
INVALID_DATA_ERR
, "Invalid second‡rgument.");

369 
	`check_cÚŒŞ_”r
(
¬gs
 !ğ
ÿÎ
, &
INVALID_DATA_ERR
, "Must have morehan oneƒlemento„equest.");

370 
	`check_cÚŒŞ_”r
(
¬gs
->
ty³
 =ğ
Šs_g_diù
, &
INVALID_DATA_ERR
, "Second‡rgument must be dict.");

376 
cb–
 = 
ÿÎbacks
; cb–->
ÿÎback
 !ğ
NULL
; cbel++) {

377 if(
	`bi£q
(
ÿÎ
->
v®ue
.
¡ršg
, &
cb–
->
Çme
)) {

378 
»suÉ
 = 
cb–
->
	`ÿÎback
(
ÿÎ
->
v®ue
.
¡ršg
, 
¬gs
->v®ue.
diù
);

379 
	`check_cÚŒŞ_”r
(
»suÉ
 !ğ
NULL
, &
CALLBACK_RETURN_ERR
, "Callback„eturn invalid data (NULL).");

385 
	`check_cÚŒŞ_”r
(
»suÉ
 !ğ
NULL
, &
CALLBACK_NOT_FOUND_ERR
, "Callback‚ot found.");

387 
”rÜ
:

388  
»suÉ
;

389 
	}
}

391 
gb¡ršg
 
	gDEFAULT_CONTROL_SPEC
 = 
bsStic
("ipc://run/control");

393 
	$CÚŒŞ_sk
(*
v
)

395 
rc
 = 0;

396 
Šs_v®ue_t
 *
»q
 = 
NULL
;

397 
Šs_v®ue_t
 *
»p
 = 
NULL
;

398 
b¡ršg
 
¥ec
 = 
	`S‘tšg_g‘_¡r
("cÚŒŞ_pÜt", &
DEFAULT_CONTROL_SPEC
);

399 
	`skÇme
("control");

401 
	`log_šfo
("S‘tšg u°cÚŒŞ sock‘ iÀ© %s", 
	`bd©a
(
¥ec
));

403 
CONTROL_SOCKET
 = 
	`mqsock‘
(
ZMQ_REP
);

404 
	`check
(
CONTROL_SOCKET
 !ğ
NULL
, "Can't create contol socket.");

406 
rc
 = 
	`zmq_bšd
(
CONTROL_SOCKET
, 
	`bd©a
(
¥ec
));

407 
	`check
(
rc
 == 0, "Failedo bind control…orto„un/control.");

409 
CONTROL_RUNNING
) {

410 
	`sk¡©e
("waiting");

412 
»q
 = 
	`»ad_mes§ge
(
CONTROL_SOCKET
);

413 
	`check
(
»q
, "FaedØ»ad mes§ge: %s.", 
	`¡»¼Ü
(
”ºo
));

415 if(
»q
->
ty³
 =ğ
Šs_g_nuÎ
) {

416 
»p
 = 
	`Šs_·r£
(
	`bd©a
(&
INVALID_DATA_ERR
), 
	`bËngth
(&INVALID_DATA_ERR), 
NULL
);

418 
»p
 = 
	`CÚŒŞ_execu‹
(
»q
, 
CALLBACKS
);

421 
	`check
(
»p
 !ğ
NULL
, "Should‚ever get‡ NULL fromhe control…ortƒxecutor.");

423 
	`sk¡©e
("replying");

424 
rc
 = 
	`£nd_»¶y
(
CONTROL_SOCKET
, 
»p
);

425 
	`check
(
rc
 == 0, "Failedo send‡„eply.");

427 
	`Šs_v®ue_de¡roy
(
»q
);

428 
	`Šs_v®ue_de¡roy
(
»p
);

431 
rc
 = 
	`zmq_şo£
(
CONTROL_SOCKET
);

432 
	`check
(
rc
 == 0, "Failedo close control…ort socket.");

433 
CONTROL_SOCKET
 = 
NULL
;

434 
	`log_šfo
("Control…ortƒxiting.");

435 
	`skex™
(0);

437 
”rÜ
:

438 
	`log_šfo
("Control…ortƒxiting withƒrror.");

439 
	`zmq_şo£
(
CONTROL_SOCKET
);

440 
CONTROL_SOCKET
 = 
NULL
;

441 
	`skex™
(1);

442 
	}
}

445 
	$CÚŒŞ_pÜt_¡¬t
()

447 
	`skü—‹
(
CÚŒŞ_sk
, 
NULL
, 32 * 1024);

448 
	}
}

450 
	$CÚŒŞ_pÜt_¡İ
()

452 
CONTROL_RUNNING
 = 0;

453 
	}
}

	@tools/src/control.h

1 #iâdeà
_cÚŒŞ_h


2 
	#_cÚŒŞ_h


	)

4 
CÚŒŞ_pÜt_¡¬t
();

6 
CÚŒŞ_pÜt_¡İ
();

	@tools/src/dbg.c

35 
	~"dbg.h
"

37 
FILE
 *
	gLOG_FILE
 = 
NULL
;

39 
	$dbg_£t_log
(
FILE
 *
log_fe
)

41 
LOG_FILE
 = 
log_fe
;

42 
	}
}

45 
FILE
 *
	$dbg_g‘_log
()

47  
LOG_FILE
 !ğ
NULL
 ? LOG_FILE : 
¡d”r
;

48 
	}
}

	@tools/src/dbg.h

35 #iâdeà
__dbg_h__


36 
	#__dbg_h__


	)

38 
	~<¡dio.h
>

39 
	~<”ºo.h
>

40 
	~<¡ršg.h
>

42 
dbg_£t_log
(
FILE
 *
log_fe
);

43 
FILE
 *
dbg_g‘_log
();

45 #ifdeà
NDEBUG


46 
	#debug
(
M
, ...)

	)

48 
	#debug
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "DEBUG %s:%d: " M "\n", 
__FILE__
, 
__LINE__
, ##
__VA_ARGS__
)

	)

55 
	#check_debug
(
A
, 
M
, ...èif(!(A)è{ 
	`debug
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

57 
	#ş—n_”ºo
(è(
”ºo
 =ğ0 ? "NÚe" : 
	`¡»¼Ü
Ó¼no))

	)

59 #ifdeà
NO_LINENOS


61 
	#log_”r
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[ERROR] (”ºo: %sè" M "\n", 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

62 
	#log_w¬n
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[WARN] (”ºo: %sè" M "\n", 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

63 
	#log_šfo
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[INFO] " M "\n", ##
__VA_ARGS__
)

	)

65 
	#log_”r
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[ERROR] (%s:%d:ƒ¼no: %sè" M "\n", 
__FILE__
, 
__LINE__
, 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

66 
	#log_w¬n
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[WARN] (%s:%d:ƒ¼no: %sè" M "\n", 
__FILE__
, 
__LINE__
, 
	`ş—n_”ºo
(), ##
__VA_ARGS__
)

	)

67 
	#log_šfo
(
M
, ...è
	`årštf
(
	`dbg_g‘_log
(), "[INFO] (%s:%dè" M "\n", 
__FILE__
, 
__LINE__
, ##
__VA_ARGS__
)

	)

70 
	#check
(
A
, 
M
, ...èif(!(A)è{ 
	`log_”r
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

72 
	#£Áš–
(
M
, ...è{ 
	`log_”r
(M, ##
__VA_ARGS__
); 
”ºo
=0; 
”rÜ
; }

	)

74 
	#check_mem
(
A
è
	`check
((A), "OuˆoàmemÜy.")

	)

76 
	#TRACE
(
C
,
E
è
	`debug
("--> %s(%s:%dè%s:%d ", "" #C, 
	`S‹_ev’t_Çme
(E), E, 
__FUNCTION__
, 
__LINE__
)

	)

78 
	#”rÜ_»¥Ú£
(
F
, 
C
, 
M
, ...è{
	`Re¥Ú£_£nd_¡©us
(F, &
HTTP_
##C); 
	`£Áš–
(M, ##
__VA_ARGS__
);}

	)

80 
	#”rÜ_uÆess
(
T
, 
F
, 
C
, 
M
, ...èif(!(T)è
	`”rÜ_»¥Ú£
(F, C, M, ##
__VA_ARGS__
)

	)

	@tools/src/dir.c

35 
	#_FILE_OFFSET_BITS
 64

	)

36 
	~<dœ.h
>

37 
	~<ÿche.h
>

38 
	~<fú.h
>

39 
	~<dbg.h
>

40 
	~<sk/sk.h
>

41 
	~<¡ršg.h
>

42 
	~<·‰”n.h
>

43 
	~<as£¹.h
>

44 
	~<mime.h
>

45 
	~<»¥Ú£.h
>

46 
	~"v”siÚ.h
"

47 
	~"£‰šg.h
"

49 
	gMAX_DIR_PATH
 = 0;

50 
	gMAX_SEND_BUFFER
 = 0;

52 
gb¡ršg
 
	gETAG_PATTERN
 = 
bsStic
("[a-e0-9]+-[a-e0-9]+");

54 cÚ¡ *
	gRESPONSE_FORMAT
 = "HTTP/1.1 200 OK\r\n"

60 "S”v”: " 
VERSION


63 cÚ¡ *
	gDIR_REDIRECT_FORMAT
 = "HTTP/1.1 301 Moved Permanently\r\n"

66 "S”v”: " 
VERSION


70 cÚ¡ *
	gRFC_822_TIME
 = "%a, %d %b %Y %H:%M:%S GMT";

72 
	$f”ecÜd_ÿche_lookup
(*
d©a
, *
key
) {

73 
b¡ršg
 
»que¡_·th
 = (b¡ršgè
key
;

74 
FeRecÜd
 *
ä
 = (FeRecÜd *è
d©a
;

76  !
	`b¡rcmp
(
ä
->
»que¡_·th
,„equest_path);

77 
	}
}

79 
	$f”ecÜd_ÿche_eviù
(*
d©a
) {

80 
	`FeRecÜd_»Ëa£
((
FeRecÜd
 *è
d©a
);

81 
	}
}

84 
FeRecÜd
 *
	$Dœ_fšd_fe
(
b¡ršg
 
·th
, b¡ršg 
deçuÉ_ty³
)

86 
FeRecÜd
 *
ä
 = 
	`ÿÎoc
((FileRecord), 1);

87 cÚ¡ *
p
 = 
	`bd©a
(
·th
);

89 
	`check_mem
(
ä
);

92 
ä
->
u£rs
 = 1;

94 
rc
 = 
	`¡©
(
p
, &
ä
->
sb
);

95 
	`check
(
rc
 =ğ0, "F¡© faed: %s", 
	`bd©a
(
·th
));

97 if(
	`S_ISDIR
(
ä
->
sb
.
¡_mode
)) {

98 
ä
->
fuÎ_·th
 = 
·th
;

99 
ä
->
is_dœ
 = 1;

100  
ä
;

103 
ä
->
fd
 = 
	`İ’
(
p
, 
O_RDONLY
);

104 
	`check
(
ä
->
fd
 >ğ0, "FaedØİ’ fbuˆ¡© wÜked: %s", 
	`bd©a
(
·th
));

106 
ä
->
fe_size
 = 
	`l£ek
(ä->
fd
, 0L, 
SEEK_END
);

107 
	`l£ek
(
ä
->
fd
, 0L, 
SEEK_SET
);

109 
ä
->
lßded
 = 
	`time
(
NULL
);

111 
ä
->
Ï¡_mod
 = 
	`bSŒfTime
(
RFC_822_TIME
, 
	`gmtime
(&ä->
sb
.
¡_mtime
));

112 
	`check
(
ä
->
Ï¡_mod
, "Failedo format†ast modifiedime.");

115 
ä
->
cÚ‹Á_ty³
 = 
	`MIME_m©ch_ext
(
·th
, 
deçuÉ_ty³
);

116 
	`check
(
ä
->
cÚ‹Á_ty³
, "Should‡lways get‡ contentype back.");

119 
ä
->
fuÎ_·th
 = 
·th
;

121 
time_t
 
now
 = 
	`time
(
NULL
);

123 
ä
->
d©e
 = 
	`bSŒfTime
(
RFC_822_TIME
, 
	`gmtime
(&
now
));

125 
ä
->
‘ag
 = 
	`bfÜm©
("%x-%x", fr->
sb
.
¡_mtime
, fr->
fe_size
);

127 
ä
->
h—d”
 = 
	`bfÜm©
(
RESPONSE_FORMAT
,

128 
	`bd©a
(
ä
->
d©e
),

129 
	`bd©a
(
ä
->
cÚ‹Á_ty³
),

130 
ä
->
fe_size
,

131 
	`bd©a
(
ä
->
Ï¡_mod
),

132 
	`bd©a
(
ä
->
‘ag
));

134 
	`check
(
ä
->
h—d”
 !ğ
NULL
, "Failedo create„esponse header.");

136  
ä
;

138 
”rÜ
:

139 
	`FeRecÜd_de¡roy
(
ä
);

140  
NULL
;

141 
	}
}

143 
šlše
 
	$Dœ_£nd_h—d”
(
FeRecÜd
 *
fe
, 
CÚÃùiÚ
 *
cÚn
)

145  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
fe
->
h—d”
), 
	`bËngth
(file->header));

146 
	}
}

148 
	$Dœ_¡»am_fe
(
FeRecÜd
 *
fe
, 
CÚÃùiÚ
 *
cÚn
)

150 
£Á
 = 0;

152 
rc
 = 
	`Dœ_£nd_h—d”
(
fe
, 
cÚn
);

153 
	`check_debug
(
rc
, "Failedo write headero socket.");

155 
£Á
 = 
	`IOBuf_¡»am_fe
(
cÚn
->
iob
, 
fe
->
fd
, fe->
fe_size
);

157  
fe
->
fe_size
;

159 
”rÜ
:

161 
	}
}

164 
Dœ
 *
	$Dœ_ü—‹
(
b¡ršg
 
ba£
, b¡ršg 
šdex_fe
, b¡ršg 
deçuÉ_ùy³
, 
ÿche_‰l
)

166 
Dœ
 *
dœ
 = 
	`ÿÎoc
((Dir), 1);

167 
	`check_mem
(
dœ
);

169 
dœ
->
ruÂšg
 = 1;

171 if(!
MAX_SEND_BUFFER
 || !
MAX_DIR_PATH
) {

172 
MAX_SEND_BUFFER
 = 
	`S‘tšg_g‘_št
("limits.dir_send_buffer", 16 * 1024);

173 
MAX_DIR_PATH
 = 
	`S‘tšg_g‘_št
("limits.dir_max_path", 256);

174 
	`log_šfo
("MAX†imits.dir_send_buffer=%d,†imits.dir_max_path=%d",

175 
MAX_SEND_BUFFER
, 
MAX_DIR_PATH
);

178 
dœ
->
ba£
 = 
	`b¡rıy
(base);

179 
	`check
(
	`bËngth
(
dœ
->
ba£
è< 
MAX_DIR_PATH
, "Base directory isoo†ong, must be†esshan %d", MAX_DIR_PATH);

180 
	`check
(
	`bch¬
(
dœ
->
ba£
, 0è!ğ'/', "DÚ'ˆ¡¬ˆthba£ w™h / iÀ%s,h© wÈç wh’‚Ù iÀchroÙ.", 
	`bd©a
(base));

181 
	`check
(
	`bch¬
(
dœ
->
ba£
, 
	`bËngth
(dœ->ba£è- 1è=ğ'/', "End dœeùÜy ba£ w™h / iÀ% Ü iˆwÚ'ˆwÜk„ight.", 
	`bd©a
(base));

183 
dœ
->
šdex_fe
 = 
	`b¡rıy
(index_file);

184 
dœ
->
deçuÉ_ùy³
 = 
	`b¡rıy
(default_ctype);

186 
dœ
->
ä_ÿche
 = 
	`Cache_ü—‹
(
FR_CACHE_SIZE
, 
f”ecÜd_ÿche_lookup
,

187 
f”ecÜd_ÿche_eviù
);

188 
	`check
(
dœ
->
ä_ÿche
, "Failedo create FileRecord cache");

190 
	`check
(
ÿche_‰l
 >= 0, "Invalid cachetl, must be‡…ositive integer");

191 
dœ
->
ÿche_‰l
 = cache_ttl;

193  
dœ
;

195 
”rÜ
:

196 if(
dœ
)

197 
	`ä“
(
dœ
);

199  
NULL
;

200 
	}
}

204 
	$Dœ_de¡roy
(
Dœ
 *
dœ
)

206 if(
dœ
) {

207 
	`bde¡roy
(
dœ
->
ba£
);

208 
	`bde¡roy
(
dœ
->
šdex_fe
);

209 
	`bde¡roy
(
dœ
->
nÜm®ized_ba£
);

210 
	`bde¡roy
(
dœ
->
deçuÉ_ùy³
);

211 if(
dœ
->
ä_ÿche
è
	`Cache_de¡roy
(dir->fr_cache);

212 
	`ä“
(
dœ
);

214 
	}
}

216 
	$FeRecÜd_»Ëa£
(
FeRecÜd
 *
fe
)

218 if(
fe
) {

219 
fe
->
u£rs
--;

220 
	`check
(
fe
->
u£rs
 >= 0, "User count on file„ecord somehow fell below 0");

221 if(
fe
->
u£rs
 <ğ0è
	`FeRecÜd_de¡roy
(file);

224 
”rÜ
:

226 
	}
}

228 
	$FeRecÜd_de¡roy
(
FeRecÜd
 *
fe
)

230 if(
fe
) {

231 if(!
fe
->
is_dœ
) {

232 
	`fdşo£
(
fe
->
fd
);

233 
	`bde¡roy
(
fe
->
d©e
);

234 
	`bde¡roy
(
fe
->
Ï¡_mod
);

235 
	`bde¡roy
(
fe
->
h—d”
);

236 
	`bde¡roy
(
fe
->
‘ag
);

238 
	`bde¡roy
(
fe
->
fuÎ_·th
);

240 
	`ä“
(
fe
);

242 
	}
}

245 
šlše
 
	$nÜm®ize_·th
(
b¡ršg
 
rg‘
)

247 
	`b®locmš
(
rg‘
, 
PATH_MAX
);

248 *
·th_buf
 = 
NULL
;

251 if(
·th_buf
 =ğ
NULL
) {

252 
·th_buf
 = 
	`ÿÎoc
(
PATH_MAX
+1, 1);

253 
	`check_mem
(
·th_buf
);

256 *
nÜm®ized
 = 
	`»®·th
((cÚ¡ *)(
	`bd©a
(
rg‘
)), 
·th_buf
);

257 
	`check_debug
(
nÜm®ized
, "FaedØnÜm®iz·th: %s", 
	`bd©a
(
rg‘
));

259 
	`bassignc¡r
(
rg‘
, 
nÜm®ized
);

263 
”rÜ
:

265 
	}
}

267 
šlše
 
	$Dœ_Ïzy_nÜm®ize_ba£
(
Dœ
 *
dœ
)

269 if(
dœ
->
nÜm®ized_ba£
 =ğ
NULL
) {

270 
dœ
->
nÜm®ized_ba£
 = 
	`b¡rıy
(dœ->
ba£
);

271 
	`check
(
	`nÜm®ize_·th
(
dœ
->
nÜm®ized_ba£
) == 0,

272 "FaedØnÜm®izba£…©h: %s", 
	`bd©a
(
dœ
->
nÜm®ized_ba£
));

274 
	`debug
("Lazy‚Üm®ized ba£…©h % štØ%s", 
	`bd©a
(
dœ
->
ba£
), bd©a(dœ->
nÜm®ized_ba£
));

278 
”rÜ
:

280 
	}
}

282 
FeRecÜd
 *
	$FeRecÜd_ÿche_check
(
Dœ
 *
dœ
, 
b¡ršg
 
·th
)

284 
FeRecÜd
 *
fe
 = 
	`Cache_lookup
(
dœ
->
ä_ÿche
, 
·th
);

286 if(
fe
) {

287 
time_t
 
now
 = 
	`time
(
NULL
);

288 cÚ¡ *
p
 = 
	`bd©a
(
fe
->
fuÎ_·th
);

289 
¡©
 
sb
;

291 if(
	`difáime
(
now
, 
fe
->
lßded
è> 
dœ
->
ÿche_‰l
) {

292 
rc¡©
 = 
	`¡©
(
p
, &
sb
);

294 if(
rc¡©
 !ğ0 || 
fe
->
sb
.
¡_mtime
 !ğsb.¡_mtim|| fe->sb.
¡_size
 != sb.st_size) {

295 
	`Cache_eviù_objeù
(
dœ
->
ä_ÿche
, 
fe
);

296 
fe
 = 
NULL
;

298 
fe
->
lßded
 = 
now
;

303  
fe
;

304 
	}
}

307 
FeRecÜd
 *
	$Dœ_»sŞve_fe
(
Dœ
 *
dœ
, 
b¡ršg
 
´efix
, b¡ršg 
·th
)

309 
FeRecÜd
 *
fe
 = 
NULL
;

310 
b¡ršg
 
rg‘
 = 
NULL
;

312 
	`check
(
	`Dœ_Ïzy_nÜm®ize_ba£
(
dœ
) == 0, "Failedo‚ormalize base…ath when„equesting %s",

313 
	`bd©a
(
·th
));

315 
fe
 = 
	`FeRecÜd_ÿche_check
(
dœ
, 
·th
);

317 if(
fe
) {

319 
fe
->
u£rs
++;

320  
fe
;

323 
	`check
(
	`bch¬
(
´efix
, 0è=ğ'/', "Rou‹ '%s'…oštšgØdœeùÜy mu¡ hav´efix w™h†—dšg '/'", 
	`bd©a
(prefix));

324 
	`check
(
	`bËngth
(
´efix
è< 
MAX_DIR_PATH
, "Prefix isoo†ong, must be†esshan %d", MAX_DIR_PATH);

326 
	`debug
("Buildingarget from base: %s…refix: %s…ath: %s index_file: %s",

327 
	`bd©a
(
dœ
->
nÜm®ized_ba£
),

328 
	`bd©a
(
´efix
),

329 
	`bd©a
(
·th
),

330 
	`bd©a
(
dœ
->
šdex_fe
));

332 if(
	`bch¬
(
·th
, 
	`bËngth
(path) - 1) == '/') {

334 
rg‘
 = 
	`bfÜm©
("%s/%s%s",

335 
	`bd©a
(
dœ
->
nÜm®ized_ba£
),

336 
	`bd©aofs
(
·th
, 
	`bËngth
(
´efix
)),

337 
	`bd©a
(
dœ
->
šdex_fe
));

338 } if(
	`bi£q
(
´efix
, 
·th
)) {

339 
rg‘
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
dœ
->
nÜm®ized_ba£
), bd©a(
·th
));

342 
rg‘
 = 
	`bfÜm©
("%s/%s", 
	`bd©a
(
dœ
->
nÜm®ized_ba£
), 
	`bd©aofs
(
·th
, 
	`bËngth
(
´efix
)));

345 
	`check_mem
(
rg‘
);

347 
	`check_debug
(
	`nÜm®ize_·th
(
rg‘
) == 0,

348 "FaedØnÜm®izrg‘…©h: %s", 
	`bd©a
(
rg‘
));

350 
	`check_debug
(
	`b¡ºcmp
(
rg‘
, 
dœ
->
nÜm®ized_ba£
, 
	`bËngth
(dir->normalized_base)) == 0,

352 
	`bd©a
(
rg‘
), bd©a(
dœ
->
ba£
));

355 
fe
 = 
	`Dœ_fšd_fe
(
rg‘
, 
dœ
->
deçuÉ_ùy³
);

356 
	`check_debug
(
fe
, "E¼Ü o³nšg fe: %s", 
	`bd©a
(
rg‘
));

359 
fe
->
u£rs
++;

360 
fe
->
»que¡_·th
 = 
	`b¡rıy
(
·th
);

361 
	`Cache_add
(
dœ
->
ä_ÿche
, 
fe
);

363  
fe
;

365 
”rÜ
:

366 
	`bde¡roy
(
rg‘
);

367 
	`FeRecÜd_»Ëa£
(
fe
);

368  
NULL
;

369 
	}
}

372 
šlše
 
b¡ršg
 
	$Dœ_if_modif›d_sšû
(
Reque¡
 *
»q
, 
FeRecÜd
 *
fe
, 
if_modif›d_sšû
)

374 if(
if_modif›d_sšû
 <ğ()
	`time
(
NULL
è&& 
fe
->
sb
.
¡_mtime
 <= if_modified_since) {

375 
»q
->
¡©us_code
 = 304;

376  &
HTTP_304
;

378  
NULL
;

381 
»q
->
¡©us_code
 = 500;

382  &
HTTP_500
;

383 
	}
}

385 
šlše
 
b¡ršg
 
	$Dœ_nÚe_m©ch
(
Reque¡
 *
»q
, 
FeRecÜd
 *
fe
, 
if_modif›d_sšû
, 
b¡ršg
 
if_nÚe_m©ch
)

387 if(
	`bi£qc¡r
(
if_nÚe_m©ch
, "*"è|| 
	`bi£q
(if_nÚe_m©ch, 
fe
->
‘ag
)) {

388 
»q
->
¡©us_code
 = 304;

389  &
HTTP_304
;

391 if(
if_modif›d_sšû
) {

392  
	`Dœ_if_modif›d_sšû
(
»q
, 
fe
, 
if_modif›d_sšû
);

394  
NULL
;

398 
»q
->
¡©us_code
 = 500;

399  &
HTTP_500
;

400 
	}
}

402 
šlše
 
b¡ršg
 
	$Dœ_ÿlcuÏ‹_»¥Ú£
(
Reque¡
 *
»q
, 
FeRecÜd
 *
fe
)

404 
if_unmodif›d_sšû
 = 0;

405 
if_modif›d_sšû
 = 0;

406 
b¡ršg
 
if_m©ch
 = 
NULL
;

407 
b¡ršg
 
if_nÚe_m©ch
 = 
NULL
;

409 if(
fe
) {

410 if(
fe
->
is_dœ
)

411  
	`bfÜm©
(
DIR_REDIRECT_FORMAT
, 
	`bd©a
(
»q
->
ho¡
),

412 
	`bd©a
(
»q
->
uri
));

414 
if_m©ch
 = 
	`Reque¡_g‘
(
»q
, &
HTTP_IF_MATCH
);

416 if(!
if_m©ch
 || 
	`bi£qc¡r
(if_m©ch, "*"è|| 
	`b¡ršg_m©ch
(if_m©ch, &
ETAG_PATTERN
)) {

417 
if_nÚe_m©ch
 = 
	`Reque¡_g‘
(
»q
, &
HTTP_IF_NONE_MATCH
);

418 
if_unmodif›d_sšû
 = 
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_UNMODIFIED_SINCE
, 
RFC_822_TIME
);

419 
if_modif›d_sšû
 = 
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_MODIFIED_SINCE
, 
RFC_822_TIME
);

421 
	`debug
("TESTING WITH: if_match: %s, if_none_match: %s, if_unmodified_since: %d, if_modified_since: %d",

422 
	`bd©a
(
if_m©ch
), bd©a(
if_nÚe_m©ch
), 
if_unmodif›d_sšû
, 
if_modif›d_sšû
);

424 if(
if_unmodif›d_sšû
) {

425 if(
fe
->
sb
.
¡_mtime
 > 
if_unmodif›d_sšû
) {

426 
»q
->
¡©us_code
 = 412;

427  &
HTTP_412
;

428 } if(
if_nÚe_m©ch
) {

429  
	`Dœ_nÚe_m©ch
(
»q
, 
fe
, 
if_modif›d_sšû
, 
if_nÚe_m©ch
);

430 } if(
if_modif›d_sšû
) {

431  
	`Dœ_if_modif›d_sšû
(
»q
, 
fe
, 
if_modif›d_sšû
);

433 } if(
if_nÚe_m©ch
) {

434  
	`Dœ_nÚe_m©ch
(
»q
, 
fe
, 
if_modif›d_sšû
, 
if_nÚe_m©ch
);

435 } if(
if_modif›d_sšû
) {

436  
	`Dœ_if_modif›d_sšû
(
»q
, 
fe
, 
if_modif›d_sšû
);

439 
»q
->
¡©us_code
 = 200;

440  
NULL
;

443 
»q
->
¡©us_code
 = 412;

444  &
HTTP_412
;

447 
»q
->
¡©us_code
 = 404;

448  &
HTTP_404
;

451 
»q
->
¡©us_code
 = 500;

452  &
HTTP_500
;

453 
	}
}

455 
	$Dœ_£rve_fe
(
Dœ
 *
dœ
, 
Reque¡
 *
»q
, 
CÚÃùiÚ
 *
cÚn
)

457 
FeRecÜd
 *
fe
 = 
NULL
;

458 
b¡ršg
 
»¥
 = 
NULL
;

459 
b¡ršg
 
·th
 = 
	`Reque¡_·th
(
»q
);

460 
b¡ršg
 
´efix
 = 
»q
->prefix;

461 
	`check
(
´efix
 !ğ
NULL
, "Request without‡…refix hit.");

462 
	`check
(
dœ
->
ruÂšg
, "Directory is‚ot„unning‡nymore.");

464 
rc
 = 0;

465 
is_g‘
 = 
	`bi£q
(
»q
->
»que¡_m‘hod
, &
HTTP_GET
);

466 
is_h—d
 = 
is_g‘
 ? 0 : 
	`bi£q
(
»q
->
»que¡_m‘hod
, &
HTTP_HEAD
);

468 
	`check
(
·th
, "Request had‚ot…ath. That's weird.");

469 
»q
->
»¥Ú£_size
 = 0;

471 if(!(
is_g‘
 || 
is_h—d
)) {

472 
»q
->
¡©us_code
 = 405;

473 
rc
 = 
	`Re¥Ú£_£nd_¡©us
(
cÚn
, &
HTTP_405
);

474 
	`check_debug
(
rc
 =ğ
	`bËngth
(&
HTTP_405
), "Failedo send 405o client.");

477 
fe
 = 
	`Dœ_»sŞve_fe
(
dœ
, 
´efix
, 
·th
);

478 
»¥
 = 
	`Dœ_ÿlcuÏ‹_»¥Ú£
(
»q
, 
fe
);

480 if(
»¥
) {

481 
rc
 = 
	`Re¥Ú£_£nd_¡©us
(
cÚn
, 
»¥
);

482 
	`check_debug
(
rc
 =ğ
	`bËngth
(
»¥
), "Failedo sendƒrror„esponse on file serving.");

483 } if(
is_g‘
) {

484 
rc
 = 
	`Dœ_¡»am_fe
(
fe
, 
cÚn
);

485 
»q
->
»¥Ú£_size
 = 
rc
;

486 
	`check_debug
(
rc
 =ğ
fe
->
fe_size
, "Didn'ˆ£nd‡Î oàthfe, s’ˆ%Îd oà%s.",„c, 
	`bd©a
(
·th
));

487 } if(
is_h—d
) {

488 
rc
 = 
	`Dœ_£nd_h—d”
(
fe
, 
cÚn
);

489 
	`check_debug
(
rc
, "Failedo write headero socket.");

491 
	`£Áš–
("Howhe hell did you geto here. Tell Zed.");

494 
	`FeRecÜd_»Ëa£
(
fe
);

498 
	`£Áš–
("Invalid code branch, Tell Zed you have magic.");

499 
”rÜ
:

500 
	`FeRecÜd_»Ëa£
(
fe
);

502 
	}
}

	@tools/src/dir.h

35 #iâdeà
_dœ_h


36 
	#_dœ_h


	)

38 #iâdeà
_FILE_OFFSET_BITS


39 
	#_FILE_OFFSET_BITS
 64

	)

42 
	~<¡dlib.h
>

44 
	~<b¡ršg.h
>

45 
	~<ÿche.h
>

46 
	~<sys/ty³s.h
>

47 
	~<sys/¡©.h
>

48 
	~<uni¡d.h
>

49 
	~<»que¡.h
>

50 
	~<cÚÃùiÚ.h
>

51 
	~"v”siÚ.h
"

53 
MAX_SEND_BUFFER
;

54 
MAX_DIR_PATH
;

56 cÚ¡ *
RESPONSE_FORMAT
;

58 
	sFeRecÜd
 {

59 
	mis_dœ
;

60 
	mfd
;

61 
	mu£rs
;

62 
time_t
 
	mlßded
;

63 
b¡ršg
 
	md©e
;

64 
b¡ršg
 
	mÏ¡_mod
;

65 
b¡ršg
 
	mcÚ‹Á_ty³
;

66 
b¡ršg
 
	mh—d”
;

67 
b¡ršg
 
	m»que¡_·th
;

68 
b¡ršg
 
	mfuÎ_·th
;

69 
b¡ršg
 
	m‘ag
;

70 
¡©
 
	msb
;

71 
off_t
 
	mfe_size
;

72 } 
	tFeRecÜd
;

74 
	sDœ
 {

75 
	mruÂšg
;

76 
Cache
 *
	mä_ÿche
;

77 
b¡ršg
 
	mba£
;

78 
b¡ršg
 
	mnÜm®ized_ba£
;

79 
b¡ršg
 
	mšdex_fe
;

80 
b¡ršg
 
	mdeçuÉ_ùy³
;

81 
	mÿche_‰l
;

82 } 
	tDœ
;

84 
Dœ
 *
Dœ_ü—‹
(
b¡ršg
 
ba£
, b¡ršg 
šdex_fe
,

85 
b¡ršg
 
deçuÉ_ùy³
, 
ÿche_‰l
);

87 
Dœ_de¡roy
(
Dœ
 *
dœ
);

89 
FeRecÜd
 *
Dœ_fšd_fe
(
b¡ršg
 
·th
, b¡ršg 
deçuÉ_ty³
);

91 
Dœ_¡»am_fe
(
FeRecÜd
 *
fe
, 
CÚÃùiÚ
 *
cÚn
);

93 
Dœ_£rve_fe
(
Dœ
 *
dœ
, 
Reque¡
 *
»q
, 
CÚÃùiÚ
 *
cÚn
);

95 
FeRecÜd
 *
Dœ_»sŞve_fe
(
Dœ
 *
dœ
, 
b¡ršg
 
´efix
, b¡ršg 
·th
);

97 
FeRecÜd_»Ëa£
(
FeRecÜd
 *
fe
);

98 
FeRecÜd_de¡roy
(
FeRecÜd
 *
fe
);

100 
	#FR_CACHE_SIZE
 32

	)

	@tools/src/events.h

35 #iâdeà
_ev’ts_h


36 
	#_ev’ts_h


	)

38 
	#EVENT_MIN
 100

	)

40 
	eS‹Ev’t
 {

41 
	mCLOSE
=100,

42 
	mCONNECT
=101,

43 
	mDIRECTORY
=102,

44 
	mFAILED
=103,

45 
	mHANDLER
=104,

46 
	mHTTP_REQ
=105,

47 
	mMSG_REQ
=106,

48 
	mOPEN
=107,

49 
	mPROXY
=108,

50 
	mREMOTE_CLOSE
=109,

51 
	mREQ_RECV
=110,

52 
	mREQ_SENT
=111,

53 
	mRESP_SENT
=112,

54 
	mSOCKET_REQ
=113,

55 
	mTIMEOUT
=114,

56 
	mEVENT_END
=115

57 } 
	tS‹Ev’t
 ;

	@tools/src/filter.c

35 
	~"f‹r.h
"

36 
	~"adt/d¬¿y.h
"

37 
	~"mem/h®loc.h
"

38 
	~<dlfú.h
>

42 
d¬¿y_t
 *
	gREGISTERED_FILTERS
 = 
NULL
;

43 
	gFILTERS_ACTIVATED
 = 0;

45 
	$F‹r_š™
()

47 
REGISTERED_FILTERS
 = 
	`d¬¿y_ü—‹
((
d¬¿y_t
 *), 
EVENT_END
 - 
EVENT_MIN
);

48 
	`check_mem
(
REGISTERED_FILTERS
);

51 
”rÜ
:

53 
	}
}

58 
	$F‹r_de¡roy
()

60 
	`d¬¿y_de¡roy
(
REGISTERED_FILTERS
);

61 
REGISTERED_FILTERS
 = 
NULL
;

62 
	}
}

64 
šlše
 
d¬¿y_t
 *
	$F‹r_lookup
(
S‹Ev’t
 
Ãxt
)

66  
	`d¬¿y_g‘
(
REGISTERED_FILTERS
, 
Ãxt
 - 
EVENT_MIN
);

67 
	}
}

69 
šlše
 
d¬¿y_t
 *
	$F‹r_lookup_ü—‹
(
S‹Ev’t
 
Ãxt
)

71 
d¬¿y_t
 *
fts
 = 
	`F‹r_lookup
(
Ãxt
);

73 if(
fts
 =ğ
NULL
) {

75 
fts
 = 
	`d¬¿y_ü—‹
((
F‹r
), 10);

76 
	`check_mem
(
fts
);

77 
	`d¬¿y_£t
(
REGISTERED_FILTERS
, 
Ãxt
 - 
EVENT_MIN
, 
fts
);

80  
fts
;

81 
”rÜ
:

82  
NULL
;

83 
	}
}

86 
	$F‹r_run
(
S‹Ev’t
 
Ãxt
, 
CÚÃùiÚ
 *
cÚn
)

88 
i
 = 0;

89 
S‹Ev’t
 
»s
 = 
Ãxt
;

90 
	`check
(
REGISTERED_FILTERS
 !ğ
NULL
, "No filters†oaded yet, don't callhis.");

92 
d¬¿y_t
 *
f‹rs
 = 
	`F‹r_lookup
(
Ãxt
);

94 if(
f‹rs
 !ğ
NULL
) {

95 
i
 = 0; i < 
	`d¬¿y_’d
(
f‹rs
è&& 
»s
 =ğ
Ãxt
; i++) {

96 
F‹r
 *
f‹r
 = 
	`d¬¿y_g‘
(
f‹rs
, 
i
);

97 
	`check
(
f‹r
 !ğ
NULL
, "Expectedo get‡ filter„ecord but got NULL.");

99 
»s
 = 
f‹r
->
	`cb
(
Ãxt
, 
cÚn
);

100 
	`check
(
»s
 >ğ
CLOSE
 &&„e < 
EVENT_END
,

101 "F‹¸% »tuºed inv®idƒv’t: %d", 
	`bd©a
(
f‹r
->
lßd_·th
), 
»s
);

105  
»s
;

107 
”rÜ
:

109 
	}
}

111 
	$F‹r_add
(
S‹Ev’t
 
¡©e
, 
f‹r_cb
 
cb
, 
b¡ršg
 
lßd_·th
)

113 
d¬¿y_t
 *
f‹rs
 = 
	`F‹r_lookup_ü—‹
(
¡©e
);

114 
	`check
(
f‹rs
 !ğ
NULL
, "Invalid filter state: %d given for filter %s",

115 
¡©e
, 
	`bd©a
(
lßd_·th
));

117 
F‹r
 *
f‹r
 = 
	`h_ÿÎoc
((Filter), 1);

118 
	`check_mem
(
f‹r
);

120 
	`h©ch
(
f‹rs
->
cÚ‹Ás
, 
f‹r
);

122 
f‹r
->
¡©e
 = state;

123 
f‹r
->
cb
 = cb;

124 
f‹r
->
lßd_·th
 = 
	`b¡rıy
(load_path);

126 
	`d¬¿y_push
(
f‹rs
, 
f‹r
);

129 
”rÜ
:

131 
	}
}

134 
	$F‹r_lßd
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
)

136 
i
 = 0;

138 if(
REGISTERED_FILTERS
 =ğ
NULL
) {

139 
	`check
(
	`F‹r_š™
() == 0, "Failedo initialize filter storage.");

140 
FILTERS_ACTIVATED
 = 1;

144 *
lib
 = 
	`dlİ’
(
	`bd©a
(
lßd_·th
), 
RTLD_LAZY
 | 
RTLD_LOCAL
);

145 
	`check
(
lib
 !ğ
NULL
, "FaedØlßd f‹¸%s: %s.", 
	`bd©a
(
lßd_·th
), 
	`dË¼Ü
());

148 
f‹r_š™_cb
 
š™
 = 
	`dlsym
(
lib
, "filter_init");

149 
	`check
(
š™
 !ğ
NULL
, "F‹¸% dÛ¢'ˆhavª in™ funùiÚ.", 
	`bd©a
(
lßd_·th
));

151 
n¡©es
 = 0;

152 
S‹Ev’t
 *
¡©es
 = 
	`š™
(
¤v
, 
lßd_·th
, &
n¡©es
);

153 
	`check
(
¡©es
 !ğ
NULL
, "In™ fÜ % »tuº NULL fau».", 
	`bd©a
(
lßd_·th
));

154 
	`check
(
n¡©es
 > 0, "In™ fÜ % »tuº <ğ0 s‹s,‚ÙhšgØdo.", 
	`bd©a
(
lßd_·th
));

156 
f‹r_cb
 
cb
 = 
	`dlsym
(
lib
, "filter_transition");

157 
	`check
(
cb
 !ğ
NULL
, "NØF‹r_Œªs™iÚ defšed iÀ%s, fa.", 
	`bd©a
(
lßd_·th
));

160 
i
 = 0; i < 
n¡©es
; i++) {

161 
S‹Ev’t
 
¡©e
 = 
¡©es
[
i
];

162 
	`check
(
¡©e
 >ğ
CLOSE
 && s‹ < 
EVENT_END
,

163 "Inv®id s‹„‘uº by % F‹r_š™: %d", 
	`bd©a
(
lßd_·th
), 
¡©e
);

166 
	`check
(
	`F‹r_add
(
¡©e
, 
cb
, 
lßd_·th
) == 0, "Failedo‡dd filter:state %s:%d",

167 
	`bd©a
(
lßd_·th
), 
¡©e
);

171 
”rÜ
:

173 
	}
}

	@tools/src/filter.h

1 #iâdeà
_f‹r_h


2 
	#_f‹r_h


	)

4 
	~"cÚÃùiÚ.h
"

5 
	~"b¡ršg.h
"

6 
	~"ev’ts.h
"

8 
FILTERS_ACTIVATED
;

10 
	$S‹Ev’t
 (*
	tf‹r_cb
)(
	tÃxt
, 
	tCÚÃùiÚ
 *
	tcÚn
);

11 
S‹Ev’t
* (*
	tf‹r_š™_cb
)(
	tS”v”
 *
	t¤v
, 
	tb¡ršg
 
	tlßd_·th
, *
	tout_n¡©es
);

13 
	sF‹r
 {

14 
¡©e
;

15 
f‹r_cb
 
cb
;

16 
b¡ršg
 
lßd_·th
;

17 } 
	tF‹r
;

19 
	`F‹r_š™
();

20 
	`F‹r_de¡roy
();

21 
	`F‹r_run
(
S‹Ev’t
 
Ãxt
, 
CÚÃùiÚ
 *
cÚn
);

22 
	`F‹r_add
(
S‹Ev’t
 
¡©e
, 
f‹r_cb
 
cb
, 
b¡ršg
 
lßd_·th
);

23 
	`F‹r_lßd
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
);

25 
šlše
 
S‹Ev’t
 *
	$F‹r_¡©e_li¡
(
S‹Ev’t
 *
¡©es
, 
Ëngth
)

27 
S‹Ev’t
 *
Ãw_¡©es
 = 
	`ÿÎoc
((S‹Ev’t), 
Ëngth
);

28 
	`memıy
(
Ãw_¡©es
, 
¡©es
, 
Ëngth
);

30  
Ãw_¡©es
;

31 
	}
}

33 
	#F‹r_¡©es_Ëngth
(
L
è((Lè/ (
S‹Ev’t
))

	)

35 
	#F‹r_aùiv©ed
(è(
FILTERS_ACTIVATED
)

	)

	@tools/src/handler.c

35 
	~<hªdËr.h
>

36 
	~<hªdËr_·r£r.h
>

37 
	~<sk/sk.h
>

38 
	~<zmq.h
>

39 
	~<dbg.h
>

40 
	~<¡dlib.h
>

41 
	~<¡ršg.h
>

42 
	~<cÚÃùiÚ.h
>

43 
	~<as£¹.h
>

44 
	~<»gi¡”.h
>

46 
	~"£‰šg.h
"

48 
gb¡ršg
 
	gLEAVE_HEADER_JSON
 = 
bsStic
("{\"METHOD\":\"JSON\"}");

49 
gb¡ršg
 
	gLEAVE_HEADER_TNET
 = 
bsStic
("16:6:METHOD,4:JSON,}");

50 
gb¡ršg
 
	gLEAVE_MSG
 = 
bsStic
("{\"type\":\"disconnect\"}");

53 
	gHANDLER_STACK
;

55 
	$c¡r_ä“
(*
d©a
, *
hšt
)

57 
	`ä“
(
d©a
);

58 
	}
}

60 
	$HªdËr_nÙify_Ëave
(
HªdËr
 *
hªdËr
, 
id
)

62 *
sock‘
 = 
hªdËr
->
£nd_sock‘
;

63 
	`as£¹
(
sock‘
 && "Socket can't be NULL");

64 
b¡ršg
 
·ylßd
 = 
NULL
;

66 if(
hªdËr
->
´ÙocŞ
 =ğ
HANDLER_PROTO_TNET
) {

67 
·ylßd
 = 
	`bfÜm©
("%s %d @* %s%d:%s,",

68 
	`bd©a
(
hªdËr
->
£nd_id’t
), 
id
,

69 
	`bd©a
(&
LEAVE_HEADER_TNET
),

70 
	`bËngth
(&
LEAVE_MSG
), 
	`bd©a
(&LEAVE_MSG));

72 
·ylßd
 = 
	`bfÜm©
("%s %d @* %d:%s,%d:%s,",

73 
	`bd©a
(
hªdËr
->
£nd_id’t
), 
id
,

74 
	`bËngth
(&
LEAVE_HEADER_JSON
), 
	`bd©a
(&LEAVE_HEADER_JSON),

75 
	`bËngth
(&
LEAVE_MSG
), 
	`bd©a
(&LEAVE_MSG));

78 
	`check
(
·ylßd
 !ğ
NULL
, "Failedo makehe…ayload for disconnect.");

80 if(
	`HªdËr_d–iv”
(
sock‘
, 
	`bd©a
(
·ylßd
), 
	`bËngth
(payload)) == -1) {

81 
	`log_”r
("Cª'ˆ‹Î hªdË¸%d d›d.", 
id
);

84 
”rÜ
:

85 if(
·ylßd
è
	`ä“
(payload);

86 
	}
}

89 
	$HªdËr_£tup
(
HªdËr
 *
hªdËr
)

91 
	`skÇme
("Handler_task");

93 
hªdËr
->
sk
 = 
	`sk£lf
();

95 
hªdËr
->
£nd_sock‘
 = 
	`HªdËr_£nd_ü—‹
(
	`bd©a
(hªdËr->
£nd_¥ec
), bd©a(hªdËr->
£nd_id’t
));

96 
	`check
(
hªdËr
->
£nd_sock‘
, "Failedo create handler socket.");

98 
hªdËr
->
»cv_sock‘
 = 
	`HªdËr_»cv_ü—‹
(
	`bd©a
(hªdËr->
»cv_¥ec
), bd©a(hªdËr->
»cv_id’t
));

99 
	`check
(
hªdËr
->
»cv_sock‘
, "Failedo create†istener socket.");

103 
”rÜ
:

106 
	}
}

108 
šlše
 
	$hªdËr_ÿp_·ylßd
(
b¡ršg
 
·ylßd
)

110 if(
·ylßd
->
d©a
[·ylßd->
¦’
 - 1] == '\0') {

111 
	`bŒunc
(
·ylßd
, 
	`bËngth
(payload)-1);

112 } if(
·ylßd
->
d©a
[·ylßd->
¦’
] != '\0') {

113 
	`bcÚch¬
(
·ylßd
, '\0');

115 
	}
}

117 
šlše
 
	$d–iv”_·ylßd
(
¿w
, 
fd
, 
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
·ylßd
)

119 
rc
 = 0;

121 if(
¿w
) {

122 
	`debug
("S’dšg„aw mes§gtØ%d†’gth %d", 
fd
, 
	`bËngth
(
·ylßd
));

123 
rc
 = 
	`CÚÃùiÚ_d–iv”_¿w
(
cÚn
, 
·ylßd
);

124 
	`check
(
rc
 !ğ-1, "E¼Ü s’dšg„aw mes§gtØHTTP†i¡’” oÀFD %d, closšghem.", 
fd
);

126 
	`debug
("S’dšg BASE64 mes§gtØ%d†’gth %d", 
fd
, 
	`bËngth
(
·ylßd
));

127 
	`hªdËr_ÿp_·ylßd
(
·ylßd
);

128 
rc
 = 
	`CÚÃùiÚ_d–iv”
(
cÚn
, 
·ylßd
);

129 
	`check
(
rc
 !ğ-1, "E¼Ü s’dšgØMSG†i¡’” oÀFD %d, closšghem.", 
fd
);

133 
”rÜ
:

135 
	}
}

137 
šlše
 
	$hªdËr_´oûss_»que¡
(
HªdËr
 *
hªdËr
, 
id
, 
fd
,

138 
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
·ylßd
)

140 
rc
 = 0;

142 if(
cÚn
 =ğ
NULL
) {

143 
	`debug
("Id’ˆ%d (fd %dèi nØlÚg” cÚÃùed.", 
id
, 
fd
);

144 
	`HªdËr_nÙify_Ëave
(
hªdËr
, 
id
);

146 if(
	`bËngth
(
·ylßd
) == 0) {

147 
rc
 = 
	`Regi¡”_discÚÃù
(
fd
);

148 
	`check
(
rc
 !ğ-1, "Regi¡” discÚÃù faed fÜ: %d", 
fd
);

150 
¿w
 = 
cÚn
->
ty³
 !ğ
CONN_TYPE_MSG
 || 
hªdËr
->raw;

152 
rc
 = 
	`d–iv”_·ylßd
(
¿w
, 
fd
, 
cÚn
, 
·ylßd
);

153 
	`check
(
rc
 !ğ-1, "FaedØd–iv”ØcÚÃùiÚ %d oÀsock‘ %d", 
id
, 
fd
);

159 
”rÜ
:

160 
	`Regi¡”_discÚÃù
(
fd
);

162 
	}
}

165 
šlše
 
	$hªdËr_»cv_·r£
(
HªdËr
 *
hªdËr
, 
HªdËrP¬£r
 *
·r£r
)

167 
	`check
(
hªdËr
->
ruÂšg
, "Called while handler wasn't„unning,hat's‚ot good.");

169 
zmq_msg_t
 *
šmsg
 = 
	`ÿÎoc
((zmq_msg_t), 1);

170 
rc
 = 0;

172 
	`check_mem
(
šmsg
);

174 
rc
 = 
	`zmq_msg_š™
(
šmsg
);

175 
	`check
(
rc
 == 0, "Failedo initialize message.");

177 
	`sk¡©e
("recv");

179 
rc
 = 
	`mq»cv
(
hªdËr
->
»cv_sock‘
, 
šmsg
, 0);

180 
	`check
(
rc
 == 0, "Receive on handler socket failed.");

181 
	`check
(
hªdËr
->
ruÂšg
, "Handler marked‡s‚ot„unning.");

183 
rc
 = 
	`HªdËrP¬£r_execu‹
(
·r£r
, 
	`zmq_msg_d©a
(
šmsg
), 
	`zmq_msg_size
(inmsg));

184 
	`check
(
rc
 == 1, "Failedo…arse message from handler.");

186 
	`check
(
·r£r
->
rg‘_couÁ
 > 0, "Message sent had 0argets: %.*s",

187 ()
	`zmq_msg_size
(
šmsg
), (*)
	`zmq_msg_d©a
(inmsg));

189 
	`zmq_msg_şo£
(
šmsg
);

190 
	`ä“
(
šmsg
);

193 
”rÜ
:

194 if(
šmsg
) {

195 
	`zmq_msg_şo£
(
šmsg
);

196 
	`ä“
(
šmsg
);

199 
	}
}

202 
	$HªdËr_sk
(*
v
)

204 
rc
 = 0;

205 
i
 = 0;

206 
HªdËr
 *
hªdËr
 = (HªdË¸*)
v
;

207 
HªdËrP¬£r
 *
·r£r
 = 
NULL
;

208 
max_rg‘s
 = 
	`S‘tšg_g‘_št
("limits.handler_targets", 128);

209 
	`log_šfo
("MAX‡llowing†imits.handler_targets=%d", 128);

211 
·r£r
 = 
	`HªdËrP¬£r_ü—‹
(
max_rg‘s
);

212 
	`check_mem
(
·r£r
);

214 
	`check
(
	`HªdËr_£tup
(
hªdËr
) == 0, "Failedo initialize handler,ƒxiting.");

216 
hªdËr
->
ruÂšg
 && !
	`sk_was_sigÇËd
()) {

217 
	`sk¡©e
("delivering");

219 
rc
 = 
	`hªdËr_»cv_·r£
(
hªdËr
, 
·r£r
);

220 if(
	`sk_was_sigÇËd
()) {

224 if(
rc
 !ğ-1 && 
·r£r
->
rg‘_couÁ
 > 0) {

225 
i
 = 0; i < ()
·r£r
->
rg‘_couÁ
; i++) {

226 
id
 = ()
·r£r
->
rg‘s
[
i
];

227 
fd
 = 
	`Regi¡”_fd_fÜ_id
(
id
);

228 
CÚÃùiÚ
 *
cÚn
 = (CÚÃùiÚ *)
	`Regi¡”_fd_exi¡s
(
fd
);

230 
	`hªdËr_´oûss_»que¡
(
hªdËr
, 
id
, 
fd
, 
cÚn
, 
·r£r
->
body
);

233 
	`debug
("Sk³d inv®id mes§gäom hªdËr: %s", 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

236 
	`HªdËrP¬£r_»£t
(
·r£r
);

239 
	`debug
("############################### HANDLER EXITED: %p,„unning: %d,ask: %p",

240 
hªdËr
, hªdËr->
ruÂšg
, hªdËr->
sk
);

241 
hªdËr
->
ruÂšg
 = 0;

242 
hªdËr
->
sk
 = 
NULL
;

243 
	`HªdËrP¬£r_de¡roy
(
·r£r
);

244 
	`skex™
(0);

246 
”rÜ
:

247 
hªdËr
->
ruÂšg
 = 0;

248 
hªdËr
->
sk
 = 
NULL
;

249 
	`HªdËrP¬£r_de¡roy
(
·r£r
);

250 
	`log_”r
("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! HANDLER TASK DIED");

251 
	`skex™
(1);

252 
	}
}

255 
	$HªdËr_d–iv”
(*
hªdËr_sock‘
, *
bufãr
, 
size_t
 
Ën
)

257 
rc
 = 0;

258 
zmq_msg_t
 
msg
;

260 
rc
 = 
	`zmq_msg_š™
(&
msg
);

261 
	`check
(
rc
 == 0, "Failedo initialize 0mq messageo send.");

263 
rc
 = 
	`zmq_msg_š™_d©a
(&
msg
, 
bufãr
, 
Ën
, 
c¡r_ä“
, 
NULL
);

264 
	`check
(
rc
 == 0, "Failedo init 0mq message data.");

266 
rc
 = 
	`mq£nd
(
hªdËr_sock‘
, &
msg
, 0);

267 
	`check
(
rc
 == 0, "Failedo deliver 0mq messageo handler.");

272 
”rÜ
:

273 
	`ä“
(
bufãr
);

275 
	}
}

278 *
	$HªdËr_£nd_ü—‹
(cÚ¡ *
£nd_¥ec
, cÚ¡ *
id’t™y
)

280 
bšd_©‹m±s
 = 10;

281 *
hªdËr_sock‘
 = 
	`mqsock‘
(
ZMQ_PUSH
);

282 
rc
 = 
	`zmq_£tsockİt
(
hªdËr_sock‘
, 
ZMQ_IDENTITY
, 
id’t™y
, 
	`¡¾’
(identity));

283 
	`check
(
rc
 =ğ0, "FaedØ£ˆhªdË¸sock‘ % id’t™y %s", 
£nd_¥ec
, 
id’t™y
);

285 
	`log_šfo
("Bšdšg hªdË¸PUSH sock‘ % w™h id’t™y: %s", 
£nd_¥ec
, 
id’t™y
);

287 
rc
 = 
	`zmq_bšd
(
hªdËr_sock‘
, 
£nd_¥ec
);

289 
rc
 !ğ0 && 
bšd_©‹m±s
-- > 0) {

290 
	`skd–ay
(1000);

291 
	`log_w¬n
("FaedØbšd s’d sock‘ryšg‡gaš fÜ: %s", 
£nd_¥ec
);

292 
rc
 = 
	`zmq_bšd
(
hªdËr_sock‘
, 
£nd_¥ec
);

295 
	`check
(
bšd_©‹m±s
 > 0, "ToØmªy bšd‡‰em± fÜ hªdË¸%s", 
£nd_¥ec
);

297  
hªdËr_sock‘
;

299 
”rÜ
:

300  
NULL
;

301 
	}
}

303 *
	$HªdËr_»cv_ü—‹
(cÚ¡ *
»cv_¥ec
, cÚ¡ *
uuid
)

305 
bšd_©‹m±s
 = 10;

306 *
li¡’”_sock‘
 = 
	`mqsock‘
(
ZMQ_SUB
);

307 
	`check
(
li¡’”_sock‘
, "Can't create ZMQ_SUB socket.");

309 
rc
 = 
	`zmq_£tsockİt
(
li¡’”_sock‘
, 
ZMQ_SUBSCRIBE
, 
uuid
, 0);

310 
	`check
(
rc
 =ğ0, "FaedØsubsüibli¡’” sock‘: %s", 
»cv_¥ec
);

311 
	`log_šfo
("Bšdšg†i¡’” SUB sock‘ % subsüibedo: %s", 
»cv_¥ec
, 
uuid
);

313 
rc
 = 
	`zmq_bšd
(
li¡’”_sock‘
, 
»cv_¥ec
);

315 
rc
 !ğ0 && 
bšd_©‹m±s
-- > 0) {

316 
	`skd–ay
(1000);

317 
	`debug
("Failedo bind„ecv socketrying‡gain.");

318 
rc
 = 
	`zmq_bšd
(
li¡’”_sock‘
, 
»cv_¥ec
);

321 
	`check
(
bšd_©‹m±s
 > 0, "ToØmªy bšd‡‰em± fÜ hªdË¸%s", 
»cv_¥ec
);

323  
li¡’”_sock‘
;

325 
”rÜ
:

326  
NULL
;

327 
	}
}

329 cÚ¡ 
	gDEFAULT_HANDLER_STACK
 = 100 * 1024;

331 
HªdËr
 *
	$HªdËr_ü—‹
(
b¡ršg
 
£nd_¥ec
, b¡ršg 
£nd_id’t
,

332 
b¡ršg
 
»cv_¥ec
, b¡ršg 
»cv_id’t
)

334 
	`debug
("C»©šg hªdË¸%s:%s", 
	`bd©a
(
£nd_¥ec
), bd©a(
£nd_id’t
));

336 if(!
HANDLER_STACK
) {

337 
HANDLER_STACK
 = 
	`S‘tšg_g‘_št
("lim™s.hªdËr_¡ack", 
DEFAULT_HANDLER_STACK
);

338 
	`log_šfo
("MAX†im™s.hªdËr_¡ack=%d", 
HANDLER_STACK
);

341 
HªdËr
 *
hªdËr
 = 
	`ÿÎoc
((Handler), 1);

342 
	`check_mem
(
hªdËr
);

344 
hªdËr
->
£nd_id’t
 = 
	`b¡rıy
(send_ident);

345 
hªdËr
->
»cv_id’t
 = 
	`b¡rıy
(recv_ident);

346 
hªdËr
->
»cv_¥ec
 = 
	`b¡rıy
(recv_spec);

347 
hªdËr
->
£nd_¥ec
 = 
	`b¡rıy
(send_spec);

348 
hªdËr
->
ruÂšg
 = 0;

349 
hªdËr
->
¿w
 = 0;

350 
hªdËr
->
´ÙocŞ
 = 
HANDLER_PROTO_JSON
;

352  
hªdËr
;

353 
”rÜ
:

355 if(
hªdËr
è
	`ä“
(handler);

356  
NULL
;

357 
	}
}

360 
	$HªdËr_de¡roy
(
HªdËr
 *
hªdËr
)

362 if(
hªdËr
) {

363 if(
hªdËr
->
»cv_sock‘
è
	`zmq_şo£
(handler->recv_socket);

364 if(
hªdËr
->
£nd_sock‘
è
	`zmq_şo£
(handler->send_socket);

366 
	`bde¡roy
(
hªdËr
->
£nd_id’t
);

367 
	`bde¡roy
(
hªdËr
->
»cv_id’t
);

368 
	`bde¡roy
(
hªdËr
->
£nd_¥ec
);

369 
	`bde¡roy
(
hªdËr
->
»cv_¥ec
);

370 
	`ä“
(
hªdËr
);

372 
	}
}

	@tools/src/handler.h

35 #iâdeà
_hªdËr_h


36 
	#_hªdËr_h


	)

38 
	~<¡dlib.h
>

39 
	~<b¡ršg.h
>

40 
	~<sk/sk.h
>

42 
HANDLER_STACK
;

44 ’um { 
	mHANDLER_PROTO_JSON
, 
	mHANDLER_PROTO_TNET
 } 
	thªdËr_´ÙocŞ_t
;

46 
	sHªdËr
 {

47 *
	m£nd_sock‘
;

48 *
	m»cv_sock‘
;

49 
b¡ršg
 
	m£nd_id’t
;

50 
b¡ršg
 
	m»cv_id’t
;

51 
b¡ršg
 
	m»cv_¥ec
;

52 
b¡ršg
 
	m£nd_¥ec
;

53 
Task
 *
	msk
;

54 
	mruÂšg
;

55 
	m¿w
;

56 
hªdËr_´ÙocŞ_t
 
	m´ÙocŞ
;

57 } 
	tHªdËr
;

59 
HªdËr_sk
(*
v
);

61 
HªdËr_d–iv”
(*
hªdËr_sock‘
, *
bufãr
, 
size_t
 
Ën
);

63 
HªdËr
 *
HªdËr_ü—‹
(
b¡ršg
 
£nd_¥ec
, b¡ršg 
£nd_id’t
,

64 
b¡ršg
 
»cv_¥ec
, b¡ršg 
»cv_id’t
);

66 
HªdËr_de¡roy
(
HªdËr
 *
hªdËr
);

68 *
HªdËr_»cv_ü—‹
(cÚ¡ *
»cv_¥ec
, cÚ¡ *
uuid
);

70 *
HªdËr_£nd_ü—‹
(cÚ¡ *
£nd_¥ec
, cÚ¡ *
id’t™y
);

72 
HªdËr_nÙify_Ëave
(
HªdËr
 *
hªdËr
, 
fd
);

	@tools/src/handler_parser.c

37 
	~<as£¹.h
>

38 
	~<¡dlib.h
>

39 
	~<ùy³.h
>

41 
	~"hªdËr_·r£r.h
"

42 
	~"b¡ršg.h
"

43 
	~"dbg.h
"

44 
	~"mem/h®loc.h
"

53 cÚ¡ 
	gHªdËrP¬£r_¡¬t
 = 1;

54 cÚ¡ 
	gHªdËrP¬£r_fœ¡_fš®
 = 9;

55 cÚ¡ 
	gHªdËrP¬£r_”rÜ
 = 0;

57 cÚ¡ 
	gHªdËrP¬£r_’_maš
 = 1;

64 
	$HªdËrP¬£r_execu‹
(
HªdËrP¬£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
)

66 cÚ¡ *
p
 = 
bufãr
;

67 cÚ¡ *
³
 = 
bufãr
+
Ën
;

68 
cs
 = 0;

69 cÚ¡ *
m¬k
 = 
p
;

70 cÚ¡ *
rg‘s_¡¬t
 = 
NULL
;

71 
rg‘_ex³ùed_Ën
 = 0;

72 
·r£r
->
rg‘_couÁ
 = 0;

73 
·r£r
->
uuid
 = 
NULL
;

78 
cs
 = 
HªdËrP¬£r_¡¬t
;

85  
cs
 )

88 iàĞ(*
p
) == 45 )

89 
Œ0
;

90 iàĞ(*
p
) < 65 ) {

91 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

92 
Œ0
;

93 } iàĞ(*
p
) > 90 ) {

94 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

95 
Œ0
;

97 
Œ0
;

98 
¡0
;

99 
¡0
:

100 
cs
 = 0;

101 
_out
;

102 
Œ0
:

104 { 
m¬k
 = 
p
; }

105 
¡2
;

106 
¡2
:

107 
p
 += 1;

110  (*
p
) ) {

111 32: 
Œ2
;

112 45: 
¡2
;

114 iàĞ(*
p
) < 65 ) {

115 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

116 
¡2
;

117 } iàĞ(*
p
) > 90 ) {

118 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

119 
¡2
;

121 
¡2
;

122 
¡0
;

123 
Œ2
:

126 
·r£r
->
uuid
 = 
	`blk2b¡r
(
m¬k
, 
p
-mark);

128 
¡3
;

129 
¡3
:

130 
p
 += 1;

133 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

134 
Œ4
;

135 
¡0
;

136 
Œ4
:

138 { 
m¬k
 = 
p
; }

139 
¡4
;

140 
¡4
:

141 
p
 += 1;

144 iàĞ(*
p
) == 58 )

145 
Œ6
;

146 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

147 
¡4
;

148 
¡0
;

149 
Œ6
:

152 *
’d±r
 = 
NULL
;

153 
rg‘_ex³ùed_Ën
 = 
	`¡¹oul
(
m¬k
, &
’d±r
, 10);

154 
	`check
(
’d±r
 =ğ
p
, "Invalid†ength given, didn't…arse correctly.");

156 
¡5
;

157 
¡5
:

158 
p
 += 1;

161 iàĞ(*
p
) == 44 )

162 
Œ7
;

163 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

164 
Œ8
;

165 
¡0
;

166 
Œ7
:

169 
rg‘s_¡¬t
 = 
p
;

173 
	`check
(
p
-
rg‘s_¡¬t
 =ğ
rg‘_ex³ùed_Ën
,

175 ()(
p
-
rg‘s_¡¬t
), ()
rg‘_ex³ùed_Ën
);

177 
¡6
;

178 
Œ11
:

181 
	`check
(
·r£r
->
rg‘_couÁ
 <…¬£r->
rg‘_max
, "Request containsoo manyarget†isteners.");

182 
·r£r
->
rg‘s
[·r£r->
rg‘_couÁ
++] = 
	`¡¹oul
(
m¬k
, 
NULL
, 10);

186 
	`check
(
p
-
rg‘s_¡¬t
 =ğ
rg‘_ex³ùed_Ën
,

188 ()(
p
-
rg‘s_¡¬t
), ()
rg‘_ex³ùed_Ën
);

190 
¡6
;

191 
¡6
:

192 
p
 += 1;

195 iàĞ(*
p
) == 32 )

196 
Œ9
;

197 
¡0
;

198 
Œ9
:

200 { {
p
++; 
cs
 = 9; 
_out
;} }

201 
¡9
;

202 
¡9
:

203 
p
 += 1;

206 
¡0
;

207 
Œ8
:

210 
rg‘s_¡¬t
 = 
p
;

213 { 
m¬k
 = 
p
; }

214 
¡7
;

215 
Œ13
:

218 
	`check
(
·r£r
->
rg‘_couÁ
 <…¬£r->
rg‘_max
, "Request containsoo manyarget†isteners.");

219 
·r£r
->
rg‘s
[·r£r->
rg‘_couÁ
++] = 
	`¡¹oul
(
m¬k
, 
NULL
, 10);

222 { 
m¬k
 = 
p
; }

223 
¡7
;

224 
¡7
:

225 
p
 += 1;

228  (*
p
) ) {

229 32: 
¡8
;

230 44: 
Œ11
;

232 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

233 
¡7
;

234 
¡0
;

235 
¡8
:

236 
p
 += 1;

238 iàĞ(*
p
) == 44 )

239 
Œ11
;

240 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

241 
Œ13
;

242 
¡0
;

245 
_out
: {}

250 
	`check
(
p
 <ğ
³
, "Buffer overflow‡fter…arsing. Tell Zedhat you sent something from‡ handlerhat went %ld…astheƒnd inhe…arser.",

251 ()(
³
 - 
p
));

253 
·r£r
->
body
 = 
	`blk2b¡r
(
p
, 
³
 -…);

255 iàĞ
cs
 ==

261 } iàĞ
cs
 >=

271 
”rÜ
:

273 
	}
}

276 
HªdËrP¬£r
 *
	$HªdËrP¬£r_ü—‹
(
size_t
 
max_rg‘s
)

278 
HªdËrP¬£r
 *
·r£r
 = 
	`h_ÿÎoc
((HandlerParser), 1);

279 
	`check_mem
(
·r£r
);

281 
·r£r
->
rg‘_max
 = 
max_rg‘s
;

282 
·r£r
->
rg‘s
 = 
	`h_ÿÎoc
((), 
max_rg‘s
);

283 
	`check_mem
(
·r£r
->
rg‘s
);

284 
	`h©ch
(
·r£r
->
rg‘s
,…arser);

286  
·r£r
;

288 
”rÜ
:

289  
NULL
;

290 
	}
}

292 
	$HªdËrP¬£r_»£t
(
HªdËrP¬£r
 *
·r£r
)

294 if(
·r£r
->
uuid
) {

295 
	`bde¡roy
(
·r£r
->
uuid
);

296 
·r£r
->
uuid
 = 
NULL
;

299 if(
·r£r
->
body
) {

300 
	`bde¡roy
(
·r£r
->
body
);

301 
·r£r
->
body
 = 
NULL
;

303 
	}
}

305 
	$HªdËrP¬£r_de¡roy
(
HªdËrP¬£r
 *
·r£r
)

307 if(
·r£r
 !ğ
NULL
) {

308 
	`HªdËrP¬£r_»£t
(
·r£r
);

309 
	`h_ä“
(
·r£r
);

311 
	}
}

	@tools/src/handler_parser.h

1 #iâdeà
_hªdËr_·r£r_h


2 
	#_hªdËr_·r£r_h


	)

4 
	~<¡dlib.h
>

5 
	~<b¡ršg.h
>

7 
	sHªdËrP¬£r
 {

8 
b¡ršg
 
	mbody
;

9 
b¡ršg
 
	muuid
;

11 
size_t
 
	mrg‘_couÁ
;

12 
size_t
 
	mrg‘_max
;

13 *
	mrg‘s
;

14 } 
	tHªdËrP¬£r
;

16 
HªdËrP¬£r
 *
HªdËrP¬£r_ü—‹
(
size_t
 
max_rg‘s
);

18 
HªdËrP¬£r_de¡roy
(
HªdËrP¬£r
 *
·r£r
);

20 
HªdËrP¬£r_execu‹
(
HªdËrP¬£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
);

22 
HªdËrP¬£r_»£t
(
HªdËrP¬£r
 *
·r£r
);

	@tools/src/headers.c

35 
	~<h—d”s.h
>

37 
gb¡ršg
 
	gHTTP_METHOD
 = 
bsStic
("METHOD");

38 
gb¡ršg
 
	gHTTP_VERSION
 = 
bsStic
("VERSION");

39 
gb¡ršg
 
	gHTTP_URI
 = 
bsStic
("URI");

40 
gb¡ršg
 
	gHTTP_PATH
 = 
bsStic
("PATH");

41 
gb¡ršg
 
	gHTTP_QUERY
 = 
bsStic
("QUERY");

42 
gb¡ršg
 
	gHTTP_FRAGMENT
 = 
bsStic
("FRAGMENT");

43 
gb¡ršg
 
	gHTTP_BODY
 = 
bsStic
("BODY");

44 
gb¡ršg
 
	gJSON_METHOD
 = 
bsStic
("JSON");

45 
gb¡ršg
 
	gXML_METHOD
 = 
bsStic
("XML");

48 
gb¡ršg
 
	gHTTP_POST
 = 
bsStic
("POST");

49 
gb¡ršg
 
	gHTTP_GET
 = 
bsStic
("GET");

50 
gb¡ršg
 
	gHTTP_HEAD
 = 
bsStic
("HEAD");

51 
gb¡ršg
 
	gHTTP_DELETE
 = 
bsStic
("DELETE");

52 
gb¡ršg
 
	gHTTP_PUT
 = 
bsStic
("PUT");

53 
gb¡ršg
 
	gHTTP_OPTIONS
 = 
bsStic
("OPTIONS");

54 
gb¡ršg
 
	gHTTP_PATTERN
 = 
bsStic
("PATTERN");

57 
gb¡ršg
 
	gHTTP_CONTENT_LENGTH
 = 
bsStic
("content-length");

58 
gb¡ršg
 
	gHTTP_HOST
 = 
bsStic
("host");

59 
gb¡ršg
 
	gHTTP_IF_MATCH
 = 
bsStic
("if-match");

60 
gb¡ršg
 
	gHTTP_IF_NONE_MATCH
 = 
bsStic
("if-none-match");

61 
gb¡ršg
 
	gHTTP_IF_MODIFIED_SINCE
 = 
bsStic
("if-modified-since");

62 
gb¡ršg
 
	gHTTP_IF_UNMODIFIED_SINCE
 = 
bsStic
("if-unmodified-since");

63 
gb¡ršg
 
	gHTTP_USER_AGENT
 = 
bsStic
("user-agent");

64 
gb¡ršg
 
	gHTTP_CONNECTION
 = 
bsStic
("connection");

66 
gb¡ršg
 
	gHTTP_X_FORWARDED_FOR
 = 
bsStic
("x-forwarded-for");

	@tools/src/headers.h

35 #iâdeà
_h—d”s_h


36 
	#_h—d”s_h


	)

38 
	~<b¡ršg.h
>

40 
gb¡ršg
 
HTTP_CONTENT_LENGTH
;

41 
gb¡ršg
 
HTTP_HOST
;

42 
gb¡ršg
 
HTTP_METHOD
;

43 
gb¡ršg
 
HTTP_VERSION
;

44 
gb¡ršg
 
HTTP_URI
;

45 
gb¡ršg
 
HTTP_PATH
;

46 
gb¡ršg
 
HTTP_QUERY
;

47 
gb¡ršg
 
HTTP_FRAGMENT
;

48 
gb¡ršg
 
HTTP_BODY
;

49 
gb¡ršg
 
JSON_METHOD
;

50 
gb¡ršg
 
XML_METHOD
;

51 
gb¡ršg
 
HTTP_IF_MATCH
;

52 
gb¡ršg
 
HTTP_IF_NONE_MATCH
;

53 
gb¡ršg
 
HTTP_IF_MODIFIED_SINCE
;

54 
gb¡ršg
 
HTTP_IF_UNMODIFIED_SINCE
;

55 
gb¡ršg
 
HTTP_POST
;

56 
gb¡ršg
 
HTTP_GET
;

57 
gb¡ršg
 
HTTP_HEAD
;

58 
gb¡ršg
 
HTTP_DELETE
;

59 
gb¡ršg
 
HTTP_PUT
;

60 
gb¡ršg
 
HTTP_OPTIONS
;

61 
gb¡ršg
 
HTTP_PATTERN
;

62 
gb¡ršg
 
HTTP_USER_AGENT
;

63 
gb¡ršg
 
HTTP_CONNECTION
;

64 
gb¡ršg
 
HTTP_X_FORWARDED_FOR
;

	@tools/src/host.c

35 
	~<ho¡.h
>

36 
	~<¡ršg.h
>

37 
	~<dbg.h
>

38 
	~<as£¹.h
>

39 
	~<mem/h®loc.h
>

40 
	~<dœ.h
>

41 
	~"£‰šg.h
"

43 
	gMAX_HOST_NAME
 = 0;

44 
	gMAX_URL_PATH
 = 0;

46 
	$back’d_de¡roy_cb
(
Rou‹
 *
r
, 
Rou‹M­
 *
m­
)

48 
Back’d
 *
back’d
 = (Back’d *)
r
->
d©a
;

50 if(
back’d
) {

51 
	`ä“
(
back’d
);

52 
r
->
d©a
 = 
NULL
;

54 
	}
}

56 
Ho¡
 *
	$Ho¡_ü—‹
(
b¡ršg
 
Çme
, b¡ršg 
m©chšg
)

58 if(!
MAX_URL_PATH
 || !
MAX_HOST_NAME
) {

59 
MAX_URL_PATH
 = 
	`S‘tšg_g‘_št
("limits.url_path", 256);

60 
MAX_HOST_NAME
 = 
	`S‘tšg_g‘_št
("limits.host_name", 256);

61 
	`log_šfo
("MAX†imits.url_path=%d,†imits.host_name=%d",

62 
MAX_URL_PATH
, 
MAX_HOST_NAME
);

65 
Ho¡
 *
ho¡
 = 
	`h_ÿÎoc
((Host), 1);

66 
	`check_mem
(
ho¡
);

68 
ho¡
->
Çme
 = 
	`b¡rıy
(name);

69 
	`check
(
	`bËngth
(
ho¡
->
Çme
è< 
MAX_HOST_NAME
, "Host‚ameoo†ong (max %d): '%s'\n",

70 
MAX_HOST_NAME
, 
	`bd©a
(
Çme
));

72 
ho¡
->
m©chšg
 = 
	`b¡rıy
(matching);

74 
	`check
(
	`bËngth
(
ho¡
->
m©chšg
è< 
MAX_HOST_NAME
, "Host matching…atternoo†ong (max %d): '%s'\n",

75 
MAX_HOST_NAME
, 
	`bd©a
(
Çme
));

77 
ho¡
->
rou‹s
 = 
	`Rou‹M­_ü—‹
(
back’d_de¡roy_cb
);

78 
	`check
(
ho¡
->
rou‹s
, "FaedØü—‹ ho¡„ou‹ m­ fÜ %s.", 
	`bd©a
(
Çme
));

80  
ho¡
;

82 
”rÜ
:

83  
NULL
;

84 
	}
}

87 
	$Ho¡_de¡roy
(
Ho¡
 *
ho¡
)

89 if(
ho¡
) {

90 
	`bde¡roy
(
ho¡
->
Çme
);

91 
	`Rou‹M­_de¡roy
(
ho¡
->
rou‹s
);

92 
	`h_ä“
(
ho¡
);

94 
	}
}

98 
	$Ho¡_add_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
·th
, 
Back’dTy³
 
ty³
, *
rg‘
)

100 
	`debug
("ADDING ROUTE TO HOST %p: %s", 
ho¡
, 
	`bd©a
(
·th
));

101 
Back’d
 *
back’d
 = 
	`ÿÎoc
((Backend), 1);

102 
	`check_mem
(
back’d
);

104 
back’d
->
ty³
 =ype;

106 if(
ty³
 =ğ
BACKEND_HANDLER
) {

107 
back’d
->
rg‘
.
hªdËr
 =arget;

108 } if(
ty³
 =ğ
BACKEND_PROXY
) {

109 
back’d
->
rg‘
.
´oxy
 =arget;

110 } if(
ty³
 =ğ
BACKEND_DIR
) {

111 
back’d
->
rg‘
.
dœ
 =arget;

113 
	`£Áš–
("Inv®id…roxyy³ giv’: %d", 
ty³
);

116 
rc
 = 
	`Rou‹M­_š£¹
(
ho¡
->
rou‹s
, 
	`b¡rıy
(
·th
), 
back’d
);

117 
	`check
(
rc
 == 0, "Failedo insert %s into host %s„oute map.",

118 
	`bd©a
(
·th
), bd©a(
ho¡
->
Çme
));

122 
”rÜ
:

124 
	}
}

127 
Back’d
 *
	$Ho¡_m©ch_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
rg‘
, 
Rou‹
 **
out_rou‹
)

129 
Rou‹
 *
found
 = 
NULL
;

130 
	`debug
("MATCHING BACKEND IN HOST %°AGAINST % š ROUTES: %p", 
ho¡
, 
	`bd©a
(
rg‘
), ho¡->
rou‹s
);

132 
found
 = 
	`Rou‹M­_sim¶e_´efix_m©ch
(
ho¡
->
rou‹s
, 
rg‘
);

134 if(
found
) {

135 
	`debug
("Found back’d‡ˆ%s", 
	`bd©a
(
found
->
·‰”n
));

136 
	`as£¹
(
found
->
d©a
 && "Invalid value for stored„oute.");

137 if(
out_rou‹
è*out_rou‹ = 
found
;

138  
found
->
d©a
;

140 if(
out_rou‹
è*out_rou‹ = 
found
;

141  
NULL
;

143 
	}
}

	@tools/src/host.h

35 #iâdeà
_ho¡_h


36 
	#_ho¡_h


	)

38 
	~<adt/t¡.h
>

39 
	~<´oxy.h
>

40 
	~<hªdËr.h
>

41 
	~<»que¡.h
>

42 
	~<routšg.h
>

44 
MAX_HOST_NAME
;

45 
MAX_URL_PATH
;

48 
	sHo¡
 {

49 
Rou‹M­
 *
	mrou‹s
;

50 
b¡ršg
 
	mÇme
;

51 
b¡ršg
 
	mm©chšg
;

52 } 
	tHo¡
;

55 
	eBack’dTy³
 {

56 
	mBACKEND_HANDLER
=1, 
	mBACKEND_PROXY
, 
	mBACKEND_DIR


57 } 
	tBack’dTy³
;

59 
	sBack’d
 {

60 
	mty³
;

63 
HªdËr
 *
	mhªdËr
;

64 
Proxy
 *
	m´oxy
;

65 
Dœ
 *
	mdœ
;

66 } 
	mrg‘
;

67 } 
	tBack’d
;

69 
Ho¡
 *
Ho¡_ü—‹
(
b¡ršg
 
Çme
, b¡ršg 
m©chšg
);

70 
Ho¡_de¡roy
(
Ho¡
 *
ho¡
);

72 
Ho¡_add_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
·th
, 
Back’dTy³
 
ty³
, *
rg‘
);

74 
Back’d
 *
Ho¡_m©ch_back’d
(
Ho¡
 *
ho¡
, 
b¡ršg
 
rg‘
, 
Rou‹
 **
out_rou‹
);

	@tools/src/http11/http11_common.h

1 #iâdeà
_h‰p11_commÚ_h


2 
	#_h‰p11_commÚ_h


	)

4 
	~<sys/ty³s.h
>

6 (*
	t–em’t_cb
)(*
	td©a
, cÚ¡ *
	t©
, 
	tsize_t
 
	tËngth
);

7 (*
	tf›ld_cb
)(*
	td©a
, cÚ¡ *
	tf›ld
, 
	tsize_t
 
	tæ’
, cÚ¡ *
	tv®ue
, size_ˆ
	tvËn
);

	@tools/src/http11/http11_parser.c

37 
	~"h‰p11_·r£r.h
"

38 
	~<¡dio.h
>

39 
	~<as£¹.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~<dbg.h
>

45 
	#LEN
(
AT
, 
FPC
è(FPC - 
bufãr
 - 
·r£r
->AT)

	)

46 
	#MARK
(
M
,
FPC
è(
·r£r
->M = (FPCè- 
bufãr
)

	)

47 
	#PTR_TO
(
F
è(
bufãr
 + 
·r£r
->F)

	)

58 cÚ¡ 
	gh‰p_·r£r_¡¬t
 = 1;

59 cÚ¡ 
	gh‰p_·r£r_fœ¡_fš®
 = 78;

60 cÚ¡ 
	gh‰p_·r£r_”rÜ
 = 0;

62 cÚ¡ 
	gh‰p_·r£r_’_maš
 = 1;

67 
	$h‰p_·r£r_š™
(
h‰p_·r£r
 *
·r£r
) {

68 
cs
 = 0;

72 
cs
 = 
h‰p_·r£r_¡¬t
;

76 
·r£r
->
cs
 = cs;

77 
·r£r
->
body_¡¬t
 = 0;

78 
·r£r
->
cÚ‹Á_Ën
 = 0;

79 
·r£r
->
m¬k
 = 0;

80 
·r£r
->
Ä—d
 = 0;

81 
·r£r
->
f›ld_Ën
 = 0;

82 
·r£r
->
f›ld_¡¬t
 = 0;

83 
·r£r
->
xml_£Á
 = 0;

84 
·r£r
->
jsÚ_£Á
 = 0;

87 
	}
}

91 
size_t
 
	$h‰p_·r£r_execu‹
(
h‰p_·r£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
, size_ˆ
off
)

93 if(
Ën
 == 0)  0;

95 cÚ¡ *
p
, *
³
;

96 
cs
 = 
·r£r
->cs;

98 
	`as£¹
(
off
 <ğ
Ën
 && "offset…astƒnd of buffer");

100 
p
 = 
bufãr
+
off
;

101 
³
 = 
bufãr
+
Ën
;

103 
	`as£¹
(
³
 - 
p
 =ğ()
Ën
 - ()
off
 && "pointers‡ren't same distance");

108 iàĞ
p
 =ğ
³
 )

109 
_‹¡_eof
;

110  
cs
 )

113  (*
p
) ) {

114 36: 
Œ0
;

115 60: 
Œ2
;

116 64: 
Œ3
;

117 95: 
Œ0
;

119 iàĞ(*
p
) < 48 ) {

120 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

121 
Œ0
;

122 } iàĞ(*
p
) > 57 ) {

123 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

124 
Œ0
;

126 
Œ0
;

127 
¡0
;

128 
¡0
:

129 
cs
 = 0;

130 
_out
;

131 
Œ0
:

133 {
	`MARK
(
m¬k
, 
p
); }

134 
¡2
;

135 
¡2
:

136 iàĞ++
p
 =ğ
³
 )

137 
_‹¡_eof2
;

140  (*
p
) ) {

141 32: 
Œ4
;

142 36: 
¡41
;

143 95: 
¡41
;

145 iàĞ(*
p
) < 48 ) {

146 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

147 
¡41
;

148 } iàĞ(*
p
) > 57 ) {

149 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

150 
¡41
;

152 
¡41
;

153 
¡0
;

154 
Œ4
:

157 if(
·r£r
->
»que¡_m‘hod
 !ğ
NULL
)

158 
·r£r
->
	`»que¡_m‘hod
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

160 
¡3
;

161 
¡3
:

162 iàĞ++
p
 =ğ
³
 )

163 
_‹¡_eof3
;

166  (*
p
) ) {

167 42: 
Œ6
;

168 47: 
Œ7
;

169 104: 
Œ8
;

171 
¡0
;

172 
Œ6
:

174 {
	`MARK
(
m¬k
, 
p
); }

175 
¡4
;

176 
¡4
:

177 iàĞ++
p
 =ğ
³
 )

178 
_‹¡_eof4
;

181  (*
p
) ) {

182 32: 
Œ9
;

183 35: 
Œ10
;

185 
¡0
;

186 
Œ9
:

189 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

190 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

192 
¡5
;

193 
Œ35
:

195 {
	`MARK
(
m¬k
, 
p
); }

198 if(
·r£r
->
äagm’t
 !ğ
NULL
)

199 
·r£r
->
	`äagm’t
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

201 
¡5
;

202 
Œ38
:

205 if(
·r£r
->
äagm’t
 !ğ
NULL
)

206 
·r£r
->
	`äagm’t
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

208 
¡5
;

209 
Œ42
:

212 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

213 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

217 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

218 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

220 
¡5
;

221 
Œ53
:

223 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

226 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

227 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

231 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

232 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

234 
¡5
;

235 
Œ57
:

238 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

239 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

243 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

244 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

246 
¡5
;

247 
¡5
:

248 iàĞ++
p
 =ğ
³
 )

249 
_‹¡_eof5
;

252 iàĞ(*
p
) == 72 )

253 
Œ11
;

254 
¡0
;

255 
Œ11
:

257 {
	`MARK
(
m¬k
, 
p
); }

258 
¡6
;

259 
¡6
:

260 iàĞ++
p
 =ğ
³
 )

261 
_‹¡_eof6
;

264 iàĞ(*
p
) == 84 )

265 
¡7
;

266 
¡0
;

267 
¡7
:

268 iàĞ++
p
 =ğ
³
 )

269 
_‹¡_eof7
;

271 iàĞ(*
p
) == 84 )

272 
¡8
;

273 
¡0
;

274 
¡8
:

275 iàĞ++
p
 =ğ
³
 )

276 
_‹¡_eof8
;

278 iàĞ(*
p
) == 80 )

279 
¡9
;

280 
¡0
;

281 
¡9
:

282 iàĞ++
p
 =ğ
³
 )

283 
_‹¡_eof9
;

285 iàĞ(*
p
) == 47 )

286 
¡10
;

287 
¡0
;

288 
¡10
:

289 iàĞ++
p
 =ğ
³
 )

290 
_‹¡_eof10
;

292 iàĞ(*
p
) == 49 )

293 
¡11
;

294 
¡0
;

295 
¡11
:

296 iàĞ++
p
 =ğ
³
 )

297 
_‹¡_eof11
;

299 iàĞ(*
p
) == 46 )

300 
¡12
;

301 
¡0
;

302 
¡12
:

303 iàĞ++
p
 =ğ
³
 )

304 
_‹¡_eof12
;

306 iàĞ48 <ğ(*
p
) && (*p) <= 49 )

307 
¡13
;

308 
¡0
;

309 
¡13
:

310 iàĞ++
p
 =ğ
³
 )

311 
_‹¡_eof13
;

313  (*
p
) ) {

314 10: 
Œ19
;

315 13: 
Œ20
;

317 
¡0
;

318 
Œ19
:

321 if(
·r£r
->
h‰p_v”siÚ
 !ğ
NULL
)

322 
·r£r
->
	`h‰p_v”siÚ
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

324 
¡14
;

325 
Œ27
:

327 { 
	`MARK
(
m¬k
, 
p
); }

330 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

331 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

334 
¡14
;

335 
Œ31
:

338 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

339 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

342 
¡14
;

343 
¡14
:

344 iàĞ++
p
 =ğ
³
 )

345 
_‹¡_eof14
;

348  (*
p
) ) {

349 10: 
Œ21
;

350 13: 
¡15
;

351 33: 
Œ23
;

352 124: 
Œ23
;

353 126: 
Œ23
;

355 iàĞ(*
p
) < 45 ) {

356 iàĞ(*
p
) > 39 ) {

357 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

358 
Œ23
;

359 } iàĞ(*
p
) >= 35 )

360 
Œ23
;

361 } iàĞ(*
p
) > 46 ) {

362 iàĞ(*
p
) < 65 ) {

363 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

364 
Œ23
;

365 } iàĞ(*
p
) > 90 ) {

366 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

367 
Œ23
;

369 
Œ23
;

371 
Œ23
;

372 
¡0
;

373 
Œ21
:

376 if(
·r£r
->
xml_£Á
 ||…¬£r->
jsÚ_£Á
) {

377 
·r£r
->
body_¡¬t
 = 
	`PTR_TO
(
m¬k
è- 
bufãr
;

379 
·r£r
->
cÚ‹Á_Ën
 = 
p
 - 
bufãr
 -…¬£r->
body_¡¬t
 + 1;

381 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

383 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
) {

384 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

387 {
p
++; 
cs
 = 78; 
_out
;}

389 
¡78
;

390 
Œ89
:

393 
·r£r
->
xml_£Á
 = 1;

397 if(
·r£r
->
xml_£Á
 ||…¬£r->
jsÚ_£Á
) {

398 
·r£r
->
body_¡¬t
 = 
	`PTR_TO
(
m¬k
è- 
bufãr
;

400 
·r£r
->
cÚ‹Á_Ën
 = 
p
 - 
bufãr
 -…¬£r->
body_¡¬t
 + 1;

402 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

404 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
) {

405 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

408 {
p
++; 
cs
 = 78; 
_out
;}

410 
¡78
;

411 
Œ98
:

414 
·r£r
->
jsÚ_£Á
 = 1;

418 if(
·r£r
->
xml_£Á
 ||…¬£r->
jsÚ_£Á
) {

419 
·r£r
->
body_¡¬t
 = 
	`PTR_TO
(
m¬k
è- 
bufãr
;

421 
·r£r
->
cÚ‹Á_Ën
 = 
p
 - 
bufãr
 -…¬£r->
body_¡¬t
 + 1;

423 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

425 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
) {

426 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

429 {
p
++; 
cs
 = 78; 
_out
;}

431 
¡78
;

432 
¡78
:

433 iàĞ++
p
 =ğ
³
 )

434 
_‹¡_eof78
;

437 
¡0
;

438 
¡15
:

439 iàĞ++
p
 =ğ
³
 )

440 
_‹¡_eof15
;

442 iàĞ(*
p
) == 10 )

443 
Œ21
;

444 
¡0
;

445 
Œ23
:

447 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

448 
¡16
;

449 
¡16
:

450 iàĞ++
p
 =ğ
³
 )

451 
_‹¡_eof16
;

454  (*
p
) ) {

455 33: 
¡16
;

456 58: 
Œ25
;

457 124: 
¡16
;

458 126: 
¡16
;

460 iàĞ(*
p
) < 45 ) {

461 iàĞ(*
p
) > 39 ) {

462 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

463 
¡16
;

464 } iàĞ(*
p
) >= 35 )

465 
¡16
;

466 } iàĞ(*
p
) > 46 ) {

467 iàĞ(*
p
) < 65 ) {

468 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

469 
¡16
;

470 } iàĞ(*
p
) > 90 ) {

471 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

472 
¡16
;

474 
¡16
;

476 
¡16
;

477 
¡0
;

478 
Œ25
:

481 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

483 
¡17
;

484 
Œ29
:

486 { 
	`MARK
(
m¬k
, 
p
); }

487 
¡17
;

488 
¡17
:

489 iàĞ++
p
 =ğ
³
 )

490 
_‹¡_eof17
;

493  (*
p
) ) {

494 10: 
Œ27
;

495 13: 
Œ28
;

496 32: 
Œ29
;

498 
Œ26
;

499 
Œ26
:

501 { 
	`MARK
(
m¬k
, 
p
); }

502 
¡18
;

503 
¡18
:

504 iàĞ++
p
 =ğ
³
 )

505 
_‹¡_eof18
;

508  (*
p
) ) {

509 10: 
Œ31
;

510 13: 
Œ32
;

512 
¡18
;

513 
Œ20
:

516 if(
·r£r
->
h‰p_v”siÚ
 !ğ
NULL
)

517 
·r£r
->
	`h‰p_v”siÚ
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

519 
¡19
;

520 
Œ28
:

522 { 
	`MARK
(
m¬k
, 
p
); }

525 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

526 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

529 
¡19
;

530 
Œ32
:

533 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

534 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

537 
¡19
;

538 
¡19
:

539 iàĞ++
p
 =ğ
³
 )

540 
_‹¡_eof19
;

543 iàĞ(*
p
) == 10 )

544 
¡14
;

545 
¡0
;

546 
Œ10
:

549 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

550 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

552 
¡20
;

553 
Œ43
:

556 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

557 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

561 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

562 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

564 
¡20
;

565 
Œ54
:

567 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

570 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

571 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

575 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

576 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

578 
¡20
;

579 
Œ58
:

582 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

583 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

587 if(
·r£r
->
»que¡_uri
 !ğ
NULL
)

588 
·r£r
->
	`»que¡_uri
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

590 
¡20
;

591 
¡20
:

592 iàĞ++
p
 =ğ
³
 )

593 
_‹¡_eof20
;

596  (*
p
) ) {

597 32: 
Œ35
;

598 37: 
Œ36
;

599 60: 
¡0
;

600 62: 
¡0
;

601 127: 
¡0
;

603 iàĞ(*
p
) > 31 ) {

604 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

605 
¡0
;

606 } iàĞ(*
p
) >= 0 )

607 
¡0
;

608 
Œ34
;

609 
Œ34
:

611 {
	`MARK
(
m¬k
, 
p
); }

612 
¡21
;

613 
¡21
:

614 iàĞ++
p
 =ğ
³
 )

615 
_‹¡_eof21
;

618  (*
p
) ) {

619 32: 
Œ38
;

620 37: 
¡22
;

621 60: 
¡0
;

622 62: 
¡0
;

623 127: 
¡0
;

625 iàĞ(*
p
) > 31 ) {

626 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

627 
¡0
;

628 } iàĞ(*
p
) >= 0 )

629 
¡0
;

630 
¡21
;

631 
Œ36
:

633 {
	`MARK
(
m¬k
, 
p
); }

634 
¡22
;

635 
¡22
:

636 iàĞ++
p
 =ğ
³
 )

637 
_‹¡_eof22
;

640 iàĞ(*
p
) < 65 ) {

641 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

642 
¡23
;

643 } iàĞ(*
p
) > 70 ) {

644 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

645 
¡23
;

647 
¡23
;

648 
¡0
;

649 
¡23
:

650 iàĞ++
p
 =ğ
³
 )

651 
_‹¡_eof23
;

653 iàĞ(*
p
) < 65 ) {

654 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

655 
¡21
;

656 } iàĞ(*
p
) > 70 ) {

657 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

658 
¡21
;

660 
¡21
;

661 
¡0
;

662 
Œ7
:

664 {
	`MARK
(
m¬k
, 
p
); }

665 
¡24
;

666 
¡24
:

667 iàĞ++
p
 =ğ
³
 )

668 
_‹¡_eof24
;

671  (*
p
) ) {

672 32: 
Œ42
;

673 34: 
¡0
;

674 35: 
Œ43
;

675 37: 
¡25
;

676 59: 
Œ45
;

677 60: 
¡0
;

678 62: 
¡0
;

679 63: 
Œ46
;

680 127: 
¡0
;

682 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

683 
¡0
;

684 
¡24
;

685 
¡25
:

686 iàĞ++
p
 =ğ
³
 )

687 
_‹¡_eof25
;

689 iàĞ(*
p
) < 65 ) {

690 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

691 
¡26
;

692 } iàĞ(*
p
) > 70 ) {

693 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

694 
¡26
;

696 
¡26
;

697 
¡0
;

698 
¡26
:

699 iàĞ++
p
 =ğ
³
 )

700 
_‹¡_eof26
;

702 iàĞ(*
p
) < 65 ) {

703 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

704 
¡24
;

705 } iàĞ(*
p
) > 70 ) {

706 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

707 
¡24
;

709 
¡24
;

710 
¡0
;

711 
Œ45
:

714 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

715 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

717 
¡27
;

718 
¡27
:

719 iàĞ++
p
 =ğ
³
 )

720 
_‹¡_eof27
;

723  (*
p
) ) {

724 32: 
Œ9
;

725 34: 
¡0
;

726 35: 
Œ10
;

727 37: 
¡28
;

728 60: 
¡0
;

729 62: 
¡0
;

730 63: 
¡30
;

731 127: 
¡0
;

733 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

734 
¡0
;

735 
¡27
;

736 
¡28
:

737 iàĞ++
p
 =ğ
³
 )

738 
_‹¡_eof28
;

740 iàĞ(*
p
) < 65 ) {

741 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

742 
¡29
;

743 } iàĞ(*
p
) > 70 ) {

744 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

745 
¡29
;

747 
¡29
;

748 
¡0
;

749 
¡29
:

750 iàĞ++
p
 =ğ
³
 )

751 
_‹¡_eof29
;

753 iàĞ(*
p
) < 65 ) {

754 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

755 
¡27
;

756 } iàĞ(*
p
) > 70 ) {

757 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

758 
¡27
;

760 
¡27
;

761 
¡0
;

762 
Œ46
:

765 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

766 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

768 
¡30
;

769 
¡30
:

770 iàĞ++
p
 =ğ
³
 )

771 
_‹¡_eof30
;

774  (*
p
) ) {

775 32: 
Œ53
;

776 34: 
¡0
;

777 35: 
Œ54
;

778 37: 
Œ55
;

779 60: 
¡0
;

780 62: 
¡0
;

781 127: 
¡0
;

783 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

784 
¡0
;

785 
Œ52
;

786 
Œ52
:

788 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

789 
¡31
;

790 
¡31
:

791 iàĞ++
p
 =ğ
³
 )

792 
_‹¡_eof31
;

795  (*
p
) ) {

796 32: 
Œ57
;

797 34: 
¡0
;

798 35: 
Œ58
;

799 37: 
¡32
;

800 60: 
¡0
;

801 62: 
¡0
;

802 127: 
¡0
;

804 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

805 
¡0
;

806 
¡31
;

807 
Œ55
:

809 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

810 
¡32
;

811 
¡32
:

812 iàĞ++
p
 =ğ
³
 )

813 
_‹¡_eof32
;

816 iàĞ(*
p
) < 65 ) {

817 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

818 
¡33
;

819 } iàĞ(*
p
) > 70 ) {

820 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

821 
¡33
;

823 
¡33
;

824 
¡0
;

825 
¡33
:

826 iàĞ++
p
 =ğ
³
 )

827 
_‹¡_eof33
;

829 iàĞ(*
p
) < 65 ) {

830 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

831 
¡31
;

832 } iàĞ(*
p
) > 70 ) {

833 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

834 
¡31
;

836 
¡31
;

837 
¡0
;

838 
Œ8
:

840 {
	`MARK
(
m¬k
, 
p
); }

841 
¡34
;

842 
¡34
:

843 iàĞ++
p
 =ğ
³
 )

844 
_‹¡_eof34
;

847 iàĞ(*
p
) == 116 )

848 
¡35
;

849 
¡0
;

850 
¡35
:

851 iàĞ++
p
 =ğ
³
 )

852 
_‹¡_eof35
;

854 iàĞ(*
p
) == 116 )

855 
¡36
;

856 
¡0
;

857 
¡36
:

858 iàĞ++
p
 =ğ
³
 )

859 
_‹¡_eof36
;

861 iàĞ(*
p
) == 112 )

862 
¡37
;

863 
¡0
;

864 
¡37
:

865 iàĞ++
p
 =ğ
³
 )

866 
_‹¡_eof37
;

868 iàĞ(*
p
) == 58 )

869 
¡38
;

870 
¡0
;

871 
¡38
:

872 iàĞ++
p
 =ğ
³
 )

873 
_‹¡_eof38
;

875  (*
p
) ) {

876 32: 
Œ9
;

877 34: 
¡0
;

878 35: 
Œ10
;

879 37: 
¡39
;

880 60: 
¡0
;

881 62: 
¡0
;

882 127: 
¡0
;

884 iàĞ0 <ğ(*
p
) && (*p) <= 31 )

885 
¡0
;

886 
¡38
;

887 
¡39
:

888 iàĞ++
p
 =ğ
³
 )

889 
_‹¡_eof39
;

891 iàĞ(*
p
) < 65 ) {

892 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

893 
¡40
;

894 } iàĞ(*
p
) > 70 ) {

895 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

896 
¡40
;

898 
¡40
;

899 
¡0
;

900 
¡40
:

901 iàĞ++
p
 =ğ
³
 )

902 
_‹¡_eof40
;

904 iàĞ(*
p
) < 65 ) {

905 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

906 
¡38
;

907 } iàĞ(*
p
) > 70 ) {

908 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

909 
¡38
;

911 
¡38
;

912 
¡0
;

913 
¡41
:

914 iàĞ++
p
 =ğ
³
 )

915 
_‹¡_eof41
;

917  (*
p
) ) {

918 32: 
Œ4
;

919 36: 
¡42
;

920 95: 
¡42
;

922 iàĞ(*
p
) < 48 ) {

923 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

924 
¡42
;

925 } iàĞ(*
p
) > 57 ) {

926 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

927 
¡42
;

929 
¡42
;

930 
¡0
;

931 
¡42
:

932 iàĞ++
p
 =ğ
³
 )

933 
_‹¡_eof42
;

935  (*
p
) ) {

936 32: 
Œ4
;

937 36: 
¡43
;

938 95: 
¡43
;

940 iàĞ(*
p
) < 48 ) {

941 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

942 
¡43
;

943 } iàĞ(*
p
) > 57 ) {

944 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

945 
¡43
;

947 
¡43
;

948 
¡0
;

949 
¡43
:

950 iàĞ++
p
 =ğ
³
 )

951 
_‹¡_eof43
;

953  (*
p
) ) {

954 32: 
Œ4
;

955 36: 
¡44
;

956 95: 
¡44
;

958 iàĞ(*
p
) < 48 ) {

959 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

960 
¡44
;

961 } iàĞ(*
p
) > 57 ) {

962 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

963 
¡44
;

965 
¡44
;

966 
¡0
;

967 
¡44
:

968 iàĞ++
p
 =ğ
³
 )

969 
_‹¡_eof44
;

971  (*
p
) ) {

972 32: 
Œ4
;

973 36: 
¡45
;

974 95: 
¡45
;

976 iàĞ(*
p
) < 48 ) {

977 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

978 
¡45
;

979 } iàĞ(*
p
) > 57 ) {

980 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

981 
¡45
;

983 
¡45
;

984 
¡0
;

985 
¡45
:

986 iàĞ++
p
 =ğ
³
 )

987 
_‹¡_eof45
;

989  (*
p
) ) {

990 32: 
Œ4
;

991 36: 
¡46
;

992 95: 
¡46
;

994 iàĞ(*
p
) < 48 ) {

995 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

996 
¡46
;

997 } iàĞ(*
p
) > 57 ) {

998 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

999 
¡46
;

1001 
¡46
;

1002 
¡0
;

1003 
¡46
:

1004 iàĞ++
p
 =ğ
³
 )

1005 
_‹¡_eof46
;

1007  (*
p
) ) {

1008 32: 
Œ4
;

1009 36: 
¡47
;

1010 95: 
¡47
;

1012 iàĞ(*
p
) < 48 ) {

1013 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1014 
¡47
;

1015 } iàĞ(*
p
) > 57 ) {

1016 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1017 
¡47
;

1019 
¡47
;

1020 
¡0
;

1021 
¡47
:

1022 iàĞ++
p
 =ğ
³
 )

1023 
_‹¡_eof47
;

1025  (*
p
) ) {

1026 32: 
Œ4
;

1027 36: 
¡48
;

1028 95: 
¡48
;

1030 iàĞ(*
p
) < 48 ) {

1031 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1032 
¡48
;

1033 } iàĞ(*
p
) > 57 ) {

1034 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1035 
¡48
;

1037 
¡48
;

1038 
¡0
;

1039 
¡48
:

1040 iàĞ++
p
 =ğ
³
 )

1041 
_‹¡_eof48
;

1043  (*
p
) ) {

1044 32: 
Œ4
;

1045 36: 
¡49
;

1046 95: 
¡49
;

1048 iàĞ(*
p
) < 48 ) {

1049 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1050 
¡49
;

1051 } iàĞ(*
p
) > 57 ) {

1052 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1053 
¡49
;

1055 
¡49
;

1056 
¡0
;

1057 
¡49
:

1058 iàĞ++
p
 =ğ
³
 )

1059 
_‹¡_eof49
;

1061  (*
p
) ) {

1062 32: 
Œ4
;

1063 36: 
¡50
;

1064 95: 
¡50
;

1066 iàĞ(*
p
) < 48 ) {

1067 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1068 
¡50
;

1069 } iàĞ(*
p
) > 57 ) {

1070 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1071 
¡50
;

1073 
¡50
;

1074 
¡0
;

1075 
¡50
:

1076 iàĞ++
p
 =ğ
³
 )

1077 
_‹¡_eof50
;

1079  (*
p
) ) {

1080 32: 
Œ4
;

1081 36: 
¡51
;

1082 95: 
¡51
;

1084 iàĞ(*
p
) < 48 ) {

1085 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1086 
¡51
;

1087 } iàĞ(*
p
) > 57 ) {

1088 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1089 
¡51
;

1091 
¡51
;

1092 
¡0
;

1093 
¡51
:

1094 iàĞ++
p
 =ğ
³
 )

1095 
_‹¡_eof51
;

1097  (*
p
) ) {

1098 32: 
Œ4
;

1099 36: 
¡52
;

1100 95: 
¡52
;

1102 iàĞ(*
p
) < 48 ) {

1103 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1104 
¡52
;

1105 } iàĞ(*
p
) > 57 ) {

1106 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1107 
¡52
;

1109 
¡52
;

1110 
¡0
;

1111 
¡52
:

1112 iàĞ++
p
 =ğ
³
 )

1113 
_‹¡_eof52
;

1115  (*
p
) ) {

1116 32: 
Œ4
;

1117 36: 
¡53
;

1118 95: 
¡53
;

1120 iàĞ(*
p
) < 48 ) {

1121 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1122 
¡53
;

1123 } iàĞ(*
p
) > 57 ) {

1124 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1125 
¡53
;

1127 
¡53
;

1128 
¡0
;

1129 
¡53
:

1130 iàĞ++
p
 =ğ
³
 )

1131 
_‹¡_eof53
;

1133  (*
p
) ) {

1134 32: 
Œ4
;

1135 36: 
¡54
;

1136 95: 
¡54
;

1138 iàĞ(*
p
) < 48 ) {

1139 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1140 
¡54
;

1141 } iàĞ(*
p
) > 57 ) {

1142 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1143 
¡54
;

1145 
¡54
;

1146 
¡0
;

1147 
¡54
:

1148 iàĞ++
p
 =ğ
³
 )

1149 
_‹¡_eof54
;

1151  (*
p
) ) {

1152 32: 
Œ4
;

1153 36: 
¡55
;

1154 95: 
¡55
;

1156 iàĞ(*
p
) < 48 ) {

1157 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1158 
¡55
;

1159 } iàĞ(*
p
) > 57 ) {

1160 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1161 
¡55
;

1163 
¡55
;

1164 
¡0
;

1165 
¡55
:

1166 iàĞ++
p
 =ğ
³
 )

1167 
_‹¡_eof55
;

1169  (*
p
) ) {

1170 32: 
Œ4
;

1171 36: 
¡56
;

1172 95: 
¡56
;

1174 iàĞ(*
p
) < 48 ) {

1175 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1176 
¡56
;

1177 } iàĞ(*
p
) > 57 ) {

1178 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1179 
¡56
;

1181 
¡56
;

1182 
¡0
;

1183 
¡56
:

1184 iàĞ++
p
 =ğ
³
 )

1185 
_‹¡_eof56
;

1187  (*
p
) ) {

1188 32: 
Œ4
;

1189 36: 
¡57
;

1190 95: 
¡57
;

1192 iàĞ(*
p
) < 48 ) {

1193 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1194 
¡57
;

1195 } iàĞ(*
p
) > 57 ) {

1196 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1197 
¡57
;

1199 
¡57
;

1200 
¡0
;

1201 
¡57
:

1202 iàĞ++
p
 =ğ
³
 )

1203 
_‹¡_eof57
;

1205  (*
p
) ) {

1206 32: 
Œ4
;

1207 36: 
¡58
;

1208 95: 
¡58
;

1210 iàĞ(*
p
) < 48 ) {

1211 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1212 
¡58
;

1213 } iàĞ(*
p
) > 57 ) {

1214 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1215 
¡58
;

1217 
¡58
;

1218 
¡0
;

1219 
¡58
:

1220 iàĞ++
p
 =ğ
³
 )

1221 
_‹¡_eof58
;

1223  (*
p
) ) {

1224 32: 
Œ4
;

1225 36: 
¡59
;

1226 95: 
¡59
;

1228 iàĞ(*
p
) < 48 ) {

1229 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1230 
¡59
;

1231 } iàĞ(*
p
) > 57 ) {

1232 iàĞ65 <ğ(*
p
) && (*p) <= 90 )

1233 
¡59
;

1235 
¡59
;

1236 
¡0
;

1237 
¡59
:

1238 iàĞ++
p
 =ğ
³
 )

1239 
_‹¡_eof59
;

1241 iàĞ(*
p
) == 32 )

1242 
Œ4
;

1243 
¡0
;

1244 
Œ2
:

1246 {
	`MARK
(
m¬k
, 
p
); }

1247 
¡60
;

1248 
¡60
:

1249 iàĞ++
p
 =ğ
³
 )

1250 
_‹¡_eof60
;

1253 iàĞ(*
p
) < 48 ) {

1254 iàĞ45 <ğ(*
p
) && (*p) <= 46 )

1255 
¡61
;

1256 } iàĞ(*
p
) > 57 ) {

1257 iàĞ(*
p
) > 90 ) {

1258 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

1259 
¡61
;

1260 } iàĞ(*
p
) >= 65 )

1261 
¡61
;

1263 
¡61
;

1264 
¡0
;

1265 
¡61
:

1266 iàĞ++
p
 =ğ
³
 )

1267 
_‹¡_eof61
;

1269  (*
p
) ) {

1270 32: 
Œ86
;

1271 47: 
Œ86
;

1272 62: 
Œ86
;

1274 iàĞ(*
p
) < 45 ) {

1275 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1276 
Œ86
;

1277 } iàĞ(*
p
) > 57 ) {

1278 iàĞ(*
p
) > 90 ) {

1279 iàĞ97 <ğ(*
p
) && (*p) <= 122 )

1280 
¡61
;

1281 } iàĞ(*
p
) >= 65 )

1282 
¡61
;

1284 
¡61
;

1285 
¡0
;

1286 
Œ86
:

1289 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1290 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1292 
¡62
;

1293 
¡62
:

1294 iàĞ++
p
 =ğ
³
 )

1295 
_‹¡_eof62
;

1298 iàĞ(*
p
) == 62 )

1299 
¡63
;

1300 
¡62
;

1301 
¡63
:

1302 iàĞ++
p
 =ğ
³
 )

1303 
_‹¡_eof63
;

1305  (*
p
) ) {

1306 0: 
Œ89
;

1307 62: 
¡63
;

1309 
¡62
;

1310 
Œ3
:

1312 {
	`MARK
(
m¬k
, 
p
); }

1313 
¡64
;

1314 
¡64
:

1315 iàĞ++
p
 =ğ
³
 )

1316 
_‹¡_eof64
;

1319  (*
p
) ) {

1320 32: 
Œ91
;

1321 37: 
¡69
;

1322 47: 
¡0
;

1323 59: 
Œ93
;

1324 60: 
¡0
;

1325 62: 
¡0
;

1326 63: 
Œ94
;

1327 127: 
¡0
;

1329 iàĞ(*
p
) > 31 ) {

1330 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1331 
¡0
;

1332 } iàĞ(*
p
) >= 0 )

1333 
¡0
;

1334 
¡65
;

1335 
¡65
:

1336 iàĞ++
p
 =ğ
³
 )

1337 
_‹¡_eof65
;

1339  (*
p
) ) {

1340 32: 
Œ91
;

1341 37: 
¡69
;

1342 59: 
Œ93
;

1343 60: 
¡0
;

1344 62: 
¡0
;

1345 63: 
Œ94
;

1346 127: 
¡0
;

1348 iàĞ(*
p
) > 31 ) {

1349 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1350 
¡0
;

1351 } iàĞ(*
p
) >= 0 )

1352 
¡0
;

1353 
¡65
;

1354 
Œ91
:

1357 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1358 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1360 
¡66
;

1361 
Œ105
:

1363 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

1366 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

1367 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

1371 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1372 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1374 
¡66
;

1375 
Œ108
:

1378 if(
·r£r
->
qu”y_¡ršg
 !ğ
NULL
)

1379 
·r£r
->
	`qu”y_¡ršg
Õ¬£r->
d©a
, 
	`PTR_TO
(
qu”y_¡¬t
), 
	`LEN
(qu”y_¡¬t, 
p
));

1383 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1384 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1386 
¡66
;

1387 
¡66
:

1388 iàĞ++
p
 =ğ
³
 )

1389 
_‹¡_eof66
;

1392 iàĞ(*
p
) == 123 )

1393 
Œ95
;

1394 
¡0
;

1395 
Œ95
:

1397 {
	`MARK
(
m¬k
, 
p
); }

1398 
¡67
;

1399 
¡67
:

1400 iàĞ++
p
 =ğ
³
 )

1401 
_‹¡_eof67
;

1404 iàĞ(*
p
) == 125 )

1405 
¡68
;

1406 
¡67
;

1407 
¡68
:

1408 iàĞ++
p
 =ğ
³
 )

1409 
_‹¡_eof68
;

1411  (*
p
) ) {

1412 0: 
Œ98
;

1413 125: 
¡68
;

1415 
¡67
;

1416 
¡69
:

1417 iàĞ++
p
 =ğ
³
 )

1418 
_‹¡_eof69
;

1420 iàĞ(*
p
) < 65 ) {

1421 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1422 
¡70
;

1423 } iàĞ(*
p
) > 70 ) {

1424 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1425 
¡70
;

1427 
¡70
;

1428 
¡0
;

1429 
¡70
:

1430 iàĞ++
p
 =ğ
³
 )

1431 
_‹¡_eof70
;

1433 iàĞ(*
p
) < 65 ) {

1434 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1435 
¡65
;

1436 } iàĞ(*
p
) > 70 ) {

1437 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1438 
¡65
;

1440 
¡65
;

1441 
¡0
;

1442 
Œ93
:

1445 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1446 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1448 
¡71
;

1449 
¡71
:

1450 iàĞ++
p
 =ğ
³
 )

1451 
_‹¡_eof71
;

1454  (*
p
) ) {

1455 32: 
Œ91
;

1456 37: 
¡72
;

1457 60: 
¡0
;

1458 62: 
¡0
;

1459 63: 
¡74
;

1460 127: 
¡0
;

1462 iàĞ(*
p
) > 31 ) {

1463 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1464 
¡0
;

1465 } iàĞ(*
p
) >= 0 )

1466 
¡0
;

1467 
¡71
;

1468 
¡72
:

1469 iàĞ++
p
 =ğ
³
 )

1470 
_‹¡_eof72
;

1472 iàĞ(*
p
) < 65 ) {

1473 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1474 
¡73
;

1475 } iàĞ(*
p
) > 70 ) {

1476 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1477 
¡73
;

1479 
¡73
;

1480 
¡0
;

1481 
¡73
:

1482 iàĞ++
p
 =ğ
³
 )

1483 
_‹¡_eof73
;

1485 iàĞ(*
p
) < 65 ) {

1486 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1487 
¡71
;

1488 } iàĞ(*
p
) > 70 ) {

1489 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1490 
¡71
;

1492 
¡71
;

1493 
¡0
;

1494 
Œ94
:

1497 if(
·r£r
->
»que¡_·th
 !ğ
NULL
)

1498 
·r£r
->
	`»que¡_·th
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k,
p
));

1500 
¡74
;

1501 
¡74
:

1502 iàĞ++
p
 =ğ
³
 )

1503 
_‹¡_eof74
;

1506  (*
p
) ) {

1507 32: 
Œ105
;

1508 37: 
Œ106
;

1509 60: 
¡0
;

1510 62: 
¡0
;

1511 127: 
¡0
;

1513 iàĞ(*
p
) > 31 ) {

1514 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1515 
¡0
;

1516 } iàĞ(*
p
) >= 0 )

1517 
¡0
;

1518 
Œ104
;

1519 
Œ104
:

1521 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

1522 
¡75
;

1523 
¡75
:

1524 iàĞ++
p
 =ğ
³
 )

1525 
_‹¡_eof75
;

1528  (*
p
) ) {

1529 32: 
Œ108
;

1530 37: 
¡76
;

1531 60: 
¡0
;

1532 62: 
¡0
;

1533 127: 
¡0
;

1535 iàĞ(*
p
) > 31 ) {

1536 iàĞ34 <ğ(*
p
) && (*p) <= 35 )

1537 
¡0
;

1538 } iàĞ(*
p
) >= 0 )

1539 
¡0
;

1540 
¡75
;

1541 
Œ106
:

1543 {
	`MARK
(
qu”y_¡¬t
, 
p
); }

1544 
¡76
;

1545 
¡76
:

1546 iàĞ++
p
 =ğ
³
 )

1547 
_‹¡_eof76
;

1550 iàĞ(*
p
) < 65 ) {

1551 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1552 
¡77
;

1553 } iàĞ(*
p
) > 70 ) {

1554 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1555 
¡77
;

1557 
¡77
;

1558 
¡0
;

1559 
¡77
:

1560 iàĞ++
p
 =ğ
³
 )

1561 
_‹¡_eof77
;

1563 iàĞ(*
p
) < 65 ) {

1564 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1565 
¡75
;

1566 } iàĞ(*
p
) > 70 ) {

1567 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

1568 
¡75
;

1570 
¡75
;

1571 
¡0
;

1573 
_‹¡_eof2
: 
cs
 = 2; 
_‹¡_eof
;

1574 
_‹¡_eof3
: 
cs
 = 3; 
_‹¡_eof
;

1575 
_‹¡_eof4
: 
cs
 = 4; 
_‹¡_eof
;

1576 
_‹¡_eof5
: 
cs
 = 5; 
_‹¡_eof
;

1577 
_‹¡_eof6
: 
cs
 = 6; 
_‹¡_eof
;

1578 
_‹¡_eof7
: 
cs
 = 7; 
_‹¡_eof
;

1579 
_‹¡_eof8
: 
cs
 = 8; 
_‹¡_eof
;

1580 
_‹¡_eof9
: 
cs
 = 9; 
_‹¡_eof
;

1581 
_‹¡_eof10
: 
cs
 = 10; 
_‹¡_eof
;

1582 
_‹¡_eof11
: 
cs
 = 11; 
_‹¡_eof
;

1583 
_‹¡_eof12
: 
cs
 = 12; 
_‹¡_eof
;

1584 
_‹¡_eof13
: 
cs
 = 13; 
_‹¡_eof
;

1585 
_‹¡_eof14
: 
cs
 = 14; 
_‹¡_eof
;

1586 
_‹¡_eof78
: 
cs
 = 78; 
_‹¡_eof
;

1587 
_‹¡_eof15
: 
cs
 = 15; 
_‹¡_eof
;

1588 
_‹¡_eof16
: 
cs
 = 16; 
_‹¡_eof
;

1589 
_‹¡_eof17
: 
cs
 = 17; 
_‹¡_eof
;

1590 
_‹¡_eof18
: 
cs
 = 18; 
_‹¡_eof
;

1591 
_‹¡_eof19
: 
cs
 = 19; 
_‹¡_eof
;

1592 
_‹¡_eof20
: 
cs
 = 20; 
_‹¡_eof
;

1593 
_‹¡_eof21
: 
cs
 = 21; 
_‹¡_eof
;

1594 
_‹¡_eof22
: 
cs
 = 22; 
_‹¡_eof
;

1595 
_‹¡_eof23
: 
cs
 = 23; 
_‹¡_eof
;

1596 
_‹¡_eof24
: 
cs
 = 24; 
_‹¡_eof
;

1597 
_‹¡_eof25
: 
cs
 = 25; 
_‹¡_eof
;

1598 
_‹¡_eof26
: 
cs
 = 26; 
_‹¡_eof
;

1599 
_‹¡_eof27
: 
cs
 = 27; 
_‹¡_eof
;

1600 
_‹¡_eof28
: 
cs
 = 28; 
_‹¡_eof
;

1601 
_‹¡_eof29
: 
cs
 = 29; 
_‹¡_eof
;

1602 
_‹¡_eof30
: 
cs
 = 30; 
_‹¡_eof
;

1603 
_‹¡_eof31
: 
cs
 = 31; 
_‹¡_eof
;

1604 
_‹¡_eof32
: 
cs
 = 32; 
_‹¡_eof
;

1605 
_‹¡_eof33
: 
cs
 = 33; 
_‹¡_eof
;

1606 
_‹¡_eof34
: 
cs
 = 34; 
_‹¡_eof
;

1607 
_‹¡_eof35
: 
cs
 = 35; 
_‹¡_eof
;

1608 
_‹¡_eof36
: 
cs
 = 36; 
_‹¡_eof
;

1609 
_‹¡_eof37
: 
cs
 = 37; 
_‹¡_eof
;

1610 
_‹¡_eof38
: 
cs
 = 38; 
_‹¡_eof
;

1611 
_‹¡_eof39
: 
cs
 = 39; 
_‹¡_eof
;

1612 
_‹¡_eof40
: 
cs
 = 40; 
_‹¡_eof
;

1613 
_‹¡_eof41
: 
cs
 = 41; 
_‹¡_eof
;

1614 
_‹¡_eof42
: 
cs
 = 42; 
_‹¡_eof
;

1615 
_‹¡_eof43
: 
cs
 = 43; 
_‹¡_eof
;

1616 
_‹¡_eof44
: 
cs
 = 44; 
_‹¡_eof
;

1617 
_‹¡_eof45
: 
cs
 = 45; 
_‹¡_eof
;

1618 
_‹¡_eof46
: 
cs
 = 46; 
_‹¡_eof
;

1619 
_‹¡_eof47
: 
cs
 = 47; 
_‹¡_eof
;

1620 
_‹¡_eof48
: 
cs
 = 48; 
_‹¡_eof
;

1621 
_‹¡_eof49
: 
cs
 = 49; 
_‹¡_eof
;

1622 
_‹¡_eof50
: 
cs
 = 50; 
_‹¡_eof
;

1623 
_‹¡_eof51
: 
cs
 = 51; 
_‹¡_eof
;

1624 
_‹¡_eof52
: 
cs
 = 52; 
_‹¡_eof
;

1625 
_‹¡_eof53
: 
cs
 = 53; 
_‹¡_eof
;

1626 
_‹¡_eof54
: 
cs
 = 54; 
_‹¡_eof
;

1627 
_‹¡_eof55
: 
cs
 = 55; 
_‹¡_eof
;

1628 
_‹¡_eof56
: 
cs
 = 56; 
_‹¡_eof
;

1629 
_‹¡_eof57
: 
cs
 = 57; 
_‹¡_eof
;

1630 
_‹¡_eof58
: 
cs
 = 58; 
_‹¡_eof
;

1631 
_‹¡_eof59
: 
cs
 = 59; 
_‹¡_eof
;

1632 
_‹¡_eof60
: 
cs
 = 60; 
_‹¡_eof
;

1633 
_‹¡_eof61
: 
cs
 = 61; 
_‹¡_eof
;

1634 
_‹¡_eof62
: 
cs
 = 62; 
_‹¡_eof
;

1635 
_‹¡_eof63
: 
cs
 = 63; 
_‹¡_eof
;

1636 
_‹¡_eof64
: 
cs
 = 64; 
_‹¡_eof
;

1637 
_‹¡_eof65
: 
cs
 = 65; 
_‹¡_eof
;

1638 
_‹¡_eof66
: 
cs
 = 66; 
_‹¡_eof
;

1639 
_‹¡_eof67
: 
cs
 = 67; 
_‹¡_eof
;

1640 
_‹¡_eof68
: 
cs
 = 68; 
_‹¡_eof
;

1641 
_‹¡_eof69
: 
cs
 = 69; 
_‹¡_eof
;

1642 
_‹¡_eof70
: 
cs
 = 70; 
_‹¡_eof
;

1643 
_‹¡_eof71
: 
cs
 = 71; 
_‹¡_eof
;

1644 
_‹¡_eof72
: 
cs
 = 72; 
_‹¡_eof
;

1645 
_‹¡_eof73
: 
cs
 = 73; 
_‹¡_eof
;

1646 
_‹¡_eof74
: 
cs
 = 74; 
_‹¡_eof
;

1647 
_‹¡_eof75
: 
cs
 = 75; 
_‹¡_eof
;

1648 
_‹¡_eof76
: 
cs
 = 76; 
_‹¡_eof
;

1649 
_‹¡_eof77
: 
cs
 = 77; 
_‹¡_eof
;

1651 
_‹¡_eof
: {}

1652 
_out
: {}

1657 
	`as£¹
(
p
 <ğ
³
 && "Buffer overflow‡fter…arsing.");

1659 ià(!
	`h‰p_·r£r_has_”rÜ
(
·r£r
)) {

1660 
·r£r
->
cs
 = cs;

1663 
·r£r
->
Ä—d
 +ğ
p
 - (
bufãr
 + 
off
);

1665 
	`as£¹
(
·r£r
->
Ä—d
 <ğ
Ën
 && "nread†ongerhan†ength");

1666 
	`as£¹
(
·r£r
->
body_¡¬t
 <ğ
Ën
 && "body starts‡fter bufferƒnd");

1667 
	`as£¹
(
·r£r
->
m¬k
 < 
Ën
 && "mark is‡fter bufferƒnd");

1668 
	`as£¹
(
·r£r
->
f›ld_Ën
 <ğ
Ën
 && "field has†ength†ongerhan whole buffer");

1669 
	`as£¹
(
·r£r
->
f›ld_¡¬t
 < 
Ën
 && "field starts‡fter bufferƒnd");

1671 (
·r£r
->
Ä—d
);

1672 
	}
}

1674 
	$h‰p_·r£r_fšish
(
h‰p_·r£r
 *
·r£r
)

1676 ià(
	`h‰p_·r£r_has_”rÜ
(
·r£r
) ) {

1678 } ià(
	`h‰p_·r£r_is_fšished
(
·r£r
) ) {

1683 
	}
}

1685 
	$h‰p_·r£r_has_”rÜ
(
h‰p_·r£r
 *
·r£r
) {

1686  
·r£r
->
cs
 =ğ
h‰p_·r£r_”rÜ
;

1687 
	}
}

1689 
	$h‰p_·r£r_is_fšished
(
h‰p_·r£r
 *
·r£r
) {

1690  
·r£r
->
cs
 >ğ
h‰p_·r£r_fœ¡_fš®
;

1691 
	}
}

	@tools/src/http11/http11_parser.h

2 #iâdeà
h‰p11_·r£r_h


3 
	#h‰p11_·r£r_h


	)

5 
	~<h‰p11/h‰p11_commÚ.h
>

7 
	sh‰p_·r£r
 {

8 
	mcs
;

9 
size_t
 
	mbody_¡¬t
;

10 
	mcÚ‹Á_Ën
;

11 
size_t
 
	mÄ—d
;

12 
size_t
 
	mm¬k
;

13 
size_t
 
	mf›ld_¡¬t
;

14 
size_t
 
	mf›ld_Ën
;

15 
size_t
 
	mqu”y_¡¬t
;

16 
	mxml_£Á
;

17 
	mjsÚ_£Á
;

19 *
	md©a
;

21 
f›ld_cb
 
	mh‰p_f›ld
;

22 
–em’t_cb
 
	m»que¡_m‘hod
;

23 
–em’t_cb
 
	m»que¡_uri
;

24 
–em’t_cb
 
	mäagm’t
;

25 
–em’t_cb
 
	m»que¡_·th
;

26 
–em’t_cb
 
	mqu”y_¡ršg
;

27 
–em’t_cb
 
	mh‰p_v”siÚ
;

28 
–em’t_cb
 
	mh—d”_dÚe
;

30 } 
	th‰p_·r£r
;

32 
h‰p_·r£r_š™
(
h‰p_·r£r
 *
·r£r
);

33 
h‰p_·r£r_fšish
(
h‰p_·r£r
 *
·r£r
);

34 
size_t
 
h‰p_·r£r_execu‹
(
h‰p_·r£r
 *
·r£r
, cÚ¡ *
d©a
, size_ˆ
Ën
, size_ˆ
off
);

35 
h‰p_·r£r_has_”rÜ
(
h‰p_·r£r
 *
·r£r
);

36 
h‰p_·r£r_is_fšished
(
h‰p_·r£r
 *
·r£r
);

38 
	#h‰p_·r£r_Ä—d
(
·r£r
èÕ¬£r)->
Ä—d


	)

	@tools/src/http11/httpclient_parser.c

37 
	~"h‰pş›Á_·r£r.h
"

38 
	~<¡dio.h
>

39 
	~<as£¹.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~"dbg.h
"

45 
	#LEN
(
AT
, 
FPC
è(FPC - 
bufãr
 - 
·r£r
->AT)

	)

46 
	#MARK
(
M
,
FPC
è(
·r£r
->M = (FPCè- 
bufãr
)

	)

47 
	#PTR_TO
(
F
è(
bufãr
 + 
·r£r
->F)

	)

58 cÚ¡ 
	gh‰pş›Á_·r£r_¡¬t
 = 1;

59 cÚ¡ 
	gh‰pş›Á_·r£r_fœ¡_fš®
 = 120;

60 cÚ¡ 
	gh‰pş›Á_·r£r_”rÜ
 = 0;

62 cÚ¡ 
	gh‰pş›Á_·r£r_’_maš
 = 1;

67 
	$h‰pş›Á_·r£r_š™
(
h‰pş›Á_·r£r
 *
·r£r
) {

68 
cs
 = 0;

73 
cs
 = 
h‰pş›Á_·r£r_¡¬t
;

78 
·r£r
->
cs
 = cs;

79 
·r£r
->
body_¡¬t
 = 0;

80 
·r£r
->
cÚ‹Á_Ën
 = -1;

81 
·r£r
->
chunked
 = 0;

82 
·r£r
->
chunks_dÚe
 = 0;

83 
·r£r
->
m¬k
 = 0;

84 
·r£r
->
Ä—d
 = 0;

85 
·r£r
->
f›ld_Ën
 = 0;

86 
·r£r
->
f›ld_¡¬t
 = 0;

87 
·r£r
->
şo£
 = 0;

90 
	}
}

94 
	$h‰pş›Á_·r£r_execu‹
(
h‰pş›Á_·r£r
 *
·r£r
, cÚ¡ *
bufãr
, 
size_t
 
Ën
, size_ˆ
off
)

96 cÚ¡ *
p
, *
³
;

97 
cs
 = 
·r£r
->cs;

99 
	`as£¹
(
off
 <ğ
Ën
 && "offset…astƒnd of buffer");

101 
p
 = 
bufãr
+
off
;

102 
³
 = 
bufãr
+
Ën
;

104 
	`as£¹
(*
³
 == '\0' && "pointer does‚otƒnd on NUL");

105 
	`as£¹
(
³
 - 
p
 =ğ()
Ën
 - ()
off
 && "pointers‡ren't same distance");

111 iàĞ
p
 =ğ
³
 )

112 
_‹¡_eof
;

113  
cs
 )

116 iàĞ(*
p
) == 72 )

117 
Œ2
;

118 iàĞ(*
p
) < 65 ) {

119 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

120 
Œ0
;

121 } iàĞ(*
p
) > 70 ) {

122 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

123 
Œ0
;

125 
Œ0
;

126 
¡0
;

127 
¡0
:

128 
cs
 = 0;

129 
_out
;

130 
Œ0
:

132 {
	`MARK
(
m¬k
, 
p
); }

133 
¡2
;

134 
¡2
:

135 iàĞ++
p
 =ğ
³
 )

136 
_‹¡_eof2
;

139  (*
p
) ) {

140 10: 
Œ3
;

141 13: 
Œ4
;

142 59: 
Œ6
;

144 iàĞ(*
p
) < 65 ) {

145 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

146 
¡2
;

147 } iàĞ(*
p
) > 70 ) {

148 iàĞ97 <ğ(*
p
) && (*p) <= 102 )

149 
¡2
;

151 
¡2
;

152 
¡0
;

153 
Œ3
:

156 
·r£r
->
chunked
 = 1;

157 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 16);

158 
·r£r
->
chunks_dÚe
 =…¬£r->
cÚ‹Á_Ën
 <= 0;

160 if(
·r£r
->
chunks_dÚe
 &&…¬£r->
Ï¡_chunk
) {

161 
·r£r
->
	`Ï¡_chunk
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

162 } if(
·r£r
->
chunk_size
 !ğ
NULL
) {

163 
·r£r
->
	`chunk_size
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

168 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

169 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

170 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

171 {
p
++; 
cs
 = 120; 
_out
;}

173 
¡120
;

174 
Œ7
:

177 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

178 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

179 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

180 {
p
++; 
cs
 = 120; 
_out
;}

182 
¡120
;

183 
Œ9
:

186 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

189 { 
	`MARK
(
m¬k
, 
p
); }

192 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

193 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

198 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

199 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

200 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

201 {
p
++; 
cs
 = 120; 
_out
;}

203 
¡120
;

204 
Œ15
:

207 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

208 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

213 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

214 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

215 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

216 {
p
++; 
cs
 = 120; 
_out
;}

218 
¡120
;

219 
Œ74
:

222 
·r£r
->
şo£
 = 1;

226 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

227 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

228 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

229 {
p
++; 
cs
 = 120; 
_out
;}

231 
¡120
;

232 
¡120
:

233 iàĞ++
p
 =ğ
³
 )

234 
_‹¡_eof120
;

237 
¡0
;

238 
Œ4
:

241 
·r£r
->
chunked
 = 1;

242 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 16);

243 
·r£r
->
chunks_dÚe
 =…¬£r->
cÚ‹Á_Ën
 <= 0;

245 if(
·r£r
->
chunks_dÚe
 &&…¬£r->
Ï¡_chunk
) {

246 
·r£r
->
	`Ï¡_chunk
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

247 } if(
·r£r
->
chunk_size
 !ğ
NULL
) {

248 
·r£r
->
	`chunk_size
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

251 
¡3
;

252 
Œ10
:

255 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

258 { 
	`MARK
(
m¬k
, 
p
); }

261 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

262 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

265 
¡3
;

266 
Œ16
:

269 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

270 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

273 
¡3
;

274 
Œ75
:

277 
·r£r
->
şo£
 = 1;

279 
¡3
;

280 
¡3
:

281 iàĞ++
p
 =ğ
³
 )

282 
_‹¡_eof3
;

285 iàĞ(*
p
) == 10 )

286 
Œ7
;

287 
¡0
;

288 
Œ6
:

291 
·r£r
->
chunked
 = 1;

292 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 16);

293 
·r£r
->
chunks_dÚe
 =…¬£r->
cÚ‹Á_Ën
 <= 0;

295 if(
·r£r
->
chunks_dÚe
 &&…¬£r->
Ï¡_chunk
) {

296 
·r£r
->
	`Ï¡_chunk
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

297 } if(
·r£r
->
chunk_size
 !ğ
NULL
) {

298 
·r£r
->
	`chunk_size
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

301 
¡4
;

302 
Œ12
:

305 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

308 { 
	`MARK
(
m¬k
, 
p
); }

311 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

312 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

315 
¡4
;

316 
Œ18
:

319 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

320 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

323 
¡4
;

324 
¡4
:

325 iàĞ++
p
 =ğ
³
 )

326 
_‹¡_eof4
;

329  (*
p
) ) {

330 33: 
Œ8
;

331 124: 
Œ8
;

332 126: 
Œ8
;

334 iàĞ(*
p
) < 45 ) {

335 iàĞ(*
p
) > 39 ) {

336 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

337 
Œ8
;

338 } iàĞ(*
p
) >= 35 )

339 
Œ8
;

340 } iàĞ(*
p
) > 46 ) {

341 iàĞ(*
p
) < 65 ) {

342 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

343 
Œ8
;

344 } iàĞ(*
p
) > 90 ) {

345 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

346 
Œ8
;

348 
Œ8
;

350 
Œ8
;

351 
¡0
;

352 
Œ8
:

354 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

355 
¡5
;

356 
¡5
:

357 iàĞ++
p
 =ğ
³
 )

358 
_‹¡_eof5
;

361  (*
p
) ) {

362 10: 
Œ9
;

363 13: 
Œ10
;

364 33: 
¡5
;

365 59: 
Œ12
;

366 61: 
Œ13
;

367 124: 
¡5
;

368 126: 
¡5
;

370 iàĞ(*
p
) < 45 ) {

371 iàĞ(*
p
) > 39 ) {

372 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

373 
¡5
;

374 } iàĞ(*
p
) >= 35 )

375 
¡5
;

376 } iàĞ(*
p
) > 46 ) {

377 iàĞ(*
p
) < 65 ) {

378 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

379 
¡5
;

380 } iàĞ(*
p
) > 90 ) {

381 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

382 
¡5
;

384 
¡5
;

386 
¡5
;

387 
¡0
;

388 
Œ13
:

391 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

394 { 
	`MARK
(
m¬k
, 
p
); }

395 
¡6
;

396 
¡6
:

397 iàĞ++
p
 =ğ
³
 )

398 
_‹¡_eof6
;

401  (*
p
) ) {

402 33: 
Œ14
;

403 124: 
Œ14
;

404 126: 
Œ14
;

406 iàĞ(*
p
) < 45 ) {

407 iàĞ(*
p
) > 39 ) {

408 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

409 
Œ14
;

410 } iàĞ(*
p
) >= 35 )

411 
Œ14
;

412 } iàĞ(*
p
) > 46 ) {

413 iàĞ(*
p
) < 65 ) {

414 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

415 
Œ14
;

416 } iàĞ(*
p
) > 90 ) {

417 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

418 
Œ14
;

420 
Œ14
;

422 
Œ14
;

423 
¡0
;

424 
Œ14
:

426 { 
	`MARK
(
m¬k
, 
p
); }

427 
¡7
;

428 
¡7
:

429 iàĞ++
p
 =ğ
³
 )

430 
_‹¡_eof7
;

433  (*
p
) ) {

434 10: 
Œ15
;

435 13: 
Œ16
;

436 33: 
¡7
;

437 59: 
Œ18
;

438 124: 
¡7
;

439 126: 
¡7
;

441 iàĞ(*
p
) < 45 ) {

442 iàĞ(*
p
) > 39 ) {

443 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

444 
¡7
;

445 } iàĞ(*
p
) >= 35 )

446 
¡7
;

447 } iàĞ(*
p
) > 46 ) {

448 iàĞ(*
p
) < 65 ) {

449 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

450 
¡7
;

451 } iàĞ(*
p
) > 90 ) {

452 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

453 
¡7
;

455 
¡7
;

457 
¡7
;

458 
¡0
;

459 
Œ2
:

461 {
	`MARK
(
m¬k
, 
p
); }

462 
¡8
;

463 
¡8
:

464 iàĞ++
p
 =ğ
³
 )

465 
_‹¡_eof8
;

468 iàĞ(*
p
) == 84 )

469 
¡9
;

470 
¡0
;

471 
¡9
:

472 iàĞ++
p
 =ğ
³
 )

473 
_‹¡_eof9
;

475 iàĞ(*
p
) == 84 )

476 
¡10
;

477 
¡0
;

478 
¡10
:

479 iàĞ++
p
 =ğ
³
 )

480 
_‹¡_eof10
;

482 iàĞ(*
p
) == 80 )

483 
¡11
;

484 
¡0
;

485 
¡11
:

486 iàĞ++
p
 =ğ
³
 )

487 
_‹¡_eof11
;

489 iàĞ(*
p
) == 47 )

490 
¡12
;

491 
¡0
;

492 
¡12
:

493 iàĞ++
p
 =ğ
³
 )

494 
_‹¡_eof12
;

496 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

497 
¡13
;

498 
¡0
;

499 
¡13
:

500 iàĞ++
p
 =ğ
³
 )

501 
_‹¡_eof13
;

503 iàĞ(*
p
) == 46 )

504 
¡14
;

505 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

506 
¡13
;

507 
¡0
;

508 
¡14
:

509 iàĞ++
p
 =ğ
³
 )

510 
_‹¡_eof14
;

512 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

513 
¡15
;

514 
¡0
;

515 
¡15
:

516 iàĞ++
p
 =ğ
³
 )

517 
_‹¡_eof15
;

519 iàĞ(*
p
) == 32 )

520 
Œ26
;

521 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

522 
¡15
;

523 
¡0
;

524 
Œ26
:

527 if(
·r£r
->
h‰p_v”siÚ
 !ğ
NULL
)

528 
·r£r
->
	`h‰p_v”siÚ
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

530 
¡16
;

531 
¡16
:

532 iàĞ++
p
 =ğ
³
 )

533 
_‹¡_eof16
;

536 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

537 
Œ27
;

538 
¡0
;

539 
Œ27
:

541 {
	`MARK
(
m¬k
, 
p
); }

542 
¡17
;

543 
¡17
:

544 iàĞ++
p
 =ğ
³
 )

545 
_‹¡_eof17
;

548 iàĞ(*
p
) == 32 )

549 
Œ28
;

550 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

551 
¡17
;

552 
¡0
;

553 
Œ28
:

556 
·r£r
->
¡©us
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 10);

558 if(
·r£r
->
¡©us_code
 !ğ
NULL
)

559 
·r£r
->
	`¡©us_code
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

561 
¡18
;

562 
¡18
:

563 iàĞ++
p
 =ğ
³
 )

564 
_‹¡_eof18
;

567 iàĞ(*
p
) == 10 )

568 
¡0
;

569 
Œ30
;

570 
Œ30
:

572 {
	`MARK
(
m¬k
, 
p
); }

573 
¡19
;

574 
¡19
:

575 iàĞ++
p
 =ğ
³
 )

576 
_‹¡_eof19
;

579  (*
p
) ) {

580 10: 
Œ32
;

581 13: 
Œ33
;

583 
¡19
;

584 
Œ45
:

587 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

588 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

591 
¡20
;

592 
Œ32
:

595 if(
·r£r
->
»asÚ_ph¿£
 !ğ
NULL
)

596 
·r£r
->
	`»asÚ_ph¿£
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

598 
¡20
;

599 
Œ42
:

601 { 
	`MARK
(
m¬k
, 
p
); }

604 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

605 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

608 
¡20
;

609 
Œ111
:

612 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

613 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

618 
·r£r
->
chunked
 = 1;

620 
¡20
;

621 
Œ113
:

624 
·r£r
->
chunked
 = 1;

626 
¡20
;

627 
Œ158
:

630 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 10);

634 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

635 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

638 
¡20
;

639 
¡20
:

640 iàĞ++
p
 =ğ
³
 )

641 
_‹¡_eof20
;

644  (*
p
) ) {

645 10: 
Œ7
;

646 13: 
¡3
;

647 33: 
Œ35
;

648 67: 
Œ36
;

649 84: 
Œ37
;

650 99: 
Œ36
;

651 116: 
Œ37
;

652 124: 
Œ35
;

653 126: 
Œ35
;

655 iàĞ(*
p
) < 45 ) {

656 iàĞ(*
p
) > 39 ) {

657 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

658 
Œ35
;

659 } iàĞ(*
p
) >= 35 )

660 
Œ35
;

661 } iàĞ(*
p
) > 46 ) {

662 iàĞ(*
p
) < 65 ) {

663 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

664 
Œ35
;

665 } iàĞ(*
p
) > 90 ) {

666 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

667 
Œ35
;

669 
Œ35
;

671 
Œ35
;

672 
¡0
;

673 
Œ35
:

675 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

676 
¡21
;

677 
Œ76
:

680 
·r£r
->
şo£
 = 1;

683 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

684 
¡21
;

685 
¡21
:

686 iàĞ++
p
 =ğ
³
 )

687 
_‹¡_eof21
;

690  (*
p
) ) {

691 33: 
¡21
;

692 58: 
Œ39
;

693 124: 
¡21
;

694 126: 
¡21
;

696 iàĞ(*
p
) < 45 ) {

697 iàĞ(*
p
) > 39 ) {

698 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

699 
¡21
;

700 } iàĞ(*
p
) >= 35 )

701 
¡21
;

702 } iàĞ(*
p
) > 46 ) {

703 iàĞ(*
p
) < 65 ) {

704 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

705 
¡21
;

706 } iàĞ(*
p
) > 90 ) {

707 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

708 
¡21
;

710 
¡21
;

712 
¡21
;

713 
¡0
;

714 
Œ41
:

716 { 
	`MARK
(
m¬k
, 
p
); }

717 
¡22
;

718 
Œ39
:

721 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

723 
¡22
;

724 
¡22
:

725 iàĞ++
p
 =ğ
³
 )

726 
_‹¡_eof22
;

729  (*
p
) ) {

730 10: 
Œ42
;

731 13: 
Œ43
;

732 32: 
Œ41
;

734 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

735 
Œ41
;

736 
Œ40
;

737 
Œ40
:

739 { 
	`MARK
(
m¬k
, 
p
); }

740 
¡23
;

741 
¡23
:

742 iàĞ++
p
 =ğ
³
 )

743 
_‹¡_eof23
;

746  (*
p
) ) {

747 10: 
Œ45
;

748 13: 
Œ46
;

750 
¡23
;

751 
Œ46
:

754 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

755 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

758 
¡24
;

759 
Œ33
:

762 if(
·r£r
->
»asÚ_ph¿£
 !ğ
NULL
)

763 
·r£r
->
	`»asÚ_ph¿£
Õ¬£r->
d©a
, 
	`PTR_TO
(
m¬k
), 
	`LEN
(m¬k, 
p
));

765 
¡24
;

766 
Œ43
:

768 { 
	`MARK
(
m¬k
, 
p
); }

771 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

772 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

775 
¡24
;

776 
Œ159
:

779 
·r£r
->
cÚ‹Á_Ën
 = 
	`¡¹Ş
(
	`PTR_TO
(
m¬k
), 
NULL
, 10);

783 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

784 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

787 
¡24
;

788 
¡24
:

789 iàĞ++
p
 =ğ
³
 )

790 
_‹¡_eof24
;

793 iàĞ(*
p
) == 10 )

794 
¡20
;

795 
¡0
;

796 
Œ36
:

798 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

799 
¡25
;

800 
Œ77
:

803 
·r£r
->
şo£
 = 1;

806 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

807 
¡25
;

808 
¡25
:

809 iàĞ++
p
 =ğ
³
 )

810 
_‹¡_eof25
;

813  (*
p
) ) {

814 33: 
¡21
;

815 58: 
Œ39
;

816 79: 
¡26
;

817 111: 
¡26
;

818 124: 
¡21
;

819 126: 
¡21
;

821 iàĞ(*
p
) < 45 ) {

822 iàĞ(*
p
) > 39 ) {

823 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

824 
¡21
;

825 } iàĞ(*
p
) >= 35 )

826 
¡21
;

827 } iàĞ(*
p
) > 46 ) {

828 iàĞ(*
p
) < 65 ) {

829 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

830 
¡21
;

831 } iàĞ(*
p
) > 90 ) {

832 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

833 
¡21
;

835 
¡21
;

837 
¡21
;

838 
¡0
;

839 
¡26
:

840 iàĞ++
p
 =ğ
³
 )

841 
_‹¡_eof26
;

843  (*
p
) ) {

844 33: 
¡21
;

845 58: 
Œ39
;

846 78: 
¡27
;

847 110: 
¡27
;

848 124: 
¡21
;

849 126: 
¡21
;

851 iàĞ(*
p
) < 45 ) {

852 iàĞ(*
p
) > 39 ) {

853 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

854 
¡21
;

855 } iàĞ(*
p
) >= 35 )

856 
¡21
;

857 } iàĞ(*
p
) > 46 ) {

858 iàĞ(*
p
) < 65 ) {

859 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

860 
¡21
;

861 } iàĞ(*
p
) > 90 ) {

862 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

863 
¡21
;

865 
¡21
;

867 
¡21
;

868 
¡0
;

869 
¡27
:

870 iàĞ++
p
 =ğ
³
 )

871 
_‹¡_eof27
;

873  (*
p
) ) {

874 33: 
¡21
;

875 58: 
Œ39
;

876 78: 
¡28
;

877 84: 
¡101
;

878 110: 
¡28
;

879 116: 
¡101
;

880 124: 
¡21
;

881 126: 
¡21
;

883 iàĞ(*
p
) < 45 ) {

884 iàĞ(*
p
) > 39 ) {

885 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

886 
¡21
;

887 } iàĞ(*
p
) >= 35 )

888 
¡21
;

889 } iàĞ(*
p
) > 46 ) {

890 iàĞ(*
p
) < 65 ) {

891 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

892 
¡21
;

893 } iàĞ(*
p
) > 90 ) {

894 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

895 
¡21
;

897 
¡21
;

899 
¡21
;

900 
¡0
;

901 
¡28
:

902 iàĞ++
p
 =ğ
³
 )

903 
_‹¡_eof28
;

905  (*
p
) ) {

906 33: 
¡21
;

907 58: 
Œ39
;

908 69: 
¡29
;

909 101: 
¡29
;

910 124: 
¡21
;

911 126: 
¡21
;

913 iàĞ(*
p
) < 45 ) {

914 iàĞ(*
p
) > 39 ) {

915 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

916 
¡21
;

917 } iàĞ(*
p
) >= 35 )

918 
¡21
;

919 } iàĞ(*
p
) > 46 ) {

920 iàĞ(*
p
) < 65 ) {

921 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

922 
¡21
;

923 } iàĞ(*
p
) > 90 ) {

924 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

925 
¡21
;

927 
¡21
;

929 
¡21
;

930 
¡0
;

931 
¡29
:

932 iàĞ++
p
 =ğ
³
 )

933 
_‹¡_eof29
;

935  (*
p
) ) {

936 33: 
¡21
;

937 58: 
Œ39
;

938 67: 
¡30
;

939 99: 
¡30
;

940 124: 
¡21
;

941 126: 
¡21
;

943 iàĞ(*
p
) < 45 ) {

944 iàĞ(*
p
) > 39 ) {

945 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

946 
¡21
;

947 } iàĞ(*
p
) >= 35 )

948 
¡21
;

949 } iàĞ(*
p
) > 46 ) {

950 iàĞ(*
p
) < 65 ) {

951 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

952 
¡21
;

953 } iàĞ(*
p
) > 90 ) {

954 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

955 
¡21
;

957 
¡21
;

959 
¡21
;

960 
¡0
;

961 
¡30
:

962 iàĞ++
p
 =ğ
³
 )

963 
_‹¡_eof30
;

965  (*
p
) ) {

966 33: 
¡21
;

967 58: 
Œ39
;

968 84: 
¡31
;

969 116: 
¡31
;

970 124: 
¡21
;

971 126: 
¡21
;

973 iàĞ(*
p
) < 45 ) {

974 iàĞ(*
p
) > 39 ) {

975 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

976 
¡21
;

977 } iàĞ(*
p
) >= 35 )

978 
¡21
;

979 } iàĞ(*
p
) > 46 ) {

980 iàĞ(*
p
) < 65 ) {

981 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

982 
¡21
;

983 } iàĞ(*
p
) > 90 ) {

984 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

985 
¡21
;

987 
¡21
;

989 
¡21
;

990 
¡0
;

991 
¡31
:

992 iàĞ++
p
 =ğ
³
 )

993 
_‹¡_eof31
;

995  (*
p
) ) {

996 33: 
¡21
;

997 58: 
Œ39
;

998 73: 
¡32
;

999 105: 
¡32
;

1000 124: 
¡21
;

1001 126: 
¡21
;

1003 iàĞ(*
p
) < 45 ) {

1004 iàĞ(*
p
) > 39 ) {

1005 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1006 
¡21
;

1007 } iàĞ(*
p
) >= 35 )

1008 
¡21
;

1009 } iàĞ(*
p
) > 46 ) {

1010 iàĞ(*
p
) < 65 ) {

1011 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1012 
¡21
;

1013 } iàĞ(*
p
) > 90 ) {

1014 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1015 
¡21
;

1017 
¡21
;

1019 
¡21
;

1020 
¡0
;

1021 
¡32
:

1022 iàĞ++
p
 =ğ
³
 )

1023 
_‹¡_eof32
;

1025  (*
p
) ) {

1026 33: 
¡21
;

1027 58: 
Œ39
;

1028 79: 
¡33
;

1029 111: 
¡33
;

1030 124: 
¡21
;

1031 126: 
¡21
;

1033 iàĞ(*
p
) < 45 ) {

1034 iàĞ(*
p
) > 39 ) {

1035 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1036 
¡21
;

1037 } iàĞ(*
p
) >= 35 )

1038 
¡21
;

1039 } iàĞ(*
p
) > 46 ) {

1040 iàĞ(*
p
) < 65 ) {

1041 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1042 
¡21
;

1043 } iàĞ(*
p
) > 90 ) {

1044 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1045 
¡21
;

1047 
¡21
;

1049 
¡21
;

1050 
¡0
;

1051 
¡33
:

1052 iàĞ++
p
 =ğ
³
 )

1053 
_‹¡_eof33
;

1055  (*
p
) ) {

1056 33: 
¡21
;

1057 58: 
Œ39
;

1058 78: 
¡34
;

1059 110: 
¡34
;

1060 124: 
¡21
;

1061 126: 
¡21
;

1063 iàĞ(*
p
) < 45 ) {

1064 iàĞ(*
p
) > 39 ) {

1065 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1066 
¡21
;

1067 } iàĞ(*
p
) >= 35 )

1068 
¡21
;

1069 } iàĞ(*
p
) > 46 ) {

1070 iàĞ(*
p
) < 65 ) {

1071 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1072 
¡21
;

1073 } iàĞ(*
p
) > 90 ) {

1074 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1075 
¡21
;

1077 
¡21
;

1079 
¡21
;

1080 
¡0
;

1081 
¡34
:

1082 iàĞ++
p
 =ğ
³
 )

1083 
_‹¡_eof34
;

1085  (*
p
) ) {

1086 33: 
¡21
;

1087 58: 
Œ58
;

1088 124: 
¡21
;

1089 126: 
¡21
;

1091 iàĞ(*
p
) < 45 ) {

1092 iàĞ(*
p
) > 39 ) {

1093 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1094 
¡21
;

1095 } iàĞ(*
p
) >= 35 )

1096 
¡21
;

1097 } iàĞ(*
p
) > 46 ) {

1098 iàĞ(*
p
) < 65 ) {

1099 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1100 
¡21
;

1101 } iàĞ(*
p
) > 90 ) {

1102 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1103 
¡21
;

1105 
¡21
;

1107 
¡21
;

1108 
¡0
;

1109 
Œ59
:

1111 { 
	`MARK
(
m¬k
, 
p
); }

1112 
¡35
;

1113 
Œ58
:

1116 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

1118 
¡35
;

1119 
¡35
:

1120 iàĞ++
p
 =ğ
³
 )

1121 
_‹¡_eof35
;

1124  (*
p
) ) {

1125 10: 
Œ60
;

1126 13: 
Œ61
;

1127 32: 
Œ59
;

1128 67: 
Œ62
;

1129 99: 
Œ62
;

1131 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1132 
Œ59
;

1133 
Œ40
;

1134 
Œ60
:

1136 { 
	`MARK
(
m¬k
, 
p
); }

1139 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1140 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1143 
¡36
;

1144 
¡36
:

1145 iàĞ++
p
 =ğ
³
 )

1146 
_‹¡_eof36
;

1149  (*
p
) ) {

1150 10: 
Œ64
;

1151 13: 
¡89
;

1152 32: 
¡37
;

1153 33: 
Œ35
;

1154 67: 
Œ66
;

1155 84: 
Œ37
;

1156 99: 
Œ66
;

1157 116: 
Œ37
;

1158 124: 
Œ35
;

1159 126: 
Œ35
;

1161 iàĞ(*
p
) < 45 ) {

1162 iàĞ(*
p
) < 35 ) {

1163 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1164 
¡37
;

1165 } iàĞ(*
p
) > 39 ) {

1166 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1167 
Œ35
;

1169 
Œ35
;

1170 } iàĞ(*
p
) > 46 ) {

1171 iàĞ(*
p
) < 65 ) {

1172 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1173 
Œ35
;

1174 } iàĞ(*
p
) > 90 ) {

1175 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1176 
Œ35
;

1178 
Œ35
;

1180 
Œ35
;

1181 
¡0
;

1182 
¡37
:

1183 iàĞ++
p
 =ğ
³
 )

1184 
_‹¡_eof37
;

1186  (*
p
) ) {

1187 32: 
¡37
;

1188 67: 
¡38
;

1189 99: 
¡38
;

1191 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1192 
¡37
;

1193 
¡0
;

1194 
¡38
:

1195 iàĞ++
p
 =ğ
³
 )

1196 
_‹¡_eof38
;

1198  (*
p
) ) {

1199 76: 
¡39
;

1200 108: 
¡39
;

1202 
¡0
;

1203 
¡39
:

1204 iàĞ++
p
 =ğ
³
 )

1205 
_‹¡_eof39
;

1207  (*
p
) ) {

1208 79: 
¡40
;

1209 111: 
¡40
;

1211 
¡0
;

1212 
¡40
:

1213 iàĞ++
p
 =ğ
³
 )

1214 
_‹¡_eof40
;

1216  (*
p
) ) {

1217 83: 
¡41
;

1218 115: 
¡41
;

1220 
¡0
;

1221 
¡41
:

1222 iàĞ++
p
 =ğ
³
 )

1223 
_‹¡_eof41
;

1225  (*
p
) ) {

1226 69: 
¡42
;

1227 101: 
¡42
;

1229 
¡0
;

1230 
¡42
:

1231 iàĞ++
p
 =ğ
³
 )

1232 
_‹¡_eof42
;

1234  (*
p
) ) {

1235 10: 
¡43
;

1236 13: 
¡88
;

1238 
¡0
;

1239 
Œ136
:

1242 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1243 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1246 
¡43
;

1247 
¡43
:

1248 iàĞ++
p
 =ğ
³
 )

1249 
_‹¡_eof43
;

1252  (*
p
) ) {

1253 10: 
Œ74
;

1254 13: 
Œ75
;

1255 33: 
Œ76
;

1256 67: 
Œ77
;

1257 84: 
Œ78
;

1258 99: 
Œ77
;

1259 116: 
Œ78
;

1260 124: 
Œ76
;

1261 126: 
Œ76
;

1263 iàĞ(*
p
) < 45 ) {

1264 iàĞ(*
p
) > 39 ) {

1265 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1266 
Œ76
;

1267 } iàĞ(*
p
) >= 35 )

1268 
Œ76
;

1269 } iàĞ(*
p
) > 46 ) {

1270 iàĞ(*
p
) < 65 ) {

1271 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1272 
Œ76
;

1273 } iàĞ(*
p
) > 90 ) {

1274 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1275 
Œ76
;

1277 
Œ76
;

1279 
Œ76
;

1280 
¡0
;

1281 
Œ37
:

1283 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

1284 
¡44
;

1285 
Œ78
:

1288 
·r£r
->
şo£
 = 1;

1291 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

1292 
¡44
;

1293 
¡44
:

1294 iàĞ++
p
 =ğ
³
 )

1295 
_‹¡_eof44
;

1298  (*
p
) ) {

1299 33: 
¡21
;

1300 58: 
Œ39
;

1301 82: 
¡45
;

1302 114: 
¡45
;

1303 124: 
¡21
;

1304 126: 
¡21
;

1306 iàĞ(*
p
) < 45 ) {

1307 iàĞ(*
p
) > 39 ) {

1308 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1309 
¡21
;

1310 } iàĞ(*
p
) >= 35 )

1311 
¡21
;

1312 } iàĞ(*
p
) > 46 ) {

1313 iàĞ(*
p
) < 65 ) {

1314 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1315 
¡21
;

1316 } iàĞ(*
p
) > 90 ) {

1317 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1318 
¡21
;

1320 
¡21
;

1322 
¡21
;

1323 
¡0
;

1324 
¡45
:

1325 iàĞ++
p
 =ğ
³
 )

1326 
_‹¡_eof45
;

1328  (*
p
) ) {

1329 33: 
¡21
;

1330 58: 
Œ39
;

1331 65: 
¡46
;

1332 97: 
¡46
;

1333 124: 
¡21
;

1334 126: 
¡21
;

1336 iàĞ(*
p
) < 45 ) {

1337 iàĞ(*
p
) > 39 ) {

1338 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1339 
¡21
;

1340 } iàĞ(*
p
) >= 35 )

1341 
¡21
;

1342 } iàĞ(*
p
) > 46 ) {

1343 iàĞ(*
p
) < 66 ) {

1344 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1345 
¡21
;

1346 } iàĞ(*
p
) > 90 ) {

1347 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1348 
¡21
;

1350 
¡21
;

1352 
¡21
;

1353 
¡0
;

1354 
¡46
:

1355 iàĞ++
p
 =ğ
³
 )

1356 
_‹¡_eof46
;

1358  (*
p
) ) {

1359 33: 
¡21
;

1360 58: 
Œ39
;

1361 78: 
¡47
;

1362 110: 
¡47
;

1363 124: 
¡21
;

1364 126: 
¡21
;

1366 iàĞ(*
p
) < 45 ) {

1367 iàĞ(*
p
) > 39 ) {

1368 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1369 
¡21
;

1370 } iàĞ(*
p
) >= 35 )

1371 
¡21
;

1372 } iàĞ(*
p
) > 46 ) {

1373 iàĞ(*
p
) < 65 ) {

1374 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1375 
¡21
;

1376 } iàĞ(*
p
) > 90 ) {

1377 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1378 
¡21
;

1380 
¡21
;

1382 
¡21
;

1383 
¡0
;

1384 
¡47
:

1385 iàĞ++
p
 =ğ
³
 )

1386 
_‹¡_eof47
;

1388  (*
p
) ) {

1389 33: 
¡21
;

1390 58: 
Œ39
;

1391 83: 
¡48
;

1392 115: 
¡48
;

1393 124: 
¡21
;

1394 126: 
¡21
;

1396 iàĞ(*
p
) < 45 ) {

1397 iàĞ(*
p
) > 39 ) {

1398 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1399 
¡21
;

1400 } iàĞ(*
p
) >= 35 )

1401 
¡21
;

1402 } iàĞ(*
p
) > 46 ) {

1403 iàĞ(*
p
) < 65 ) {

1404 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1405 
¡21
;

1406 } iàĞ(*
p
) > 90 ) {

1407 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1408 
¡21
;

1410 
¡21
;

1412 
¡21
;

1413 
¡0
;

1414 
¡48
:

1415 iàĞ++
p
 =ğ
³
 )

1416 
_‹¡_eof48
;

1418  (*
p
) ) {

1419 33: 
¡21
;

1420 58: 
Œ39
;

1421 70: 
¡49
;

1422 102: 
¡49
;

1423 124: 
¡21
;

1424 126: 
¡21
;

1426 iàĞ(*
p
) < 45 ) {

1427 iàĞ(*
p
) > 39 ) {

1428 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1429 
¡21
;

1430 } iàĞ(*
p
) >= 35 )

1431 
¡21
;

1432 } iàĞ(*
p
) > 46 ) {

1433 iàĞ(*
p
) < 65 ) {

1434 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1435 
¡21
;

1436 } iàĞ(*
p
) > 90 ) {

1437 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1438 
¡21
;

1440 
¡21
;

1442 
¡21
;

1443 
¡0
;

1444 
¡49
:

1445 iàĞ++
p
 =ğ
³
 )

1446 
_‹¡_eof49
;

1448  (*
p
) ) {

1449 33: 
¡21
;

1450 58: 
Œ39
;

1451 69: 
¡50
;

1452 101: 
¡50
;

1453 124: 
¡21
;

1454 126: 
¡21
;

1456 iàĞ(*
p
) < 45 ) {

1457 iàĞ(*
p
) > 39 ) {

1458 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1459 
¡21
;

1460 } iàĞ(*
p
) >= 35 )

1461 
¡21
;

1462 } iàĞ(*
p
) > 46 ) {

1463 iàĞ(*
p
) < 65 ) {

1464 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1465 
¡21
;

1466 } iàĞ(*
p
) > 90 ) {

1467 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1468 
¡21
;

1470 
¡21
;

1472 
¡21
;

1473 
¡0
;

1474 
¡50
:

1475 iàĞ++
p
 =ğ
³
 )

1476 
_‹¡_eof50
;

1478  (*
p
) ) {

1479 33: 
¡21
;

1480 58: 
Œ39
;

1481 82: 
¡51
;

1482 114: 
¡51
;

1483 124: 
¡21
;

1484 126: 
¡21
;

1486 iàĞ(*
p
) < 45 ) {

1487 iàĞ(*
p
) > 39 ) {

1488 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1489 
¡21
;

1490 } iàĞ(*
p
) >= 35 )

1491 
¡21
;

1492 } iàĞ(*
p
) > 46 ) {

1493 iàĞ(*
p
) < 65 ) {

1494 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1495 
¡21
;

1496 } iàĞ(*
p
) > 90 ) {

1497 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1498 
¡21
;

1500 
¡21
;

1502 
¡21
;

1503 
¡0
;

1504 
¡51
:

1505 iàĞ++
p
 =ğ
³
 )

1506 
_‹¡_eof51
;

1508  (*
p
) ) {

1509 33: 
¡21
;

1510 45: 
¡52
;

1511 46: 
¡21
;

1512 58: 
Œ39
;

1513 124: 
¡21
;

1514 126: 
¡21
;

1516 iàĞ(*
p
) < 48 ) {

1517 iàĞ(*
p
) > 39 ) {

1518 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1519 
¡21
;

1520 } iàĞ(*
p
) >= 35 )

1521 
¡21
;

1522 } iàĞ(*
p
) > 57 ) {

1523 iàĞ(*
p
) > 90 ) {

1524 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1525 
¡21
;

1526 } iàĞ(*
p
) >= 65 )

1527 
¡21
;

1529 
¡21
;

1530 
¡0
;

1531 
¡52
:

1532 iàĞ++
p
 =ğ
³
 )

1533 
_‹¡_eof52
;

1535  (*
p
) ) {

1536 33: 
¡21
;

1537 58: 
Œ39
;

1538 69: 
¡53
;

1539 101: 
¡53
;

1540 124: 
¡21
;

1541 126: 
¡21
;

1543 iàĞ(*
p
) < 45 ) {

1544 iàĞ(*
p
) > 39 ) {

1545 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1546 
¡21
;

1547 } iàĞ(*
p
) >= 35 )

1548 
¡21
;

1549 } iàĞ(*
p
) > 46 ) {

1550 iàĞ(*
p
) < 65 ) {

1551 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1552 
¡21
;

1553 } iàĞ(*
p
) > 90 ) {

1554 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1555 
¡21
;

1557 
¡21
;

1559 
¡21
;

1560 
¡0
;

1561 
¡53
:

1562 iàĞ++
p
 =ğ
³
 )

1563 
_‹¡_eof53
;

1565  (*
p
) ) {

1566 33: 
¡21
;

1567 58: 
Œ39
;

1568 78: 
¡54
;

1569 110: 
¡54
;

1570 124: 
¡21
;

1571 126: 
¡21
;

1573 iàĞ(*
p
) < 45 ) {

1574 iàĞ(*
p
) > 39 ) {

1575 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1576 
¡21
;

1577 } iàĞ(*
p
) >= 35 )

1578 
¡21
;

1579 } iàĞ(*
p
) > 46 ) {

1580 iàĞ(*
p
) < 65 ) {

1581 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1582 
¡21
;

1583 } iàĞ(*
p
) > 90 ) {

1584 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1585 
¡21
;

1587 
¡21
;

1589 
¡21
;

1590 
¡0
;

1591 
¡54
:

1592 iàĞ++
p
 =ğ
³
 )

1593 
_‹¡_eof54
;

1595  (*
p
) ) {

1596 33: 
¡21
;

1597 58: 
Œ39
;

1598 67: 
¡55
;

1599 99: 
¡55
;

1600 124: 
¡21
;

1601 126: 
¡21
;

1603 iàĞ(*
p
) < 45 ) {

1604 iàĞ(*
p
) > 39 ) {

1605 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1606 
¡21
;

1607 } iàĞ(*
p
) >= 35 )

1608 
¡21
;

1609 } iàĞ(*
p
) > 46 ) {

1610 iàĞ(*
p
) < 65 ) {

1611 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1612 
¡21
;

1613 } iàĞ(*
p
) > 90 ) {

1614 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1615 
¡21
;

1617 
¡21
;

1619 
¡21
;

1620 
¡0
;

1621 
¡55
:

1622 iàĞ++
p
 =ğ
³
 )

1623 
_‹¡_eof55
;

1625  (*
p
) ) {

1626 33: 
¡21
;

1627 58: 
Œ39
;

1628 79: 
¡56
;

1629 111: 
¡56
;

1630 124: 
¡21
;

1631 126: 
¡21
;

1633 iàĞ(*
p
) < 45 ) {

1634 iàĞ(*
p
) > 39 ) {

1635 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1636 
¡21
;

1637 } iàĞ(*
p
) >= 35 )

1638 
¡21
;

1639 } iàĞ(*
p
) > 46 ) {

1640 iàĞ(*
p
) < 65 ) {

1641 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1642 
¡21
;

1643 } iàĞ(*
p
) > 90 ) {

1644 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1645 
¡21
;

1647 
¡21
;

1649 
¡21
;

1650 
¡0
;

1651 
¡56
:

1652 iàĞ++
p
 =ğ
³
 )

1653 
_‹¡_eof56
;

1655  (*
p
) ) {

1656 33: 
¡21
;

1657 58: 
Œ39
;

1658 68: 
¡57
;

1659 100: 
¡57
;

1660 124: 
¡21
;

1661 126: 
¡21
;

1663 iàĞ(*
p
) < 45 ) {

1664 iàĞ(*
p
) > 39 ) {

1665 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1666 
¡21
;

1667 } iàĞ(*
p
) >= 35 )

1668 
¡21
;

1669 } iàĞ(*
p
) > 46 ) {

1670 iàĞ(*
p
) < 65 ) {

1671 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1672 
¡21
;

1673 } iàĞ(*
p
) > 90 ) {

1674 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1675 
¡21
;

1677 
¡21
;

1679 
¡21
;

1680 
¡0
;

1681 
¡57
:

1682 iàĞ++
p
 =ğ
³
 )

1683 
_‹¡_eof57
;

1685  (*
p
) ) {

1686 33: 
¡21
;

1687 58: 
Œ39
;

1688 73: 
¡58
;

1689 105: 
¡58
;

1690 124: 
¡21
;

1691 126: 
¡21
;

1693 iàĞ(*
p
) < 45 ) {

1694 iàĞ(*
p
) > 39 ) {

1695 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1696 
¡21
;

1697 } iàĞ(*
p
) >= 35 )

1698 
¡21
;

1699 } iàĞ(*
p
) > 46 ) {

1700 iàĞ(*
p
) < 65 ) {

1701 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1702 
¡21
;

1703 } iàĞ(*
p
) > 90 ) {

1704 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1705 
¡21
;

1707 
¡21
;

1709 
¡21
;

1710 
¡0
;

1711 
¡58
:

1712 iàĞ++
p
 =ğ
³
 )

1713 
_‹¡_eof58
;

1715  (*
p
) ) {

1716 33: 
¡21
;

1717 58: 
Œ39
;

1718 78: 
¡59
;

1719 110: 
¡59
;

1720 124: 
¡21
;

1721 126: 
¡21
;

1723 iàĞ(*
p
) < 45 ) {

1724 iàĞ(*
p
) > 39 ) {

1725 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1726 
¡21
;

1727 } iàĞ(*
p
) >= 35 )

1728 
¡21
;

1729 } iàĞ(*
p
) > 46 ) {

1730 iàĞ(*
p
) < 65 ) {

1731 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1732 
¡21
;

1733 } iàĞ(*
p
) > 90 ) {

1734 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1735 
¡21
;

1737 
¡21
;

1739 
¡21
;

1740 
¡0
;

1741 
¡59
:

1742 iàĞ++
p
 =ğ
³
 )

1743 
_‹¡_eof59
;

1745  (*
p
) ) {

1746 33: 
¡21
;

1747 58: 
Œ39
;

1748 71: 
¡60
;

1749 103: 
¡60
;

1750 124: 
¡21
;

1751 126: 
¡21
;

1753 iàĞ(*
p
) < 45 ) {

1754 iàĞ(*
p
) > 39 ) {

1755 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1756 
¡21
;

1757 } iàĞ(*
p
) >= 35 )

1758 
¡21
;

1759 } iàĞ(*
p
) > 46 ) {

1760 iàĞ(*
p
) < 65 ) {

1761 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1762 
¡21
;

1763 } iàĞ(*
p
) > 90 ) {

1764 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1765 
¡21
;

1767 
¡21
;

1769 
¡21
;

1770 
¡0
;

1771 
¡60
:

1772 iàĞ++
p
 =ğ
³
 )

1773 
_‹¡_eof60
;

1775  (*
p
) ) {

1776 33: 
¡21
;

1777 58: 
Œ95
;

1778 124: 
¡21
;

1779 126: 
¡21
;

1781 iàĞ(*
p
) < 45 ) {

1782 iàĞ(*
p
) > 39 ) {

1783 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1784 
¡21
;

1785 } iàĞ(*
p
) >= 35 )

1786 
¡21
;

1787 } iàĞ(*
p
) > 46 ) {

1788 iàĞ(*
p
) < 65 ) {

1789 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1790 
¡21
;

1791 } iàĞ(*
p
) > 90 ) {

1792 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1793 
¡21
;

1795 
¡21
;

1797 
¡21
;

1798 
¡0
;

1799 
Œ96
:

1801 { 
	`MARK
(
m¬k
, 
p
); }

1802 
¡61
;

1803 
Œ95
:

1806 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

1808 
¡61
;

1809 
¡61
:

1810 iàĞ++
p
 =ğ
³
 )

1811 
_‹¡_eof61
;

1814  (*
p
) ) {

1815 10: 
Œ97
;

1816 13: 
Œ98
;

1817 32: 
Œ96
;

1818 67: 
Œ99
;

1819 99: 
Œ99
;

1821 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1822 
Œ96
;

1823 
Œ40
;

1824 
Œ97
:

1826 { 
	`MARK
(
m¬k
, 
p
); }

1829 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1830 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1833 
¡62
;

1834 
¡62
:

1835 iàĞ++
p
 =ğ
³
 )

1836 
_‹¡_eof62
;

1839  (*
p
) ) {

1840 10: 
Œ101
;

1841 13: 
¡72
;

1842 32: 
¡63
;

1843 33: 
Œ35
;

1844 67: 
Œ103
;

1845 84: 
Œ37
;

1846 99: 
Œ103
;

1847 116: 
Œ37
;

1848 124: 
Œ35
;

1849 126: 
Œ35
;

1851 iàĞ(*
p
) < 45 ) {

1852 iàĞ(*
p
) < 35 ) {

1853 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

1854 
¡63
;

1855 } iàĞ(*
p
) > 39 ) {

1856 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

1857 
Œ35
;

1859 
Œ35
;

1860 } iàĞ(*
p
) > 46 ) {

1861 iàĞ(*
p
) < 65 ) {

1862 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

1863 
Œ35
;

1864 } iàĞ(*
p
) > 90 ) {

1865 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

1866 
Œ35
;

1868 
Œ35
;

1870 
Œ35
;

1871 
¡0
;

1872 
¡63
:

1873 iàĞ++
p
 =ğ
³
 )

1874 
_‹¡_eof63
;

1876  (*
p
) ) {

1877 32: 
¡63
;

1878 67: 
Œ104
;

1879 99: 
Œ104
;

1881 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1882 
¡63
;

1883 
¡0
;

1884 
Œ104
:

1886 { 
	`MARK
(
m¬k
, 
p
); }

1887 
¡64
;

1888 
¡64
:

1889 iàĞ++
p
 =ğ
³
 )

1890 
_‹¡_eof64
;

1893  (*
p
) ) {

1894 72: 
¡65
;

1895 104: 
¡65
;

1897 
¡0
;

1898 
¡65
:

1899 iàĞ++
p
 =ğ
³
 )

1900 
_‹¡_eof65
;

1902  (*
p
) ) {

1903 85: 
¡66
;

1904 117: 
¡66
;

1906 
¡0
;

1907 
¡66
:

1908 iàĞ++
p
 =ğ
³
 )

1909 
_‹¡_eof66
;

1911  (*
p
) ) {

1912 78: 
¡67
;

1913 110: 
¡67
;

1915 
¡0
;

1916 
¡67
:

1917 iàĞ++
p
 =ğ
³
 )

1918 
_‹¡_eof67
;

1920  (*
p
) ) {

1921 75: 
¡68
;

1922 107: 
¡68
;

1924 
¡0
;

1925 
¡68
:

1926 iàĞ++
p
 =ğ
³
 )

1927 
_‹¡_eof68
;

1929  (*
p
) ) {

1930 69: 
¡69
;

1931 101: 
¡69
;

1933 
¡0
;

1934 
¡69
:

1935 iàĞ++
p
 =ğ
³
 )

1936 
_‹¡_eof69
;

1938  (*
p
) ) {

1939 68: 
¡70
;

1940 100: 
¡70
;

1942 
¡0
;

1943 
¡70
:

1944 iàĞ++
p
 =ğ
³
 )

1945 
_‹¡_eof70
;

1947  (*
p
) ) {

1948 10: 
Œ111
;

1949 13: 
Œ112
;

1951 
¡0
;

1952 
Œ112
:

1955 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

1956 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

1959 
¡71
;

1960 
¡71
:

1961 iàĞ++
p
 =ğ
³
 )

1962 
_‹¡_eof71
;

1965 iàĞ(*
p
) == 10 )

1966 
Œ113
;

1967 
¡0
;

1968 
Œ101
:

1971 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

1972 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

1973 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

1974 {
p
++; 
cs
 = 121; 
_out
;}

1976 
¡121
;

1977 
¡121
:

1978 iàĞ++
p
 =ğ
³
 )

1979 
_‹¡_eof121
;

1982  (*
p
) ) {

1983 32: 
¡63
;

1984 67: 
Œ104
;

1985 99: 
Œ104
;

1987 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

1988 
¡63
;

1989 
¡0
;

1990 
¡72
:

1991 iàĞ++
p
 =ğ
³
 )

1992 
_‹¡_eof72
;

1994  (*
p
) ) {

1995 10: 
Œ101
;

1996 32: 
¡63
;

1997 67: 
Œ104
;

1998 99: 
Œ104
;

2000 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2001 
¡63
;

2002 
¡0
;

2003 
Œ103
:

2005 { 
	`MARK
(
m¬k
, 
p
); }

2007 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

2008 
¡73
;

2009 
¡73
:

2010 iàĞ++
p
 =ğ
³
 )

2011 
_‹¡_eof73
;

2014  (*
p
) ) {

2015 33: 
¡21
;

2016 58: 
Œ39
;

2017 72: 
¡74
;

2018 79: 
¡26
;

2019 104: 
¡74
;

2020 111: 
¡26
;

2021 124: 
¡21
;

2022 126: 
¡21
;

2024 iàĞ(*
p
) < 45 ) {

2025 iàĞ(*
p
) > 39 ) {

2026 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2027 
¡21
;

2028 } iàĞ(*
p
) >= 35 )

2029 
¡21
;

2030 } iàĞ(*
p
) > 46 ) {

2031 iàĞ(*
p
) < 65 ) {

2032 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2033 
¡21
;

2034 } iàĞ(*
p
) > 90 ) {

2035 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2036 
¡21
;

2038 
¡21
;

2040 
¡21
;

2041 
¡0
;

2042 
¡74
:

2043 iàĞ++
p
 =ğ
³
 )

2044 
_‹¡_eof74
;

2046  (*
p
) ) {

2047 33: 
¡21
;

2048 58: 
Œ39
;

2049 85: 
¡75
;

2050 117: 
¡75
;

2051 124: 
¡21
;

2052 126: 
¡21
;

2054 iàĞ(*
p
) < 45 ) {

2055 iàĞ(*
p
) > 39 ) {

2056 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2057 
¡21
;

2058 } iàĞ(*
p
) >= 35 )

2059 
¡21
;

2060 } iàĞ(*
p
) > 46 ) {

2061 iàĞ(*
p
) < 65 ) {

2062 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2063 
¡21
;

2064 } iàĞ(*
p
) > 90 ) {

2065 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2066 
¡21
;

2068 
¡21
;

2070 
¡21
;

2071 
¡0
;

2072 
¡75
:

2073 iàĞ++
p
 =ğ
³
 )

2074 
_‹¡_eof75
;

2076  (*
p
) ) {

2077 33: 
¡21
;

2078 58: 
Œ39
;

2079 78: 
¡76
;

2080 110: 
¡76
;

2081 124: 
¡21
;

2082 126: 
¡21
;

2084 iàĞ(*
p
) < 45 ) {

2085 iàĞ(*
p
) > 39 ) {

2086 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2087 
¡21
;

2088 } iàĞ(*
p
) >= 35 )

2089 
¡21
;

2090 } iàĞ(*
p
) > 46 ) {

2091 iàĞ(*
p
) < 65 ) {

2092 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2093 
¡21
;

2094 } iàĞ(*
p
) > 90 ) {

2095 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2096 
¡21
;

2098 
¡21
;

2100 
¡21
;

2101 
¡0
;

2102 
¡76
:

2103 iàĞ++
p
 =ğ
³
 )

2104 
_‹¡_eof76
;

2106  (*
p
) ) {

2107 33: 
¡21
;

2108 58: 
Œ39
;

2109 75: 
¡77
;

2110 107: 
¡77
;

2111 124: 
¡21
;

2112 126: 
¡21
;

2114 iàĞ(*
p
) < 45 ) {

2115 iàĞ(*
p
) > 39 ) {

2116 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2117 
¡21
;

2118 } iàĞ(*
p
) >= 35 )

2119 
¡21
;

2120 } iàĞ(*
p
) > 46 ) {

2121 iàĞ(*
p
) < 65 ) {

2122 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2123 
¡21
;

2124 } iàĞ(*
p
) > 90 ) {

2125 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2126 
¡21
;

2128 
¡21
;

2130 
¡21
;

2131 
¡0
;

2132 
¡77
:

2133 iàĞ++
p
 =ğ
³
 )

2134 
_‹¡_eof77
;

2136  (*
p
) ) {

2137 33: 
¡21
;

2138 58: 
Œ39
;

2139 69: 
¡78
;

2140 101: 
¡78
;

2141 124: 
¡21
;

2142 126: 
¡21
;

2144 iàĞ(*
p
) < 45 ) {

2145 iàĞ(*
p
) > 39 ) {

2146 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2147 
¡21
;

2148 } iàĞ(*
p
) >= 35 )

2149 
¡21
;

2150 } iàĞ(*
p
) > 46 ) {

2151 iàĞ(*
p
) < 65 ) {

2152 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2153 
¡21
;

2154 } iàĞ(*
p
) > 90 ) {

2155 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2156 
¡21
;

2158 
¡21
;

2160 
¡21
;

2161 
¡0
;

2162 
¡78
:

2163 iàĞ++
p
 =ğ
³
 )

2164 
_‹¡_eof78
;

2166  (*
p
) ) {

2167 33: 
¡21
;

2168 58: 
Œ39
;

2169 68: 
¡79
;

2170 100: 
¡79
;

2171 124: 
¡21
;

2172 126: 
¡21
;

2174 iàĞ(*
p
) < 45 ) {

2175 iàĞ(*
p
) > 39 ) {

2176 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2177 
¡21
;

2178 } iàĞ(*
p
) >= 35 )

2179 
¡21
;

2180 } iàĞ(*
p
) > 46 ) {

2181 iàĞ(*
p
) < 65 ) {

2182 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2183 
¡21
;

2184 } iàĞ(*
p
) > 90 ) {

2185 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2186 
¡21
;

2188 
¡21
;

2190 
¡21
;

2191 
¡0
;

2192 
¡79
:

2193 iàĞ++
p
 =ğ
³
 )

2194 
_‹¡_eof79
;

2196  (*
p
) ) {

2197 10: 
Œ111
;

2198 13: 
Œ112
;

2199 33: 
¡21
;

2200 58: 
Œ39
;

2201 124: 
¡21
;

2202 126: 
¡21
;

2204 iàĞ(*
p
) < 45 ) {

2205 iàĞ(*
p
) > 39 ) {

2206 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2207 
¡21
;

2208 } iàĞ(*
p
) >= 35 )

2209 
¡21
;

2210 } iàĞ(*
p
) > 46 ) {

2211 iàĞ(*
p
) < 65 ) {

2212 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2213 
¡21
;

2214 } iàĞ(*
p
) > 90 ) {

2215 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2216 
¡21
;

2218 
¡21
;

2220 
¡21
;

2221 
¡0
;

2222 
Œ98
:

2224 { 
	`MARK
(
m¬k
, 
p
); }

2227 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2228 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2231 
¡80
;

2232 
¡80
:

2233 iàĞ++
p
 =ğ
³
 )

2234 
_‹¡_eof80
;

2237  (*
p
) ) {

2238 10: 
¡62
;

2239 32: 
¡63
;

2240 67: 
Œ104
;

2241 99: 
Œ104
;

2243 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2244 
¡63
;

2245 
¡0
;

2246 
Œ99
:

2248 { 
	`MARK
(
m¬k
, 
p
); }

2249 
¡81
;

2250 
¡81
:

2251 iàĞ++
p
 =ğ
³
 )

2252 
_‹¡_eof81
;

2255  (*
p
) ) {

2256 10: 
Œ45
;

2257 13: 
Œ46
;

2258 72: 
¡82
;

2259 104: 
¡82
;

2261 
¡23
;

2262 
¡82
:

2263 iàĞ++
p
 =ğ
³
 )

2264 
_‹¡_eof82
;

2266  (*
p
) ) {

2267 10: 
Œ45
;

2268 13: 
Œ46
;

2269 85: 
¡83
;

2270 117: 
¡83
;

2272 
¡23
;

2273 
¡83
:

2274 iàĞ++
p
 =ğ
³
 )

2275 
_‹¡_eof83
;

2277  (*
p
) ) {

2278 10: 
Œ45
;

2279 13: 
Œ46
;

2280 78: 
¡84
;

2281 110: 
¡84
;

2283 
¡23
;

2284 
¡84
:

2285 iàĞ++
p
 =ğ
³
 )

2286 
_‹¡_eof84
;

2288  (*
p
) ) {

2289 10: 
Œ45
;

2290 13: 
Œ46
;

2291 75: 
¡85
;

2292 107: 
¡85
;

2294 
¡23
;

2295 
¡85
:

2296 iàĞ++
p
 =ğ
³
 )

2297 
_‹¡_eof85
;

2299  (*
p
) ) {

2300 10: 
Œ45
;

2301 13: 
Œ46
;

2302 69: 
¡86
;

2303 101: 
¡86
;

2305 
¡23
;

2306 
¡86
:

2307 iàĞ++
p
 =ğ
³
 )

2308 
_‹¡_eof86
;

2310  (*
p
) ) {

2311 10: 
Œ45
;

2312 13: 
Œ46
;

2313 68: 
¡87
;

2314 100: 
¡87
;

2316 
¡23
;

2317 
¡87
:

2318 iàĞ++
p
 =ğ
³
 )

2319 
_‹¡_eof87
;

2321  (*
p
) ) {

2322 10: 
Œ111
;

2323 13: 
Œ112
;

2325 
¡23
;

2326 
Œ137
:

2329 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2330 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2333 
¡88
;

2334 
¡88
:

2335 iàĞ++
p
 =ğ
³
 )

2336 
_‹¡_eof88
;

2339 iàĞ(*
p
) == 10 )

2340 
¡43
;

2341 
¡0
;

2342 
Œ64
:

2345 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

2346 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

2347 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

2348 {
p
++; 
cs
 = 122; 
_out
;}

2350 
¡122
;

2351 
¡122
:

2352 iàĞ++
p
 =ğ
³
 )

2353 
_‹¡_eof122
;

2356  (*
p
) ) {

2357 32: 
¡37
;

2358 67: 
¡38
;

2359 99: 
¡38
;

2361 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2362 
¡37
;

2363 
¡0
;

2364 
¡89
:

2365 iàĞ++
p
 =ğ
³
 )

2366 
_‹¡_eof89
;

2368  (*
p
) ) {

2369 10: 
Œ64
;

2370 32: 
¡37
;

2371 67: 
¡38
;

2372 99: 
¡38
;

2374 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2375 
¡37
;

2376 
¡0
;

2377 
Œ66
:

2379 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

2380 
¡90
;

2381 
¡90
:

2382 iàĞ++
p
 =ğ
³
 )

2383 
_‹¡_eof90
;

2386  (*
p
) ) {

2387 33: 
¡21
;

2388 58: 
Œ39
;

2389 76: 
¡91
;

2390 79: 
¡26
;

2391 108: 
¡91
;

2392 111: 
¡26
;

2393 124: 
¡21
;

2394 126: 
¡21
;

2396 iàĞ(*
p
) < 45 ) {

2397 iàĞ(*
p
) > 39 ) {

2398 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2399 
¡21
;

2400 } iàĞ(*
p
) >= 35 )

2401 
¡21
;

2402 } iàĞ(*
p
) > 46 ) {

2403 iàĞ(*
p
) < 65 ) {

2404 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2405 
¡21
;

2406 } iàĞ(*
p
) > 90 ) {

2407 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2408 
¡21
;

2410 
¡21
;

2412 
¡21
;

2413 
¡0
;

2414 
¡91
:

2415 iàĞ++
p
 =ğ
³
 )

2416 
_‹¡_eof91
;

2418  (*
p
) ) {

2419 33: 
¡21
;

2420 58: 
Œ39
;

2421 79: 
¡92
;

2422 111: 
¡92
;

2423 124: 
¡21
;

2424 126: 
¡21
;

2426 iàĞ(*
p
) < 45 ) {

2427 iàĞ(*
p
) > 39 ) {

2428 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2429 
¡21
;

2430 } iàĞ(*
p
) >= 35 )

2431 
¡21
;

2432 } iàĞ(*
p
) > 46 ) {

2433 iàĞ(*
p
) < 65 ) {

2434 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2435 
¡21
;

2436 } iàĞ(*
p
) > 90 ) {

2437 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2438 
¡21
;

2440 
¡21
;

2442 
¡21
;

2443 
¡0
;

2444 
¡92
:

2445 iàĞ++
p
 =ğ
³
 )

2446 
_‹¡_eof92
;

2448  (*
p
) ) {

2449 33: 
¡21
;

2450 58: 
Œ39
;

2451 83: 
¡93
;

2452 115: 
¡93
;

2453 124: 
¡21
;

2454 126: 
¡21
;

2456 iàĞ(*
p
) < 45 ) {

2457 iàĞ(*
p
) > 39 ) {

2458 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2459 
¡21
;

2460 } iàĞ(*
p
) >= 35 )

2461 
¡21
;

2462 } iàĞ(*
p
) > 46 ) {

2463 iàĞ(*
p
) < 65 ) {

2464 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2465 
¡21
;

2466 } iàĞ(*
p
) > 90 ) {

2467 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2468 
¡21
;

2470 
¡21
;

2472 
¡21
;

2473 
¡0
;

2474 
¡93
:

2475 iàĞ++
p
 =ğ
³
 )

2476 
_‹¡_eof93
;

2478  (*
p
) ) {

2479 33: 
¡21
;

2480 58: 
Œ39
;

2481 69: 
¡94
;

2482 101: 
¡94
;

2483 124: 
¡21
;

2484 126: 
¡21
;

2486 iàĞ(*
p
) < 45 ) {

2487 iàĞ(*
p
) > 39 ) {

2488 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2489 
¡21
;

2490 } iàĞ(*
p
) >= 35 )

2491 
¡21
;

2492 } iàĞ(*
p
) > 46 ) {

2493 iàĞ(*
p
) < 65 ) {

2494 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2495 
¡21
;

2496 } iàĞ(*
p
) > 90 ) {

2497 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2498 
¡21
;

2500 
¡21
;

2502 
¡21
;

2503 
¡0
;

2504 
¡94
:

2505 iàĞ++
p
 =ğ
³
 )

2506 
_‹¡_eof94
;

2508  (*
p
) ) {

2509 10: 
¡43
;

2510 13: 
¡88
;

2511 33: 
¡21
;

2512 58: 
Œ39
;

2513 124: 
¡21
;

2514 126: 
¡21
;

2516 iàĞ(*
p
) < 45 ) {

2517 iàĞ(*
p
) > 39 ) {

2518 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2519 
¡21
;

2520 } iàĞ(*
p
) >= 35 )

2521 
¡21
;

2522 } iàĞ(*
p
) > 46 ) {

2523 iàĞ(*
p
) < 65 ) {

2524 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2525 
¡21
;

2526 } iàĞ(*
p
) > 90 ) {

2527 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2528 
¡21
;

2530 
¡21
;

2532 
¡21
;

2533 
¡0
;

2534 
Œ61
:

2536 { 
	`MARK
(
m¬k
, 
p
); }

2539 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2540 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2543 
¡95
;

2544 
¡95
:

2545 iàĞ++
p
 =ğ
³
 )

2546 
_‹¡_eof95
;

2549  (*
p
) ) {

2550 10: 
¡36
;

2551 32: 
¡37
;

2552 67: 
¡38
;

2553 99: 
¡38
;

2555 iàĞ9 <ğ(*
p
) && (*p) <= 13 )

2556 
¡37
;

2557 
¡0
;

2558 
Œ62
:

2560 { 
	`MARK
(
m¬k
, 
p
); }

2561 
¡96
;

2562 
¡96
:

2563 iàĞ++
p
 =ğ
³
 )

2564 
_‹¡_eof96
;

2567  (*
p
) ) {

2568 10: 
Œ45
;

2569 13: 
Œ46
;

2570 76: 
¡97
;

2571 108: 
¡97
;

2573 
¡23
;

2574 
¡97
:

2575 iàĞ++
p
 =ğ
³
 )

2576 
_‹¡_eof97
;

2578  (*
p
) ) {

2579 10: 
Œ45
;

2580 13: 
Œ46
;

2581 79: 
¡98
;

2582 111: 
¡98
;

2584 
¡23
;

2585 
¡98
:

2586 iàĞ++
p
 =ğ
³
 )

2587 
_‹¡_eof98
;

2589  (*
p
) ) {

2590 10: 
Œ45
;

2591 13: 
Œ46
;

2592 83: 
¡99
;

2593 115: 
¡99
;

2595 
¡23
;

2596 
¡99
:

2597 iàĞ++
p
 =ğ
³
 )

2598 
_‹¡_eof99
;

2600  (*
p
) ) {

2601 10: 
Œ45
;

2602 13: 
Œ46
;

2603 69: 
¡100
;

2604 101: 
¡100
;

2606 
¡23
;

2607 
¡100
:

2608 iàĞ++
p
 =ğ
³
 )

2609 
_‹¡_eof100
;

2611  (*
p
) ) {

2612 10: 
Œ136
;

2613 13: 
Œ137
;

2615 
¡23
;

2616 
¡101
:

2617 iàĞ++
p
 =ğ
³
 )

2618 
_‹¡_eof101
;

2620  (*
p
) ) {

2621 33: 
¡21
;

2622 58: 
Œ39
;

2623 69: 
¡102
;

2624 101: 
¡102
;

2625 124: 
¡21
;

2626 126: 
¡21
;

2628 iàĞ(*
p
) < 45 ) {

2629 iàĞ(*
p
) > 39 ) {

2630 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2631 
¡21
;

2632 } iàĞ(*
p
) >= 35 )

2633 
¡21
;

2634 } iàĞ(*
p
) > 46 ) {

2635 iàĞ(*
p
) < 65 ) {

2636 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2637 
¡21
;

2638 } iàĞ(*
p
) > 90 ) {

2639 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2640 
¡21
;

2642 
¡21
;

2644 
¡21
;

2645 
¡0
;

2646 
¡102
:

2647 iàĞ++
p
 =ğ
³
 )

2648 
_‹¡_eof102
;

2650  (*
p
) ) {

2651 33: 
¡21
;

2652 58: 
Œ39
;

2653 78: 
¡103
;

2654 110: 
¡103
;

2655 124: 
¡21
;

2656 126: 
¡21
;

2658 iàĞ(*
p
) < 45 ) {

2659 iàĞ(*
p
) > 39 ) {

2660 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2661 
¡21
;

2662 } iàĞ(*
p
) >= 35 )

2663 
¡21
;

2664 } iàĞ(*
p
) > 46 ) {

2665 iàĞ(*
p
) < 65 ) {

2666 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2667 
¡21
;

2668 } iàĞ(*
p
) > 90 ) {

2669 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2670 
¡21
;

2672 
¡21
;

2674 
¡21
;

2675 
¡0
;

2676 
¡103
:

2677 iàĞ++
p
 =ğ
³
 )

2678 
_‹¡_eof103
;

2680  (*
p
) ) {

2681 33: 
¡21
;

2682 58: 
Œ39
;

2683 84: 
¡104
;

2684 116: 
¡104
;

2685 124: 
¡21
;

2686 126: 
¡21
;

2688 iàĞ(*
p
) < 45 ) {

2689 iàĞ(*
p
) > 39 ) {

2690 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2691 
¡21
;

2692 } iàĞ(*
p
) >= 35 )

2693 
¡21
;

2694 } iàĞ(*
p
) > 46 ) {

2695 iàĞ(*
p
) < 65 ) {

2696 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2697 
¡21
;

2698 } iàĞ(*
p
) > 90 ) {

2699 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2700 
¡21
;

2702 
¡21
;

2704 
¡21
;

2705 
¡0
;

2706 
¡104
:

2707 iàĞ++
p
 =ğ
³
 )

2708 
_‹¡_eof104
;

2710  (*
p
) ) {

2711 33: 
¡21
;

2712 45: 
¡105
;

2713 46: 
¡21
;

2714 58: 
Œ39
;

2715 124: 
¡21
;

2716 126: 
¡21
;

2718 iàĞ(*
p
) < 48 ) {

2719 iàĞ(*
p
) > 39 ) {

2720 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2721 
¡21
;

2722 } iàĞ(*
p
) >= 35 )

2723 
¡21
;

2724 } iàĞ(*
p
) > 57 ) {

2725 iàĞ(*
p
) > 90 ) {

2726 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2727 
¡21
;

2728 } iàĞ(*
p
) >= 65 )

2729 
¡21
;

2731 
¡21
;

2732 
¡0
;

2733 
¡105
:

2734 iàĞ++
p
 =ğ
³
 )

2735 
_‹¡_eof105
;

2737  (*
p
) ) {

2738 33: 
¡21
;

2739 58: 
Œ39
;

2740 76: 
¡106
;

2741 108: 
¡106
;

2742 124: 
¡21
;

2743 126: 
¡21
;

2745 iàĞ(*
p
) < 45 ) {

2746 iàĞ(*
p
) > 39 ) {

2747 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2748 
¡21
;

2749 } iàĞ(*
p
) >= 35 )

2750 
¡21
;

2751 } iàĞ(*
p
) > 46 ) {

2752 iàĞ(*
p
) < 65 ) {

2753 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2754 
¡21
;

2755 } iàĞ(*
p
) > 90 ) {

2756 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2757 
¡21
;

2759 
¡21
;

2761 
¡21
;

2762 
¡0
;

2763 
¡106
:

2764 iàĞ++
p
 =ğ
³
 )

2765 
_‹¡_eof106
;

2767  (*
p
) ) {

2768 33: 
¡21
;

2769 58: 
Œ39
;

2770 69: 
¡107
;

2771 101: 
¡107
;

2772 124: 
¡21
;

2773 126: 
¡21
;

2775 iàĞ(*
p
) < 45 ) {

2776 iàĞ(*
p
) > 39 ) {

2777 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2778 
¡21
;

2779 } iàĞ(*
p
) >= 35 )

2780 
¡21
;

2781 } iàĞ(*
p
) > 46 ) {

2782 iàĞ(*
p
) < 65 ) {

2783 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2784 
¡21
;

2785 } iàĞ(*
p
) > 90 ) {

2786 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2787 
¡21
;

2789 
¡21
;

2791 
¡21
;

2792 
¡0
;

2793 
¡107
:

2794 iàĞ++
p
 =ğ
³
 )

2795 
_‹¡_eof107
;

2797  (*
p
) ) {

2798 33: 
¡21
;

2799 58: 
Œ39
;

2800 78: 
¡108
;

2801 110: 
¡108
;

2802 124: 
¡21
;

2803 126: 
¡21
;

2805 iàĞ(*
p
) < 45 ) {

2806 iàĞ(*
p
) > 39 ) {

2807 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2808 
¡21
;

2809 } iàĞ(*
p
) >= 35 )

2810 
¡21
;

2811 } iàĞ(*
p
) > 46 ) {

2812 iàĞ(*
p
) < 65 ) {

2813 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2814 
¡21
;

2815 } iàĞ(*
p
) > 90 ) {

2816 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2817 
¡21
;

2819 
¡21
;

2821 
¡21
;

2822 
¡0
;

2823 
¡108
:

2824 iàĞ++
p
 =ğ
³
 )

2825 
_‹¡_eof108
;

2827  (*
p
) ) {

2828 33: 
¡21
;

2829 58: 
Œ39
;

2830 71: 
¡109
;

2831 103: 
¡109
;

2832 124: 
¡21
;

2833 126: 
¡21
;

2835 iàĞ(*
p
) < 45 ) {

2836 iàĞ(*
p
) > 39 ) {

2837 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2838 
¡21
;

2839 } iàĞ(*
p
) >= 35 )

2840 
¡21
;

2841 } iàĞ(*
p
) > 46 ) {

2842 iàĞ(*
p
) < 65 ) {

2843 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2844 
¡21
;

2845 } iàĞ(*
p
) > 90 ) {

2846 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2847 
¡21
;

2849 
¡21
;

2851 
¡21
;

2852 
¡0
;

2853 
¡109
:

2854 iàĞ++
p
 =ğ
³
 )

2855 
_‹¡_eof109
;

2857  (*
p
) ) {

2858 33: 
¡21
;

2859 58: 
Œ39
;

2860 84: 
¡110
;

2861 116: 
¡110
;

2862 124: 
¡21
;

2863 126: 
¡21
;

2865 iàĞ(*
p
) < 45 ) {

2866 iàĞ(*
p
) > 39 ) {

2867 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2868 
¡21
;

2869 } iàĞ(*
p
) >= 35 )

2870 
¡21
;

2871 } iàĞ(*
p
) > 46 ) {

2872 iàĞ(*
p
) < 65 ) {

2873 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2874 
¡21
;

2875 } iàĞ(*
p
) > 90 ) {

2876 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2877 
¡21
;

2879 
¡21
;

2881 
¡21
;

2882 
¡0
;

2883 
¡110
:

2884 iàĞ++
p
 =ğ
³
 )

2885 
_‹¡_eof110
;

2887  (*
p
) ) {

2888 33: 
¡21
;

2889 58: 
Œ39
;

2890 72: 
¡111
;

2891 104: 
¡111
;

2892 124: 
¡21
;

2893 126: 
¡21
;

2895 iàĞ(*
p
) < 45 ) {

2896 iàĞ(*
p
) > 39 ) {

2897 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2898 
¡21
;

2899 } iàĞ(*
p
) >= 35 )

2900 
¡21
;

2901 } iàĞ(*
p
) > 46 ) {

2902 iàĞ(*
p
) < 65 ) {

2903 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2904 
¡21
;

2905 } iàĞ(*
p
) > 90 ) {

2906 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2907 
¡21
;

2909 
¡21
;

2911 
¡21
;

2912 
¡0
;

2913 
¡111
:

2914 iàĞ++
p
 =ğ
³
 )

2915 
_‹¡_eof111
;

2917  (*
p
) ) {

2918 33: 
¡21
;

2919 58: 
Œ148
;

2920 124: 
¡21
;

2921 126: 
¡21
;

2923 iàĞ(*
p
) < 45 ) {

2924 iàĞ(*
p
) > 39 ) {

2925 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

2926 
¡21
;

2927 } iàĞ(*
p
) >= 35 )

2928 
¡21
;

2929 } iàĞ(*
p
) > 46 ) {

2930 iàĞ(*
p
) < 65 ) {

2931 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2932 
¡21
;

2933 } iàĞ(*
p
) > 90 ) {

2934 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

2935 
¡21
;

2937 
¡21
;

2939 
¡21
;

2940 
¡0
;

2941 
Œ149
:

2943 { 
	`MARK
(
m¬k
, 
p
); }

2944 
¡112
;

2945 
Œ148
:

2948 
·r£r
->
f›ld_Ën
 = 
	`LEN
(
f›ld_¡¬t
, 
p
);

2950 
¡112
;

2951 
¡112
:

2952 iàĞ++
p
 =ğ
³
 )

2953 
_‹¡_eof112
;

2956  (*
p
) ) {

2957 10: 
Œ150
;

2958 13: 
Œ151
;

2959 32: 
Œ149
;

2961 iàĞ(*
p
) > 12 ) {

2962 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

2963 
Œ152
;

2964 } iàĞ(*
p
) >= 9 )

2965 
Œ149
;

2966 
Œ40
;

2967 
Œ150
:

2969 { 
	`MARK
(
m¬k
, 
p
); }

2972 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

2973 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

2976 
¡113
;

2977 
¡113
:

2978 iàĞ++
p
 =ğ
³
 )

2979 
_‹¡_eof113
;

2982  (*
p
) ) {

2983 10: 
Œ154
;

2984 13: 
¡116
;

2985 32: 
¡114
;

2986 33: 
Œ35
;

2987 67: 
Œ36
;

2988 84: 
Œ37
;

2989 99: 
Œ36
;

2990 116: 
Œ37
;

2991 124: 
Œ35
;

2992 126: 
Œ35
;

2994 iàĞ(*
p
) < 45 ) {

2995 iàĞ(*
p
) < 35 ) {

2996 iàĞ9 <ğ(*
p
) && (*p) <= 12 )

2997 
¡114
;

2998 } iàĞ(*
p
) > 39 ) {

2999 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

3000 
Œ35
;

3002 
Œ35
;

3003 } iàĞ(*
p
) > 46 ) {

3004 iàĞ(*
p
) < 65 ) {

3005 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3006 
Œ156
;

3007 } iàĞ(*
p
) > 90 ) {

3008 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

3009 
Œ35
;

3011 
Œ35
;

3013 
Œ35
;

3014 
¡0
;

3015 
¡114
:

3016 iàĞ++
p
 =ğ
³
 )

3017 
_‹¡_eof114
;

3019 iàĞ(*
p
) == 32 )

3020 
¡114
;

3021 iàĞ(*
p
) > 13 ) {

3022 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3023 
Œ157
;

3024 } iàĞ(*
p
) >= 9 )

3025 
¡114
;

3026 
¡0
;

3027 
Œ157
:

3029 { 
	`MARK
(
m¬k
, 
p
); }

3030 
¡115
;

3031 
¡115
:

3032 iàĞ++
p
 =ğ
³
 )

3033 
_‹¡_eof115
;

3036  (*
p
) ) {

3037 10: 
Œ158
;

3038 13: 
Œ159
;

3040 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3041 
¡115
;

3042 
¡0
;

3043 
Œ154
:

3046 
·r£r
->
body_¡¬t
 = 
p
 - 
bufãr
 + 1;

3047 if(
·r£r
->
h—d”_dÚe
 !ğ
NULL
)

3048 
·r£r
->
	`h—d”_dÚe
Õ¬£r->
d©a
, 
p
 + 1, 
³
 -… - 1);

3049 {
p
++; 
cs
 = 123; 
_out
;}

3051 
¡123
;

3052 
¡123
:

3053 iàĞ++
p
 =ğ
³
 )

3054 
_‹¡_eof123
;

3057 iàĞ(*
p
) == 32 )

3058 
¡114
;

3059 iàĞ(*
p
) > 13 ) {

3060 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3061 
Œ157
;

3062 } iàĞ(*
p
) >= 9 )

3063 
¡114
;

3064 
¡0
;

3065 
¡116
:

3066 iàĞ++
p
 =ğ
³
 )

3067 
_‹¡_eof116
;

3069  (*
p
) ) {

3070 10: 
Œ154
;

3071 32: 
¡114
;

3073 iàĞ(*
p
) > 13 ) {

3074 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3075 
Œ157
;

3076 } iàĞ(*
p
) >= 9 )

3077 
¡114
;

3078 
¡0
;

3079 
Œ156
:

3081 { 
	`MARK
(
m¬k
, 
p
); }

3083 { 
	`MARK
(
f›ld_¡¬t
, 
p
); }

3084 
¡117
;

3085 
¡117
:

3086 iàĞ++
p
 =ğ
³
 )

3087 
_‹¡_eof117
;

3090  (*
p
) ) {

3091 10: 
Œ158
;

3092 13: 
Œ159
;

3093 33: 
¡21
;

3094 58: 
Œ39
;

3095 124: 
¡21
;

3096 126: 
¡21
;

3098 iàĞ(*
p
) < 45 ) {

3099 iàĞ(*
p
) > 39 ) {

3100 iàĞ42 <ğ(*
p
) && (*p) <= 43 )

3101 
¡21
;

3102 } iàĞ(*
p
) >= 35 )

3103 
¡21
;

3104 } iàĞ(*
p
) > 46 ) {

3105 iàĞ(*
p
) < 65 ) {

3106 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3107 
¡117
;

3108 } iàĞ(*
p
) > 90 ) {

3109 iàĞ94 <ğ(*
p
) && (*p) <= 122 )

3110 
¡21
;

3112 
¡21
;

3114 
¡21
;

3115 
¡0
;

3116 
Œ151
:

3118 { 
	`MARK
(
m¬k
, 
p
); }

3121 if(
·r£r
->
h‰p_f›ld
 !ğ
NULL
) {

3122 
·r£r
->
	`h‰p_f›ld
Õ¬£r->
d©a
, 
	`PTR_TO
(
f›ld_¡¬t
),…¬£r->
f›ld_Ën
, PTR_TO(
m¬k
), 
	`LEN
(m¬k, 
p
));

3125 
¡118
;

3126 
¡118
:

3127 iàĞ++
p
 =ğ
³
 )

3128 
_‹¡_eof118
;

3131  (*
p
) ) {

3132 10: 
¡113
;

3133 32: 
¡114
;

3135 iàĞ(*
p
) > 13 ) {

3136 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3137 
Œ157
;

3138 } iàĞ(*
p
) >= 9 )

3139 
¡114
;

3140 
¡0
;

3141 
Œ152
:

3143 { 
	`MARK
(
m¬k
, 
p
); }

3144 
¡119
;

3145 
¡119
:

3146 iàĞ++
p
 =ğ
³
 )

3147 
_‹¡_eof119
;

3150  (*
p
) ) {

3151 10: 
Œ158
;

3152 13: 
Œ159
;

3154 iàĞ48 <ğ(*
p
) && (*p) <= 57 )

3155 
¡119
;

3156 
¡23
;

3158 
_‹¡_eof2
: 
cs
 = 2; 
_‹¡_eof
;

3159 
_‹¡_eof120
: 
cs
 = 120; 
_‹¡_eof
;

3160 
_‹¡_eof3
: 
cs
 = 3; 
_‹¡_eof
;

3161 
_‹¡_eof4
: 
cs
 = 4; 
_‹¡_eof
;

3162 
_‹¡_eof5
: 
cs
 = 5; 
_‹¡_eof
;

3163 
_‹¡_eof6
: 
cs
 = 6; 
_‹¡_eof
;

3164 
_‹¡_eof7
: 
cs
 = 7; 
_‹¡_eof
;

3165 
_‹¡_eof8
: 
cs
 = 8; 
_‹¡_eof
;

3166 
_‹¡_eof9
: 
cs
 = 9; 
_‹¡_eof
;

3167 
_‹¡_eof10
: 
cs
 = 10; 
_‹¡_eof
;

3168 
_‹¡_eof11
: 
cs
 = 11; 
_‹¡_eof
;

3169 
_‹¡_eof12
: 
cs
 = 12; 
_‹¡_eof
;

3170 
_‹¡_eof13
: 
cs
 = 13; 
_‹¡_eof
;

3171 
_‹¡_eof14
: 
cs
 = 14; 
_‹¡_eof
;

3172 
_‹¡_eof15
: 
cs
 = 15; 
_‹¡_eof
;

3173 
_‹¡_eof16
: 
cs
 = 16; 
_‹¡_eof
;

3174 
_‹¡_eof17
: 
cs
 = 17; 
_‹¡_eof
;

3175 
_‹¡_eof18
: 
cs
 = 18; 
_‹¡_eof
;

3176 
_‹¡_eof19
: 
cs
 = 19; 
_‹¡_eof
;

3177 
_‹¡_eof20
: 
cs
 = 20; 
_‹¡_eof
;

3178 
_‹¡_eof21
: 
cs
 = 21; 
_‹¡_eof
;

3179 
_‹¡_eof22
: 
cs
 = 22; 
_‹¡_eof
;

3180 
_‹¡_eof23
: 
cs
 = 23; 
_‹¡_eof
;

3181 
_‹¡_eof24
: 
cs
 = 24; 
_‹¡_eof
;

3182 
_‹¡_eof25
: 
cs
 = 25; 
_‹¡_eof
;

3183 
_‹¡_eof26
: 
cs
 = 26; 
_‹¡_eof
;

3184 
_‹¡_eof27
: 
cs
 = 27; 
_‹¡_eof
;

3185 
_‹¡_eof28
: 
cs
 = 28; 
_‹¡_eof
;

3186 
_‹¡_eof29
: 
cs
 = 29; 
_‹¡_eof
;

3187 
_‹¡_eof30
: 
cs
 = 30; 
_‹¡_eof
;

3188 
_‹¡_eof31
: 
cs
 = 31; 
_‹¡_eof
;

3189 
_‹¡_eof32
: 
cs
 = 32; 
_‹¡_eof
;

3190 
_‹¡_eof33
: 
cs
 = 33; 
_‹¡_eof
;

3191 
_‹¡_eof34
: 
cs
 = 34; 
_‹¡_eof
;

3192 
_‹¡_eof35
: 
cs
 = 35; 
_‹¡_eof
;

3193 
_‹¡_eof36
: 
cs
 = 36; 
_‹¡_eof
;

3194 
_‹¡_eof37
: 
cs
 = 37; 
_‹¡_eof
;

3195 
_‹¡_eof38
: 
cs
 = 38; 
_‹¡_eof
;

3196 
_‹¡_eof39
: 
cs
 = 39; 
_‹¡_eof
;

3197 
_‹¡_eof40
: 
cs
 = 40; 
_‹¡_eof
;

3198 
_‹¡_eof41
: 
cs
 = 41; 
_‹¡_eof
;

3199 
_‹¡_eof42
: 
cs
 = 42; 
_‹¡_eof
;

3200 
_‹¡_eof43
: 
cs
 = 43; 
_‹¡_eof
;

3201 
_‹¡_eof44
: 
cs
 = 44; 
_‹¡_eof
;

3202 
_‹¡_eof45
: 
cs
 = 45; 
_‹¡_eof
;

3203 
_‹¡_eof46
: 
cs
 = 46; 
_‹¡_eof
;

3204 
_‹¡_eof47
: 
cs
 = 47; 
_‹¡_eof
;

3205 
_‹¡_eof48
: 
cs
 = 48; 
_‹¡_eof
;

3206 
_‹¡_eof49
: 
cs
 = 49; 
_‹¡_eof
;

3207 
_‹¡_eof50
: 
cs
 = 50; 
_‹¡_eof
;

3208 
_‹¡_eof51
: 
cs
 = 51; 
_‹¡_eof
;

3209 
_‹¡_eof52
: 
cs
 = 52; 
_‹¡_eof
;

3210 
_‹¡_eof53
: 
cs
 = 53; 
_‹¡_eof
;

3211 
_‹¡_eof54
: 
cs
 = 54; 
_‹¡_eof
;

3212 
_‹¡_eof55
: 
cs
 = 55; 
_‹¡_eof
;

3213 
_‹¡_eof56
: 
cs
 = 56; 
_‹¡_eof
;

3214 
_‹¡_eof57
: 
cs
 = 57; 
_‹¡_eof
;

3215 
_‹¡_eof58
: 
cs
 = 58; 
_‹¡_eof
;

3216 
_‹¡_eof59
: 
cs
 = 59; 
_‹¡_eof
;

3217 
_‹¡_eof60
: 
cs
 = 60; 
_‹¡_eof
;

3218 
_‹¡_eof61
: 
cs
 = 61; 
_‹¡_eof
;

3219 
_‹¡_eof62
: 
cs
 = 62; 
_‹¡_eof
;

3220 
_‹¡_eof63
: 
cs
 = 63; 
_‹¡_eof
;

3221 
_‹¡_eof64
: 
cs
 = 64; 
_‹¡_eof
;

3222 
_‹¡_eof65
: 
cs
 = 65; 
_‹¡_eof
;

3223 
_‹¡_eof66
: 
cs
 = 66; 
_‹¡_eof
;

3224 
_‹¡_eof67
: 
cs
 = 67; 
_‹¡_eof
;

3225 
_‹¡_eof68
: 
cs
 = 68; 
_‹¡_eof
;

3226 
_‹¡_eof69
: 
cs
 = 69; 
_‹¡_eof
;

3227 
_‹¡_eof70
: 
cs
 = 70; 
_‹¡_eof
;

3228 
_‹¡_eof71
: 
cs
 = 71; 
_‹¡_eof
;

3229 
_‹¡_eof121
: 
cs
 = 121; 
_‹¡_eof
;

3230 
_‹¡_eof72
: 
cs
 = 72; 
_‹¡_eof
;

3231 
_‹¡_eof73
: 
cs
 = 73; 
_‹¡_eof
;

3232 
_‹¡_eof74
: 
cs
 = 74; 
_‹¡_eof
;

3233 
_‹¡_eof75
: 
cs
 = 75; 
_‹¡_eof
;

3234 
_‹¡_eof76
: 
cs
 = 76; 
_‹¡_eof
;

3235 
_‹¡_eof77
: 
cs
 = 77; 
_‹¡_eof
;

3236 
_‹¡_eof78
: 
cs
 = 78; 
_‹¡_eof
;

3237 
_‹¡_eof79
: 
cs
 = 79; 
_‹¡_eof
;

3238 
_‹¡_eof80
: 
cs
 = 80; 
_‹¡_eof
;

3239 
_‹¡_eof81
: 
cs
 = 81; 
_‹¡_eof
;

3240 
_‹¡_eof82
: 
cs
 = 82; 
_‹¡_eof
;

3241 
_‹¡_eof83
: 
cs
 = 83; 
_‹¡_eof
;

3242 
_‹¡_eof84
: 
cs
 = 84; 
_‹¡_eof
;

3243 
_‹¡_eof85
: 
cs
 = 85; 
_‹¡_eof
;

3244 
_‹¡_eof86
: 
cs
 = 86; 
_‹¡_eof
;

3245 
_‹¡_eof87
: 
cs
 = 87; 
_‹¡_eof
;

3246 
_‹¡_eof88
: 
cs
 = 88; 
_‹¡_eof
;

3247 
_‹¡_eof122
: 
cs
 = 122; 
_‹¡_eof
;

3248 
_‹¡_eof89
: 
cs
 = 89; 
_‹¡_eof
;

3249 
_‹¡_eof90
: 
cs
 = 90; 
_‹¡_eof
;

3250 
_‹¡_eof91
: 
cs
 = 91; 
_‹¡_eof
;

3251 
_‹¡_eof92
: 
cs
 = 92; 
_‹¡_eof
;

3252 
_‹¡_eof93
: 
cs
 = 93; 
_‹¡_eof
;

3253 
_‹¡_eof94
: 
cs
 = 94; 
_‹¡_eof
;

3254 
_‹¡_eof95
: 
cs
 = 95; 
_‹¡_eof
;

3255 
_‹¡_eof96
: 
cs
 = 96; 
_‹¡_eof
;

3256 
_‹¡_eof97
: 
cs
 = 97; 
_‹¡_eof
;

3257 
_‹¡_eof98
: 
cs
 = 98; 
_‹¡_eof
;

3258 
_‹¡_eof99
: 
cs
 = 99; 
_‹¡_eof
;

3259 
_‹¡_eof100
: 
cs
 = 100; 
_‹¡_eof
;

3260 
_‹¡_eof101
: 
cs
 = 101; 
_‹¡_eof
;

3261 
_‹¡_eof102
: 
cs
 = 102; 
_‹¡_eof
;

3262 
_‹¡_eof103
: 
cs
 = 103; 
_‹¡_eof
;

3263 
_‹¡_eof104
: 
cs
 = 104; 
_‹¡_eof
;

3264 
_‹¡_eof105
: 
cs
 = 105; 
_‹¡_eof
;

3265 
_‹¡_eof106
: 
cs
 = 106; 
_‹¡_eof
;

3266 
_‹¡_eof107
: 
cs
 = 107; 
_‹¡_eof
;

3267 
_‹¡_eof108
: 
cs
 = 108; 
_‹¡_eof
;

3268 
_‹¡_eof109
: 
cs
 = 109; 
_‹¡_eof
;

3269 
_‹¡_eof110
: 
cs
 = 110; 
_‹¡_eof
;

3270 
_‹¡_eof111
: 
cs
 = 111; 
_‹¡_eof
;

3271 
_‹¡_eof112
: 
cs
 = 112; 
_‹¡_eof
;

3272 
_‹¡_eof113
: 
cs
 = 113; 
_‹¡_eof
;

3273 
_‹¡_eof114
: 
cs
 = 114; 
_‹¡_eof
;

3274 
_‹¡_eof115
: 
cs
 = 115; 
_‹¡_eof
;

3275 
_‹¡_eof123
: 
cs
 = 123; 
_‹¡_eof
;

3276 
_‹¡_eof116
: 
cs
 = 116; 
_‹¡_eof
;

3277 
_‹¡_eof117
: 
cs
 = 117; 
_‹¡_eof
;

3278 
_‹¡_eof118
: 
cs
 = 118; 
_‹¡_eof
;

3279 
_‹¡_eof119
: 
cs
 = 119; 
_‹¡_eof
;

3281 
_‹¡_eof
: {}

3282 
_out
: {}

3287 
·r£r
->
cs
 = cs;

3288 
·r£r
->
Ä—d
 +ğ
p
 - (
bufãr
 + 
off
);

3290 
	`as£¹
(
p
 <ğ
³
 && "buffer overflow‡fter…arsingƒxecute");

3291 
	`as£¹
(
·r£r
->
Ä—d
 <ğ
Ën
 && "nread†ongerhan†ength");

3292 
	`as£¹
(
·r£r
->
body_¡¬t
 <ğ
Ën
 && "body starts‡fter bufferƒnd");

3293 
	`check
(
·r£r
->
m¬k
 < 
Ën
, "mark is‡fter bufferƒnd");

3294 
	`check
(
·r£r
->
f›ld_Ën
 <ğ
Ën
, "field has†ength†ongerhan whole buffer");

3295 
	`check
(
·r£r
->
f›ld_¡¬t
 < 
Ën
, "field starts‡fter bufferƒnd");

3297 if(
·r£r
->
body_¡¬t
) {

3299 
·r£r
->
Ä—d
++;

3302 (
·r£r
->
Ä—d
);

3304 
”rÜ
:

3306 
	}
}

3308 
	$h‰pş›Á_·r£r_fšish
(
h‰pş›Á_·r£r
 *
·r£r
)

3310 
cs
 = 
·r£r
->cs;

3312 
·r£r
->
cs
 = cs;

3314 ià(
	`h‰pş›Á_·r£r_has_”rÜ
(
·r£r
) ) {

3316 } ià(
	`h‰pş›Á_·r£r_is_fšished
(
·r£r
) ) {

3321 
	}
}

3323 
	$h‰pş›Á_·r£r_has_”rÜ
(
h‰pş›Á_·r£r
 *
·r£r
) {

3324  
·r£r
->
cs
 =ğ
h‰pş›Á_·r£r_”rÜ
;

3325 
	}
}

3327 
	$h‰pş›Á_·r£r_is_fšished
(
h‰pş›Á_·r£r
 *
·r£r
) {

3328  
·r£r
->
cs
 =ğ
h‰pş›Á_·r£r_fœ¡_fš®
;

3329 
	}
}

	@tools/src/http11/httpclient_parser.h

35 #iâdeà
h‰pş›Á_·r£r_h


36 
	#h‰pş›Á_·r£r_h


	)

38 
	~<h‰p11/h‰p11_commÚ.h
>

40 
	sh‰pş›Á_·r£r
 {

41 
	mcs
;

42 
size_t
 
	mbody_¡¬t
;

43 
	mcÚ‹Á_Ën
;

44 
	m¡©us
;

45 
	mchunked
;

46 
	mchunks_dÚe
;

47 
	mşo£
;

48 
size_t
 
	mÄ—d
;

49 
size_t
 
	mm¬k
;

50 
size_t
 
	mf›ld_¡¬t
;

51 
size_t
 
	mf›ld_Ën
;

53 *
	md©a
;

55 
f›ld_cb
 
	mh‰p_f›ld
;

56 
–em’t_cb
 
	m»asÚ_ph¿£
;

57 
–em’t_cb
 
	m¡©us_code
;

58 
–em’t_cb
 
	mchunk_size
;

59 
–em’t_cb
 
	mh‰p_v”siÚ
;

60 
–em’t_cb
 
	mh—d”_dÚe
;

61 
–em’t_cb
 
	mÏ¡_chunk
;

64 } 
	th‰pş›Á_·r£r
;

66 
h‰pş›Á_·r£r_š™
(
h‰pş›Á_·r£r
 *
·r£r
);

67 
h‰pş›Á_·r£r_fšish
(
h‰pş›Á_·r£r
 *
·r£r
);

68 
h‰pş›Á_·r£r_execu‹
(
h‰pş›Á_·r£r
 *
·r£r
, cÚ¡ *
d©a
, 
size_t
 
Ën
, size_ˆ
off
);

69 
h‰pş›Á_·r£r_has_”rÜ
(
h‰pş›Á_·r£r
 *
·r£r
);

70 
h‰pş›Á_·r£r_is_fšished
(
h‰pş›Á_·r£r
 *
·r£r
);

72 
	#h‰pş›Á_·r£r_Ä—d
(
·r£r
èÕ¬£r)->
Ä—d


	)

	@tools/src/io.c

35 
	#_XOPEN_SOURCE
 500

	)

36 
	#_FILE_OFFSET_BITS
 64

	)

38 
	~"io.h
"

39 
	~"»gi¡”.h
"

40 
	~"mem/h®loc.h
"

41 
	~"dbg.h
"

42 
	~<¡dlib.h
>

43 
	~<as£¹.h
>

44 
	~<uni¡d.h
>

45 
	~<pŞ¬s¦/havege.h
>

46 
	~<pŞ¬s¦/s¦.h
>

47 
	~<sk/sk.h
>

49 
ssize_t
 
	$nuÎ_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

51  
Ën
;

52 
	}
}

54 
ssize_t
 
	$nuÎ_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

56  
Ën
;

57 
	}
}

59 
ssize_t
 
	$nuÎ_¡»am_fe
(
IOBuf
 *
iob
, 
fd
, 
off_t
 
Ën
)

61  
Ën
;

62 
	}
}

64 
ssize_t
 
	$¶aš‹xt_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

66  
	`fd£nd
(
iob
->
fd
, 
bufãr
, 
Ën
);

67 
	}
}

69 
ssize_t
 
	$¶aš‹xt_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

71  
	`fd»cv
(
iob
->
fd
, 
bufãr
, 
Ën
);

72 
	}
}

74 
ssize_t
 
	$fe_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

76  
	`fdwr™e
(
iob
->
fd
, 
bufãr
, 
Ën
);

77 
	}
}

79 
ssize_t
 
	$fe_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

81  
	`fd»ad
(
iob
->
fd
, 
bufãr
, 
Ën
);

82 
	}
}

84 
ssize_t
 
	$¶aš_¡»am_fe
(
IOBuf
 *
iob
, 
fd
, 
off_t
 
Ën
)

86 
off_t
 
£Á
 = 0;

87 
off_t
 
tÙ®
 = 0;

88 
off_t
 
off£t
 = 0;

89 
off_t
 
block_size
 = 
MAX_SEND_BUFFER
;

90 
cÚn_fd
 = 
	`IOBuf_fd
(
iob
);

92 
tÙ®
 = 0; 
	`fdwa™
(
cÚn_fd
, 'w'è=ğ0 &&Ù® < 
Ën
;Ù® +ğ
£Á
) {

94 
block_size
 = (
Ën
 - 
tÙ®
) > block_size ? block_size : (len -otal);

95 
£Á
 = 
	`IOBuf_£ndfe
(
cÚn_fd
, 
fd
, &
off£t
, 
block_size
);

97 
	`check
(
	`Regi¡”_wr™e
(
iob
->
fd
, 
£Á
) != -1, "Socket seemso be closed.");

99 
	`check_debug
(
£Á
 > 0, "Client closed…robably during sendfile on socket: %d from "

100 "f%d", 
cÚn_fd
, 
fd
);

103 
	`check
(
tÙ®
 <ğ
Ën
,

105 ()
tÙ®
, 
Ën
);

107 
	`check
(
tÙ®
 =ğ
Ën
,

109 ()
tÙ®
, 
Ën
);

111  
tÙ®
;

113 
”rÜ
:

115 
	}
}

117 
	$s¦_fd£nd_w¿µ”
(*
p_iob
, *
ubufãr
, 
Ën
)

119 
IOBuf
 *
iob
 = (IOBuà*è
p_iob
;

120  
	`fd£nd
(
iob
->
fd
, (*è
ubufãr
, 
Ën
);

121 
	}
}

123 
	$s¦_fd»cv_w¿µ”
(*
p_iob
, *
ubufãr
, 
Ën
)

125 
IOBuf
 *
iob
 = (IOBuà*è
p_iob
;

126  
	`fd»cv1
(
iob
->
fd
, (*è
ubufãr
, 
Ën
);

127 
	}
}

129 
	$s¦_do_hªdshake
(
IOBuf
 *
iob
)

131 
rcode
;

132 
	`check
(!
iob
->
hªdshake_³rfÜmed
, "ssl_do_handshake called unnecessarily");

133 (
rcode
 = 
	`s¦_hªdshake
(&
iob
->
s¦
)) != 0) {

134 
	`check
(
rcode
 =ğ
POLARSSL_ERR_NET_TRY_AGAIN
,

135 "hªdshakçed w™hƒ¼Ü cod%d", 
rcode
);

137 
iob
->
hªdshake_³rfÜmed
 = 1;

139 
”rÜ
:

141 
	}
}

143 
ssize_t
 
	$s¦_£nd
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

145 
ssize_t
 
£Á
 = 0;

147 
	`check
(
iob
->
u£_s¦
, "IOBuf‚ot set upo use ssl");

148 if(!
iob
->
hªdshake_³rfÜmed
) {

149 
rcode
 = 
	`s¦_do_hªdshake
(
iob
);

150 
	`check
(
rcode
 == 0, "handshake failed");

155 
£Á
 +ğ
	`s¦_wr™e
(&
iob
->
s¦
, (cÚ¡ *è(
bufãr
 + s’t), (
Ën
 - sent));

156 } 
£Á
 < 
Ën
);

158  
£Á
;

159 
”rÜ
:

161 
	}
}

163 
ssize_t
 
	$s¦_»cv
(
IOBuf
 *
iob
, *
bufãr
, 
Ën
)

165 
	`check
(
iob
->
u£_s¦
, "IOBuf‚ot set upo use ssl");

166 if(!
iob
->
hªdshake_³rfÜmed
) {

167 
rcode
 = 
	`s¦_do_hªdshake
(
iob
);

168 
	`check
(
rcode
 == 0, "handshake failed");

170  
	`s¦_»ad
(&
iob
->
s¦
, (*è
bufãr
, 
Ën
);

171 
”rÜ
:

173 
	}
}

175 
ssize_t
 
	$s¦_¡»am_fe
(
IOBuf
 *
iob
, 
fd
, 
off_t
 
Ën
)

177 
ssize_t
 
£Á
 = 0;

178 
off_t
 
tÙ®
 = 0;

179 
ssize_t
 
amt
 = 0;

180 
ssize_t
 
to£nd
 = 0;

181 
cÚn_fd
 = 
	`IOBuf_fd
(
iob
);

182 
buff
[1024];

184 
tÙ®
 = 0; 
	`fdwa™
(
cÚn_fd
, 'w'è=ğ0 &&Ù® < 
Ën
;Ù® +ğ
to£nd
) {

185 
to£nd
 = 
	`´—d
(
fd
, 
buff
, (buff), 
tÙ®
);

186 
	`check_debug
(
to£nd
 > 0, "Camu°shÜˆš„—dšg f%d\n", 
fd
);

190 if(
to£nd
 + 
tÙ®
 > 
Ën
)

191 
to£nd
 = 
Ën
 - 
tÙ®
;

193 
£Á
 = 0;

194 
£Á
 < 
to£nd
) {

195 
amt
 = 
	`s¦_£nd
(
iob
, 
buff
, 
to£nd
);

196 
	`check_debug
(
amt
 > 0, "ssl_send failed in ssl_stream_file with "

197 "»tuº cod%zd", 
amt
);

198 
£Á
 +ğ
amt
;

201 
	`check
(
	`Regi¡”_wr™e
(
iob
->
fd
, 
£Á
) != -1, "Failedo„ecord write, must have died.");

204 
	`check
(
tÙ®
 <ğ
Ën
,

206 ()
tÙ®
, 
Ën
);

208 
	`check
(
tÙ®
 =ğ
Ën
,

210 ()
tÙ®
, 
Ën
);

212  
tÙ®
;

214 
”rÜ
:

216 
	}
}

218 
	$s¦_debug
(*
p
, 
Ëv–
, cÚ¡ *
msg
) {

219 if(
Ëv–
 < 2) {

220 
	`debug
("pŞ¬s¦: %s", 
msg
);

222 
	}
}

224 
IOBuf
 *
	$IOBuf_ü—‹
(
size_t
 
Ën
, 
fd
, 
IOBufTy³
 
ty³
)

226 
IOBuf
 *
buf
 = 
	`h_ÿÎoc
((IOBuf), 1);

227 
	`check_mem
(
buf
);

229 
buf
->
fd
 = fd;

230 
buf
->
Ën
 =†en;

232 
buf
->buàğ
	`h_m®loc
(
Ën
 + 1);

233 
	`check_mem
(
buf
->buf);

235 
	`h©ch
(
buf
->buf, buf);

237 
buf
->
ty³
 =ype;

239 if(
ty³
 =ğ
IOBUF_SSL
) {

240 
buf
->
u£_s¦
 = 1;

241 
buf
->
hªdshake_³rfÜmed
 = 0;

242 
	`s¦_š™
(&
buf
->
s¦
);

243 
	`s¦_£t_’dpošt
(&
buf
->
s¦
, 
SSL_IS_SERVER
);

244 
	`s¦_£t_authmode
(&
buf
->
s¦
, 
SSL_VERIFY_NONE
);

245 
	`havege_š™
(&
buf
->
hs
);

246 
	`s¦_£t_ºg
(&
buf
->
s¦
, 
havege_¿nd
, &buf->
hs
);

247 
	`s¦_£t_dbg
(&
buf
->
s¦
, 
s¦_debug
, 
NULL
);

248 
	`s¦_£t_bio
(&
buf
->
s¦
, 
s¦_fd»cv_w¿µ”
, buf,

249 
s¦_fd£nd_w¿µ”
, 
buf
);

250 
	`s¦_£t_£ssiÚ
(&
buf
->
s¦
, 1, 0, &buf->
s¢
);

251 
	`mem£t
(&
buf
->
s¢
, 0, (buf->ssn));

253 
buf
->
£nd
 = 
s¦_£nd
;

254 
buf
->
»cv
 = 
s¦_»cv
;

255 
buf
->
¡»am_fe
 = 
s¦_¡»am_fe
;

256 } if(
ty³
 =ğ
IOBUF_NULL
) {

257 
buf
->
£nd
 = 
nuÎ_£nd
;

258 
buf
->
»cv
 = 
nuÎ_»cv
;

259 
buf
->
¡»am_fe
 = 
nuÎ_¡»am_fe
;

260 } if(
ty³
 =ğ
IOBUF_FILE
) {

261 
buf
->
£nd
 = 
fe_£nd
;

262 
buf
->
»cv
 = 
fe_»cv
;

263 
buf
->
¡»am_fe
 = 
¶aš_¡»am_fe
;

264 } if(
ty³
 =ğ
IOBUF_SOCKET
) {

265 
buf
->
£nd
 = 
¶aš‹xt_£nd
;

266 
buf
->
»cv
 = 
¶aš‹xt_»cv
;

267 
buf
->
¡»am_fe
 = 
¶aš_¡»am_fe
;

269 
	`£Áš–
("Inv®id IOBufTy³ giv’: %d", 
ty³
);

272  
buf
;

274 
”rÜ
:

275 if(
buf
è
	`h_ä“
(buf);

276  
NULL
;

277 
	}
}

279 
	$IOBuf_de¡roy
(
IOBuf
 *
buf
)

281 if(
buf
) {

282 if(
buf
->
u£_s¦
) {

283 
	`s¦_şo£_nÙify
(&
buf
->
s¦
);

284 
	`s¦_ä“
(&
buf
->
s¦
);

287 
	`fdşo£
(
buf
->
fd
);

288 
	`h_ä“
(
buf
);

290 
	}
}

292 
	$IOBuf_»size
(
IOBuf
 *
buf
, 
size_t
 
Ãw_size
)

294 
buf
->buàğ
	`h_»®loc
(buf->buf, 
Ãw_size
);

295 
buf
->
Ën
 = 
Ãw_size
;

296 
	}
}

299 
šlše
 
	$IOBuf_com·ù
(
IOBuf
 *
buf
)

301 
	`memmove
(
buf
->buf, 
	`IOBuf_¡¬t
(buf), buf->
ava
);

302 
buf
->
cur
 = 0;

303 
	}
}

320 *
	$IOBuf_»ad
(
IOBuf
 *
buf
, 
Ãed
, *
out_Ën
)

322 
rc
 = 0;

323 
	`as£¹
(
buf
->
cur
 + buf->
ava
 <ğbuf->
Ën
 &&

325 
	`as£¹
(
buf
->
cur
 >= 0 && "Buffer cur can't be < 0");

326 
	`as£¹
(
buf
->
ava
 >= 0 && "Buffer‡vail can't be < 0");

327 
	`as£¹
(
Ãed
 <ğ
buf
->
Ën
 && "Request for morehan…ossible inhe buffer.");

329 if(
	`IOBuf_şo£d
(
buf
)) {

330 if(
buf
->
ava
 > 0) {

331 *
out_Ën
 = 
buf
->
ava
;

333 *
out_Ën
 = 0;

334  
NULL
;

336 } if(
buf
->
ava
 < 
Ãed
) {

337 if(
buf
->
cur
 > 0 && 
	`IOBuf_com·ù_Ãeded
(buf, 
Ãed
)) {

338 
	`IOBuf_com·ù
(
buf
);

340 
rc
 = 
buf
->
	`»cv
(buf, 
	`IOBuf_»ad_pošt
(buf), 
	`IOBuf_»maššg
(buf));

342 if(
rc
 <= 0) {

343 
	`debug
("Sock‘ wa şo£d, wÈ»tuº oÆy wh©' avaabË: %d", 
buf
->
ava
);

344 
buf
->
şo£d
 = 1;

346 
buf
->
ava
 = buf->ava + 
rc
;

349 if(
buf
->
ava
 < 
Ãed
) {

351 *
out_Ën
 = 
buf
->
ava
;

354 *
out_Ën
 = 
Ãed
;

356 } if(
buf
->
ava
 >ğ
Ãed
) {

357 *
out_Ën
 = 
Ãed
;

359 
	`£Áš–
("Invalid branch…rocessing buffer, Tell Zed.");

362  
	`IOBuf_¡¬t
(
buf
);

364 
”rÜ
:

365  
NULL
;

366 
	}
}

374 
	$IOBuf_»ad_comm™
(
IOBuf
 *
buf
, 
Ãed
)

376 
buf
->
ava
 -ğ
Ãed
;

377 
	`as£¹
(
buf
->
ava
 >= 0 && "Buffer commit„educed‡vailo < 0.");

379 
	`check
(
	`Regi¡”_»ad
(
buf
->
fd
, 
Ãed
) != -1, "Failedo„ecord„ead, must have died.");

381 
buf
->
m¬k
 = 0;

383 if(
buf
->
ava
 == 0) {

385 
buf
->
cur
 = 0;

387 
buf
->
cur
 +ğ
Ãed
;

391 
”rÜ
:

393 
	}
}

399 
	$IOBuf_£nd
(
IOBuf
 *
buf
, *
d©a
, 
Ën
)

401 
rc
 = 0;

403 
rc
 = 
buf
->
	`£nd
(buf, 
d©a
, 
Ën
);

405 if(
rc
 >= 0) {

406 
	`check
(
	`Regi¡”_wr™e
(
buf
->
fd
, 
rc
) != -1, "Failedo„ecord write, must have died.");

408 
buf
->
şo£d
 = 1;

411  
rc
;

413 
”rÜ
:

415 
	}
}

421 *
	$IOBuf_»ad_®l
(
IOBuf
 *
buf
, 
Ën
, 
»Œ›s
)

423 
Ä—d
 = 0;

424 
©‹m±s
 = 0;

426 
	`check_debug
(!
	`IOBuf_şo£d
(
buf
), "Closed when‡ttemptingo„ead from buffer.");

428 if(
Ën
 > 
buf
->len) {

430 
	`IOBuf_»size
(
buf
, 
Ën
);

433 *
d©a
 = 
	`IOBuf_»ad
(
buf
, 
Ën
, &
Ä—d
);

435 
	`debug
("INITIAL READ:†’: %d,‚»ad: %d", 
Ën
, 
Ä—d
);

436 
©‹m±s
 = 0; 
Ä—d
 < 
Ën
;‡ttempts++) {

437 
d©a
 = 
	`IOBuf_»ad
(
buf
, 
Ën
, &
Ä—d
);

439 
	`check_debug
(
d©a
, "Readƒrror from socket.");

440 
	`as£¹
(
Ä—d
 <ğ
Ën
 && "Invalid‚read size (too much) on IOBuf„ead.");

442 if(
Ä—d
 =ğ
Ën
) {

445 
	`fdwa™
(
buf
->
fd
, 'r');

449 
	`debug
("ATTEMPTS: %d, RETRIES: %d", 
©‹m±s
, 
»Œ›s
);

451 if(
©‹m±s
 > 
»Œ›s
) {

452 
	`log_w¬n
("R—d oà%d†’gth‡‰em±ed %dime which i ov” %d„‘ry†im™..", 
Ën
, 
©‹m±s
, 
»Œ›s
);

455 
	`check
(
	`IOBuf_»ad_comm™
(
buf
, 
Ën
) != -1, "Final commit failed of„ead_all.");

456  
d©a
;

458 
”rÜ
:

459 
buf
->
şo£d
 = 1;

460  
NULL
;

461 
	}
}

468 
	$IOBuf_¡»am
(
IOBuf
 *
äom
, IOBuà*
to
, 
tÙ®
)

470 
Ãed
 = 0;

471 
»maš
 = 
tÙ®
;

472 
ava
 = 0;

473 
rc
 = 0;

474 *
d©a
 = 
NULL
;

476 if(
äom
->
Ën
 > 
to
->Ënè
	`IOBuf_»size
(to, from->len);

478 
»maš
 > 0) {

479 
Ãed
 = 
»maš
 <ğ
äom
->
Ën
 ?„emain : from->len;

481 
d©a
 = 
	`IOBuf_»ad
(
äom
, 
Ãed
, &
ava
);

482 
	`check_debug
(
ava
 > 0, "Nothing in„ead buffer.");

484 
rc
 = 
	`IOBuf_£nd_®l
(
to
, 
	`IOBuf_¡¬t
(
äom
), 
ava
);

485 
	`check_debug
(
rc
 =ğ
ava
, "Failedo send‡ll ofhe data: %d of %d",„c,‡vail)

488 
	`check
(
	`IOBuf_»ad_comm™
(
äom
, 
rc
) != -1, "Final commit failed during streaming.");

491 
»maš
 -ğ
rc
;

494 
	`as£¹
(
»maš
 == 0 && "Buffer math is wrong.");

496  
tÙ®
 - 
»maš
;

498 
”rÜ
:

500 
	}
}

504 
	$IOBuf_£nd_®l
(
IOBuf
 *
buf
, *
d©a
, 
Ën
)

506 
rc
 = 0;

507 
tÙ®
 = 
Ën
;

510 
rc
 = 
	`IOBuf_£nd
(
buf
, 
d©a
, 
tÙ®
);

511 
	`check
(
rc
 > 0, "Writeƒrror when sending‡ll.");

512 
tÙ®
 -ğ
rc
;

513 } 
tÙ®
 > 0);

515 
	`as£¹
(
tÙ®
 == 0 && "Mathƒrror sending‡ll from buffer.");

517  
Ën
;

519 
”rÜ
:

521 
	}
}

523 
	$IOBuf_¡»am_fe
(
IOBuf
 *
buf
, 
fd
, 
off_t
 
Ën
)

525 
rc
 = 0;

530 
rc
 = 
buf
->
	`¡»am_fe
(buf, 
fd
, 
Ën
);

532 if(
rc
 < 0è
buf
->
şo£d
 = 1;

534  
rc
;

535 
	}
}

539 
	$debug_dump
(*
addr
, 
Ën
)

541 #ifdeà
NDEBUG


545 
tohex
[] = "0123456789ABCDEF";

546 
i
 = 0;

547 *
pc
 = 
addr
;

549 
buf0
[32] = {0};

550 
buf1
[64] = {0};

551 
buf2
[64] = {0};

553 *
pc1
 = 
NULL
;

554 *
pc2
 = 
NULL
;

558 --
Ën
 >= 0) {

560 if(
i
 % 16 == 0) {

561 
	`¥rštf
(
buf0
, "%08x", 
i
);

562 
buf1
[0] = 0;

563 
buf2
[0] = 0;

564 
pc1
 = 
buf1
;

565 
pc2
 = 
buf2
;

568 *
pc1
++ = 
tohex
[*
pc
 >> 4];

569 *
pc1
++ = 
tohex
[*
pc
 & 15];

570 *
pc1
++ = ' ';

572 if(*
pc
 >= 32 && *pc < 127) {

573 *
pc2
++ = *
pc
;

575 *
pc2
++ = '.';

578 
i
++;

579 
pc
++;

581 if(
i
 % 16 == 0) {

582 *
pc1
 = 0;

583 *
pc2
 = 0;

584 
	`debug
("%s: %  %s", 
buf0
, 
buf1
, 
buf2
);

589 if(
i
 % 16 != 0) {

590 
i
 % 16 != 0) {

591 *
pc1
++ = ' ';

592 *
pc1
++ = ' ';

593 *
pc1
++ = ' ';

594 *
pc2
++ = ' ';

595 
i
++;

598 *
pc1
 = 0;

599 *
pc2
 = 0;

600 
	`debug
("%s: %  %s", 
buf0
, 
buf1
, 
buf2
);

602 
	}
}

	@tools/src/io.h

1 #iâdeà
_io_h


2 
	#_io_h


	)

4 #iâdeà
_FILE_OFFSET_BITS


5 
	#_FILE_OFFSET_BITS
 64

	)

8 
	~<¡dlib.h
>

9 
	~<pŞ¬s¦/x509.h
>

10 
	~<pŞ¬s¦/r§.h
>

11 
	~<pŞ¬s¦/s¦.h
>

12 
	~<pŞ¬s¦/havege.h
>

14 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

15 
	~"bsd_¥ecific.h
"

17 
	~<sys/£ndfe.h
>

20 
MAX_SEND_BUFFER
;

22 
	gIOBuf
;

24 
	$ssize_t
 (*
	tio_cb
)(
	tIOBuf
 *, *
	td©a
, 
	tËn
);

25 
	$ssize_t
 (*
	tio_¡»am_fe_cb
)(
	tIOBuf
 *, 
	tfd
, 
	toff_t
 
	tËn
);

27 
	eIOBufTy³
 {

28 
IOBUF_SSL
, 
IOBUF_SOCKET
, 
IOBUF_FILE
, 
IOBUF_NULL


29 } 
	tIOBufTy³
;

31 
	sIOBuf
 {

34 
Ën
;

37 
ava
;

40 
cur
;

43 
m¬k
;

45 
şo£d
;

46 
io_cb
 
»cv
;

47 
io_cb
 
£nd
;

48 
io_¡»am_fe_cb
 
¡»am_fe
;

49 *
buf
;

51 
ty³
;

53 
fd
;

54 
u£_s¦
;

55 
hªdshake_³rfÜmed
;

56 
s¦_cÚ‹xt
 
s¦
;

57 
s¦_£ssiÚ
 
s¢
;

58 
havege_¡©e
 
hs
;

59 } 
	tIOBuf
;

61 
IOBuf
 *
	`IOBuf_ü—‹
(
size_t
 
Ën
, 
fd
, 
IOBufTy³
 
ty³
);

63 
	`IOBuf_»size
(
IOBuf
 *
buf
, 
size_t
 
Ãw_size
);

65 
	`IOBuf_de¡roy
(
IOBuf
 *
buf
);

67 *
	`IOBuf_»ad
(
IOBuf
 *
buf
, 
Ãed
, *
out_Ën
);

68 
	`IOBuf_»ad_comm™
(
IOBuf
 *
buf
, 
Ãed
);

70 
	`IOBuf_£nd
(
IOBuf
 *
buf
, *
d©a
, 
Ën
);

72 
	`IOBuf_£nd_®l
(
IOBuf
 *
buf
, *
d©a
, 
Ën
);

74 *
	`IOBuf_»ad_®l
(
IOBuf
 *
buf
, 
Ën
, 
»Œ›s
);

76 
	`IOBuf_¡»am
(
IOBuf
 *
äom
, IOBuà*
to
, 
tÙ®
);

78 
	`IOBuf_¡»am_fe
(
IOBuf
 *
buf
, 
fd
, 
off_t
 
Ën
);

80 
	#IOBuf_»ad_some
(
I
,
A
è
	`IOBuf_»ad
((I), (I)->
Ën
, A)

	)

82 
	#IOBuf_şo£d
(
I
è((I)->
şo£d
)

	)

84 
	#IOBuf_com·ù_Ãeded
(
I
,
N
è((I)->
cur
 + (Nè> (I)->
Ën
)

	)

86 
	#IOBuf_»maššg
(
I
è((I)->
Ën
 - (I)->
ava
 - (I)->
cur
)

	)

87 
	#IOBuf_»ad_pošt
(
I
è((I)->
buf
 + (I)->
cur
 + (I)->
ava
)

	)

88 
	#IOBuf_¡¬t
(
I
è((I)->
buf
 + (I)->
cur
)

	)

90 
	#IOBuf_£t_m¬k
(
I
, 
N
è((I)->
m¬k
 = (N))

	)

91 
	#IOBuf_m¬k
(
I
è((I)->
m¬k
)

	)

93 
	#IOBuf_ava
(
I
è((I)->
ava
)

	)

95 
	#IOBuf_fd
(
I
è((I)->
fd
)

	)

97 #ià
	`defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

98 
	#IOBuf_£ndfe
 
bsd_£ndfe


	)

100 
	#IOBuf_£ndfe
 
£ndfe


	)

	@tools/src/log.c

35 
	~"log.h
"

36 
	~"dbg.h
"

37 
	~"»que¡.h
"

38 
	~"h—d”s.h
"

39 
	~"£‰šg.h
"

40 
	~"Š‘¡ršgs.h
"

41 
	~<¡dio.h
>

42 
	~<zmq.h
>

43 
	~<±h»ad.h
>

45 *
	gLOG_SOCKET
 = 
NULL
;

46 
±h»ad_t
 
	gLOG_THREAD
;

48 
	sLogCÚfig
 {

49 
b¡ršg
 
	mfe_Çme
;

50 
b¡ršg
 
	mlog_¥ec
;

51 
FILE
 *
	mlog_fe
;

52 } 
	tLogCÚfig
;

55 
	$LogCÚfig_de¡roy
(
LogCÚfig
 *
cÚfig
)

57 if(
cÚfig
) {

58 
	`bde¡roy
(
cÚfig
->
fe_Çme
);

59 
	`bde¡roy
(
cÚfig
->
log_¥ec
);

60 if(
cÚfig
->
log_fe
è
	`fşo£
(config->log_file);

61 
	`ä“
(
cÚfig
);

63 
	}
}

65 *
	$Log_š‹º®_th»ad
(*
¥ec
)

67 
zmq_msg_t
 
msg
;

68 
rc
 = 0;

69 
LogCÚfig
 *
cÚfig
 = 
¥ec
;

71 *
sock‘
 = 
	`zmq_sock‘
(
ZMQ_CTX
, 
ZMQ_SUB
);

72 
	`check
(
sock‘
, "Could‚ot bindhe†ogging subscribe socket.");

76 
rc
 = 
	`zmq_£tsockİt
(
sock‘
, 
ZMQ_SUBSCRIBE
, "", 0);

77 
	`check
(
rc
 == 0, "Could‚ot subscribeohe†ogger.");

79 #ifdeà
ZMQ_LINGER


80 
İt
 = 0;

81 
rc
 = 
	`zmq_£tsockİt
(
sock‘
, 
ZMQ_LINGER
, &
İt
, (opt));

82 
	`check
(
rc
 == 0, "Could‚ot sethe†inger option.");

85 
rc
 = 
	`zmq_cÚÃù
(
sock‘
, 
	`bd©a
(
cÚfig
->
log_¥ec
));

86 
	`check
(
rc
 =ğ0, "Could cÚÃùØloggšgƒndpošt: %s", 
	`bd©a
(
cÚfig
->
log_¥ec
));

90 
rc
 = 
	`zmq_msg_š™
(&
msg
);

91 
	`check
(
rc
 == 0, "Failedo initialize message.");

93 
rc
 = 
	`zmq_»cv
(
sock‘
, &
msg
, 0);

94 if(
rc
 =ğ-1 && 
”ºo
 =ğ
ETERM
) {

98 
	`check
(
rc
 == 0, "Failedo„eceive fromhe zeromq†ogging socket");

99 
	`check
(
	`zmq_msg_size
(&
msg
) > 0, "Received…oison…ill,†oghreadƒxiting.");

101 
	`årštf
(
cÚfig
->
log_fe
, "%.*s", ()
	`zmq_msg_size
(&
msg
), (*)
	`zmq_msg_d©a
(&msg));

103 
rc
 = 
	`zmq_msg_şo£
(&
msg
);

104 
	`check
(
rc
 == 0, "Message close failed.");

107 
rc
 = 
	`zmq_şo£
(
sock‘
);

108 
	`check
(
rc
 == 0, "Could‚ot close socket");

110 
	`LogCÚfig_de¡roy
(
cÚfig
);

111  
NULL
;

113 
”rÜ
:

114 
	`LogCÚfig_de¡roy
(
cÚfig
);

116  
NULL
;

117 
	}
}

120 
LogCÚfig
 *
	$LogCÚfig_ü—‹
(
b¡ršg
 
acûss_log
, b¡ršg 
log_¥ec
)

122 
LogCÚfig
 *
cÚfig
 = 
	`m®loc
((LogConfig));

123 
cÚfig
->
log_¥ec
 =†og_spec;

124 
cÚfig
->
fe_Çme
 = 
acûss_log
;

126 
cÚfig
->
log_fe
 = 
	`fİ’
((*)cÚfig->
fe_Çme
->
d©a
, "a+");

127 
	`check
(
cÚfig
->
log_fe
, "FaedØİ’†og fe: % fÜ‡cûs loggšg.", 
	`bd©a
(cÚfig->
fe_Çme
));

128 
	`£tbuf
(
cÚfig
->
log_fe
, 
NULL
);

130  
cÚfig
;

132 
”rÜ
:

133 
	`LogCÚfig_de¡roy
(
cÚfig
);

134  
NULL
;

135 
	}
}

138 
	$Log_š™
(
b¡ršg
 
acûss_log
, b¡ršg 
log_¥ec
)

140 
rc
 = 0;

141 
LogCÚfig
 *
cÚfig
 = 
NULL
;

143 if(
LOG_SOCKET
 =ğ
NULL
)

145 
	`check
(
ZMQ_CTX
, "No ZMQ context, cannot start‡ccess†og.");

147 if(
	`S‘tšg_g‘_št
("disable.access_logging", 0))

149 
	`log_šfo
("Access†og is disabled‡ccordingo disable.access_logging.");

153 
cÚfig
 = 
	`LogCÚfig_ü—‹
(
acûss_log
, 
log_¥ec
);

154 
	`check
(
cÚfig
, "Failedo configure‡ccess†ogging.");

156 
LOG_SOCKET
 = 
	`zmq_sock‘
(
ZMQ_CTX
, 
ZMQ_PUB
);

157 
	`check
(
LOG_SOCKET
 !ğ
NULL
, "Failedo create‡ccess†og socket");

159 #ifdeà
ZMQ_LINGER


160 
İt
 = 0;

161 
rc
 = 
	`zmq_£tsockİt
(
LOG_SOCKET
, 
ZMQ_LINGER
, &
İt
, (opt));

162 
	`check
(
rc
 == 0, "Could‚ot sethe†inger option.");

165 
rc
 = 
	`zmq_bšd
(
LOG_SOCKET
, 
	`bd©a
(
log_¥ec
));

166 
	`check
(
rc
 == 0, "Failedo bind‡ccess_log zeromq socket.");

168 
	`±h»ad_ü—‹
(&
LOG_THREAD
, 
NULL
, 
Log_š‹º®_th»ad
, 
cÚfig
);

173 
”rÜ
:

175 
	`LogCÚfig_de¡roy
(
cÚfig
);

177 
	}
}

180 
	$Log_poisÚ_wÜk”s
()

182 
	`check
(
LOG_SOCKET
 !ğ
NULL
, "No‡ccess†og socket.");

184 
zmq_msg_t
 
msg
;

185 
rc
 = 
	`zmq_msg_š™_size
(&
msg
, 0);

186 
	`check
(
rc
 == 0, "Could‚ot create zmq message.");

188 
rc
 = 
	`zmq_£nd
(
LOG_SOCKET
, &
msg
, 0);

189 
	`check
(
rc
 == 0, "Could‚ot send message");

191 
rc
 = 
	`zmq_msg_şo£
(&
msg
);

192 
	`check
(
rc
 == 0, "Failedo close message object");

195 
”rÜ
:

196 
	`zmq_msg_şo£
(&
msg
);

198 
	}
}

200 
šlše
 
b¡ršg
 
	$make_log_mes§ge
(
Reque¡
 *
»q
, cÚ¡ *
»mÙe_addr
,

201 
»mÙe_pÜt
, 
¡©us
, 
size
)

203 
b¡ršg
 
»que¡_m‘hod
 = 
NULL
;

205 ià(
	`Reque¡_is_jsÚ
(
»q
)) {

206 
»que¡_m‘hod
 = &
JSON_METHOD
;

207 } ià(
	`Reque¡_is_xml
(
»q
)) {

208 
»que¡_m‘hod
 = &
XML_METHOD
;

210 
»que¡_m‘hod
 = 
»q
->request_method;

213 
Šs_outbuf
 
outbuf
 = {.
bufãr
 = 
NULL
};

214 
b¡ršg
 
b_‹mp
;

216 
	`check
(
	`Šs_»nd”_log_¡¬t
(&
outbuf
), "Could‚ot initialize buffer");

218 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, 
size
);

219 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, 
¡©us
);

221 
b_‹mp
 = 
	`bäomc¡r
(
	`Reque¡_is_jsÚ
(
»q
è? "" : 
	`bd©a
Ôeq->
v”siÚ
));

222 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
b_‹mp
);

223 
	`bde¡roy
(
b_‹mp
);

225 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
	`Reque¡_·th
(
»q
));

226 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
»que¡_m‘hod
);

227 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, (è
	`time
(
NULL
));

228 
	`Šs_»nd”_numb”_´•’d
(&
outbuf
, 
»mÙe_pÜt
);

230 
b_‹mp
 = 
	`bäomc¡r
(
»mÙe_addr
);

231 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
b_‹mp
);

232 
	`bde¡roy
(
b_‹mp
);

234 
	`Šs_»nd”_¡ršg_´•’d
(&
outbuf
, 
»q
->
rg‘_ho¡
->
Çme
);

236 
	`Šs_»nd”_log_’d
(&
outbuf
);

239 
b¡ršg
 
log_d©a
 = 
	`Šs_outbuf_to_b¡ršg
(&
outbuf
);

240 
	`bcÚch¬
(
log_d©a
, '\n');

242  
log_d©a
;

244 
”rÜ
:

246  
NULL
;

247 
	}
}

249 
	$ä“_log_msg
(*
d©a
, *
hšt
)

251 
	`bde¡roy
((
b¡ršg
)
hšt
);

252 
	}
}

254 
	$Log_»que¡
(
CÚÃùiÚ
 *
cÚn
, 
¡©us
, 
size
)

256 
zmq_msg_t
 
msg
;

258 if(
LOG_SOCKET
 =ğ
NULL
)

261 
b¡ršg
 
log_d©a
 = 
	`make_log_mes§ge
(
cÚn
->
»q
, cÚn->
»mÙe
, cÚn->
½Üt
, 
¡©us
, 
size
);

262 
	`check_mem
(
log_d©a
);

264 
rc
 = 
	`zmq_msg_š™_d©a
(&
msg
, 
	`bd©a
(
log_d©a
), 
	`bËngth
(log_data),

265 
ä“_log_msg
, 
log_d©a
);

266 
	`check
(
rc
 =ğ0, "Could‚Ù c¿á mes§gfÜ†og mes§g'%s'.", 
	`bd©a
(
log_d©a
));

268 
rc
 = 
	`zmq_£nd
(
LOG_SOCKET
, &
msg
, 0);

269 
	`check
(
rc
 == 0, "Could‚ot send†og messageo socket.");

271 
log_d©a
 = 
NULL
;

272 
rc
 = 
	`zmq_msg_şo£
(&
msg
);

273 
	`check
(
rc
 == 0, "Failedo close message object.");

277 
”rÜ
:

278 
	`bde¡roy
(
log_d©a
);

279 
	`zmq_msg_şo£
(&
msg
);

281 
	}
}

283 
	$Log_‹rm
()

285 if(
LOG_SOCKET
 =ğ
NULL
)

288 
rc
 = 
	`zmq_şo£
(
LOG_SOCKET
);

289 
	`check
(
rc
 == 0, "Failedo close‡ccess†og socket.");

293 
”rÜ
:

295 
	}
}

	@tools/src/log.h

1 #iâdeà
_log_h


2 
	#_log_h


	)

4 
	~"£rv”.h
"

5 
	~"cÚÃùiÚ.h
"

7 
Log_š™
(
b¡ršg
 
acûss_log
, b¡ršg 
log_¥ec
);

9 
Log_bšd
(cÚ¡ *
’dpošt
);

11 
Log_poisÚ_wÜk”s
();

13 
Log_»que¡
(
CÚÃùiÚ
 *
cÚn
, 
¡©us
, 
size
);

15 
Log_‹rm
();

	@tools/src/mem/align.h

15 #iâdeà
_LIBP_ALIGN_H_


16 
	#_LIBP_ALIGN_H_


	)

21 
	umax_®ign


23 
	mc
;

24 
	ms
;

25 
	ml
;

26 
	mi
;

27 
	mf
;

28 
	md
;

29 * 
	mv
;

30 (*
	mq
)();

33 
max_®ign
 
	tmax_®ign_t
;

	@tools/src/mem/halloc.c

15 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD
)

16 
	~<¡dlib.h
>

18 
	~<m®loc.h
>

20 
	~<¡ršg.h
>

22 
	~"h®loc.h
"

23 
	~"®ign.h
"

24 
	~"hli¡.h
"

29 
	shblock


31 #iâdeà
NDEBUG


32 
	#HH_MAGIC
 0x20040518L

	)

33 
	mmagic
;

35 
hli¡_™em_t
 
	msiblšgs
;

36 
hli¡_h—d_t
 
	mchd»n
;

37 
max_®ign_t
 
	md©a
[1];

39 } 
	thblock_t
;

41 
	#sizeof_hblock
 
	`off£tof
(
hblock_t
, 
d©a
)

	)

46 
»®loc_t
 
	gh®loc_®loÿtÜ
 = 
NULL
;

48 
	#®loÿtÜ
 
h®loc_®loÿtÜ


	)

53 
_£t_®loÿtÜ
();

54 * 
_»®loc
(* 
±r
, 
size_t
 
n
);

56 #iâdeà
NDEBUG


57 
_»Ï‹
(
hblock_t
 * 
b
, hblock_ˆ* 
p
);

60 
_ä“_chd»n
(
hblock_t
 * 
p
);

65 * 
	$h®loc
(* 
±r
, 
size_t
 
Ën
)

67 
hblock_t
 * 
p
;

70 ià(! 
®loÿtÜ
)

72 
	`_£t_®loÿtÜ
();

73 
	`as£¹
(
®loÿtÜ
);

77 ià(! 
±r
)

79 ià(! 
Ën
)

80  
NULL
;

82 
p
 = 
	`®loÿtÜ
(0, 
Ën
 + 
sizeof_hblock
);

83 ià(! 
p
)

84  
NULL
;

85 #iâdeà
NDEBUG


86 
p
->
magic
 = 
HH_MAGIC
;

88 
	`hli¡_š™
(&
p
->
chd»n
);

89 
	`hli¡_š™_™em
(&
p
->
siblšgs
);

91  
p
->
d©a
;

94 
p
 = 
	`¡ruùof
(
±r
, 
hblock_t
, 
d©a
);

95 
	`as£¹
(
p
->
magic
 =ğ
HH_MAGIC
);

98 ià(
Ën
)

100 
p
 = 
	`®loÿtÜ
Õ, 
Ën
 + 
sizeof_hblock
);

101 ià(! 
p
)

102  
NULL
;

104 
	`hli¡_»lšk
(&
p
->
siblšgs
);

105 
	`hli¡_»lšk_h—d
(&
p
->
chd»n
);

107  
p
->
d©a
;

111 
	`_ä“_chd»n
(
p
);

112 
	`hli¡_d–
(&
p
->
siblšgs
);

113 
	`®loÿtÜ
(
p
, 0);

115  
NULL
;

116 
	}
}

118 
	$h©ch
(* 
block
, * 
·»Á
)

120 
hblock_t
 * 
b
, * 
p
;

122 ià(! 
block
)

124 
	`as£¹
(! 
·»Á
);

129 
b
 = 
	`¡ruùof
(
block
, 
hblock_t
, 
d©a
);

130 
	`as£¹
(
b
->
magic
 =ğ
HH_MAGIC
);

132 
	`hli¡_d–
(&
b
->
siblšgs
);

134 ià(! 
·»Á
)

138 
p
 = 
	`¡ruùof
(
·»Á
, 
hblock_t
, 
d©a
);

139 
	`as£¹
(
p
->
magic
 =ğ
HH_MAGIC
);

142 
	`as£¹
(
b
 !ğ
p
);

143 
	`as£¹
(! 
	`_»Ï‹
(
p
, 
b
));

145 
	`hli¡_add
(&
p
->
chd»n
, &
b
->
siblšgs
);

146 
	}
}

151 * 
	$h_m®loc
(
size_t
 
Ën
)

153  
	`h®loc
(0, 
Ën
);

154 
	}
}

156 * 
	$h_ÿÎoc
(
size_t
 
n
, size_ˆ
Ën
)

158 * 
±r
 = 
	`h®loc
(0, 
Ën
*=
n
);

159  
±r
 ? 
	`mem£t
ÕŒ, 0, 
Ën
è: 
NULL
;

160 
	}
}

162 * 
	$h_»®loc
(* 
±r
, 
size_t
 
Ën
)

164  
	`h®loc
(
±r
, 
Ën
);

165 
	}
}

167 
	$h_ä“
(* 
±r
)

169 
	`h®loc
(
±r
, 0);

170 
	}
}

172 * 
	$h_¡rdup
(cÚ¡ * 
¡r
)

174 
size_t
 
Ën
 = 
	`¡¾’
(
¡r
);

175 * 
±r
 = 
	`h®loc
(0, 
Ën
 + 1);

176  
±r
 ? (±r[
Ën
] = 0, 
	`memıy
ÕŒ, 
¡r
,†’)è: 
NULL
;

177 
	}
}

182 
	$_£t_®loÿtÜ
()

184 * 
p
;

185 
	`as£¹
(! 
®loÿtÜ
);

197 
®loÿtÜ
 = 
»®loc
;

198 ià(! (
p
 = 
	`m®loc
(1)))

202 ià((
p
 = 
	`»®loc
(p, 0)))

205 
®loÿtÜ
 = 
_»®loc
;

206 
	`ä“
(
p
);

208 
	}
}

210 * 
	$_»®loc
(* 
±r
, 
size_t
 
n
)

215 ià(
n
)

216  
	`»®loc
(
±r
, 
n
);

217 
	`ä“
(
±r
);

218  
NULL
;

219 
	}
}

221 #iâdeà
NDEBUG


222 
	$_»Ï‹
(
hblock_t
 * 
b
, hblock_ˆ* 
p
)

224 
hli¡_™em_t
 * 
i
;

226 ià(!
b
 || !
p
)

234 
	`hli¡_fÜ_—ch
(
i
, &
p
->
chd»n
)

236 
hblock_t
 * 
q
 = 
	`¡ruùof
(
i
, hblock_t, 
siblšgs
);

237 ià(
q
 =ğ
b
 || 
	`_»Ï‹
(b, q))

241 
	}
}

244 
	$_ä“_chd»n
(
hblock_t
 * 
p
)

246 
hli¡_™em_t
 * 
i
, * 
tmp
;

248 #iâdeà
NDEBUG


253 
	`as£¹
(
p
 &&…->
magic
 =ğ
HH_MAGIC
);

254 
p
->
magic
 = 0;

256 
	`hli¡_fÜ_—ch_§ã
(
i
, 
tmp
, &
p
->
chd»n
)

258 
hblock_t
 * 
q
 = 
	`¡ruùof
(
i
, hblock_t, 
siblšgs
);

259 
	`_ä“_chd»n
(
q
);

260 
	`®loÿtÜ
(
q
, 0);

262 
	}
}

	@tools/src/mem/halloc.h

15 #iâdeà
_LIBP_HALLOC_H_


16 
	#_LIBP_HALLOC_H_


	)

18 
	~<¡ddef.h
>

23 * 
h®loc
 (* 
block
, 
size_t
 
Ën
);

24 
h©ch
(* 
block
, * 
·»Á
);

29 * 
h_m®loc
 (
size_t
 
Ën
);

30 * 
h_ÿÎoc
 (
size_t
 
n
, size_ˆ
Ën
);

31 * 
h_»®loc
(* 
p
, 
size_t
 
Ën
);

32 
h_ä“
 (* 
p
);

33 * 
h_¡rdup
 (cÚ¡ * 
¡r
);

38 * (* 
	t»®loc_t
)(* 
	t±r
, 
	tsize_t
 
	tËn
);

40 
»®loc_t
 
h®loc_®loÿtÜ
;

	@tools/src/mem/hlist.h

15 #iâdeà
_LIBP_HLIST_H_


16 
	#_LIBP_HLIST_H_


	)

18 
	~<as£¹.h
>

19 
	~"maüos.h
"

24 
hli¡_h—d
 
	thli¡_h—d_t
;

25 
hli¡_™em
 
	thli¡_™em_t
;

30 
	shli¡_h—d


32 
hli¡_™em_t
 * 
	mÃxt
;

35 
	shli¡_™em


37 
hli¡_™em_t
 * 
	mÃxt
;

38 
hli¡_™em_t
 ** 
	m´ev
;

44 
hli¡_™em
 
	ghli¡_nuÎ
;

49 
	#__hli¡_š™
(
h
è{ &
hli¡_nuÎ
 }

	)

50 
	#__hli¡_š™_™em
(
i
è{ &
hli¡_nuÎ
, &(i).
Ãxt
 }

	)

52 
¡©ic_šlše
 
hli¡_š™
(
hli¡_h—d_t
 * 
h
);

53 
¡©ic_šlše
 
hli¡_š™_™em
(
hli¡_™em_t
 * 
i
);

65 
¡©ic_šlše
 
hli¡_add
(
hli¡_h—d_t
 * 
h
, 
hli¡_™em_t
 * 
i
);

70 
¡©ic_šlše
 
hli¡_d–
(
hli¡_™em_t
 * 
i
);

72 
¡©ic_šlše
 
hli¡_»lšk
(
hli¡_™em_t
 * 
i
);

73 
¡©ic_šlše
 
hli¡_»lšk_h—d
(
hli¡_h—d_t
 * 
h
);

75 
	#hli¡_fÜ_—ch
(
i
, 
h
) \

76 
i
 = (
h
)->
Ãxt
; i !ğ&
hli¡_nuÎ
; i = i->Ãxt)

	)

78 
	#hli¡_fÜ_—ch_§ã
(
i
, 
tmp
, 
h
) \

79 
i
 = (
h
)->
Ãxt
, 
tmp
 = i->next; \

80 
i
!ğ&
hli¡_nuÎ
; \

81 
i
 = 
tmp
,m°ği->
Ãxt
)

	)

86 
¡©ic_šlše
 
	$hli¡_š™
(
hli¡_h—d_t
 * 
h
)

88 
	`as£¹
(
h
);

89 
h
->
Ãxt
 = &
hli¡_nuÎ
;

90 
	}
}

92 
¡©ic_šlše
 
	$hli¡_š™_™em
(
hli¡_™em_t
 * 
i
)

94 
	`as£¹
(
i
);

95 
i
->
´ev
 = &i->
Ãxt
;

96 
i
->
Ãxt
 = &
hli¡_nuÎ
;

97 
	}
}

99 
¡©ic_šlše
 
	$hli¡_add
(
hli¡_h—d_t
 * 
h
, 
hli¡_™em_t
 * 
i
)

101 
hli¡_™em_t
 * 
Ãxt
;

102 
	`as£¹
(
h
 && 
i
);

104 
Ãxt
 = 
i
->Ãxˆğ
h
->next;

105 
Ãxt
->
´ev
 = &
i
->next;

106 
h
->
Ãxt
 = 
i
;

107 
i
->
´ev
 = &
h
->
Ãxt
;

108 
	}
}

110 
¡©ic_šlše
 
	$hli¡_d–
(
hli¡_™em_t
 * 
i
)

112 
hli¡_™em_t
 * 
Ãxt
;

113 
	`as£¹
(
i
);

115 
Ãxt
 = 
i
->next;

116 
Ãxt
->
´ev
 = 
i
->prev;

117 *
i
->
´ev
 = 
Ãxt
;

119 
	`hli¡_š™_™em
(
i
);

120 
	}
}

122 
¡©ic_šlše
 
	$hli¡_»lšk
(
hli¡_™em_t
 * 
i
)

124 
	`as£¹
(
i
);

125 *
i
->
´ev
 = i;

126 
i
->
Ãxt
->
´ev
 = &i->next;

127 
	}
}

129 
¡©ic_šlše
 
	$hli¡_»lšk_h—d
(
hli¡_h—d_t
 * 
h
)

131 
	`as£¹
(
h
);

132 
h
->
Ãxt
->
´ev
 = &h->next;

133 
	}
}

	@tools/src/mem/macros.h

15 #iâdeà
_LIBP_MACROS_H_


16 
	#_LIBP_MACROS_H_


	)

18 
	~<¡ddef.h
>

23 
	#¡ruùof
(
p
,
t
,
f
è(Ñ*)(- 
	`off£tof
Ñ,fè+ (*)Õ)))

	)

28 
	#¡©ic_šlše
 
__šlše__


	)

	@tools/src/mime.c

35 
	~<mime.h
>

36 
	~<adt/t¡.h
>

37 
	~<dbg.h
>

38 
	~"£‰šg.h
"

41 
t¡_t
 *
	gMIME_MAP
 = 
NULL
;

43 
	gMAX_EXT_LEN
 = 0;

45 
	$MIME_add_ty³
(cÚ¡ *
ext
, cÚ¡ *
ty³
)

47 if(!
MAX_EXT_LEN
) {

48 
MAX_EXT_LEN
 = 
	`S‘tšg_g‘_št
("limits.mime_ext_len", 128);

49 
	`log_šfo
("MAX†im™s.mime_ext_Ën=%d", 
MAX_EXT_LEN
);

52 
b¡ršg
 
ext_»v
 = 
	`bäomc¡r
(
ext
);

53 
	`bRev”£
(
ext_»v
);

54 
b¡ršg
 
ty³_¡r
 = 
	`bäomc¡r
(
ty³
);

56 
	`check
(
	`bËngth
(
ext_»v
è> 0, "NØz”ØËngth MIMEƒx‹nsiÚ ®lowed: %s:%s", 
ext
, 
ty³
);

57 
	`check
(
	`bËngth
(
ty³_¡r
è> 0, "NØz”ØËngth MIMEy³ ®lowed: %s:%s", 
ext
, 
ty³
);

58 
	`check
(
ext
[0] =ğ'.', "Ex‹nsiÚ mu¡ s¹ w™h‡ . '%s:%s'",ƒxt, 
ty³
);

60 
	`check
(
	`bËngth
(
ext_»v
è< 
MAX_EXT_LEN
, "MIMEƒx‹nsiÚ %s:% i lÚg”hª %d MAX (™' %d)", 
ext
, 
ty³
, MAX_EXT_LEN, blength(ext_rev));

62 
	`check
(!
	`t¡_£¬ch
(
MIME_MAP
, 
	`bd©a
(
ext_»v
), 
	`bËngth
(ext_rev)),

64 
ext
,ƒxt, 
ty³
);

66 
MIME_MAP
 = 
	`t¡_š£¹
(MIME_MAP, 
	`bd©a
(
ext_»v
), 
	`bËngth
Óxt_»v), 
ty³_¡r
);

68 
	`bde¡roy
(
ext_»v
);

71 
”rÜ
:

72 
	`bde¡roy
(
ext_»v
);

73 
	`bde¡roy
(
ty³_¡r
);

75 
	}
}

78 
b¡ršg
 
	$MIME_m©ch_ext
(
b¡ršg
 
·th
, b¡ršg 
def
)

80 
b¡ršg
 
ty³
 = 
	`t¡_£¬ch_suffix
(
MIME_MAP
, 
	`bd©a
(
·th
), 
	`bËngth
(path));

82  
ty³
 =ğ
NULL
 ? 
def
 :ype;

83 
	}
}

85 
	$MIME_Œav”£_de¡roy
(*
v®ue
, *
d©a
)

87 
	`bde¡roy
((
b¡ršg
)
v®ue
);

88 
	}
}

90 
	$MIME_de¡roy
()

92 if(
MIME_MAP
) {

93 
	`t¡_Œav”£
(
MIME_MAP
, 
MIME_Œav”£_de¡roy
, 
NULL
);

94 
	`t¡_de¡roy
(
MIME_MAP
);

95 
MIME_MAP
 = 
NULL
;

97 
	}
}

	@tools/src/mime.h

35 #iâdeà
_mime_h


36 
	#_mime_h


	)

38 
	~<¡dlib.h
>

39 
	~<b¡ršg.h
>

41 
MIME_add_ty³
(cÚ¡ *
ext
, cÚ¡ *
ty³
);

43 
b¡ršg
 
MIME_m©ch_ext
(b¡ršg 
·th
, b¡ršg 
def
);

45 
MIME_de¡roy
();

	@tools/src/mongrel2.c

35 
	~<fú.h
>

36 
	~<¡ršg.h
>

37 
	~<sigÇl.h
>

38 
	~<time.h
>

39 
	~<as£¹.h
>

41 
	~"£rv”.h
"

42 
	~"dbg.h
"

43 
	~"dœ.h
"

44 
	~"sk/sk.h
"

45 
	~"cÚfig/cÚfig.h
"

46 
	~"cÚfig/db.h
"

47 
	~"adt/li¡.h
"

48 
	~"unixy.h
"

49 
	~"mime.h
"

50 
	~"su³½Şl.h
"

51 
	~"£‰šg.h
"

52 
	~"v”siÚ.h
"

53 
	~"cÚŒŞ.h
"

54 
	~"log.h
"

55 
	~"»gi¡”.h
"

57 
RUNNING
;

58 
ušt32_t
 
THE_CURRENT_TIME_IS
;

59 
	gRELOAD
;

60 
	gMURDER
;

62 
gb¡ršg
 
	gPRIV_DIR
 = 
bsStic
("/");

64 
S”v”
 *
	gSERVER
 = 
NULL
;

67 
	$‹rmš©e
(
s
)

69 
MURDER
 = 
s
 =ğ
SIGTERM
;

70 
s
)

72 
SIGHUP
:

73 
RELOAD
 = 1;

74 
RUNNING
 = 0;

75 
	`log_šfo
("RELOAD REQUESTED, I'll do it onhe‚ext„equest.");

78 if(!
RUNNING
) {

79 
	`log_šfo
("SIGINT CAUGHT AGAIN, ASSUMING MURDER.");

80 
MURDER
 = 1;

82 
RUNNING
 = 0;

83 
	`log_šfo
("SHUTDOWN REQUESTED: %s", 
MURDER
 ? "MURDER" : "GRACEFUL (SIGINT‡gaino EXIT NOW)");

84 
	`fdşo£
(
SERVER
->
li¡’_fd
);

88 
	}
}

90 
	$¡¬t_‹rmš©Ü
()

92 
sigaùiÚ
 
§
, 
o§
;

93 
	`mem£t
(&
§
, 0,  sa);

94 
§
.
§_hªdËr
 = 
‹rmš©e
;

95 
§
.
§_æags
 = 
SA_RESTART
;

96 
	`sigaùiÚ
(
SIGINT
, &
§
, &
o§
);

97 
	`sigaùiÚ
(
SIGTERM
, &
§
, &
o§
);

98 
	`sigaùiÚ
(
SIGHUP
, &
§
, &
o§
);

101 
sig£t_t
 
x
;

102 
	`sigem±y£t
(&
x
);

103 
	`sigadd£t
(&
x
, 
SIGPIPE
);

104 
	`sig´ocmask
(
SIG_BLOCK
, &
x
, 
NULL
);

106 
	`sigem±y£t
(&
x
);

107 
	`sigadd£t
(&
x
, 
SIGPIPE
);

108 
	`±h»ad_sigmask
(
SIG_BLOCK
, &
x
, 
NULL
);

110 
§
.
§_hªdËr
 = 
SIG_IGN
;

111 
	`sigaùiÚ
(
SIGPIPE
, &
§
, &
o§
);

112 
	}
}

115 
S”v”
 *
	$lßd_£rv”
(cÚ¡ *
db_fe
, cÚ¡ *
£rv”_uuid
, 
S”v”
 *
Şd_¤v
)

117 
rc
 = 0;

118 
S”v”
 *
¤v
 = 
NULL
;

120 
rc
 = 
	`CÚfig_š™_db
(
db_fe
);

121 
	`check
(
rc
 =ğ0, "FaedØlßd cÚfig d©aba£‡ˆ%s", 
db_fe
);

123 
rc
 = 
	`CÚfig_lßd_£‰šgs
();

124 
	`check
(
rc
 != -1, "Failedo†oad global settings.");

126 
rc
 = 
	`CÚfig_lßd_mim‘y³s
();

127 
	`check
(
rc
 != -1, "Failedo†oad mimeypes.");

129 
¤v
 = 
	`CÚfig_lßd_£rv”
(
£rv”_uuid
);

130 
	`check
(
¤v
, "FaedØlßd s”v” % äom %s", 
£rv”_uuid
, 
db_fe
);

131 
	`check
(
¤v
->
deçuÉ_ho¡
, "NØdeçuÉ_ho¡ s‘ fÜ s”v”: %s, you‚“d oÃ ho¡‚amed: %s", 
£rv”_uuid
, 
	`bd©a
(¤v->
deçuÉ_ho¡Çme
));

133 if(
Şd_¤v
 =ğ
NULL
 || old_¤v->
li¡’_fd
 == -1) {

134 
¤v
->
li¡’_fd
 = 
	`ÃÂounû
(
TCP
, 
	`bd©a
(¤v->
bšd_addr
), srv->
pÜt
);

135 
	`check
(
¤v
->
li¡’_fd
 >ğ0, "Cª'ˆªnounû oÀTCP…Üˆ%d", srv->
pÜt
);

136 
	`check
(
	`fdnoblock
(
¤v
->
li¡’_fd
è=ğ0, "FaedØ£ˆli¡’šg…Üˆ%d‚Úblockšg.", srv->
pÜt
);

138 
¤v
->
li¡’_fd
 = 
	`dup
(
Şd_¤v
->listen_fd);

139 
	`check
(
¤v
->
li¡’_fd
 != -1, "Failedo duphe socket fromhe„unning server.");

140 
	`fdşo£
(
Şd_¤v
->
li¡’_fd
);

143 
	`check
(
	`S”v”_¡¬t_hªdËrs
(
¤v
, 
Şd_¤v
) == 0, "Failedo start handlers.");

145 
	`CÚfig_şo£_db
();

146  
¤v
;

147 
”rÜ
:

149 
	`S”v”_de¡roy
(
¤v
);

150 
	`CÚfig_şo£_db
();

151  
NULL
;

152 
	}
}

155 
	$ş—r_pid_fe
(
S”v”
 *
¤v
)

157 
b¡ršg
 
pid_fe
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
¤v
->
chroÙ
), bdata(srv->pid_file));

159 
rc
 = 
	`Unixy_»move_d—d_pidfe
(
pid_fe
);

160 
	`check
(
rc
 =ğ0, "FaedØ»movthd—d PID fe: %s", 
	`bd©a
(
pid_fe
));

161 
	`bde¡roy
(
pid_fe
);

164 
”rÜ
:

166 
	}
}

168 
	$tick”sk
(*
v
)

170 
	`skÇme
("ticker");

172 !
	`sk_was_sigÇËd
()) {

173 
THE_CURRENT_TIME_IS
 = 
	`time
(
NULL
);

175 
mš_wa™
 = 
	`S‘tšg_g‘_št
("limits.tick_timer", 10);

176 
	`skd–ay
(
mš_wa™
 * 1000);

179 
mš_pšg
 = 
	`S‘tšg_g‘_št
("lim™s.mš_pšg", 
DEFAULT_MIN_PING
);

180 
mš_wr™e_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_wr™e_¿‹", 
DEFAULT_MIN_READ_RATE
);

181 
mš_»ad_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_»ad_¿‹", 
DEFAULT_MIN_WRITE_RATE
);

183 if(
mš_pšg
 > 0 || 
mš_wr™e_¿‹
 > 0 || 
mš_»ad_¿‹
 > 0) {

184 
ş—»d
 = 
	`Regi¡”_ş—nout
();

186 if(
ş—»d
 > 0) {

187 
	`log_w¬n
("Timeouˆsk kËd %dasks, wa™šg %d secÚd fÜ mÜe.", 
ş—»d
, 
mš_wa™
);

189 
	`debug
("No connectionsimed out.");

193 
	}
}

195 
	$©‹m±_chroÙ_drİ
(
S”v”
 *
¤v
)

197 
rc
 = 0;

199 if(
	`Unixy_chroÙ
(
¤v
->
chroÙ
) == 0) {

200 
	`log_šfo
("All†oaded up,imeourn into‡ server.");

202 
	`check
(
	`acûss
("/run", 
F_OK
è=ğ0, "/ruÀdœeùÜy dÛ¢'ˆexi¡ iÀ% Ü i¢'ˆowÃd„ight.", 
	`bd©a
(
¤v
->
chroÙ
));

203 
	`check
(
	`acûss
("/tmp", 
F_OK
è=ğ0, "/tm°dœeùÜy dÛ¢'ˆexi¡ iÀ% Ü i¢'ˆowÃd„ight.", 
	`bd©a
(
¤v
->
chroÙ
));

205 
rc
 = 
	`Unixy_d«mÚize
();

206 
	`check
(
rc
 == 0, "Failedo daemonize,†ooks†ike you're hosed.");

208 
FILE
 *
log
 = 
	`fİ’
(
	`bd©a
(
¤v
->
”rÜ_log
), "a+");

209 
	`check
(
log
, "Couldn'ˆİ’ % log fe.", 
	`bd©a
(
¤v
->
”rÜ_log
));

210 
	`£tbuf
(
log
, 
NULL
);

212 
	`dbg_£t_log
(
log
);

214 
rc
 = 
	`Unixy_pid_fe
(
¤v
->
pid_fe
);

215 
	`check
(
rc
 =ğ0, "FaedØmakthPID f%s", 
	`bd©a
(
¤v
->
pid_fe
));

217 
rc
 = 
	`Unixy_drİ_´iv
(&
PRIV_DIR
);

218 
	`check
(
rc
 =ğ0, "FaedØdrİ…rivØthowÃ¸oà%s", 
	`bd©a
(&
PRIV_DIR
));

221 
	`log_w¬n
("Couldn'ˆchroÙoØ%s,‡ssumšg„uÂšg iÀ‹¡ mode.", 
	`bd©a
(
¤v
->
chroÙ
));

224 
b¡ršg
 
‹mp
 = 
	`bfÜm©
("%s%s", 
	`bd©a
(
¤v
->
chroÙ
), bd©a(¤v->
acûss_log
));

225 
	`bassign
(
¤v
->
acûss_log
, 
‹mp
);

226 
	`bde¡roy
(
‹mp
);

228 
‹mp
 = 
	`bfÜm©
(".%s", 
	`bd©a
(
¤v
->
pid_fe
));

229 
	`bassign
(
¤v
->
pid_fe
, 
‹mp
);

230 
	`bde¡roy
(
‹mp
);

232 
rc
 = 
	`Unixy_pid_fe
(
¤v
->
pid_fe
);

233 
	`check
(
rc
 =ğ0, "FaedØmakthPID f%s", 
	`bd©a
(
¤v
->
pid_fe
));

238 
”rÜ
:

240 
	}
}

242 
	$fš®_£tup
()

244 
	`¡¬t_‹rmš©Ü
();

245 
	`S”v”_š™
();

246 
b¡ršg
 
’d_pošt
 = 
	`bäomc¡r
("inproc://access_log");

247 
	`Log_š™
(
	`b¡rıy
(
SERVER
->
acûss_log
), 
’d_pošt
);

248 
	}
}

252 
S”v”
 *
	$»lßd_£rv”
(
S”v”
 *
Şd_¤v
, cÚ¡ *
db_fe
, cÚ¡ *
£rv”_uuid
)

254 
RUNNING
 = 1;

256 
	`log_šfo
("------------------------ RELOAD % -----------------------------------", 
£rv”_uuid
);

257 
	`MIME_de¡roy
();

258 
	`S‘tšg_de¡roy
();

260 
S”v”
 *
¤v
 = 
	`lßd_£rv”
(
db_fe
, 
£rv”_uuid
, 
Şd_¤v
);

261 
	`check
(
¤v
 !ğ
NULL
, "Failedo†oad‚ew server config.");

263 
	`S”v”_¡İ_hªdËrs
(
Şd_¤v
);

265 
RELOAD
 = 0;

266  
¤v
;

268 
”rÜ
:

269  
NULL
;

270 
	}
}

273 
	$com¶‘e_shutdown
(
S”v”
 *
¤v
)

275 
	`fdşo£
(
¤v
->
li¡’_fd
);

276 
©‹m±s
 = 0;

277 
rc
 = 0;

279 
rc
 = 
	`sk®lsigÇl
(
SIGTERM
);

280 
	`check
(
rc
 != -1, "Failedo sendhe TERM signalo‡ll internalasks.");

282 
	`log_šfo
("Shutting down‡ll„unningasks‡s gracefully‡s…ossible.");

285 
©‹m±s
 = 0; 
	`sk¤uÂšg
() > 1 &&‡ttempts < 20;‡ttempts++) {

286 
rc
 = 
	`sk®lsigÇl
(
SIGTERM
);

287 
	`check
(
rc
 !ğ-1, "FaedØ£ndhTERM sigÇÈtØš‹º®ask Ú‡‰em±: %d.", 
©‹m±s
);

290 
	`log_šfo
("Task now„uÂšg (šşudšg mašask): %d", 
	`sk¤uÂšg
());

292 
	`CÚŒŞ_pÜt_¡İ
();

293 
rc
 = 
	`Log_‹rm
();

294 
	`check
(
rc
 != -1, "Failedo shutdownhe†ogging subsystem.");

296 
	`S‘tšg_de¡roy
();

297 
	`MIME_de¡roy
();

299 
	`log_šfo
("Removšg…id f%s", 
	`bd©a
(
¤v
->
pid_fe
));

300 
rc
 = 
	`uÆšk
((cÚ¡ *)
¤v
->
pid_fe
->
d©a
);

301 
	`check
(
rc
 !ğ-1, "FaedØuÆšk…id_fe: %s", 
	`bd©a
(
¤v
->
pid_fe
));

303 
	`S”v”_de¡roy
(
¤v
);

305 
	`skex™®l
(0);

306 
”rÜ
:

307 
	`skex™®l
(1);

308 
	}
}

310 cÚ¡ 
	gTICKER_TASK_STACK
 = 16 * 1024;

312 
	$skmaš
(
¬gc
, **
¬gv
)

314 
	`dbg_£t_log
(
¡d”r
);

315 
rc
 = 0;

317 
	`check
(
¬gc
 == 3 ||‡rgc == 4, "usage: mongrel2 config.sqlite server_uuid [config_module.so]");

319 if(
¬gc
 == 4) {

320 
	`log_šfo
("Using configuration module %so†oad configs.",

321 
¬gv
[3]);

322 
rc
 = 
	`CÚfig_moduË_lßd
(
¬gv
[3]);

323 
	`check
(
rc
 !ğ-1, "FaedØlßdhcÚfig moduË: %s", 
¬gv
[3]);

326 
SERVER
 = 
	`lßd_£rv”
(
¬gv
[1],‡rgv[2], 
NULL
);

327 
	`check
(
SERVER
, "Aborting since can't†oad server.");

329 
	`Su³rPŞl_g‘_max_fd
();

331 
rc
 = 
	`ş—r_pid_fe
(
SERVER
);

332 
	`check
(
rc
 == 0, "PID file failure,‡borting„atherhanryingo start.");

334 
rc
 = 
	`©‹m±_chroÙ_drİ
(
SERVER
);

335 
	`check
(
rc
 == 0, "Major failure in chroot/droppriv,‡borting.");

337 
	`fš®_£tup
();

339 
	`CÚŒŞ_pÜt_¡¬t
();

340 
	`skü—‹
(
tick”sk
, 
NULL
, 
TICKER_TASK_STACK
);

343 
	`log_šfo
("S¹šg " 
VERSION
 ". Copyright (C) Zed A. Shaw. Licensed BSD.");

344 
	`S”v”_¡¬t
(
SERVER
);

346 if(
RELOAD
) {

347 
	`log_šfo
("R–ßd„eque¡ed, wÈlßd % äom %s", 
¬gv
[2],‡rgv[1]);

348 
S”v”
 *
Ãw_¤v
 = 
	`»lßd_£rv”
(
SERVER
, 
¬gv
[1],‡rgv[2]);

349 
	`check
(
Ãw_¤v
, "Failedo†oadhe‚ew configuration,ƒxiting.");

352 
SERVER
 = 
Ãw_¤v
;

354 
	`log_šfo
("Shutdown„equested, goodbye.");

359 
	`com¶‘e_shutdown
(
SERVER
);

362 
”rÜ
:

363 
	`log_”r
("Exiting dueoƒrror.");

364 
	`skex™®l
(1);

365 
	}
}

	@tools/src/pattern.c

5 
	~<dbg.h
>

6 
	~<¡dlib.h
>

7 
	~<·‰”n.h
>

8 
	~<¡ršg.h
>

9 
	~<as£¹.h
>

10 
	~<ùy³.h
>

14 
	sM©chS‹
 {

15 cÚ¡ *
	m¤c_š™
;

16 cÚ¡ *
	m¤c_’d
;

17 } 
	tM©chS‹
;

20 
	#CAP_UNFINISHED
 (-1)

	)

21 
	#CAP_POSITION
 (-2)

	)

23 
	#uch¬
(
S
è(S)

	)

26 
	#L_ESC
 '\\'

	)

29 cÚ¡ *
	$şas£nd
 (
M©chS‹
 *
ms
, cÚ¡ *
p
) {

30 *
p
++) {

31 
L_ESC
: {

32 ià(*
p
 == '\0')

33 
	`log_”r
("malformed…attern (ends with '\\0')");

34  
p
+1;

37 ià(*
p
 == '^')…++;

39 ià(*
p
 == '\0')

40 
	`log_”r
("malformed…attern (missing ])");

41 ià(*(
p
++è=ğ
L_ESC
 && *p != '\0')

42 
p
++;

43 } *
p
 != ']');

44  
p
+1;

47  
p
;

50 
	}
}

53 
	$m©ch_şass
 (
c
, 
ş
) {

54 
»s
;

55 
	`tŞow”
(
ş
)) {

56 'a' : 
»s
 = 
	`i§Íha
(
c
); ;

57 'c' : 
»s
 = 
	`isúŒl
(
c
); ;

58 'd' : 
»s
 = 
	`isdig™
(
c
); ;

59 'l' : 
»s
 = 
	`i¦ow”
(
c
); ;

60 'p' : 
»s
 = 
	`i¥unù
(
c
); ;

61 's' : 
»s
 = 
	`is¥aû
(
c
); ;

62 'u' : 
»s
 = 
	`isuµ”
(
c
); ;

63 'w' : 
»s
 = 
	`i§Êum
(
c
); ;

64 'x' : 
»s
 = 
	`isxdig™
(
c
); ;

65 'z' : 
»s
 = (
c
 == 0); ;

66 :  (
ş
 =ğ
c
);

68  (
	`i¦ow”
(
ş
è? 
»s
 : !res);

69 
	}
}

72 
	$m©chb¿ck‘şass
 (
c
, cÚ¡ *
p
, cÚ¡ *
ec
) {

73 
sig
 = 1;

74 ià(*(
p
+1) == '^') {

75 
sig
 = 0;

76 
p
++;

78 ++
p
 < 
ec
) {

79 ià(*
p
 =ğ
L_ESC
) {

80 
p
++;

81 ià(
	`m©ch_şass
(
c
, 
	`uch¬
(*
p
)))

82  
sig
;

84 ià((*(
p
+1è=ğ'-'è&& (p+2 < 
ec
)) {

85 
p
+=2;

86 ià(
	`uch¬
(*(
p
-2)è<ğ
c
 && c <= uchar(*p))

87  
sig
;

89 ià(
	`uch¬
(*
p
è=ğ
c
è 
sig
;

91  !
sig
;

92 
	}
}

95 
	$sšgËm©ch
 (
c
, cÚ¡ *
p
, cÚ¡ *
•
) {

96 *
p
) {

98 
L_ESC
:  
	`m©ch_şass
(
c
, 
	`uch¬
(*(
p
+1)));

99 '[':  
	`m©chb¿ck‘şass
(
c
, 
p
, 
•
-1);

100 :  (
	`uch¬
(*
p
è=ğ
c
);

102 
	}
}

105 cÚ¡ *
m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
);

108 cÚ¡ *
	$m©chb®ªû
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

109 cÚ¡ *
p
) {

110 ià(*
p
 == 0 || *(p+1) == 0)

111 
	`log_”r
("unbalanced…attern");

112 ià(*
s
 !ğ*
p
è 
NULL
;

114 
b
 = *
p
;

115 
e
 = *(
p
+1);

116 
cÚt
 = 1;

117 ++
s
 < 
ms
->
¤c_’d
) {

118 ià(*
s
 =ğ
e
) {

119 ià(--
cÚt
 =ğ0è 
s
+1;

121 ià(*
s
 =ğ
b
è
cÚt
++;

124  
NULL
;

125 
	}
}

128 cÚ¡ *
	$max_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

129 cÚ¡ *
p
, cÚ¡ *
•
) {

130 
i
 = 0;

131 (
s
+
i
è< 
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*(s+i)), 
p
, 
•
))

132 
i
++;

134 
i
>=0) {

135 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, (
s
+
i
), 
•
+1);

136 ià(
»s
) „es;

137 
i
--;

139  
NULL
;

140 
	}
}

143 cÚ¡ *
	$mš_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

144 cÚ¡ *
p
, cÚ¡ *
•
) {

146 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, 
s
, 
•
+1);

147 ià(
»s
 !ğ
NULL
)

148  
»s
;

149 ià(
s
<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*s), 
p
, 
•
))

150 
s
++;

151  
NULL
;

153 
	}
}

156 cÚ¡ *
	$·‰”n_m©ch
(cÚ¡ *
s
, 
size_t
 
Ën
, cÚ¡ *
p
)

158 
M©chS‹
 
ms
 = {.
¤c_š™
 = 
s
, .
¤c_’d
 = s + 
Ën
};

159  
	`m©ch
(&
ms
, 
s
, 
p
);

160 
	}
}

163 cÚ¡ *
	$b¡ršg_m©ch
(
b¡ršg
 
s
, b¡ršg 
·‰”n
)

165 
M©chS‹
 
ms
 = {.
¤c_š™
 = 
	`bd©a
(
s
), .
¤c_’d
 = bd©a(sè+ 
	`bËngth
(s)};

166  
	`m©ch
(&
ms
, 
	`bd©a
(
s
), bd©a(
·‰”n
));

167 
	}
}

169 cÚ¡ *
	$m©ch
(
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
) {

171 
š™
:

172 *
p
) {

174 
p
++;

175 
š™
;

177 
p
++;

178 
š™
;

179 
L_ESC
: {

180 *(
p
+1)) {

182 
s
 = 
	`m©chb®ªû
(
ms
, s, 
p
+2);

183 ià(
s
 =ğ
NULL
)  NULL;

184 
p
+=4; 
š™
;

187 cÚ¡ *
•
; 
´evious
;

188 
p
 += 2;

189 ià(*
p
 != '[')

190 
	`log_”r
("missing '['‡fter \\\\f in…attern");

191 
•
 = 
	`şas£nd
(
ms
, 
p
);

192 
´evious
 = (
s
 =ğ
ms
->
¤c_š™
) ? '\0' : *(s-1);

193 ià(
	`m©chb¿ck‘şass
(
	`uch¬
(
´evious
), 
p
, 
•
-1) ||

194 !
	`m©chb¿ck‘şass
(
	`uch¬
(*
s
), 
p
, 
•
-1)è 
NULL
;

195 
p
=
•
; 
š™
;

198 
dæt
;

203  
s
;

206 ià(*(
p
+1) == '\0')

207  (
s
 =ğ
ms
->
¤c_’d
è? s : 
NULL
;

208 
dæt
;

210 : 
dæt
: {

211 cÚ¡ *
•
 = 
	`şas£nd
(
ms
, 
p
);

212 
m
 = 
s
<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*s), 
p
, 
•
);

213 *
•
) {

215 cÚ¡ *
»s
;

216 ià(
m
 && ((
»s
=
	`m©ch
(
ms
, 
s
+1, 
•
+1)è!ğ
NULL
))

217  
»s
;

218 
p
=
•
+1; 
š™
;

221  
	`max_ex·nd
(
ms
, 
s
, 
p
, 
•
);

224  (
m
 ? 
	`max_ex·nd
(
ms
, 
s
+1, 
p
, 
•
è: 
NULL
);

227  
	`mš_ex·nd
(
ms
, 
s
, 
p
, 
•
);

230 ià(!
m
è 
NULL
;

231 
s
++; 
p
=
•
; 
š™
;

236 
	}
}

	@tools/src/pattern.h

35 #iâdeà
_·‰”n_h


36 
	#_·‰”n_h


	)

38 
	~<b¡ršg.h
>

40 cÚ¡ *
·‰”n_m©ch
(cÚ¡ *
s
, 
size_t
 
Ën
, cÚ¡ *
p
);

42 cÚ¡ *
b¡ršg_m©ch
(
b¡ršg
 
s
, b¡ršg 
·‰”n
);

	@tools/src/polarssl/aes.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_AES_C
)

36 
	~"pŞ¬s¦/«s.h
"

37 
	~"pŞ¬s¦/·dlock.h
"

39 
	~<¡ršg.h
>

44 #iâdeà
GET_ULONG_LE


45 
	#GET_ULONG_LE
(
n
,
b
,
i
) \

47 (
n
èğĞ(è(
b
)[(
i
) ] ) \

48 | ( (è(
b
)[(
i
) + 1] << 8 ) \

49 | ( (è(
b
)[(
i
) + 2] << 16 ) \

50 | ( (è(
b
)[(
i
) + 3] << 24 ); \

51 }

	)

54 #iâdeà
PUT_ULONG_LE


55 
	#PUT_ULONG_LE
(
n
,
b
,
i
) \

57 (
b
)[(
i
è] = (èĞ(
n
) ); \

58 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 16 ); \

60 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 24 ); \

61 }

	)

64 #ià
defšed
(
POLARSSL_AES_ROM_TABLES
)

68 cÚ¡ 
	gFSb
[256] =

107 
	#FT
 \

109 
	`V
(
A5
,63,63,
C6
), V(84,7C,7C,
F8
), V(99,77,77,
EE
), V(8D,7B,7B,
F6
), \

110 
	`V
(0D,
F2
,F2,
FF
), V(
BD
,6B,6B,
D6
), V(
B1
,6F,6F,
DE
), V(54,
C5
,C5,91), \

111 
	`V
(50,30,30,60), V(03,01,01,02), V(
A9
,67,67,
CE
), V(7D,2B,2B,56), \

112 
	`V
(19,
FE
,FE,
E7
), V(62,
D7
,D7,
B5
), V(
E6
,
AB
,AB,4D), V(9A,76,76,
EC
), \

113 
	`V
(45,
CA
,CA,8F), V(9D,82,82,1F), V(40,
C9
,C9,89), V(87,7D,7D,
FA
), \

114 
	`V
(15,
FA
,FA,
EF
), V(
EB
,59,59,
B2
), V(
C9
,47,47,8E), V(0B,
F0
,F0,
FB
), \

115 
	`V
(
EC
,
AD
,AD,41), V(67,
D4
,D4,
B3
), V(
FD
,
A2
,A2,5F), V(
EA
,
AF
,AF,45), \

116 
	`V
(
BF
,9C,9C,23), V(
F7
,
A4
,A4,53), V(96,72,72,
E4
), V(5B,
C0
,C0,9B), \

117 
	`V
(
C2
,
B7
,B7,75), V(1C,
FD
,FD,
E1
), V(
AE
,93,93,3D), V(6A,26,26,4C), \

118 
	`V
(5A,36,36,6C), V(41,3F,3F,7E), V(02,
F7
,F7,
F5
), V(4F,
CC
,CC,83), \

119 
	`V
(5C,34,34,68), V(
F4
,
A5
,A5,51), V(34,
E5
,E5,
D1
), V(08,
F1
,F1,
F9
), \

120 
	`V
(93,71,71,
E2
), V(73,
D8
,D8,
AB
), V(53,31,31,62), V(3F,15,15,2A), \

121 
	`V
(0C,04,04,08), V(52,
C7
,C7,95), V(65,23,23,46), V(5E,
C3
,C3,9D), \

122 
	`V
(28,18,18,30), V(
A1
,96,96,37), V(0F,05,05,0A), V(
B5
,9A,9A,2F), \

123 
	`V
(09,07,07,0E), V(36,12,12,24), V(9B,80,80,1B), V(3D,
E2
,E2,
DF
), \

124 
	`V
(26,
EB
,EB,
CD
), V(69,27,27,4E), V(CD,
B2
,B2,7F), V(9F,75,75,
EA
), \

125 
	`V
(1B,09,09,12), V(9E,83,83,1D), V(74,2C,2C,58), V(2E,1A,1A,34), \

126 
	`V
(2D,1B,1B,36), V(
B2
,6E,6E,
DC
), V(
EE
,5A,5A,
B4
), V(
FB
,
A0
,A0,5B), \

127 
	`V
(
F6
,52,52,
A4
), V(4D,3B,3B,76), V(61,
D6
,D6,
B7
), V(
CE
,
B3
,B3,7D), \

128 
	`V
(7B,29,29,52), V(3E,
E3
,E3,
DD
), V(71,2F,2F,5E), V(97,84,84,13), \

129 
	`V
(
F5
,53,53,
A6
), V(68,
D1
,D1,
B9
), V(00,00,00,00), V(2C,
ED
,ED,
C1
), \

130 
	`V
(60,20,20,40), V(1F,
FC
,FC,
E3
), V(
C8
,
B1
,B1,79), V(
ED
,5B,5B,
B6
), \

131 
	`V
(
BE
,6A,6A,
D4
), V(46,
CB
,CB,8D), V(
D9
,BE,BE,67), V(4B,39,39,72), \

132 
	`V
(
DE
,4A,4A,94), V(
D4
,4C,4C,98), V(
E8
,58,58,
B0
), V(4A,
CF
,CF,85), \

133 
	`V
(6B,
D0
,D0,
BB
), V(2A,
EF
,EF,
C5
), V(
E5
,
AA
,AA,4F), V(16,
FB
,FB,
ED
), \

134 
	`V
(
C5
,43,43,86), V(
D7
,4D,4D,9A), V(55,33,33,66), V(94,85,85,11), \

135 
	`V
(
CF
,45,45,8A), V(10,
F9
,F9,
E9
), V(06,02,02,04), V(81,7F,7F,
FE
), \

136 
	`V
(
F0
,50,50,
A0
), V(44,3C,3C,78), V(
BA
,9F,9F,25), V(
E3
,
A8
,A8,4B), \

137 
	`V
(
F3
,51,51,
A2
), V(
FE
,
A3
,A3,5D), V(
C0
,40,40,80), V(8A,8F,8F,05), \

138 
	`V
(
AD
,92,92,3F), V(
BC
,9D,9D,21), V(48,38,38,70), V(04,
F5
,F5,
F1
), \

139 
	`V
(
DF
,
BC
,BC,63), V(
C1
,
B6
,B6,77), V(75,
DA
,DA,
AF
), V(63,21,21,42), \

140 
	`V
(30,10,10,20), V(1A,
FF
,FF,
E5
), V(0E,
F3
,F3,
FD
), V(6D,
D2
,D2,
BF
), \

141 
	`V
(4C,
CD
,CD,81), V(14,0C,0C,18), V(35,13,13,26), V(2F,
EC
,EC,
C3
), \

142 
	`V
(
E1
,5F,5F,
BE
), V(
A2
,97,97,35), V(
CC
,44,44,88), V(39,17,17,2E), \

143 
	`V
(57,
C4
,C4,93), V(
F2
,
A7
,A7,55), V(82,7E,7E,
FC
), V(47,3D,3D,7A), \

144 
	`V
(
AC
,64,64,
C8
), V(
E7
,5D,5D,
BA
), V(2B,19,19,32), V(95,73,73,
E6
), \

145 
	`V
(
A0
,60,60,
C0
), V(98,81,81,19), V(
D1
,4F,4F,9E), V(7F,
DC
,DC,
A3
), \

146 
	`V
(66,22,22,44), V(7E,2A,2A,54), V(
AB
,90,90,3B), V(83,88,88,0B), \

147 
	`V
(
CA
,46,46,8C), V(29,
EE
,EE,
C7
), V(
D3
,
B8
,B8,6B), V(3C,14,14,28), \

148 
	`V
(79,
DE
,DE,
A7
), V(
E2
,5E,5E,
BC
), V(1D,0B,0B,16), V(76,
DB
,DB,
AD
), \

149 
	`V
(3B,
E0
,E0,
DB
), V(56,32,32,64), V(4E,3A,3A,74), V(1E,0A,0A,14), \

150 
	`V
(
DB
,49,49,92), V(0A,06,06,0C), V(6C,24,24,48), V(
E4
,5C,5C,
B8
), \

151 
	`V
(5D,
C2
,C2,9F), V(6E,
D3
,D3,
BD
), V(
EF
,
AC
,AC,43), V(
A6
,62,62,
C4
), \

152 
	`V
(
A8
,91,91,39), V(
A4
,95,95,31), V(37,
E4
,E4,
D3
), V(8B,79,79,
F2
), \

153 
	`V
(32,
E7
,E7,
D5
), V(43,
C8
,C8,8B), V(59,37,37,6E), V(
B7
,6D,6D,
DA
), \

154 
	`V
(8C,8D,8D,01), V(64,
D5
,D5,
B1
), V(
D2
,4E,4E,9C), V(
E0
,
A9
,A9,49), \

155 
	`V
(
B4
,6C,6C,
D8
), V(
FA
,56,56,
AC
), V(07,
F4
,F4,
F3
), V(25,
EA
,EA,
CF
), \

156 
	`V
(
AF
,65,65,
CA
), V(8E,7A,7A,
F4
), V(
E9
,
AE
,AE,47), V(18,08,08,10), \

157 
	`V
(
D5
,
BA
,BA,6F), V(88,78,78,
F0
), V(6F,25,25,4A), V(72,2E,2E,5C), \

158 
	`V
(24,1C,1C,38), V(
F1
,
A6
,A6,57), V(
C7
,
B4
,B4,73), V(51,
C6
,C6,97), \

159 
	`V
(23,
E8
,E8,
CB
), V(7C,
DD
,DD,
A1
), V(9C,74,74,E8), V(21,1F,1F,3E), \

160 
	`V
(
DD
,4B,4B,96), V(
DC
,
BD
,BD,61), V(86,8B,8B,0D), V(85,8A,8A,0F), \

161 
	`V
(90,70,70,
E0
), V(42,3E,3E,7C), V(
C4
,
B5
,B5,71), V(
AA
,66,66,
CC
), \

162 
	`V
(
D8
,48,48,90), V(05,03,03,06), V(01,
F6
,F6,
F7
), V(12,0E,0E,1C), \

163 
	`V
(
A3
,61,61,
C2
), V(5F,35,35,6A), V(
F9
,57,57,
AE
), V(
D0
,
B9
,B9,69), \

164 
	`V
(91,86,86,17), V(58,
C1
,C1,99), V(27,1D,1D,3A), V(
B9
,9E,9E,27), \

165 
	`V
(38,
E1
,E1,
D9
), V(13,
F8
,F8,
EB
), V(
B3
,98,98,2B), V(33,11,11,22), \

166 
	`V
(
BB
,69,69,
D2
), V(70,
D9
,D9,
A9
), V(89,8E,8E,07), V(
A7
,94,94,33), \

167 
	`V
(
B6
,9B,9B,2D), V(22,1E,1E,3C), V(92,87,87,15), V(20,
E9
,E9,
C9
), \

168 
	`V
(49,
CE
,CE,87), V(
FF
,55,55,
AA
), V(78,28,28,50), V(7A,
DF
,DF,
A5
), \

169 
	`V
(8F,8C,8C,03), V(
F8
,
A1
,A1,59), V(80,89,89,09), V(17,0D,0D,1A), \

170 
	`V
(
DA
,
BF
,BF,65), V(31,
E6
,E6,
D7
), V(
C6
,42,42,84), V(
B8
,68,68,
D0
), \

171 
	`V
(
C3
,41,41,82), V(
B0
,99,99,29), V(77,2D,2D,5A), V(11,0F,0F,1E), \

172 
	`V
(
CB
,
B0
,B0,7B), V(
FC
,54,54,
A8
), V(
D6
,
BB
,BB,6D), V(3A,16,16,2C)

	)

174 
	#V
(
a
,
b
,
c
,
d
è0x##a##b##c##
	)
d

175 cÚ¡ 
	gFT0
[256] = { 
FT
 };

176 #undeà
V


178 
	#V
(
a
,
b
,
c
,
d
è0x##b##c##d##
	)
a

179 cÚ¡ 
	gFT1
[256] = { 
FT
 };

180 #undeà
V


182 
	#V
(
a
,
b
,
c
,
d
è0x##c##d##a##
	)
b

183 cÚ¡ 
	gFT2
[256] = { 
FT
 };

184 #undeà
V


186 
	#V
(
a
,
b
,
c
,
d
è0x##d##a##b##
	)
c

187 cÚ¡ 
	gFT3
[256] = { 
FT
 };

188 #undeà
V


190 #undeà
FT


195 cÚ¡ 
	gRSb
[256] =

234 
	#RT
 \

236 
	`V
(50,
A7
,
F4
,51), V(53,65,41,7E), V(
C3
,
A4
,17,1A), V(96,5E,27,3A), \

237 
	`V
(
CB
,6B,
AB
,3B), V(
F1
,45,9D,1F), V(AB,58,
FA
,
AC
), V(93,03,
E3
,4B), \

238 
	`V
(55,
FA
,30,20), V(
F6
,6D,76,
AD
), V(91,76,
CC
,88), V(25,4C,02,
F5
), \

239 
	`V
(
FC
,
D7
,
E5
,4F), V(D7,
CB
,2A,
C5
), V(80,44,35,26), V(8F,
A3
,62,
B5
), \

240 
	`V
(49,5A,
B1
,
DE
), V(67,1B,
BA
,25), V(98,0E,
EA
,45), V(
E1
,
C0
,
FE
,5D), \

241 
	`V
(02,75,2F,
C3
), V(12,
F0
,4C,81), V(
A3
,97,46,8D), V(
C6
,
F9
,
D3
,6B), \

242 
	`V
(
E7
,5F,8F,03), V(95,9C,92,15), V(
EB
,7A,6D,
BF
), V(
DA
,59,52,95), \

243 
	`V
(2D,83,
BE
,
D4
), V(
D3
,21,74,58), V(29,69,
E0
,49), V(44,
C8
,
C9
,8E), \

244 
	`V
(6A,89,
C2
,75), V(78,79,8E,
F4
), V(6B,3E,58,99), V(
DD
,71,
B9
,27), \

245 
	`V
(
B6
,4F,
E1
,
BE
), V(17,
AD
,88,
F0
), V(66,
AC
,20,
C9
), V(
B4
,3A,
CE
,7D), \

246 
	`V
(18,4A,
DF
,63), V(82,31,1A,
E5
), V(60,33,51,97), V(45,7F,53,62), \

247 
	`V
(
E0
,77,64,
B1
), V(84,
AE
,6B,
BB
), V(1C,
A0
,81,
FE
), V(94,2B,08,
F9
), \

248 
	`V
(58,68,48,70), V(19,
FD
,45,8F), V(87,6C,
DE
,94), V(
B7
,
F8
,7B,52), \

249 
	`V
(23,
D3
,73,
AB
), V(
E2
,02,4B,72), V(57,8F,1F,
E3
), V(2A,AB,55,66), \

250 
	`V
(07,28,
EB
,
B2
), V(03,
C2
,
B5
,2F), V(9A,7B,
C5
,86), V(
A5
,08,37,
D3
), \

251 
	`V
(
F2
,87,28,30), V(
B2
,
A5
,
BF
,23), V(
BA
,6A,03,02), V(5C,82,16,
ED
), \

252 
	`V
(2B,1C,
CF
,8A), V(92,
B4
,79,
A7
), V(
F0
,
F2
,07,
F3
), V(
A1
,
E2
,69,4E), \

253 
	`V
(
CD
,
F4
,
DA
,65), V(
D5
,
BE
,05,06), V(1F,62,34,
D1
), V(8A,
FE
,
A6
,
C4
), \

254 
	`V
(9D,53,2E,34), V(
A0
,55,
F3
,
A2
), V(32,
E1
,8A,05), V(75,
EB
,
F6
,
A4
), \

255 
	`V
(39,
EC
,83,0B), V(
AA
,
EF
,60,40), V(06,9F,71,5E), V(51,10,6E,
BD
), \

256 
	`V
(
F9
,8A,21,3E), V(3D,06,
DD
,96), V(
AE
,05,3E,DD), V(46,
BD
,
E6
,4D), \

257 
	`V
(
B5
,8D,54,91), V(05,5D,
C4
,71), V(6F,
D4
,06,04), V(
FF
,15,50,60), \

258 
	`V
(24,
FB
,98,19), V(97,
E9
,
BD
,
D6
), V(
CC
,43,40,89), V(77,9E,
D9
,67), \

259 
	`V
(
BD
,42,
E8
,
B0
), V(88,8B,89,07), V(38,5B,19,
E7
), V(
DB
,
EE
,
C8
,79), \

260 
	`V
(47,0A,7C,
A1
), V(
E9
,0F,42,7C), V(
C9
,1E,84,
F8
), V(00,00,00,00), \

261 
	`V
(83,86,80,09), V(48,
ED
,2B,32), V(
AC
,70,11,1E), V(4E,72,5A,6C), \

262 
	`V
(
FB
,
FF
,0E,
FD
), V(56,38,85,0F), V(1E,
D5
,
AE
,3D), V(27,39,2D,36), \

263 
	`V
(64,
D9
,0F,0A), V(21,
A6
,5C,68), V(
D1
,54,5B,9B), V(3A,2E,36,24), \

264 
	`V
(
B1
,67,0A,0C), V(0F,
E7
,57,93), V(
D2
,96,
EE
,
B4
), V(9E,91,9B,1B), \

265 
	`V
(4F,
C5
,
C0
,80), V(
A2
,20,
DC
,61), V(69,4B,77,5A), V(16,1A,12,1C), \

266 
	`V
(0A,
BA
,93,
E2
), V(
E5
,2A,
A0
,
C0
), V(43,
E0
,22,3C), V(1D,17,1B,12), \

267 
	`V
(0B,0D,09,0E), V(
AD
,
C7
,8B,
F2
), V(
B9
,
A8
,
B6
,2D), V(
C8
,
A9
,1E,14), \

268 
	`V
(85,19,
F1
,57), V(4C,07,75,
AF
), V(
BB
,
DD
,99,
EE
), V(
FD
,60,7F,
A3
), \

269 
	`V
(9F,26,01,
F7
), V(
BC
,
F5
,72,5C), V(
C5
,3B,66,44), V(34,7E,
FB
,5B), \

270 
	`V
(76,29,43,8B), V(
DC
,
C6
,23,
CB
), V(68,
FC
,
ED
,
B6
), V(63,
F1
,
E4
,
B8
), \

271 
	`V
(
CA
,
DC
,31,
D7
), V(10,85,63,42), V(40,22,97,13), V(20,11,
C6
,84), \

272 
	`V
(7D,24,4A,85), V(
F8
,3D,
BB
,
D2
), V(11,32,
F9
,
AE
), V(6D,
A1
,29,
C7
), \

273 
	`V
(4B,2F,9E,1D), V(
F3
,30,
B2
,
DC
), V(
EC
,52,86,0D), V(
D0
,
E3
,
C1
,77), \

274 
	`V
(6C,16,
B3
,2B), V(99,
B9
,70,
A9
), V(
FA
,48,94,11), V(22,64,
E9
,47), \

275 
	`V
(
C4
,8C,
FC
,
A8
), V(1A,3F,
F0
,
A0
), V(
D8
,2C,7D,56), V(
EF
,90,33,22), \

276 
	`V
(
C7
,4E,49,87), V(
C1
,
D1
,38,
D9
), V(
FE
,
A2
,
CA
,8C), V(36,0B,
D4
,98), \

277 
	`V
(
CF
,81,
F5
,
A6
), V(28,
DE
,7A,
A5
), V(26,8E,
B7
,
DA
), V(
A4
,
BF
,
AD
,3F), \

278 
	`V
(
E4
,9D,3A,2C), V(0D,92,78,50), V(9B,
CC
,5F,6A), V(62,46,7E,54), \

279 
	`V
(
C2
,13,8D,
F6
), V(
E8
,
B8
,
D8
,90), V(5E,
F7
,39,2E), V(
F5
,
AF
,
C3
,82), \

280 
	`V
(
BE
,80,5D,9F), V(7C,93,
D0
,69), V(
A9
,2D,
D5
,6F), V(
B3
,12,25,
CF
), \

281 
	`V
(3B,99,
AC
,
C8
), V(
A7
,7D,18,10), V(6E,63,9C,
E8
), V(7B,
BB
,3B,
DB
), \

282 
	`V
(09,78,26,
CD
), V(
F4
,18,59,6E), V(01,
B7
,9A,
EC
), V(
A8
,9A,4F,83), \

283 
	`V
(65,6E,95,
E6
), V(7E,E6,
FF
,
AA
), V(08,
CF
,
BC
,21), V(E6,
E8
,15,
EF
), \

284 
	`V
(
D9
,9B,
E7
,
BA
), V(
CE
,36,6F,4A), V(
D4
,09,9F,
EA
), V(
D6
,7C,
B0
,29), \

285 
	`V
(
AF
,
B2
,
A4
,31), V(31,23,3F,2A), V(30,94,
A5
,
C6
), V(
C0
,66,
A2
,35), \

286 
	`V
(37,
BC
,4E,74), V(
A6
,
CA
,82,
FC
), V(
B0
,
D0
,90,
E0
), V(15,
D8
,
A7
,33), \

287 
	`V
(4A,98,04,
F1
), V(
F7
,
DA
,
EC
,41), V(0E,50,
CD
,7F), V(2F,
F6
,91,17), \

288 
	`V
(8D,
D6
,4D,76), V(4D,
B0
,
EF
,43), V(54,4D,
AA
,
CC
), V(
DF
,04,96,
E4
), \

289 
	`V
(
E3
,
B5
,
D1
,9E), V(1B,88,6A,4C), V(
B8
,1F,2C,
C1
), V(7F,51,65,46), \

290 
	`V
(04,
EA
,5E,9D), V(5D,35,8C,01), V(73,74,87,
FA
), V(2E,41,0B,
FB
), \

291 
	`V
(5A,1D,67,
B3
), V(52,
D2
,
DB
,92), V(33,56,10,
E9
), V(13,47,
D6
,6D), \

292 
	`V
(8C,61,
D7
,9A), V(7A,0C,
A1
,37), V(8E,14,
F8
,59), V(89,3C,13,
EB
), \

293 
	`V
(
EE
,27,
A9
,
CE
), V(35,
C9
,61,
B7
), V(
ED
,
E5
,1C,
E1
), V(3C,
B1
,47,7A), \

294 
	`V
(59,
DF
,
D2
,9C), V(3F,73,
F2
,55), V(79,
CE
,14,18), V(
BF
,37,
C7
,73), \

295 
	`V
(
EA
,
CD
,
F7
,53), V(5B,
AA
,
FD
,5F), V(14,6F,3D,
DF
), V(86,
DB
,44,78), \

296 
	`V
(81,
F3
,
AF
,
CA
), V(3E,
C4
,68,
B9
), V(2C,34,24,38), V(5F,40,
A3
,
C2
), \

297 
	`V
(72,
C3
,1D,16), V(0C,25,
E2
,
BC
), V(8B,49,3C,28), V(41,95,0D,
FF
), \

298 
	`V
(71,01,
A8
,39), V(
DE
,
B3
,0C,08), V(9C,
E4
,
B4
,
D8
), V(90,
C1
,56,64), \

299 
	`V
(61,84,
CB
,7B), V(70,
B6
,32,
D5
), V(74,5C,6C,48), V(42,57,
B8
,
D0
)

	)

301 
	#V
(
a
,
b
,
c
,
d
è0x##a##b##c##
	)
d

302 cÚ¡ 
	gRT0
[256] = { 
RT
 };

303 #undeà
V


305 
	#V
(
a
,
b
,
c
,
d
è0x##b##c##d##
	)
a

306 cÚ¡ 
	gRT1
[256] = { 
RT
 };

307 #undeà
V


309 
	#V
(
a
,
b
,
c
,
d
è0x##c##d##a##
	)
b

310 cÚ¡ 
	gRT2
[256] = { 
RT
 };

311 #undeà
V


313 
	#V
(
a
,
b
,
c
,
d
è0x##d##a##b##
	)
c

314 cÚ¡ 
	gRT3
[256] = { 
RT
 };

315 #undeà
V


317 #undeà
RT


322 cÚ¡ 
	gRCON
[10] =

334 
	gFSb
[256];

335 
	gFT0
[256];

336 
	gFT1
[256];

337 
	gFT2
[256];

338 
	gFT3
[256];

343 
	gRSb
[256];

344 
	gRT0
[256];

345 
	gRT1
[256];

346 
	gRT2
[256];

347 
	gRT3
[256];

352 
	gRCON
[10];

357 
	#ROTL8
(
x
èĞĞx << 8 ) & 0xFFFFFFFF ) | ( x >> 24 )

	)

358 
	#XTIME
(
x
èĞĞx << 1 ) ^ ( ( x & 0x80 ) ? 0x1B : 0x00 ) )

	)

359 
	#MUL
(
x
,
y
èĞĞx && y ) ? 
pow
[(
log
[x]+log[y]è% 255] : 0 )

	)

361 
	g«s_š™_dÚe
 = 0;

363 
	$«s_g’_bËs
( )

365 
i
, 
x
, 
y
, 
z
;

366 
pow
[256];

367 
log
[256];

372  
i
 = 0, 
x
 = 1; i < 256; i++ )

374 
pow
[
i
] = 
x
;

375 
log
[
x
] = 
i
;

376 
x
 = ( x ^ 
	`XTIME
( x ) ) & 0xFF;

382  
i
 = 0, 
x
 = 1; i < 10; i++ )

384 
RCON
[
i
] = (è
x
;

385 
x
 = 
	`XTIME
( x ) & 0xFF;

391 
FSb
[0x00] = 0x63;

392 
RSb
[0x63] = 0x00;

394  
i
 = 1; i < 256; i++ )

396 
x
 = 
pow
[255 - 
log
[
i
]];

398 
y
 = 
x
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

399 
x
 ^ğ
y
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

400 
x
 ^ğ
y
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

401 
x
 ^ğ
y
; y = ( (y << 1) | (y >> 7) ) & 0xFF;

402 
x
 ^ğ
y
 ^ 0x63;

404 
FSb
[
i
] = (è
x
;

405 
RSb
[
x
] = (è
i
;

411  
i
 = 0; i < 256; i++ )

413 
x
 = 
FSb
[
i
];

414 
y
 = 
	`XTIME
Ğ
x
 ) & 0xFF;

415 
z
 = ( 
y
 ^ 
x
 ) & 0xFF;

417 
FT0
[
i
] = ( (è
y
 ) ^

418 Ğ(è
x
 << 8 ) ^

419 Ğ(è
x
 << 16 ) ^

420 Ğ(è
z
 << 24 );

422 
FT1
[
i
] = 
	`ROTL8
Ğ
FT0
[i] );

423 
FT2
[
i
] = 
	`ROTL8
Ğ
FT1
[i] );

424 
FT3
[
i
] = 
	`ROTL8
Ğ
FT2
[i] );

426 
x
 = 
RSb
[
i
];

428 
RT0
[
i
] = ( (è
	`MUL
Ğ0x0E, 
x
 ) ) ^

429 Ğ(è
	`MUL
Ğ0x09, 
x
 ) << 8 ) ^

430 Ğ(è
	`MUL
Ğ0x0D, 
x
 ) << 16 ) ^

431 Ğ(è
	`MUL
Ğ0x0B, 
x
 ) << 24 );

433 
RT1
[
i
] = 
	`ROTL8
Ğ
RT0
[i] );

434 
RT2
[
i
] = 
	`ROTL8
Ğ
RT1
[i] );

435 
RT3
[
i
] = 
	`ROTL8
Ğ
RT2
[i] );

437 
	}
}

444 
	$«s_£tkey_’c
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

446 
i
;

447 *
RK
;

449 #ià!
	`defšed
(
POLARSSL_AES_ROM_TABLES
)

450 ifĞ
«s_š™_dÚe
 == 0 )

452 
	`«s_g’_bËs
();

453 
«s_š™_dÚe
 = 1;

457  
keysize
 )

459 128: 
ùx
->
Ä
 = 10; ;

460 192: 
ùx
->
Ä
 = 12; ;

461 256: 
ùx
->
Ä
 = 14; ;

462  : Ğ
POLARSSL_ERR_AES_INVALID_KEY_LENGTH
 );

465 #ià
	`defšed
(
PADLOCK_ALIGN16
)

466 
ùx
->
rk
 = 
RK
 = 
	`PADLOCK_ALIGN16
Ğùx->
buf
 );

468 
ùx
->
rk
 = 
RK
 = ctx->
buf
;

471  
i
 = 0; i < (
keysize
 >> 5); i++ )

473 
	`GET_ULONG_LE
Ğ
RK
[
i
], 
key
, i << 2 );

476  
ùx
->
Ä
 )

480  
i
 = 0; i < 10; i++, 
RK
 += 4 )

482 
RK
[4] = RK[0] ^ 
RCON
[
i
] ^

483 Ğ(è
FSb
[ ( 
RK
[3] >> 8 ) & 0xFF ] ) ^

484 Ğ(è
FSb
[ ( 
RK
[3] >> 16 ) & 0xFF ] << 8 ) ^

485 Ğ(è
FSb
[ ( 
RK
[3] >> 24 ) & 0xFF ] << 16 ) ^

486 Ğ(è
FSb
[ ( 
RK
[3] ) & 0xFF ] << 24 );

488 
RK
[5] = RK[1] ^ RK[4];

489 
RK
[6] = RK[2] ^ RK[5];

490 
RK
[7] = RK[3] ^ RK[6];

496  
i
 = 0; i < 8; i++, 
RK
 += 6 )

498 
RK
[6] = RK[0] ^ 
RCON
[
i
] ^

499 Ğ(è
FSb
[ ( 
RK
[5] >> 8 ) & 0xFF ] ) ^

500 Ğ(è
FSb
[ ( 
RK
[5] >> 16 ) & 0xFF ] << 8 ) ^

501 Ğ(è
FSb
[ ( 
RK
[5] >> 24 ) & 0xFF ] << 16 ) ^

502 Ğ(è
FSb
[ ( 
RK
[5] ) & 0xFF ] << 24 );

504 
RK
[7] = RK[1] ^ RK[6];

505 
RK
[8] = RK[2] ^ RK[7];

506 
RK
[9] = RK[3] ^ RK[8];

507 
RK
[10] = RK[4] ^ RK[9];

508 
RK
[11] = RK[5] ^ RK[10];

514  
i
 = 0; i < 7; i++, 
RK
 += 8 )

516 
RK
[8] = RK[0] ^ 
RCON
[
i
] ^

517 Ğ(è
FSb
[ ( 
RK
[7] >> 8 ) & 0xFF ] ) ^

518 Ğ(è
FSb
[ ( 
RK
[7] >> 16 ) & 0xFF ] << 8 ) ^

519 Ğ(è
FSb
[ ( 
RK
[7] >> 24 ) & 0xFF ] << 16 ) ^

520 Ğ(è
FSb
[ ( 
RK
[7] ) & 0xFF ] << 24 );

522 
RK
[9] = RK[1] ^ RK[8];

523 
RK
[10] = RK[2] ^ RK[9];

524 
RK
[11] = RK[3] ^ RK[10];

526 
RK
[12] = RK[4] ^

527 Ğ(è
FSb
[ ( 
RK
[11] ) & 0xFF ] ) ^

528 Ğ(è
FSb
[ ( 
RK
[11] >> 8 ) & 0xFF ] << 8 ) ^

529 Ğ(è
FSb
[ ( 
RK
[11] >> 16 ) & 0xFF ] << 16 ) ^

530 Ğ(è
FSb
[ ( 
RK
[11] >> 24 ) & 0xFF ] << 24 );

532 
RK
[13] = RK[5] ^ RK[12];

533 
RK
[14] = RK[6] ^ RK[13];

534 
RK
[15] = RK[7] ^ RK[14];

544 
	}
}

549 
	$«s_£tkey_dec
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

551 
i
, 
j
;

552 
«s_cÚ‹xt
 
ùy
;

553 *
RK
;

554 *
SK
;

555 
»t
;

557  
keysize
 )

559 128: 
ùx
->
Ä
 = 10; ;

560 192: 
ùx
->
Ä
 = 12; ;

561 256: 
ùx
->
Ä
 = 14; ;

562  : Ğ
POLARSSL_ERR_AES_INVALID_KEY_LENGTH
 );

565 #ià
	`defšed
(
PADLOCK_ALIGN16
)

566 
ùx
->
rk
 = 
RK
 = 
	`PADLOCK_ALIGN16
Ğùx->
buf
 );

568 
ùx
->
rk
 = 
RK
 = ctx->
buf
;

571 
»t
 = 
	`«s_£tkey_’c
Ğ&
ùy
, 
key
, 
keysize
 );

572 ifĞ
»t
 != 0 )

573 Ğ
»t
 );

575 
SK
 = 
ùy
.
rk
 + cty.
Ä
 * 4;

577 *
RK
++ = *
SK
++;

578 *
RK
++ = *
SK
++;

579 *
RK
++ = *
SK
++;

580 *
RK
++ = *
SK
++;

582  
i
 = 
ùx
->
Ä
 - 1, 
SK
 -= 8; i > 0; i--, SK -= 8 )

584  
j
 = 0; j < 4; j++, 
SK
++ )

586 *
RK
++ = 
RT0
[ 
FSb
[ ( *
SK
 ) & 0xFF ] ] ^

587 
RT1
[ 
FSb
[ ( *
SK
 >> 8 ) & 0xFF ] ] ^

588 
RT2
[ 
FSb
[ ( *
SK
 >> 16 ) & 0xFF ] ] ^

589 
RT3
[ 
FSb
[ ( *
SK
 >> 24 ) & 0xFF ] ];

593 *
RK
++ = *
SK
++;

594 *
RK
++ = *
SK
++;

595 *
RK
++ = *
SK
++;

596 *
RK
++ = *
SK
++;

598 
	`mem£t
Ğ&
ùy
, 0, Ğ
«s_cÚ‹xt
 ) );

601 
	}
}

603 
	#AES_FROUND
(
X0
,
X1
,
X2
,
X3
,
Y0
,
Y1
,
Y2
,
Y3
) \

605 
X0
 = *
RK
++ ^ 
FT0
[ ( 
Y0
 ) & 0xFF ] ^ \

606 
FT1
[ ( 
Y1
 >> 8 ) & 0xFF ] ^ \

607 
FT2
[ ( 
Y2
 >> 16 ) & 0xFF ] ^ \

608 
FT3
[ ( 
Y3
 >> 24 ) & 0xFF ]; \

610 
X1
 = *
RK
++ ^ 
FT0
[ ( 
Y1
 ) & 0xFF ] ^ \

611 
FT1
[ ( 
Y2
 >> 8 ) & 0xFF ] ^ \

612 
FT2
[ ( 
Y3
 >> 16 ) & 0xFF ] ^ \

613 
FT3
[ ( 
Y0
 >> 24 ) & 0xFF ]; \

615 
X2
 = *
RK
++ ^ 
FT0
[ ( 
Y2
 ) & 0xFF ] ^ \

616 
FT1
[ ( 
Y3
 >> 8 ) & 0xFF ] ^ \

617 
FT2
[ ( 
Y0
 >> 16 ) & 0xFF ] ^ \

618 
FT3
[ ( 
Y1
 >> 24 ) & 0xFF ]; \

620 
X3
 = *
RK
++ ^ 
FT0
[ ( 
Y3
 ) & 0xFF ] ^ \

621 
FT1
[ ( 
Y0
 >> 8 ) & 0xFF ] ^ \

622 
FT2
[ ( 
Y1
 >> 16 ) & 0xFF ] ^ \

623 
FT3
[ ( 
Y2
 >> 24 ) & 0xFF ]; \

624 }

	)

626 
	#AES_RROUND
(
X0
,
X1
,
X2
,
X3
,
Y0
,
Y1
,
Y2
,
Y3
) \

628 
X0
 = *
RK
++ ^ 
RT0
[ ( 
Y0
 ) & 0xFF ] ^ \

629 
RT1
[ ( 
Y3
 >> 8 ) & 0xFF ] ^ \

630 
RT2
[ ( 
Y2
 >> 16 ) & 0xFF ] ^ \

631 
RT3
[ ( 
Y1
 >> 24 ) & 0xFF ]; \

633 
X1
 = *
RK
++ ^ 
RT0
[ ( 
Y1
 ) & 0xFF ] ^ \

634 
RT1
[ ( 
Y0
 >> 8 ) & 0xFF ] ^ \

635 
RT2
[ ( 
Y3
 >> 16 ) & 0xFF ] ^ \

636 
RT3
[ ( 
Y2
 >> 24 ) & 0xFF ]; \

638 
X2
 = *
RK
++ ^ 
RT0
[ ( 
Y2
 ) & 0xFF ] ^ \

639 
RT1
[ ( 
Y1
 >> 8 ) & 0xFF ] ^ \

640 
RT2
[ ( 
Y0
 >> 16 ) & 0xFF ] ^ \

641 
RT3
[ ( 
Y3
 >> 24 ) & 0xFF ]; \

643 
X3
 = *
RK
++ ^ 
RT0
[ ( 
Y3
 ) & 0xFF ] ^ \

644 
RT1
[ ( 
Y2
 >> 8 ) & 0xFF ] ^ \

645 
RT2
[ ( 
Y1
 >> 16 ) & 0xFF ] ^ \

646 
RT3
[ ( 
Y0
 >> 24 ) & 0xFF ]; \

647 }

	)

652 
	$«s_üy±_ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

653 
mode
,

654 cÚ¡ 
šput
[16],

655 
ouut
[16] )

657 
i
;

658 *
RK
, 
X0
, 
X1
, 
X2
, 
X3
, 
Y0
, 
Y1
, 
Y2
, 
Y3
;

660 #ià
	`defšed
(
POLARSSL_PADLOCK_C
è&& defšed(
POLARSSL_HAVE_X86
)

661 ifĞ
	`·dlock_suµÜts
Ğ
PADLOCK_ACE
 ) )

663 ifĞ
	`·dlock_xüy±ecb
Ğ
ùx
, 
mode
, 
šput
, 
ouut
 ) == 0 )

672 
RK
 = 
ùx
->
rk
;

674 
	`GET_ULONG_LE
Ğ
X0
, 
šput
, 0 ); X0 ^ğ*
RK
++;

675 
	`GET_ULONG_LE
Ğ
X1
, 
šput
, 4 ); X1 ^ğ*
RK
++;

676 
	`GET_ULONG_LE
Ğ
X2
, 
šput
, 8 ); X2 ^ğ*
RK
++;

677 
	`GET_ULONG_LE
Ğ
X3
, 
šput
, 12 ); X3 ^ğ*
RK
++;

679 ifĞ
mode
 =ğ
AES_DECRYPT
 )

681  
i
 = (
ùx
->
Ä
 >> 1) - 1; i > 0; i-- )

683 
	`AES_RROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

684 
	`AES_RROUND
Ğ
X0
, 
X1
, 
X2
, 
X3
, 
Y0
, 
Y1
, 
Y2
, 
Y3
 );

687 
	`AES_RROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

689 
X0
 = *
RK
++ ^ \

690 Ğ(è
RSb
[ ( 
Y0
 ) & 0xFF ] ) ^

691 Ğ(è
RSb
[ ( 
Y3
 >> 8 ) & 0xFF ] << 8 ) ^

692 Ğ(è
RSb
[ ( 
Y2
 >> 16 ) & 0xFF ] << 16 ) ^

693 Ğ(è
RSb
[ ( 
Y1
 >> 24 ) & 0xFF ] << 24 );

695 
X1
 = *
RK
++ ^ \

696 Ğ(è
RSb
[ ( 
Y1
 ) & 0xFF ] ) ^

697 Ğ(è
RSb
[ ( 
Y0
 >> 8 ) & 0xFF ] << 8 ) ^

698 Ğ(è
RSb
[ ( 
Y3
 >> 16 ) & 0xFF ] << 16 ) ^

699 Ğ(è
RSb
[ ( 
Y2
 >> 24 ) & 0xFF ] << 24 );

701 
X2
 = *
RK
++ ^ \

702 Ğ(è
RSb
[ ( 
Y2
 ) & 0xFF ] ) ^

703 Ğ(è
RSb
[ ( 
Y1
 >> 8 ) & 0xFF ] << 8 ) ^

704 Ğ(è
RSb
[ ( 
Y0
 >> 16 ) & 0xFF ] << 16 ) ^

705 Ğ(è
RSb
[ ( 
Y3
 >> 24 ) & 0xFF ] << 24 );

707 
X3
 = *
RK
++ ^ \

708 Ğ(è
RSb
[ ( 
Y3
 ) & 0xFF ] ) ^

709 Ğ(è
RSb
[ ( 
Y2
 >> 8 ) & 0xFF ] << 8 ) ^

710 Ğ(è
RSb
[ ( 
Y1
 >> 16 ) & 0xFF ] << 16 ) ^

711 Ğ(è
RSb
[ ( 
Y0
 >> 24 ) & 0xFF ] << 24 );

715  
i
 = (
ùx
->
Ä
 >> 1) - 1; i > 0; i-- )

717 
	`AES_FROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

718 
	`AES_FROUND
Ğ
X0
, 
X1
, 
X2
, 
X3
, 
Y0
, 
Y1
, 
Y2
, 
Y3
 );

721 
	`AES_FROUND
Ğ
Y0
, 
Y1
, 
Y2
, 
Y3
, 
X0
, 
X1
, 
X2
, 
X3
 );

723 
X0
 = *
RK
++ ^ \

724 Ğ(è
FSb
[ ( 
Y0
 ) & 0xFF ] ) ^

725 Ğ(è
FSb
[ ( 
Y1
 >> 8 ) & 0xFF ] << 8 ) ^

726 Ğ(è
FSb
[ ( 
Y2
 >> 16 ) & 0xFF ] << 16 ) ^

727 Ğ(è
FSb
[ ( 
Y3
 >> 24 ) & 0xFF ] << 24 );

729 
X1
 = *
RK
++ ^ \

730 Ğ(è
FSb
[ ( 
Y1
 ) & 0xFF ] ) ^

731 Ğ(è
FSb
[ ( 
Y2
 >> 8 ) & 0xFF ] << 8 ) ^

732 Ğ(è
FSb
[ ( 
Y3
 >> 16 ) & 0xFF ] << 16 ) ^

733 Ğ(è
FSb
[ ( 
Y0
 >> 24 ) & 0xFF ] << 24 );

735 
X2
 = *
RK
++ ^ \

736 Ğ(è
FSb
[ ( 
Y2
 ) & 0xFF ] ) ^

737 Ğ(è
FSb
[ ( 
Y3
 >> 8 ) & 0xFF ] << 8 ) ^

738 Ğ(è
FSb
[ ( 
Y0
 >> 16 ) & 0xFF ] << 16 ) ^

739 Ğ(è
FSb
[ ( 
Y1
 >> 24 ) & 0xFF ] << 24 );

741 
X3
 = *
RK
++ ^ \

742 Ğ(è
FSb
[ ( 
Y3
 ) & 0xFF ] ) ^

743 Ğ(è
FSb
[ ( 
Y0
 >> 8 ) & 0xFF ] << 8 ) ^

744 Ğ(è
FSb
[ ( 
Y1
 >> 16 ) & 0xFF ] << 16 ) ^

745 Ğ(è
FSb
[ ( 
Y2
 >> 24 ) & 0xFF ] << 24 );

748 
	`PUT_ULONG_LE
Ğ
X0
, 
ouut
, 0 );

749 
	`PUT_ULONG_LE
Ğ
X1
, 
ouut
, 4 );

750 
	`PUT_ULONG_LE
Ğ
X2
, 
ouut
, 8 );

751 
	`PUT_ULONG_LE
Ğ
X3
, 
ouut
, 12 );

754 
	}
}

759 
	$«s_üy±_cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

760 
mode
,

761 
Ëngth
,

762 
iv
[16],

763 cÚ¡ *
šput
,

764 *
ouut
 )

766 
i
;

767 
‹mp
[16];

769 ifĞ
Ëngth
 % 16 )

770 Ğ
POLARSSL_ERR_AES_INVALID_INPUT_LENGTH
 );

772 #ià
	`defšed
(
POLARSSL_PADLOCK_C
è&& defšed(
POLARSSL_HAVE_X86
)

773 ifĞ
	`·dlock_suµÜts
Ğ
PADLOCK_ACE
 ) )

775 ifĞ
	`·dlock_xüy±cbc
Ğ
ùx
, 
mode
, 
Ëngth
, 
iv
, 
šput
, 
ouut
 ) == 0 )

784 ifĞ
mode
 =ğ
AES_DECRYPT
 )

786  
Ëngth
 > 0 )

788 
	`memıy
Ğ
‹mp
, 
šput
, 16 );

789 
	`«s_üy±_ecb
Ğ
ùx
, 
mode
, 
šput
, 
ouut
 );

791  
i
 = 0; i < 16; i++ )

792 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

794 
	`memıy
Ğ
iv
, 
‹mp
, 16 );

796 
šput
 += 16;

797 
ouut
 += 16;

798 
Ëngth
 -= 16;

803  
Ëngth
 > 0 )

805  
i
 = 0; i < 16; i++ )

806 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

808 
	`«s_üy±_ecb
Ğ
ùx
, 
mode
, 
ouut
, output );

809 
	`memıy
Ğ
iv
, 
ouut
, 16 );

811 
šput
 += 16;

812 
ouut
 += 16;

813 
Ëngth
 -= 16;

818 
	}
}

823 
	$«s_üy±_cfb128
Ğ
«s_cÚ‹xt
 *
ùx
,

824 
mode
,

825 
Ëngth
,

826 *
iv_off
,

827 
iv
[16],

828 cÚ¡ *
šput
,

829 *
ouut
 )

831 
c
, 
n
 = *
iv_off
;

833 ifĞ
mode
 =ğ
AES_DECRYPT
 )

835  
Ëngth
-- )

837 ifĞ
n
 == 0 )

838 
	`«s_üy±_ecb
Ğ
ùx
, 
AES_ENCRYPT
, 
iv
, iv );

840 
c
 = *
šput
++;

841 *
ouut
++ = ()Ğ
c
 ^ 
iv
[
n
] );

842 
iv
[
n
] = (è
c
;

844 
n
 = (n + 1) & 0x0F;

849  
Ëngth
-- )

851 ifĞ
n
 == 0 )

852 
	`«s_üy±_ecb
Ğ
ùx
, 
AES_ENCRYPT
, 
iv
, iv );

854 
iv
[
n
] = *
ouut
++ = ()Ğiv[n] ^ *
šput
++ );

856 
n
 = (n + 1) & 0x0F;

860 *
iv_off
 = 
n
;

863 
	}
}

865 #ià
defšed
(
POLARSSL_SELF_TEST
)

867 
	~<¡dio.h
>

874 cÚ¡ 
	g«s_‹¡_ecb_dec
[3][16] =

884 cÚ¡ 
	g«s_‹¡_ecb_’c
[3][16] =

894 cÚ¡ 
	g«s_‹¡_cbc_dec
[3][16] =

904 cÚ¡ 
	g«s_‹¡_cbc_’c
[3][16] =

919 cÚ¡ 
	g«s_‹¡_cfb128_key
[3][32] =

932 cÚ¡ 
	g«s_‹¡_cfb128_iv
[16] =

938 cÚ¡ 
	g«s_‹¡_cfb128_±
[64] =

950 cÚ¡ 
	g«s_‹¡_cfb128_ù
[3][64] =

981 
	$«s_£lf_‹¡
Ğ
v”bo£
 )

983 
i
, 
j
, 
u
, 
v
, 
off£t
;

984 
key
[32];

985 
buf
[64];

986 
´v
[16];

987 
iv
[16];

988 
«s_cÚ‹xt
 
ùx
;

990 
	`mem£t
Ğ
key
, 0, 32 );

995  
i
 = 0; i < 6; i++ )

997 
u
 = 
i
 >> 1;

998 
v
 = 
i
 & 1;

1000 ifĞ
v”bo£
 != 0 )

1001 
	`´štf
Ğ" AES-ECB-%3d (%s): ", 128 + 
u
 * 64,

1002 Ğ
v
 =ğ
AES_DECRYPT
 ) ? "dec" : "enc" );

1004 
	`mem£t
Ğ
buf
, 0, 16 );

1006 ifĞ
v
 =ğ
AES_DECRYPT
 )

1008 
	`«s_£tkey_dec
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1010  
j
 = 0; j < 10000; j++ )

1011 
	`«s_üy±_ecb
Ğ&
ùx
, 
v
, 
buf
, buf );

1013 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_ecb_dec
[
u
], 16 ) != 0 )

1015 ifĞ
v”bo£
 != 0 )

1016 
	`´štf
( "failed\n" );

1023 
	`«s_£tkey_’c
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1025  
j
 = 0; j < 10000; j++ )

1026 
	`«s_üy±_ecb
Ğ&
ùx
, 
v
, 
buf
, buf );

1028 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_ecb_’c
[
u
], 16 ) != 0 )

1030 ifĞ
v”bo£
 != 0 )

1031 
	`´štf
( "failed\n" );

1037 ifĞ
v”bo£
 != 0 )

1038 
	`´štf
( "passed\n" );

1041 ifĞ
v”bo£
 != 0 )

1042 
	`´štf
( "\n" );

1047  
i
 = 0; i < 6; i++ )

1049 
u
 = 
i
 >> 1;

1050 
v
 = 
i
 & 1;

1052 ifĞ
v”bo£
 != 0 )

1053 
	`´štf
Ğ" AES-CBC-%3d (%s): ", 128 + 
u
 * 64,

1054 Ğ
v
 =ğ
AES_DECRYPT
 ) ? "dec" : "enc" );

1056 
	`mem£t
Ğ
iv
 , 0, 16 );

1057 
	`mem£t
Ğ
´v
, 0, 16 );

1058 
	`mem£t
Ğ
buf
, 0, 16 );

1060 ifĞ
v
 =ğ
AES_DECRYPT
 )

1062 
	`«s_£tkey_dec
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1064  
j
 = 0; j < 10000; j++ )

1065 
	`«s_üy±_cbc
Ğ&
ùx
, 
v
, 16, 
iv
, 
buf
, buf );

1067 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_cbc_dec
[
u
], 16 ) != 0 )

1069 ifĞ
v”bo£
 != 0 )

1070 
	`´štf
( "failed\n" );

1077 
	`«s_£tkey_’c
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1079  
j
 = 0; j < 10000; j++ )

1081 
tmp
[16];

1083 
	`«s_üy±_cbc
Ğ&
ùx
, 
v
, 16, 
iv
, 
buf
, buf );

1085 
	`memıy
Ğ
tmp
, 
´v
, 16 );

1086 
	`memıy
Ğ
´v
, 
buf
, 16 );

1087 
	`memıy
Ğ
buf
, 
tmp
, 16 );

1090 ifĞ
	`memcmp
Ğ
´v
, 
«s_‹¡_cbc_’c
[
u
], 16 ) != 0 )

1092 ifĞ
v”bo£
 != 0 )

1093 
	`´štf
( "failed\n" );

1099 ifĞ
v”bo£
 != 0 )

1100 
	`´štf
( "passed\n" );

1103 ifĞ
v”bo£
 != 0 )

1104 
	`´štf
( "\n" );

1109  
i
 = 0; i < 6; i++ )

1111 
u
 = 
i
 >> 1;

1112 
v
 = 
i
 & 1;

1114 ifĞ
v”bo£
 != 0 )

1115 
	`´štf
Ğ" AES-CFB128-%3d (%s): ", 128 + 
u
 * 64,

1116 Ğ
v
 =ğ
AES_DECRYPT
 ) ? "dec" : "enc" );

1118 
	`memıy
Ğ
iv
, 
«s_‹¡_cfb128_iv
, 16 );

1119 
	`memıy
Ğ
key
, 
«s_‹¡_cfb128_key
[
u
], 16 + u * 8 );

1121 
off£t
 = 0;

1122 
	`«s_£tkey_’c
Ğ&
ùx
, 
key
, 128 + 
u
 * 64 );

1124 ifĞ
v
 =ğ
AES_DECRYPT
 )

1126 
	`memıy
Ğ
buf
, 
«s_‹¡_cfb128_ù
[
u
], 64 );

1127 
	`«s_üy±_cfb128
Ğ&
ùx
, 
v
, 64, &
off£t
, 
iv
, 
buf
, buf );

1129 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_cfb128_±
, 64 ) != 0 )

1131 ifĞ
v”bo£
 != 0 )

1132 
	`´štf
( "failed\n" );

1139 
	`memıy
Ğ
buf
, 
«s_‹¡_cfb128_±
, 64 );

1140 
	`«s_üy±_cfb128
Ğ&
ùx
, 
v
, 64, &
off£t
, 
iv
, 
buf
, buf );

1142 ifĞ
	`memcmp
Ğ
buf
, 
«s_‹¡_cfb128_ù
[
u
], 64 ) != 0 )

1144 ifĞ
v”bo£
 != 0 )

1145 
	`´štf
( "failed\n" );

1151 ifĞ
v”bo£
 != 0 )

1152 
	`´štf
( "passed\n" );

1156 ifĞ
v”bo£
 != 0 )

1157 
	`´štf
( "\n" );

1160 
	}
}

	@tools/src/polarssl/aes.h

25 #iâdeà
POLARSSL_AES_H


26 
	#POLARSSL_AES_H


	)

28 
	#AES_ENCRYPT
 1

	)

29 
	#AES_DECRYPT
 0

	)

31 
	#POLARSSL_ERR_AES_INVALID_KEY_LENGTH
 -0x0800

	)

32 
	#POLARSSL_ERR_AES_INVALID_INPUT_LENGTH
 -0x0810

	)

39 
	mÄ
;

40 *
	mrk
;

41 
	mbuf
[68];

43 
	t«s_cÚ‹xt
;

45 #ifdeà
__ılu¥lus


58 
«s_£tkey_’c
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

69 
«s_£tkey_dec
Ğ
«s_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

81 
«s_üy±_ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

82 
mode
,

83 cÚ¡ 
šput
[16],

84 
ouut
[16] );

100 
«s_üy±_cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

101 
mode
,

102 
Ëngth
,

103 
iv
[16],

104 cÚ¡ *
šput
,

105 *
ouut
 );

120 
«s_üy±_cfb128
Ğ
«s_cÚ‹xt
 *
ùx
,

121 
mode
,

122 
Ëngth
,

123 *
iv_off
,

124 
iv
[16],

125 cÚ¡ *
šput
,

126 *
ouut
 );

133 
«s_£lf_‹¡
Ğ
v”bo£
 );

135 #ifdeà
__ılu¥lus


	@tools/src/polarssl/arc4.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_ARC4_C
)

35 
	~"pŞ¬s¦/¬c4.h
"

40 
	$¬c4_£tup
Ğ
¬c4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

42 
i
, 
j
, 
k
, 
a
;

43 *
m
;

45 
ùx
->
x
 = 0;

46 
ùx
->
y
 = 0;

47 
m
 = 
ùx
->m;

49  
i
 = 0; i < 256; i++ )

50 
m
[
i
] = () i;

52 
j
 = 
k
 = 0;

54  
i
 = 0; i < 256; i++, 
k
++ )

56 ifĞ
k
 >ğ
keyËn
 ) k = 0;

58 
a
 = 
m
[
i
];

59 
j
 = ( j + 
a
 + 
key
[
k
] ) & 0xFF;

60 
m
[
i
] = m[
j
];

61 
m
[
j
] = (è
a
;

63 
	}
}

68 
	$¬c4_üy±
Ğ
¬c4_cÚ‹xt
 *
ùx
, 
Ëngth
, cÚ¡ *
šput
,

69 *
ouut
 )

71 
i
, 
x
, 
y
, 
a
, 
b
;

72 *
m
;

74 
x
 = 
ùx
->x;

75 
y
 = 
ùx
->y;

76 
m
 = 
ùx
->m;

78  
i
 = 0; i < 
Ëngth
; i++ )

80 
x
 = ( x + 1 ) & 0xFF; 
a
 = 
m
[x];

81 
y
 = ( y + 
a
 ) & 0xFF; 
b
 = 
m
[y];

83 
m
[
x
] = (è
b
;

84 
m
[
y
] = (è
a
;

86 
ouut
[
i
] = ()

87 Ğ
šput
[
i
] ^ 
m
[()Ğ
a
 + 
b
 )] );

90 
ùx
->
x
 = x;

91 
ùx
->
y
 = y;

94 
	}
}

96 #ià
defšed
(
POLARSSL_SELF_TEST
)

98 
	~<¡ršg.h
>

99 
	~<¡dio.h
>

106 cÚ¡ 
	g¬c4_‹¡_key
[3][8] =

113 cÚ¡ 
	g¬c4_‹¡_±
[3][8] =

120 cÚ¡ 
	g¬c4_‹¡_ù
[3][8] =

130 
	$¬c4_£lf_‹¡
Ğ
v”bo£
 )

132 
i
;

133 
ibuf
[8];

134 
obuf
[8];

135 
¬c4_cÚ‹xt
 
ùx
;

137  
i
 = 0; i < 3; i++ )

139 ifĞ
v”bo£
 != 0 )

140 
	`´štf
Ğ" ARC4e¡ #%d: ", 
i
 + 1 );

142 
	`memıy
Ğ
ibuf
, 
¬c4_‹¡_±
[
i
], 8 );

144 
	`¬c4_£tup
Ğ&
ùx
, (*è
¬c4_‹¡_key
[
i
], 8 );

145 
	`¬c4_üy±
Ğ&
ùx
, 8, 
ibuf
, 
obuf
 );

147 ifĞ
	`memcmp
Ğ
obuf
, 
¬c4_‹¡_ù
[
i
], 8 ) != 0 )

149 ifĞ
v”bo£
 != 0 )

150 
	`´štf
( "failed\n" );

155 ifĞ
v”bo£
 != 0 )

156 
	`´štf
( "passed\n" );

159 ifĞ
v”bo£
 != 0 )

160 
	`´štf
( "\n" );

163 
	}
}

	@tools/src/polarssl/arc4.h

25 #iâdeà
POLARSSL_ARC4_H


26 
	#POLARSSL_ARC4_H


	)

33 
	mx
;

34 
	my
;

35 
	mm
[256];

37 
	t¬c4_cÚ‹xt
;

39 #ifdeà
__ılu¥lus


50 
¬c4_£tup
Ğ
¬c4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

62 
¬c4_üy±
Ğ
¬c4_cÚ‹xt
 *
ùx
, 
Ëngth
, cÚ¡ *
šput
,

63 *
ouut
 );

70 
¬c4_£lf_‹¡
Ğ
v”bo£
 );

72 #ifdeà
__ılu¥lus


	@tools/src/polarssl/base64.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_BASE64_C
)

30 
	~"pŞ¬s¦/ba£64.h
"

32 cÚ¡ 
	gba£64_’c_m­
[64] =

43 cÚ¡ 
	gba£64_dec_m­
[128] =

63 
	$ba£64_’code
Ğ*
d¡
, *
dËn
,

64 cÚ¡ *
¤c
, 
¦’
 )

66 
i
, 
n
;

67 
C1
, 
C2
, 
C3
;

68 *
p
;

70 ifĞ
¦’
 == 0 )

73 
n
 = (
¦’
 << 3) / 6;

75  (
¦’
 << 3è- (
n
 * 6) )

77 2: 
n
 += 3; ;

78 4: 
n
 += 2; ;

82 ifĞ*
dËn
 < 
n
 + 1 )

84 *
dËn
 = 
n
 + 1;

85 Ğ
POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL
 );

88 
n
 = (
¦’
 / 3) * 3;

90  
i
 = 0, 
p
 = 
d¡
; i < 
n
; i += 3 )

92 
C1
 = *
¤c
++;

93 
C2
 = *
¤c
++;

94 
C3
 = *
¤c
++;

96 *
p
++ = 
ba£64_’c_m­
[(
C1
 >> 2) & 0x3F];

97 *
p
++ = 
ba£64_’c_m­
[(((
C1
 & 3è<< 4è+ (
C2
 >> 4)) & 0x3F];

98 *
p
++ = 
ba£64_’c_m­
[(((
C2
 & 15è<< 2è+ (
C3
 >> 6)) & 0x3F];

99 *
p
++ = 
ba£64_’c_m­
[
C3
 & 0x3F];

102 ifĞ
i
 < 
¦’
 )

104 
C1
 = *
¤c
++;

105 
C2
 = ((
i
 + 1è< 
¦’
è? *
¤c
++ : 0;

107 *
p
++ = 
ba£64_’c_m­
[(
C1
 >> 2) & 0x3F];

108 *
p
++ = 
ba£64_’c_m­
[(((
C1
 & 3è<< 4è+ (
C2
 >> 4)) & 0x3F];

110 ifĞ(
i
 + 1è< 
¦’
 )

111 *
p
++ = 
ba£64_’c_m­
[((
C2
 & 15) << 2) & 0x3F];

112 *
p
++ = '=';

114 *
p
++ = '=';

117 *
dËn
 = 
p
 - 
d¡
;

118 *
p
 = 0;

121 
	}
}

126 
	$ba£64_decode
Ğ*
d¡
, *
dËn
,

127 cÚ¡ *
¤c
, 
¦’
 )

129 
i
, 
j
, 
n
;

130 
x
;

131 *
p
;

133  
i
 = 
j
 = 
n
 = 0; i < 
¦’
; i++ )

135 ifĞĞ
¦’
 - 
i
 ) >= 2 &&

136 
¤c
[
i
] == '\r' && src[i + 1] == '\n' )

139 ifĞ
¤c
[
i
] == '\n' )

142 ifĞ
¤c
[
i
] =ğ'=' && ++
j
 > 2 )

143 Ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 );

145 ifĞ
¤c
[
i
] > 127 || 
ba£64_dec_m­
[src[i]] == 127 )

146 Ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 );

148 ifĞ
ba£64_dec_m­
[
¤c
[
i
]] < 64 && 
j
 != 0 )

149 Ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 );

151 
n
++;

154 ifĞ
n
 == 0 )

157 
n
 = ((n * 6) + 7) >> 3;

159 ifĞ*
dËn
 < 
n
 )

161 *
dËn
 = 
n
;

162 Ğ
POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL
 );

165  
j
 = 3, 
n
 = 
x
 = 0, 
p
 = 
d¡
; 
i
 > 0; i--, 
¤c
++ )

167 ifĞ*
¤c
 == '\r' || *src == '\n' )

170 
j
 -ğĞ
ba£64_dec_m­
[*
¤c
] == 64 );

171 
x
 = (x << 6è| ( 
ba£64_dec_m­
[*
¤c
] & 0x3F );

173 ifĞ++
n
 == 4 )

175 
n
 = 0;

176 ifĞ
j
 > 0 ) *
p
++ = ()Ğ
x
 >> 16 );

177 ifĞ
j
 > 1 ) *
p
++ = ()Ğ
x
 >> 8 );

178 ifĞ
j
 > 2 ) *
p
++ = ()Ğ
x
 );

182 *
dËn
 = 
p
 - 
d¡
;

185 
	}
}

187 #ià
defšed
(
POLARSSL_SELF_TEST
)

189 
	~<¡ršg.h
>

190 
	~<¡dio.h
>

192 cÚ¡ 
	gba£64_‹¡_dec
[64] =

204 cÚ¡ 
	gba£64_‹¡_’c
[] =

211 
	$ba£64_£lf_‹¡
Ğ
v”bo£
 )

213 
Ën
;

214 *
¤c
, 
bufãr
[128];

216 ifĞ
v”bo£
 != 0 )

217 
	`´štf
( " Base64ƒncodingest: " );

219 
Ën
 = Ğ
bufãr
 );

220 
¤c
 = (*è
ba£64_‹¡_dec
;

222 ifĞ
	`ba£64_’code
Ğ
bufãr
, &
Ën
, 
¤c
, 64 ) != 0 ||

223 
	`memcmp
Ğ
ba£64_‹¡_’c
, 
bufãr
, 88 ) != 0 )

225 ifĞ
v”bo£
 != 0 )

226 
	`´štf
( "failed\n" );

231 ifĞ
v”bo£
 != 0 )

232 
	`´štf
( "passed\n Base64 decodingest: " );

234 
Ën
 = Ğ
bufãr
 );

235 
¤c
 = (*è
ba£64_‹¡_’c
;

237 ifĞ
	`ba£64_decode
Ğ
bufãr
, &
Ën
, 
¤c
, 88 ) != 0 ||

238 
	`memcmp
Ğ
ba£64_‹¡_dec
, 
bufãr
, 64 ) != 0 )

240 ifĞ
v”bo£
 != 0 )

241 
	`´štf
( "failed\n" );

246 ifĞ
v”bo£
 != 0 )

247 
	`´štf
( "passed\n\n" );

250 
	}
}

	@tools/src/polarssl/base64.h

25 #iâdeà
POLARSSL_BASE64_H


26 
	#POLARSSL_BASE64_H


	)

28 
	#POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL
 0x0010

	)

29 
	#POLARSSL_ERR_BASE64_INVALID_CHARACTER
 0x0012

	)

31 #ifdeà
__ılu¥lus


50 
ba£64_’code
Ğ*
d¡
, *
dËn
,

51 cÚ¡ *
¤c
, 
¦’
 );

69 
ba£64_decode
Ğ*
d¡
, *
dËn
,

70 cÚ¡ *
¤c
, 
¦’
 );

77 
ba£64_£lf_‹¡
Ğ
v”bo£
 );

79 #ifdeà
__ılu¥lus


	@tools/src/polarssl/bignum.c

33 
	~"pŞ¬s¦/cÚfig.h
"

35 #ià
defšed
(
POLARSSL_BIGNUM_C
)

37 
	~"pŞ¬s¦/bignum.h
"

38 
	~"pŞ¬s¦/bn_mul.h
"

40 
	~<¡ršg.h
>

41 
	~<¡dlib.h
>

42 
	~<¡d¬g.h
>

44 
	#ciL
 ((è(
t_št
)è

	)

45 
	#biL
 (
ciL
 << 3è

	)

46 
	#biH
 (
ciL
 << 2è

	)

51 
	#BITS_TO_LIMBS
(
i
è(((iè+ 
biL
 - 1è/ biL)

	)

52 
	#CHARS_TO_LIMBS
(
i
è(((iè+ 
ciL
 - 1è/ ciL)

	)

57 
	$mpi_š™
Ğ
mpi
 *
X
, ... )

59 
va_li¡
 
¬gs
;

61 
	`va_¡¬t
Ğ
¬gs
, 
X
 );

63  
X
 !ğ
NULL
 )

65 
X
->
s
 = 1;

66 
X
->
n
 = 0;

67 
X
->
p
 = 
NULL
;

69 
X
 = 
	`va_¬g
Ğ
¬gs
, 
mpi
* );

72 
	`va_’d
Ğ
¬gs
 );

73 
	}
}

78 
	$mpi_ä“
Ğ
mpi
 *
X
, ... )

80 
va_li¡
 
¬gs
;

82 
	`va_¡¬t
Ğ
¬gs
, 
X
 );

84  
X
 !ğ
NULL
 )

86 ifĞ
X
->
p
 !ğ
NULL
 )

88 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

89 
	`ä“
Ğ
X
->
p
 );

92 
X
->
s
 = 1;

93 
X
->
n
 = 0;

94 
X
->
p
 = 
NULL
;

96 
X
 = 
	`va_¬g
Ğ
¬gs
, 
mpi
* );

99 
	`va_’d
Ğ
¬gs
 );

100 
	}
}

105 
	$mpi_grow
Ğ
mpi
 *
X
, 
nblimbs
 )

107 
t_št
 *
p
;

109 ifĞ
X
->
n
 < 
nblimbs
 )

111 ifĞĞ
p
 = (
t_št
 *è
	`m®loc
Ğ
nblimbs
 * 
ciL
 ) ) =ğ
NULL
 )

114 
	`mem£t
Ğ
p
, 0, 
nblimbs
 * 
ciL
 );

116 ifĞ
X
->
p
 !ğ
NULL
 )

118 
	`memıy
Ğ
p
, 
X
->p, X->
n
 * 
ciL
 );

119 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

120 
	`ä“
Ğ
X
->
p
 );

123 
X
->
n
 = 
nblimbs
;

124 
X
->
p
 =…;

128 
	}
}

133 
	$mpi_cİy
Ğ
mpi
 *
X
, cÚ¡ mp˜*
Y
 )

135 
»t
, 
i
;

137 ifĞ
X
 =ğ
Y
 )

140  
i
 = 
Y
->
n
 - 1; i > 0; i-- )

141 ifĞ
Y
->
p
[
i
] != 0 )

143 
i
++;

145 
X
->
s
 = 
Y
->s;

147 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
i
 ) );

149 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

150 
	`memıy
Ğ
X
->
p
, 
Y
->p, 
i
 * 
ciL
 );

152 
ş—nup
:

154 Ğ
»t
 );

155 
	}
}

160 
	$mpi_sw­
Ğ
mpi
 *
X
, mp˜*
Y
 )

162 
mpi
 
T
;

164 
	`memıy
Ğ&
T
, 
X
, Ğ
mpi
 ) );

165 
	`memıy
Ğ
X
, 
Y
, Ğ
mpi
 ) );

166 
	`memıy
Ğ
Y
, &
T
, Ğ
mpi
 ) );

167 
	}
}

172 
	$mpi_l£t
Ğ
mpi
 *
X
, 
z
 )

174 
»t
;

176 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 1 ) );

177 
	`mem£t
Ğ
X
->
p
, 0, X->
n
 * 
ciL
 );

179 
X
->
p
[0] = ( 
z
 < 0 ) ? -z : z;

180 
X
->
s
 = ( 
z
 < 0 ) ? -1 : 1;

182 
ş—nup
:

184 Ğ
»t
 );

185 
	}
}

190 
	$mpi_lsb
ĞcÚ¡ 
mpi
 *
X
 )

192 
i
, 
j
, 
couÁ
 = 0;

194  
i
 = 0; i < 
X
->
n
; i++ )

195  
j
 = 0; j < (è
biL
; j++, 
couÁ
++ )

196 ifĞĞĞ
X
->
p
[
i
] >> 
j
 ) & 1 ) != 0 )

197 Ğ
couÁ
 );

200 
	}
}

205 
	$mpi_msb
ĞcÚ¡ 
mpi
 *
X
 )

207 
i
, 
j
;

209  
i
 = 
X
->
n
 - 1; i > 0; i-- )

210 ifĞ
X
->
p
[
i
] != 0 )

213  
j
 = 
biL
 - 1; j >= 0; j-- )

214 ifĞĞĞ
X
->
p
[
i
] >> 
j
 ) & 1 ) != 0 )

217 ĞĞ
i
 * 
biL
 ) + 
j
 + 1 );

218 
	}
}

223 
	$mpi_size
ĞcÚ¡ 
mpi
 *
X
 )

225 ĞĞ
	`mpi_msb
Ğ
X
 ) + 7 ) >> 3 );

226 
	}
}

231 
	$mpi_g‘_dig™
Ğ
t_št
 *
d
, 
¿dix
, 
c
 )

233 *
d
 = 255;

235 ifĞ
c
 >ğ0x30 && c <ğ0x39 ) *
d
 = c - 0x30;

236 ifĞ
c
 >ğ0x41 && c <ğ0x46 ) *
d
 = c - 0x37;

237 ifĞ
c
 >ğ0x61 && c <ğ0x66 ) *
d
 = c - 0x57;

239 ifĞ*
d
 >ğ(
t_št
è
¿dix
 )

240 Ğ
POLARSSL_ERR_MPI_INVALID_CHARACTER
 );

243 
	}
}

248 
	$mpi_»ad_¡ršg
Ğ
mpi
 *
X
, 
¿dix
, cÚ¡ *
s
 )

250 
»t
, 
i
, 
j
, 
n
, 
¦’
;

251 
t_št
 
d
;

252 
mpi
 
T
;

254 ifĞ
¿dix
 < 2 ||„adix > 16 )

255 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

257 
	`mpi_š™
Ğ&
T
, 
NULL
 );

259 
¦’
 = 
	`¡¾’
Ğ
s
 );

261 ifĞ
¿dix
 == 16 )

263 
n
 = 
	`BITS_TO_LIMBS
Ğ
¦’
 << 2 );

265 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
n
 ) );

266 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

268  
i
 = 
¦’
 - 1, 
j
 = 0; i >= 0; i--, j++ )

270 ifĞ
i
 =ğ0 && 
s
[i] == '-' )

272 
X
->
s
 = -1;

276 
	`MPI_CHK
Ğ
	`mpi_g‘_dig™
Ğ&
d
, 
¿dix
, 
s
[
i
] ) );

277 
X
->
p
[
j
 / (2 * 
ciL
)] |ğ
d
 << ( (j % (2 * ciL)) << 2 );

282 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

284  
i
 = 0; i < 
¦’
; i++ )

286 ifĞ
i
 =ğ0 && 
s
[i] == '-' )

288 
X
->
s
 = -1;

292 
	`MPI_CHK
Ğ
	`mpi_g‘_dig™
Ğ&
d
, 
¿dix
, 
s
[
i
] ) );

293 
	`MPI_CHK
Ğ
	`mpi_mul_št
Ğ&
T
, 
X
, 
¿dix
 ) );

295 ifĞ
X
->
s
 == 1 )

297 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ
X
, &
T
, 
d
 ) );

301 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ
X
, &
T
, 
d
 ) );

306 
ş—nup
:

308 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

310 Ğ
»t
 );

311 
	}
}

316 
	$mpi_wr™e_hÍ
Ğ
mpi
 *
X
, 
¿dix
, **
p
 )

318 
»t
;

319 
t_št
 
r
;

321 ifĞ
¿dix
 < 2 ||„adix > 16 )

322 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

324 
	`MPI_CHK
Ğ
	`mpi_mod_št
Ğ&
r
, 
X
, 
¿dix
 ) );

325 
	`MPI_CHK
Ğ
	`mpi_div_št
Ğ
X
, 
NULL
, X, 
¿dix
 ) );

327 ifĞ
	`mpi_cmp_št
Ğ
X
, 0 ) != 0 )

328 
	`MPI_CHK
Ğ
	`mpi_wr™e_hÍ
Ğ
X
, 
¿dix
, 
p
 ) );

330 ifĞ
r
 < 10 )

331 *(*
p
)++ = ()Ğ
r
 + 0x30 );

333 *(*
p
)++ = ()Ğ
r
 + 0x37 );

335 
ş—nup
:

337 Ğ
»t
 );

338 
	}
}

343 
	$mpi_wr™e_¡ršg
ĞcÚ¡ 
mpi
 *
X
, 
¿dix
, *
s
, *
¦’
 )

345 
»t
 = 0, 
n
;

346 *
p
;

347 
mpi
 
T
;

349 ifĞ
¿dix
 < 2 ||„adix > 16 )

350 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

352 
n
 = 
	`mpi_msb
Ğ
X
 );

353 ifĞ
¿dix
 >ğ4 ) 
n
 >>= 1;

354 ifĞ
¿dix
 >ğ16 ) 
n
 >>= 1;

355 
n
 += 3;

357 ifĞ*
¦’
 < 
n
 )

359 *
¦’
 = 
n
;

360 Ğ
POLARSSL_ERR_MPI_BUFFER_TOO_SMALL
 );

363 
p
 = 
s
;

364 
	`mpi_š™
Ğ&
T
, 
NULL
 );

366 ifĞ
X
->
s
 == -1 )

367 *
p
++ = '-';

369 ifĞ
¿dix
 == 16 )

371 
c
, 
i
, 
j
, 
k
;

373  
i
 = 
X
->
n
 - 1, 
k
 = 0; i >= 0; i-- )

375  
j
 = 
ciL
 - 1; j >= 0; j-- )

377 
c
 = ( 
X
->
p
[
i
] >> (
j
 << 3) ) & 0xFF;

379 ifĞ
c
 =ğ0 && 
k
 =ğ0 && (
i
 + 
j
) != 0 )

382 
p
 +ğ
	`¥rštf
Ğp, "%02X", 
c
 );

383 
k
 = 1;

389 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
T
, 
X
 ) );

391 ifĞ
T
.
s
 == -1 )

392 
T
.
s
 = 1;

394 
	`MPI_CHK
Ğ
	`mpi_wr™e_hÍ
Ğ&
T
, 
¿dix
, &
p
 ) );

397 *
p
++ = '\0';

398 *
¦’
 = 
p
 - 
s
;

400 
ş—nup
:

402 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

404 Ğ
»t
 );

405 
	}
}

410 
	$mpi_»ad_fe
Ğ
mpi
 *
X
, 
¿dix
, 
FILE
 *
fš
 )

412 
t_št
 
d
;

413 
¦’
;

414 *
p
;

415 
s
[1024];

417 
	`mem£t
Ğ
s
, 0, ( s ) );

418 ifĞ
	`fg‘s
Ğ
s
, Ğ è- 1, 
fš
 ) =ğ
NULL
 )

419 Ğ
POLARSSL_ERR_MPI_FILE_IO_ERROR
 );

421 
¦’
 = 
	`¡¾’
Ğ
s
 );

422 ifĞ
s
[
¦’
 - 1] == '\n' ) { slen--; s[slen] = '\0'; }

423 ifĞ
s
[
¦’
 - 1] == '\r' ) { slen--; s[slen] = '\0'; }

425 
p
 = 
s
 + 
¦’
;

426  --
p
 >ğ
s
 )

427 ifĞ
	`mpi_g‘_dig™
Ğ&
d
, 
¿dix
, *
p
 ) != 0 )

430 Ğ
	`mpi_»ad_¡ršg
Ğ
X
, 
¿dix
, 
p
 + 1 ) );

431 
	}
}

436 
	$mpi_wr™e_fe
ĞcÚ¡ *
p
, cÚ¡ 
mpi
 *
X
, 
¿dix
, 
FILE
 *
fout
 )

438 
n
, 
»t
;

439 
size_t
 
¦’
;

440 
size_t
 
¶’
;

441 
s
[2048];

443 
n
 = Ğ
s
 );

444 
	`mem£t
Ğ
s
, 0, 
n
 );

445 
n
 -= 2;

447 
	`MPI_CHK
Ğ
	`mpi_wr™e_¡ršg
Ğ
X
, 
¿dix
, 
s
, (*è&
n
 ) );

449 ifĞ
p
 =ğ
NULL
 )… = "";

451 
¶’
 = 
	`¡¾’
Ğ
p
 );

452 
¦’
 = 
	`¡¾’
Ğ
s
 );

453 
s
[
¦’
++] = '\r';

454 
s
[
¦’
++] = '\n';

456 ifĞ
fout
 !ğ
NULL
 )

458 ifĞ
	`fwr™e
Ğ
p
, 1, 
¶’
, 
fout
 ) !=…len ||

459 
	`fwr™e
Ğ
s
, 1, 
¦’
, 
fout
 ) != slen )

460 Ğ
POLARSSL_ERR_MPI_FILE_IO_ERROR
 );

463 
	`´štf
Ğ"%s%s", 
p
, 
s
 );

465 
ş—nup
:

467 Ğ
»t
 );

468 
	}
}

473 
	$mpi_»ad_bš¬y
Ğ
mpi
 *
X
, cÚ¡ *
buf
, 
buæ’
 )

475 
»t
, 
i
, 
j
, 
n
;

477  
n
 = 0;‚ < 
buæ’
;‚++ )

478 ifĞ
buf
[
n
] != 0 )

481 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
	`CHARS_TO_LIMBS
Ğ
buæ’
 - 
n
 ) ) );

482 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

484  
i
 = 
buæ’
 - 1, 
j
 = 0; i >ğ
n
; i--, j++ )

485 
X
->
p
[
j
 / 
ciL
] |ğ((
t_št
è
buf
[
i
]) << ((j % ciL) << 3);

487 
ş—nup
:

489 Ğ
»t
 );

490 
	}
}

495 
	$mpi_wr™e_bš¬y
ĞcÚ¡ 
mpi
 *
X
, *
buf
, 
buæ’
 )

497 
i
, 
j
, 
n
;

499 
n
 = 
	`mpi_size
Ğ
X
 );

501 ifĞ
buæ’
 < 
n
 )

502 Ğ
POLARSSL_ERR_MPI_BUFFER_TOO_SMALL
 );

504 
	`mem£t
Ğ
buf
, 0, 
buæ’
 );

506  
i
 = 
buæ’
 - 1, 
j
 = 0; 
n
 > 0; i--, j++,‚-- )

507 
buf
[
i
] = ()Ğ
X
->
p
[
j
 / 
ciL
] >> ((j % ciL) << 3) );

510 
	}
}

515 
	$mpi_shiá_l
Ğ
mpi
 *
X
, 
couÁ
 )

517 
»t
, 
i
, 
v0
, 
t1
;

518 
t_št
 
r0
 = 0, 
r1
;

520 
v0
 = 
couÁ
 / (
biL
 );

521 
t1
 = 
couÁ
 & (
biL
 - 1);

523 
i
 = 
	`mpi_msb
Ğ
X
 ) + 
couÁ
;

525 ifĞ
X
->
n
 * (è
biL
 < 
i
 )

526 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
	`BITS_TO_LIMBS
Ğ
i
 ) ) );

528 
»t
 = 0;

533 ifĞ
v0
 > 0 )

535  
i
 = 
X
->
n
 - 1; i >ğ
v0
; i-- )

536 
X
->
p
[
i
] = X->p[˜- 
v0
];

538  ; 
i
 >= 0; i-- )

539 
X
->
p
[
i
] = 0;

545 ifĞ
t1
 > 0 )

547  
i
 = 
v0
; i < 
X
->
n
; i++ )

549 
r1
 = 
X
->
p
[
i
] >> (
biL
 - 
t1
);

550 
X
->
p
[
i
] <<ğ
t1
;

551 
X
->
p
[
i
] |ğ
r0
;

552 
r0
 = 
r1
;

556 
ş—nup
:

558 Ğ
»t
 );

559 
	}
}

564 
	$mpi_shiá_r
Ğ
mpi
 *
X
, 
couÁ
 )

566 
i
, 
v0
, 
v1
;

567 
t_št
 
r0
 = 0, 
r1
;

569 
v0
 = 
couÁ
 / 
biL
;

570 
v1
 = 
couÁ
 & (
biL
 - 1);

575 ifĞ
v0
 > 0 )

577  
i
 = 0; i < 
X
->
n
 - 
v0
; i++ )

578 
X
->
p
[
i
] = X->p[˜+ 
v0
];

580  ; 
i
 < 
X
->
n
; i++ )

581 
X
->
p
[
i
] = 0;

587 ifĞ
v1
 > 0 )

589  
i
 = 
X
->
n
 - 1; i >= 0; i-- )

591 
r1
 = 
X
->
p
[
i
] << (
biL
 - 
v1
);

592 
X
->
p
[
i
] >>ğ
v1
;

593 
X
->
p
[
i
] |ğ
r0
;

594 
r0
 = 
r1
;

599 
	}
}

604 
	$mpi_cmp_abs
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 )

606 
i
, 
j
;

608  
i
 = 
X
->
n
 - 1; i >= 0; i-- )

609 ifĞ
X
->
p
[
i
] != 0 )

612  
j
 = 
Y
->
n
 - 1; j >= 0; j-- )

613 ifĞ
Y
->
p
[
j
] != 0 )

616 ifĞ
i
 < 0 && 
j
 < 0 )

619 ifĞ
i
 > 
j
 ) ( 1 );

620 ifĞ
j
 > 
i
 ) ( -1 );

622  ; 
i
 >= 0; i-- )

624 ifĞ
X
->
p
[
i
] > 
Y
->p[i] ) ( 1 );

625 ifĞ
X
->
p
[
i
] < 
Y
->p[i] ) ( -1 );

629 
	}
}

634 
	$mpi_cmp_mpi
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 )

636 
i
, 
j
;

638  
i
 = 
X
->
n
 - 1; i >= 0; i-- )

639 ifĞ
X
->
p
[
i
] != 0 )

642  
j
 = 
Y
->
n
 - 1; j >= 0; j-- )

643 ifĞ
Y
->
p
[
j
] != 0 )

646 ifĞ
i
 < 0 && 
j
 < 0 )

649 ifĞ
i
 > 
j
 ) Ğ
X
->
s
 );

650 ifĞ
j
 > 
i
 ) Ğ-
X
->
s
 );

652 ifĞ
X
->
s
 > 0 && 
Y
->s < 0 ) ( 1 );

653 ifĞ
Y
->
s
 > 0 && 
X
->s < 0 ) ( -1 );

655  ; 
i
 >= 0; i-- )

657 ifĞ
X
->
p
[
i
] > 
Y
->p[i] ) ĞX->
s
 );

658 ifĞ
X
->
p
[
i
] < 
Y
->p[i] ) Ğ-X->
s
 );

662 
	}
}

667 
	$mpi_cmp_št
ĞcÚ¡ 
mpi
 *
X
, 
z
 )

669 
mpi
 
Y
;

670 
t_št
 
p
[1];

672 *
p
 = ( 
z
 < 0 ) ? -z : z;

673 
Y
.
s
 = ( 
z
 < 0 ) ? -1 : 1;

674 
Y
.
n
 = 1;

675 
Y
.
p
 =…;

677 Ğ
	`mpi_cmp_mpi
Ğ
X
, &
Y
 ) );

678 
	}
}

683 
	$mpi_add_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

685 
»t
, 
i
, 
j
;

686 
t_št
 *
o
, *
p
, 
c
;

688 ifĞ
X
 =ğ
B
 )

690 cÚ¡ 
mpi
 *
T
 = 
A
; A = 
X
; 
B
 = T;

693 ifĞ
X
 !ğ
A
 )

694 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, 
A
 ) );

699 
X
->
s
 = 1;

701  
j
 = 
B
->
n
 - 1; j >= 0; j-- )

702 ifĞ
B
->
p
[
j
] != 0 )

705 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
j
 + 1 ) );

707 
o
 = 
B
->
p
;… = 
X
->p; 
c
 = 0;

709  
i
 = 0; i <ğ
j
; i++, 
o
++, 
p
++ )

711 *
p
 +ğ
c
; c = ( *p < c );

712 *
p
 +ğ*
o
; 
c
 += ( *p < *o );

715  
c
 != 0 )

717 ifĞ
i
 >ğ
X
->
n
 )

719 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
i
 + 1 ) );

720 
p
 = 
X
->°+ 
i
;

723 *
p
 +ğ
c
; c = ( *°< c ); 
i
++;

726 
ş—nup
:

728 Ğ
»t
 );

729 
	}
}

734 
	$mpi_sub_hÍ
Ğ
n
, 
t_št
 *
s
,_šˆ*
d
 )

736 
i
;

737 
t_št
 
c
, 
z
;

739  
i
 = 
c
 = 0; i < 
n
; i++, 
s
++, 
d
++ )

741 
z
 = ( *
d
 < 
c
 ); *d -= c;

742 
c
 = ( *
d
 < *
s
 ) + 
z
; *d -= *s;

745  
c
 != 0 )

747 
z
 = ( *
d
 < 
c
 ); *d -= c;

748 
c
 = 
z
; 
i
++; 
d
++;

750 
	}
}

755 
	$mpi_sub_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

757 
mpi
 
TB
;

758 
»t
, 
n
;

760 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) < 0 )

761 Ğ
POLARSSL_ERR_MPI_NEGATIVE_VALUE
 );

763 
	`mpi_š™
Ğ&
TB
, 
NULL
 );

765 ifĞ
X
 =ğ
B
 )

767 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, 
B
 ) );

768 
B
 = &
TB
;

771 ifĞ
X
 !ğ
A
 )

772 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, 
A
 ) );

777 
X
->
s
 = 1;

779 
»t
 = 0;

781  
n
 = 
B
->n - 1;‚ >= 0;‚-- )

782 ifĞ
B
->
p
[
n
] != 0 )

785 
	`mpi_sub_hÍ
Ğ
n
 + 1, 
B
->
p
, 
X
->p );

787 
ş—nup
:

789 
	`mpi_ä“
Ğ&
TB
, 
NULL
 );

791 Ğ
»t
 );

792 
	}
}

797 
	$mpi_add_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

799 
»t
, 
s
 = 
A
->s;

801 ifĞ
A
->
s
 * 
B
->s < 0 )

803 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) >= 0 )

805 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
A
, 
B
 ) );

806 
X
->
s
 = s;

810 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
B
, 
A
 ) );

811 
X
->
s
 = -s;

816 
	`MPI_CHK
Ğ
	`mpi_add_abs
Ğ
X
, 
A
, 
B
 ) );

817 
X
->
s
 = s;

820 
ş—nup
:

822 Ğ
»t
 );

823 
	}
}

828 
	$mpi_sub_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

830 
»t
, 
s
 = 
A
->s;

832 ifĞ
A
->
s
 * 
B
->s > 0 )

834 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) >= 0 )

836 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
A
, 
B
 ) );

837 
X
->
s
 = s;

841 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ
X
, 
B
, 
A
 ) );

842 
X
->
s
 = -s;

847 
	`MPI_CHK
Ğ
	`mpi_add_abs
Ğ
X
, 
A
, 
B
 ) );

848 
X
->
s
 = s;

851 
ş—nup
:

853 Ğ
»t
 );

854 
	}
}

859 
	$mpi_add_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 )

861 
mpi
 
_B
;

862 
t_št
 
p
[1];

864 
p
[0] = ( 
b
 < 0 ) ? -b : b;

865 
_B
.
s
 = ( 
b
 < 0 ) ? -1 : 1;

866 
_B
.
n
 = 1;

867 
_B
.
p
 =…;

869 Ğ
	`mpi_add_mpi
Ğ
X
, 
A
, &
_B
 ) );

870 
	}
}

875 
	$mpi_sub_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 )

877 
mpi
 
_B
;

878 
t_št
 
p
[1];

880 
p
[0] = ( 
b
 < 0 ) ? -b : b;

881 
_B
.
s
 = ( 
b
 < 0 ) ? -1 : 1;

882 
_B
.
n
 = 1;

883 
_B
.
p
 =…;

885 Ğ
	`mpi_sub_mpi
Ğ
X
, 
A
, &
_B
 ) );

886 
	}
}

891 
	$mpi_mul_hÍ
Ğ
i
, 
t_št
 *
s
,_šˆ*
d
,_šˆ
b
 )

893 
t_št
 
c
 = 0, 
t
 = 0;

895 #ià
	`defšed
(
MULADDC_HUIT
)

896  ; 
i
 >= 8; i -= 8 )

898 
MULADDC_INIT


899 
MULADDC_HUIT


900 
MULADDC_STOP


903  ; 
i
 > 0; i-- )

905 
MULADDC_INIT


906 
MULADDC_CORE


907 
MULADDC_STOP


910  ; 
i
 >= 16; i -= 16 )

912 
MULADDC_INIT


913 
MULADDC_CORE
 MULADDC_CORE

914 
MULADDC_CORE
 MULADDC_CORE

915 
MULADDC_CORE
 MULADDC_CORE

916 
MULADDC_CORE
 MULADDC_CORE

918 
MULADDC_CORE
 MULADDC_CORE

919 
MULADDC_CORE
 MULADDC_CORE

920 
MULADDC_CORE
 MULADDC_CORE

921 
MULADDC_CORE
 MULADDC_CORE

922 
MULADDC_STOP


925  ; 
i
 >= 8; i -= 8 )

927 
MULADDC_INIT


928 
MULADDC_CORE
 MULADDC_CORE

929 
MULADDC_CORE
 MULADDC_CORE

931 
MULADDC_CORE
 MULADDC_CORE

932 
MULADDC_CORE
 MULADDC_CORE

933 
MULADDC_STOP


936  ; 
i
 > 0; i-- )

938 
MULADDC_INIT


939 
MULADDC_CORE


940 
MULADDC_STOP


944 
t
++;

947 *
d
 +ğ
c
; c = ( *d < c ); d++;

949  
c
 != 0 );

950 
	}
}

955 
	$mpi_mul_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

957 
»t
, 
i
, 
j
;

958 
mpi
 
TA
, 
TB
;

960 
	`mpi_š™
Ğ&
TA
, &
TB
, 
NULL
 );

962 ifĞ
X
 =ğ
A
 ) { 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TA
, A ) ); A = &TA; }

963 ifĞ
X
 =ğ
B
 ) { 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, B ) ); B = &TB; }

965  
i
 = 
A
->
n
 - 1; i >= 0; i-- )

966 ifĞ
A
->
p
[
i
] != 0 )

969  
j
 = 
B
->
n
 - 1; j >= 0; j-- )

970 ifĞ
B
->
p
[
j
] != 0 )

973 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
i
 + 
j
 + 2 ) );

974 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

976  
i
++; 
j
 >= 0; j-- )

977 
	`mpi_mul_hÍ
Ğ
i
, 
A
->
p
, 
X
->°+ 
j
, 
B
->p[j] );

979 
X
->
s
 = 
A
-> * 
B
->s;

981 
ş—nup
:

983 
	`mpi_ä“
Ğ&
TB
, &
TA
, 
NULL
 );

985 Ğ
»t
 );

986 
	}
}

991 
	$mpi_mul_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
t_št
 
b
 )

993 
mpi
 
_B
;

994 
t_št
 
p
[1];

996 
_B
.
s
 = 1;

997 
_B
.
n
 = 1;

998 
_B
.
p
 =…;

999 
p
[0] = 
b
;

1001 Ğ
	`mpi_mul_mpi
Ğ
X
, 
A
, &
_B
 ) );

1002 
	}
}

1007 
	$mpi_div_mpi
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

1009 
»t
, 
i
, 
n
, 
t
, 
k
;

1010 
mpi
 
X
, 
Y
, 
Z
, 
T1
, 
T2
;

1012 ifĞ
	`mpi_cmp_št
Ğ
B
, 0 ) == 0 )

1013 Ğ
POLARSSL_ERR_MPI_DIVISION_BY_ZERO
 );

1015 
	`mpi_š™
Ğ&
X
, &
Y
, &
Z
, &
T1
, &
T2
, 
NULL
 );

1017 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
B
 ) < 0 )

1019 ifĞ
Q
 !ğ
NULL
 ) 
	`MPI_CHK
Ğ
	`mpi_l£t
( Q, 0 ) );

1020 ifĞ
R
 !ğ
NULL
 ) 
	`MPI_CHK
Ğ
	`mpi_cİy
ĞR, 
A
 ) );

1024 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
X
, 
A
 ) );

1025 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
Y
, 
B
 ) );

1026 
X
.
s
 = 
Y
.s = 1;

1028 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
Z
, 
A
->
n
 + 2 ) );

1029 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
Z
, 0 ) );

1030 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
T1
, 2 ) );

1031 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
T2
, 3 ) );

1033 
k
 = 
	`mpi_msb
Ğ&
Y
 ) % 
biL
;

1034 ifĞ
k
 < (è
biL
 - 1 )

1036 
k
 = 
biL
 - 1 - k;

1037 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
X
, 
k
 ) );

1038 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
Y
, 
k
 ) );

1040 
k
 = 0;

1042 
n
 = 
X
.n - 1;

1043 
t
 = 
Y
.
n
 - 1;

1044 
	`mpi_shiá_l
Ğ&
Y
, 
biL
 * (
n
 - 
t
) );

1046  
	`mpi_cmp_mpi
Ğ&
X
, &
Y
 ) >= 0 )

1048 
Z
.
p
[
n
 - 
t
]++;

1049 
	`mpi_sub_mpi
Ğ&
X
, &X, &
Y
 );

1051 
	`mpi_shiá_r
Ğ&
Y
, 
biL
 * (
n
 - 
t
) );

1053  
i
 = 
n
; i > 
t
 ; i-- )

1055 ifĞ
X
.
p
[
i
] >ğ
Y
.p[
t
] )

1056 
Z
.
p
[
i
 - 
t
 - 1] = ~0;

1059 #ià
	`defšed
(
POLARSSL_HAVE_LONGLONG
)

1060 
t_dbl
 
r
;

1062 
r
 = (
t_dbl
è
X
.
p
[
i
] << 
biL
;

1063 
r
 |ğ(
t_dbl
è
X
.
p
[
i
 - 1];

1064 
r
 /ğ
Y
.
p
[
t
];

1065 ifĞ
r
 > ((
t_dbl
è1 << 
biL
) - 1)

1066 
r
 = ((
t_dbl
è1 << 
biL
) - 1;

1068 
Z
.
p
[
i
 - 
t
 - 1] = (
t_št
è
r
;

1073 
t_št
 
q0
, 
q1
, 
r0
, 
r1
;

1074 
t_št
 
d0
, 
d1
, 
d
, 
m
;

1076 
d
 = 
Y
.
p
[
t
];

1077 
d0
 = ( 
d
 << 
biH
 ) >> biH;

1078 
d1
 = ( 
d
 >> 
biH
 );

1080 
q1
 = 
X
.
p
[
i
] / 
d1
;

1081 
r1
 = 
X
.
p
[
i
] - 
d1
 * 
q1
;

1082 
r1
 <<ğ
biH
;

1083 
r1
 |ğĞ
X
.
p
[
i
 - 1] >> 
biH
 );

1085 
m
 = 
q1
 * 
d0
;

1086 ifĞ
r1
 < 
m
 )

1088 
q1
--, 
r1
 +ğ
d
;

1089  
r1
 >ğ
d
 &&„1 < 
m
 )

1090 
q1
--, 
r1
 +ğ
d
;

1092 
r1
 -ğ
m
;

1094 
q0
 = 
r1
 / 
d1
;

1095 
r0
 = 
r1
 - 
d1
 * 
q0
;

1096 
r0
 <<ğ
biH
;

1097 
r0
 |ğĞ
X
.
p
[
i
 - 1] << 
biH
 ) >> biH;

1099 
m
 = 
q0
 * 
d0
;

1100 ifĞ
r0
 < 
m
 )

1102 
q0
--, 
r0
 +ğ
d
;

1103  
r0
 >ğ
d
 &&„0 < 
m
 )

1104 
q0
--, 
r0
 +ğ
d
;

1106 
r0
 -ğ
m
;

1108 
Z
.
p
[
i
 - 
t
 - 1] = ( 
q1
 << 
biH
 ) | 
q0
;

1112 
Z
.
p
[
i
 - 
t
 - 1]++;

1115 
Z
.
p
[
i
 - 
t
 - 1]--;

1117 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
T1
, 0 ) );

1118 
T1
.
p
[0] = (
t
 < 1è? 0 : 
Y
.p[t - 1];

1119 
T1
.
p
[1] = 
Y
.p[
t
];

1120 
	`MPI_CHK
Ğ
	`mpi_mul_št
Ğ&
T1
, &T1, 
Z
.
p
[
i
 - 
t
 - 1] ) );

1122 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
T2
, 0 ) );

1123 
T2
.
p
[0] = (
i
 < 2è? 0 : 
X
.p[i - 2];

1124 
T2
.
p
[1] = (
i
 < 1è? 0 : 
X
.p[i - 1];

1125 
T2
.
p
[2] = 
X
.p[
i
];

1127  
	`mpi_cmp_mpi
Ğ&
T1
, &
T2
 ) > 0 );

1129 
	`MPI_CHK
Ğ
	`mpi_mul_št
Ğ&
T1
, &
Y
, 
Z
.
p
[
i
 - 
t
 - 1] ) );

1130 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
T1
, 
biL
 * (
i
 - 
t
 - 1) ) );

1131 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
X
, &X, &
T1
 ) );

1133 ifĞ
	`mpi_cmp_št
Ğ&
X
, 0 ) < 0 )

1135 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
T1
, &
Y
 ) );

1136 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
T1
, 
biL
 * (
i
 - 
t
 - 1) ) );

1137 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
X
, &X, &
T1
 ) );

1138 
Z
.
p
[
i
 - 
t
 - 1]--;

1142 ifĞ
Q
 !ğ
NULL
 )

1144 
	`mpi_cİy
Ğ
Q
, &
Z
 );

1145 
Q
->
s
 = 
A
-> * 
B
->s;

1148 ifĞ
R
 !ğ
NULL
 )

1150 
	`mpi_shiá_r
Ğ&
X
, 
k
 );

1151 
	`mpi_cİy
Ğ
R
, &
X
 );

1153 
R
->
s
 = 
A
->s;

1154 ifĞ
	`mpi_cmp_št
Ğ
R
, 0 ) == 0 )

1155 
R
->
s
 = 1;

1158 
ş—nup
:

1160 
	`mpi_ä“
Ğ&
X
, &
Y
, &
Z
, &
T1
, &
T2
, 
NULL
 );

1162 Ğ
»t
 );

1163 
	}
}

1172 
	$mpi_div_št
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, 
b
 )

1174 
mpi
 
_B
;

1175 
t_št
 
p
[1];

1177 
p
[0] = ( 
b
 < 0 ) ? -b : b;

1178 
_B
.
s
 = ( 
b
 < 0 ) ? -1 : 1;

1179 
_B
.
n
 = 1;

1180 
_B
.
p
 =…;

1182 Ğ
	`mpi_div_mpi
Ğ
Q
, 
R
, 
A
, &
_B
 ) );

1183 
	}
}

1188 
	$mpi_mod_mpi
Ğ
mpi
 *
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

1190 
»t
;

1192 ifĞ
	`mpi_cmp_št
Ğ
B
, 0 ) < 0 )

1193  
POLARSSL_ERR_MPI_NEGATIVE_VALUE
;

1195 
	`MPI_CHK
Ğ
	`mpi_div_mpi
Ğ
NULL
, 
R
, 
A
, 
B
 ) );

1197  
	`mpi_cmp_št
Ğ
R
, 0 ) < 0 )

1198 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ
R
, R, 
B
 ) );

1200  
	`mpi_cmp_mpi
Ğ
R
, 
B
 ) >= 0 )

1201 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ
R
, R, 
B
 ) );

1203 
ş—nup
:

1205 Ğ
»t
 );

1206 
	}
}

1211 
	$mpi_mod_št
Ğ
t_št
 *
r
, cÚ¡ 
mpi
 *
A
, 
b
 )

1213 
i
;

1214 
t_št
 
x
, 
y
, 
z
;

1216 ifĞ
b
 == 0 )

1217 Ğ
POLARSSL_ERR_MPI_DIVISION_BY_ZERO
 );

1219 ifĞ
b
 < 0 )

1220  
POLARSSL_ERR_MPI_NEGATIVE_VALUE
;

1225 ifĞ
b
 == 1 )

1227 *
r
 = 0;

1231 ifĞ
b
 == 2 )

1233 *
r
 = 
A
->
p
[0] & 1;

1240  
i
 = 
A
->
n
 - 1, 
y
 = 0; i >= 0; i-- )

1242 
x
 = 
A
->
p
[
i
];

1243 
y
 = ( y << 
biH
 ) | ( 
x
 >> biH );

1244 
z
 = 
y
 / 
b
;

1245 
y
 -ğ
z
 * 
b
;

1247 
x
 <<ğ
biH
;

1248 
y
 = ( y << 
biH
 ) | ( 
x
 >> biH );

1249 
z
 = 
y
 / 
b
;

1250 
y
 -ğ
z
 * 
b
;

1257 ifĞ
A
->
s
 < 0 && 
y
 != 0 )

1258 
y
 = 
b
 - y;

1260 *
r
 = 
y
;

1263 
	}
}

1268 
	$mpi_mÚtg_š™
Ğ
t_št
 *
mm
, cÚ¡ 
mpi
 *
N
 )

1270 
t_št
 
x
, 
m0
 = 
N
->
p
[0];

1272 
x
 = 
m0
;

1273 
x
 +ğĞĞ
m0
 + 2 ) & 4 ) << 1;

1274 
x
 *ğĞ2 - ( 
m0
 * x ) );

1276 ifĞ
biL
 >ğ16 ) 
x
 *ğĞ2 - ( 
m0
 * x ) );

1277 ifĞ
biL
 >ğ32 ) 
x
 *ğĞ2 - ( 
m0
 * x ) );

1278 ifĞ
biL
 >ğ64 ) 
x
 *ğĞ2 - ( 
m0
 * x ) );

1280 *
mm
 = ~
x
 + 1;

1281 
	}
}

1286 
	$mpi_mÚtmul
Ğ
mpi
 *
A
, cÚ¡ mp˜*
B
, cÚ¡ mp˜*
N
, 
t_št
 
mm
, cÚ¡ mp˜*
T
 )

1288 
i
, 
n
, 
m
;

1289 
t_št
 
u0
, 
u1
, *
d
;

1291 
	`mem£t
Ğ
T
->
p
, 0, T->
n
 * 
ciL
 );

1293 
d
 = 
T
->
p
;

1294 
n
 = 
N
->n;

1295 
m
 = ( 
B
->
n
 <‚ ) ? B->n :‚;

1297  
i
 = 0; i < 
n
; i++ )

1302 
u0
 = 
A
->
p
[
i
];

1303 
u1
 = ( 
d
[0] + 
u0
 * 
B
->
p
[0] ) * 
mm
;

1305 
	`mpi_mul_hÍ
Ğ
m
, 
B
->
p
, 
d
, 
u0
 );

1306 
	`mpi_mul_hÍ
Ğ
n
, 
N
->
p
, 
d
, 
u1
 );

1308 *
d
++ = 
u0
; d[
n
 + 1] = 0;

1311 
	`memıy
Ğ
A
->
p
, 
d
, (
n
 + 1è* 
ciL
 );

1313 ifĞ
	`mpi_cmp_abs
Ğ
A
, 
N
 ) >= 0 )

1314 
	`mpi_sub_hÍ
Ğ
n
, 
N
->
p
, 
A
->p );

1317 
	`mpi_sub_hÍ
Ğ
n
, 
A
->
p
, 
T
->p );

1318 
	}
}

1323 
	$mpi_mÚŒed
Ğ
mpi
 *
A
, cÚ¡ mp˜*
N
, 
t_št
 
mm
, cÚ¡ mp˜*
T
 )

1325 
t_št
 
z
 = 1;

1326 
mpi
 
U
;

1328 
U
.
n
 = U.
s
 = 
z
;

1329 
U
.
p
 = &
z
;

1331 
	`mpi_mÚtmul
Ğ
A
, &
U
, 
N
, 
mm
, 
T
 );

1332 
	}
}

1337 
	$mpi_exp_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
E
, cÚ¡ mp˜*
N
, mp˜*
_RR
 )

1339 
»t
, 
i
, 
j
, 
wsize
, 
wb™s
;

1340 
bufsize
, 
nblimbs
, 
nb™s
;

1341 
t_št
 
ei
, 
mm
, 
¡©e
;

1342 
mpi
 
RR
, 
T
, 
W
[64];

1344 ifĞ
	`mpi_cmp_št
Ğ
N
, 0 ) < 0 || ( N->
p
[0] & 1 ) == 0 )

1345 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

1350 
	`mpi_mÚtg_š™
Ğ&
mm
, 
N
 );

1351 
	`mpi_š™
Ğ&
RR
, &
T
, 
NULL
 );

1352 
	`mem£t
Ğ
W
, 0, ( W ) );

1354 
i
 = 
	`mpi_msb
Ğ
E
 );

1356 
wsize
 = ( 
i
 > 671 ) ? 6 : ( i > 239 ) ? 5 :

1357 Ğ
i
 > 79 ) ? 4 : ( i > 23 ) ? 3 : 1;

1359 
j
 = 
N
->
n
 + 1;

1360 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
j
 ) );

1361 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
W
[1], 
j
 ) );

1362 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
T
, 
j
 * 2 ) );

1367 ifĞ
_RR
 =ğ
NULL
 || _RR->
p
 == NULL )

1369 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
RR
, 1 ) );

1370 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
RR
, 
N
->
n
 * 2 * 
biL
 ) );

1371 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
RR
, &RR, 
N
 ) );

1373 ifĞ
_RR
 !ğ
NULL
 )

1374 
	`memıy
Ğ
_RR
, &
RR
, Ğ
mpi
 ) );

1377 
	`memıy
Ğ&
RR
, 
_RR
, Ğ
mpi
 ) );

1382 ifĞ
	`mpi_cmp_mpi
Ğ
A
, 
N
 ) >= 0 )

1383 
	`mpi_mod_mpi
Ğ&
W
[1], 
A
, 
N
 );

1384 
	`mpi_cİy
Ğ&
W
[1], 
A
 );

1386 
	`mpi_mÚtmul
Ğ&
W
[1], &
RR
, 
N
, 
mm
, &
T
 );

1391 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, &
RR
 ) );

1392 
	`mpi_mÚŒed
Ğ
X
, 
N
, 
mm
, &
T
 );

1394 ifĞ
wsize
 > 1 )

1399 
j
 = 1 << (
wsize
 - 1);

1401 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
W
[
j
], 
N
->
n
 + 1 ) );

1402 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
W
[
j
], &W[1] ) );

1404  
i
 = 0; i < 
wsize
 - 1; i++ )

1405 
	`mpi_mÚtmul
Ğ&
W
[
j
], &W[j], 
N
, 
mm
, &
T
 );

1410  
i
 = 
j
 + 1; i < (1 << 
wsize
); i++ )

1412 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
W
[
i
], 
N
->
n
 + 1 ) );

1413 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
W
[
i
], &W[i - 1] ) );

1415 
	`mpi_mÚtmul
Ğ&
W
[
i
], &W[1], 
N
, 
mm
, &
T
 );

1419 
nblimbs
 = 
E
->
n
;

1420 
bufsize
 = 0;

1421 
nb™s
 = 0;

1422 
wb™s
 = 0;

1423 
¡©e
 = 0;

1427 ifĞ
bufsize
 == 0 )

1429 ifĞ
nblimbs
-- == 0 )

1432 
bufsize
 = Ğ
t_št
 ) << 3;

1435 
bufsize
--;

1437 
ei
 = (
E
->
p
[
nblimbs
] >> 
bufsize
) & 1;

1442 ifĞ
ei
 =ğ0 && 
¡©e
 == 0 )

1445 ifĞ
ei
 =ğ0 && 
¡©e
 == 1 )

1450 
	`mpi_mÚtmul
Ğ
X
, X, 
N
, 
mm
, &
T
 );

1457 
¡©e
 = 2;

1459 
nb™s
++;

1460 
wb™s
 |ğ(
ei
 << (
wsize
 - 
nb™s
));

1462 ifĞ
nb™s
 =ğ
wsize
 )

1467  
i
 = 0; i < 
wsize
; i++ )

1468 
	`mpi_mÚtmul
Ğ
X
, X, 
N
, 
mm
, &
T
 );

1473 
	`mpi_mÚtmul
Ğ
X
, &
W
[
wb™s
], 
N
, 
mm
, &
T
 );

1475 
¡©e
--;

1476 
nb™s
 = 0;

1477 
wb™s
 = 0;

1484  
i
 = 0; i < 
nb™s
; i++ )

1486 
	`mpi_mÚtmul
Ğ
X
, X, 
N
, 
mm
, &
T
 );

1488 
wb™s
 <<= 1;

1490 ifĞ(
wb™s
 & (1 << 
wsize
)) != 0 )

1491 
	`mpi_mÚtmul
Ğ
X
, &
W
[1], 
N
, 
mm
, &
T
 );

1497 
	`mpi_mÚŒed
Ğ
X
, 
N
, 
mm
, &
T
 );

1499 
ş—nup
:

1501  
i
 = (1 << (
wsize
 - 1)); i < (1 << wsize); i++ )

1502 
	`mpi_ä“
Ğ&
W
[
i
], 
NULL
 );

1504 ifĞ
_RR
 !ğ
NULL
 )

1505 
	`mpi_ä“
Ğ&
W
[1], &
T
, 
NULL
 );

1506 
	`mpi_ä“
Ğ&
W
[1], &
T
, &
RR
, 
NULL
 );

1508 Ğ
»t
 );

1509 
	}
}

1514 
	$mpi_gcd
Ğ
mpi
 *
G
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 )

1516 
»t
, 
lz
, 
lzt
;

1517 
mpi
 
TG
, 
TA
, 
TB
;

1519 
	`mpi_š™
Ğ&
TG
, &
TA
, &
TB
, 
NULL
 );

1521 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TA
, 
A
 ) );

1522 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, 
B
 ) );

1524 
lz
 = 
	`mpi_lsb
Ğ&
TA
 );

1525 
lzt
 = 
	`mpi_lsb
Ğ&
TB
 );

1527 iàĞ
lzt
 < 
lz
 )

1528 
lz
 = 
lzt
;

1530 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TA
, 
lz
 ) );

1531 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TB
, 
lz
 ) );

1533 
TA
.
s
 = 
TB
.s = 1;

1535  
	`mpi_cmp_št
Ğ&
TA
, 0 ) != 0 )

1537 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TA
, 
	`mpi_lsb
( &TA ) ) );

1538 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TB
, 
	`mpi_lsb
( &TB ) ) );

1540 ifĞ
	`mpi_cmp_mpi
Ğ&
TA
, &
TB
 ) >= 0 )

1542 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ&
TA
, &TA, &
TB
 ) );

1543 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TA
, 1 ) );

1547 
	`MPI_CHK
Ğ
	`mpi_sub_abs
Ğ&
TB
, &TB, &
TA
 ) );

1548 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TB
, 1 ) );

1552 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ&
TB
, 
lz
 ) );

1553 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
G
, &
TB
 ) );

1555 
ş—nup
:

1557 
	`mpi_ä“
Ğ&
TB
, &
TA
, &
TG
, 
NULL
 );

1559 Ğ
»t
 );

1560 
	}
}

1562 #ià
defšed
(
POLARSSL_GENPRIME
)

1567 
	$mpi_šv_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
N
 )

1569 
»t
;

1570 
mpi
 
G
, 
TA
, 
TU
, 
U1
, 
U2
, 
TB
, 
TV
, 
V1
, 
V2
;

1572 ifĞ
	`mpi_cmp_št
Ğ
N
, 0 ) <= 0 )

1573 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

1575 
	`mpi_š™
Ğ&
TA
, &
TU
, &
U1
, &
U2
, &
G
,

1576 &
TB
, &
TV
, &
V1
, &
V2
, 
NULL
 );

1578 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G
, 
A
, 
N
 ) );

1580 ifĞ
	`mpi_cmp_št
Ğ&
G
, 1 ) != 0 )

1582 
»t
 = 
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
;

1583 
ş—nup
;

1586 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
TA
, 
A
, 
N
 ) );

1587 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TU
, &
TA
 ) );

1588 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TB
, 
N
 ) );

1589 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
TV
, 
N
 ) );

1591 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
U1
, 1 ) );

1592 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
U2
, 0 ) );

1593 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
V1
, 0 ) );

1594 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
V2
, 1 ) );

1598  ( 
TU
.
p
[0] & 1 ) == 0 )

1600 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TU
, 1 ) );

1602 ifĞĞ
U1
.
p
[0] & 1 ) !ğ0 || ( 
U2
.p[0] & 1 ) != 0 )

1604 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
U1
, &U1, &
TB
 ) );

1605 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
U2
, &U2, &
TA
 ) );

1608 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
U1
, 1 ) );

1609 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
U2
, 1 ) );

1612  ( 
TV
.
p
[0] & 1 ) == 0 )

1614 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
TV
, 1 ) );

1616 ifĞĞ
V1
.
p
[0] & 1 ) !ğ0 || ( 
V2
.p[0] & 1 ) != 0 )

1618 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
V1
, &V1, &
TB
 ) );

1619 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V2
, &V2, &
TA
 ) );

1622 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
V1
, 1 ) );

1623 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
V2
, 1 ) );

1626 ifĞ
	`mpi_cmp_mpi
Ğ&
TU
, &
TV
 ) >= 0 )

1628 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
TU
, &TU, &
TV
 ) );

1629 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
U1
, &U1, &
V1
 ) );

1630 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
U2
, &U2, &
V2
 ) );

1634 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
TV
, &TV, &
TU
 ) );

1635 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V1
, &V1, &
U1
 ) );

1636 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V2
, &V2, &
U2
 ) );

1639  
	`mpi_cmp_št
Ğ&
TU
, 0 ) != 0 );

1641  
	`mpi_cmp_št
Ğ&
V1
, 0 ) < 0 )

1642 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
V1
, &V1, 
N
 ) );

1644  
	`mpi_cmp_mpi
Ğ&
V1
, 
N
 ) >= 0 )

1645 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
V1
, &V1, 
N
 ) );

1647 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ
X
, &
V1
 ) );

1649 
ş—nup
:

1651 
	`mpi_ä“
Ğ&
V2
, &
V1
, &
TV
, &
TB
, &
G
,

1652 &
U2
, &
U1
, &
TU
, &
TA
, 
NULL
 );

1654 Ğ
»t
 );

1655 
	}
}

1657 cÚ¡ 
	gsm®l_´ime
[] =

1685 
mpi_is_´ime
Ğ
mpi
 *
X
, (*
f_ºg
)(*), *
p_ºg
 )

1687 
»t
, 
i
, 
j
, 
n
, 
s
, 
xs
;

1688 
mpi
 
W
, 
R
, 
T
, 
A
, 
RR
;

1689 *
p
;

1691 ifĞ
	`mpi_cmp_št
Ğ
X
, 0 ) == 0 ||

1692 
	`mpi_cmp_št
Ğ
X
, 1 ) == 0 )

1693 Ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 );

1695 ifĞ
	`mpi_cmp_št
Ğ
X
, 2 ) == 0 )

1698 
	`mpi_š™
Ğ&
W
, &
R
, &
T
, &
A
, &
RR
, 
NULL
 );

1700 
xs
 = 
X
->
s
; X->s = 1;

1705 ifĞĞ
X
->
p
[0] & 1 ) == 0 )

1706 Ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 );

1708  
i
 = 0; 
sm®l_´ime
[i] > 0; i++ )

1710 
t_št
 
r
;

1712 ifĞ
	`mpi_cmp_št
Ğ
X
, 
sm®l_´ime
[
i
] ) <= 0 )

1715 
	`MPI_CHK
Ğ
	`mpi_mod_št
Ğ&
r
, 
X
, 
sm®l_´ime
[
i
] ) );

1717 ifĞ
r
 == 0 )

1718 Ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 );

1725 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
W
, 
X
, 1 ) );

1726 
s
 = 
	`mpi_lsb
Ğ&
W
 );

1727 
	`MPI_CHK
Ğ
	`mpi_cİy
Ğ&
R
, &
W
 ) );

1728 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
R
, 
s
 ) );

1730 
i
 = 
	`mpi_msb
Ğ
X
 );

1734 
n
 = ( ( 
i
 >= 1300 ) ? 2 : ( i >= 850 ) ? 3 :

1735 Ğ
i
 >= 650 ) ? 4 : ( i >= 350 ) ? 8 :

1736 Ğ
i
 >= 250 ) ? 12 : ( i >= 150 ) ? 18 : 27 );

1738  
i
 = 0; i < 
n
; i++ )

1743 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
A
, 
X
->
n
 ) );

1745 
p
 = (*è
A
.p;

1746  
j
 = 0; j < 
A
.
n
 * 
ciL
; j++ )

1747 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

1749 
j
 = 
	`mpi_msb
Ğ&
A
 ) - mpi_msbĞ&
W
 );

1750 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
A
, 
j
 + 1 ) );

1751 
A
.
p
[0] |= 3;

1756 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
A
, &A, &
R
, 
X
, &
RR
 ) );

1758 ifĞ
	`mpi_cmp_mpi
Ğ&
A
, &
W
 ) == 0 ||

1759 
	`mpi_cmp_št
Ğ&
A
, 1 ) == 0 )

1762 
j
 = 1;

1763  
j
 < 
s
 && 
	`mpi_cmp_mpi
Ğ&
A
, &
W
 ) != 0 )

1768 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
T
, &
A
, &A ) );

1769 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
A
, &
T
, 
X
 ) );

1771 ifĞ
	`mpi_cmp_št
Ğ&
A
, 1 ) == 0 )

1774 
j
++;

1780 ifĞ
	`mpi_cmp_mpi
Ğ&
A
, &
W
 ) != 0 ||

1781 
	`mpi_cmp_št
Ğ&
A
, 1 ) == 0 )

1783 
»t
 = 
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
;

1788 
ş—nup
:

1790 
X
->
s
 = 
xs
;

1792 
	`mpi_ä“
Ğ&
RR
, &
A
, &
T
, &
R
, &
W
, 
NULL
 );

1794 Ğ
»t
 );

1795 
	}
}

1800 
mpi_g’_´ime
Ğ
mpi
 *
X
, 
nb™s
, 
dh_æag
,

1801 (*
f_ºg
)(*), *
p_ºg
 )

1803 
»t
, 
k
, 
n
;

1804 *
p
;

1805 
mpi
 
Y
;

1807 ifĞ
nb™s
 < 3 )

1808 Ğ
POLARSSL_ERR_MPI_BAD_INPUT_DATA
 );

1810 
	`mpi_š™
Ğ&
Y
, 
NULL
 );

1812 
n
 = 
	`BITS_TO_LIMBS
Ğ
nb™s
 );

1814 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ
X
, 
n
 ) );

1815 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ
X
, 0 ) );

1817 
p
 = (*è
X
->p;

1818  
k
 = 0; k < 
X
->
n
 * 
ciL
; k++ )

1819 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

1821 
k
 = 
	`mpi_msb
Ğ
X
 );

1822 ifĞ
k
 < 
nb™s
 ) 
	`MPI_CHK
Ğ
	`mpi_shiá_l
Ğ
X
,‚bits - k ) );

1823 ifĞ
k
 > 
nb™s
 ) 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ
X
, k -‚bits ) );

1825 
X
->
p
[0] |= 3;

1827 ifĞ
dh_æag
 == 0 )

1829  ( 
»t
 = 
	`mpi_is_´ime
Ğ
X
, 
f_ºg
, 
p_ºg
 ) ) != 0 )

1831 ifĞ
»t
 !ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 )

1832 
ş—nup
;

1834 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ
X
, X, 2 ) );

1839 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
Y
, 
X
, 1 ) );

1840 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
Y
, 1 ) );

1844 ifĞĞ
»t
 = 
	`mpi_is_´ime
Ğ
X
, 
f_ºg
, 
p_ºg
 ) ) == 0 )

1846 ifĞĞ
»t
 = 
	`mpi_is_´ime
Ğ&
Y
, 
f_ºg
, 
p_ºg
 ) ) == 0 )

1849 ifĞ
»t
 !ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 )

1850 
ş—nup
;

1853 ifĞ
»t
 !ğ
POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 )

1854 
ş—nup
;

1856 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ&
Y
, 
X
, 1 ) );

1857 
	`MPI_CHK
Ğ
	`mpi_add_št
Ğ
X
, X, 2 ) );

1858 
	`MPI_CHK
Ğ
	`mpi_shiá_r
Ğ&
Y
, 1 ) );

1862 
ş—nup
:

1864 
	`mpi_ä“
Ğ&
Y
, 
NULL
 );

1866 Ğ
»t
 );

1867 
	}
}

1871 #ià
defšed
(
POLARSSL_SELF_TEST
)

1873 
	#GCD_PAIR_COUNT
 3

	)

1875 cÚ¡ 
	ggcd_·œs
[
GCD_PAIR_COUNT
][3] =

1885 
	$mpi_£lf_‹¡
Ğ
v”bo£
 )

1887 
»t
, 
i
;

1888 
mpi
 
A
, 
E
, 
N
, 
X
, 
Y
, 
U
, 
V
;

1890 
	`mpi_š™
Ğ&
A
, &
E
, &
N
, &
X
, &
Y
, &
U
, &
V
, 
NULL
 );

1892 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
A
, 16,

1898 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
E
, 16,

1904 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
N
, 16,

1909 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
X
, &
A
, &
N
 ) );

1911 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1920 ifĞ
v”bo£
 != 0 )

1921 
	`´štf
( " MPIest #1 (mul_mpi): " );

1923 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 )

1925 ifĞ
v”bo£
 != 0 )

1926 
	`´štf
( "failed\n" );

1931 ifĞ
v”bo£
 != 0 )

1932 
	`´štf
( "passed\n" );

1934 
	`MPI_CHK
Ğ
	`mpi_div_mpi
Ğ&
X
, &
Y
, &
A
, &
N
 ) );

1936 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1939 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
V
, 16,

1944 ifĞ
v”bo£
 != 0 )

1945 
	`´štf
( " MPIest #2 (div_mpi): " );

1947 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 ||

1948 
	`mpi_cmp_mpi
Ğ&
Y
, &
V
 ) != 0 )

1950 ifĞ
v”bo£
 != 0 )

1951 
	`´štf
( "failed\n" );

1956 ifĞ
v”bo£
 != 0 )

1957 
	`´štf
( "passed\n" );

1959 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
X
, &
A
, &
E
, &
N
, 
NULL
 ) );

1961 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1966 ifĞ
v”bo£
 != 0 )

1967 
	`´štf
( " MPIest #3 (exp_mod): " );

1969 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 )

1971 ifĞ
v”bo£
 != 0 )

1972 
	`´štf
( "failed\n" );

1977 ifĞ
v”bo£
 != 0 )

1978 
	`´štf
( "passed\n" );

1980 
	`MPI_CHK
Ğ
	`mpi_šv_mod
Ğ&
X
, &
A
, &
N
 ) );

1982 
	`MPI_CHK
Ğ
	`mpi_»ad_¡ršg
Ğ&
U
, 16,

1987 ifĞ
v”bo£
 != 0 )

1988 
	`´štf
( " MPIest #4 (inv_mod): " );

1990 ifĞ
	`mpi_cmp_mpi
Ğ&
X
, &
U
 ) != 0 )

1992 ifĞ
v”bo£
 != 0 )

1993 
	`´štf
( "failed\n" );

1998 ifĞ
v”bo£
 != 0 )

1999 
	`´štf
( "passed\n" );

2001 ifĞ
v”bo£
 != 0 )

2002 
	`´štf
( " MPIest #5 (simple gcd): " );

2004  
i
 = 0; i < 
GCD_PAIR_COUNT
; i++)

2006 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
X
, 
gcd_·œs
[
i
][0] ) );

2007 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
Y
, 
gcd_·œs
[
i
][1] ) );

2009 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
A
, &
X
, &
Y
 ) );

2011 ifĞ
	`mpi_cmp_št
Ğ&
A
, 
gcd_·œs
[
i
][2] ) != 0 )

2013 ifĞ
v”bo£
 != 0 )

2014 
	`´štf
Ğ"çed‡ˆ%d\n", 
i
 );

2020 ifĞ
v”bo£
 != 0 )

2021 
	`´štf
( "passed\n" );

2023 
ş—nup
:

2025 ifĞ
»t
 !ğ0 && 
v”bo£
 != 0 )

2026 
	`´štf
Ğ"UÃx³ùedƒ¼Ü,„‘uº codğ%08X\n", 
»t
 );

2028 
	`mpi_ä“
Ğ&
V
, &
U
, &
Y
, &
X
, &
N
, &
E
, &
A
, 
NULL
 );

2030 ifĞ
v”bo£
 != 0 )

2031 
	`´štf
( "\n" );

2033 Ğ
»t
 );

2034 
	}
}

	@tools/src/polarssl/bignum.h

25 #iâdeà
POLARSSL_BIGNUM_H


26 
	#POLARSSL_BIGNUM_H


	)

28 
	~<¡dio.h
>

30 
	#POLARSSL_ERR_MPI_FILE_IO_ERROR
 0x0002

	)

31 
	#POLARSSL_ERR_MPI_BAD_INPUT_DATA
 0x0004

	)

32 
	#POLARSSL_ERR_MPI_INVALID_CHARACTER
 0x0006

	)

33 
	#POLARSSL_ERR_MPI_BUFFER_TOO_SMALL
 0x0008

	)

34 
	#POLARSSL_ERR_MPI_NEGATIVE_VALUE
 0x000A

	)

35 
	#POLARSSL_ERR_MPI_DIVISION_BY_ZERO
 0x000C

	)

36 
	#POLARSSL_ERR_MPI_NOT_ACCEPTABLE
 0x000E

	)

38 
	#MPI_CHK
(
f
èifĞĞ
»t
 = f ) !ğ0 ) 
ş—nup


	)

43 #ià
defšed
(
POLARSSL_HAVE_INT8
)

44 
	tt_št
;

45 
	tt_dbl
;

47 #ià
defšed
(
POLARSSL_HAVE_INT16
)

48 
	tt_št
;

49 
	tt_dbl
;

51 
	tt_št
;

52 #ià
defšed
(
_MSC_VER
è&& defšed(
_M_IX86
)

53 
	t__št64
 
	tt_dbl
;

55 #ià
defšed
(
__amd64__
è|| defšed(
__x86_64__
) || \

56 
defšed
(
__µc64__
è|| defšed(
__pow”pc64__
) || \

57 
defšed
(
__Ÿ64__
è|| 
	$defšed
(
__®pha__
)

58 
	tt_dbl
 
	t__©Œibu‹__
((
	tmode
(
	tTI
)));

60 #ià
	`defšed
(
POLARSSL_HAVE_LONGLONG
)

61 
	tt_dbl
;

73 
s
;

74 
n
;

75 
t_št
 *
p
;

77 
	tmpi
;

79 #ifdeà
__ılu¥lus


86 
	`mpi_š™
Ğ
mpi
 *
X
, ... );

91 
	`mpi_ä“
Ğ
mpi
 *
X
, ... );

102 
	`mpi_grow
Ğ
mpi
 *
X
, 
nblimbs
 );

113 
	`mpi_cİy
Ğ
mpi
 *
X
, cÚ¡ mp˜*
Y
 );

121 
	`mpi_sw­
Ğ
mpi
 *
X
, mp˜*
Y
 );

132 
	`mpi_l£t
Ğ
mpi
 *
X
, 
z
 );

139 
	`mpi_lsb
ĞcÚ¡ 
mpi
 *
X
 );

146 
	`mpi_msb
ĞcÚ¡ 
mpi
 *
X
 );

153 
	`mpi_size
ĞcÚ¡ 
mpi
 *
X
 );

164 
	`mpi_»ad_¡ršg
Ğ
mpi
 *
X
, 
¿dix
, cÚ¡ *
s
 );

181 
	`mpi_wr™e_¡ršg
ĞcÚ¡ 
mpi
 *
X
, 
¿dix
, *
s
, *
¦’
 );

192 
	`mpi_»ad_fe
Ğ
mpi
 *
X
, 
¿dix
, 
FILE
 *
fš
 );

206 
	`mpi_wr™e_fe
ĞcÚ¡ *
p
, cÚ¡ 
mpi
 *
X
, 
¿dix
, 
FILE
 *
fout
 );

218 
	`mpi_»ad_bš¬y
Ğ
mpi
 *
X
, cÚ¡ *
buf
, 
buæ’
 );

230 
	`mpi_wr™e_bš¬y
ĞcÚ¡ 
mpi
 *
X
, *
buf
, 
buæ’
 );

241 
	`mpi_shiá_l
Ğ
mpi
 *
X
, 
couÁ
 );

252 
	`mpi_shiá_r
Ğ
mpi
 *
X
, 
couÁ
 );

264 
	`mpi_cmp_abs
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 );

276 
	`mpi_cmp_mpi
ĞcÚ¡ 
mpi
 *
X
, cÚ¡ mp˜*
Y
 );

288 
	`mpi_cmp_št
ĞcÚ¡ 
mpi
 *
X
, 
z
 );

300 
	`mpi_add_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

312 
	`mpi_sub_abs
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

324 
	`mpi_add_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

336 
	`mpi_sub_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

348 
	`mpi_add_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 );

360 
	`mpi_sub_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
b
 );

372 
	`mpi_mul_mpi
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

386 
	`mpi_mul_št
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, 
t_št
 
b
 );

402 
	`mpi_div_mpi
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

418 
	`mpi_div_št
Ğ
mpi
 *
Q
, mp˜*
R
, cÚ¡ mp˜*
A
, 
b
 );

432 
	`mpi_mod_mpi
Ğ
mpi
 *
R
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

446 
	`mpi_mod_št
Ğ
t_št
 *
r
, cÚ¡ 
mpi
 *
A
, 
b
 );

465 
	`mpi_exp_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
E
, cÚ¡ mp˜*
N
, mp˜*
_RR
 );

477 
	`mpi_gcd
Ğ
mpi
 *
G
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
B
 );

491 
	`mpi_šv_mod
Ğ
mpi
 *
X
, cÚ¡ mp˜*
A
, cÚ¡ mp˜*
N
 );

504 
	`mpi_is_´ime
Ğ
mpi
 *
X
, (*
f_ºg
)(*), *
p_ºg
 );

519 
	`mpi_g’_´ime
Ğ
mpi
 *
X
, 
nb™s
, 
dh_æag
,

520 (*
f_ºg
)(*), *
p_ºg
 );

527 
	`mpi_£lf_‹¡
Ğ
v”bo£
 );

529 #ifdeà
__ılu¥lus


530 
	}
}

	@tools/src/polarssl/bn_mul.h

39 #iâdeà
POLARSSL_BN_MUL_H


40 
	#POLARSSL_BN_MUL_H


	)

42 
	~"pŞ¬s¦/cÚfig.h
"

44 #ià
defšed
(
POLARSSL_HAVE_ASM
)

46 #ià
defšed
(
__GNUC__
)

47 #ià
defšed
(
__i386__
)

49 
	#MULADDC_INIT
 \

50 
	`asm
Ğ" \
 %%ebx, %0; \
 %5, %%esi; \
 %6, %%edi; \
 %7, %%ecx; \
 %8, %%ebx; \
"

	)

58 
	#MULADDC_CORE
 \

59 " \
; \
 %%ebx; \
 %%ecx, %%—x; \
 $0, %%edx; \
 (%%edi), %%—x; \
 $0, %%edx; \
 %%edx, %%ecx; \
; \
"

	)

70 #ià
defšed
(
POLARSSL_HAVE_SSE2
)

72 
	#MULADDC_HUIT
 \

73 " \
 %%ecx, %%mm1; \
 %%ebx, %%mm0; \
 (%%edi), %%mm3; \
 %%mm3, %%mm1; \
 (%%esi), %%mm2; \
 %%mm0, %%mm2; \
 4(%%esi), %%mm4; \
 %%mm0, %%mm4; \
 8(%%esi), %%mm6; \
 %%mm0, %%mm6; \
 12(%%esi), %%mm7; \
 %%mm0, %%mm7; \
 %%mm2, %%mm1; \
 4(%%edi), %%mm3; \
 %%mm4, %%mm3; \
 8(%%edi), %%mm5; \
 %%mm6, %%mm5; \
 12(%%edi), %%mm4; \
 %%mm4, %%mm7; \
 %%mm1, (%%edi); \
 16(%%esi), %%mm2; \
 %%mm0, %%mm2; \
 $32, %%mm1; \
 20(%%esi), %%mm4; \
 %%mm0, %%mm4; \
 %%mm3, %%mm1; \
 24(%%esi), %%mm6; \
 %%mm0, %%mm6; \
 %%mm1, 4(%%edi); \
 $32, %%mm1; \
 28(%%esi), %%mm3; \
 %%mm0, %%mm3; \
 %%mm5, %%mm1; \
 16(%%edi), %%mm5; \
 %%mm5, %%mm2; \
 %%mm1, 8(%%edi); \
 $32, %%mm1; \
 %%mm7, %%mm1; \
 20(%%edi), %%mm5; \
 %%mm5, %%mm4; \
 %%mm1, 12(%%edi); \
 $32, %%mm1; \
 %%mm2, %%mm1; \
 24(%%edi), %%mm5; \
 %%mm5, %%mm6; \
 %%mm1, 16(%%edi); \
 $32, %%mm1; \
 %%mm4, %%mm1; \
 28(%%edi), %%mm5; \
 %%mm5, %%mm3; \
 %%mm1, 20(%%edi); \
 $32, %%mm1; \
 %%mm6, %%mm1; \
 %%mm1, 24(%%edi); \
 $32, %%mm1; \
 %%mm3, %%mm1; \
 %%mm1, 28(%%edi); \
 $32, %%edi; \
 $32, %%esi; \
 $32, %%mm1; \
 %%mm1, %%ecx; \
"

	)

137 
	#MULADDC_STOP
 \

145 : "=m" (
t
), "=m" (
c
), "=m" (
d
), "=m" (
s
) \

146 : "m" (
t
), "m" (
s
), "m" (
d
), "m" (
c
), "m" (
b
) \

148 );

	)

152 
	#MULADDC_STOP
 \

159 : "=m" (
t
), "=m" (
c
), "=m" (
d
), "=m" (
s
) \

160 : "m" (
t
), "m" (
s
), "m" (
d
), "m" (
c
), "m" (
b
) \

162 );

	)

166 #ià
defšed
(
__amd64__
è|| defšed (
__x86_64__
)

168 
	#MULADDC_INIT
 \

169 
	`asm
Ğ"movq %0, %%rs˜ " :: "m" (
s
)); \

170 
	`asm
Ğ"movq %0, %%rd˜ " :: "m" (
d
)); \

171 
	`asm
Ğ"movq %0, %%rcx " :: "m" (
c
)); \

172 
	`asm
Ğ"movq %0, %%rbx " :: "m" (
b
)); \

173 
	`asm
Ğ"xÜq %r8, %r8 " );

	)

175 
	#MULADDC_CORE
 \

176 
	`asm
( "movq (%rsi),%rax " ); \

177 
	`asm
( "mulq %rbx " ); \

178 
	`asm
( "addq $8, %rsi " ); \

179 
	`asm
( "addq %rcx, %rax " ); \

180 
	`asm
( "movq %r8, %rcx " ); \

181 
	`asm
( "adcq $0, %rdx " ); \

182 
	`asm
( "nop " ); \

183 
	`asm
( "addq %rax, (%rdi) " ); \

184 
	`asm
( "adcq %rdx, %rcx " ); \

185 
	`asm
Ğ"addq $8, %rd˜ " );

	)

187 
	#MULADDC_STOP
 \

188 
	`asm
Ğ"movq %%rcx, %0 " : "=m" (
c
)); \

189 
	`asm
Ğ"movq %%rdi, %0 " : "=m" (
d
)); \

190 
	`asm
Ğ"movq %%rsi, %0 " : "=m" (
s
) :: \

191 "¿x", "rcx", "rdx", "rbx", "rsi", "rdi", "r8" );

	)

195 #ià
defšed
(
__mc68020__
è|| defšed(
__mıu32__
)

197 
	#MULADDC_INIT
 \

198 
	`asm
Ğ"movÈ %0, %%a2 " :: "m" (
s
)); \

199 
	`asm
Ğ"movÈ %0, %%a3 " :: "m" (
d
)); \

200 
	`asm
Ğ"movÈ %0, %%d3 " :: "m" (
c
)); \

201 
	`asm
Ğ"movÈ %0, %%d2 " :: "m" (
b
)); \

202 
	`asm
Ğ"moveq #0, %d0 " );

	)

204 
	#MULADDC_CORE
 \

205 
	`asm
( "movel %a2@+, %d1 " ); \

206 
	`asm
( "mulul %d2, %d4:%d1 " ); \

207 
	`asm
( "addl %d3, %d1 " ); \

208 
	`asm
( "addxl %d0, %d4 " ); \

209 
	`asm
( "moveq #0, %d3 " ); \

210 
	`asm
( "addl %d1, %a3@+ " ); \

211 
	`asm
Ğ"addxÈ %d4, %d3 " );

	)

213 
	#MULADDC_STOP
 \

214 
	`asm
Ğ"movÈ %%d3, %0 " : "=m" (
c
)); \

215 
	`asm
Ğ"movÈ %%a3, %0 " : "=m" (
d
)); \

216 
	`asm
Ğ"movÈ %%a2, %0 " : "=m" (
s
) :: \

217 "d0", "d1", "d2", "d3", "d4", "a2", "a3" );

	)

219 
	#MULADDC_HUIT
 \

220 
	`asm
( "movel %a2@+, %d1 " ); \

221 
	`asm
( "mulul %d2, %d4:%d1 " ); \

222 
	`asm
( "addxl %d3, %d1 " ); \

223 
	`asm
( "addxl %d0, %d4 " ); \

224 
	`asm
( "addl %d1, %a3@+ " ); \

225 
	`asm
( "movel %a2@+, %d1 " ); \

226 
	`asm
( "mulul %d2, %d3:%d1 " ); \

227 
	`asm
( "addxl %d4, %d1 " ); \

228 
	`asm
( "addxl %d0, %d3 " ); \

229 
	`asm
( "addl %d1, %a3@+ " ); \

230 
	`asm
( "movel %a2@+, %d1 " ); \

231 
	`asm
( "mulul %d2, %d4:%d1 " ); \

232 
	`asm
( "addxl %d3, %d1 " ); \

233 
	`asm
( "addxl %d0, %d4 " ); \

234 
	`asm
( "addl %d1, %a3@+ " ); \

235 
	`asm
( "movel %a2@+, %d1 " ); \

236 
	`asm
( "mulul %d2, %d3:%d1 " ); \

237 
	`asm
( "addxl %d4, %d1 " ); \

238 
	`asm
( "addxl %d0, %d3 " ); \

239 
	`asm
( "addl %d1, %a3@+ " ); \

240 
	`asm
( "movel %a2@+, %d1 " ); \

241 
	`asm
( "mulul %d2, %d4:%d1 " ); \

242 
	`asm
( "addxl %d3, %d1 " ); \

243 
	`asm
( "addxl %d0, %d4 " ); \

244 
	`asm
( "addl %d1, %a3@+ " ); \

245 
	`asm
( "movel %a2@+, %d1 " ); \

246 
	`asm
( "mulul %d2, %d3:%d1 " ); \

247 
	`asm
( "addxl %d4, %d1 " ); \

248 
	`asm
( "addxl %d0, %d3 " ); \

249 
	`asm
( "addl %d1, %a3@+ " ); \

250 
	`asm
( "movel %a2@+, %d1 " ); \

251 
	`asm
( "mulul %d2, %d4:%d1 " ); \

252 
	`asm
( "addxl %d3, %d1 " ); \

253 
	`asm
( "addxl %d0, %d4 " ); \

254 
	`asm
( "addl %d1, %a3@+ " ); \

255 
	`asm
( "movel %a2@+, %d1 " ); \

256 
	`asm
( "mulul %d2, %d3:%d1 " ); \

257 
	`asm
( "addxl %d4, %d1 " ); \

258 
	`asm
( "addxl %d0, %d3 " ); \

259 
	`asm
( "addl %d1, %a3@+ " ); \

260 
	`asm
Ğ"addxÈ %d0, %d3 " );

	)

264 #ià
defšed
(
__pow”pc__
è|| defšed(
__µc__
)

265 #ià
defšed
(
__pow”pc64__
è|| defšed(
__µc64__
)

267 #ià
defšed
(
__MACH__
è&& defšed(
__APPLE__
)

269 
	#MULADDC_INIT
 \

270 
	`asm
Ğ"ld„3, %0 " :: "m" (
s
)); \

271 
	`asm
Ğ"ld„4, %0 " :: "m" (
d
)); \

272 
	`asm
Ğ"ld„5, %0 " :: "m" (
c
)); \

273 
	`asm
Ğ"ld„6, %0 " :: "m" (
b
)); \

274 
	`asm
( "addi„3,„3, -8 " ); \

275 
	`asm
( "addi„4,„4, -8 " ); \

276 
	`asm
Ğ"addiø„5,„5, 0 " );

	)

278 
	#MULADDC_CORE
 \

279 
	`asm
( "ldu„7, 8(r3) " ); \

280 
	`asm
( "mulld„8,„7,„6 " ); \

281 
	`asm
( "mulhdu„9,„7,„6 " ); \

282 
	`asm
( "adde„8,„8,„5 " ); \

283 
	`asm
( "ld„7, 8(r4) " ); \

284 
	`asm
( "addze„5,„9 " ); \

285 
	`asm
( "addc„8,„8,„7 " ); \

286 
	`asm
Ğ"¡du„8, 8Ô4è " );

	)

288 
	#MULADDC_STOP
 \

289 
	`asm
( "addze„5,„5 " ); \

290 
	`asm
( "addi„4,„4, 8 " ); \

291 
	`asm
( "addi„3,„3, 8 " ); \

292 
	`asm
Ğ"¡d„5, %0 " : "=m" (
c
)); \

293 
	`asm
Ğ"¡d„4, %0 " : "=m" (
d
)); \

294 
	`asm
Ğ"¡d„3, %0 " : "=m" (
s
) :: \

295 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

299 
	#MULADDC_INIT
 \

300 
	`asm
Ğ"ld %%r3, %0 " :: "m" (
s
)); \

301 
	`asm
Ğ"ld %%r4, %0 " :: "m" (
d
)); \

302 
	`asm
Ğ"ld %%r5, %0 " :: "m" (
c
)); \

303 
	`asm
Ğ"ld %%r6, %0 " :: "m" (
b
)); \

304 
	`asm
( "addi %r3, %r3, -8 " ); \

305 
	`asm
( "addi %r4, %r4, -8 " ); \

306 
	`asm
Ğ"addiø %r5, %r5, 0 " );

	)

308 
	#MULADDC_CORE
 \

309 
	`asm
( "ldu %r7, 8(%r3) " ); \

310 
	`asm
( "mulld %r8, %r7, %r6 " ); \

311 
	`asm
( "mulhdu %r9, %r7, %r6 " ); \

312 
	`asm
( "adde %r8, %r8, %r5 " ); \

313 
	`asm
( "ld %r7, 8(%r4) " ); \

314 
	`asm
( "addze %r5, %r9 " ); \

315 
	`asm
( "addc %r8, %r8, %r7 " ); \

316 
	`asm
Ğ"¡du %r8, 8(%r4è " );

	)

318 
	#MULADDC_STOP
 \

319 
	`asm
( "addze %r5, %r5 " ); \

320 
	`asm
( "addi %r4, %r4, 8 " ); \

321 
	`asm
( "addi %r3, %r3, 8 " ); \

322 
	`asm
Ğ"¡d %%r5, %0 " : "=m" (
c
)); \

323 
	`asm
Ğ"¡d %%r4, %0 " : "=m" (
d
)); \

324 
	`asm
Ğ"¡d %%r3, %0 " : "=m" (
s
) :: \

325 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

331 #ià
defšed
(
__MACH__
è&& defšed(
__APPLE__
)

333 
	#MULADDC_INIT
 \

334 
	`asm
Ğ"lwz„3, %0 " :: "m" (
s
)); \

335 
	`asm
Ğ"lwz„4, %0 " :: "m" (
d
)); \

336 
	`asm
Ğ"lwz„5, %0 " :: "m" (
c
)); \

337 
	`asm
Ğ"lwz„6, %0 " :: "m" (
b
)); \

338 
	`asm
( "addi„3,„3, -4 " ); \

339 
	`asm
( "addi„4,„4, -4 " ); \

340 
	`asm
Ğ"addiø„5,„5, 0 " );

	)

342 
	#MULADDC_CORE
 \

343 
	`asm
( "lwzu„7, 4(r3) " ); \

344 
	`asm
( "mullw„8,„7,„6 " ); \

345 
	`asm
( "mulhwu„9,„7,„6 " ); \

346 
	`asm
( "adde„8,„8,„5 " ); \

347 
	`asm
( "lwz„7, 4(r4) " ); \

348 
	`asm
( "addze„5,„9 " ); \

349 
	`asm
( "addc„8,„8,„7 " ); \

350 
	`asm
Ğ"¡wu„8, 4Ô4è " );

	)

352 
	#MULADDC_STOP
 \

353 
	`asm
( "addze„5,„5 " ); \

354 
	`asm
( "addi„4,„4, 4 " ); \

355 
	`asm
( "addi„3,„3, 4 " ); \

356 
	`asm
Ğ"¡w„5, %0 " : "=m" (
c
)); \

357 
	`asm
Ğ"¡w„4, %0 " : "=m" (
d
)); \

358 
	`asm
Ğ"¡w„3, %0 " : "=m" (
s
) :: \

359 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

363 
	#MULADDC_INIT
 \

364 
	`asm
Ğ"lwz %%r3, %0 " :: "m" (
s
)); \

365 
	`asm
Ğ"lwz %%r4, %0 " :: "m" (
d
)); \

366 
	`asm
Ğ"lwz %%r5, %0 " :: "m" (
c
)); \

367 
	`asm
Ğ"lwz %%r6, %0 " :: "m" (
b
)); \

368 
	`asm
( "addi %r3, %r3, -4 " ); \

369 
	`asm
( "addi %r4, %r4, -4 " ); \

370 
	`asm
Ğ"addiø %r5, %r5, 0 " );

	)

372 
	#MULADDC_CORE
 \

373 
	`asm
( "lwzu %r7, 4(%r3) " ); \

374 
	`asm
( "mullw %r8, %r7, %r6 " ); \

375 
	`asm
( "mulhwu %r9, %r7, %r6 " ); \

376 
	`asm
( "adde %r8, %r8, %r5 " ); \

377 
	`asm
( "lwz %r7, 4(%r4) " ); \

378 
	`asm
( "addze %r5, %r9 " ); \

379 
	`asm
( "addc %r8, %r8, %r7 " ); \

380 
	`asm
Ğ"¡wu %r8, 4(%r4è " );

	)

382 
	#MULADDC_STOP
 \

383 
	`asm
( "addze %r5, %r5 " ); \

384 
	`asm
( "addi %r4, %r4, 4 " ); \

385 
	`asm
( "addi %r3, %r3, 4 " ); \

386 
	`asm
Ğ"¡w %%r5, %0 " : "=m" (
c
)); \

387 
	`asm
Ğ"¡w %%r4, %0 " : "=m" (
d
)); \

388 
	`asm
Ğ"¡w %%r3, %0 " : "=m" (
s
) :: \

389 "r3", "r4", "r5", "r6", "r7", "r8", "r9" );

	)

396 #ià
defšed
(
__¥¬c__
)

398 
	#MULADDC_INIT
 \

399 
	`asm
Ğ"ld %0, %%o0 " :: "m" (
s
)); \

400 
	`asm
Ğ"ld %0, %%o1 " :: "m" (
d
)); \

401 
	`asm
Ğ"ld %0, %%o2 " :: "m" (
c
)); \

402 
	`asm
Ğ"ld %0, %%o3 " :: "m" (
b
));

	)

404 
	#MULADDC_CORE
 \

405 
	`asm
( "ld [%o0], %o4 " ); \

406 
	`asm
( "inc 4, %o0 " ); \

407 
	`asm
( "ld [%o1], %o5 " ); \

408 
	`asm
( "umul %o3, %o4, %o4 " ); \

409 
	`asm
( "addcc %o4, %o2, %o4 " ); \

410 
	`asm
( "rd %y, %g1 " ); \

411 
	`asm
( "addx %g1, 0, %g1 " ); \

412 
	`asm
( "addcc %o4, %o5, %o4 " ); \

413 
	`asm
( "st %o4, [%o1] " ); \

414 
	`asm
( "addx %g1, 0, %o2 " ); \

415 
	`asm
Ğ"šø 4, %o1 " );

	)

417 
	#MULADDC_STOP
 \

418 
	`asm
Ğ"¡ %%o2, %0 " : "=m" (
c
)); \

419 
	`asm
Ğ"¡ %%o1, %0 " : "=m" (
d
)); \

420 
	`asm
Ğ"¡ %%o0, %0 " : "=m" (
s
) :: \

421 "g1", "o0", "o1", "o2", "o3", "o4", "o5" );

	)

425 #ià
defšed
(
__miüobÏze__
è|| defšed(
miüobÏze
)

427 
	#MULADDC_INIT
 \

428 
	`asm
Ğ"lw˜„3, %0 " :: "m" (
s
)); \

429 
	`asm
Ğ"lw˜„4, %0 " :: "m" (
d
)); \

430 
	`asm
Ğ"lw˜„5, %0 " :: "m" (
c
)); \

431 
	`asm
Ğ"lw˜„6, %0 " :: "m" (
b
)); \

432 
	`asm
( "andi„7,„6, 0xffff" ); \

433 
	`asm
Ğ"b¤l˜r6,„6, 16 " );

	)

435 
	#MULADDC_CORE
 \

436 
	`asm
( "lhui„8,„3, 0 " ); \

437 
	`asm
( "addi„3,„3, 2 " ); \

438 
	`asm
( "lhui„9,„3, 0 " ); \

439 
	`asm
( "addi„3,„3, 2 " ); \

440 
	`asm
( "mul„10,„9,„6 " ); \

441 
	`asm
( "mul„11,„8,„7 " ); \

442 
	`asm
( "mul„12,„9,„7 " ); \

443 
	`asm
( "mul„13,„8,„6 " ); \

444 
	`asm
( "bsrli„8,„10, 16 " ); \

445 
	`asm
( "bsrli„9,„11, 16 " ); \

446 
	`asm
( "add„13,„13,„8 " ); \

447 
	`asm
( "add„13,„13,„9 " ); \

448 
	`asm
( "bslli„10,„10, 16 " ); \

449 
	`asm
( "bslli„11,„11, 16 " ); \

450 
	`asm
( "add„12,„12,„10 " ); \

451 
	`asm
( "addc„13,„13,„0 " ); \

452 
	`asm
( "add„12,„12,„11 " ); \

453 
	`asm
( "addc„13,„13,„0 " ); \

454 
	`asm
( "lwi„10,„4, 0 " ); \

455 
	`asm
( "add„12,„12,„10 " ); \

456 
	`asm
( "addc„13,„13,„0 " ); \

457 
	`asm
( "add„12,„12,„5 " ); \

458 
	`asm
( "addc„5,„13,„0 " ); \

459 
	`asm
( "swi„12,„4, 0 " ); \

460 
	`asm
Ğ"add˜„4,„4, 4 " );

	)

462 
	#MULADDC_STOP
 \

463 
	`asm
Ğ"sw˜„5, %0 " : "=m" (
c
)); \

464 
	`asm
Ğ"sw˜„4, %0 " : "=m" (
d
)); \

465 
	`asm
Ğ"sw˜„3, %0 " : "=m" (
s
) :: \

467 "r9", "r10", "r11", "r12", "r13" );

	)

471 #ià
defšed
(
__ŒicÜe__
)

473 
	#MULADDC_INIT
 \

474 
	`asm
Ğ"ld.¨ %%a2, %0 " :: "m" (
s
)); \

475 
	`asm
Ğ"ld.¨ %%a3, %0 " :: "m" (
d
)); \

476 
	`asm
Ğ"ld.w %%d4, %0 " :: "m" (
c
)); \

477 
	`asm
Ğ"ld.w %%d1, %0 " :: "m" (
b
)); \

478 
	`asm
Ğ"xÜ %d5, %d5 " );

	)

480 
	#MULADDC_CORE
 \

481 
	`asm
( "ld.w %d0, [%a2+] " ); \

482 
	`asm
( "madd.u %e2, %e4, %d0, %d1 " ); \

483 
	`asm
( "ld.w %d0, [%a3] " ); \

484 
	`asm
( "addx %d2, %d2, %d0 " ); \

485 
	`asm
( "addc %d3, %d3, 0 " ); \

486 
	`asm
( "mov %d4, %d3 " ); \

487 
	`asm
Ğ"¡.w [%a3+], %d2 " );

	)

489 
	#MULADDC_STOP
 \

490 
	`asm
Ğ"¡.w %0, %%d4 " : "=m" (
c
)); \

491 
	`asm
Ğ"¡.¨ %0, %%a3 " : "=m" (
d
)); \

492 
	`asm
Ğ"¡.¨ %0, %%a2 " : "=m" (
s
) :: \

493 "d0", "d1", "e2", "d4", "a2", "a3" );

	)

497 #ià
defšed
(
__¬m__
)

499 
	#MULADDC_INIT
 \

500 
	`asm
Ğ"ld¸„0, %0 " :: "m" (
s
)); \

501 
	`asm
Ğ"ld¸„1, %0 " :: "m" (
d
)); \

502 
	`asm
Ğ"ld¸„2, %0 " :: "m" (
c
)); \

503 
	`asm
Ğ"ld¸„3, %0 " :: "m" (
b
));

	)

505 
	#MULADDC_CORE
 \

506 
	`asm
( "ldr„4, [r0], #4 " ); \

507 
	`asm
( "mov„5, #0 " ); \

508 
	`asm
( "ldr„6, [r1] " ); \

509 
	`asm
( "umlal„2,„5,„3,„4 " ); \

510 
	`asm
( "adds„7,„6,„2 " ); \

511 
	`asm
( "adc„2,„5, #0 " ); \

512 
	`asm
Ğ"¡¸„7, [r1], #4 " );

	)

514 
	#MULADDC_STOP
 \

515 
	`asm
Ğ"¡¸„2, %0 " : "=m" (
c
)); \

516 
	`asm
Ğ"¡¸„1, %0 " : "=m" (
d
)); \

517 
	`asm
Ğ"¡¸„0, %0 " : "=m" (
s
) :: \

518 "r0", "r1", "r2", "r3", "r4", "r5", "r6", "r7" );

	)

522 #ià
defšed
(
__®pha__
)

524 
	#MULADDC_INIT
 \

525 
	`asm
Ğ"ldq $1, %0 " :: "m" (
s
)); \

526 
	`asm
Ğ"ldq $2, %0 " :: "m" (
d
)); \

527 
	`asm
Ğ"ldq $3, %0 " :: "m" (
c
)); \

528 
	`asm
Ğ"ldq $4, %0 " :: "m" (
b
));

	)

530 
	#MULADDC_CORE
 \

531 
	`asm
( "ldq $6, 0($1) " ); \

532 
	`asm
( "addq $1, 8, $1 " ); \

533 
	`asm
( "mulq $6, $4, $7 " ); \

534 
	`asm
( "umulh $6, $4, $6 " ); \

535 
	`asm
( "addq $7, $3, $7 " ); \

536 
	`asm
( "cmpult $7, $3, $3 " ); \

537 
	`asm
( "ldq $5, 0($2) " ); \

538 
	`asm
( "addq $7, $5, $7 " ); \

539 
	`asm
( "cmpult $7, $5, $5 " ); \

540 
	`asm
( "stq $7, 0($2) " ); \

541 
	`asm
( "addq $2, 8, $2 " ); \

542 
	`asm
( "addq $6, $3, $3 " ); \

543 
	`asm
Ğ"addq $5, $3, $3 " );

	)

545 
	#MULADDC_STOP
 \

546 
	`asm
Ğ"¡q $3, %0 " : "=m" (
c
)); \

547 
	`asm
Ğ"¡q $2, %0 " : "=m" (
d
)); \

548 
	`asm
Ğ"¡q $1, %0 " : "=m" (
s
) :: \

549 "$1", "$2", "$3", "$4", "$5", "$6", "$7" );

	)

553 #ià
defšed
(
__ms__
)

555 
	#MULADDC_INIT
 \

556 
	`asm
Ğ"lw $10, %0 " :: "m" (
s
)); \

557 
	`asm
Ğ"lw $11, %0 " :: "m" (
d
)); \

558 
	`asm
Ğ"lw $12, %0 " :: "m" (
c
)); \

559 
	`asm
Ğ"lw $13, %0 " :: "m" (
b
));

	)

561 
	#MULADDC_CORE
 \

562 
	`asm
( "lw $14, 0($10) " ); \

563 
	`asm
( "multu $13, $14 " ); \

564 
	`asm
( "addi $10, $10, 4 " ); \

565 
	`asm
( "mflo $14 " ); \

566 
	`asm
( "mfhi $9 " ); \

567 
	`asm
( "addu $14, $12, $14 " ); \

568 
	`asm
( "lw $15, 0($11) " ); \

569 
	`asm
( "sltu $12, $14, $12 " ); \

570 
	`asm
( "addu $15, $14, $15 " ); \

571 
	`asm
( "sltu $14, $15, $14 " ); \

572 
	`asm
( "addu $12, $12, $9 " ); \

573 
	`asm
( "sw $15, 0($11) " ); \

574 
	`asm
( "addu $12, $12, $14 " ); \

575 
	`asm
Ğ"add˜ $11, $11, 4 " );

	)

577 
	#MULADDC_STOP
 \

578 
	`asm
Ğ"sw $12, %0 " : "=m" (
c
)); \

579 
	`asm
Ğ"sw $11, %0 " : "=m" (
d
)); \

580 
	`asm
Ğ"sw $10, %0 " : "=m" (
s
) :: \

581 "$9", "$10", "$11", "$12", "$13", "$14", "$15" );

	)

586 #ià(
defšed
(
_MSC_VER
è&& defšed(
_M_IX86
)è|| defšed(
__WATCOMC__
)

588 
	#MULADDC_INIT
 \

589 
__asm
 
mov
 
esi
, 
s
 \

590 
__asm
 
mov
 
edi
, 
d
 \

591 
__asm
 
mov
 
ecx
, 
c
 \

592 
__asm
 
mov
 
ebx
, 
b


	)

594 
	#MULADDC_CORE
 \

595 
__asm
 
lodsd
 \

596 
__asm
 
mul
 
ebx
 \

597 
__asm
 
add
 
—x
, 
ecx
 \

598 
__asm
 
adc
 
edx
, 0 \

599 
__asm
 
add
 
—x
, [
edi
] \

600 
__asm
 
adc
 
edx
, 0 \

601 
__asm
 
mov
 
ecx
, 
edx
 \

602 
__asm
 
¡osd


	)

604 #ià
defšed
(
POLARSSL_HAVE_SSE2
)

606 
	#EMIT
 
__asm
 
_em™


	)

608 
	#MULADDC_HUIT
 \

609 
EMIT
 0x0F EMIT 0x6E EMIT 0xC9 \

610 
EMIT
 0x0F EMIT 0x6E EMIT 0xC3 \

611 
EMIT
 0x0F EMIT 0x6E EMIT 0x1F \

612 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCB \

613 
EMIT
 0x0F EMIT 0x6E EMIT 0x16 \

614 
EMIT
 0x0F EMIT 0xF4 EMIT 0xD0 \

615 
EMIT
 0x0F EMIT 0x6E EMIT 0x66 EMIT 0x04 \

616 
EMIT
 0x0F EMIT 0xF4 EMIT 0xE0 \

617 
EMIT
 0x0F EMIT 0x6E EMIT 0x76 EMIT 0x08 \

618 
EMIT
 0x0F EMIT 0xF4 EMIT 0xF0 \

619 
EMIT
 0x0F EMIT 0x6E EMIT 0x7E EMIT 0x0C \

620 
EMIT
 0x0F EMIT 0xF4 EMIT 0xF8 \

621 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCA \

622 
EMIT
 0x0F EMIT 0x6E EMIT 0x5F EMIT 0x04 \

623 
EMIT
 0x0F EMIT 0xD4 EMIT 0xDC \

624 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x08 \

625 
EMIT
 0x0F EMIT 0xD4 EMIT 0xEE \

626 
EMIT
 0x0F EMIT 0x6E EMIT 0x67 EMIT 0x0C \

627 
EMIT
 0x0F EMIT 0xD4 EMIT 0xFC \

628 
EMIT
 0x0F EMIT 0x7E EMIT 0x0F \

629 
EMIT
 0x0F EMIT 0x6E EMIT 0x56 EMIT 0x10 \

630 
EMIT
 0x0F EMIT 0xF4 EMIT 0xD0 \

631 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

632 
EMIT
 0x0F EMIT 0x6E EMIT 0x66 EMIT 0x14 \

633 
EMIT
 0x0F EMIT 0xF4 EMIT 0xE0 \

634 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCB \

635 
EMIT
 0x0F EMIT 0x6E EMIT 0x76 EMIT 0x18 \

636 
EMIT
 0x0F EMIT 0xF4 EMIT 0xF0 \

637 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x04 \

638 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

639 
EMIT
 0x0F EMIT 0x6E EMIT 0x5E EMIT 0x1C \

640 
EMIT
 0x0F EMIT 0xF4 EMIT 0xD8 \

641 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCD \

642 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x10 \

643 
EMIT
 0x0F EMIT 0xD4 EMIT 0xD5 \

644 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x08 \

645 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

646 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCF \

647 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x14 \

648 
EMIT
 0x0F EMIT 0xD4 EMIT 0xE5 \

649 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x0C \

650 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

651 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCA \

652 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x18 \

653 
EMIT
 0x0F EMIT 0xD4 EMIT 0xF5 \

654 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x10 \

655 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

656 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCC \

657 
EMIT
 0x0F EMIT 0x6E EMIT 0x6F EMIT 0x1C \

658 
EMIT
 0x0F EMIT 0xD4 EMIT 0xDD \

659 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x14 \

660 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

661 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCE \

662 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x18 \

663 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

664 
EMIT
 0x0F EMIT 0xD4 EMIT 0xCB \

665 
EMIT
 0x0F EMIT 0x7E EMIT 0x4F EMIT 0x1C \

666 
EMIT
 0x83 EMIT 0xC7 EMIT 0x20 \

667 
EMIT
 0x83 EMIT 0xC6 EMIT 0x20 \

668 
EMIT
 0x0F EMIT 0x73 EMIT 0xD1 EMIT 0x20 \

669 
EMIT
 0x0F EMIT 0x7E EMIT 0xC9

	)

671 
	#MULADDC_STOP
 \

672 
EMIT
 0x0F EMIT 0x77 \

673 
__asm
 
mov
 
c
, 
ecx
 \

674 
__asm
 
mov
 
d
, 
edi
 \

675 
__asm
 
mov
 
s
, 
esi
 \

676 

	)

679 
	#MULADDC_STOP
 \

680 
__asm
 
mov
 
c
, 
ecx
 \

681 
__asm
 
mov
 
d
, 
edi
 \

682 
__asm
 
mov
 
s
, 
esi
 \

683 

	)

689 #ià!
defšed
(
MULADDC_CORE
)

690 #ià
defšed
(
POLARSSL_HAVE_LONGLONG
)

692 
	#MULADDC_INIT
 \

694 
t_dbl
 
r
; \

695 
t_št
 
r0
, 
r1
;

	)

697 
	#MULADDC_CORE
 \

698 
r
 = *(
s
++è* (
t_dbl
è
b
; \

699 
r0
 = 
r
; \

700 
r1
 = 
r
 >> 
biL
; \

701 
r0
 +ğ
c
; 
r1
 += (r0 < c); \

702 
r0
 +ğ*
d
; 
r1
 += (r0 < *d); \

703 
c
 = 
r1
; *(
d
++èğ
r0
;

	)

705 
	#MULADDC_STOP
 \

706 }

	)

709 
	#MULADDC_INIT
 \

711 
t_št
 
s0
, 
s1
, 
b0
, 
b1
; \

712 
t_št
 
r0
, 
r1
, 
rx
, 
ry
; \

713 
b0
 = ( 
b
 << 
biH
 ) >> biH; \

714 
b1
 = ( 
b
 >> 
biH
 );

	)

716 
	#MULADDC_CORE
 \

717 
s0
 = ( *
s
 << 
biH
 ) >> biH; \

718 
s1
 = ( *
s
 >> 
biH
 ); s++; \

719 
rx
 = 
s0
 * 
b1
; 
r0
 = s0 * 
b0
; \

720 
ry
 = 
s1
 * 
b0
; 
r1
 = s1 * 
b1
; \

721 
r1
 +ğĞ
rx
 >> 
biH
 ); \

722 
r1
 +ğĞ
ry
 >> 
biH
 ); \

723 
rx
 <<ğ
biH
; 
ry
 <<= biH; \

724 
r0
 +ğ
rx
; 
r1
 += (r0 <„x); \

725 
r0
 +ğ
ry
; 
r1
 += (r0 <„y); \

726 
r0
 +ğ
c
; 
r1
 += (r0 < c); \

727 
r0
 +ğ*
d
; 
r1
 += (r0 < *d); \

728 
c
 = 
r1
; *(
d
++èğ
r0
;

	)

730 
	#MULADDC_STOP
 \

731 }

	)

	@tools/src/polarssl/camellia.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

36 
	~"pŞ¬s¦/ÿm–lŸ.h
"

38 
	~<¡ršg.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

63 cÚ¡ 
	gSIGMA_CHARS
[6][8] =

73 #ifdeà
POLARSSL_CAMELLIA_SMALL_MEMORY


75 cÚ¡ 
	gFSb
[256] =

95 
	#SBOX1
(
n
è
FSb
[Ò)]

	)

96 
	#SBOX2
(
n
è()((
FSb
[Ò)] >> 7 ^ FSb[Ò)] << 1è& 0xff)

	)

97 
	#SBOX3
(
n
è()((
FSb
[Ò)] >> 1 ^ FSb[Ò)] << 7è& 0xff)

	)

98 
	#SBOX4
(
n
è
FSb
[(Òè<< 1 ^ (nè>> 7è&0xff]

	)

102 cÚ¡ 
	gFSb
[256] =

122 cÚ¡ 
	gFSb2
[256] =

142 cÚ¡ 
	gFSb3
[256] =

162 cÚ¡ 
	gFSb4
[256] =

182 
	#SBOX1
(
n
è
FSb
[Ò)]

	)

183 
	#SBOX2
(
n
è
FSb2
[Ò)]

	)

184 
	#SBOX3
(
n
è
FSb3
[Ò)]

	)

185 
	#SBOX4
(
n
è
FSb4
[Ò)]

	)

189 cÚ¡ 
	gshiás
[2][4][4] =

205 cÚ¡ sigÃd 
	gšdexes
[2][4][20] =

229 cÚ¡ sigÃd 
	gŒª¥o£s
[2][20] =

248 
	#ROTL
(
DEST
, 
SRC
, 
SHIFT
) \

250 (
DEST
)[0] = (
SRC
)[0] << (
SHIFT
) ^ (SRC)[1] >> (32 - (SHIFT)); \

251 (
DEST
)[1] = (
SRC
)[1] << (
SHIFT
) ^ (SRC)[2] >> (32 - (SHIFT)); \

252 (
DEST
)[2] = (
SRC
)[2] << (
SHIFT
) ^ (SRC)[3] >> (32 - (SHIFT)); \

253 (
DEST
)[3] = (
SRC
)[3] << (
SHIFT
) ^ (SRC)[0] >> (32 - (SHIFT)); \

254 }

	)

256 
	#FL
(
XL
, 
XR
, 
KL
, 
KR
) \

258 (
XR
èğ((((
XL
è& (
KL
)) << 1) | (((XL) & (KL)) >> 31)) ^ (XR); \

259 (
XL
èğ((
XR
è| (
KR
)) ^ (XL); \

260 }

	)

262 
	#FLInv
(
YL
, 
YR
, 
KL
, 
KR
) \

264 (
YL
èğ((
YR
è| (
KR
)) ^ (YL); \

265 (
YR
èğ((((
YL
è& (
KL
)) << 1) | (((YL) & (KL)) >> 31)) ^ (YR); \

266 }

	)

268 
	#SHIFT_AND_PLACE
(
INDEX
, 
OFFSET
) \

270 
TK
[0] = 
KC
[(
OFFSET
) * 4 + 0]; \

271 
TK
[1] = 
KC
[(
OFFSET
) * 4 + 1]; \

272 
TK
[2] = 
KC
[(
OFFSET
) * 4 + 2]; \

273 
TK
[3] = 
KC
[(
OFFSET
) * 4 + 3]; \

275  
i
 = 1; i <= 4; i++ ) \

276 ià(
shiás
[(
INDEX
)][(
OFFSET
)][
i
 -1]) \

277 
	`ROTL
(
TK
 + 
i
 * 4, TK, (15 * i) % 32); \

279  
i
 = 0; i < 20; i++ ) \

280 ià(
šdexes
[(
INDEX
)][(
OFFSET
)][
i
] != -1) { \

281 
RK
[
šdexes
[(
INDEX
)][(
OFFSET
)][
i
]] = 
TK
[ i ]; \

283 }

	)

285 
	$ÿm–lŸ_ãi¡–
(cÚ¡ 
ušt32_t
 
x
[2], cÚ¡ ušt32_ˆ
k
[2], ušt32_ˆ
z
[2])

287 
ušt32_t
 
I0
, 
I1
;

288 
I0
 = 
x
[0] ^ 
k
[0];

289 
I1
 = 
x
[1] ^ 
k
[1];

291 
I0
 = (
	`SBOX1
((I0 >> 24) & 0xFF) << 24) |

292 (
	`SBOX2
((
I0
 >> 16) & 0xFF) << 16) |

293 (
	`SBOX3
((
I0
 >> 8) & 0xFF) << 8) |

294 (
	`SBOX4
((
I0
 ) & 0xFF) );

295 
I1
 = (
	`SBOX2
((I1 >> 24) & 0xFF) << 24) |

296 (
	`SBOX3
((
I1
 >> 16) & 0xFF) << 16) |

297 (
	`SBOX4
((
I1
 >> 8) & 0xFF) << 8) |

298 (
	`SBOX1
((
I1
 ) & 0xFF) );

300 
I0
 ^ğ(
I1
 << 8) | (I1 >> 24);

301 
I1
 ^ğ(
I0
 << 16) | (I0 >> 16);

302 
I0
 ^ğ(
I1
 >> 8) | (I1 << 24);

303 
I1
 ^ğ(
I0
 >> 8) | (I0 << 24);

305 
z
[0] ^ğ
I1
;

306 
z
[1] ^ğ
I0
;

307 
	}
}

312 
	$ÿm–lŸ_£tkey_’c
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

314 
i
, 
idx
;

315 
ušt32_t
 *
RK
;

316 
t
[64];

317 
ušt32_t
 
SIGMA
[6][2];

318 
ušt32_t
 
KC
[16];

319 
ušt32_t
 
TK
[20];

321 
RK
 = 
ùx
->
rk
;

323 
	`mem£t
(
t
, 0, 64);

324 
	`mem£t
(
RK
, 0, (
ùx
->
rk
));

326  
keysize
 )

328 128: 
ùx
->
Ä
 = 3; 
idx
 = 0; ;

330 256: 
ùx
->
Ä
 = 4; 
idx
 = 1; ;

331  : Ğ
POLARSSL_ERR_CAMELLIA_INVALID_KEY_LENGTH
 );

334  
i
 = 0; i < 
keysize
 / 8; ++i)

335 
t
[
i
] = 
key
[i];

337 ià(
keysize
 == 192) {

338 
i
 = 0; i < 8; i++)

339 
t
[24 + 
i
] = ~t[16 + i];

345 
i
 = 0; i < 6; i++) {

346 
	`GET_ULONG_BE
(
SIGMA
[
i
][0], 
SIGMA_CHARS
[i], 0);

347 
	`GET_ULONG_BE
(
SIGMA
[
i
][1], 
SIGMA_CHARS
[i], 4);

354 
	`mem£t
(
KC
, 0, (KC));

357 
i
 = 0; i < 8; i++)

358 
	`GET_ULONG_BE
(
KC
[
i
], 
t
, i * 4);

361  
i
 = 0; i < 4; ++i)

362 
KC
[8 + 
i
] = KC[i] ^ KC[4 + i];

364 
	`ÿm–lŸ_ãi¡–
(
KC
 + 8, 
SIGMA
[0], KC + 10);

365 
	`ÿm–lŸ_ãi¡–
(
KC
 + 10, 
SIGMA
[1], KC + 8);

367  
i
 = 0; i < 4; ++i)

368 
KC
[8 + 
i
] ^= KC[i];

370 
	`ÿm–lŸ_ãi¡–
(
KC
 + 8, 
SIGMA
[2], KC + 10);

371 
	`ÿm–lŸ_ãi¡–
(
KC
 + 10, 
SIGMA
[3], KC + 8);

373 ià(
keysize
 > 128) {

375  
i
 = 0; i < 4; ++i)

376 
KC
[12 + 
i
] = KC[4 + i] ^ KC[8 + i];

378 
	`ÿm–lŸ_ãi¡–
(
KC
 + 12, 
SIGMA
[4], KC + 14);

379 
	`ÿm–lŸ_ãi¡–
(
KC
 + 14, 
SIGMA
[5], KC + 12);

387 
	`SHIFT_AND_PLACE
(
idx
, 0);

390 ià(
keysize
 > 128) {

391 
	`SHIFT_AND_PLACE
(
idx
, 1);

395 
	`SHIFT_AND_PLACE
(
idx
, 2);

398 ià(
keysize
 > 128) {

399 
	`SHIFT_AND_PLACE
(
idx
, 3);

403  
i
 = 0; i < 20; i++ ) {

404 ià(
Œª¥o£s
[
idx
][
i
] != -1) {

405 
RK
[32 + 12 * 
idx
 + 
i
] = RK[
Œª¥o£s
[idx][i]];

410 
	}
}

415 
	$ÿm–lŸ_£tkey_dec
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 )

417 
i
, 
idx
;

418 
ÿm–lŸ_cÚ‹xt
 
ùy
;

419 
ušt32_t
 *
RK
;

420 
ušt32_t
 *
SK
;

421 
»t
;

423  
keysize
 )

425 128: 
ùx
->
Ä
 = 3; 
idx
 = 0; ;

427 256: 
ùx
->
Ä
 = 4; 
idx
 = 1; ;

428  : Ğ
POLARSSL_ERR_CAMELLIA_INVALID_KEY_LENGTH
 );

431 
RK
 = 
ùx
->
rk
;

433 
»t
 = 
	`ÿm–lŸ_£tkey_’c
(&
ùy
, 
key
, 
keysize
);

434 ifĞ
»t
 != 0 )

435 Ğ
»t
 );

437 
SK
 = 
ùy
.
rk
 + 24 * 2 + 8 * 
idx
 * 2;

439 *
RK
++ = *
SK
++;

440 *
RK
++ = *
SK
++;

441 *
RK
++ = *
SK
++;

442 *
RK
++ = *
SK
++;

444 
i
 = 22 + 8 * 
idx
, 
SK
 -= 6; i > 0; i--, SK -= 4)

446 *
RK
++ = *
SK
++;

447 *
RK
++ = *
SK
++;

450 
SK
 -= 2;

452 *
RK
++ = *
SK
++;

453 *
RK
++ = *
SK
++;

454 *
RK
++ = *
SK
++;

455 *
RK
++ = *
SK
++;

457 
	`mem£t
Ğ&
ùy
, 0, Ğ
ÿm–lŸ_cÚ‹xt
 ) );

460 
	}
}

465 
	$ÿm–lŸ_üy±_ecb
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

466 
mode
,

467 cÚ¡ 
šput
[16],

468 
ouut
[16] )

470 
NR
;

471 
ušt32_t
 *
RK
, 
X
[4];

473 Ğ(è
mode
 );

475 
NR
 = 
ùx
->
Ä
;

476 
RK
 = 
ùx
->
rk
;

478 
	`GET_ULONG_BE
Ğ
X
[0], 
šput
, 0 );

479 
	`GET_ULONG_BE
Ğ
X
[1], 
šput
, 4 );

480 
	`GET_ULONG_BE
Ğ
X
[2], 
šput
, 8 );

481 
	`GET_ULONG_BE
Ğ
X
[3], 
šput
, 12 );

483 
X
[0] ^ğ*
RK
++;

484 
X
[1] ^ğ*
RK
++;

485 
X
[2] ^ğ*
RK
++;

486 
X
[3] ^ğ*
RK
++;

488 
NR
) {

489 --
NR
;

490 
	`ÿm–lŸ_ãi¡–
(
X
, 
RK
, X + 2);

491 
RK
 += 2;

492 
	`ÿm–lŸ_ãi¡–
(
X
 + 2, 
RK
, X);

493 
RK
 += 2;

494 
	`ÿm–lŸ_ãi¡–
(
X
, 
RK
, X + 2);

495 
RK
 += 2;

496 
	`ÿm–lŸ_ãi¡–
(
X
 + 2, 
RK
, X);

497 
RK
 += 2;

498 
	`ÿm–lŸ_ãi¡–
(
X
, 
RK
, X + 2);

499 
RK
 += 2;

500 
	`ÿm–lŸ_ãi¡–
(
X
 + 2, 
RK
, X);

501 
RK
 += 2;

503 ià(
NR
) {

504 
	`FL
(
X
[0], X[1], 
RK
[0], RK[1]);

505 
RK
 += 2;

506 
	`FLInv
(
X
[2], X[3], 
RK
[0], RK[1]);

507 
RK
 += 2;

511 
X
[2] ^ğ*
RK
++;

512 
X
[3] ^ğ*
RK
++;

513 
X
[0] ^ğ*
RK
++;

514 
X
[1] ^ğ*
RK
++;

516 
	`PUT_ULONG_BE
Ğ
X
[2], 
ouut
, 0 );

517 
	`PUT_ULONG_BE
Ğ
X
[3], 
ouut
, 4 );

518 
	`PUT_ULONG_BE
Ğ
X
[0], 
ouut
, 8 );

519 
	`PUT_ULONG_BE
Ğ
X
[1], 
ouut
, 12 );

522 
	}
}

527 
	$ÿm–lŸ_üy±_cbc
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

528 
mode
,

529 
Ëngth
,

530 
iv
[16],

531 cÚ¡ *
šput
,

532 *
ouut
 )

534 
i
;

535 
‹mp
[16];

537 ifĞ
Ëngth
 % 16 )

538 Ğ
POLARSSL_ERR_CAMELLIA_INVALID_INPUT_LENGTH
 );

540 ifĞ
mode
 =ğ
CAMELLIA_DECRYPT
 )

542  
Ëngth
 > 0 )

544 
	`memıy
Ğ
‹mp
, 
šput
, 16 );

545 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
mode
, 
šput
, 
ouut
 );

547  
i
 = 0; i < 16; i++ )

548 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

550 
	`memıy
Ğ
iv
, 
‹mp
, 16 );

552 
šput
 += 16;

553 
ouut
 += 16;

554 
Ëngth
 -= 16;

559  
Ëngth
 > 0 )

561  
i
 = 0; i < 16; i++ )

562 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

564 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
mode
, 
ouut
, output );

565 
	`memıy
Ğ
iv
, 
ouut
, 16 );

567 
šput
 += 16;

568 
ouut
 += 16;

569 
Ëngth
 -= 16;

574 
	}
}

579 
	$ÿm–lŸ_üy±_cfb128
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

580 
mode
,

581 
Ëngth
,

582 *
iv_off
,

583 
iv
[16],

584 cÚ¡ *
šput
,

585 *
ouut
 )

587 
c
, 
n
 = *
iv_off
;

589 ifĞ
mode
 =ğ
CAMELLIA_DECRYPT
 )

591  
Ëngth
-- )

593 ifĞ
n
 == 0 )

594 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
CAMELLIA_ENCRYPT
, 
iv
, iv );

596 
c
 = *
šput
++;

597 *
ouut
++ = ()Ğ
c
 ^ 
iv
[
n
] );

598 
iv
[
n
] = (è
c
;

600 
n
 = (n + 1) & 0x0F;

605  
Ëngth
-- )

607 ifĞ
n
 == 0 )

608 
	`ÿm–lŸ_üy±_ecb
Ğ
ùx
, 
CAMELLIA_ENCRYPT
, 
iv
, iv );

610 
iv
[
n
] = *
ouut
++ = ()Ğiv[n] ^ *
šput
++ );

612 
n
 = (n + 1) & 0x0F;

616 *
iv_off
 = 
n
;

619 
	}
}

621 #ià
defšed
(
POLARSSL_SELF_TEST
)

623 
	~<¡dio.h
>

633 
	#CAMELLIA_TESTS_ECB
 2

	)

635 cÚ¡ 
	gÿm–lŸ_‹¡_ecb_key
[3][
CAMELLIA_TESTS_ECB
][32] =

663 cÚ¡ 
	gÿm–lŸ_‹¡_ecb_¶aš
[
CAMELLIA_TESTS_ECB
][16] =

671 cÚ¡ 
	gÿm–lŸ_‹¡_ecb_ch”
[3][
CAMELLIA_TESTS_ECB
][16] =

693 
	#CAMELLIA_TESTS_CBC
 3

	)

695 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_key
[3][32] =

710 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_iv
[16] =

716 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_¶aš
[
CAMELLIA_TESTS_CBC
][16] =

727 cÚ¡ 
	gÿm–lŸ_‹¡_cbc_ch”
[3][
CAMELLIA_TESTS_CBC
][16] =

759 
	$ÿm–lŸ_£lf_‹¡
Ğ
v”bo£
 )

761 
i
, 
j
, 
u
, 
v
;

762 
key
[32];

763 
buf
[64];

764 
¤c
[16];

765 
d¡
[16];

766 
iv
[16];

767 
ÿm–lŸ_cÚ‹xt
 
ùx
;

769 
	`mem£t
Ğ
key
, 0, 32 );

771 
j
 = 0; j < 6; j++) {

772 
u
 = 
j
 >> 1;

773 
v
 = 
j
 & 1;

775 ifĞ
v”bo£
 != 0 )

776 
	`´štf
Ğ" CAMELLIA-ECB-%3d (%s): ", 128 + 
u
 * 64,

777 (
v
 =ğ
CAMELLIA_DECRYPT
) ? "dec" : "enc");

779 
i
 = 0; i < 
CAMELLIA_TESTS_ECB
; i++ ) {

780 
	`memıy
Ğ
key
, 
ÿm–lŸ_‹¡_ecb_key
[
u
][
i
], 16 + 8 * u);

782 ià(
v
 =ğ
CAMELLIA_DECRYPT
) {

783 
	`ÿm–lŸ_£tkey_dec
(&
ùx
, 
key
, 128 + 
u
 * 64);

784 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_ecb_ch”
[
u
][
i
], 16);

785 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_ecb_¶aš
[
i
], 16);

787 
	`ÿm–lŸ_£tkey_’c
(&
ùx
, 
key
, 128 + 
u
 * 64);

788 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_ecb_¶aš
[
i
], 16);

789 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_ecb_ch”
[
u
][
i
], 16);

792 
	`ÿm–lŸ_üy±_ecb
(&
ùx
, 
v
, 
¤c
, 
buf
);

794 ifĞ
	`memcmp
Ğ
buf
, 
d¡
, 16 ) != 0 )

796 ifĞ
v”bo£
 != 0 )

797 
	`´štf
( "failed\n" );

803 ifĞ
v”bo£
 != 0 )

804 
	`´štf
( "passed\n" );

807 ifĞ
v”bo£
 != 0 )

808 
	`´štf
( "\n" );

813  
j
 = 0; j < 6; j++ )

815 
u
 = 
j
 >> 1;

816 
v
 = 
j
 & 1;

818 ifĞ
v”bo£
 != 0 )

819 
	`´štf
Ğ" CAMELLIA-CBC-%3d (%s): ", 128 + 
u
 * 64,

820 Ğ
v
 =ğ
CAMELLIA_DECRYPT
 ) ? "dec" : "enc" );

822 
	`memıy
Ğ
¤c
, 
ÿm–lŸ_‹¡_cbc_iv
, 16);

823 
	`memıy
Ğ
d¡
, 
ÿm–lŸ_‹¡_cbc_iv
, 16);

824 
	`memıy
Ğ
key
, 
ÿm–lŸ_‹¡_cbc_key
[
u
], 16 + 8 * u);

826 ià(
v
 =ğ
CAMELLIA_DECRYPT
) {

827 
	`ÿm–lŸ_£tkey_dec
(&
ùx
, 
key
, 128 + 
u
 * 64);

829 
	`ÿm–lŸ_£tkey_’c
(&
ùx
, 
key
, 128 + 
u
 * 64);

832 
i
 = 0; i < 
CAMELLIA_TESTS_CBC
; i++ ) {

834 ià(
v
 =ğ
CAMELLIA_DECRYPT
) {

835 
	`memıy
Ğ
iv
 , 
¤c
, 16 );

836 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_cbc_ch”
[
u
][
i
], 16);

837 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_cbc_¶aš
[
i
], 16);

839 
	`memıy
Ğ
iv
 , 
d¡
, 16 );

840 
	`memıy
(
¤c
, 
ÿm–lŸ_‹¡_cbc_¶aš
[
i
], 16);

841 
	`memıy
(
d¡
, 
ÿm–lŸ_‹¡_cbc_ch”
[
u
][
i
], 16);

844 
	`ÿm–lŸ_üy±_cbc
(&
ùx
, 
v
, 16, 
iv
, 
¤c
, 
buf
);

846 ifĞ
	`memcmp
Ğ
buf
, 
d¡
, 16 ) != 0 )

848 ifĞ
v”bo£
 != 0 )

849 
	`´štf
( "failed\n" );

855 ifĞ
v”bo£
 != 0 )

856 
	`´štf
( "passed\n" );

859 ifĞ
v”bo£
 != 0 )

860 
	`´štf
( "\n" );

863 
	}
}

	@tools/src/polarssl/camellia.h

25 #iâdeà
POLARSSL_CAMELLIA_H


26 
	#POLARSSL_CAMELLIA_H


	)

28 #ifdeà
_MSC_VER


29 
	~<ba£tsd.h
>

30 
UINT32
 
	tušt32_t
;

32 
	~<š‰y³s.h
>

35 
	#CAMELLIA_ENCRYPT
 1

	)

36 
	#CAMELLIA_DECRYPT
 0

	)

38 
	#POLARSSL_ERR_CAMELLIA_INVALID_KEY_LENGTH
 -0x0a00

	)

39 
	#POLARSSL_ERR_CAMELLIA_INVALID_INPUT_LENGTH
 -0x0a10

	)

46 
	mÄ
;

47 
ušt32_t
 
	mrk
[68];

49 
	tÿm–lŸ_cÚ‹xt
;

51 #ifdeà
__ılu¥lus


64 
ÿm–lŸ_£tkey_’c
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

75 
ÿm–lŸ_£tkey_dec
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keysize
 );

87 
ÿm–lŸ_üy±_ecb
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

88 
mode
,

89 cÚ¡ 
šput
[16],

90 
ouut
[16] );

106 
ÿm–lŸ_üy±_cbc
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

107 
mode
,

108 
Ëngth
,

109 
iv
[16],

110 cÚ¡ *
šput
,

111 *
ouut
 );

126 
ÿm–lŸ_üy±_cfb128
Ğ
ÿm–lŸ_cÚ‹xt
 *
ùx
,

127 
mode
,

128 
Ëngth
,

129 *
iv_off
,

130 
iv
[16],

131 cÚ¡ *
šput
,

132 *
ouut
 );

139 
ÿm–lŸ_£lf_‹¡
Ğ
v”bo£
 );

141 #ifdeà
__ılu¥lus


	@tools/src/polarssl/certs.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_CERTS_C
)

30 cÚ¡ 
	g‹¡_ÿ_üt
[] =

53 cÚ¡ 
	g‹¡_ÿ_key
[] =

85 cÚ¡ 
	g‹¡_ÿ_pwd
[] = "PolarSSLTest";

87 cÚ¡ 
	g‹¡_¤v_üt
[] =

109 cÚ¡ 
	g‹¡_¤v_key
[] =

138 cÚ¡ 
	g‹¡_şi_üt
[] =

160 cÚ¡ 
	g‹¡_şi_key
[] =

	@tools/src/polarssl/certs.h

25 #iâdeà
POLARSSL_CERTS_H


26 
	#POLARSSL_CERTS_H


	)

28 #ifdeà
__ılu¥lus


32 cÚ¡ 
‹¡_ÿ_üt
[];

33 cÚ¡ 
‹¡_ÿ_key
[];

34 cÚ¡ 
‹¡_ÿ_pwd
[];

35 cÚ¡ 
‹¡_¤v_üt
[];

36 cÚ¡ 
‹¡_¤v_key
[];

37 cÚ¡ 
‹¡_şi_üt
[];

38 cÚ¡ 
‹¡_şi_key
[];

40 #ifdeà
__ılu¥lus


	@tools/src/polarssl/config.h

29 #iâdeà
POLARSSL_CONFIG_H


30 
	#POLARSSL_CONFIG_H


	)

32 #iâdeà
_CRT_SECURE_NO_DEPRECATE


33 
	#_CRT_SECURE_NO_DEPRECATE
 1

	)

65 
	#POLARSSL_HAVE_ASM


	)

76 
	#POLARSSL_DEBUG_MSG


	)

81 
	#POLARSSL_SELF_TEST


	)

86 
	#POLARSSL_VERSION_C


	)

91 
	#POLARSSL_GENPRIME


	)

108 
	#POLARSSL_AES_C


	)

118 
	#POLARSSL_ARC4_C


	)

126 
	#POLARSSL_BASE64_C


	)

137 
	#POLARSSL_BIGNUM_C


	)

148 
	#POLARSSL_CAMELLIA_C


	)

156 
	#POLARSSL_CERTS_C


	)

166 
	#POLARSSL_DEBUG_C


	)

176 
	#POLARSSL_DES_C


	)

188 
	#POLARSSL_DHM_C


	)

196 
	#POLARSSL_HAVEGE_C


	)

223 
	#POLARSSL_MD5_C


	)

231 
	#POLARSSL_NET_C


	)

239 
	#POLARSSL_PADLOCK_C


	)

250 
	#POLARSSL_RSA_C


	)

261 
	#POLARSSL_SHA1_C


	)

269 
	#POLARSSL_SHA2_C


	)

277 
	#POLARSSL_SHA4_C


	)

285 
	#POLARSSL_SSL_CLI_C


	)

293 
	#POLARSSL_SSL_SRV_C


	)

302 
	#POLARSSL_SSL_TLS_C


	)

310 
	#POLARSSL_TIMING_C


	)

320 
	#POLARSSL_X509_PARSE_C


	)

328 
	#POLARSSL_X509_WRITE_C


	)

334 
	#POLARSSL_XTEA_C


	)

	@tools/src/polarssl/debug.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_DEBUG_C
)

30 
	~"pŞ¬s¦/debug.h
"

32 
	~<¡d¬g.h
>

33 
	~<¡dlib.h
>

35 #ià
defšed
 
_MSC_VER
 && !defšed 
¢´štf


36 
	#¢´štf
 
_¢´štf


	)

39 #ià
defšed
 
_MSC_VER
 && !defšed 
v¢´štf


40 
	#v¢´štf
 
_v¢´štf


	)

43 *
	$debug_fmt
ĞcÚ¡ *
fÜm©
, ... )

45 
va_li¡
 
¬gp
;

46 
¡r
[512];

47 
maxËn
 = Ğ
¡r
 ) - 1;

49 
	`va_¡¬t
Ğ
¬gp
, 
fÜm©
 );

50 
	`v¢´štf
Ğ
¡r
, 
maxËn
, 
fÜm©
, 
¬gp
 );

51 
	`va_’d
Ğ
¬gp
 );

53 
¡r
[
maxËn
] = '\0';

54 Ğ
¡r
 );

55 
	}
}

57 
	$debug_´št_msg
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

58 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
 )

60 
¡r
[512];

61 
maxËn
 = Ğ
¡r
 ) - 1;

63 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 )

66 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %s\n", 
fe
, 
lše
, 
‹xt
 );

67 
¡r
[
maxËn
] = '\0';

68 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

69 
	}
}

71 
	$debug_´št_»t
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

72 cÚ¡ *
fe
, 
lše
,

73 cÚ¡ *
‹xt
, 
»t
 )

75 
¡r
[512];

76 
maxËn
 = Ğ
¡r
 ) - 1;

78 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 )

81 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %s()„eturned %d (0x%x)\n",

82 
fe
, 
lše
, 
‹xt
, 
»t
,„et );

84 
¡r
[
maxËn
] = '\0';

85 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

86 
	}
}

88 
	$debug_´št_buf
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

89 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
,

90 *
buf
, 
Ën
 )

92 
¡r
[512];

93 
i
, 
maxËn
 = Ğ
¡r
 ) - 1;

95 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 || 
Ën
 < 0 )

98 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): dumping '%s' (%d bytes)\n",

99 
fe
, 
lše
, 
‹xt
, 
Ën
 );

101 
¡r
[
maxËn
] = '\0';

102 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

104  
i
 = 0; i < 
Ën
; i++ )

106 ifĞ
i
 >= 4096 )

109 ifĞ
i
 % 16 == 0 )

111 ifĞ
i
 > 0 )

112 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

114 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %04x: ", 
fe
, 
lše
, 
i
 );

116 
¡r
[
maxËn
] = '\0';

117 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

120 
	`¢´štf
Ğ
¡r
, 
maxËn
, " %02x", (è
buf
[
i
] );

122 
¡r
[
maxËn
] = '\0';

123 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

126 ifĞ
Ën
 > 0 )

127 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

128 
	}
}

130 
	$debug_´št_mpi
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

131 cÚ¡ *
fe
, 
lše
,

132 cÚ¡ *
‹xt
, cÚ¡ 
mpi
 *
X
 )

134 
¡r
[512];

135 
i
, 
j
, 
k
, 
n
, 
maxËn
 = Ğ
¡r
 ) - 1;

137 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 || 
X
 == NULL )

140  
n
 = 
X
->n - 1;‚ >= 0;‚-- )

141 ifĞ
X
->
p
[
n
] != 0 )

144 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): value of '%s' (%lu bits) is:\n",

145 
fe
, 
lše
, 
‹xt
,

146 (è((
n
 + 1è* Ğ
t_št
 )) << 3 );

148 
¡r
[
maxËn
] = '\0';

149 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

151  
i
 = 
n
, 
j
 = 0; i >= 0; i--, j++ )

153 ifĞ
j
 % ( 16 / Ğ
t_št
 ) ) == 0 )

155 ifĞ
j
 > 0 )

156 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

158 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): ", 
fe
, 
lše
 );

160 
¡r
[
maxËn
] = '\0';

161 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

164  
k
 = Ğ
t_št
 ) - 1; k >= 0; k-- )

166 
	`¢´štf
Ğ
¡r
, 
maxËn
, " %02x", ()

167 Ğ
X
->
p
[
i
] >> (
k
 << 3) ) & 0xFF );

169 
¡r
[
maxËn
] = '\0';

170 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

174 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, "\n" );

175 
	}
}

177 
	$debug_´št_üt
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

178 cÚ¡ *
fe
, 
lše
,

179 cÚ¡ *
‹xt
, cÚ¡ 
x509_û¹
 *
üt
 )

181 
¡r
[1024], 
´efix
[64];

182 
i
 = 0, 
maxËn
 = Ğ
´efix
 ) - 1;

184 ifĞ
s¦
->
f_dbg
 =ğ
NULL
 || 
üt
 == NULL )

187 
	`¢´štf
Ğ
´efix
, 
maxËn
, "%s(%04d): ", 
fe
, 
lše
 );

188 
´efix
[
maxËn
] = '\0';

189 
maxËn
 = Ğ
¡r
 ) - 1;

191  
üt
 !ğ
NULL
 )

193 
buf
[1024];

194 
	`x509·r£_û¹_šfo
Ğ
buf
, Ğbuàè- 1, 
´efix
, 
üt
 );

196 
	`¢´štf
Ğ
¡r
, 
maxËn
, "%s(%04d): %s #%d:\n%s",

197 
fe
, 
lše
, 
‹xt
, ++
i
, 
buf
 );

199 
¡r
[
maxËn
] = '\0';

200 
s¦
->
	`f_dbg
Ğs¦->
p_dbg
, 
Ëv–
, 
¡r
 );

202 
	`debug_´št_mpi
Ğ
s¦
, 
Ëv–
, 
fe
, 
lše
,

203 "üt->r§.N", &
üt
->
r§
.
N
 );

205 
	`debug_´št_mpi
Ğ
s¦
, 
Ëv–
, 
fe
, 
lše
,

206 "üt->r§.E", &
üt
->
r§
.
E
 );

208 
üt
 = c¹->
Ãxt
;

210 
	}
}

	@tools/src/polarssl/debug.h

25 #iâdeà
SSL_DEBUG_H


26 
	#SSL_DEBUG_H


	)

28 
	~"pŞ¬s¦/cÚfig.h
"

29 
	~"pŞ¬s¦/s¦.h
"

31 #ià
defšed
(
POLARSSL_DEBUG_MSG
)

33 
	#SSL_DEBUG_MSG
Ğ
Ëv–
, 
¬gs
 ) \

34 
	`debug_´št_msg
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
debug_fmt
 
¬gs
 );

	)

36 
	#SSL_DEBUG_RET
Ğ
Ëv–
, 
‹xt
, 
»t
 ) \

37 
	`debug_´št_»t
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
»t
 );

	)

39 
	#SSL_DEBUG_BUF
Ğ
Ëv–
, 
‹xt
, 
buf
, 
Ën
 ) \

40 
	`debug_´št_buf
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
buf
, 
Ën
 );

	)

42 
	#SSL_DEBUG_MPI
Ğ
Ëv–
, 
‹xt
, 
X
 ) \

43 
	`debug_´št_mpi
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
X
 );

	)

45 
	#SSL_DEBUG_CRT
Ğ
Ëv–
, 
‹xt
, 
üt
 ) \

46 
	`debug_´št_üt
Ğ
s¦
, 
Ëv–
, 
__FILE__
, 
__LINE__
, 
‹xt
, 
üt
 );

	)

50 
	#SSL_DEBUG_MSG
Ğ
Ëv–
, 
¬gs
 ) dØ{ }  0 )

	)

51 
	#SSL_DEBUG_RET
Ğ
Ëv–
, 
‹xt
, 
»t
 ) dØ{ }  0 )

	)

52 
	#SSL_DEBUG_BUF
Ğ
Ëv–
, 
‹xt
, 
buf
, 
Ën
 ) dØ{ }  0 )

	)

53 
	#SSL_DEBUG_MPI
Ğ
Ëv–
, 
‹xt
, 
X
 ) dØ{ }  0 )

	)

54 
	#SSL_DEBUG_CRT
Ğ
Ëv–
, 
‹xt
, 
üt
 ) dØ{ }  0 )

	)

58 #ifdeà
__ılu¥lus


62 *
debug_fmt
ĞcÚ¡ *
fÜm©
, ... );

64 
debug_´št_msg
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

65 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
 );

67 
debug_´št_»t
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

68 cÚ¡ *
fe
, 
lše
,

69 cÚ¡ *
‹xt
, 
»t
 );

71 
debug_´št_buf
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

72 cÚ¡ *
fe
, 
lše
, cÚ¡ *
‹xt
,

73 *
buf
, 
Ën
 );

75 
debug_´št_mpi
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

76 cÚ¡ *
fe
, 
lše
,

77 cÚ¡ *
‹xt
, cÚ¡ 
mpi
 *
X
 );

79 
debug_´št_üt
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
, 
Ëv–
,

80 cÚ¡ *
fe
, 
lše
,

81 cÚ¡ *
‹xt
, cÚ¡ 
x509_û¹
 *
üt
 );

83 #ifdeà
__ılu¥lus


	@tools/src/polarssl/des.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_DES_C
)

36 
	~"pŞ¬s¦/des.h
"

38 
	~<¡ršg.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

66 cÚ¡ 
	gSB1
[64] =

86 cÚ¡ 
	gSB2
[64] =

106 cÚ¡ 
	gSB3
[64] =

126 cÚ¡ 
	gSB4
[64] =

146 cÚ¡ 
	gSB5
[64] =

166 cÚ¡ 
	gSB6
[64] =

186 cÚ¡ 
	gSB7
[64] =

206 cÚ¡ 
	gSB8
[64] =

229 cÚ¡ 
	gLHs
[16] =

237 cÚ¡ 
	gRHs
[16] =

248 
	#DES_IP
(
X
,
Y
) \

250 
T
 = ((
X
 >> 4è^ 
Y
) & 0x0F0F0F0F; Y ^= T; X ^= (T << 4); \

251 
T
 = ((
X
 >> 16è^ 
Y
) & 0x0000FFFF; Y ^= T; X ^= (T << 16); \

252 
T
 = ((
Y
 >> 2è^ 
X
) & 0x33333333; X ^= T; Y ^= (T << 2); \

253 
T
 = ((
Y
 >> 8è^ 
X
) & 0x00FF00FF; X ^= T; Y ^= (T << 8); \

254 
Y
 = ((Y << 1) | (Y >> 31)) & 0xFFFFFFFF; \

255 
T
 = (
X
 ^ 
Y
) & 0xAAAAAAAA; Y ^= T; X ^= T; \

256 
X
 = ((X << 1) | (X >> 31)) & 0xFFFFFFFF; \

257 }

	)

262 
	#DES_FP
(
X
,
Y
) \

264 
X
 = ((X << 31) | (X >> 1)) & 0xFFFFFFFF; \

265 
T
 = (
X
 ^ 
Y
) & 0xAAAAAAAA; X ^= T; Y ^= T; \

266 
Y
 = ((Y << 31) | (Y >> 1)) & 0xFFFFFFFF; \

267 
T
 = ((
Y
 >> 8è^ 
X
) & 0x00FF00FF; X ^= T; Y ^= (T << 8); \

268 
T
 = ((
Y
 >> 2è^ 
X
) & 0x33333333; X ^= T; Y ^= (T << 2); \

269 
T
 = ((
X
 >> 16è^ 
Y
) & 0x0000FFFF; Y ^= T; X ^= (T << 16); \

270 
T
 = ((
X
 >> 4è^ 
Y
) & 0x0F0F0F0F; Y ^= T; X ^= (T << 4); \

271 }

	)

276 
	#DES_ROUND
(
X
,
Y
) \

278 
T
 = *
SK
++ ^ 
X
; \

279 
Y
 ^ğ
SB8
[ (
T
 ) & 0x3F ] ^ \

280 
SB6
[ (
T
 >> 8) & 0x3F ] ^ \

281 
SB4
[ (
T
 >> 16) & 0x3F ] ^ \

282 
SB2
[ (
T
 >> 24) & 0x3F ]; \

284 
T
 = *
SK
++ ^ ((
X
 << 28) | (X >> 4)); \

285 
Y
 ^ğ
SB7
[ (
T
 ) & 0x3F ] ^ \

286 
SB5
[ (
T
 >> 8) & 0x3F ] ^ \

287 
SB3
[ (
T
 >> 16) & 0x3F ] ^ \

288 
SB1
[ (
T
 >> 24) & 0x3F ]; \

289 }

	)

291 
	#SWAP
(
a
,
b
è{ 
t
 =‡;‡ = b; b =; = 0; }

	)

293 
	$des_£tkey
Ğ
SK
[32], cÚ¡ 
key
[8] )

295 
i
;

296 
X
, 
Y
, 
T
;

298 
	`GET_ULONG_BE
Ğ
X
, 
key
, 0 );

299 
	`GET_ULONG_BE
Ğ
Y
, 
key
, 4 );

304 
T
 = ((
Y
 >> 4è^ 
X
) & 0x0F0F0F0F; X ^= T; Y ^= (T << 4);

305 
T
 = ((
Y
 ) ^ 
X
) & 0x10101010; X ^= T; Y ^= (T );

307 
X
 = (
LHs
[ (X ) & 0xF] << 3) | (LHs[ (X >> 8) & 0xF ] << 2)

308 | (
LHs
[ (
X
 >> 16) & 0xF] << 1) | (LHs[ (X >> 24) & 0xF ] )

309 | (
LHs
[ (
X
 >> 5) & 0xF] << 7) | (LHs[ (X >> 13) & 0xF ] << 6)

310 | (
LHs
[ (
X
 >> 21) & 0xF] << 5) | (LHs[ (X >> 29) & 0xF ] << 4);

312 
Y
 = (
RHs
[ (Y >> 1) & 0xF] << 3) | (RHs[ (Y >> 9) & 0xF ] << 2)

313 | (
RHs
[ (
Y
 >> 17) & 0xF] << 1) | (RHs[ (Y >> 25) & 0xF ] )

314 | (
RHs
[ (
Y
 >> 4) & 0xF] << 7) | (RHs[ (Y >> 12) & 0xF ] << 6)

315 | (
RHs
[ (
Y
 >> 20) & 0xF] << 5) | (RHs[ (Y >> 28) & 0xF ] << 4);

317 
X
 &= 0x0FFFFFFF;

318 
Y
 &= 0x0FFFFFFF;

323  
i
 = 0; i < 16; i++ )

325 ifĞ
i
 < 2 || i == 8 || i == 15 )

327 
X
 = ((X << 1) | (X >> 27)) & 0x0FFFFFFF;

328 
Y
 = ((Y << 1) | (Y >> 27)) & 0x0FFFFFFF;

332 
X
 = ((X << 2) | (X >> 26)) & 0x0FFFFFFF;

333 
Y
 = ((Y << 2) | (Y >> 26)) & 0x0FFFFFFF;

336 *
SK
++ = ((
X
 << 4) & 0x24000000) | ((X << 28) & 0x10000000)

337 | ((
X
 << 14) & 0x08000000) | ((X << 18) & 0x02080000)

338 | ((
X
 << 6) & 0x01000000) | ((X << 9) & 0x00200000)

339 | ((
X
 >> 1) & 0x00100000) | ((X << 10) & 0x00040000)

340 | ((
X
 << 2) & 0x00020000) | ((X >> 10) & 0x00010000)

341 | ((
Y
 >> 13) & 0x00002000) | ((Y >> 4) & 0x00001000)

342 | ((
Y
 << 6) & 0x00000800) | ((Y >> 1) & 0x00000400)

343 | ((
Y
 >> 14) & 0x00000200) | ((Y ) & 0x00000100)

344 | ((
Y
 >> 5) & 0x00000020) | ((Y >> 10) & 0x00000010)

345 | ((
Y
 >> 3) & 0x00000008) | ((Y >> 18) & 0x00000004)

346 | ((
Y
 >> 26) & 0x00000002) | ((Y >> 24) & 0x00000001);

348 *
SK
++ = ((
X
 << 15) & 0x20000000) | ((X << 17) & 0x10000000)

349 | ((
X
 << 10) & 0x08000000) | ((X << 22) & 0x04000000)

350 | ((
X
 >> 2) & 0x02000000) | ((X << 1) & 0x01000000)

351 | ((
X
 << 16) & 0x00200000) | ((X << 11) & 0x00100000)

352 | ((
X
 << 3) & 0x00080000) | ((X >> 6) & 0x00040000)

353 | ((
X
 << 15) & 0x00020000) | ((X >> 4) & 0x00010000)

354 | ((
Y
 >> 2) & 0x00002000) | ((Y << 8) & 0x00001000)

355 | ((
Y
 >> 14) & 0x00000808) | ((Y >> 9) & 0x00000400)

356 | ((
Y
 ) & 0x00000200) | ((Y << 7) & 0x00000100)

357 | ((
Y
 >> 7) & 0x00000020) | ((Y >> 3) & 0x00000011)

358 | ((
Y
 << 2) & 0x00000004) | ((Y >> 21) & 0x00000002);

360 
	}
}

365 
	$des_£tkey_’c
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] )

367 
	`des_£tkey
Ğ
ùx
->
sk
, 
key
 );

368 
	}
}

373 
	$des_£tkey_dec
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] )

375 
i
;

377 
	`des_£tkey
Ğ
ùx
->
sk
, 
key
 );

379  
i
 = 0; i < 16; i += 2 )

381 
	`SWAP
Ğ
ùx
->
sk
[
i
 ], ctx->sk[30 - i] );

382 
	`SWAP
Ğ
ùx
->
sk
[
i
 + 1], ctx->sk[31 - i] );

384 
	}
}

386 
	$des3_£t2key
Ğ
esk
[96],

387 
dsk
[96],

388 cÚ¡ 
key
[16] )

390 
i
;

392 
	`des_£tkey
Ğ
esk
, 
key
 );

393 
	`des_£tkey
Ğ
dsk
 + 32, 
key
 + 8 );

395  
i
 = 0; i < 32; i += 2 )

397 
dsk
[
i
 ] = 
esk
[30 - i];

398 
dsk
[
i
 + 1] = 
esk
[31 - i];

400 
esk
[
i
 + 32] = 
dsk
[62 - i];

401 
esk
[
i
 + 33] = 
dsk
[63 - i];

403 
esk
[
i
 + 64] =ƒsk[i ];

404 
esk
[
i
 + 65] =ƒsk[i + 1];

406 
dsk
[
i
 + 64] = dsk[i ];

407 
dsk
[
i
 + 65] = dsk[i + 1];

409 
	}
}

414 
	$des3_£t2key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] )

416 
sk
[96];

418 
	`des3_£t2key
Ğ
ùx
->
sk
, sk, 
key
 );

419 
	`mem£t
Ğ
sk
, 0, ( sk ) );

420 
	}
}

425 
	$des3_£t2key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] )

427 
sk
[96];

429 
	`des3_£t2key
Ğ
sk
, 
ùx
->sk, 
key
 );

430 
	`mem£t
Ğ
sk
, 0, ( sk ) );

431 
	}
}

433 
	$des3_£t3key
Ğ
esk
[96],

434 
dsk
[96],

435 cÚ¡ 
key
[24] )

437 
i
;

439 
	`des_£tkey
Ğ
esk
, 
key
 );

440 
	`des_£tkey
Ğ
dsk
 + 32, 
key
 + 8 );

441 
	`des_£tkey
Ğ
esk
 + 64, 
key
 + 16 );

443  
i
 = 0; i < 32; i += 2 )

445 
dsk
[
i
 ] = 
esk
[94 - i];

446 
dsk
[
i
 + 1] = 
esk
[95 - i];

448 
esk
[
i
 + 32] = 
dsk
[62 - i];

449 
esk
[
i
 + 33] = 
dsk
[63 - i];

451 
dsk
[
i
 + 64] = 
esk
[30 - i];

452 
dsk
[
i
 + 65] = 
esk
[31 - i];

454 
	}
}

459 
	$des3_£t3key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] )

461 
sk
[96];

463 
	`des3_£t3key
Ğ
ùx
->
sk
, sk, 
key
 );

464 
	`mem£t
Ğ
sk
, 0, ( sk ) );

465 
	}
}

470 
	$des3_£t3key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] )

472 
sk
[96];

474 
	`des3_£t3key
Ğ
sk
, 
ùx
->sk, 
key
 );

475 
	`mem£t
Ğ
sk
, 0, ( sk ) );

476 
	}
}

481 
	$des_üy±_ecb
Ğ
des_cÚ‹xt
 *
ùx
,

482 cÚ¡ 
šput
[8],

483 
ouut
[8] )

485 
i
;

486 
X
, 
Y
, 
T
, *
SK
;

488 
SK
 = 
ùx
->
sk
;

490 
	`GET_ULONG_BE
Ğ
X
, 
šput
, 0 );

491 
	`GET_ULONG_BE
Ğ
Y
, 
šput
, 4 );

493 
	`DES_IP
Ğ
X
, 
Y
 );

495  
i
 = 0; i < 8; i++ )

497 
	`DES_ROUND
Ğ
Y
, 
X
 );

498 
	`DES_ROUND
Ğ
X
, 
Y
 );

501 
	`DES_FP
Ğ
Y
, 
X
 );

503 
	`PUT_ULONG_BE
Ğ
Y
, 
ouut
, 0 );

504 
	`PUT_ULONG_BE
Ğ
X
, 
ouut
, 4 );

507 
	}
}

512 
	$des_üy±_cbc
Ğ
des_cÚ‹xt
 *
ùx
,

513 
mode
,

514 
Ëngth
,

515 
iv
[8],

516 cÚ¡ *
šput
,

517 *
ouut
 )

519 
i
;

520 
‹mp
[8];

522 ifĞ
Ëngth
 % 8 )

523 Ğ
POLARSSL_ERR_DES_INVALID_INPUT_LENGTH
 );

525 ifĞ
mode
 =ğ
DES_ENCRYPT
 )

527  
Ëngth
 > 0 )

529  
i
 = 0; i < 8; i++ )

530 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

532 
	`des_üy±_ecb
Ğ
ùx
, 
ouut
, output );

533 
	`memıy
Ğ
iv
, 
ouut
, 8 );

535 
šput
 += 8;

536 
ouut
 += 8;

537 
Ëngth
 -= 8;

542  
Ëngth
 > 0 )

544 
	`memıy
Ğ
‹mp
, 
šput
, 8 );

545 
	`des_üy±_ecb
Ğ
ùx
, 
šput
, 
ouut
 );

547  
i
 = 0; i < 8; i++ )

548 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

550 
	`memıy
Ğ
iv
, 
‹mp
, 8 );

552 
šput
 += 8;

553 
ouut
 += 8;

554 
Ëngth
 -= 8;

559 
	}
}

564 
	$des3_üy±_ecb
Ğ
des3_cÚ‹xt
 *
ùx
,

565 cÚ¡ 
šput
[8],

566 
ouut
[8] )

568 
i
;

569 
X
, 
Y
, 
T
, *
SK
;

571 
SK
 = 
ùx
->
sk
;

573 
	`GET_ULONG_BE
Ğ
X
, 
šput
, 0 );

574 
	`GET_ULONG_BE
Ğ
Y
, 
šput
, 4 );

576 
	`DES_IP
Ğ
X
, 
Y
 );

578  
i
 = 0; i < 8; i++ )

580 
	`DES_ROUND
Ğ
Y
, 
X
 );

581 
	`DES_ROUND
Ğ
X
, 
Y
 );

584  
i
 = 0; i < 8; i++ )

586 
	`DES_ROUND
Ğ
X
, 
Y
 );

587 
	`DES_ROUND
Ğ
Y
, 
X
 );

590  
i
 = 0; i < 8; i++ )

592 
	`DES_ROUND
Ğ
Y
, 
X
 );

593 
	`DES_ROUND
Ğ
X
, 
Y
 );

596 
	`DES_FP
Ğ
Y
, 
X
 );

598 
	`PUT_ULONG_BE
Ğ
Y
, 
ouut
, 0 );

599 
	`PUT_ULONG_BE
Ğ
X
, 
ouut
, 4 );

602 
	}
}

607 
	$des3_üy±_cbc
Ğ
des3_cÚ‹xt
 *
ùx
,

608 
mode
,

609 
Ëngth
,

610 
iv
[8],

611 cÚ¡ *
šput
,

612 *
ouut
 )

614 
i
;

615 
‹mp
[8];

617 ifĞ
Ëngth
 % 8 )

618 Ğ
POLARSSL_ERR_DES_INVALID_INPUT_LENGTH
 );

620 ifĞ
mode
 =ğ
DES_ENCRYPT
 )

622  
Ëngth
 > 0 )

624  
i
 = 0; i < 8; i++ )

625 
ouut
[
i
] = ()Ğ
šput
[i] ^ 
iv
[i] );

627 
	`des3_üy±_ecb
Ğ
ùx
, 
ouut
, output );

628 
	`memıy
Ğ
iv
, 
ouut
, 8 );

630 
šput
 += 8;

631 
ouut
 += 8;

632 
Ëngth
 -= 8;

637  
Ëngth
 > 0 )

639 
	`memıy
Ğ
‹mp
, 
šput
, 8 );

640 
	`des3_üy±_ecb
Ğ
ùx
, 
šput
, 
ouut
 );

642  
i
 = 0; i < 8; i++ )

643 
ouut
[
i
] = ()Ğouut[i] ^ 
iv
[i] );

645 
	`memıy
Ğ
iv
, 
‹mp
, 8 );

647 
šput
 += 8;

648 
ouut
 += 8;

649 
Ëngth
 -= 8;

654 
	}
}

656 #ià
defšed
(
POLARSSL_SELF_TEST
)

658 
	~<¡dio.h
>

665 cÚ¡ 
	gdes3_‹¡_keys
[24] =

672 cÚ¡ 
	gdes3_‹¡_iv
[8] =

677 cÚ¡ 
	gdes3_‹¡_buf
[8] =

682 cÚ¡ 
	gdes3_‹¡_ecb_dec
[3][8] =

689 cÚ¡ 
	gdes3_‹¡_ecb_’c
[3][8] =

696 cÚ¡ 
	gdes3_‹¡_cbc_dec
[3][8] =

703 cÚ¡ 
	gdes3_‹¡_cbc_’c
[3][8] =

713 
	$des_£lf_‹¡
Ğ
v”bo£
 )

715 
i
, 
j
, 
u
, 
v
;

716 
des_cÚ‹xt
 
ùx
;

717 
des3_cÚ‹xt
 
ùx3
;

718 
key
[24];

719 
buf
[8];

720 
´v
[8];

721 
iv
[8];

723 
	`mem£t
Ğ
key
, 0, 24 );

728  
i
 = 0; i < 6; i++ )

730 
u
 = 
i
 >> 1;

731 
v
 = 
i
 & 1;

733 ifĞ
v”bo£
 != 0 )

734 
	`´štf
( " DES%c-ECB-%3d (%s): ",

735 Ğ
u
 == 0 ) ? ' ' : '3', 56 + u * 56,

736 Ğ
v
 =ğ
DES_DECRYPT
 ) ? "dec" : "enc" );

738 
	`memıy
Ğ
buf
, 
des3_‹¡_buf
, 8 );

740  
i
 )

743 
	`des_£tkey_dec
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

747 
	`des_£tkey_’c
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

751 
	`des3_£t2key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

755 
	`des3_£t2key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

759 
	`des3_£t3key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

763 
	`des3_£t3key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

770  
j
 = 0; j < 10000; j++ )

772 ifĞ
u
 == 0 )

773 
	`des_üy±_ecb
Ğ&
ùx
, 
buf
, buf );

775 
	`des3_üy±_ecb
Ğ&
ùx3
, 
buf
, buf );

778 ifĞĞ
v
 =ğ
DES_DECRYPT
 &&

779 
	`memcmp
Ğ
buf
, 
des3_‹¡_ecb_dec
[
u
], 8 ) != 0 ) ||

780 Ğ
v
 !ğ
DES_DECRYPT
 &&

781 
	`memcmp
Ğ
buf
, 
des3_‹¡_ecb_’c
[
u
], 8 ) != 0 ) )

783 ifĞ
v”bo£
 != 0 )

784 
	`´štf
( "failed\n" );

789 ifĞ
v”bo£
 != 0 )

790 
	`´štf
( "passed\n" );

793 ifĞ
v”bo£
 != 0 )

794 
	`´štf
( "\n" );

799  
i
 = 0; i < 6; i++ )

801 
u
 = 
i
 >> 1;

802 
v
 = 
i
 & 1;

804 ifĞ
v”bo£
 != 0 )

805 
	`´štf
( " DES%c-CBC-%3d (%s): ",

806 Ğ
u
 == 0 ) ? ' ' : '3', 56 + u * 56,

807 Ğ
v
 =ğ
DES_DECRYPT
 ) ? "dec" : "enc" );

809 
	`memıy
Ğ
iv
, 
des3_‹¡_iv
, 8 );

810 
	`memıy
Ğ
´v
, 
des3_‹¡_iv
, 8 );

811 
	`memıy
Ğ
buf
, 
des3_‹¡_buf
, 8 );

813  
i
 )

816 
	`des_£tkey_dec
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

820 
	`des_£tkey_’c
Ğ&
ùx
, (*è
des3_‹¡_keys
 );

824 
	`des3_£t2key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

828 
	`des3_£t2key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

832 
	`des3_£t3key_dec
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

836 
	`des3_£t3key_’c
Ğ&
ùx3
, (*è
des3_‹¡_keys
 );

843 ifĞ
v
 =ğ
DES_DECRYPT
 )

845  
j
 = 0; j < 10000; j++ )

847 ifĞ
u
 == 0 )

848 
	`des_üy±_cbc
Ğ&
ùx
, 
v
, 8, 
iv
, 
buf
, buf );

850 
	`des3_üy±_cbc
Ğ&
ùx3
, 
v
, 8, 
iv
, 
buf
, buf );

855  
j
 = 0; j < 10000; j++ )

857 
tmp
[8];

859 ifĞ
u
 == 0 )

860 
	`des_üy±_cbc
Ğ&
ùx
, 
v
, 8, 
iv
, 
buf
, buf );

862 
	`des3_üy±_cbc
Ğ&
ùx3
, 
v
, 8, 
iv
, 
buf
, buf );

864 
	`memıy
Ğ
tmp
, 
´v
, 8 );

865 
	`memıy
Ğ
´v
, 
buf
, 8 );

866 
	`memıy
Ğ
buf
, 
tmp
, 8 );

869 
	`memıy
Ğ
buf
, 
´v
, 8 );

872 ifĞĞ
v
 =ğ
DES_DECRYPT
 &&

873 
	`memcmp
Ğ
buf
, 
des3_‹¡_cbc_dec
[
u
], 8 ) != 0 ) ||

874 Ğ
v
 !ğ
DES_DECRYPT
 &&

875 
	`memcmp
Ğ
buf
, 
des3_‹¡_cbc_’c
[
u
], 8 ) != 0 ) )

877 ifĞ
v”bo£
 != 0 )

878 
	`´štf
( "failed\n" );

883 ifĞ
v”bo£
 != 0 )

884 
	`´štf
( "passed\n" );

887 ifĞ
v”bo£
 != 0 )

888 
	`´štf
( "\n" );

891 
	}
}

	@tools/src/polarssl/des.h

25 #iâdeà
POLARSSL_DES_H


26 
	#POLARSSL_DES_H


	)

28 
	#DES_ENCRYPT
 1

	)

29 
	#DES_DECRYPT
 0

	)

31 
	#POLARSSL_ERR_DES_INVALID_INPUT_LENGTH
 -0x0C00

	)

38 
	mmode
;

39 
	msk
[32];

41 
	tdes_cÚ‹xt
;

48 
	mmode
;

49 
	msk
[96];

51 
	tdes3_cÚ‹xt
;

53 #ifdeà
__ılu¥lus


63 
des_£tkey_’c
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] );

71 
des_£tkey_dec
Ğ
des_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[8] );

79 
des3_£t2key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] );

87 
des3_£t2key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[16] );

95 
des3_£t3key_’c
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] );

103 
des3_£t3key_dec
Ğ
des3_cÚ‹xt
 *
ùx
, cÚ¡ 
key
[24] );

114 
des_üy±_ecb
Ğ
des_cÚ‹xt
 *
ùx
,

115 cÚ¡ 
šput
[8],

116 
ouut
[8] );

128 
des_üy±_cbc
Ğ
des_cÚ‹xt
 *
ùx
,

129 
mode
,

130 
Ëngth
,

131 
iv
[8],

132 cÚ¡ *
šput
,

133 *
ouut
 );

144 
des3_üy±_ecb
Ğ
des3_cÚ‹xt
 *
ùx
,

145 cÚ¡ 
šput
[8],

146 
ouut
[8] );

160 
des3_üy±_cbc
Ğ
des3_cÚ‹xt
 *
ùx
,

161 
mode
,

162 
Ëngth
,

163 
iv
[8],

164 cÚ¡ *
šput
,

165 *
ouut
 );

172 
des_£lf_‹¡
Ğ
v”bo£
 );

174 #ifdeà
__ılu¥lus


	@tools/src/polarssl/dhm.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_DHM_C
)

35 
	~"pŞ¬s¦/dhm.h
"

37 
	~<¡ršg.h
>

42 
	$dhm_»ad_bignum
Ğ
mpi
 *
X
,

43 **
p
,

44 cÚ¡ *
’d
 )

46 
»t
, 
n
;

48 ifĞ
’d
 - *
p
 < 2 )

49 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

51 
n
 = ( (*
p
)[0] << 8 ) | (*p)[1];

52 (*
p
) += 2;

54 ifĞ()Ğ
’d
 - *
p
 ) < 
n
 )

55 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

57 ifĞĞ
»t
 = 
	`mpi_»ad_bš¬y
Ğ
X
, *
p
, 
n
 ) ) != 0 )

58 Ğ
POLARSSL_ERR_DHM_READ_PARAMS_FAILED
 | 
»t
 );

60 (*
p
è+ğ
n
;

63 
	}
}

74 
	$dhm_check_¿nge
ĞcÚ¡ 
mpi
 *
public_·¿m
, cÚ¡ mp˜*
P
 )

76 
mpi
 
L
, 
U
;

77 
»t
 = 
POLARSSL_ERR_DHM_BAD_INPUT_DATA
;

79 
	`mpi_š™
Ğ&
L
, &
U
, 
NULL
 );

80 
	`mpi_l£t
Ğ&
L
, 2 );

81 
	`mpi_sub_št
Ğ&
U
, 
P
, 2 );

83 ifĞ
	`mpi_cmp_mpi
Ğ
public_·¿m
, &
L
 ) >= 0 &&

84 
	`mpi_cmp_mpi
Ğ
public_·¿m
, &
U
 ) <= 0 )

86 
»t
 = 0;

89 
	`mpi_ä“
Ğ&
L
, &
U
, 
NULL
 );

91 Ğ
»t
 );

92 
	}
}

97 
	$dhm_»ad_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
,

98 **
p
,

99 cÚ¡ *
’d
 )

101 
»t
, 
n
;

103 
	`mem£t
Ğ
ùx
, 0, Ğ
dhm_cÚ‹xt
 ) );

105 ifĞĞ
»t
 = 
	`dhm_»ad_bignum
Ğ&
ùx
->
P
, 
p
, 
’d
 ) ) != 0 ||

106 Ğ
»t
 = 
	`dhm_»ad_bignum
Ğ&
ùx
->
G
, 
p
, 
’d
 ) ) != 0 ||

107 Ğ
»t
 = 
	`dhm_»ad_bignum
Ğ&
ùx
->
GY
, 
p
, 
’d
 ) ) != 0 )

108 Ğ
»t
 );

110 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GY
, &ùx->
P
 ) ) != 0 )

111 Ğ
»t
 );

113 
ùx
->
Ën
 = 
	`mpi_size
Ğ&ùx->
P
 );

115 ifĞ
’d
 - *
p
 < 2 )

116 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

118 
n
 = ( (*
p
)[0] << 8 ) | (*p)[1];

119 (*
p
) += 2;

121 ifĞ
’d
 !ğ*
p
 + 
n
 )

122 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

125 
	}
}

130 
dhm_make_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
, 
x_size
,

131 *
ouut
, *
Ş’
,

132 (*
f_ºg
)(*), *
p_ºg
 )

134 
i
, 
»t
, 
n
, 
n1
, 
n2
, 
n3
;

135 *
p
;

140 
n
 = 
x_size
 / Ğ
t_št
 ) + 1;

141 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
ùx
->
X
, 
n
 ) );

142 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
ùx
->
X
, 0 ) );

144 
p
 = (*è
ùx
->
X
.p;

145  
i
 = 0; i < 
x_size
; i++ )

146 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

148  
	`mpi_cmp_mpi
Ğ&
ùx
->
X
, &ùx->
P
 ) >= 0 )

149 
	`mpi_shiá_r
Ğ&
ùx
->
X
, 1 );

154 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
ùx
->
GX
, &ùx->
G
, &ùx->
X
,

155 &
ùx
->
P
 , &ùx->
RP
 ) );

157 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GX
, &ùx->
P
 ) ) != 0 )

158 Ğ
»t
 );

163 
	#DHM_MPI_EXPORT
(
X
,
n
) \

164 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ
X
, 
p
 + 2, 
n
 ) ); \

165 *
p
++ = ()Ğ
n
 >> 8 ); \

166 *
p
++ = ()Ğ
n
 );… +ğn;

	)

168 
n1
 = 
	`mpi_size
Ğ&
ùx
->
P
 );

169 
n2
 = 
	`mpi_size
Ğ&
ùx
->
G
 );

170 
n3
 = 
	`mpi_size
Ğ&
ùx
->
GX
 );

172 
p
 = 
ouut
;

173 
	`DHM_MPI_EXPORT
Ğ&
ùx
->
P
 , 
n1
 );

174 
	`DHM_MPI_EXPORT
Ğ&
ùx
->
G
 , 
n2
 );

175 
	`DHM_MPI_EXPORT
Ğ&
ùx
->
GX
, 
n3
 );

177 *
Ş’
 = 
p
 - 
ouut
;

179 
ùx
->
Ën
 = 
n1
;

181 
ş—nup
:

183 ifĞ
»t
 != 0 )

184 Ğ
»t
 | 
POLARSSL_ERR_DHM_MAKE_PARAMS_FAILED
 );

187 
	}
}

192 
	$dhm_»ad_public
Ğ
dhm_cÚ‹xt
 *
ùx
,

193 cÚ¡ *
šput
, 
’
 )

195 
»t
;

197 ifĞ
ùx
 =ğ
NULL
 || 
’
 < 1 || iËÀ> ctx->
Ën
 )

198 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

200 ifĞĞ
»t
 = 
	`mpi_»ad_bš¬y
Ğ&
ùx
->
GY
, 
šput
, 
’
 ) ) != 0 )

201 Ğ
POLARSSL_ERR_DHM_READ_PUBLIC_FAILED
 | 
»t
 );

204 
	}
}

209 
dhm_make_public
Ğ
dhm_cÚ‹xt
 *
ùx
, 
x_size
,

210 *
ouut
, 
Ş’
,

211 (*
f_ºg
)(*), *
p_ºg
 )

213 
»t
, 
i
, 
n
;

214 *
p
;

216 ifĞ
ùx
 =ğ
NULL
 || 
Ş’
 < 1 || oËÀ> ctx->
Ën
 )

217 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

222 
n
 = 
x_size
 / Ğ
t_št
 ) + 1;

223 
	`MPI_CHK
Ğ
	`mpi_grow
Ğ&
ùx
->
X
, 
n
 ) );

224 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
ùx
->
X
, 0 ) );

226 
p
 = (*è
ùx
->
X
.p;

227  
i
 = 0; i < 
x_size
; i++ )

228 *
p
++ = (è
	`f_ºg
Ğ
p_ºg
 );

230  
	`mpi_cmp_mpi
Ğ&
ùx
->
X
, &ùx->
P
 ) >= 0 )

231 
	`mpi_shiá_r
Ğ&
ùx
->
X
, 1 );

233 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
ùx
->
GX
, &ùx->
G
, &ùx->
X
,

234 &
ùx
->
P
 , &ùx->
RP
 ) );

236 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GX
, &ùx->
P
 ) ) != 0 )

237 Ğ
»t
 );

239 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
ùx
->
GX
, 
ouut
, 
Ş’
 ) );

241 
ş—nup
:

243 ifĞ
»t
 != 0 )

244 Ğ
POLARSSL_ERR_DHM_MAKE_PUBLIC_FAILED
 | 
»t
 );

247 
	}
}

252 
	$dhm_ÿlc_£ü‘
Ğ
dhm_cÚ‹xt
 *
ùx
,

253 *
ouut
, *
Ş’
 )

255 
»t
;

257 ifĞ
ùx
 =ğ
NULL
 || *
Ş’
 < ctx->
Ën
 )

258 Ğ
POLARSSL_ERR_DHM_BAD_INPUT_DATA
 );

260 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
ùx
->
K
, &ùx->
GY
, &ùx->
X
,

261 &
ùx
->
P
, &ùx->
RP
 ) );

263 ifĞĞ
»t
 = 
	`dhm_check_¿nge
Ğ&
ùx
->
GY
, &ùx->
P
 ) ) != 0 )

264 Ğ
»t
 );

266 *
Ş’
 = 
	`mpi_size
Ğ&
ùx
->
K
 );

268 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
ùx
->
K
, 
ouut
, *
Ş’
 ) );

270 
ş—nup
:

272 ifĞ
»t
 != 0 )

273 Ğ
POLARSSL_ERR_DHM_CALC_SECRET_FAILED
 | 
»t
 );

276 
	}
}

281 
	$dhm_ä“
Ğ
dhm_cÚ‹xt
 *
ùx
 )

283 
	`mpi_ä“
Ğ&
ùx
->
RP
, &ùx->
K
, &ùx->
GY
,

284 &
ùx
->
GX
, &ùx->
X
, &ùx->
G
,

285 &
ùx
->
P
, 
NULL
 );

286 
	}
}

288 #ià
defšed
(
POLARSSL_SELF_TEST
)

293 
	$dhm_£lf_‹¡
Ğ
v”bo£
 )

295 Ğ
v”bo£
++ );

296 
	}
}

	@tools/src/polarssl/dhm.h

25 #iâdeà
POLARSSL_DHM_H


26 
	#POLARSSL_DHM_H


	)

28 
	~"pŞ¬s¦/bignum.h
"

30 
	#POLARSSL_ERR_DHM_BAD_INPUT_DATA
 0x0480

	)

31 
	#POLARSSL_ERR_DHM_READ_PARAMS_FAILED
 0x0490

	)

32 
	#POLARSSL_ERR_DHM_MAKE_PARAMS_FAILED
 0x04A0

	)

33 
	#POLARSSL_ERR_DHM_READ_PUBLIC_FAILED
 0x04B0

	)

34 
	#POLARSSL_ERR_DHM_MAKE_PUBLIC_FAILED
 0x04C0

	)

35 
	#POLARSSL_ERR_DHM_CALC_SECRET_FAILED
 0x04D0

	)

39 
	mËn
;

40 
mpi
 
	mP
;

41 
mpi
 
	mG
;

42 
mpi
 
	mX
;

43 
mpi
 
	mGX
;

44 
mpi
 
	mGY
;

45 
mpi
 
	mK
;

46 
mpi
 
	mRP
;

48 
	tdhm_cÚ‹xt
;

50 #ifdeà
__ılu¥lus


63 
dhm_»ad_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
,

64 **
p
,

65 cÚ¡ *
’d
 );

83 
dhm_make_·¿ms
Ğ
dhm_cÚ‹xt
 *
ùx
, 
x_size
,

84 *
ouut
, *
Ş’
,

85 (*
f_ºg
)(*), *
p_ºg
 );

96 
dhm_»ad_public
Ğ
dhm_cÚ‹xt
 *
ùx
,

97 cÚ¡ *
šput
, 
’
 );

111 
dhm_make_public
Ğ
dhm_cÚ‹xt
 *
ùx
, 
s_size
,

112 *
ouut
, 
Ş’
,

113 (*
f_ºg
)(*), *
p_ºg
 );

124 
dhm_ÿlc_£ü‘
Ğ
dhm_cÚ‹xt
 *
ùx
,

125 *
ouut
, *
Ş’
 );

130 
dhm_ä“
Ğ
dhm_cÚ‹xt
 *
ùx
 );

137 
dhm_£lf_‹¡
Ğ
v”bo£
 );

139 #ifdeà
__ılu¥lus


	@tools/src/polarssl/havege.c

33 
	~<¡ršg.h
>

34 
	~<time.h
>

36 
	~"pŞ¬s¦/cÚfig.h
"

38 #ià
defšed
(
POLARSSL_HAVEGE_C
)

40 
	~"pŞ¬s¦/havege.h
"

41 
	~"pŞ¬s¦/timšg.h
"

57 
	#SWAP
(
X
,
Y
è{ *
T
 = X; X = Y; Y = T; }

	)

59 
	#TST1_ENTER
 ifĞ
PTEST
 & 1 ) { PTEST ^ğ3; PTEST >>ğ1;

	)

60 
	#TST2_ENTER
 ifĞ
PTEST
 & 1 ) { PTEST ^ğ3; PTEST >>ğ1;

	)

62 
	#TST1_LEAVE
 
U1
++; }

	)

63 
	#TST2_LEAVE
 
U2
++; }

	)

65 
	#ONE_ITERATION
 \

67 
PTEST
 = 
PT1
 >> 20; \

69 
TST1_ENTER
 TST1_ENTER TST1_ENTER TST1_ENTER \

70 
TST1_ENTER
 TST1_ENTER TST1_ENTER TST1_ENTER \

71 
TST1_ENTER
 TST1_ENTER TST1_ENTER TST1_ENTER \

73 
TST1_LEAVE
 TST1_LEAVE TST1_LEAVE TST1_LEAVE \

74 
TST1_LEAVE
 TST1_LEAVE TST1_LEAVE TST1_LEAVE \

75 
TST1_LEAVE
 TST1_LEAVE TST1_LEAVE TST1_LEAVE \

77 
PTX
 = (
PT1
 >> 18) & 7; \

78 
PT1
 &= 0x1FFF; \

79 
PT2
 &= 0x1FFF; \

80 
CLK
 = (è
	`h¬dşock
(); \

82 
i
 = 0; \

83 
A
 = &
WALK
[
PT1
 ]; 
RES
[
i
++] ^= *A; \

84 
B
 = &
WALK
[
PT2
 ]; 
RES
[
i
++] ^= *B; \

85 
C
 = &
WALK
[
PT1
 ^ 1]; 
RES
[
i
++] ^= *C; \

86 
D
 = &
WALK
[
PT2
 ^ 4]; 
RES
[
i
++] ^= *D; \

88 
IN
 = (*
A
 >> (1)è^ (*A << (31)è^ 
CLK
; \

89 *
A
 = (*
B
 >> (2)è^ (*B << (30)è^ 
CLK
; \

90 *
B
 = 
IN
 ^ 
U1
; \

91 *
C
 = (*C >> (3)è^ (*C << (29)è^ 
CLK
; \

92 *
D
 = (*D >> (4)è^ (*D << (28)è^ 
CLK
; \

94 
A
 = &
WALK
[
PT1
 ^ 2]; 
RES
[
i
++] ^= *A; \

95 
B
 = &
WALK
[
PT2
 ^ 2]; 
RES
[
i
++] ^= *B; \

96 
C
 = &
WALK
[
PT1
 ^ 3]; 
RES
[
i
++] ^= *C; \

97 
D
 = &
WALK
[
PT2
 ^ 6]; 
RES
[
i
++] ^= *D; \

99 ifĞ
PTEST
 & 1 ) 
	`SWAP
Ğ
A
, 
C
 ); \

101 
IN
 = (*
A
 >> (5)è^ (*A << (27)è^ 
CLK
; \

102 *
A
 = (*
B
 >> (6)è^ (*B << (26)è^ 
CLK
; \

103 *
B
 = 
IN
; 
CLK
 = (è
	`h¬dşock
(); \

104 *
C
 = (*C >> (7)è^ (*C << (25)è^ 
CLK
; \

105 *
D
 = (*D >> (8)è^ (*D << (24)è^ 
CLK
; \

107 
A
 = &
WALK
[
PT1
 ^ 4]; \

108 
B
 = &
WALK
[
PT2
 ^ 1]; \

110 
PTEST
 = 
PT2
 >> 1; \

112 
PT2
 = (
RES
[(
i
 - 8è^ 
PTY
] ^ 
WALK
[PT2 ^ PTY ^ 7]); \

113 
PT2
 = ((PT2 & 0x1FFFè& (~8)è^ ((
PT1
 ^ 8) & 0x8); \

114 
PTY
 = (
PT2
 >> 10) & 7; \

116 
TST2_ENTER
 TST2_ENTER TST2_ENTER TST2_ENTER \

117 
TST2_ENTER
 TST2_ENTER TST2_ENTER TST2_ENTER \

118 
TST2_ENTER
 TST2_ENTER TST2_ENTER TST2_ENTER \

120 
TST2_LEAVE
 TST2_LEAVE TST2_LEAVE TST2_LEAVE \

121 
TST2_LEAVE
 TST2_LEAVE TST2_LEAVE TST2_LEAVE \

122 
TST2_LEAVE
 TST2_LEAVE TST2_LEAVE TST2_LEAVE \

124 
C
 = &
WALK
[
PT1
 ^ 5]; \

125 
D
 = &
WALK
[
PT2
 ^ 5]; \

127 
RES
[
i
++] ^ğ*
A
; \

128 
RES
[
i
++] ^ğ*
B
; \

129 
RES
[
i
++] ^ğ*
C
; \

130 
RES
[
i
++] ^ğ*
D
; \

132 
IN
 = (*
A
 >> ( 9)è^ (*A << (23)è^ 
CLK
; \

133 *
A
 = (*
B
 >> (10)è^ (*B << (22)è^ 
CLK
; \

134 *
B
 = 
IN
 ^ 
U2
; \

135 *
C
 = (*C >> (11)è^ (*C << (21)è^ 
CLK
; \

136 *
D
 = (*D >> (12)è^ (*D << (20)è^ 
CLK
; \

138 
A
 = &
WALK
[
PT1
 ^ 6]; 
RES
[
i
++] ^= *A; \

139 
B
 = &
WALK
[
PT2
 ^ 3]; 
RES
[
i
++] ^= *B; \

140 
C
 = &
WALK
[
PT1
 ^ 7]; 
RES
[
i
++] ^= *C; \

141 
D
 = &
WALK
[
PT2
 ^ 7]; 
RES
[
i
++] ^= *D; \

143 
IN
 = (*
A
 >> (13)è^ (*A << (19)è^ 
CLK
; \

144 *
A
 = (*
B
 >> (14)è^ (*B << (18)è^ 
CLK
; \

145 *
B
 = 
IN
; \

146 *
C
 = (*C >> (15)è^ (*C << (17)è^ 
CLK
; \

147 *
D
 = (*D >> (16)è^ (*D << (16)è^ 
CLK
; \

149 
PT1
 = ( 
RES
[(
i
 - 8è^ 
PTX
] ^ \

150 
WALK
[
PT1
 ^ 
PTX
 ^ 7] ) & (~1); \

151 
PT1
 ^ğ(
PT2
 ^ 0x10) & 0x10; \

153  
n
++, 
i
 = 0; i < 16; i++ ) \

154 
hs
->
poŞ
[
n
 % 
COLLECT_SIZE
] ^ğ
RES
[
i
];

	)

159 
	$havege_fl
Ğ
havege_¡©e
 *
hs
 )

161 
i
, 
n
 = 0;

162 
U1
, 
U2
, *
A
, *
B
, *
C
, *
D
;

163 
PT1
, 
PT2
, *
WALK
, 
RES
[16];

164 
PTX
, 
PTY
, 
CLK
, 
PTEST
, 
IN
;

166 
WALK
 = 
hs
->WALK;

167 
PT1
 = 
hs
->PT1;

168 
PT2
 = 
hs
->PT2;

170 
PTX
 = 
U1
 = 0;

171 
PTY
 = 
U2
 = 0;

173 
	`mem£t
Ğ
RES
, 0, ( RES ) );

175  
n
 < 
COLLECT_SIZE
 * 4 )

177 
ONE_ITERATION


178 
ONE_ITERATION


179 
ONE_ITERATION


180 
ONE_ITERATION


183 
hs
->
PT1
 = PT1;

184 
hs
->
PT2
 = PT2;

186 
hs
->
off£t
[0] = 0;

187 
hs
->
off£t
[1] = 
COLLECT_SIZE
 / 2;

188 
	}
}

193 
	$havege_š™
Ğ
havege_¡©e
 *
hs
 )

195 
	`mem£t
Ğ
hs
, 0, Ğ
havege_¡©e
 ) );

197 
	`havege_fl
Ğ
hs
 );

198 
	}
}

203 
	$havege_¿nd
Ğ*
p_ºg
 )

205 
»t
;

206 
havege_¡©e
 *
hs
 = (havege_¡©*è
p_ºg
;

208 ifĞ
hs
->
off£t
[1] >ğ
COLLECT_SIZE
 )

209 
	`havege_fl
Ğ
hs
 );

211 
»t
 = 
hs
->
poŞ
[hs->
off£t
[0]++];

212 
»t
 ^ğ
hs
->
poŞ
[hs->
off£t
[1]++];

214 Ğ
»t
 );

215 
	}
}

217 #ià
defšed
(
POLARSSL_RAND_TEST
)

219 
	~<¡dio.h
>

221 
	$maš
Ğ
¬gc
, *
¬gv
[] )

223 
FILE
 *
f
;

224 
time_t
 
t
;

225 
i
, 
j
, 
k
;

226 
havege_¡©e
 
hs
;

227 
buf
[1024];

229 ifĞ
¬gc
 < 2 )

231 
	`årštf
Ğ
¡d”r
, "u§ge: % <ouuˆf’ame>\n", 
¬gv
[0] );

235 ifĞĞ
f
 = 
	`fİ’
Ğ
¬gv
[1], "wb+" ) ) =ğ
NULL
 )

237 
	`´štf
Ğ"çedØİ’ '%s' fÜ wr™šg.\n", 
¬gv
[0] );

241 
	`havege_š™
Ğ&
hs
 );

243 
t
 = 
	`time
Ğ
NULL
 );

245  
i
 = 0, 
k
 = 32768; i < k; i++ )

247  
j
 = 0; j < Ğ
buf
 ); j++ )

248 
buf
[
j
] = 
	`havege_¿nd
Ğ&
hs
 );

250 
	`fwr™e
Ğ
buf
, Ğbuà), 1, 
f
 );

252 
	`´štf
( "Generating 32Mb of data in file '%s'... %04.1f" \

253 "%% dÚe\r", 
¬gv
[1], (100 * (è(
i
 + 1)è/ 
k
 );

254 
	`fæush
Ğ
¡dout
 );

257 ifĞ
t
 =ğ
	`time
Ğ
NULL
 ) )

258 
t
--;

260 
	`fşo£
Ğ
f
 );

262 
	}
}

	@tools/src/polarssl/havege.h

25 #iâdeà
POLARSSL_HAVEGE_H


26 
	#POLARSSL_HAVEGE_H


	)

28 
	#COLLECT_SIZE
 1024

	)

35 
	mPT1
, 
	mPT2
, 
	moff£t
[2];

36 
	mpoŞ
[
COLLECT_SIZE
];

37 
	mWALK
[8192];

39 
	thavege_¡©e
;

41 #ifdeà
__ılu¥lus


50 
havege_š™
Ğ
havege_¡©e
 *
hs
 );

59 
havege_¿nd
Ğ*
p_ºg
 );

61 #ifdeà
__ılu¥lus


	@tools/src/polarssl/md2.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_MD2_C
)

36 
	~"pŞ¬s¦/md2.h
"

38 
	~<¡ršg.h
>

39 
	~<¡dio.h
>

41 cÚ¡ 
	gPI_SUBST
[256] =

74 
	$md2_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
 )

76 
	`mem£t
Ğ
ùx
->
cksum
, 0, 16 );

77 
	`mem£t
Ğ
ùx
->
¡©e
, 0, 46 );

78 
	`mem£t
Ğ
ùx
->
bufãr
, 0, 16 );

79 
ùx
->
Ëá
 = 0;

80 
	}
}

82 
	$md2_´oûss
Ğ
md2_cÚ‹xt
 *
ùx
 )

84 
i
, 
j
;

85 
t
 = 0;

87  
i
 = 0; i < 16; i++ )

89 
ùx
->
¡©e
[
i
 + 16] = ctx->
bufãr
[i];

90 
ùx
->
¡©e
[
i
 + 32] =

91 ()Ğ
ùx
->
bufãr
[
i
] ^ ctx->
¡©e
[i]);

94  
i
 = 0; i < 18; i++ )

96  
j
 = 0; j < 48; j++ )

98 
ùx
->
¡©e
[
j
] = ()

99 Ğ
ùx
->
¡©e
[
j
] ^ 
PI_SUBST
[
t
] );

100 
t
 = 
ùx
->
¡©e
[
j
];

103 
t
 = ()Ğˆ+ 
i
 );

106 
t
 = 
ùx
->
cksum
[15];

108  
i
 = 0; i < 16; i++ )

110 
ùx
->
cksum
[
i
] = ()

111 Ğ
ùx
->
cksum
[
i
] ^ 
PI_SUBST
[ùx->
bufãr
[i] ^ 
t
] );

112 
t
 = 
ùx
->
cksum
[
i
];

114 
	}
}

119 
	$md2_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

121 
fl
;

123  
’
 > 0 )

125 ifĞ
ùx
->
Ëá
 + 
’
 > 16 )

126 
fl
 = 16 - 
ùx
->
Ëá
;

128 
fl
 = 
’
;

130 
	`memıy
Ğ
ùx
->
bufãr
 + ctx->
Ëá
, 
šput
, 
fl
 );

132 
ùx
->
Ëá
 +ğ
fl
;

133 
šput
 +ğ
fl
;

134 
’
 -ğ
fl
;

136 ifĞ
ùx
->
Ëá
 == 16 )

138 
ùx
->
Ëá
 = 0;

139 
	`md2_´oûss
Ğ
ùx
 );

142 
	}
}

147 
	$md2_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] )

149 
i
;

150 
x
;

152 
x
 = ()Ğ16 - 
ùx
->
Ëá
 );

154  
i
 = 
ùx
->
Ëá
; i < 16; i++ )

155 
ùx
->
bufãr
[
i
] = 
x
;

157 
	`md2_´oûss
Ğ
ùx
 );

159 
	`memıy
Ğ
ùx
->
bufãr
, ctx->
cksum
, 16 );

160 
	`md2_´oûss
Ğ
ùx
 );

162 
	`memıy
Ğ
ouut
, 
ùx
->
¡©e
, 16 );

163 
	}
}

168 
	$md2
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] )

170 
md2_cÚ‹xt
 
ùx
;

172 
	`md2_¡¬ts
Ğ&
ùx
 );

173 
	`md2_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

174 
	`md2_fšish
Ğ&
ùx
, 
ouut
 );

176 
	`mem£t
Ğ&
ùx
, 0, Ğ
md2_cÚ‹xt
 ) );

177 
	}
}

182 
	$md2_fe
ĞcÚ¡ *
·th
, 
ouut
[16] )

184 
FILE
 *
f
;

185 
size_t
 
n
;

186 
md2_cÚ‹xt
 
ùx
;

187 
buf
[1024];

189 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

192 
	`md2_¡¬ts
Ğ&
ùx
 );

194  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

195 
	`md2_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

197 
	`md2_fšish
Ğ&
ùx
, 
ouut
 );

199 
	`mem£t
Ğ&
ùx
, 0, Ğ
md2_cÚ‹xt
 ) );

201 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

203 
	`fşo£
Ğ
f
 );

207 
	`fşo£
Ğ
f
 );

209 
	}
}

214 
	$md2_hmac_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

216 
i
;

217 
sum
[16];

219 ifĞ
keyËn
 > 64 )

221 
	`md2
Ğ
key
, 
keyËn
, 
sum
 );

222 
keyËn
 = 16;

223 
key
 = 
sum
;

226 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

227 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

229  
i
 = 0; i < 
keyËn
; i++ )

231 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

232 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

235 
	`md2_¡¬ts
Ğ
ùx
 );

236 
	`md2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

238 
	`mem£t
Ğ
sum
, 0, ( sum ) );

239 
	}
}

244 
	$md2_hmac_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

246 
	`md2_upd©e
Ğ
ùx
, 
šput
, 
’
 );

247 
	}
}

252 
	$md2_hmac_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] )

254 
tmpbuf
[16];

256 
	`md2_fšish
Ğ
ùx
, 
tmpbuf
 );

257 
	`md2_¡¬ts
Ğ
ùx
 );

258 
	`md2_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

259 
	`md2_upd©e
Ğ
ùx
, 
tmpbuf
, 16 );

260 
	`md2_fšish
Ğ
ùx
, 
ouut
 );

262 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

263 
	}
}

268 
	$md2_hmac_»£t
Ğ
md2_cÚ‹xt
 *
ùx
 )

270 
	`md2_¡¬ts
Ğ
ùx
 );

271 
	`md2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

272 
	}
}

277 
	$md2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

278 cÚ¡ *
šput
, 
’
,

279 
ouut
[16] )

281 
md2_cÚ‹xt
 
ùx
;

283 
	`md2_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

284 
	`md2_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

285 
	`md2_hmac_fšish
Ğ&
ùx
, 
ouut
 );

287 
	`mem£t
Ğ&
ùx
, 0, Ğ
md2_cÚ‹xt
 ) );

288 
	}
}

290 #ià
defšed
(
POLARSSL_SELF_TEST
)

295 cÚ¡ 
	gmd2_‹¡_¡r
[7][81] =

307 cÚ¡ 
	gmd2_‹¡_sum
[7][16] =

328 
	$md2_£lf_‹¡
Ğ
v”bo£
 )

330 
i
;

331 
md2sum
[16];

333  
i
 = 0; i < 7; i++ )

335 ifĞ
v”bo£
 != 0 )

336 
	`´štf
Ğ" MD2e¡ #%d: ", 
i
 + 1 );

338 
	`md2
Ğ(*è
md2_‹¡_¡r
[
i
],

339 
	`¡¾’
Ğ
md2_‹¡_¡r
[
i
] ), 
md2sum
 );

341 ifĞ
	`memcmp
Ğ
md2sum
, 
md2_‹¡_sum
[
i
], 16 ) != 0 )

343 ifĞ
v”bo£
 != 0 )

344 
	`´štf
( "failed\n" );

349 ifĞ
v”bo£
 != 0 )

350 
	`´štf
( "passed\n" );

353 ifĞ
v”bo£
 != 0 )

354 
	`´štf
( "\n" );

357 
	}
}

	@tools/src/polarssl/md2.h

25 #iâdeà
POLARSSL_MD2_H


26 
	#POLARSSL_MD2_H


	)

33 
	mcksum
[16];

34 
	m¡©e
[48];

35 
	mbufãr
[16];

37 
	mad
[64];

38 
	mİad
[64];

39 
	mËá
;

41 
	tmd2_cÚ‹xt
;

43 #ifdeà
__ılu¥lus


52 
md2_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
 );

61 
md2_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

69 
md2_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] );

78 
md2
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] );

89 
md2_fe
ĞcÚ¡ *
·th
, 
ouut
[16] );

98 
md2_hmac_¡¬ts
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

107 
md2_hmac_upd©e
Ğ
md2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

115 
md2_hmac_fšish
Ğ
md2_cÚ‹xt
 *
ùx
, 
ouut
[16] );

122 
md2_hmac_»£t
Ğ
md2_cÚ‹xt
 *
ùx
 );

133 
md2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

134 cÚ¡ *
šput
, 
’
,

135 
ouut
[16] );

142 
md2_£lf_‹¡
Ğ
v”bo£
 );

144 #ifdeà
__ılu¥lus


	@tools/src/polarssl/md4.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_MD4_C
)

36 
	~"pŞ¬s¦/md4.h
"

38 
	~<¡ršg.h
>

39 
	~<¡dio.h
>

44 #iâdeà
GET_ULONG_LE


45 
	#GET_ULONG_LE
(
n
,
b
,
i
) \

47 (
n
èğĞ(è(
b
)[(
i
) ] ) \

48 | ( (è(
b
)[(
i
) + 1] << 8 ) \

49 | ( (è(
b
)[(
i
) + 2] << 16 ) \

50 | ( (è(
b
)[(
i
) + 3] << 24 ); \

51 }

	)

54 #iâdeà
PUT_ULONG_LE


55 
	#PUT_ULONG_LE
(
n
,
b
,
i
) \

57 (
b
)[(
i
è] = (èĞ(
n
) ); \

58 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 16 ); \

60 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 24 ); \

61 }

	)

67 
	$md4_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
 )

69 
ùx
->
tÙ®
[0] = 0;

70 
ùx
->
tÙ®
[1] = 0;

72 
ùx
->
¡©e
[0] = 0x67452301;

73 
ùx
->
¡©e
[1] = 0xEFCDAB89;

74 
ùx
->
¡©e
[2] = 0x98BADCFE;

75 
ùx
->
¡©e
[3] = 0x10325476;

76 
	}
}

78 
	$md4_´oûss
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

80 
X
[16], 
A
, 
B
, 
C
, 
D
;

82 
	`GET_ULONG_LE
Ğ
X
[ 0], 
d©a
, 0 );

83 
	`GET_ULONG_LE
Ğ
X
[ 1], 
d©a
, 4 );

84 
	`GET_ULONG_LE
Ğ
X
[ 2], 
d©a
, 8 );

85 
	`GET_ULONG_LE
Ğ
X
[ 3], 
d©a
, 12 );

86 
	`GET_ULONG_LE
Ğ
X
[ 4], 
d©a
, 16 );

87 
	`GET_ULONG_LE
Ğ
X
[ 5], 
d©a
, 20 );

88 
	`GET_ULONG_LE
Ğ
X
[ 6], 
d©a
, 24 );

89 
	`GET_ULONG_LE
Ğ
X
[ 7], 
d©a
, 28 );

90 
	`GET_ULONG_LE
Ğ
X
[ 8], 
d©a
, 32 );

91 
	`GET_ULONG_LE
Ğ
X
[ 9], 
d©a
, 36 );

92 
	`GET_ULONG_LE
Ğ
X
[10], 
d©a
, 40 );

93 
	`GET_ULONG_LE
Ğ
X
[11], 
d©a
, 44 );

94 
	`GET_ULONG_LE
Ğ
X
[12], 
d©a
, 48 );

95 
	`GET_ULONG_LE
Ğ
X
[13], 
d©a
, 52 );

96 
	`GET_ULONG_LE
Ğ
X
[14], 
d©a
, 56 );

97 
	`GET_ULONG_LE
Ğ
X
[15], 
d©a
, 60 );

99 
	#S
(
x
,
n
è((x <<‚è| ((x & 0xFFFFFFFFè>> (32 -‚)))

	)

101 
A
 = 
ùx
->
¡©e
[0];

102 
B
 = 
ùx
->
¡©e
[1];

103 
C
 = 
ùx
->
¡©e
[2];

104 
D
 = 
ùx
->
¡©e
[3];

106 
	#F
(
x
, 
y
, 
z
è((x & yè| ((~xè& z))

	)

107 
	#P
(
a
,
b
,
c
,
d
,
x
,
s
è{‡ +ğ
	`F
(b,c,dè+ x;‡ = 
	`S
×,s); }

	)

109 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 0], 3 );

110 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 1], 7 );

111 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 2], 11 );

112 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[ 3], 19 );

113 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 4], 3 );

114 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 5], 7 );

115 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 6], 11 );

116 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[ 7], 19 );

117 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 8], 3 );

118 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 9], 7 );

119 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[10], 11 );

120 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[11], 19 );

121 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[12], 3 );

122 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[13], 7 );

123 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[14], 11 );

124 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[15], 19 );

126 #undeà
P


127 #undeà
F


129 
	#F
(
x
,
y
,
z
è((x & yè| (x & zè| (y & z))

	)

130 
	#P
(
a
,
b
,
c
,
d
,
x
,
s
è{‡ +ğ
	`F
(b,c,dè+ x + 0x5A827999;‡ = 
	`S
×,s); }

	)

132 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 0], 3 );

133 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 4], 5 );

134 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 8], 9 );

135 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[12], 13 );

136 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 1], 3 );

137 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 5], 5 );

138 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 9], 9 );

139 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[13], 13 );

140 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 2], 3 );

141 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 6], 5 );

142 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[10], 9 );

143 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[14], 13 );

144 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 3], 3 );

145 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 7], 5 );

146 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[11], 9 );

147 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[15], 13 );

149 #undeà
P


150 #undeà
F


152 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

153 
	#P
(
a
,
b
,
c
,
d
,
x
,
s
è{‡ +ğ
	`F
(b,c,dè+ x + 0x6ED9EBA1;‡ = 
	`S
×,s); }

	)

155 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 0], 3 );

156 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 8], 9 );

157 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 4], 11 );

158 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[12], 15 );

159 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 2], 3 );

160 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[10], 9 );

161 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 6], 11 );

162 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[14], 15 );

163 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 1], 3 );

164 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[ 9], 9 );

165 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 5], 11 );

166 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[13], 15 );

167 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
X
[ 3], 3 );

168 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 
X
[11], 9 );

169 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 
X
[ 7], 11 );

170 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 
X
[15], 15 );

172 #undeà
F


173 #undeà
P


175 
ùx
->
¡©e
[0] +ğ
A
;

176 
ùx
->
¡©e
[1] +ğ
B
;

177 
ùx
->
¡©e
[2] +ğ
C
;

178 
ùx
->
¡©e
[3] +ğ
D
;

179 
	}
}

184 
	$md4_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

186 
fl
;

187 
Ëá
;

189 ifĞ
’
 <= 0 )

192 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

193 
fl
 = 64 - 
Ëá
;

195 
ùx
->
tÙ®
[0] +ğ
’
;

196 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

198 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

199 
ùx
->
tÙ®
[1]++;

201 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

203 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

204 (*è
šput
, 
fl
 );

205 
	`md4_´oûss
Ğ
ùx
, ctx->
bufãr
 );

206 
šput
 +ğ
fl
;

207 
’
 -ğ
fl
;

208 
Ëá
 = 0;

211  
’
 >= 64 )

213 
	`md4_´oûss
Ğ
ùx
, 
šput
 );

214 
šput
 += 64;

215 
’
 -= 64;

218 ifĞ
’
 > 0 )

220 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

221 (*è
šput
, 
’
 );

223 
	}
}

225 cÚ¡ 
	gmd4_·ddšg
[64] =

236 
	$md4_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] )

238 
Ï¡
, 
·dn
;

239 
high
, 
low
;

240 
msgËn
[8];

242 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

243 | ( 
ùx
->
tÙ®
[1] << 3 );

244 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

246 
	`PUT_ULONG_LE
Ğ
low
, 
msgËn
, 0 );

247 
	`PUT_ULONG_LE
Ğ
high
, 
msgËn
, 4 );

249 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

250 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

252 
	`md4_upd©e
Ğ
ùx
, (*è
md4_·ddšg
, 
·dn
 );

253 
	`md4_upd©e
Ğ
ùx
, 
msgËn
, 8 );

255 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

256 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

257 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

258 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

259 
	}
}

264 
	$md4
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] )

266 
md4_cÚ‹xt
 
ùx
;

268 
	`md4_¡¬ts
Ğ&
ùx
 );

269 
	`md4_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

270 
	`md4_fšish
Ğ&
ùx
, 
ouut
 );

272 
	`mem£t
Ğ&
ùx
, 0, Ğ
md4_cÚ‹xt
 ) );

273 
	}
}

278 
	$md4_fe
ĞcÚ¡ *
·th
, 
ouut
[16] )

280 
FILE
 *
f
;

281 
size_t
 
n
;

282 
md4_cÚ‹xt
 
ùx
;

283 
buf
[1024];

285 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

288 
	`md4_¡¬ts
Ğ&
ùx
 );

290  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

291 
	`md4_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

293 
	`md4_fšish
Ğ&
ùx
, 
ouut
 );

295 
	`mem£t
Ğ&
ùx
, 0, Ğ
md4_cÚ‹xt
 ) );

297 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

299 
	`fşo£
Ğ
f
 );

303 
	`fşo£
Ğ
f
 );

305 
	}
}

310 
	$md4_hmac_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

312 
i
;

313 
sum
[16];

315 ifĞ
keyËn
 > 64 )

317 
	`md4
Ğ
key
, 
keyËn
, 
sum
 );

318 
keyËn
 = 16;

319 
key
 = 
sum
;

322 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

323 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

325  
i
 = 0; i < 
keyËn
; i++ )

327 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

328 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

331 
	`md4_¡¬ts
Ğ
ùx
 );

332 
	`md4_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

334 
	`mem£t
Ğ
sum
, 0, ( sum ) );

335 
	}
}

340 
	$md4_hmac_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

342 
	`md4_upd©e
Ğ
ùx
, 
šput
, 
’
 );

343 
	}
}

348 
	$md4_hmac_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] )

350 
tmpbuf
[16];

352 
	`md4_fšish
Ğ
ùx
, 
tmpbuf
 );

353 
	`md4_¡¬ts
Ğ
ùx
 );

354 
	`md4_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

355 
	`md4_upd©e
Ğ
ùx
, 
tmpbuf
, 16 );

356 
	`md4_fšish
Ğ
ùx
, 
ouut
 );

358 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

359 
	}
}

364 
	$md4_hmac_»£t
Ğ
md4_cÚ‹xt
 *
ùx
 )

366 
	`md4_¡¬ts
Ğ
ùx
 );

367 
	`md4_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

368 
	}
}

373 
	$md4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

374 cÚ¡ *
šput
, 
’
,

375 
ouut
[16] )

377 
md4_cÚ‹xt
 
ùx
;

379 
	`md4_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

380 
	`md4_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

381 
	`md4_hmac_fšish
Ğ&
ùx
, 
ouut
 );

383 
	`mem£t
Ğ&
ùx
, 0, Ğ
md4_cÚ‹xt
 ) );

384 
	}
}

386 #ià
defšed
(
POLARSSL_SELF_TEST
)

391 cÚ¡ 
	gmd4_‹¡_¡r
[7][81] =

403 cÚ¡ 
	gmd4_‹¡_sum
[7][16] =

424 
	$md4_£lf_‹¡
Ğ
v”bo£
 )

426 
i
;

427 
md4sum
[16];

429  
i
 = 0; i < 7; i++ )

431 ifĞ
v”bo£
 != 0 )

432 
	`´štf
Ğ" MD4e¡ #%d: ", 
i
 + 1 );

434 
	`md4
Ğ(*è
md4_‹¡_¡r
[
i
],

435 
	`¡¾’
Ğ
md4_‹¡_¡r
[
i
] ), 
md4sum
 );

437 ifĞ
	`memcmp
Ğ
md4sum
, 
md4_‹¡_sum
[
i
], 16 ) != 0 )

439 ifĞ
v”bo£
 != 0 )

440 
	`´štf
( "failed\n" );

445 ifĞ
v”bo£
 != 0 )

446 
	`´štf
( "passed\n" );

449 ifĞ
v”bo£
 != 0 )

450 
	`´štf
( "\n" );

453 
	}
}

	@tools/src/polarssl/md4.h

25 #iâdeà
POLARSSL_MD4_H


26 
	#POLARSSL_MD4_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[4];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

40 
	tmd4_cÚ‹xt
;

42 #ifdeà
__ılu¥lus


51 
md4_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
 );

60 
md4_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

68 
md4_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] );

77 
md4
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] );

88 
md4_fe
ĞcÚ¡ *
·th
, 
ouut
[16] );

97 
md4_hmac_¡¬ts
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

106 
md4_hmac_upd©e
Ğ
md4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

114 
md4_hmac_fšish
Ğ
md4_cÚ‹xt
 *
ùx
, 
ouut
[16] );

121 
md4_hmac_»£t
Ğ
md4_cÚ‹xt
 *
ùx
 );

132 
md4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

133 cÚ¡ *
šput
, 
’
,

134 
ouut
[16] );

141 
md4_£lf_‹¡
Ğ
v”bo£
 );

143 #ifdeà
__ılu¥lus


	@tools/src/polarssl/md5.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_MD5_C
)

35 
	~"pŞ¬s¦/md5.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_ULONG_LE


44 
	#GET_ULONG_LE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] ) \

47 | ( (è(
b
)[(
i
) + 1] << 8 ) \

48 | ( (è(
b
)[(
i
) + 2] << 16 ) \

49 | ( (è(
b
)[(
i
) + 3] << 24 ); \

50 }

	)

53 #iâdeà
PUT_ULONG_LE


54 
	#PUT_ULONG_LE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 8 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 16 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 24 ); \

60 }

	)

66 
	$md5_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
 )

68 
ùx
->
tÙ®
[0] = 0;

69 
ùx
->
tÙ®
[1] = 0;

71 
ùx
->
¡©e
[0] = 0x67452301;

72 
ùx
->
¡©e
[1] = 0xEFCDAB89;

73 
ùx
->
¡©e
[2] = 0x98BADCFE;

74 
ùx
->
¡©e
[3] = 0x10325476;

75 
	}
}

77 
	$md5_´oûss
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

79 
X
[16], 
A
, 
B
, 
C
, 
D
;

81 
	`GET_ULONG_LE
Ğ
X
[ 0], 
d©a
, 0 );

82 
	`GET_ULONG_LE
Ğ
X
[ 1], 
d©a
, 4 );

83 
	`GET_ULONG_LE
Ğ
X
[ 2], 
d©a
, 8 );

84 
	`GET_ULONG_LE
Ğ
X
[ 3], 
d©a
, 12 );

85 
	`GET_ULONG_LE
Ğ
X
[ 4], 
d©a
, 16 );

86 
	`GET_ULONG_LE
Ğ
X
[ 5], 
d©a
, 20 );

87 
	`GET_ULONG_LE
Ğ
X
[ 6], 
d©a
, 24 );

88 
	`GET_ULONG_LE
Ğ
X
[ 7], 
d©a
, 28 );

89 
	`GET_ULONG_LE
Ğ
X
[ 8], 
d©a
, 32 );

90 
	`GET_ULONG_LE
Ğ
X
[ 9], 
d©a
, 36 );

91 
	`GET_ULONG_LE
Ğ
X
[10], 
d©a
, 40 );

92 
	`GET_ULONG_LE
Ğ
X
[11], 
d©a
, 44 );

93 
	`GET_ULONG_LE
Ğ
X
[12], 
d©a
, 48 );

94 
	`GET_ULONG_LE
Ğ
X
[13], 
d©a
, 52 );

95 
	`GET_ULONG_LE
Ğ
X
[14], 
d©a
, 56 );

96 
	`GET_ULONG_LE
Ğ
X
[15], 
d©a
, 60 );

98 
	#S
(
x
,
n
è((x <<‚è| ((x & 0xFFFFFFFFè>> (32 -‚)))

	)

100 
	#P
(
a
,
b
,
c
,
d
,
k
,
s
,
t
) \

102 
a
 +ğ
	`F
(
b
,
c
,
d
è+ 
X
[
k
] + 
t
;‡ = 
	`S
×,
s
) + b; \

103 }

	)

105 
A
 = 
ùx
->
¡©e
[0];

106 
B
 = 
ùx
->
¡©e
[1];

107 
C
 = 
ùx
->
¡©e
[2];

108 
D
 = 
ùx
->
¡©e
[3];

110 
	#F
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

112 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 0, 7, 0xD76AA478 );

113 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 1, 12, 0xE8C7B756 );

114 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 2, 17, 0x242070DB );

115 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 3, 22, 0xC1BDCEEE );

116 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 4, 7, 0xF57C0FAF );

117 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 5, 12, 0x4787C62A );

118 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 6, 17, 0xA8304613 );

119 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 7, 22, 0xFD469501 );

120 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 8, 7, 0x698098D8 );

121 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 9, 12, 0x8B44F7AF );

122 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 10, 17, 0xFFFF5BB1 );

123 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 11, 22, 0x895CD7BE );

124 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 12, 7, 0x6B901122 );

125 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 13, 12, 0xFD987193 );

126 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 14, 17, 0xA679438E );

127 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 15, 22, 0x49B40821 );

129 #undeà
F


131 
	#F
(
x
,
y
,
z
è(y ^ (z & (x ^ y)))

	)

133 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 1, 5, 0xF61E2562 );

134 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 6, 9, 0xC040B340 );

135 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 11, 14, 0x265E5A51 );

136 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 0, 20, 0xE9B6C7AA );

137 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 5, 5, 0xD62F105D );

138 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 10, 9, 0x02441453 );

139 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 15, 14, 0xD8A1E681 );

140 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 4, 20, 0xE7D3FBC8 );

141 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 9, 5, 0x21E1CDE6 );

142 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 14, 9, 0xC33707D6 );

143 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 3, 14, 0xF4D50D87 );

144 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 8, 20, 0x455A14ED );

145 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 13, 5, 0xA9E3E905 );

146 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 2, 9, 0xFCEFA3F8 );

147 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 7, 14, 0x676F02D9 );

148 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 12, 20, 0x8D2A4C8A );

150 #undeà
F


152 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

154 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 5, 4, 0xFFFA3942 );

155 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 8, 11, 0x8771F681 );

156 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 11, 16, 0x6D9D6122 );

157 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 14, 23, 0xFDE5380C );

158 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 1, 4, 0xA4BEEA44 );

159 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 4, 11, 0x4BDECFA9 );

160 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 7, 16, 0xF6BB4B60 );

161 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 10, 23, 0xBEBFBC70 );

162 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 13, 4, 0x289B7EC6 );

163 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 0, 11, 0xEAA127FA );

164 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 3, 16, 0xD4EF3085 );

165 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 6, 23, 0x04881D05 );

166 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 9, 4, 0xD9D4D039 );

167 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 12, 11, 0xE6DB99E5 );

168 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 15, 16, 0x1FA27CF8 );

169 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 2, 23, 0xC4AC5665 );

171 #undeà
F


173 
	#F
(
x
,
y
,
z
è(y ^ (x | ~z))

	)

175 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 0, 6, 0xF4292244 );

176 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 7, 10, 0x432AFF97 );

177 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 14, 15, 0xAB9423A7 );

178 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 5, 21, 0xFC93A039 );

179 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 12, 6, 0x655B59C3 );

180 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 3, 10, 0x8F0CCC92 );

181 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 10, 15, 0xFFEFF47D );

182 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 1, 21, 0x85845DD1 );

183 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 8, 6, 0x6FA87E4F );

184 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 15, 10, 0xFE2CE6E0 );

185 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 6, 15, 0xA3014314 );

186 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 13, 21, 0x4E0811A1 );

187 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 4, 6, 0xF7537E82 );

188 
	`P
Ğ
D
, 
A
, 
B
, 
C
, 11, 10, 0xBD3AF235 );

189 
	`P
Ğ
C
, 
D
, 
A
, 
B
, 2, 15, 0x2AD7D2BB );

190 
	`P
Ğ
B
, 
C
, 
D
, 
A
, 9, 21, 0xEB86D391 );

192 #undeà
F


194 
ùx
->
¡©e
[0] +ğ
A
;

195 
ùx
->
¡©e
[1] +ğ
B
;

196 
ùx
->
¡©e
[2] +ğ
C
;

197 
ùx
->
¡©e
[3] +ğ
D
;

198 
	}
}

203 
	$md5_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

205 
fl
;

206 
Ëá
;

208 ifĞ
’
 <= 0 )

211 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

212 
fl
 = 64 - 
Ëá
;

214 
ùx
->
tÙ®
[0] +ğ
’
;

215 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

217 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

218 
ùx
->
tÙ®
[1]++;

220 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

222 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

223 (*è
šput
, 
fl
 );

224 
	`md5_´oûss
Ğ
ùx
, ctx->
bufãr
 );

225 
šput
 +ğ
fl
;

226 
’
 -ğ
fl
;

227 
Ëá
 = 0;

230  
’
 >= 64 )

232 
	`md5_´oûss
Ğ
ùx
, 
šput
 );

233 
šput
 += 64;

234 
’
 -= 64;

237 ifĞ
’
 > 0 )

239 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

240 (*è
šput
, 
’
 );

242 
	}
}

244 cÚ¡ 
	gmd5_·ddšg
[64] =

255 
	$md5_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] )

257 
Ï¡
, 
·dn
;

258 
high
, 
low
;

259 
msgËn
[8];

261 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

262 | ( 
ùx
->
tÙ®
[1] << 3 );

263 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

265 
	`PUT_ULONG_LE
Ğ
low
, 
msgËn
, 0 );

266 
	`PUT_ULONG_LE
Ğ
high
, 
msgËn
, 4 );

268 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

269 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

271 
	`md5_upd©e
Ğ
ùx
, (*è
md5_·ddšg
, 
·dn
 );

272 
	`md5_upd©e
Ğ
ùx
, 
msgËn
, 8 );

274 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

275 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

276 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

277 
	`PUT_ULONG_LE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

278 
	}
}

283 
	$md5
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] )

285 
md5_cÚ‹xt
 
ùx
;

287 
	`md5_¡¬ts
Ğ&
ùx
 );

288 
	`md5_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

289 
	`md5_fšish
Ğ&
ùx
, 
ouut
 );

291 
	`mem£t
Ğ&
ùx
, 0, Ğ
md5_cÚ‹xt
 ) );

292 
	}
}

297 
	$md5_fe
ĞcÚ¡ *
·th
, 
ouut
[16] )

299 
FILE
 *
f
;

300 
size_t
 
n
;

301 
md5_cÚ‹xt
 
ùx
;

302 
buf
[1024];

304 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

307 
	`md5_¡¬ts
Ğ&
ùx
 );

309  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

310 
	`md5_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

312 
	`md5_fšish
Ğ&
ùx
, 
ouut
 );

314 
	`mem£t
Ğ&
ùx
, 0, Ğ
md5_cÚ‹xt
 ) );

316 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

318 
	`fşo£
Ğ
f
 );

322 
	`fşo£
Ğ
f
 );

324 
	}
}

329 
	$md5_hmac_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

331 
i
;

332 
sum
[16];

334 ifĞ
keyËn
 > 64 )

336 
	`md5
Ğ
key
, 
keyËn
, 
sum
 );

337 
keyËn
 = 16;

338 
key
 = 
sum
;

341 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

342 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

344  
i
 = 0; i < 
keyËn
; i++ )

346 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

347 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

350 
	`md5_¡¬ts
Ğ
ùx
 );

351 
	`md5_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

353 
	`mem£t
Ğ
sum
, 0, ( sum ) );

354 
	}
}

359 
	$md5_hmac_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

361 
	`md5_upd©e
Ğ
ùx
, 
šput
, 
’
 );

362 
	}
}

367 
	$md5_hmac_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] )

369 
tmpbuf
[16];

371 
	`md5_fšish
Ğ
ùx
, 
tmpbuf
 );

372 
	`md5_¡¬ts
Ğ
ùx
 );

373 
	`md5_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

374 
	`md5_upd©e
Ğ
ùx
, 
tmpbuf
, 16 );

375 
	`md5_fšish
Ğ
ùx
, 
ouut
 );

377 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

378 
	}
}

383 
	$md5_hmac_»£t
Ğ
md5_cÚ‹xt
 *
ùx
 )

385 
	`md5_¡¬ts
Ğ
ùx
 );

386 
	`md5_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

387 
	}
}

392 
	$md5_hmac
ĞcÚ¡ *
key
, 
keyËn
,

393 cÚ¡ *
šput
, 
’
,

394 
ouut
[16] )

396 
md5_cÚ‹xt
 
ùx
;

398 
	`md5_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

399 
	`md5_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

400 
	`md5_hmac_fšish
Ğ&
ùx
, 
ouut
 );

402 
	`mem£t
Ğ&
ùx
, 0, Ğ
md5_cÚ‹xt
 ) );

403 
	}
}

405 #ià
defšed
(
POLARSSL_SELF_TEST
)

409 
	gmd5_‹¡_buf
[7][81] =

421 cÚ¡ 
	gmd5_‹¡_buæ’
[7] =

426 cÚ¡ 
	gmd5_‹¡_sum
[7][16] =

447 
	gmd5_hmac_‹¡_key
[7][26] =

459 cÚ¡ 
	gmd5_hmac_‹¡_keyËn
[7] =

464 
	gmd5_hmac_‹¡_buf
[7][74] =

484 cÚ¡ 
	gmd5_hmac_‹¡_buæ’
[7] =

489 cÚ¡ 
	gmd5_hmac_‹¡_sum
[7][16] =

510 
	$md5_£lf_‹¡
Ğ
v”bo£
 )

512 
i
, 
buæ’
;

513 
buf
[1024];

514 
md5sum
[16];

515 
md5_cÚ‹xt
 
ùx
;

517  
i
 = 0; i < 7; i++ )

519 ifĞ
v”bo£
 != 0 )

520 
	`´štf
Ğ" MD5e¡ #%d: ", 
i
 + 1 );

522 
	`md5
Ğ
md5_‹¡_buf
[
i
], 
md5_‹¡_buæ’
[i], 
md5sum
 );

524 ifĞ
	`memcmp
Ğ
md5sum
, 
md5_‹¡_sum
[
i
], 16 ) != 0 )

526 ifĞ
v”bo£
 != 0 )

527 
	`´štf
( "failed\n" );

532 ifĞ
v”bo£
 != 0 )

533 
	`´štf
( "passed\n" );

536 ifĞ
v”bo£
 != 0 )

537 
	`´štf
( "\n" );

539  
i
 = 0; i < 7; i++ )

541 ifĞ
v”bo£
 != 0 )

542 
	`´štf
Ğ" HMAC-MD5e¡ #%d: ", 
i
 + 1 );

544 ifĞ
i
 == 5 || i == 6 )

546 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 80 );

547 
	`md5_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
 );

550 
	`md5_hmac_¡¬ts
Ğ&
ùx
, 
md5_hmac_‹¡_key
[
i
],

551 
md5_hmac_‹¡_keyËn
[
i
] );

553 
	`md5_hmac_upd©e
Ğ&
ùx
, 
md5_hmac_‹¡_buf
[
i
],

554 
md5_hmac_‹¡_buæ’
[
i
] );

556 
	`md5_hmac_fšish
Ğ&
ùx
, 
md5sum
 );

558 
buæ’
 = ( 
i
 == 4 ) ? 12 : 16;

560 ifĞ
	`memcmp
Ğ
md5sum
, 
md5_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

562 ifĞ
v”bo£
 != 0 )

563 
	`´štf
( "failed\n" );

568 ifĞ
v”bo£
 != 0 )

569 
	`´štf
( "passed\n" );

572 ifĞ
v”bo£
 != 0 )

573 
	`´štf
( "\n" );

576 
	}
}

	@tools/src/polarssl/md5.h

25 #iâdeà
POLARSSL_MD5_H


26 
	#POLARSSL_MD5_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[4];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

40 
	tmd5_cÚ‹xt
;

42 #ifdeà
__ılu¥lus


51 
md5_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
 );

60 
md5_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

68 
md5_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] );

77 
md5
ĞcÚ¡ *
šput
, 
’
, 
ouut
[16] );

88 
md5_fe
ĞcÚ¡ *
·th
, 
ouut
[16] );

97 
md5_hmac_¡¬ts
Ğ
md5_cÚ‹xt
 *
ùx
,

98 cÚ¡ *
key
, 
keyËn
 );

107 
md5_hmac_upd©e
Ğ
md5_cÚ‹xt
 *
ùx
,

108 cÚ¡ *
šput
, 
’
 );

116 
md5_hmac_fšish
Ğ
md5_cÚ‹xt
 *
ùx
, 
ouut
[16] );

123 
md5_hmac_»£t
Ğ
md5_cÚ‹xt
 *
ùx
 );

134 
md5_hmac
ĞcÚ¡ *
key
, 
keyËn
,

135 cÚ¡ *
šput
, 
’
,

136 
ouut
[16] );

143 
md5_£lf_‹¡
Ğ
v”bo£
 );

145 #ifdeà
__ılu¥lus


	@tools/src/polarssl/net.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_NET_C
)

30 
	~"pŞ¬s¦/Ãt.h
"

32 #ià
defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

34 
	~<wšsock2.h
>

35 
	~<wšdows.h
>

37 #ià
defšed
(
_WIN32_WCE
)

38 #´agm¨
comm’t
Ğ
lib
, "ws2.lib" )

40 #´agm¨
comm’t
Ğ
lib
, "ws2_32.lib" )

43 
	#»ad
(
fd
,
buf
,
Ën
è
	`»cv
(fd,buf,Ën,0)

	)

44 
	#wr™e
(
fd
,
buf
,
Ën
è
	`£nd
(fd,buf,Ën,0)

	)

45 
	#şo£
(
fd
è
	`şo£sock‘
(fd)

	)

47 
	gw§_š™_dÚe
 = 0;

51 
	~<sys/ty³s.h
>

52 
	~<sys/sock‘.h
>

53 
	~<Ãtš‘/š.h
>

54 
	~<¬·/š‘.h
>

55 
	~<sys/time.h
>

56 
	~<uni¡d.h
>

57 
	~<sigÇl.h
>

58 
	~<fú.h
>

59 
	~<Ãtdb.h
>

60 
	~<”ºo.h
>

62 #ià
defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

63 
	~<sys/’dŸn.h
>

64 #–ià
defšed
(
__APPLE__
)

65 
	~<machše/’dŸn.h
>

67 
	~<’dŸn.h
>

72 
	~<¡ršg.h
>

73 
	~<¡dlib.h
>

74 
	~<¡dio.h
>

75 
	~<time.h
>

82 #ià
defšed
(
__BYTE_ORDER
è&& defšed(
__BIG_ENDIAN
) && __BYTE_ORDER == __BIG_ENDIAN

83 
	#POLARSSL_HTONS
(
n
èÒ)

	)

85 
	#POLARSSL_HTONS
(
n
è((((()Òè& 0xFF)è<< 8è| ((()Òè& 0xFF00è>> 8))

	)

88 
Ãt_htÚs
(
n
);

89 
	#Ãt_htÚs
(
n
è
	`POLARSSL_HTONS
Ò)

	)

94 
	$Ãt_cÚÃù
Ğ*
fd
, cÚ¡ *
ho¡
, 
pÜt
 )

96 
sockaddr_š
 
£rv”_addr
;

97 
ho¡’t
 *
£rv”_ho¡
;

99 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

100 
WSADATA
 
w§D©a
;

102 ifĞ
w§_š™_dÚe
 == 0 )

104 ifĞ
	`WSAS¹up
Ğ
	`MAKEWORD
(2,0), &
w§D©a
 ) =ğ
SOCKET_ERROR
 )

105 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

107 
w§_š™_dÚe
 = 1;

110 
	`sigÇl
Ğ
SIGPIPE
, 
SIG_IGN
 );

113 ifĞĞ
£rv”_ho¡
 = 
	`g‘ho¡byÇme
Ğ
ho¡
 ) ) =ğ
NULL
 )

114 Ğ
POLARSSL_ERR_NET_UNKNOWN_HOST
 );

116 ifĞĞ*
fd
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_IP
 ) ) < 0 )

117 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

119 
	`memıy
Ğ(*è&
£rv”_addr
.
sš_addr
,

120 (*è
£rv”_ho¡
->
h_addr
,

121 
£rv”_ho¡
->
h_Ëngth
 );

123 
£rv”_addr
.
sš_çmy
 = 
AF_INET
;

124 
£rv”_addr
.
sš_pÜt
 = 
	`Ãt_htÚs
Ğ
pÜt
 );

126 ifĞ
	`cÚÃù
Ğ*
fd
, (
sockaddr
 *è&
£rv”_addr
,

127 Ğ
£rv”_addr
 ) ) < 0 )

129 
	`şo£
Ğ*
fd
 );

130 Ğ
POLARSSL_ERR_NET_CONNECT_FAILED
 );

134 
	}
}

139 
	$Ãt_bšd
Ğ*
fd
, cÚ¡ *
bšd_
, 
pÜt
 )

141 
n
, 
c
[4];

142 
sockaddr_š
 
£rv”_addr
;

144 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

145 
WSADATA
 
w§D©a
;

147 ifĞ
w§_š™_dÚe
 == 0 )

149 ifĞ
	`WSAS¹up
Ğ
	`MAKEWORD
(2,0), &
w§D©a
 ) =ğ
SOCKET_ERROR
 )

150 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

152 
w§_š™_dÚe
 = 1;

155 
	`sigÇl
Ğ
SIGPIPE
, 
SIG_IGN
 );

158 ifĞĞ*
fd
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_IP
 ) ) < 0 )

159 Ğ
POLARSSL_ERR_NET_SOCKET_FAILED
 );

161 
n
 = 1;

162 
	`£tsockİt
Ğ*
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

163 (cÚ¡ *è&
n
, (‚ ) );

165 
£rv”_addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

166 
£rv”_addr
.
sš_çmy
 = 
AF_INET
;

167 
£rv”_addr
.
sš_pÜt
 = 
	`Ãt_htÚs
Ğ
pÜt
 );

169 ifĞ
bšd_
 !ğ
NULL
 )

171 
	`mem£t
Ğ
c
, 0, ( c ) );

172 
	`ssÿnf
Ğ
bšd_
, "%d.%d.%d.%d", &
c
[0], &c[1], &c[2], &c[3] );

174  
n
 = 0;‚ < 4;‚++ )

175 ifĞ
c
[
n
] < 0 || c[n] > 255 )

178 ifĞ
n
 == 4 )

179 
£rv”_addr
.
sš_addr
.
s_addr
 =

180 Ğ(è
c
[0] << 24 ) |

181 Ğ(è
c
[1] << 16 ) |

182 Ğ(è
c
[2] << 8 ) |

183 Ğ(è
c
[3] );

186 ifĞ
	`bšd
Ğ*
fd
, (
sockaddr
 *è&
£rv”_addr
,

187 Ğ
£rv”_addr
 ) ) < 0 )

189 
	`şo£
Ğ*
fd
 );

190 Ğ
POLARSSL_ERR_NET_BIND_FAILED
 );

193 ifĞ
	`li¡’
Ğ*
fd
, 10 ) != 0 )

195 
	`şo£
Ğ*
fd
 );

196 Ğ
POLARSSL_ERR_NET_LISTEN_FAILED
 );

200 
	}
}

205 
	$Ãt_is_blockšg
( )

207 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

208 Ğ
	`WSAG‘La¡E¼Ü
(è=ğ
WSAEWOULDBLOCK
 );

210  
”ºo
 )

212 #ià
defšed
 
EAGAIN


213 
EAGAIN
:

215 #ià
defšed
 
EWOULDBLOCK
 && EWOULDBLOCK !ğ
EAGAIN


216 
EWOULDBLOCK
:

222 
	}
}

227 
	$Ãt_acû±
Ğ
bšd_fd
, *
ş›Á_fd
, *
ş›Á_
 )

229 
sockaddr_š
 
ş›Á_addr
;

231 #ià
	`defšed
(
__sockËn_t_defšed
è|| defšed(
_SOCKLEN_T
)

232 
sockËn_t
 
n
 = (sockËn_tèĞ
ş›Á_addr
 );

234 
n
 = (èĞ
ş›Á_addr
 );

237 *
ş›Á_fd
 = 
	`acû±
Ğ
bšd_fd
, (
sockaddr
 *)

238 &
ş›Á_addr
, &
n
 );

240 ifĞ*
ş›Á_fd
 < 0 )

242 ifĞ
	`Ãt_is_blockšg
() != 0 )

243 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

245 Ğ
POLARSSL_ERR_NET_ACCEPT_FAILED
 );

248 ifĞ
ş›Á_
 !ğ
NULL
 )

249 
	`memıy
Ğ
ş›Á_
, &
ş›Á_addr
.
sš_addr
.
s_addr
,

250 Ğ
ş›Á_addr
.
sš_addr
.
s_addr
 ) );

253 
	}
}

258 
	$Ãt_£t_block
Ğ
fd
 )

260 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

261 
n
 = 0;

262 Ğ
	`ioùlsock‘
Ğ
fd
, 
FIONBIO
, &
n
 ) );

264 Ğ
	`fú
Ğ
fd
, 
F_SETFL
, fúĞfd, 
F_GETFL
 ) & ~
O_NONBLOCK
 ) );

266 
	}
}

268 
	$Ãt_£t_nÚblock
Ğ
fd
 )

270 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

271 
n
 = 1;

272 Ğ
	`ioùlsock‘
Ğ
fd
, 
FIONBIO
, &
n
 ) );

274 Ğ
	`fú
Ğ
fd
, 
F_SETFL
, fúĞfd, 
F_GETFL
 ) | 
O_NONBLOCK
 ) );

276 
	}
}

281 
	$Ãt_u¦“p
Ğ
u£c
 )

283 
timev®
 
tv
;

284 
tv
.
tv_£c
 = 0;

285 
tv
.
tv_u£c
 = 
u£c
;

286 
	`£Ëù
Ğ0, 
NULL
, NULL, NULL, &
tv
 );

287 
	}
}

292 
	$Ãt_»cv
Ğ*
ùx
, *
buf
, 
Ën
 )

294 
»t
 = 
	`»ad
Ğ*((*è
ùx
), 
buf
, 
Ën
 );

296 ifĞ
Ën
 > 0 && 
»t
 == 0 )

297 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

299 ifĞ
»t
 < 0 )

301 ifĞ
	`Ãt_is_blockšg
() != 0 )

302 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

304 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

305 ifĞ
	`WSAG‘La¡E¼Ü
(è=ğ
WSAECONNRESET
 )

306 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

308 ifĞ
”ºo
 =ğ
EPIPE
 ||ƒ¼nØ=ğ
ECONNRESET
 )

309 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

311 ifĞ
”ºo
 =ğ
EINTR
 )

312 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

315 Ğ
POLARSSL_ERR_NET_RECV_FAILED
 );

318 Ğ
»t
 );

319 
	}
}

324 
	$Ãt_£nd
Ğ*
ùx
, *
buf
, 
Ën
 )

326 
»t
 = 
	`wr™e
Ğ*((*è
ùx
), 
buf
, 
Ën
 );

328 ifĞ
»t
 < 0 )

330 ifĞ
	`Ãt_is_blockšg
() != 0 )

331 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

333 #ià
	`defšed
(
_WIN32
è|| defšed(
_WIN32_WCE
)

334 ifĞ
	`WSAG‘La¡E¼Ü
(è=ğ
WSAECONNRESET
 )

335 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

337 ifĞ
”ºo
 =ğ
EPIPE
 ||ƒ¼nØ=ğ
ECONNRESET
 )

338 Ğ
POLARSSL_ERR_NET_CONN_RESET
 );

340 ifĞ
”ºo
 =ğ
EINTR
 )

341 Ğ
POLARSSL_ERR_NET_TRY_AGAIN
 );

344 Ğ
POLARSSL_ERR_NET_SEND_FAILED
 );

347 Ğ
»t
 );

348 
	}
}

353 
	$Ãt_şo£
Ğ
fd
 )

355 
	`shutdown
Ğ
fd
, 2 );

356 
	`şo£
Ğ
fd
 );

357 
	}
}

	@tools/src/polarssl/net.h

25 #iâdeà
POLARSSL_NET_H


26 
	#POLARSSL_NET_H


	)

28 
	#POLARSSL_ERR_NET_UNKNOWN_HOST
 -0x0F00

	)

29 
	#POLARSSL_ERR_NET_SOCKET_FAILED
 -0x0F10

	)

30 
	#POLARSSL_ERR_NET_CONNECT_FAILED
 -0x0F20

	)

31 
	#POLARSSL_ERR_NET_BIND_FAILED
 -0x0F30

	)

32 
	#POLARSSL_ERR_NET_LISTEN_FAILED
 -0x0F40

	)

33 
	#POLARSSL_ERR_NET_ACCEPT_FAILED
 -0x0F50

	)

34 
	#POLARSSL_ERR_NET_RECV_FAILED
 -0x0F60

	)

35 
	#POLARSSL_ERR_NET_SEND_FAILED
 -0x0F70

	)

36 
	#POLARSSL_ERR_NET_CONN_RESET
 -0x0F80

	)

37 
	#POLARSSL_ERR_NET_TRY_AGAIN
 -0x0F90

	)

39 #ifdeà
__ılu¥lus


55 
Ãt_cÚÃù
Ğ*
fd
, cÚ¡ *
ho¡
, 
pÜt
 );

70 
Ãt_bšd
Ğ*
fd
, cÚ¡ *
bšd_
, 
pÜt
 );

83 
Ãt_acû±
Ğ
bšd_fd
, *
ş›Á_fd
, *
ş›Á_
 );

92 
Ãt_£t_block
Ğ
fd
 );

101 
Ãt_£t_nÚblock
Ğ
fd
 );

111 
Ãt_u¦“p
Ğ
u£c
 );

125 
Ãt_»cv
Ğ*
ùx
, *
buf
, 
Ën
 );

139 
Ãt_£nd
Ğ*
ùx
, *
buf
, 
Ën
 );

146 
Ãt_şo£
Ğ
fd
 );

148 #ifdeà
__ılu¥lus


	@tools/src/polarssl/openssl.h

28 #iâdeà
POLARSSL_OPENSSL_H


29 
	#POLARSSL_OPENSSL_H


	)

31 
	~"pŞ¬s¦/«s.h
"

32 
	~"pŞ¬s¦/md5.h
"

33 
	~"pŞ¬s¦/r§.h
"

34 
	~"pŞ¬s¦/sha1.h
"

36 
	#AES_SIZE
 16

	)

37 
	#AES_BLOCK_SIZE
 16

	)

38 
	#AES_KEY
 
«s_cÚ‹xt


	)

39 
	#MD5_CTX
 
md5_cÚ‹xt


	)

40 
	#SHA_CTX
 
sha1_cÚ‹xt


	)

42 
	#SHA1_In™
Ğ
CTX
 ) \

43 
	`sha1_¡¬ts
Ğ(
CTX
è)

	)

44 
	#SHA1_Upd©e
Ğ
CTX
, 
BUF
, 
LEN
 ) \

45 
	`sha1_upd©e
Ğ(
CTX
), (*)(
BUF
), (
LEN
è)

	)

46 
	#SHA1_Fš®
Ğ
OUT
, 
CTX
 ) \

47 
	`sha1_fšish
Ğ(
CTX
), (
OUT
è)

	)

49 
	#MD5_In™
Ğ
CTX
 ) \

50 
	`md5_¡¬ts
Ğ(
CTX
è)

	)

51 
	#MD5_Upd©e
Ğ
CTX
, 
BUF
, 
LEN
 ) \

52 
	`md5_upd©e
Ğ(
CTX
), (*)(
BUF
), (
LEN
è)

	)

53 
	#MD5_Fš®
Ğ
OUT
, 
CTX
 ) \

54 
	`md5_fšish
Ğ(
CTX
), (
OUT
è)

	)

56 
	#AES_£t_’üy±_key
Ğ
KEY
, 
KEYSIZE
, 
CTX
 ) \

57 
	`«s_£tkey_’c
Ğ(
CTX
), (
KEY
), (
KEYSIZE
è)

	)

58 
	#AES_£t_deüy±_key
Ğ
KEY
, 
KEYSIZE
, 
CTX
 ) \

59 
	`«s_£tkey_dec
Ğ(
CTX
), (
KEY
), (
KEYSIZE
è)

	)

60 
	#AES_cbc_’üy±
Ğ
INPUT
, 
OUTPUT
, 
LEN
, 
CTX
, 
IV
, 
MODE
 ) \

61 
	`«s_üy±_cbc
Ğ(
CTX
), (
MODE
), (
LEN
), (
IV
), (
INPUT
), (
OUTPUT
è)

	)

66 
šlše
 
	$__RSA_Pas¡hrough
Ğ*
ouut
, *
šput
, 
size
 )

68 
	`memıy
Ğ
ouut
, 
šput
, 
size
 );

69  
size
;

70 
	}
}

72 
šlše
 
r§_cÚ‹xt
* 
	$d2i_RSA_PUBKEY
Ğ*
ignÜe
, **
buåŒ
,

73 
Ën
 )

75 *
bufãr
 = *(**è
buåŒ
;

76 
r§_cÚ‹xt
 *
r§
;

86 ifĞ
ignÜe
 !ğ0 || ( 
Ën
 != 94 &&†en != 162 ) )

89 
r§
 = (
r§_cÚ‹xt
 *è
	`m®loc
ĞĞ
r§_r§
 ) );

90 ifĞ
r§
 =ğ
NULL
 )

93 
	`mem£t
Ğ
r§
, 0, Ğ
r§_cÚ‹xt
 ) );

95 ifĞĞ
Ën
 == 94 &&

96 
	`mpi_»ad_bš¬y
Ğ&
r§
->
N
, &
bufãr
[ 25], 64 ) == 0 &&

97 
	`mpi_»ad_bš¬y
Ğ&
r§
->
E
, &
bufãr
[ 91], 3 ) == 0 ) ||

98 Ğ
Ën
 == 162 &&

99 
	`mpi_»ad_bš¬y
Ğ&
r§
->
N
, &
bufãr
[ 29], 128 ) == 0 ) &&

100 
	`mpi_»ad_bš¬y
Ğ&
r§
->
E
, &
bufãr
[159], 3 ) == 0 )

105 
r§
->
Ën
 = ( 
	`mpi_msb
Ğ&r§->
N
 ) + 7 ) >> 3;

106 Ğ
r§
 );

110 
	`mem£t
Ğ
r§
, 0, Ğ
r§_cÚ‹xt
 ) );

111 
	`ä“
Ğ
r§
 );

114 
	}
}

116 
	#RSA
 
r§_cÚ‹xt


	)

117 
	#RSA_PKCS1_PADDING
 1

	)

118 
	#RSA_size
Ğ
CTX
 ) (CTX)->
Ën


	)

119 
	#RSA_ä“
Ğ
CTX
 ) 
	`r§_ä“
ĞCTX )

	)

120 
	#ERR_g‘_”rÜ
Ğè"ERR_g‘_”rÜ(ènÙ suµÜ‹d"

	)

121 
	#RSA_blšdšg_off
Ğ
IGNORE
 )

	)

123 
	#d2i_RSAPriv©eKey
Ğ
a
, 
b
, 
c
 ) 
Ãw
 
r§_cÚ‹xt


	)

125 
šlše
 
	$RSA_public_deüy±
 ( 
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { 
outsize
=size; ifĞ!
	`r§_pkcs1_deüy±
Ğkey, 
RSA_PUBLIC
, &outsize, iÅut, ouuˆèè outsize;  -1; 
	}
}

126 
šlše
 
	$RSA_´iv©e_deüy±
Ğ
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { 
outsize
=size; ifĞ!
	`r§_pkcs1_deüy±
Ğkey, 
RSA_PRIVATE
, &outsize, iÅut, ouuˆèè outsize;  -1; 
	}
}

127 
šlše
 
	$RSA_public_’üy±
 ( 
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { ifĞ!
	`r§_pkcs1_’üy±
Ğkey, 
RSA_PUBLIC
, size, iÅut, ouuˆèè 
	`RSA_size
(key);  -1; 
	}
}

128 
šlše
 
	$RSA_´iv©e_’üy±
Ğ
size
, * 
šput
, * 
ouut
, 
RSA
* 
key
, 
ignÜe
 ) { ifĞ!
	`r§_pkcs1_’üy±
Ğkey, 
RSA_PRIVATE
, size, iÅut, ouuˆèè 
	`RSA_size
(key);  -1; 
	}
}

130 #ifdeà
__ılu¥lus


	@tools/src/polarssl/padlock.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_PADLOCK_C
)

36 
	~"pŞ¬s¦/«s.h
"

37 
	~"pŞ¬s¦/·dlock.h
"

39 #ià
defšed
(
POLARSSL_HAVE_X86
)

41 
	~<¡ršg.h
>

46 
	$·dlock_suµÜts
Ğ
ã©u»
 )

48 
æags
 = -1;

49 
ebx
, 
edx
;

51 ifĞ
æags
 == -1 )

53 
	`asm
( "movl %%ebx, %0 \n" \

64 : "=m" (
ebx
), "=m" (
edx
)

65 : "m" (
ebx
)

68 
æags
 = 
edx
;

71 Ğ
æags
 & 
ã©u»
 );

72 
	}
}

77 
	$·dlock_xüy±ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

78 
mode
,

79 cÚ¡ 
šput
[16],

80 
ouut
[16] )

82 
ebx
;

83 *
rk
;

84 *
blk
;

85 *
ù¾
;

86 
buf
[256];

88 
rk
 = 
ùx
->rk;

89 
blk
 = 
	`PADLOCK_ALIGN16
Ğ
buf
 );

90 
	`memıy
Ğ
blk
, 
šput
, 16 );

92 
ù¾
 = 
blk
 + 4;

93 *
ù¾
 = 0x80 | 
ùx
->
Ä
 | ( ( ctx->Ä + ( 
mode
^1 ) - 10 ) << 9 );

95 
	`asm
( "pushfl;…opfl \n" \

104 : "=m" (
ebx
)

105 : "m" (
ebx
), "m" (
ù¾
), "m" (
rk
), "m" (
blk
)

108 
	`memıy
Ğ
ouut
, 
blk
, 16 );

111 
	}
}

116 
	$·dlock_xüy±cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

117 
mode
,

118 
Ëngth
,

119 
iv
[16],

120 cÚ¡ *
šput
,

121 *
ouut
 )

123 
ebx
, 
couÁ
;

124 *
rk
;

125 *
iw
;

126 *
ù¾
;

127 
buf
[256];

129 ifĞĞ(è
šput
 & 15 ) != 0 ||

130 Ğ(è
ouut
 & 15 ) != 0 )

131 Ğ
POLARSSL_ERR_PADLOCK_DATA_MISALIGNED
 );

133 
rk
 = 
ùx
->rk;

134 
iw
 = 
	`PADLOCK_ALIGN16
Ğ
buf
 );

135 
	`memıy
Ğ
iw
, 
iv
, 16 );

137 
ù¾
 = 
iw
 + 4;

138 *
ù¾
 = 0x80 | 
ùx
->
Ä
 | ( ( ctx->Ä + (
mode
^1) - 10 ) << 9 );

140 
couÁ
 = (
Ëngth
 + 15) >> 4;

142 
	`asm
( "pushfl;…opfl \n" \

152 : "=m" (
ebx
)

153 : "m" (
ebx
), "m" (
couÁ
), "m" (
ù¾
),

154 "m" (
rk
), "m" (
šput
), "m" (
ouut
), "m" (
iw
)

157 
	`memıy
Ğ
iv
, 
iw
, 16 );

160 
	}
}

	@tools/src/polarssl/padlock.h

25 #iâdeà
POLARSSL_PADLOCK_H


26 
	#POLARSSL_PADLOCK_H


	)

28 
	~"pŞ¬s¦/«s.h
"

30 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__i386__
)

32 #iâdeà
POLARSSL_HAVE_X86


33 
	#POLARSSL_HAVE_X86


	)

36 
	#PADLOCK_RNG
 0x000C

	)

37 
	#PADLOCK_ACE
 0x00C0

	)

38 
	#PADLOCK_PHE
 0x0C00

	)

39 
	#PADLOCK_PMM
 0x3000

	)

41 
	#PADLOCK_ALIGN16
(
x
è(*è(16 + ((èx & ~15))

	)

43 
	#POLARSSL_ERR_PADLOCK_DATA_MISALIGNED
 -0x08E0

	)

45 #ifdeà
__ılu¥lus


56 
·dlock_suµÜts
Ğ
ã©u»
 );

68 
·dlock_xüy±ecb
Ğ
«s_cÚ‹xt
 *
ùx
,

69 
mode
,

70 cÚ¡ 
šput
[16],

71 
ouut
[16] );

85 
·dlock_xüy±cbc
Ğ
«s_cÚ‹xt
 *
ùx
,

86 
mode
,

87 
Ëngth
,

88 
iv
[16],

89 cÚ¡ *
šput
,

90 *
ouut
 );

92 #ifdeà
__ılu¥lus


	@tools/src/polarssl/rsa.c

32 
	~"pŞ¬s¦/cÚfig.h
"

34 #ià
defšed
(
POLARSSL_RSA_C
)

36 
	~"pŞ¬s¦/r§.h
"

38 
	~<¡dlib.h
>

39 
	~<¡ršg.h
>

40 
	~<¡dio.h
>

45 
	$r§_š™
Ğ
r§_cÚ‹xt
 *
ùx
,

46 
·ddšg
,

47 
hash_id
 )

49 
	`mem£t
Ğ
ùx
, 0, Ğ
r§_cÚ‹xt
 ) );

51 
ùx
->
·ddšg
 =…adding;

52 
ùx
->
hash_id
 = hash_id;

53 
	}
}

55 #ià
defšed
(
POLARSSL_GENPRIME
)

60 
r§_g’_key
Ğ
r§_cÚ‹xt
 *
ùx
,

61 (*
f_ºg
)(*),

62 *
p_ºg
,

63 
nb™s
, 
expÚ’t
 )

65 
»t
;

66 
mpi
 
P1
, 
Q1
, 
H
, 
G
;

68 ifĞ
f_ºg
 =ğ
NULL
 || 
nb™s
 < 128 || 
expÚ’t
 < 3 )

69 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

71 
	`mpi_š™
Ğ&
P1
, &
Q1
, &
H
, &
G
, 
NULL
 );

77 
	`MPI_CHK
Ğ
	`mpi_l£t
Ğ&
ùx
->
E
, 
expÚ’t
 ) );

81 
	`MPI_CHK
Ğ
	`mpi_g’_´ime
Ğ&
ùx
->
P
, ( 
nb™s
 + 1 ) >> 1, 0,

82 
f_ºg
, 
p_ºg
 ) );

84 
	`MPI_CHK
Ğ
	`mpi_g’_´ime
Ğ&
ùx
->
Q
, ( 
nb™s
 + 1 ) >> 1, 0,

85 
f_ºg
, 
p_ºg
 ) );

87 ifĞ
	`mpi_cmp_mpi
Ğ&
ùx
->
P
, &ùx->
Q
 ) < 0 )

88 
	`mpi_sw­
Ğ&
ùx
->
P
, &ùx->
Q
 );

90 ifĞ
	`mpi_cmp_mpi
Ğ&
ùx
->
P
, &ùx->
Q
 ) == 0 )

93 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
ùx
->
N
, &ùx->
P
, &ùx->
Q
 ) );

94 ifĞ
	`mpi_msb
Ğ&
ùx
->
N
 ) !ğ
nb™s
 )

97 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
P1
, &
ùx
->
P
, 1 ) );

98 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
Q1
, &
ùx
->
Q
, 1 ) );

99 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
H
, &
P1
, &
Q1
 ) );

100 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G
, &
ùx
->
E
, &
H
 ) );

102  
	`mpi_cmp_št
Ğ&
G
, 1 ) != 0 );

110 
	`MPI_CHK
Ğ
	`mpi_šv_mod
Ğ&
ùx
->
D
 , &ùx->
E
, &
H
 ) );

111 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
ùx
->
DP
, &ùx->
D
, &
P1
 ) );

112 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
ùx
->
DQ
, &ùx->
D
, &
Q1
 ) );

113 
	`MPI_CHK
Ğ
	`mpi_šv_mod
Ğ&
ùx
->
QP
, &ùx->
Q
, &ùx->
P
 ) );

115 
ùx
->
Ën
 = ( 
	`mpi_msb
Ğ&ùx->
N
 ) + 7 ) >> 3;

117 
ş—nup
:

119 
	`mpi_ä“
Ğ&
G
, &
H
, &
Q1
, &
P1
, 
NULL
 );

121 ifĞ
»t
 != 0 )

123 
	`r§_ä“
Ğ
ùx
 );

124 Ğ
POLARSSL_ERR_RSA_KEY_GEN_FAILED
 | 
»t
 );

128 
	}
}

135 
	$r§_check_pubkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 )

137 ifĞ!
ùx
->
N
.
p
 || !ùx->
E
.p )

138 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

140 ifĞĞ
ùx
->
N
.
p
[0] & 1 ) == 0 ||

141 Ğ
ùx
->
E
.
p
[0] & 1 ) == 0 )

142 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

144 ifĞ
	`mpi_msb
Ğ&
ùx
->
N
 ) < 128 ||

145 
	`mpi_msb
Ğ&
ùx
->
N
 ) > 4096 )

146 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

148 ifĞ
	`mpi_msb
Ğ&
ùx
->
E
 ) < 2 ||

149 
	`mpi_msb
Ğ&
ùx
->
E
 ) > 64 )

150 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

153 
	}
}

158 
	$r§_check_´ivkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 )

160 
»t
;

161 
mpi
 
PQ
, 
DE
, 
P1
, 
Q1
, 
H
, 
I
, 
G
, 
G2
, 
L1
, 
L2
;

163 ifĞĞ
»t
 = 
	`r§_check_pubkey
Ğ
ùx
 ) ) != 0 )

164 Ğ
»t
 );

166 ifĞ!
ùx
->
P
.
p
 || !ùx->
Q
.°|| !ùx->
D
.p )

167 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 );

169 
	`mpi_š™
Ğ&
PQ
, &
DE
, &
P1
, &
Q1
, &
H
, &
I
, &
G
, &
G2
, &
L1
, &
L2
, 
NULL
 );

171 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
PQ
, &
ùx
->
P
, &ùx->
Q
 ) );

172 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
DE
, &
ùx
->
D
, &ùx->
E
 ) );

173 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
P1
, &
ùx
->
P
, 1 ) );

174 
	`MPI_CHK
Ğ
	`mpi_sub_št
Ğ&
Q1
, &
ùx
->
Q
, 1 ) );

175 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
H
, &
P1
, &
Q1
 ) );

176 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G
, &
ùx
->
E
, &
H
 ) );

178 
	`MPI_CHK
Ğ
	`mpi_gcd
Ğ&
G2
, &
P1
, &
Q1
 ) );

179 
	`MPI_CHK
Ğ
	`mpi_div_mpi
Ğ&
L1
, &
L2
, &
H
, &
G2
 ) );

180 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
I
, &
DE
, &
L1
 ) );

185 ifĞ
	`mpi_cmp_mpi
Ğ&
PQ
, &
ùx
->
N
 ) == 0 &&

186 
	`mpi_cmp_št
Ğ&
L2
, 0 ) == 0 &&

187 
	`mpi_cmp_št
Ğ&
I
, 1 ) == 0 &&

188 
	`mpi_cmp_št
Ğ&
G
, 1 ) == 0 )

190 
	`mpi_ä“
Ğ&
G
, &
I
, &
H
, &
Q1
, &
P1
, &
DE
, &
PQ
, &
G2
, &
L1
, &
L2
, 
NULL
 );

195 
ş—nup
:

197 
	`mpi_ä“
Ğ&
G
, &
I
, &
H
, &
Q1
, &
P1
, &
DE
, &
PQ
, &
G2
, &
L1
, &
L2
, 
NULL
 );

198 Ğ
POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 | 
»t
 );

199 
	}
}

204 
	$r§_public
Ğ
r§_cÚ‹xt
 *
ùx
,

205 cÚ¡ *
šput
,

206 *
ouut
 )

208 
»t
, 
Ş’
;

209 
mpi
 
T
;

211 
	`mpi_š™
Ğ&
T
, 
NULL
 );

213 
	`MPI_CHK
Ğ
	`mpi_»ad_bš¬y
Ğ&
T
, 
šput
, 
ùx
->
Ën
 ) );

215 ifĞ
	`mpi_cmp_mpi
Ğ&
T
, &
ùx
->
N
 ) >= 0 )

217 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

218 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

221 
Ş’
 = 
ùx
->
Ën
;

222 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T
, &T, &
ùx
->
E
, &ùx->
N
, &ùx->
RN
 ) );

223 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
T
, 
ouut
, 
Ş’
 ) );

225 
ş—nup
:

227 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

229 ifĞ
»t
 != 0 )

230 Ğ
POLARSSL_ERR_RSA_PUBLIC_FAILED
 | 
»t
 );

233 
	}
}

238 
	$r§_´iv©e
Ğ
r§_cÚ‹xt
 *
ùx
,

239 cÚ¡ *
šput
,

240 *
ouut
 )

242 
»t
, 
Ş’
;

243 
mpi
 
T
, 
T1
, 
T2
;

245 
	`mpi_š™
Ğ&
T
, &
T1
, &
T2
, 
NULL
 );

247 
	`MPI_CHK
Ğ
	`mpi_»ad_bš¬y
Ğ&
T
, 
šput
, 
ùx
->
Ën
 ) );

249 ifĞ
	`mpi_cmp_mpi
Ğ&
T
, &
ùx
->
N
 ) >= 0 )

251 
	`mpi_ä“
Ğ&
T
, 
NULL
 );

252 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

256 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T
, &T, &
ùx
->
D
, &ùx->
N
, &ùx->
RN
 ) );

264 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T1
, &
T
, &
ùx
->
DP
, &ùx->
P
, &ùx->
RP
 ) );

265 
	`MPI_CHK
Ğ
	`mpi_exp_mod
Ğ&
T2
, &
T
, &
ùx
->
DQ
, &ùx->
Q
, &ùx->
RQ
 ) );

270 
	`MPI_CHK
Ğ
	`mpi_sub_mpi
Ğ&
T
, &
T1
, &
T2
 ) );

271 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
T1
, &
T
, &
ùx
->
QP
 ) );

272 
	`MPI_CHK
Ğ
	`mpi_mod_mpi
Ğ&
T
, &
T1
, &
ùx
->
P
 ) );

277 
	`MPI_CHK
Ğ
	`mpi_mul_mpi
Ğ&
T1
, &
T
, &
ùx
->
Q
 ) );

278 
	`MPI_CHK
Ğ
	`mpi_add_mpi
Ğ&
T
, &
T2
, &
T1
 ) );

281 
Ş’
 = 
ùx
->
Ën
;

282 
	`MPI_CHK
Ğ
	`mpi_wr™e_bš¬y
Ğ&
T
, 
ouut
, 
Ş’
 ) );

284 
ş—nup
:

286 
	`mpi_ä“
Ğ&
T
, &
T1
, &
T2
, 
NULL
 );

288 ifĞ
»t
 != 0 )

289 Ğ
POLARSSL_ERR_RSA_PRIVATE_FAILED
 | 
»t
 );

292 
	}
}

297 
r§_pkcs1_’üy±
Ğ
r§_cÚ‹xt
 *
ùx
,

298 (*
f_ºg
)(*),

299 *
p_ºg
,

300 
mode
, 
’
,

301 cÚ¡ *
šput
,

302 *
ouut
 )

304 
nb_·d
, 
Ş’
;

305 *
p
 = 
ouut
;

307 
Ş’
 = 
ùx
->
Ën
;

309  
ùx
->
·ddšg
 )

311 
RSA_PKCS_V15
:

313 ifĞ
’
 < 0 || 
Ş’
 < iËÀ+ 11 || 
f_ºg
 =ğ
NULL
 )

314 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

316 
nb_·d
 = 
Ş’
 - 3 - 
’
;

318 *
p
++ = 0;

319 *
p
++ = 
RSA_CRYPT
;

321  
nb_·d
-- > 0 )

323 
ºg_dl
 = 100;

326 *
p
 = (è
	`f_ºg
Ğ
p_ºg
 );

327 }  *
p
 =ğ0 && --
ºg_dl
 );

331 ifĞ
ºg_dl
 == 0 )

332  
POLARSSL_ERR_RSA_RNG_FAILED
;

334 
p
++;

336 *
p
++ = 0;

337 
	`memıy
Ğ
p
, 
šput
, 
’
 );

342 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

345 ĞĞ
mode
 =ğ
RSA_PUBLIC
 )

346 ? 
	`r§_public
Ğ
ùx
, 
ouut
, output )

347 : 
	`r§_´iv©e
Ğ
ùx
, 
ouut
, output ) );

348 
	}
}

353 
	$r§_pkcs1_deüy±
Ğ
r§_cÚ‹xt
 *
ùx
,

354 
mode
, *
Ş’
,

355 cÚ¡ *
šput
,

356 *
ouut
,

357 
ouut_max_Ën
)

359 
»t
, 
’
;

360 *
p
;

361 
buf
[1024];

363 
’
 = 
ùx
->
Ën
;

365 ifĞ
’
 < 16 || iËÀ> (èĞ
buf
 ) )

366 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

368 
»t
 = ( 
mode
 =ğ
RSA_PUBLIC
 )

369 ? 
	`r§_public
Ğ
ùx
, 
šput
, 
buf
 )

370 : 
	`r§_´iv©e
Ğ
ùx
, 
šput
, 
buf
 );

372 ifĞ
»t
 != 0 )

373 Ğ
»t
 );

375 
p
 = 
buf
;

377  
ùx
->
·ddšg
 )

379 
RSA_PKCS_V15
:

381 ifĞ*
p
++ !ğ0 || *p++ !ğ
RSA_CRYPT
 )

382 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

384  *
p
 != 0 )

386 ifĞ
p
 >ğ
buf
 + 
’
 - 1 )

387 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

388 
p
++;

390 
p
++;

395 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

398 ià(
’
 - ()(
p
 - 
buf
è> 
ouut_max_Ën
)

399 Ğ
POLARSSL_ERR_RSA_OUTPUT_TOO_LARGE
 );

401 *
Ş’
 = 
’
 - ()(
p
 - 
buf
);

402 
	`memıy
Ğ
ouut
, 
p
, *
Ş’
 );

405 
	}
}

410 
	$r§_pkcs1_sign
Ğ
r§_cÚ‹xt
 *
ùx
,

411 
mode
,

412 
hash_id
,

413 
hashËn
,

414 cÚ¡ *
hash
,

415 *
sig
 )

417 
nb_·d
, 
Ş’
;

418 *
p
 = 
sig
;

420 
Ş’
 = 
ùx
->
Ën
;

422  
ùx
->
·ddšg
 )

424 
RSA_PKCS_V15
:

426  
hash_id
 )

428 
SIG_RSA_RAW
:

429 
nb_·d
 = 
Ş’
 - 3 - 
hashËn
;

432 
SIG_RSA_MD2
:

433 
SIG_RSA_MD4
:

434 
SIG_RSA_MD5
:

435 
nb_·d
 = 
Ş’
 - 3 - 34;

438 
SIG_RSA_SHA1
:

439 
nb_·d
 = 
Ş’
 - 3 - 35;

442 
SIG_RSA_SHA224
:

443 
nb_·d
 = 
Ş’
 - 3 - 47;

446 
SIG_RSA_SHA256
:

447 
nb_·d
 = 
Ş’
 - 3 - 51;

450 
SIG_RSA_SHA384
:

451 
nb_·d
 = 
Ş’
 - 3 - 67;

454 
SIG_RSA_SHA512
:

455 
nb_·d
 = 
Ş’
 - 3 - 83;

460 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

463 ifĞ
nb_·d
 < 8 )

464 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

466 *
p
++ = 0;

467 *
p
++ = 
RSA_SIGN
;

468 
	`mem£t
Ğ
p
, 0xFF, 
nb_·d
 );

469 
p
 +ğ
nb_·d
;

470 *
p
++ = 0;

475 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

478  
hash_id
 )

480 
SIG_RSA_RAW
:

481 
	`memıy
Ğ
p
, 
hash
, 
hashËn
 );

484 
SIG_RSA_MD2
:

485 
	`memıy
Ğ
p
, 
ASN1_HASH_MDX
, 18 );

486 
	`memıy
Ğ
p
 + 18, 
hash
, 16 );

487 
p
[13] = 2; ;

489 
SIG_RSA_MD4
:

490 
	`memıy
Ğ
p
, 
ASN1_HASH_MDX
, 18 );

491 
	`memıy
Ğ
p
 + 18, 
hash
, 16 );

492 
p
[13] = 4; ;

494 
SIG_RSA_MD5
:

495 
	`memıy
Ğ
p
, 
ASN1_HASH_MDX
, 18 );

496 
	`memıy
Ğ
p
 + 18, 
hash
, 16 );

497 
p
[13] = 5; ;

499 
SIG_RSA_SHA1
:

500 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA1
, 15 );

501 
	`memıy
Ğ
p
 + 15, 
hash
, 20 );

504 
SIG_RSA_SHA224
:

505 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

506 
	`memıy
Ğ
p
 + 19, 
hash
, 28 );

507 
p
[1] += 28;…[14] = 4;…[18] += 28; ;

509 
SIG_RSA_SHA256
:

510 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

511 
	`memıy
Ğ
p
 + 19, 
hash
, 32 );

512 
p
[1] += 32;…[14] = 1;…[18] += 32; ;

514 
SIG_RSA_SHA384
:

515 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

516 
	`memıy
Ğ
p
 + 19, 
hash
, 48 );

517 
p
[1] += 48;…[14] = 2;…[18] += 48; ;

519 
SIG_RSA_SHA512
:

520 
	`memıy
Ğ
p
, 
ASN1_HASH_SHA2X
, 19 );

521 
	`memıy
Ğ
p
 + 19, 
hash
, 64 );

522 
p
[1] += 64;…[14] = 3;…[18] += 64; ;

525 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

528 ĞĞ
mode
 =ğ
RSA_PUBLIC
 )

529 ? 
	`r§_public
Ğ
ùx
, 
sig
, sig )

530 : 
	`r§_´iv©e
Ğ
ùx
, 
sig
, sig ) );

531 
	}
}

536 
	$r§_pkcs1_v”ify
Ğ
r§_cÚ‹xt
 *
ùx
,

537 
mode
,

538 
hash_id
,

539 
hashËn
,

540 cÚ¡ *
hash
,

541 *
sig
 )

543 
»t
, 
Ën
, 
sigËn
;

544 *
p
, 
c
;

545 
buf
[1024];

547 
sigËn
 = 
ùx
->
Ën
;

549 ifĞ
sigËn
 < 16 || sigËÀ> (èĞ
buf
 ) )

550 Ğ
POLARSSL_ERR_RSA_BAD_INPUT_DATA
 );

552 
»t
 = ( 
mode
 =ğ
RSA_PUBLIC
 )

553 ? 
	`r§_public
Ğ
ùx
, 
sig
, 
buf
 )

554 : 
	`r§_´iv©e
Ğ
ùx
, 
sig
, 
buf
 );

556 ifĞ
»t
 != 0 )

557 Ğ
»t
 );

559 
p
 = 
buf
;

561  
ùx
->
·ddšg
 )

563 
RSA_PKCS_V15
:

565 ifĞ*
p
++ !ğ0 || *p++ !ğ
RSA_SIGN
 )

566 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

568  *
p
 != 0 )

570 ifĞ
p
 >ğ
buf
 + 
sigËn
 - 1 || *p != 0xFF )

571 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

572 
p
++;

574 
p
++;

579 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

582 
Ën
 = 
sigËn
 - ()Ğ
p
 - 
buf
 );

584 ifĞ
Ën
 == 34 )

586 
c
 = 
p
[13];

587 
p
[13] = 0;

589 ifĞ
	`memcmp
Ğ
p
, 
ASN1_HASH_MDX
, 18 ) != 0 )

590 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

592 ifĞĞ
c
 =ğ2 && 
hash_id
 =ğ
SIG_RSA_MD2
 ) ||

593 Ğ
c
 =ğ4 && 
hash_id
 =ğ
SIG_RSA_MD4
 ) ||

594 Ğ
c
 =ğ5 && 
hash_id
 =ğ
SIG_RSA_MD5
 ) )

596 ifĞ
	`memcmp
Ğ
p
 + 18, 
hash
, 16 ) == 0 )

599 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

603 ifĞ
Ën
 =ğ35 && 
hash_id
 =ğ
SIG_RSA_SHA1
 )

605 ifĞ
	`memcmp
Ğ
p
, 
ASN1_HASH_SHA1
, 15 ) == 0 &&

606 
	`memcmp
Ğ
p
 + 15, 
hash
, 20 ) == 0 )

609 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

611 ifĞĞ
Ën
 =ğ19 + 28 && 
p
[14] =ğ4 && 
hash_id
 =ğ
SIG_RSA_SHA224
 ) ||

612 Ğ
Ën
 =ğ19 + 32 && 
p
[14] =ğ1 && 
hash_id
 =ğ
SIG_RSA_SHA256
 ) ||

613 Ğ
Ën
 =ğ19 + 48 && 
p
[14] =ğ2 && 
hash_id
 =ğ
SIG_RSA_SHA384
 ) ||

614 Ğ
Ën
 =ğ19 + 64 && 
p
[14] =ğ3 && 
hash_id
 =ğ
SIG_RSA_SHA512
 ) )

616 
c
 = 
p
[1] - 17;

617 
p
[1] = 17;

618 
p
[14] = 0;

620 ifĞ
p
[18] =ğ
c
 &&

621 
	`memcmp
Ğ
p
, 
ASN1_HASH_SHA2X
, 18 ) == 0 &&

622 
	`memcmp
Ğ
p
 + 19, 
hash
, 
c
 ) == 0 )

625 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

628 ifĞ
Ën
 =ğ
hashËn
 && 
hash_id
 =ğ
SIG_RSA_RAW
 )

630 ifĞ
	`memcmp
Ğ
p
, 
hash
, 
hashËn
 ) == 0 )

633 Ğ
POLARSSL_ERR_RSA_VERIFY_FAILED
 );

636 Ğ
POLARSSL_ERR_RSA_INVALID_PADDING
 );

637 
	}
}

642 
	$r§_ä“
Ğ
r§_cÚ‹xt
 *
ùx
 )

644 
	`mpi_ä“
Ğ&
ùx
->
RQ
, &ùx->
RP
, &ùx->
RN
,

645 &
ùx
->
QP
, &ùx->
DQ
, &ùx->
DP
,

646 &
ùx
->
Q
, &ùx->
P
, &ùx->
D
,

647 &
ùx
->
E
, &ùx->
N
, 
NULL
 );

648 
	}
}

650 #ià
defšed
(
POLARSSL_SELF_TEST
)

652 
	~"pŞ¬s¦/sha1.h
"

657 
	#KEY_LEN
 128

	)

659 
	#RSA_N
 "9292758453063D803DD603D5E777D788" \

666 "5E94BB77B07507233A0BC7BAC8F90F79"

	)

668 
	#RSA_E
 "10001"

	)

670 
	#RSA_D
 "24BF6185468786FDD303083D25E64EFC" \

677 "071513A1E85B5DFA031F21ECAE91A34D"

	)

679 
	#RSA_P
 "C36D0EB7FCD285223CFB5AABA5BDA3D8" \

682 "C3D9E75E1EFC42488BB4F1D13AC30A57"

	)

684 
	#RSA_Q
 "C000DF51A7C77AE8D7C7370C1FF55B69" \

687 "8452DD96A9A5EA5D9DCA68DA636032AF"

	)

689 
	#RSA_DP
 "C1ACF567564274FB07A0BBAD5D26E298" \

692 "3CC559CD27BC2D1CA488811730BB5725"

	)

694 
	#RSA_DQ
 "4959CBF6F8FEF750AEE6977C155579C7" \

697 "407A1BD76C164B93DA2D32A383E58357"

	)

699 
	#RSA_QP
 "9AE7FBC99546432DF71896FC239EADAE" \

702 "A74206CEC169D74BF5A8C50D6F48EA08"

	)

704 
	#PT_LEN
 24

	)

705 
	#RSA_PT
 "\xAA\xBB\xCC\x03\x02\x01\x00\xFF\xFF\xFF\xFF\xFF" \

706 "\x11\x22\x33\x0A\x0B\x0C\xCC\xDD\xDD\xDD\xDD\xDD"

	)

708 
	$my¿nd
Ğ*
ºg_¡©e
 )

710 ifĞ
ºg_¡©e
 !ğ
NULL
 )

711 
ºg_¡©e
 = 
NULL
;

713 Ğ
	`¿nd
() );

714 
	}
}

719 
	$r§_£lf_‹¡
Ğ
v”bo£
 )

721 
Ën
;

722 
r§_cÚ‹xt
 
r§
;

723 
sha1sum
[20];

724 
r§_¶aš‹xt
[
PT_LEN
];

725 
r§_deüy±ed
[
PT_LEN
];

726 
r§_ch”‹xt
[
KEY_LEN
];

728 
	`r§_š™
Ğ&
r§
, 
RSA_PKCS_V15
, 0 );

730 
r§
.
Ën
 = 
KEY_LEN
;

731 
	`mpi_»ad_¡ršg
Ğ&
r§
.
N
 , 16, 
RSA_N
 );

732 
	`mpi_»ad_¡ršg
Ğ&
r§
.
E
 , 16, 
RSA_E
 );

733 
	`mpi_»ad_¡ršg
Ğ&
r§
.
D
 , 16, 
RSA_D
 );

734 
	`mpi_»ad_¡ršg
Ğ&
r§
.
P
 , 16, 
RSA_P
 );

735 
	`mpi_»ad_¡ršg
Ğ&
r§
.
Q
 , 16, 
RSA_Q
 );

736 
	`mpi_»ad_¡ršg
Ğ&
r§
.
DP
, 16, 
RSA_DP
 );

737 
	`mpi_»ad_¡ršg
Ğ&
r§
.
DQ
, 16, 
RSA_DQ
 );

738 
	`mpi_»ad_¡ršg
Ğ&
r§
.
QP
, 16, 
RSA_QP
 );

740 ifĞ
v”bo£
 != 0 )

741 
	`´štf
( " RSA key validation: " );

743 ifĞ
	`r§_check_pubkey
Ğ&
r§
 ) != 0 ||

744 
	`r§_check_´ivkey
Ğ&
r§
 ) != 0 )

746 ifĞ
v”bo£
 != 0 )

747 
	`´štf
( "failed\n" );

752 ifĞ
v”bo£
 != 0 )

753 
	`´štf
( "passed\n PKCS#1ƒncryption : " );

755 
	`memıy
Ğ
r§_¶aš‹xt
, 
RSA_PT
, 
PT_LEN
 );

757 ifĞ
	`r§_pkcs1_’üy±
Ğ&
r§
, &
my¿nd
, 
NULL
, 
RSA_PUBLIC
, 
PT_LEN
,

758 
r§_¶aš‹xt
, 
r§_ch”‹xt
 ) != 0 )

760 ifĞ
v”bo£
 != 0 )

761 
	`´štf
( "failed\n" );

766 ifĞ
v”bo£
 != 0 )

767 
	`´štf
( "passed\n PKCS#1 decryption : " );

769 ifĞ
	`r§_pkcs1_deüy±
Ğ&
r§
, 
RSA_PRIVATE
, &
Ën
,

770 
r§_ch”‹xt
, 
r§_deüy±ed
,

771 (
r§_deüy±ed
) ) != 0 )

773 ifĞ
v”bo£
 != 0 )

774 
	`´štf
( "failed\n" );

779 ifĞ
	`memcmp
Ğ
r§_deüy±ed
, 
r§_¶aš‹xt
, 
Ën
 ) != 0 )

781 ifĞ
v”bo£
 != 0 )

782 
	`´štf
( "failed\n" );

787 ifĞ
v”bo£
 != 0 )

788 
	`´štf
( "passed\n PKCS#1 data sign : " );

790 
	`sha1
Ğ
r§_¶aš‹xt
, 
PT_LEN
, 
sha1sum
 );

792 ifĞ
	`r§_pkcs1_sign
Ğ&
r§
, 
RSA_PRIVATE
, 
SIG_RSA_SHA1
, 20,

793 
sha1sum
, 
r§_ch”‹xt
 ) != 0 )

795 ifĞ
v”bo£
 != 0 )

796 
	`´štf
( "failed\n" );

801 ifĞ
v”bo£
 != 0 )

802 
	`´štf
( "passed\n PKCS#1 sig. verify: " );

804 ifĞ
	`r§_pkcs1_v”ify
Ğ&
r§
, 
RSA_PUBLIC
, 
SIG_RSA_SHA1
, 20,

805 
sha1sum
, 
r§_ch”‹xt
 ) != 0 )

807 ifĞ
v”bo£
 != 0 )

808 
	`´štf
( "failed\n" );

813 ifĞ
v”bo£
 != 0 )

814 
	`´štf
( "passed\n\n" );

816 
	`r§_ä“
Ğ&
r§
 );

819 
	}
}

	@tools/src/polarssl/rsa.h

25 #iâdeà
POLARSSL_RSA_H


26 
	#POLARSSL_RSA_H


	)

28 
	~"pŞ¬s¦/bignum.h
"

33 
	#POLARSSL_ERR_RSA_BAD_INPUT_DATA
 -0x0400

	)

34 
	#POLARSSL_ERR_RSA_INVALID_PADDING
 -0x0410

	)

35 
	#POLARSSL_ERR_RSA_KEY_GEN_FAILED
 -0x0420

	)

36 
	#POLARSSL_ERR_RSA_KEY_CHECK_FAILED
 -0x0430

	)

37 
	#POLARSSL_ERR_RSA_PUBLIC_FAILED
 -0x0440

	)

38 
	#POLARSSL_ERR_RSA_PRIVATE_FAILED
 -0x0450

	)

39 
	#POLARSSL_ERR_RSA_VERIFY_FAILED
 -0x0460

	)

40 
	#POLARSSL_ERR_RSA_OUTPUT_TOO_LARGE
 -0x0470

	)

41 
	#POLARSSL_ERR_RSA_RNG_FAILED
 -0x0480

	)

46 
	#SIG_RSA_RAW
 0

	)

47 
	#SIG_RSA_MD2
 2

	)

48 
	#SIG_RSA_MD4
 3

	)

49 
	#SIG_RSA_MD5
 4

	)

50 
	#SIG_RSA_SHA1
 5

	)

51 
	#SIG_RSA_SHA224
 14

	)

52 
	#SIG_RSA_SHA256
 11

	)

53 
	#SIG_RSA_SHA384
 12

	)

54 
	#SIG_RSA_SHA512
 13

	)

56 
	#RSA_PUBLIC
 0

	)

57 
	#RSA_PRIVATE
 1

	)

59 
	#RSA_PKCS_V15
 0

	)

60 
	#RSA_PKCS_V21
 1

	)

62 
	#RSA_SIGN
 1

	)

63 
	#RSA_CRYPT
 2

	)

65 
	#ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x30"

	)

66 
	#ASN1_STR_NULL
 "\x05"

	)

67 
	#ASN1_STR_OID
 "\x06"

	)

68 
	#ASN1_STR_OCTET_STRING
 "\x04"

	)

70 
	#OID_DIGEST_ALG_MDX
 "\x2A\x86\x48\x86\xF7\x0D\x02\x00"

	)

71 
	#OID_HASH_ALG_SHA1
 "\x2b\x0e\x03\x02\x1a"

	)

72 
	#OID_HASH_ALG_SHA2X
 "\x60\x86\x48\x01\x65\x03\x04\x02\x00"

	)

74 
	#OID_ISO_MEMBER_BODIES
 "\x2a"

	)

75 
	#OID_ISO_IDENTIFIED_ORG
 "\x2b"

	)

80 
	#OID_COUNTRY_US
 "\x86\x48"

	)

81 
	#OID_RSA_DATA_SECURITY
 "\x86\xf7\x0d"

	)

86 
	#OID_OIW_SECSIG_SHA1
 "\x0e\x03\x02\x1a"

	)

97 
	#ASN1_HASH_MDX
 \

99 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x20" \

100 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x0C" \

101 
ASN1_STR_OID
 "\x08" \

102 
OID_DIGEST_ALG_MDX
 \

103 
ASN1_STR_NULL
 "\x00" \

104 
ASN1_STR_OCTET_STRING
 "\x10" \

105 )

	)

107 
	#ASN1_HASH_SHA1
 \

108 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x21" \

109 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x09" \

110 
ASN1_STR_OID
 "\x05" \

111 
OID_HASH_ALG_SHA1
 \

112 
ASN1_STR_NULL
 "\x00" \

113 
ASN1_STR_OCTET_STRING
 "\x14"

	)

115 
	#ASN1_HASH_SHA2X
 \

116 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x11" \

117 
ASN1_STR_CONSTRUCTED_SEQUENCE
 "\x0d" \

118 
ASN1_STR_OID
 "\x09" \

119 
OID_HASH_ALG_SHA2X
 \

120 
ASN1_STR_NULL
 "\x00" \

121 
ASN1_STR_OCTET_STRING
 "\x00"

	)

128 
	mv”
;

129 
	mËn
;

131 
mpi
 
	mN
;

132 
mpi
 
	mE
;

134 
mpi
 
	mD
;

135 
mpi
 
	mP
;

136 
mpi
 
	mQ
;

137 
mpi
 
	mDP
;

138 
mpi
 
	mDQ
;

139 
mpi
 
	mQP
;

141 
mpi
 
	mRN
;

142 
mpi
 
	mRP
;

143 
mpi
 
	mRQ
;

145 
	m·ddšg
;

146 
	mhash_id
;

148 
	tr§_cÚ‹xt
;

150 #ifdeà
__ılu¥lus


167 
r§_š™
Ğ
r§_cÚ‹xt
 *
ùx
,

168 
·ddšg
,

169 
hash_id
);

185 
r§_g’_key
Ğ
r§_cÚ‹xt
 *
ùx
,

186 (*
f_ºg
)(*),

187 *
p_ºg
,

188 
nb™s
, 
expÚ’t
 );

197 
r§_check_pubkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 );

206 
r§_check_´ivkey
ĞcÚ¡ 
r§_cÚ‹xt
 *
ùx
 );

224 
r§_public
Ğ
r§_cÚ‹xt
 *
ùx
,

225 cÚ¡ *
šput
,

226 *
ouut
 );

240 
r§_´iv©e
Ğ
r§_cÚ‹xt
 *
ùx
,

241 cÚ¡ *
šput
,

242 *
ouut
 );

260 
r§_pkcs1_’üy±
Ğ
r§_cÚ‹xt
 *
ùx
,

261 (*
f_ºg
)(*),

262 *
p_ºg
,

263 
mode
, 
’
,

264 cÚ¡ *
šput
,

265 *
ouut
 );

283 
r§_pkcs1_deüy±
Ğ
r§_cÚ‹xt
 *
ùx
,

284 
mode
, *
Ş’
,

285 cÚ¡ *
šput
,

286 *
ouut
,

287 
ouut_max_Ën
 );

305 
r§_pkcs1_sign
Ğ
r§_cÚ‹xt
 *
ùx
,

306 
mode
,

307 
hash_id
,

308 
hashËn
,

309 cÚ¡ *
hash
,

310 *
sig
 );

328 
r§_pkcs1_v”ify
Ğ
r§_cÚ‹xt
 *
ùx
,

329 
mode
,

330 
hash_id
,

331 
hashËn
,

332 cÚ¡ *
hash
,

333 *
sig
 );

340 
r§_ä“
Ğ
r§_cÚ‹xt
 *
ùx
 );

347 
r§_£lf_‹¡
Ğ
v”bo£
 );

349 #ifdeà
__ılu¥lus


	@tools/src/polarssl/sha1.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_SHA1_C
)

35 
	~"pŞ¬s¦/sha1.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

66 
	$sha1_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
 )

68 
ùx
->
tÙ®
[0] = 0;

69 
ùx
->
tÙ®
[1] = 0;

71 
ùx
->
¡©e
[0] = 0x67452301;

72 
ùx
->
¡©e
[1] = 0xEFCDAB89;

73 
ùx
->
¡©e
[2] = 0x98BADCFE;

74 
ùx
->
¡©e
[3] = 0x10325476;

75 
ùx
->
¡©e
[4] = 0xC3D2E1F0;

76 
	}
}

78 
	$sha1_´oûss
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

80 
‹mp
, 
W
[16], 
A
, 
B
, 
C
, 
D
, 
E
;

82 
	`GET_ULONG_BE
Ğ
W
[ 0], 
d©a
, 0 );

83 
	`GET_ULONG_BE
Ğ
W
[ 1], 
d©a
, 4 );

84 
	`GET_ULONG_BE
Ğ
W
[ 2], 
d©a
, 8 );

85 
	`GET_ULONG_BE
Ğ
W
[ 3], 
d©a
, 12 );

86 
	`GET_ULONG_BE
Ğ
W
[ 4], 
d©a
, 16 );

87 
	`GET_ULONG_BE
Ğ
W
[ 5], 
d©a
, 20 );

88 
	`GET_ULONG_BE
Ğ
W
[ 6], 
d©a
, 24 );

89 
	`GET_ULONG_BE
Ğ
W
[ 7], 
d©a
, 28 );

90 
	`GET_ULONG_BE
Ğ
W
[ 8], 
d©a
, 32 );

91 
	`GET_ULONG_BE
Ğ
W
[ 9], 
d©a
, 36 );

92 
	`GET_ULONG_BE
Ğ
W
[10], 
d©a
, 40 );

93 
	`GET_ULONG_BE
Ğ
W
[11], 
d©a
, 44 );

94 
	`GET_ULONG_BE
Ğ
W
[12], 
d©a
, 48 );

95 
	`GET_ULONG_BE
Ğ
W
[13], 
d©a
, 52 );

96 
	`GET_ULONG_BE
Ğ
W
[14], 
d©a
, 56 );

97 
	`GET_ULONG_BE
Ğ
W
[15], 
d©a
, 60 );

99 
	#S
(
x
,
n
è((x <<‚è| ((x & 0xFFFFFFFFè>> (32 -‚)))

	)

101 
	#R
(
t
) \

103 
‹mp
 = 
W
[(
t
 - 3) & 0x0F] ^ W[(t - 8) & 0x0F] ^ \

104 
W
[(
t
 - 14) & 0x0F] ^ W[ & 0x0F], \

105 Ğ
W
[
t
 & 0x0F] = 
	`S
(
‹mp
,1) ) \

106 )

	)

108 
	#P
(
a
,
b
,
c
,
d
,
e
,
x
) \

110 
e
 +ğ
	`S
(
a
,5è+ 
	`F
(
b
,
c
,
d
è+ 
K
 + 
x
; b = S(b,30); \

111 }

	)

113 
A
 = 
ùx
->
¡©e
[0];

114 
B
 = 
ùx
->
¡©e
[1];

115 
C
 = 
ùx
->
¡©e
[2];

116 
D
 = 
ùx
->
¡©e
[3];

117 
E
 = 
ùx
->
¡©e
[4];

119 
	#F
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

120 
	#K
 0x5A827999

	)

122 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[0] );

123 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
W
[1] );

124 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
W
[2] );

125 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
W
[3] );

126 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
W
[4] );

127 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[5] );

128 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
W
[6] );

129 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
W
[7] );

130 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
W
[8] );

131 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
W
[9] );

132 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[10] );

133 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
W
[11] );

134 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
W
[12] );

135 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
W
[13] );

136 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
W
[14] );

137 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
W
[15] );

138 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(16) );

139 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(17) );

140 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(18) );

141 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(19) );

143 #undeà
K


144 #undeà
F


146 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

147 
	#K
 0x6ED9EBA1

	)

149 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(20) );

150 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(21) );

151 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(22) );

152 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(23) );

153 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(24) );

154 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(25) );

155 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(26) );

156 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(27) );

157 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(28) );

158 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(29) );

159 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(30) );

160 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(31) );

161 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(32) );

162 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(33) );

163 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(34) );

164 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(35) );

165 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(36) );

166 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(37) );

167 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(38) );

168 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(39) );

170 #undeà
K


171 #undeà
F


173 
	#F
(
x
,
y
,
z
è((x & yè| (z & (x | y)))

	)

174 
	#K
 0x8F1BBCDC

	)

176 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(40) );

177 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(41) );

178 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(42) );

179 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(43) );

180 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(44) );

181 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(45) );

182 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(46) );

183 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(47) );

184 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(48) );

185 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(49) );

186 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(50) );

187 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(51) );

188 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(52) );

189 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(53) );

190 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(54) );

191 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(55) );

192 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(56) );

193 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(57) );

194 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(58) );

195 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(59) );

197 #undeà
K


198 #undeà
F


200 
	#F
(
x
,
y
,
z
è(x ^ y ^ z)

	)

201 
	#K
 0xCA62C1D6

	)

203 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(60) );

204 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(61) );

205 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(62) );

206 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(63) );

207 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(64) );

208 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(65) );

209 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(66) );

210 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(67) );

211 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(68) );

212 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(69) );

213 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(70) );

214 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(71) );

215 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(72) );

216 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(73) );

217 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(74) );

218 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(75) );

219 
	`P
Ğ
E
, 
A
, 
B
, 
C
, 
D
, 
	`R
(76) );

220 
	`P
Ğ
D
, 
E
, 
A
, 
B
, 
C
, 
	`R
(77) );

221 
	`P
Ğ
C
, 
D
, 
E
, 
A
, 
B
, 
	`R
(78) );

222 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
A
, 
	`R
(79) );

224 #undeà
K


225 #undeà
F


227 
ùx
->
¡©e
[0] +ğ
A
;

228 
ùx
->
¡©e
[1] +ğ
B
;

229 
ùx
->
¡©e
[2] +ğ
C
;

230 
ùx
->
¡©e
[3] +ğ
D
;

231 
ùx
->
¡©e
[4] +ğ
E
;

232 
	}
}

237 
	$sha1_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

239 
fl
;

240 
Ëá
;

242 ifĞ
’
 <= 0 )

245 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

246 
fl
 = 64 - 
Ëá
;

248 
ùx
->
tÙ®
[0] +ğ
’
;

249 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

251 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

252 
ùx
->
tÙ®
[1]++;

254 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

256 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

257 (*è
šput
, 
fl
 );

258 
	`sha1_´oûss
Ğ
ùx
, ctx->
bufãr
 );

259 
šput
 +ğ
fl
;

260 
’
 -ğ
fl
;

261 
Ëá
 = 0;

264  
’
 >= 64 )

266 
	`sha1_´oûss
Ğ
ùx
, 
šput
 );

267 
šput
 += 64;

268 
’
 -= 64;

271 ifĞ
’
 > 0 )

273 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

274 (*è
šput
, 
’
 );

276 
	}
}

278 cÚ¡ 
	gsha1_·ddšg
[64] =

289 
	$sha1_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] )

291 
Ï¡
, 
·dn
;

292 
high
, 
low
;

293 
msgËn
[8];

295 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

296 | ( 
ùx
->
tÙ®
[1] << 3 );

297 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

299 
	`PUT_ULONG_BE
Ğ
high
, 
msgËn
, 0 );

300 
	`PUT_ULONG_BE
Ğ
low
, 
msgËn
, 4 );

302 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

303 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

305 
	`sha1_upd©e
Ğ
ùx
, (*è
sha1_·ddšg
, 
·dn
 );

306 
	`sha1_upd©e
Ğ
ùx
, 
msgËn
, 8 );

308 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

309 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

310 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

311 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

312 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[4], 
ouut
, 16 );

313 
	}
}

318 
	$sha1
ĞcÚ¡ *
šput
, 
’
, 
ouut
[20] )

320 
sha1_cÚ‹xt
 
ùx
;

322 
	`sha1_¡¬ts
Ğ&
ùx
 );

323 
	`sha1_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

324 
	`sha1_fšish
Ğ&
ùx
, 
ouut
 );

326 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha1_cÚ‹xt
 ) );

327 
	}
}

332 
	$sha1_fe
ĞcÚ¡ *
·th
, 
ouut
[20] )

334 
FILE
 *
f
;

335 
size_t
 
n
;

336 
sha1_cÚ‹xt
 
ùx
;

337 
buf
[1024];

339 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

342 
	`sha1_¡¬ts
Ğ&
ùx
 );

344  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

345 
	`sha1_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

347 
	`sha1_fšish
Ğ&
ùx
, 
ouut
 );

349 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha1_cÚ‹xt
 ) );

351 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

353 
	`fşo£
Ğ
f
 );

357 
	`fşo£
Ğ
f
 );

359 
	}
}

364 
	$sha1_hmac_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 )

366 
i
;

367 
sum
[20];

369 ifĞ
keyËn
 > 64 )

371 
	`sha1
Ğ
key
, 
keyËn
, 
sum
 );

372 
keyËn
 = 20;

373 
key
 = 
sum
;

376 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

377 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

379  
i
 = 0; i < 
keyËn
; i++ )

381 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

382 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

385 
	`sha1_¡¬ts
Ğ
ùx
 );

386 
	`sha1_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

388 
	`mem£t
Ğ
sum
, 0, ( sum ) );

389 
	}
}

394 
	$sha1_hmac_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

396 
	`sha1_upd©e
Ğ
ùx
, 
šput
, 
’
 );

397 
	}
}

402 
	$sha1_hmac_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] )

404 
tmpbuf
[20];

406 
	`sha1_fšish
Ğ
ùx
, 
tmpbuf
 );

407 
	`sha1_¡¬ts
Ğ
ùx
 );

408 
	`sha1_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

409 
	`sha1_upd©e
Ğ
ùx
, 
tmpbuf
, 20 );

410 
	`sha1_fšish
Ğ
ùx
, 
ouut
 );

412 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

413 
	}
}

418 
	$sha1_hmac_»£t
Ğ
sha1_cÚ‹xt
 *
ùx
 )

420 
	`sha1_¡¬ts
Ğ
ùx
 );

421 
	`sha1_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

422 
	}
}

427 
	$sha1_hmac
ĞcÚ¡ *
key
, 
keyËn
,

428 cÚ¡ *
šput
, 
’
,

429 
ouut
[20] )

431 
sha1_cÚ‹xt
 
ùx
;

433 
	`sha1_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
 );

434 
	`sha1_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

435 
	`sha1_hmac_fšish
Ğ&
ùx
, 
ouut
 );

437 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha1_cÚ‹xt
 ) );

438 
	}
}

440 #ià
defšed
(
POLARSSL_SELF_TEST
)

444 
	gsha1_‹¡_buf
[3][57] =

451 cÚ¡ 
	gsha1_‹¡_buæ’
[3] =

456 cÚ¡ 
	gsha1_‹¡_sum
[3][20] =

469 
	gsha1_hmac_‹¡_key
[7][26] =

484 cÚ¡ 
	gsha1_hmac_‹¡_keyËn
[7] =

489 
	gsha1_hmac_‹¡_buf
[7][74] =

509 cÚ¡ 
	gsha1_hmac_‹¡_buæ’
[7] =

514 cÚ¡ 
	gsha1_hmac_‹¡_sum
[7][20] =

535 
	$sha1_£lf_‹¡
Ğ
v”bo£
 )

537 
i
, 
j
, 
buæ’
;

538 
buf
[1024];

539 
sha1sum
[20];

540 
sha1_cÚ‹xt
 
ùx
;

545  
i
 = 0; i < 3; i++ )

547 ifĞ
v”bo£
 != 0 )

548 
	`´štf
Ğ" SHA-1e¡ #%d: ", 
i
 + 1 );

550 
	`sha1_¡¬ts
Ğ&
ùx
 );

552 ifĞ
i
 == 2 )

554 
	`mem£t
Ğ
buf
, 'a', 
buæ’
 = 1000 );

556  
j
 = 0; j < 1000; j++ )

557 
	`sha1_upd©e
Ğ&
ùx
, 
buf
, 
buæ’
 );

560 
	`sha1_upd©e
Ğ&
ùx
, 
sha1_‹¡_buf
[
i
],

561 
sha1_‹¡_buæ’
[
i
] );

563 
	`sha1_fšish
Ğ&
ùx
, 
sha1sum
 );

565 ifĞ
	`memcmp
Ğ
sha1sum
, 
sha1_‹¡_sum
[
i
], 20 ) != 0 )

567 ifĞ
v”bo£
 != 0 )

568 
	`´štf
( "failed\n" );

573 ifĞ
v”bo£
 != 0 )

574 
	`´štf
( "passed\n" );

577 ifĞ
v”bo£
 != 0 )

578 
	`´štf
( "\n" );

580  
i
 = 0; i < 7; i++ )

582 ifĞ
v”bo£
 != 0 )

583 
	`´štf
Ğ" HMAC-SHA-1e¡ #%d: ", 
i
 + 1 );

585 ifĞ
i
 == 5 || i == 6 )

587 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 80 );

588 
	`sha1_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
 );

591 
	`sha1_hmac_¡¬ts
Ğ&
ùx
, 
sha1_hmac_‹¡_key
[
i
],

592 
sha1_hmac_‹¡_keyËn
[
i
] );

594 
	`sha1_hmac_upd©e
Ğ&
ùx
, 
sha1_hmac_‹¡_buf
[
i
],

595 
sha1_hmac_‹¡_buæ’
[
i
] );

597 
	`sha1_hmac_fšish
Ğ&
ùx
, 
sha1sum
 );

599 
buæ’
 = ( 
i
 == 4 ) ? 12 : 20;

601 ifĞ
	`memcmp
Ğ
sha1sum
, 
sha1_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

603 ifĞ
v”bo£
 != 0 )

604 
	`´štf
( "failed\n" );

609 ifĞ
v”bo£
 != 0 )

610 
	`´štf
( "passed\n" );

613 ifĞ
v”bo£
 != 0 )

614 
	`´štf
( "\n" );

617 
	}
}

	@tools/src/polarssl/sha1.h

25 #iâdeà
POLARSSL_SHA1_H


26 
	#POLARSSL_SHA1_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[5];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

40 
	tsha1_cÚ‹xt
;

42 #ifdeà
__ılu¥lus


51 
sha1_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
 );

60 
sha1_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

68 
sha1_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] );

77 
sha1
ĞcÚ¡ *
šput
, 
’
, 
ouut
[20] );

88 
sha1_fe
ĞcÚ¡ *
·th
, 
ouut
[20] );

97 
sha1_hmac_¡¬ts
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
 );

106 
sha1_hmac_upd©e
Ğ
sha1_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

114 
sha1_hmac_fšish
Ğ
sha1_cÚ‹xt
 *
ùx
, 
ouut
[20] );

121 
sha1_hmac_»£t
Ğ
sha1_cÚ‹xt
 *
ùx
 );

132 
sha1_hmac
ĞcÚ¡ *
key
, 
keyËn
,

133 cÚ¡ *
šput
, 
’
,

134 
ouut
[20] );

141 
sha1_£lf_‹¡
Ğ
v”bo£
 );

143 #ifdeà
__ılu¥lus


	@tools/src/polarssl/sha2.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_SHA2_C
)

35 
	~"pŞ¬s¦/sha2.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_ULONG_BE


44 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

47 | ( (è(
b
)[(
i
) + 1] << 16 ) \

48 | ( (è(
b
)[(
i
) + 2] << 8 ) \

49 | ( (è(
b
)[(
i
) + 3] ); \

50 }

	)

53 #iâdeà
PUT_ULONG_BE


54 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

56 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

57 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

58 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

59 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

60 }

	)

66 
	$sha2_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, 
is224
 )

68 
ùx
->
tÙ®
[0] = 0;

69 
ùx
->
tÙ®
[1] = 0;

71 ifĞ
is224
 == 0 )

74 
ùx
->
¡©e
[0] = 0x6A09E667;

75 
ùx
->
¡©e
[1] = 0xBB67AE85;

76 
ùx
->
¡©e
[2] = 0x3C6EF372;

77 
ùx
->
¡©e
[3] = 0xA54FF53A;

78 
ùx
->
¡©e
[4] = 0x510E527F;

79 
ùx
->
¡©e
[5] = 0x9B05688C;

80 
ùx
->
¡©e
[6] = 0x1F83D9AB;

81 
ùx
->
¡©e
[7] = 0x5BE0CD19;

86 
ùx
->
¡©e
[0] = 0xC1059ED8;

87 
ùx
->
¡©e
[1] = 0x367CD507;

88 
ùx
->
¡©e
[2] = 0x3070DD17;

89 
ùx
->
¡©e
[3] = 0xF70E5939;

90 
ùx
->
¡©e
[4] = 0xFFC00B31;

91 
ùx
->
¡©e
[5] = 0x68581511;

92 
ùx
->
¡©e
[6] = 0x64F98FA7;

93 
ùx
->
¡©e
[7] = 0xBEFA4FA4;

96 
ùx
->
is224
 = is224;

97 
	}
}

99 
	$sha2_´oûss
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[64] )

101 
‹mp1
, 
‹mp2
, 
W
[64];

102 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
;

104 
	`GET_ULONG_BE
Ğ
W
[ 0], 
d©a
, 0 );

105 
	`GET_ULONG_BE
Ğ
W
[ 1], 
d©a
, 4 );

106 
	`GET_ULONG_BE
Ğ
W
[ 2], 
d©a
, 8 );

107 
	`GET_ULONG_BE
Ğ
W
[ 3], 
d©a
, 12 );

108 
	`GET_ULONG_BE
Ğ
W
[ 4], 
d©a
, 16 );

109 
	`GET_ULONG_BE
Ğ
W
[ 5], 
d©a
, 20 );

110 
	`GET_ULONG_BE
Ğ
W
[ 6], 
d©a
, 24 );

111 
	`GET_ULONG_BE
Ğ
W
[ 7], 
d©a
, 28 );

112 
	`GET_ULONG_BE
Ğ
W
[ 8], 
d©a
, 32 );

113 
	`GET_ULONG_BE
Ğ
W
[ 9], 
d©a
, 36 );

114 
	`GET_ULONG_BE
Ğ
W
[10], 
d©a
, 40 );

115 
	`GET_ULONG_BE
Ğ
W
[11], 
d©a
, 44 );

116 
	`GET_ULONG_BE
Ğ
W
[12], 
d©a
, 48 );

117 
	`GET_ULONG_BE
Ğ
W
[13], 
d©a
, 52 );

118 
	`GET_ULONG_BE
Ğ
W
[14], 
d©a
, 56 );

119 
	`GET_ULONG_BE
Ğ
W
[15], 
d©a
, 60 );

121 
	#SHR
(
x
,
n
è((x & 0xFFFFFFFFè>>‚)

	)

122 
	#ROTR
(
x
,
n
è(
	`SHR
(x,nè| (x << (32 -‚)))

	)

124 
	#S0
(
x
è(
	`ROTR
(x, 7è^ ROTR(x,18è^ 
	`SHR
(x, 3))

	)

125 
	#S1
(
x
è(
	`ROTR
(x,17è^ ROTR(x,19è^ 
	`SHR
(x,10))

	)

127 
	#S2
(
x
è(
	`ROTR
(x, 2è^ ROTR(x,13è^ ROTR(x,22))

	)

128 
	#S3
(
x
è(
	`ROTR
(x, 6è^ ROTR(x,11è^ ROTR(x,25))

	)

130 
	#F0
(
x
,
y
,
z
è((x & yè| (z & (x | y)))

	)

131 
	#F1
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

133 
	#R
(
t
) \

135 
W
[
t
] = 
	`S1
(W[t - 2]) + W[t - 7] + \

136 
	`S0
(
W
[
t
 - 15]) + W[t - 16] \

137 )

	)

139 
	#P
(
a
,
b
,
c
,
d
,
e
,
f
,
g
,
h
,
x
,
K
) \

141 
‹mp1
 = 
h
 + 
	`S3
(
e
è+ 
	`F1
Ó,
f
,
g
è+ 
K
 + 
x
; \

142 
‹mp2
 = 
	`S2
(
a
è+ 
	`F0
×,
b
,
c
); \

143 
d
 +ğ
‹mp1
; 
h
 =emp1 + 
‹mp2
; \

144 }

	)

146 
A
 = 
ùx
->
¡©e
[0];

147 
B
 = 
ùx
->
¡©e
[1];

148 
C
 = 
ùx
->
¡©e
[2];

149 
D
 = 
ùx
->
¡©e
[3];

150 
E
 = 
ùx
->
¡©e
[4];

151 
F
 = 
ùx
->
¡©e
[5];

152 
G
 = 
ùx
->
¡©e
[6];

153 
H
 = 
ùx
->
¡©e
[7];

155 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
W
[ 0], 0x428A2F98 );

156 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
W
[ 1], 0x71374491 );

157 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
W
[ 2], 0xB5C0FBCF );

158 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
W
[ 3], 0xE9B5DBA5 );

159 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
W
[ 4], 0x3956C25B );

160 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
W
[ 5], 0x59F111F1 );

161 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
W
[ 6], 0x923F82A4 );

162 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
W
[ 7], 0xAB1C5ED5 );

163 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
W
[ 8], 0xD807AA98 );

164 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
W
[ 9], 0x12835B01 );

165 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
W
[10], 0x243185BE );

166 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
W
[11], 0x550C7DC3 );

167 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
W
[12], 0x72BE5D74 );

168 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
W
[13], 0x80DEB1FE );

169 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
W
[14], 0x9BDC06A7 );

170 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
W
[15], 0xC19BF174 );

171 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(16), 0xE49B69C1 );

172 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(17), 0xEFBE4786 );

173 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(18), 0x0FC19DC6 );

174 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(19), 0x240CA1CC );

175 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(20), 0x2DE92C6F );

176 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(21), 0x4A7484AA );

177 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(22), 0x5CB0A9DC );

178 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(23), 0x76F988DA );

179 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(24), 0x983E5152 );

180 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(25), 0xA831C66D );

181 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(26), 0xB00327C8 );

182 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(27), 0xBF597FC7 );

183 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(28), 0xC6E00BF3 );

184 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(29), 0xD5A79147 );

185 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(30), 0x06CA6351 );

186 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(31), 0x14292967 );

187 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(32), 0x27B70A85 );

188 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(33), 0x2E1B2138 );

189 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(34), 0x4D2C6DFC );

190 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(35), 0x53380D13 );

191 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(36), 0x650A7354 );

192 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(37), 0x766A0ABB );

193 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(38), 0x81C2C92E );

194 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(39), 0x92722C85 );

195 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(40), 0xA2BFE8A1 );

196 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(41), 0xA81A664B );

197 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(42), 0xC24B8B70 );

198 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(43), 0xC76C51A3 );

199 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(44), 0xD192E819 );

200 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(45), 0xD6990624 );

201 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(46), 0xF40E3585 );

202 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(47), 0x106AA070 );

203 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(48), 0x19A4C116 );

204 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(49), 0x1E376C08 );

205 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(50), 0x2748774C );

206 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(51), 0x34B0BCB5 );

207 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(52), 0x391C0CB3 );

208 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(53), 0x4ED8AA4A );

209 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(54), 0x5B9CCA4F );

210 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(55), 0x682E6FF3 );

211 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
	`R
(56), 0x748F82EE );

212 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
	`R
(57), 0x78A5636F );

213 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
	`R
(58), 0x84C87814 );

214 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
	`R
(59), 0x8CC70208 );

215 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
	`R
(60), 0x90BEFFFA );

216 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
	`R
(61), 0xA4506CEB );

217 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
	`R
(62), 0xBEF9A3F7 );

218 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
	`R
(63), 0xC67178F2 );

220 
ùx
->
¡©e
[0] +ğ
A
;

221 
ùx
->
¡©e
[1] +ğ
B
;

222 
ùx
->
¡©e
[2] +ğ
C
;

223 
ùx
->
¡©e
[3] +ğ
D
;

224 
ùx
->
¡©e
[4] +ğ
E
;

225 
ùx
->
¡©e
[5] +ğ
F
;

226 
ùx
->
¡©e
[6] +ğ
G
;

227 
ùx
->
¡©e
[7] +ğ
H
;

228 
	}
}

233 
	$sha2_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

235 
fl
;

236 
Ëá
;

238 ifĞ
’
 <= 0 )

241 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x3F;

242 
fl
 = 64 - 
Ëá
;

244 
ùx
->
tÙ®
[0] +ğ
’
;

245 
ùx
->
tÙ®
[0] &= 0xFFFFFFFF;

247 ifĞ
ùx
->
tÙ®
[0] < (è
’
 )

248 
ùx
->
tÙ®
[1]++;

250 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

252 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

253 (*è
šput
, 
fl
 );

254 
	`sha2_´oûss
Ğ
ùx
, ctx->
bufãr
 );

255 
šput
 +ğ
fl
;

256 
’
 -ğ
fl
;

257 
Ëá
 = 0;

260  
’
 >= 64 )

262 
	`sha2_´oûss
Ğ
ùx
, 
šput
 );

263 
šput
 += 64;

264 
’
 -= 64;

267 ifĞ
’
 > 0 )

269 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

270 (*è
šput
, 
’
 );

272 
	}
}

274 cÚ¡ 
	gsha2_·ddšg
[64] =

285 
	$sha2_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] )

287 
Ï¡
, 
·dn
;

288 
high
, 
low
;

289 
msgËn
[8];

291 
high
 = ( 
ùx
->
tÙ®
[0] >> 29 )

292 | ( 
ùx
->
tÙ®
[1] << 3 );

293 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

295 
	`PUT_ULONG_BE
Ğ
high
, 
msgËn
, 0 );

296 
	`PUT_ULONG_BE
Ğ
low
, 
msgËn
, 4 );

298 
Ï¡
 = 
ùx
->
tÙ®
[0] & 0x3F;

299 
·dn
 = ( 
Ï¡
 < 56 ) ? ( 56 -†ast ) : ( 120 -†ast );

301 
	`sha2_upd©e
Ğ
ùx
, (*è
sha2_·ddšg
, 
·dn
 );

302 
	`sha2_upd©e
Ğ
ùx
, 
msgËn
, 8 );

304 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

305 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[1], 
ouut
, 4 );

306 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[2], 
ouut
, 8 );

307 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[3], 
ouut
, 12 );

308 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[4], 
ouut
, 16 );

309 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[5], 
ouut
, 20 );

310 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[6], 
ouut
, 24 );

312 ifĞ
ùx
->
is224
 == 0 )

313 
	`PUT_ULONG_BE
Ğ
ùx
->
¡©e
[7], 
ouut
, 28 );

314 
	}
}

319 
	$sha2
ĞcÚ¡ *
šput
, 
’
,

320 
ouut
[32], 
is224
 )

322 
sha2_cÚ‹xt
 
ùx
;

324 
	`sha2_¡¬ts
Ğ&
ùx
, 
is224
 );

325 
	`sha2_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

326 
	`sha2_fšish
Ğ&
ùx
, 
ouut
 );

328 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha2_cÚ‹xt
 ) );

329 
	}
}

334 
	$sha2_fe
ĞcÚ¡ *
·th
, 
ouut
[32], 
is224
 )

336 
FILE
 *
f
;

337 
size_t
 
n
;

338 
sha2_cÚ‹xt
 
ùx
;

339 
buf
[1024];

341 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

344 
	`sha2_¡¬ts
Ğ&
ùx
, 
is224
 );

346  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

347 
	`sha2_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

349 
	`sha2_fšish
Ğ&
ùx
, 
ouut
 );

351 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha2_cÚ‹xt
 ) );

353 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

355 
	`fşo£
Ğ
f
 );

359 
	`fşo£
Ğ
f
 );

361 
	}
}

366 
	$sha2_hmac_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

367 
is224
 )

369 
i
;

370 
sum
[32];

372 ifĞ
keyËn
 > 64 )

374 
	`sha2
Ğ
key
, 
keyËn
, 
sum
, 
is224
 );

375 
keyËn
 = ( 
is224
 ) ? 28 : 32;

376 
key
 = 
sum
;

379 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 64 );

380 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 64 );

382  
i
 = 0; i < 
keyËn
; i++ )

384 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

385 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

388 
	`sha2_¡¬ts
Ğ
ùx
, 
is224
 );

389 
	`sha2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

391 
	`mem£t
Ğ
sum
, 0, ( sum ) );

392 
	}
}

397 
	$sha2_hmac_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

399 
	`sha2_upd©e
Ğ
ùx
, 
šput
, 
’
 );

400 
	}
}

405 
	$sha2_hmac_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] )

407 
is224
, 
hËn
;

408 
tmpbuf
[32];

410 
is224
 = 
ùx
->is224;

411 
hËn
 = ( 
is224
 == 0 ) ? 32 : 28;

413 
	`sha2_fšish
Ğ
ùx
, 
tmpbuf
 );

414 
	`sha2_¡¬ts
Ğ
ùx
, 
is224
 );

415 
	`sha2_upd©e
Ğ
ùx
, ctx->
İad
, 64 );

416 
	`sha2_upd©e
Ğ
ùx
, 
tmpbuf
, 
hËn
 );

417 
	`sha2_fšish
Ğ
ùx
, 
ouut
 );

419 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

420 
	}
}

425 
	$sha2_hmac_»£t
Ğ
sha2_cÚ‹xt
 *
ùx
 )

427 
	`sha2_¡¬ts
Ğ
ùx
, ctx->
is224
 );

428 
	`sha2_upd©e
Ğ
ùx
, ctx->
ad
, 64 );

429 
	}
}

434 
	$sha2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

435 cÚ¡ *
šput
, 
’
,

436 
ouut
[32], 
is224
 )

438 
sha2_cÚ‹xt
 
ùx
;

440 
	`sha2_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
, 
is224
 );

441 
	`sha2_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

442 
	`sha2_hmac_fšish
Ğ&
ùx
, 
ouut
 );

444 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha2_cÚ‹xt
 ) );

445 
	}
}

447 #ià
defšed
(
POLARSSL_SELF_TEST
)

451 
	gsha2_‹¡_buf
[3][57] =

458 cÚ¡ 
	gsha2_‹¡_buæ’
[3] =

463 cÚ¡ 
	gsha2_‹¡_sum
[6][32] =

501 
	gsha2_hmac_‹¡_key
[7][26] =

516 cÚ¡ 
	gsha2_hmac_‹¡_keyËn
[7] =

521 
	gsha2_hmac_‹¡_buf
[7][153] =

542 cÚ¡ 
	gsha2_hmac_‹¡_buæ’
[7] =

547 cÚ¡ 
	gsha2_hmac_‹¡_sum
[14][32] =

613 
	$sha2_£lf_‹¡
Ğ
v”bo£
 )

615 
i
, 
j
, 
k
, 
buæ’
;

616 
buf
[1024];

617 
sha2sum
[32];

618 
sha2_cÚ‹xt
 
ùx
;

620  
i
 = 0; i < 6; i++ )

622 
j
 = 
i
 % 3;

623 
k
 = 
i
 < 3;

625 ifĞ
v”bo£
 != 0 )

626 
	`´štf
Ğ" SHA-%de¡ #%d: ", 256 - 
k
 * 32, 
j
 + 1 );

628 
	`sha2_¡¬ts
Ğ&
ùx
, 
k
 );

630 ifĞ
j
 == 2 )

632 
	`mem£t
Ğ
buf
, 'a', 
buæ’
 = 1000 );

634  
j
 = 0; j < 1000; j++ )

635 
	`sha2_upd©e
Ğ&
ùx
, 
buf
, 
buæ’
 );

638 
	`sha2_upd©e
Ğ&
ùx
, 
sha2_‹¡_buf
[
j
],

639 
sha2_‹¡_buæ’
[
j
] );

641 
	`sha2_fšish
Ğ&
ùx
, 
sha2sum
 );

643 ifĞ
	`memcmp
Ğ
sha2sum
, 
sha2_‹¡_sum
[
i
], 32 - 
k
 * 4 ) != 0 )

645 ifĞ
v”bo£
 != 0 )

646 
	`´štf
( "failed\n" );

651 ifĞ
v”bo£
 != 0 )

652 
	`´štf
( "passed\n" );

655 ifĞ
v”bo£
 != 0 )

656 
	`´štf
( "\n" );

658  
i
 = 0; i < 14; i++ )

660 
j
 = 
i
 % 7;

661 
k
 = 
i
 < 7;

663 ifĞ
v”bo£
 != 0 )

664 
	`´štf
Ğ" HMAC-SHA-%de¡ #%d: ", 256 - 
k
 * 32, 
j
 + 1 );

666 ifĞ
j
 == 5 || j == 6 )

668 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 131 );

669 
	`sha2_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
, 
k
 );

672 
	`sha2_hmac_¡¬ts
Ğ&
ùx
, 
sha2_hmac_‹¡_key
[
j
],

673 
sha2_hmac_‹¡_keyËn
[
j
], 
k
 );

675 
	`sha2_hmac_upd©e
Ğ&
ùx
, 
sha2_hmac_‹¡_buf
[
j
],

676 
sha2_hmac_‹¡_buæ’
[
j
] );

678 
	`sha2_hmac_fšish
Ğ&
ùx
, 
sha2sum
 );

680 
buæ’
 = ( 
j
 =ğ4 ) ? 16 : 32 - 
k
 * 4;

682 ifĞ
	`memcmp
Ğ
sha2sum
, 
sha2_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

684 ifĞ
v”bo£
 != 0 )

685 
	`´štf
( "failed\n" );

690 ifĞ
v”bo£
 != 0 )

691 
	`´štf
( "passed\n" );

694 ifĞ
v”bo£
 != 0 )

695 
	`´štf
( "\n" );

698 
	}
}

	@tools/src/polarssl/sha2.h

25 #iâdeà
POLARSSL_SHA2_H


26 
	#POLARSSL_SHA2_H


	)

33 
	mtÙ®
[2];

34 
	m¡©e
[8];

35 
	mbufãr
[64];

37 
	mad
[64];

38 
	mİad
[64];

39 
	mis224
;

41 
	tsha2_cÚ‹xt
;

43 #ifdeà
__ılu¥lus


53 
sha2_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, 
is224
 );

62 
sha2_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

70 
sha2_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] );

80 
sha2
ĞcÚ¡ *
šput
, 
’
,

81 
ouut
[32], 
is224
 );

93 
sha2_fe
ĞcÚ¡ *
·th
, 
ouut
[32], 
is224
 );

103 
sha2_hmac_¡¬ts
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

104 
is224
 );

113 
sha2_hmac_upd©e
Ğ
sha2_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

121 
sha2_hmac_fšish
Ğ
sha2_cÚ‹xt
 *
ùx
, 
ouut
[32] );

128 
sha2_hmac_»£t
Ğ
sha2_cÚ‹xt
 *
ùx
 );

140 
sha2_hmac
ĞcÚ¡ *
key
, 
keyËn
,

141 cÚ¡ *
šput
, 
’
,

142 
ouut
[32], 
is224
 );

149 
sha2_£lf_‹¡
Ğ
v”bo£
 );

151 #ifdeà
__ılu¥lus


	@tools/src/polarssl/sha4.c

31 
	~"pŞ¬s¦/cÚfig.h
"

33 #ià
defšed
(
POLARSSL_SHA4_C
)

35 
	~"pŞ¬s¦/sha4.h
"

37 
	~<¡ršg.h
>

38 
	~<¡dio.h
>

43 #iâdeà
GET_UINT64_BE


44 
	#GET_UINT64_BE
(
n
,
b
,
i
) \

46 (
n
èğĞ(
št64
è(
b
)[(
i
) ] << 56 ) \

47 | ( (
št64
è(
b
)[(
i
) + 1] << 48 ) \

48 | ( (
št64
è(
b
)[(
i
) + 2] << 40 ) \

49 | ( (
št64
è(
b
)[(
i
) + 3] << 32 ) \

50 | ( (
št64
è(
b
)[(
i
) + 4] << 24 ) \

51 | ( (
št64
è(
b
)[(
i
) + 5] << 16 ) \

52 | ( (
št64
è(
b
)[(
i
) + 6] << 8 ) \

53 | ( (
št64
è(
b
)[(
i
) + 7] ); \

54 }

	)

57 #iâdeà
PUT_UINT64_BE


58 
	#PUT_UINT64_BE
(
n
,
b
,
i
) \

60 (
b
)[(
i
è] = (èĞ(
n
) >> 56 ); \

61 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 48 ); \

62 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 40 ); \

63 (
b
)[(
i
è+ 3] = (èĞ(
n
) >> 32 ); \

64 (
b
)[(
i
è+ 4] = (èĞ(
n
) >> 24 ); \

65 (
b
)[(
i
è+ 5] = (èĞ(
n
) >> 16 ); \

66 (
b
)[(
i
è+ 6] = (èĞ(
n
) >> 8 ); \

67 (
b
)[(
i
è+ 7] = (èĞ(
n
) ); \

68 }

	)

74 cÚ¡ 
št64
 
	gK
[80] =

76 
UL64
(0x428A2F98D728AE22), UL64(0x7137449123EF65CD),

77 
UL64
(0xB5C0FBCFEC4D3B2F), UL64(0xE9B5DBA58189DBBC),

78 
UL64
(0x3956C25BF348B538), UL64(0x59F111F1B605D019),

79 
UL64
(0x923F82A4AF194F9B), UL64(0xAB1C5ED5DA6D8118),

80 
UL64
(0xD807AA98A3030242), UL64(0x12835B0145706FBE),

81 
UL64
(0x243185BE4EE4B28C), UL64(0x550C7DC3D5FFB4E2),

82 
UL64
(0x72BE5D74F27B896F), UL64(0x80DEB1FE3B1696B1),

83 
UL64
(0x9BDC06A725C71235), UL64(0xC19BF174CF692694),

84 
UL64
(0xE49B69C19EF14AD2), UL64(0xEFBE4786384F25E3),

85 
UL64
(0x0FC19DC68B8CD5B5), UL64(0x240CA1CC77AC9C65),

86 
UL64
(0x2DE92C6F592B0275), UL64(0x4A7484AA6EA6E483),

87 
UL64
(0x5CB0A9DCBD41FBD4), UL64(0x76F988DA831153B5),

88 
UL64
(0x983E5152EE66DFAB), UL64(0xA831C66D2DB43210),

89 
UL64
(0xB00327C898FB213F), UL64(0xBF597FC7BEEF0EE4),

90 
UL64
(0xC6E00BF33DA88FC2), UL64(0xD5A79147930AA725),

91 
UL64
(0x06CA6351E003826F), UL64(0x142929670A0E6E70),

92 
UL64
(0x27B70A8546D22FFC), UL64(0x2E1B21385C26C926),

93 
UL64
(0x4D2C6DFC5AC42AED), UL64(0x53380D139D95B3DF),

94 
UL64
(0x650A73548BAF63DE), UL64(0x766A0ABB3C77B2A8),

95 
UL64
(0x81C2C92E47EDAEE6), UL64(0x92722C851482353B),

96 
UL64
(0xA2BFE8A14CF10364), UL64(0xA81A664BBC423001),

97 
UL64
(0xC24B8B70D0F89791), UL64(0xC76C51A30654BE30),

98 
UL64
(0xD192E819D6EF5218), UL64(0xD69906245565A910),

99 
UL64
(0xF40E35855771202A), UL64(0x106AA07032BBD1B8),

100 
UL64
(0x19A4C116B8D2D0C8), UL64(0x1E376C085141AB53),

101 
UL64
(0x2748774CDF8EEB99), UL64(0x34B0BCB5E19B48A8),

102 
UL64
(0x391C0CB3C5C95A63), UL64(0x4ED8AA4AE3418ACB),

103 
UL64
(0x5B9CCA4F7763E373), UL64(0x682E6FF3D6B2B8A3),

104 
UL64
(0x748F82EE5DEFB2FC), UL64(0x78A5636F43172F60),

105 
UL64
(0x84C87814A1F0AB72), UL64(0x8CC702081A6439EC),

106 
UL64
(0x90BEFFFA23631E28), UL64(0xA4506CEBDE82BDE9),

107 
UL64
(0xBEF9A3F7B2C67915), UL64(0xC67178F2E372532B),

108 
UL64
(0xCA273ECEEA26619C), UL64(0xD186B8C721C0C207),

109 
UL64
(0xEADA7DD6CDE0EB1E), UL64(0xF57D4F7FEE6ED178),

110 
UL64
(0x06F067AA72176FBA), UL64(0x0A637DC5A2C898A6),

111 
UL64
(0x113F9804BEF90DAE), UL64(0x1B710B35131C471B),

112 
UL64
(0x28DB77F523047D84), UL64(0x32CAAB7B40C72493),

113 
UL64
(0x3C9EBE0A15C9BEBC), UL64(0x431D67C49C100D4C),

114 
UL64
(0x4CC5D4BECB3E42B6), UL64(0x597F299CFC657E2A),

115 
UL64
(0x5FCB6FAB3AD6FAEC), UL64(0x6C44198C4A475817)

121 
	$sha4_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, 
is384
 )

123 
ùx
->
tÙ®
[0] = 0;

124 
ùx
->
tÙ®
[1] = 0;

126 ifĞ
is384
 == 0 )

129 
ùx
->
¡©e
[0] = 
	`UL64
(0x6A09E667F3BCC908);

130 
ùx
->
¡©e
[1] = 
	`UL64
(0xBB67AE8584CAA73B);

131 
ùx
->
¡©e
[2] = 
	`UL64
(0x3C6EF372FE94F82B);

132 
ùx
->
¡©e
[3] = 
	`UL64
(0xA54FF53A5F1D36F1);

133 
ùx
->
¡©e
[4] = 
	`UL64
(0x510E527FADE682D1);

134 
ùx
->
¡©e
[5] = 
	`UL64
(0x9B05688C2B3E6C1F);

135 
ùx
->
¡©e
[6] = 
	`UL64
(0x1F83D9ABFB41BD6B);

136 
ùx
->
¡©e
[7] = 
	`UL64
(0x5BE0CD19137E2179);

141 
ùx
->
¡©e
[0] = 
	`UL64
(0xCBBB9D5DC1059ED8);

142 
ùx
->
¡©e
[1] = 
	`UL64
(0x629A292A367CD507);

143 
ùx
->
¡©e
[2] = 
	`UL64
(0x9159015A3070DD17);

144 
ùx
->
¡©e
[3] = 
	`UL64
(0x152FECD8F70E5939);

145 
ùx
->
¡©e
[4] = 
	`UL64
(0x67332667FFC00B31);

146 
ùx
->
¡©e
[5] = 
	`UL64
(0x8EB44A8768581511);

147 
ùx
->
¡©e
[6] = 
	`UL64
(0xDB0C2E0D64F98FA7);

148 
ùx
->
¡©e
[7] = 
	`UL64
(0x47B5481DBEFA4FA4);

151 
ùx
->
is384
 = is384;

152 
	}
}

154 
	$sha4_´oûss
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ 
d©a
[128] )

156 
i
;

157 
št64
 
‹mp1
, 
‹mp2
, 
W
[80];

158 
št64
 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
;

160 
	#SHR
(
x
,
n
è(x >>‚)

	)

161 
	#ROTR
(
x
,
n
è(
	`SHR
(x,nè| (x << (64 -‚)))

	)

163 
	#S0
(
x
è(
	`ROTR
(x, 1è^ ROTR(x, 8è^ 
	`SHR
(x, 7))

	)

164 
	#S1
(
x
è(
	`ROTR
(x,19è^ ROTR(x,61è^ 
	`SHR
(x, 6))

	)

166 
	#S2
(
x
è(
	`ROTR
(x,28è^ ROTR(x,34è^ ROTR(x,39))

	)

167 
	#S3
(
x
è(
	`ROTR
(x,14è^ ROTR(x,18è^ ROTR(x,41))

	)

169 
	#F0
(
x
,
y
,
z
è((x & yè| (z & (x | y)))

	)

170 
	#F1
(
x
,
y
,
z
è(z ^ (x & (y ^ z)))

	)

172 
	#P
(
a
,
b
,
c
,
d
,
e
,
f
,
g
,
h
,
x
,
K
) \

174 
‹mp1
 = 
h
 + 
	`S3
(
e
è+ 
	`F1
Ó,
f
,
g
è+ 
K
 + 
x
; \

175 
‹mp2
 = 
	`S2
(
a
è+ 
	`F0
×,
b
,
c
); \

176 
d
 +ğ
‹mp1
; 
h
 =emp1 + 
‹mp2
; \

177 }

	)

179  
i
 = 0; i < 16; i++ )

181 
	`GET_UINT64_BE
Ğ
W
[
i
], 
d©a
, i << 3 );

184  ; 
i
 < 80; i++ )

186 
W
[
i
] = 
	`S1
(W[i - 2]) + W[i - 7] +

187 
	`S0
(
W
[
i
 - 15]) + W[i - 16];

190 
A
 = 
ùx
->
¡©e
[0];

191 
B
 = 
ùx
->
¡©e
[1];

192 
C
 = 
ùx
->
¡©e
[2];

193 
D
 = 
ùx
->
¡©e
[3];

194 
E
 = 
ùx
->
¡©e
[4];

195 
F
 = 
ùx
->
¡©e
[5];

196 
G
 = 
ùx
->
¡©e
[6];

197 
H
 = 
ùx
->
¡©e
[7];

198 
i
 = 0;

202 
	`P
Ğ
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
W
[
i
], 
K
[i] ); i++;

203 
	`P
Ğ
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
W
[
i
], 
K
[i] ); i++;

204 
	`P
Ğ
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
W
[
i
], 
K
[i] ); i++;

205 
	`P
Ğ
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
E
, 
W
[
i
], 
K
[i] ); i++;

206 
	`P
Ğ
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
D
, 
W
[
i
], 
K
[i] ); i++;

207 
	`P
Ğ
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
C
, 
W
[
i
], 
K
[i] ); i++;

208 
	`P
Ğ
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
B
, 
W
[
i
], 
K
[i] ); i++;

209 
	`P
Ğ
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
, 
A
, 
W
[
i
], 
K
[i] ); i++;

211  
i
 < 80 );

213 
ùx
->
¡©e
[0] +ğ
A
;

214 
ùx
->
¡©e
[1] +ğ
B
;

215 
ùx
->
¡©e
[2] +ğ
C
;

216 
ùx
->
¡©e
[3] +ğ
D
;

217 
ùx
->
¡©e
[4] +ğ
E
;

218 
ùx
->
¡©e
[5] +ğ
F
;

219 
ùx
->
¡©e
[6] +ğ
G
;

220 
ùx
->
¡©e
[7] +ğ
H
;

221 
	}
}

226 
	$sha4_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 )

228 
fl
;

229 
št64
 
Ëá
;

231 ifĞ
’
 <= 0 )

234 
Ëá
 = 
ùx
->
tÙ®
[0] & 0x7F;

235 
fl
 = ()Ğ128 - 
Ëá
 );

237 
ùx
->
tÙ®
[0] +ğ
’
;

239 ifĞ
ùx
->
tÙ®
[0] < (
št64
è
’
 )

240 
ùx
->
tÙ®
[1]++;

242 ifĞ
Ëá
 && 
’
 >ğ
fl
 )

244 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

245 (*è
šput
, 
fl
 );

246 
	`sha4_´oûss
Ğ
ùx
, ctx->
bufãr
 );

247 
šput
 +ğ
fl
;

248 
’
 -ğ
fl
;

249 
Ëá
 = 0;

252  
’
 >= 128 )

254 
	`sha4_´oûss
Ğ
ùx
, 
šput
 );

255 
šput
 += 128;

256 
’
 -= 128;

259 ifĞ
’
 > 0 )

261 
	`memıy
Ğ(*è(
ùx
->
bufãr
 + 
Ëá
),

262 (*è
šput
, 
’
 );

264 
	}
}

266 cÚ¡ 
	gsha4_·ddšg
[128] =

281 
	$sha4_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] )

283 
Ï¡
, 
·dn
;

284 
št64
 
high
, 
low
;

285 
msgËn
[16];

287 
high
 = ( 
ùx
->
tÙ®
[0] >> 61 )

288 | ( 
ùx
->
tÙ®
[1] << 3 );

289 
low
 = ( 
ùx
->
tÙ®
[0] << 3 );

291 
	`PUT_UINT64_BE
Ğ
high
, 
msgËn
, 0 );

292 
	`PUT_UINT64_BE
Ğ
low
, 
msgËn
, 8 );

294 
Ï¡
 = ()Ğ
ùx
->
tÙ®
[0] & 0x7F );

295 
·dn
 = ( 
Ï¡
 < 112 ) ? ( 112 -†ast ) : ( 240 -†ast );

297 
	`sha4_upd©e
Ğ
ùx
, (*è
sha4_·ddšg
, 
·dn
 );

298 
	`sha4_upd©e
Ğ
ùx
, 
msgËn
, 16 );

300 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[0], 
ouut
, 0 );

301 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[1], 
ouut
, 8 );

302 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[2], 
ouut
, 16 );

303 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[3], 
ouut
, 24 );

304 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[4], 
ouut
, 32 );

305 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[5], 
ouut
, 40 );

307 ifĞ
ùx
->
is384
 == 0 )

309 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[6], 
ouut
, 48 );

310 
	`PUT_UINT64_BE
Ğ
ùx
->
¡©e
[7], 
ouut
, 56 );

312 
	}
}

317 
	$sha4
ĞcÚ¡ *
šput
, 
’
,

318 
ouut
[64], 
is384
 )

320 
sha4_cÚ‹xt
 
ùx
;

322 
	`sha4_¡¬ts
Ğ&
ùx
, 
is384
 );

323 
	`sha4_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

324 
	`sha4_fšish
Ğ&
ùx
, 
ouut
 );

326 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha4_cÚ‹xt
 ) );

327 
	}
}

332 
	$sha4_fe
ĞcÚ¡ *
·th
, 
ouut
[64], 
is384
 )

334 
FILE
 *
f
;

335 
size_t
 
n
;

336 
sha4_cÚ‹xt
 
ùx
;

337 
buf
[1024];

339 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

342 
	`sha4_¡¬ts
Ğ&
ùx
, 
is384
 );

344  ( 
n
 = 
	`ä—d
Ğ
buf
, 1, Ğbuà), 
f
 ) ) > 0 )

345 
	`sha4_upd©e
Ğ&
ùx
, 
buf
, (è
n
 );

347 
	`sha4_fšish
Ğ&
ùx
, 
ouut
 );

349 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha4_cÚ‹xt
 ) );

351 ifĞ
	`ã¼Ü
Ğ
f
 ) != 0 )

353 
	`fşo£
Ğ
f
 );

357 
	`fşo£
Ğ
f
 );

359 
	}
}

364 
	$sha4_hmac_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

365 
is384
 )

367 
i
;

368 
sum
[64];

370 ifĞ
keyËn
 > 128 )

372 
	`sha4
Ğ
key
, 
keyËn
, 
sum
, 
is384
 );

373 
keyËn
 = ( 
is384
 ) ? 48 : 64;

374 
key
 = 
sum
;

377 
	`mem£t
Ğ
ùx
->
ad
, 0x36, 128 );

378 
	`mem£t
Ğ
ùx
->
İad
, 0x5C, 128 );

380  
i
 = 0; i < 
keyËn
; i++ )

382 
ùx
->
ad
[
i
] = ()Ğùx->ad[i] ^ 
key
[i] );

383 
ùx
->
İad
[
i
] = ()Ğùx->İad[i] ^ 
key
[i] );

386 
	`sha4_¡¬ts
Ğ
ùx
, 
is384
 );

387 
	`sha4_upd©e
Ğ
ùx
, ctx->
ad
, 128 );

389 
	`mem£t
Ğ
sum
, 0, ( sum ) );

390 
	}
}

395 
	$sha4_hmac_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
,

396 cÚ¡ *
šput
, 
’
 )

398 
	`sha4_upd©e
Ğ
ùx
, 
šput
, 
’
 );

399 
	}
}

404 
	$sha4_hmac_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] )

406 
is384
, 
hËn
;

407 
tmpbuf
[64];

409 
is384
 = 
ùx
->is384;

410 
hËn
 = ( 
is384
 == 0 ) ? 64 : 48;

412 
	`sha4_fšish
Ğ
ùx
, 
tmpbuf
 );

413 
	`sha4_¡¬ts
Ğ
ùx
, 
is384
 );

414 
	`sha4_upd©e
Ğ
ùx
, ctx->
İad
, 128 );

415 
	`sha4_upd©e
Ğ
ùx
, 
tmpbuf
, 
hËn
 );

416 
	`sha4_fšish
Ğ
ùx
, 
ouut
 );

418 
	`mem£t
Ğ
tmpbuf
, 0, (mpbuf ) );

419 
	}
}

424 
	$sha4_hmac_»£t
Ğ
sha4_cÚ‹xt
 *
ùx
 )

426 
	`sha4_¡¬ts
Ğ
ùx
, ctx->
is384
 );

427 
	`sha4_upd©e
Ğ
ùx
, ctx->
ad
, 128 );

428 
	}
}

433 
	$sha4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

434 cÚ¡ *
šput
, 
’
,

435 
ouut
[64], 
is384
 )

437 
sha4_cÚ‹xt
 
ùx
;

439 
	`sha4_hmac_¡¬ts
Ğ&
ùx
, 
key
, 
keyËn
, 
is384
 );

440 
	`sha4_hmac_upd©e
Ğ&
ùx
, 
šput
, 
’
 );

441 
	`sha4_hmac_fšish
Ğ&
ùx
, 
ouut
 );

443 
	`mem£t
Ğ&
ùx
, 0, Ğ
sha4_cÚ‹xt
 ) );

444 
	}
}

446 #ià
defšed
(
POLARSSL_SELF_TEST
)

451 
	gsha4_‹¡_buf
[3][113] =

459 cÚ¡ 
	gsha4_‹¡_buæ’
[3] =

464 cÚ¡ 
	gsha4_‹¡_sum
[6][64] =

520 
	gsha4_hmac_‹¡_key
[7][26] =

535 cÚ¡ 
	gsha4_hmac_‹¡_keyËn
[7] =

540 
	gsha4_hmac_‹¡_buf
[7][153] =

561 cÚ¡ 
	gsha4_hmac_‹¡_buæ’
[7] =

566 cÚ¡ 
	gsha4_hmac_‹¡_sum
[14][64] =

668 
	$sha4_£lf_‹¡
Ğ
v”bo£
 )

670 
i
, 
j
, 
k
, 
buæ’
;

671 
buf
[1024];

672 
sha4sum
[64];

673 
sha4_cÚ‹xt
 
ùx
;

675  
i
 = 0; i < 6; i++ )

677 
j
 = 
i
 % 3;

678 
k
 = 
i
 < 3;

680 ifĞ
v”bo£
 != 0 )

681 
	`´štf
Ğ" SHA-%de¡ #%d: ", 512 - 
k
 * 128, 
j
 + 1 );

683 
	`sha4_¡¬ts
Ğ&
ùx
, 
k
 );

685 ifĞ
j
 == 2 )

687 
	`mem£t
Ğ
buf
, 'a', 
buæ’
 = 1000 );

689  
j
 = 0; j < 1000; j++ )

690 
	`sha4_upd©e
Ğ&
ùx
, 
buf
, 
buæ’
 );

693 
	`sha4_upd©e
Ğ&
ùx
, 
sha4_‹¡_buf
[
j
],

694 
sha4_‹¡_buæ’
[
j
] );

696 
	`sha4_fšish
Ğ&
ùx
, 
sha4sum
 );

698 ifĞ
	`memcmp
Ğ
sha4sum
, 
sha4_‹¡_sum
[
i
], 64 - 
k
 * 16 ) != 0 )

700 ifĞ
v”bo£
 != 0 )

701 
	`´štf
( "failed\n" );

706 ifĞ
v”bo£
 != 0 )

707 
	`´štf
( "passed\n" );

710 ifĞ
v”bo£
 != 0 )

711 
	`´štf
( "\n" );

713  
i
 = 0; i < 14; i++ )

715 
j
 = 
i
 % 7;

716 
k
 = 
i
 < 7;

718 ifĞ
v”bo£
 != 0 )

719 
	`´štf
Ğ" HMAC-SHA-%de¡ #%d: ", 512 - 
k
 * 128, 
j
 + 1 );

721 ifĞ
j
 == 5 || j == 6 )

723 
	`mem£t
Ğ
buf
, '\xAA', 
buæ’
 = 131 );

724 
	`sha4_hmac_¡¬ts
Ğ&
ùx
, 
buf
, 
buæ’
, 
k
 );

727 
	`sha4_hmac_¡¬ts
Ğ&
ùx
, 
sha4_hmac_‹¡_key
[
j
],

728 
sha4_hmac_‹¡_keyËn
[
j
], 
k
 );

730 
	`sha4_hmac_upd©e
Ğ&
ùx
, 
sha4_hmac_‹¡_buf
[
j
],

731 
sha4_hmac_‹¡_buæ’
[
j
] );

733 
	`sha4_hmac_fšish
Ğ&
ùx
, 
sha4sum
 );

735 
buæ’
 = ( 
j
 =ğ4 ) ? 16 : 64 - 
k
 * 16;

737 ifĞ
	`memcmp
Ğ
sha4sum
, 
sha4_hmac_‹¡_sum
[
i
], 
buæ’
 ) != 0 )

739 ifĞ
v”bo£
 != 0 )

740 
	`´štf
( "failed\n" );

745 ifĞ
v”bo£
 != 0 )

746 
	`´štf
( "passed\n" );

749 ifĞ
v”bo£
 != 0 )

750 
	`´štf
( "\n" );

753 
	}
}

	@tools/src/polarssl/sha4.h

25 #iâdeà
POLARSSL_SHA4_H


26 
	#POLARSSL_SHA4_H


	)

28 #ià
defšed
(
_MSC_VER
è|| defšed(
__WATCOMC__
)

29 
	#UL64
(
x
èx##
ui64


	)

30 
	#št64
 
__št64


	)

32 
	#UL64
(
x
èx##
ULL


	)

33 
	#št64
 

	)

41 
št64
 
	mtÙ®
[2];

42 
št64
 
	m¡©e
[8];

43 
	mbufãr
[128];

45 
	mad
[128];

46 
	mİad
[128];

47 
	mis384
;

49 
	tsha4_cÚ‹xt
;

51 #ifdeà
__ılu¥lus


61 
sha4_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, 
is384
 );

70 
sha4_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

78 
sha4_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] );

88 
sha4
ĞcÚ¡ *
šput
, 
’
,

89 
ouut
[64], 
is384
 );

101 
sha4_fe
ĞcÚ¡ *
·th
, 
ouut
[64], 
is384
 );

111 
sha4_hmac_¡¬ts
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, 
keyËn
,

112 
is384
 );

121 
sha4_hmac_upd©e
Ğ
sha4_cÚ‹xt
 *
ùx
, cÚ¡ *
šput
, 
’
 );

129 
sha4_hmac_fšish
Ğ
sha4_cÚ‹xt
 *
ùx
, 
ouut
[64] );

136 
sha4_hmac_»£t
Ğ
sha4_cÚ‹xt
 *
ùx
 );

148 
sha4_hmac
ĞcÚ¡ *
key
, 
keyËn
,

149 cÚ¡ *
šput
, 
’
,

150 
ouut
[64], 
is384
 );

157 
sha4_£lf_‹¡
Ğ
v”bo£
 );

159 #ifdeà
__ılu¥lus


	@tools/src/polarssl/ssl.h

25 #iâdeà
POLARSSL_SSL_H


26 
	#POLARSSL_SSL_H


	)

28 
	~<time.h
>

30 
	~"pŞ¬s¦/Ãt.h
"

31 
	~"pŞ¬s¦/dhm.h
"

32 
	~"pŞ¬s¦/r§.h
"

33 
	~"pŞ¬s¦/md5.h
"

34 
	~"pŞ¬s¦/sha1.h
"

35 
	~"pŞ¬s¦/x509.h
"

40 
	#POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 -0x1000

	)

41 
	#POLARSSL_ERR_SSL_BAD_INPUT_DATA
 -0x1800

	)

42 
	#POLARSSL_ERR_SSL_INVALID_MAC
 -0x2000

	)

43 
	#POLARSSL_ERR_SSL_INVALID_RECORD
 -0x2800

	)

44 
	#POLARSSL_ERR_SSL_INVALID_MODULUS_SIZE
 -0x3000

	)

45 
	#POLARSSL_ERR_SSL_UNKNOWN_CIPHER
 -0x3800

	)

46 
	#POLARSSL_ERR_SSL_NO_CIPHER_CHOSEN
 -0x4000

	)

47 
	#POLARSSL_ERR_SSL_NO_SESSION_FOUND
 -0x4800

	)

48 
	#POLARSSL_ERR_SSL_NO_CLIENT_CERTIFICATE
 -0x5000

	)

49 
	#POLARSSL_ERR_SSL_CERTIFICATE_TOO_LARGE
 -0x5800

	)

50 
	#POLARSSL_ERR_SSL_CERTIFICATE_REQUIRED
 -0x6000

	)

51 
	#POLARSSL_ERR_SSL_PRIVATE_KEY_REQUIRED
 -0x6800

	)

52 
	#POLARSSL_ERR_SSL_CA_CHAIN_REQUIRED
 -0x7000

	)

53 
	#POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 -0x7800

	)

54 
	#POLARSSL_ERR_SSL_FATAL_ALERT_MESSAGE
 -0x8000

	)

55 
	#POLARSSL_ERR_SSL_PEER_VERIFY_FAILED
 -0x8800

	)

56 
	#POLARSSL_ERR_SSL_PEER_CLOSE_NOTIFY
 -0x9000

	)

57 
	#POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 -0x9800

	)

58 
	#POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 -0xA000

	)

59 
	#POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 -0xA800

	)

60 
	#POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_REQUEST
 -0xB000

	)

61 
	#POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 -0xB800

	)

62 
	#POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO_DONE
 -0xC000

	)

63 
	#POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 -0xC800

	)

64 
	#POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 -0xD000

	)

65 
	#POLARSSL_ERR_SSL_BAD_HS_CHANGE_CIPHER_SPEC
 -0xD800

	)

66 
	#POLARSSL_ERR_SSL_BAD_HS_FINISHED
 -0xE000

	)

71 
	#SSL_MAJOR_VERSION_3
 3

	)

72 
	#SSL_MINOR_VERSION_0
 0

	)

73 
	#SSL_MINOR_VERSION_1
 1

	)

74 
	#SSL_MINOR_VERSION_2
 2

	)

76 
	#SSL_IS_CLIENT
 0

	)

77 
	#SSL_IS_SERVER
 1

	)

78 
	#SSL_COMPRESS_NULL
 0

	)

80 
	#SSL_VERIFY_NONE
 0

	)

81 
	#SSL_VERIFY_OPTIONAL
 1

	)

82 
	#SSL_VERIFY_REQUIRED
 2

	)

84 
	#SSL_MAX_CONTENT_LEN
 16384

	)

90 
	#SSL_BUFFER_LEN
 (
SSL_MAX_CONTENT_LEN
 + 512)

	)

95 
	#SSL_RSA_RC4_128_MD5
 0x04

	)

96 
	#SSL_RSA_RC4_128_SHA
 0x05

	)

97 
	#SSL_RSA_DES_168_SHA
 0x0A

	)

98 
	#SSL_EDH_RSA_DES_168_SHA
 0x16

	)

99 
	#SSL_RSA_AES_128_SHA
 0x2F

	)

100 
	#SSL_EDH_RSA_AES_128_SHA
 0x33

	)

101 
	#SSL_RSA_AES_256_SHA
 0x35

	)

102 
	#SSL_EDH_RSA_AES_256_SHA
 0x39

	)

104 
	#SSL_RSA_CAMELLIA_128_SHA
 0x41

	)

105 
	#SSL_EDH_RSA_CAMELLIA_128_SHA
 0x45

	)

106 
	#SSL_RSA_CAMELLIA_256_SHA
 0x84

	)

107 
	#SSL_EDH_RSA_CAMELLIA_256_SHA
 0x88

	)

112 
	#SSL_MSG_CHANGE_CIPHER_SPEC
 20

	)

113 
	#SSL_MSG_ALERT
 21

	)

114 
	#SSL_MSG_HANDSHAKE
 22

	)

115 
	#SSL_MSG_APPLICATION_DATA
 23

	)

117 
	#SSL_ALERT_LEVEL_WARNING
 1

	)

118 
	#SSL_ALERT_LEVEL_FATAL
 2

	)

120 
	#SSL_ALERT_MSG_CLOSE_NOTIFY
 0

	)

121 
	#SSL_ALERT_MSG_UNEXPECTED_MESSAGE
 10

	)

122 
	#SSL_ALERT_MSG_BAD_RECORD_MAD
 20

	)

123 
	#SSL_ALERT_MSG_DECRYPTION_FAILED
 21

	)

124 
	#SSL_ALERT_MSG_RECORD_OVERFLOW
 22

	)

125 
	#SSL_ALERT_MSG_DECOMPRESSION_FAILURE
 30

	)

126 
	#SSL_ALERT_MSG_HANDSHAKE_FAILURE
 40

	)

127 
	#SSL_ALERT_MSG_NO_CERT
 41

	)

128 
	#SSL_ALERT_MSG_BAD_CERT
 42

	)

129 
	#SSL_ALERT_MSG_UNSUPPORTED_CERT
 43

	)

130 
	#SSL_ALERT_MSG_CERT_REVOKED
 44

	)

131 
	#SSL_ALERT_MSG_CERT_EXPIRED
 45

	)

132 
	#SSL_ALERT_MSG_CERT_UNKNOWN
 46

	)

133 
	#SSL_ALERT_MSG_ILLEGAL_PARAMETER
 47

	)

134 
	#SSL_ALERT_MSG_UNKNOWN_CA
 48

	)

135 
	#SSL_ALERT_MSG_ACCESS_DENIED
 49

	)

136 
	#SSL_ALERT_MSG_DECODE_ERROR
 50

	)

137 
	#SSL_ALERT_MSG_DECRYPT_ERROR
 51

	)

138 
	#SSL_ALERT_MSG_EXPORT_RESTRICTION
 60

	)

139 
	#SSL_ALERT_MSG_PROTOCOL_VERSION
 70

	)

140 
	#SSL_ALERT_MSG_INSUFFICIENT_SECURITY
 71

	)

141 
	#SSL_ALERT_MSG_INTERNAL_ERROR
 80

	)

142 
	#SSL_ALERT_MSG_USER_CANCELED
 90

	)

143 
	#SSL_ALERT_MSG_NO_RENEGOTIATION
 100

	)

145 
	#SSL_HS_HELLO_REQUEST
 0

	)

146 
	#SSL_HS_CLIENT_HELLO
 1

	)

147 
	#SSL_HS_SERVER_HELLO
 2

	)

148 
	#SSL_HS_CERTIFICATE
 11

	)

149 
	#SSL_HS_SERVER_KEY_EXCHANGE
 12

	)

150 
	#SSL_HS_CERTIFICATE_REQUEST
 13

	)

151 
	#SSL_HS_SERVER_HELLO_DONE
 14

	)

152 
	#SSL_HS_CERTIFICATE_VERIFY
 15

	)

153 
	#SSL_HS_CLIENT_KEY_EXCHANGE
 16

	)

154 
	#SSL_HS_FINISHED
 20

	)

159 
	#TLS_EXT_SERVERNAME
 0

	)

160 
	#TLS_EXT_SERVERNAME_HOSTNAME
 0

	)

167 
	mSSL_HELLO_REQUEST
,

168 
	mSSL_CLIENT_HELLO
,

169 
	mSSL_SERVER_HELLO
,

170 
	mSSL_SERVER_CERTIFICATE
,

171 
	mSSL_SERVER_KEY_EXCHANGE
,

172 
	mSSL_CERTIFICATE_REQUEST
,

173 
	mSSL_SERVER_HELLO_DONE
,

174 
	mSSL_CLIENT_CERTIFICATE
,

175 
	mSSL_CLIENT_KEY_EXCHANGE
,

176 
	mSSL_CERTIFICATE_VERIFY
,

177 
	mSSL_CLIENT_CHANGE_CIPHER_SPEC
,

178 
	mSSL_CLIENT_FINISHED
,

179 
	mSSL_SERVER_CHANGE_CIPHER_SPEC
,

180 
	mSSL_SERVER_FINISHED
,

181 
	mSSL_FLUSH_BUFFERS
,

182 
	mSSL_HANDSHAKE_OVER


184 
	ts¦_¡©es
;

186 
_s¦_£ssiÚ
 
	ts¦_£ssiÚ
;

187 
_s¦_cÚ‹xt
 
	ts¦_cÚ‹xt
;

192 
	s_s¦_£ssiÚ


194 
time_t
 
	m¡¬t
;

195 
	mch”
;

196 
	mËngth
;

197 
	mid
[32];

198 
	mma¡”
[48];

199 
s¦_£ssiÚ
 *
	mÃxt
;

202 
	s_s¦_cÚ‹xt


207 
	m¡©e
;

209 
	mmajÜ_v”
;

210 
	mmšÜ_v”
;

212 
	mmax_majÜ_v”
;

213 
	mmax_mšÜ_v”
;

218 (*
	mf_ºg
)(*);

219 (*
	mf_dbg
)(*, , const *);

220 (*
	mf_»cv
)(*, *, );

221 (*
	mf_£nd
)(*, *, );

223 *
	mp_ºg
;

224 *
	mp_dbg
;

225 *
	mp_»cv
;

226 *
	mp_£nd
;

231 
	m»sume
;

232 
	mtimeout
;

233 
s¦_£ssiÚ
 *
	m£ssiÚ
;

234 (*
	ms_g‘
)(
	ms¦_cÚ‹xt
 *);

235 (*
	ms_£t
)(
	ms¦_cÚ‹xt
 *);

240 *
	mš_ùr
;

241 *
	mš_hdr
;

242 *
	mš_msg
;

243 *
	mš_ofá
;

245 
	mš_msgty³
;

246 
	mš_msgËn
;

247 
	mš_Ëá
;

249 
	mš_h¦’
;

250 
	mnb_z”o
;

255 *
	mout_ùr
;

256 *
	mout_hdr
;

257 *
	mout_msg
;

259 
	mout_msgty³
;

260 
	mout_msgËn
;

261 
	mout_Ëá
;

266 
r§_cÚ‹xt
 *
	mr§_key
;

267 
x509_û¹
 *
	mown_û¹
;

268 
x509_û¹
 *
	mÿ_chaš
;

269 
x509_ül
 *
	mÿ_ül
;

270 
x509_û¹
 *
	m³”_û¹
;

271 cÚ¡ *
	m³”_ú
;

273 
	m’dpošt
;

274 
	mauthmode
;

275 
	mş›Á_auth
;

276 
	mv”ify_»suÉ
;

281 
dhm_cÚ‹xt
 
	mdhm_ùx
;

282 
md5_cÚ‹xt
 
	mfš_md5
;

283 
sha1_cÚ‹xt
 
	mfš_sha1
;

285 
	mdo_üy±
;

286 *
	mch”s
;

287 
	mpm¦’
;

288 
	mkeyËn
;

289 
	mmšËn
;

290 
	mivËn
;

291 
	mmaş’
;

293 
	m¿ndby‹s
[64];

294 
	m´ema¡”
[256];

296 
	miv_’c
[16];

297 
	miv_dec
[16];

299 
	mmac_’c
[32];

300 
	mmac_dec
[32];

302 
	mùx_’c
[128];

303 
	mùx_dec
[128];

308 *
	mho¡Çme
;

309 
	mho¡Çme_Ën
;

312 #ifdeà
__ılu¥lus


316 
s¦_deçuÉ_ch”s
[];

325 
s¦_š™
Ğ
s¦_cÚ‹xt
 *
s¦
 );

333 
s¦_£t_’dpošt
Ğ
s¦_cÚ‹xt
 *
s¦
, 
’dpošt
 );

352 
s¦_£t_authmode
Ğ
s¦_cÚ‹xt
 *
s¦
, 
authmode
 );

361 
s¦_£t_ºg
Ğ
s¦_cÚ‹xt
 *
s¦
,

362 (*
f_ºg
)(*),

363 *
p_ºg
 );

372 
s¦_£t_dbg
Ğ
s¦_cÚ‹xt
 *
s¦
,

373 (*
f_dbg
)(*, , const *),

374 *
p_dbg
 );

385 
s¦_£t_bio
Ğ
s¦_cÚ‹xt
 *
s¦
,

386 (*
f_»cv
)(*, *, ), *
p_»cv
,

387 (*
f_£nd
)(*, *, ), *
p_£nd
 );

396 
s¦_£t_scb
Ğ
s¦_cÚ‹xt
 *
s¦
,

397 (*
s_g‘
)(
s¦_cÚ‹xt
 *),

398 (*
s_£t
)(
s¦_cÚ‹xt
 *) );

408 
s¦_£t_£ssiÚ
Ğ
s¦_cÚ‹xt
 *
s¦
, 
»sume
, 
timeout
,

409 
s¦_£ssiÚ
 *
£ssiÚ
 );

417 
s¦_£t_ch”s
Ğ
s¦_cÚ‹xt
 *
s¦
, *
ch”s
 );

429 
s¦_£t_ÿ_chaš
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
ÿ_chaš
,

430 
x509_ül
 *
ÿ_ül
, cÚ¡ *
³”_ú
 );

439 
s¦_£t_own_û¹
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
own_û¹
,

440 
r§_cÚ‹xt
 *
r§_key
 );

452 
s¦_£t_dh_·¿m
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
dhm_P
, cÚ¡ *
dhm_G
 );

463 
s¦_£t_ho¡Çme
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
ho¡Çme
 );

472 
s¦_g‘_by‹s_ava
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 );

485 
s¦_g‘_v”ify_»suÉ
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 );

494 cÚ¡ *
s¦_g‘_ch”
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 );

504 
s¦_hªdshake
Ğ
s¦_cÚ‹xt
 *
s¦
 );

516 
s¦_»ad
Ğ
s¦_cÚ‹xt
 *
s¦
, *
buf
, 
Ën
 );

532 
s¦_wr™e
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
buf
, 
Ën
 );

539 
s¦_şo£_nÙify
Ğ
s¦_cÚ‹xt
 *
s¦
 );

546 
s¦_ä“
Ğ
s¦_cÚ‹xt
 *
s¦
 );

551 
s¦_hªdshake_ş›Á
Ğ
s¦_cÚ‹xt
 *
s¦
 );

552 
s¦_hªdshake_£rv”
Ğ
s¦_cÚ‹xt
 *
s¦
 );

554 
s¦_d”ive_keys
Ğ
s¦_cÚ‹xt
 *
s¦
 );

555 
s¦_ÿlc_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
, 
hash
[36] );

557 
s¦_»ad_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 );

558 
s¦_ãtch_šput
Ğ
s¦_cÚ‹xt
 *
s¦
, 
nb_wªt
 );

560 
s¦_wr™e_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 );

561 
s¦_æush_ouut
Ğ
s¦_cÚ‹xt
 *
s¦
 );

563 
s¦_·r£_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 );

564 
s¦_wr™e_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 );

566 
s¦_·r£_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 );

567 
s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 );

569 
s¦_·r£_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 );

570 
s¦_wr™e_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 );

572 #ifdeà
__ılu¥lus


	@tools/src/polarssl/ssl_cli.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_SSL_CLI_C
)

30 
	~"pŞ¬s¦/debug.h
"

31 
	~"pŞ¬s¦/s¦.h
"

33 
	~<¡ršg.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

36 
	~<time.h
>

38 
	$s¦_wr™e_ş›Á_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

40 
»t
, 
i
, 
n
;

41 *
buf
;

42 *
p
;

43 
time_t
 
t
;

45 
	`SSL_DEBUG_MSG
( 2, ( "=> write client hello" ) );

47 
s¦
->
majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

48 
s¦
->
mšÜ_v”
 = 
SSL_MINOR_VERSION_0
;

50 
s¦
->
max_majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

51 
s¦
->
max_mšÜ_v”
 = 
SSL_MINOR_VERSION_2
;

60 
buf
 = 
s¦
->
out_msg
;

61 
p
 = 
buf
 + 4;

63 *
p
++ = (è
s¦
->
max_majÜ_v”
;

64 *
p
++ = (è
s¦
->
max_mšÜ_v”
;

66 
	`SSL_DEBUG_MSG
( 3, ( "client hello, max version: [%d:%d]",

67 
buf
[4], buf[5] ) );

69 
t
 = 
	`time
Ğ
NULL
 );

70 *
p
++ = ()Ğ
t
 >> 24 );

71 *
p
++ = ()Ğ
t
 >> 16 );

72 *
p
++ = ()Ğ
t
 >> 8 );

73 *
p
++ = ()Ğ
t
 );

75 
	`SSL_DEBUG_MSG
Ğ3, ( "ş›Á h–lo, cu¼’ˆtime: %lu", 
t
 ) );

77  
i
 = 28; i > 0; i-- )

78 *
p
++ = (è
s¦
->
	`f_ºg
Ğs¦->
p_ºg
 );

80 
	`memıy
Ğ
s¦
->
¿ndby‹s
, 
buf
 + 6, 32 );

82 
	`SSL_DEBUG_BUF
Ğ3, "ş›Á h–lo,„ªdom by‹s", 
buf
 + 6, 32 );

92 
n
 = 
s¦
->
£ssiÚ
->
Ëngth
;

94 ifĞ
n
 < 16 ||‚ > 32 || 
s¦
->
»sume
 == 0 ||

95 Ğ
s¦
->
timeout
 !ğ0 && 
t
 - s¦->
£ssiÚ
->
¡¬t
 > ssl->timeout ) )

96 
n
 = 0;

98 *
p
++ = (è
n
;

100  
i
 = 0; i < 
n
; i++ )

101 *
p
++ = 
s¦
->
£ssiÚ
->
id
[
i
];

103 
	`SSL_DEBUG_MSG
Ğ3, ( "ş›Á h–lo, sessiÚ id†’.: %d", 
n
 ) );

104 
	`SSL_DEBUG_BUF
Ğ3, "ş›Á h–lo, sessiÚ id", 
buf
 + 39, 
n
 );

106  
n
 = 0; 
s¦
->
ch”s
[n] != 0;‚++ );

107 *
p
++ = ()Ğ
n
 >> 7 );

108 *
p
++ = ()Ğ
n
 << 1 );

110 
	`SSL_DEBUG_MSG
Ğ3, ( "ş›Á h–lo, gÙ %d ch”s", 
n
 ) );

112  
i
 = 0; i < 
n
; i++ )

114 
	`SSL_DEBUG_MSG
( 3, ( "client hello,‡dd cipher: %2d",

115 
s¦
->
ch”s
[
i
] ) );

117 *
p
++ = ()Ğ
s¦
->
ch”s
[
i
] >> 8 );

118 *
p
++ = ()Ğ
s¦
->
ch”s
[
i
] );

121 
	`SSL_DEBUG_MSG
( 3, ( "client hello, compress†en.: %d", 1 ) );

122 
	`SSL_DEBUG_MSG
( 3, ( "client hello, compress‡lg.: %d", 0 ) );

124 *
p
++ = 1;

125 *
p
++ = 
SSL_COMPRESS_NULL
;

127 iàĞ
s¦
->
ho¡Çme
 !ğ
NULL
 )

129 
	`SSL_DEBUG_MSG
( 3, ( "client hello, server‚ameƒxtension: %s",

130 
s¦
->
ho¡Çme
 ) );

132 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 9) >> 8 ) & 0xFF );

133 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 9) ) & 0xFF );

135 *
p
++ = ()ĞĞ
TLS_EXT_SERVERNAME
 >> 8 ) & 0xFF );

136 *
p
++ = ()ĞĞ
TLS_EXT_SERVERNAME
 ) & 0xFF );

138 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 5) >> 8 ) & 0xFF );

139 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 5) ) & 0xFF );

141 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 3) >> 8 ) & 0xFF );

142 *
p
++ = ()ĞĞ(
s¦
->
ho¡Çme_Ën
 + 3) ) & 0xFF );

144 *
p
++ = ()ĞĞ
TLS_EXT_SERVERNAME_HOSTNAME
 ) & 0xFF );

145 *
p
++ = ()ĞĞ
s¦
->
ho¡Çme_Ën
 >> 8 ) & 0xFF );

146 *
p
++ = ()ĞĞ
s¦
->
ho¡Çme_Ën
 ) & 0xFF );

148 
	`memıy
Ğ
p
, 
s¦
->
ho¡Çme
, s¦->
ho¡Çme_Ën
 );

150 
p
 +ğ
s¦
->
ho¡Çme_Ën
;

153 
s¦
->
out_msgËn
 = 
p
 - 
buf
;

154 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

155 
s¦
->
out_msg
[0] = 
SSL_HS_CLIENT_HELLO
;

157 
s¦
->
¡©e
++;

159 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

161 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

162 Ğ
»t
 );

165 
	`SSL_DEBUG_MSG
( 2, ( "<= write client hello" ) );

168 
	}
}

170 
	$s¦_·r£_£rv”_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

172 
time_t
 
t
;

173 
»t
, 
i
, 
n
;

174 
ext_Ën
;

175 *
buf
;

177 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse server hello" ) );

186 
buf
 = 
s¦
->
š_msg
;

188 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

190 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

191 Ğ
»t
 );

194 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

196 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

197 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

200 
	`SSL_DEBUG_MSG
( 3, ( "server hello, chosen version: [%d:%d]",

201 
buf
[4], buf[5] ) );

203 ifĞ
s¦
->
š_h¦’
 < 42 ||

204 
buf
[0] !ğ
SSL_HS_SERVER_HELLO
 ||

205 
buf
[4] !ğ
SSL_MAJOR_VERSION_3
 )

207 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

208 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

211 ifĞ
buf
[5] > 
s¦
->
max_mšÜ_v”
 )

213 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

214 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

217 
s¦
->
mšÜ_v”
 = 
buf
[5];

219 
t
 = ( (
time_t
è
buf
[6] << 24 )

220 | ( (
time_t
è
buf
[7] << 16 )

221 | ( (
time_t
è
buf
[8] << 8 )

222 | ( (
time_t
è
buf
[9] );

224 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32, 
buf
 + 6, 32 );

226 
n
 = 
buf
[38];

228 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, cu¼’ˆtime: %lu", 
t
 ) );

229 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo,„ªdom by‹s", 
buf
 + 6, 32 );

239 ifĞ
n
 < 0 ||‚ > 32 || 
s¦
->
š_h¦’
 > 42 +‚ )

241 
ext_Ën
 = ( ( 
buf
[42 + 
n
] << 8 )

242 | ( 
buf
[43 + 
n
] ) ) + 2;

246 
ext_Ën
 = 0;

249 ifĞ
n
 < 0 ||‚ > 32 || 
s¦
->
š_h¦’
 !ğ42 +‚ + 
ext_Ën
 )

251 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

252 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

255 
i
 = ( 
buf
[39 + 
n
] << 8 ) | buf[40 +‚];

257 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, sessiÚ id†’.: %d", 
n
 ) );

258 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo, sessiÚ id", 
buf
 + 39, 
n
 );

263 ifĞ
s¦
->
»sume
 =ğ0 || 
n
 == 0 ||

264 
s¦
->
£ssiÚ
->
ch”
 !ğ
i
 ||

265 
s¦
->
£ssiÚ
->
Ëngth
 !ğ
n
 ||

266 
	`memcmp
Ğ
s¦
->
£ssiÚ
->
id
, 
buf
 + 39, 
n
 ) != 0 )

268 
s¦
->
¡©e
++;

269 
s¦
->
»sume
 = 0;

270 
s¦
->
£ssiÚ
->
¡¬t
 = 
	`time
Ğ
NULL
 );

271 
s¦
->
£ssiÚ
->
ch”
 = 
i
;

272 
s¦
->
£ssiÚ
->
Ëngth
 = 
n
;

273 
	`memıy
Ğ
s¦
->
£ssiÚ
->
id
, 
buf
 + 39, 
n
 );

277 
s¦
->
¡©e
 = 
SSL_SERVER_CHANGE_CIPHER_SPEC
;

279 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

281 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

282 Ğ
»t
 );

286 
	`SSL_DEBUG_MSG
( 3, ( "%s session has been„esumed",

287 
s¦
->
»sume
 ? "a" : "no" ) );

289 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, cho£Àch”: %d", 
i
 ) );

290 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, com´es ®g.: %d", 
buf
[41 + 
n
] ) );

292 
i
 = 0;

295 ifĞ
s¦
->
ch”s
[
i
] == 0 )

297 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

298 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

301 ifĞ
s¦
->
ch”s
[
i
++] =ğs¦->
£ssiÚ
->
ch”
 )

305 ifĞ
buf
[41 + 
n
] !ğ
SSL_COMPRESS_NULL
 )

307 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello message" ) );

308 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO
 );

313 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse server hello" ) );

316 
	}
}

318 
	$s¦_·r£_£rv”_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

320 
»t
, 
n
;

321 *
p
, *
’d
;

322 
hash
[36];

323 
md5_cÚ‹xt
 
md5
;

324 
sha1_cÚ‹xt
 
sha1
;

326 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse server keyƒxchange" ) );

328 ifĞ
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_DES_168_SHA
 &&

329 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_128_SHA
 &&

330 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_256_SHA
 &&

331 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 &&

332 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

334 
	`SSL_DEBUG_MSG
( 2, ( "<= skip…arse server keyƒxchange" ) );

335 
s¦
->
¡©e
++;

339 #ià!
	`defšed
(
POLARSSL_DHM_C
)

340 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm in‚ot‡vailable" ) );

341 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

343 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

345 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

346 Ğ
»t
 );

349 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

351 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

352 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

355 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_SERVER_KEY_EXCHANGE
 )

357 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

358 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

370 
p
 = 
s¦
->
š_msg
 + 4;

371 
’d
 = 
s¦
->
š_msg
 + s¦->
š_h¦’
;

373 ifĞĞ
»t
 = 
	`dhm_»ad_·¿ms
Ğ&
s¦
->
dhm_ùx
, &
p
, 
’d
 ) ) != 0 )

375 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

376 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

379 ifĞ()Ğ
’d
 - 
p
 ) !ğ
s¦
->
³”_û¹
->
r§
.
Ën
 )

381 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

382 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

385 ifĞ
s¦
->
dhm_ùx
.
Ën
 < 64 || ssl->dhm_ctx.len > 256 )

387 
	`SSL_DEBUG_MSG
( 1, ( "bad server keyƒxchange message" ) );

388 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_KEY_EXCHANGE
 );

391 
	`SSL_DEBUG_MPI
Ğ3, "DHM: P ", &
s¦
->
dhm_ùx
.
P
 );

392 
	`SSL_DEBUG_MPI
Ğ3, "DHM: G ", &
s¦
->
dhm_ùx
.
G
 );

393 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GY", &
s¦
->
dhm_ùx
.
GY
 );

408 
n
 = 
s¦
->
š_h¦’
 - ( 
’d
 - 
p
 ) - 6;

410 
	`md5_¡¬ts
Ğ&
md5
 );

411 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
¿ndby‹s
, 64 );

412 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
š_msg
 + 4, 
n
 );

413 
	`md5_fšish
Ğ&
md5
, 
hash
 );

415 
	`sha1_¡¬ts
Ğ&
sha1
 );

416 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

417 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
š_msg
 + 4, 
n
 );

418 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

420 
	`SSL_DEBUG_BUF
Ğ3, "·¿m‘” hash", 
hash
, 36 );

422 ifĞĞ
»t
 = 
	`r§_pkcs1_v”ify
Ğ&
s¦
->
³”_û¹
->
r§
, 
RSA_PUBLIC
,

423 
SIG_RSA_RAW
, 36, 
hash
, 
p
 ) ) != 0 )

425 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_v”ify", 
»t
 );

426 Ğ
»t
 );

429 
s¦
->
¡©e
++;

431 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse server keyƒxchange" ) );

435 
	}
}

437 
	$s¦_·r£_û¹ifiÿ‹_»que¡
Ğ
s¦_cÚ‹xt
 *
s¦
 )

439 
»t
;

441 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse certificate„equest" ) );

454 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

456 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

457 Ğ
»t
 );

460 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

462 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate„equest message" ) );

463 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

466 
s¦
->
ş›Á_auth
 = 0;

467 
s¦
->
¡©e
++;

469 ifĞ
s¦
->
š_msg
[0] =ğ
SSL_HS_CERTIFICATE_REQUEST
 )

470 
s¦
->
ş›Á_auth
++;

472 
	`SSL_DEBUG_MSG
( 3, ( "got %s certificate„equest",

473 
s¦
->
ş›Á_auth
 ? "a" : "no" ) );

475 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse certificate„equest" ) );

478 
	}
}

480 
	$s¦_·r£_£rv”_h–lo_dÚe
Ğ
s¦_cÚ‹xt
 *
s¦
 )

482 
»t
;

484 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse server hello done" ) );

486 ifĞ
s¦
->
ş›Á_auth
 != 0 )

488 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

490 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

491 Ğ
»t
 );

494 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

496 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello done message" ) );

497 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

501 ifĞ
s¦
->
š_h¦’
 != 4 ||

502 
s¦
->
š_msg
[0] !ğ
SSL_HS_SERVER_HELLO_DONE
 )

504 
	`SSL_DEBUG_MSG
( 1, ( "bad server hello done message" ) );

505 Ğ
POLARSSL_ERR_SSL_BAD_HS_SERVER_HELLO_DONE
 );

508 
s¦
->
¡©e
++;

510 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse server hello done" ) );

513 
	}
}

515 
	$s¦_wr™e_ş›Á_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

517 
»t
, 
i
, 
n
;

519 
	`SSL_DEBUG_MSG
( 2, ( "=> write client keyƒxchange" ) );

521 ifĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_DES_168_SHA
 ||

522 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

523 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
 ||

524 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

525 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

527 #ià!
	`defšed
(
POLARSSL_DHM_C
)

528 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm in‚ot‡vailable" ) );

529 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

534 
n
 = 
s¦
->
dhm_ùx
.
Ën
;

536 
s¦
->
out_msg
[4] = ()Ğ
n
 >> 8 );

537 
s¦
->
out_msg
[5] = ()Ğ
n
 );

538 
i
 = 6;

540 
»t
 = 
	`dhm_make_public
Ğ&
s¦
->
dhm_ùx
, 256,

541 &
s¦
->
out_msg
[
i
], 
n
,

542 
s¦
->
f_ºg
, s¦->
p_ºg
 );

543 ifĞ
»t
 != 0 )

545 
	`SSL_DEBUG_RET
Ğ1, "dhm_make_public", 
»t
 );

546 Ğ
»t
 );

549 
	`SSL_DEBUG_MPI
Ğ3, "DHM: X ", &
s¦
->
dhm_ùx
.
X
 );

550 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GX", &
s¦
->
dhm_ùx
.
GX
 );

552 
s¦
->
pm¦’
 = s¦->
dhm_ùx
.
Ën
;

554 ifĞĞ
»t
 = 
	`dhm_ÿlc_£ü‘
Ğ&
s¦
->
dhm_ùx
,

555 
s¦
->
´ema¡”
,

556 &
s¦
->
pm¦’
 ) ) != 0 )

558 
	`SSL_DEBUG_RET
Ğ1, "dhm_ÿlc_£ü‘", 
»t
 );

559 Ğ
»t
 );

562 
	`SSL_DEBUG_MPI
Ğ3, "DHM: K ", &
s¦
->
dhm_ùx
.
K
 );

570 
s¦
->
´ema¡”
[0] = (ès¦->
max_majÜ_v”
;

571 
s¦
->
´ema¡”
[1] = (ès¦->
max_mšÜ_v”
;

572 
s¦
->
pm¦’
 = 48;

574  
i
 = 2; i < 
s¦
->
pm¦’
; i++ )

575 
s¦
->
´ema¡”
[
i
] = (ès¦->
	`f_ºg
Ğs¦->
p_ºg
 );

577 
i
 = 4;

578 
n
 = 
s¦
->
³”_û¹
->
r§
.
Ën
;

580 ifĞ
s¦
->
mšÜ_v”
 !ğ
SSL_MINOR_VERSION_0
 )

582 
i
 += 2;

583 
s¦
->
out_msg
[4] = ()Ğ
n
 >> 8 );

584 
s¦
->
out_msg
[5] = ()Ğ
n
 );

587 
»t
 = 
	`r§_pkcs1_’üy±
Ğ&
s¦
->
³”_û¹
->
r§
,

588 
s¦
->
f_ºg
, s¦->
p_ºg
,

589 
RSA_PUBLIC
,

590 
s¦
->
pm¦’
, s¦->
´ema¡”
,

591 
s¦
->
out_msg
 + 
i
 );

592 ifĞ
»t
 != 0 )

594 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_’üy±", 
»t
 );

595 Ğ
»t
 );

599 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

601 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

602 Ğ
»t
 );

605 
s¦
->
out_msgËn
 = 
i
 + 
n
;

606 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

607 
s¦
->
out_msg
[0] = 
SSL_HS_CLIENT_KEY_EXCHANGE
;

609 
s¦
->
¡©e
++;

611 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

613 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

614 Ğ
»t
 );

617 
	`SSL_DEBUG_MSG
( 2, ( "<= write client keyƒxchange" ) );

620 
	}
}

622 
	$s¦_wr™e_û¹ifiÿ‹_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
 )

624 
»t
, 
n
;

625 
hash
[36];

627 
	`SSL_DEBUG_MSG
( 2, ( "=> write certificate verify" ) );

629 ifĞ
s¦
->
ş›Á_auth
 =ğ0 || s¦->
own_û¹
 =ğ
NULL
 )

631 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write certificate verify" ) );

632 
s¦
->
¡©e
++;

636 ifĞ
s¦
->
r§_key
 =ğ
NULL
 )

638 
	`SSL_DEBUG_MSG
( 1, ( "got‚o…rivate key" ) );

639 Ğ
POLARSSL_ERR_SSL_PRIVATE_KEY_REQUIRED
 );

645 
	`s¦_ÿlc_v”ify
Ğ
s¦
, 
hash
 );

647 
n
 = 
s¦
->
r§_key
->
Ën
;

648 
s¦
->
out_msg
[4] = ()Ğ
n
 >> 8 );

649 
s¦
->
out_msg
[5] = ()Ğ
n
 );

651 ifĞĞ
»t
 = 
	`r§_pkcs1_sign
Ğ
s¦
->
r§_key
, 
RSA_PRIVATE
, 
SIG_RSA_RAW
,

652 36, 
hash
, 
s¦
->
out_msg
 + 6 ) ) != 0 )

654 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_sign", 
»t
 );

655 Ğ
»t
 );

658 
s¦
->
out_msgËn
 = 6 + 
n
;

659 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

660 
s¦
->
out_msg
[0] = 
SSL_HS_CERTIFICATE_VERIFY
;

662 
s¦
->
¡©e
++;

664 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

666 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

667 Ğ
»t
 );

670 
	`SSL_DEBUG_MSG
( 2, ( "<= write certificate verify" ) );

673 
	}
}

678 
	$s¦_hªdshake_ş›Á
Ğ
s¦_cÚ‹xt
 *
s¦
 )

680 
»t
 = 0;

682 
	`SSL_DEBUG_MSG
( 2, ( "=> handshake client" ) );

684  
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

686 
	`SSL_DEBUG_MSG
Ğ2, ( "ş›Á s‹: %d", 
s¦
->
¡©e
 ) );

688 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

691  
s¦
->
¡©e
 )

693 
SSL_HELLO_REQUEST
:

694 
s¦
->
¡©e
 = 
SSL_CLIENT_HELLO
;

700 
SSL_CLIENT_HELLO
:

701 
»t
 = 
	`s¦_wr™e_ş›Á_h–lo
Ğ
s¦
 );

711 
SSL_SERVER_HELLO
:

712 
»t
 = 
	`s¦_·r£_£rv”_h–lo
Ğ
s¦
 );

715 
SSL_SERVER_CERTIFICATE
:

716 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹
Ğ
s¦
 );

719 
SSL_SERVER_KEY_EXCHANGE
:

720 
»t
 = 
	`s¦_·r£_£rv”_key_exchªge
Ğ
s¦
 );

723 
SSL_CERTIFICATE_REQUEST
:

724 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹_»que¡
Ğ
s¦
 );

727 
SSL_SERVER_HELLO_DONE
:

728 
»t
 = 
	`s¦_·r£_£rv”_h–lo_dÚe
Ğ
s¦
 );

738 
SSL_CLIENT_CERTIFICATE
:

739 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹
Ğ
s¦
 );

742 
SSL_CLIENT_KEY_EXCHANGE
:

743 
»t
 = 
	`s¦_wr™e_ş›Á_key_exchªge
Ğ
s¦
 );

746 
SSL_CERTIFICATE_VERIFY
:

747 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹_v”ify
Ğ
s¦
 );

750 
SSL_CLIENT_CHANGE_CIPHER_SPEC
:

751 
»t
 = 
	`s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦
 );

754 
SSL_CLIENT_FINISHED
:

755 
»t
 = 
	`s¦_wr™e_fšished
Ğ
s¦
 );

762 
SSL_SERVER_CHANGE_CIPHER_SPEC
:

763 
»t
 = 
	`s¦_·r£_chªge_ch”_¥ec
Ğ
s¦
 );

766 
SSL_SERVER_FINISHED
:

767 
»t
 = 
	`s¦_·r£_fšished
Ğ
s¦
 );

770 
SSL_FLUSH_BUFFERS
:

771 
	`SSL_DEBUG_MSG
( 2, ( "handshake: done" ) );

772 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

776 
	`SSL_DEBUG_MSG
Ğ1, ( "šv®id s‹ %d", 
s¦
->
¡©e
 ) );

777 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

780 ifĞ
»t
 != 0 )

784 
	`SSL_DEBUG_MSG
( 2, ( "<= handshake client" ) );

786 Ğ
»t
 );

787 
	}
}

	@tools/src/polarssl/ssl_srv.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_SSL_SRV_C
)

30 
	~"pŞ¬s¦/debug.h
"

31 
	~"pŞ¬s¦/s¦.h
"

33 
	~<¡ršg.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

36 
	~<time.h
>

38 
	$s¦_·r£_ş›Á_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

40 
»t
, 
i
, 
j
, 
n
;

41 
ch_Ën
, 
£ss_Ën
;

42 
ch®_Ën
, 
comp_Ën
;

43 *
buf
, *
p
;

45 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse client hello" ) );

47 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 ) ) != 0 )

49 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

50 Ğ
»t
 );

53 
buf
 = 
s¦
->
š_hdr
;

55 ifĞĞ
buf
[0] & 0x80 ) != 0 )

57 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd h—d”", 
buf
, 5 );

59 
	`SSL_DEBUG_MSG
( 3, ( "client hello v2, messageype: %d",

60 
buf
[2] ) );

61 
	`SSL_DEBUG_MSG
( 3, ( "client hello v2, message†en.: %d",

62 ĞĞ
buf
[0] & 0x7F ) << 8 ) | buf[1] ) );

63 
	`SSL_DEBUG_MSG
( 3, ( "client hello v2, max. version: [%d:%d]",

64 
buf
[3], buf[4] ) );

76 ifĞ
buf
[2] !ğ
SSL_HS_CLIENT_HELLO
 ||

77 
buf
[3] !ğ
SSL_MAJOR_VERSION_3
 )

79 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

80 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

83 
n
 = ( ( 
buf
[0] << 8 ) | buf[1] ) & 0x7FFF;

85 ifĞ
n
 < 17 ||‚ > 512 )

87 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

88 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

91 
s¦
->
max_majÜ_v”
 = 
buf
[3];

92 
s¦
->
max_mšÜ_v”
 = 
buf
[4];

94 
s¦
->
majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

95 
s¦
->
mšÜ_v”
 = ( 
buf
[4] <ğ
SSL_MINOR_VERSION_2
 )

96 ? 
buf
[4] : 
SSL_MINOR_VERSION_2
;

98 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 2 + 
n
 ) ) != 0 )

100 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

101 Ğ
»t
 );

104 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , 
buf
 + 2, 
n
 );

105 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, 
buf
 + 2, 
n
 );

107 
buf
 = 
s¦
->
š_msg
;

108 
n
 = 
s¦
->
š_Ëá
 - 5;

118 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd cÚ‹Ás", 
buf
, 
n
 );

120 
ch_Ën
 = ( 
buf
[0] << 8 ) | buf[1];

121 
£ss_Ën
 = ( 
buf
[2] << 8 ) | buf[3];

122 
ch®_Ën
 = ( 
buf
[4] << 8 ) | buf[5];

124 
	`SSL_DEBUG_MSG
( 3, ( "ciph_len: %d, sess_len: %d, chal_len: %d",

125 
ch_Ën
, 
£ss_Ën
, 
ch®_Ën
 ) );

130 ifĞ
ch_Ën
 < 3 || ( ciph_len % 3 ) != 0 )

132 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

133 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

136 ifĞ
£ss_Ën
 < 0 || sess_len > 32 )

138 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

139 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

142 ifĞ
ch®_Ën
 < 8 || chal_len > 32 )

144 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

145 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

148 ifĞ
n
 !ğ6 + 
ch_Ën
 + 
£ss_Ën
 + 
ch®_Ën
 )

150 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

151 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

154 
	`SSL_DEBUG_BUF
( 3, "client hello, cipherlist",

155 
buf
 + 6, 
ch_Ën
 );

156 
	`SSL_DEBUG_BUF
( 3, "client hello, session id",

157 
buf
 + 6 + 
ch_Ën
, 
£ss_Ën
 );

158 
	`SSL_DEBUG_BUF
( 3, "client hello, challenge",

159 
buf
 + 6 + 
ch_Ën
 + 
£ss_Ën
, 
ch®_Ën
 );

161 
p
 = 
buf
 + 6 + 
ch_Ën
;

162 
s¦
->
£ssiÚ
->
Ëngth
 = 
£ss_Ën
;

163 
	`mem£t
Ğ
s¦
->
£ssiÚ
->
id
, 0, ( ssl->session->id ) );

164 
	`memıy
Ğ
s¦
->
£ssiÚ
->
id
, 
p
, s¦->£ssiÚ->
Ëngth
 );

166 
p
 +ğ
£ss_Ën
;

167 
	`mem£t
Ğ
s¦
->
¿ndby‹s
, 0, 64 );

168 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32 - 
ch®_Ën
, 
p
, chal_len );

170  
i
 = 0; 
s¦
->
ch”s
[i] != 0; i++ )

172  
j
 = 0, 
p
 = 
buf
 + 6; j < 
ch_Ën
; j += 3,… += 3 )

174 ifĞ
p
[0] == 0 &&

175 
p
[1] == 0 &&

176 
p
[2] =ğ
s¦
->
ch”s
[
i
] )

177 
have_ch”
;

183 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd h—d”", 
buf
, 5 );

185 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, messageype: %d",

186 
buf
[0] ) );

187 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, message†en.: %d",

188 Ğ
buf
[3] << 8 ) | buf[4] ) );

189 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3,…rotocol ver: [%d:%d]",

190 
buf
[1], buf[2] ) );

200 ifĞ
buf
[0] !ğ
SSL_MSG_HANDSHAKE
 ||

201 
buf
[1] !ğ
SSL_MAJOR_VERSION_3
 )

203 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

204 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

207 
n
 = ( 
buf
[3] << 8 ) | buf[4];

209 ifĞ
n
 < 45 ||‚ > 512 )

211 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

212 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

215 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 + 
n
 ) ) != 0 )

217 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

218 Ğ
»t
 );

221 
buf
 = 
s¦
->
š_msg
;

222 
n
 = 
s¦
->
š_Ëá
 - 5;

224 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , 
buf
, 
n
 );

225 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, 
buf
, 
n
 );

241 
	`SSL_DEBUG_BUF
Ğ4, "»cÜd cÚ‹Ás", 
buf
, 
n
 );

243 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, handshakeype: %d",

244 
buf
[0] ) );

245 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, handshake†en.: %d",

246 Ğ
buf
[1] << 16 ) | ( buf[2] << 8 ) | buf[3] ) );

247 
	`SSL_DEBUG_MSG
( 3, ( "client hello v3, max. version: [%d:%d]",

248 
buf
[4], buf[5] ) );

253 ifĞ
buf
[0] !ğ
SSL_HS_CLIENT_HELLO
 ||

254 
buf
[4] !ğ
SSL_MAJOR_VERSION_3
 )

256 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

257 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

260 
s¦
->
majÜ_v”
 = 
SSL_MAJOR_VERSION_3
;

261 
s¦
->
mšÜ_v”
 = ( 
buf
[5] <ğ
SSL_MINOR_VERSION_2
 )

262 ? 
buf
[5] : 
SSL_MINOR_VERSION_2
;

264 
s¦
->
max_majÜ_v”
 = 
buf
[4];

265 
s¦
->
max_mšÜ_v”
 = 
buf
[5];

267 
	`memıy
Ğ
s¦
->
¿ndby‹s
, 
buf
 + 6, 32 );

272 ifĞ
buf
[1] !ğ0 || 
n
 != 4 + ( ( buf[2] << 8 ) | buf[3] ) )

274 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

275 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

281 
£ss_Ën
 = 
buf
[38];

283 ifĞ
£ss_Ën
 < 0 || sess_len > 32 )

285 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

286 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

289 
s¦
->
£ssiÚ
->
Ëngth
 = 
£ss_Ën
;

290 
	`mem£t
Ğ
s¦
->
£ssiÚ
->
id
, 0, ( ssl->session->id ) );

291 
	`memıy
Ğ
s¦
->
£ssiÚ
->
id
, 
buf
 + 39 , s¦->£ssiÚ->
Ëngth
 );

296 
ch_Ën
 = ( 
buf
[39 + 
£ss_Ën
] << 8 )

297 | ( 
buf
[40 + 
£ss_Ën
] );

299 ifĞ
ch_Ën
 < 2 || ciph_len > 256 || ( ciph_len % 2 ) != 0 )

301 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

302 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

308 
comp_Ën
 = 
buf
[41 + 
£ss_Ën
 + 
ch_Ën
];

310 ifĞ
comp_Ën
 < 1 || comp_len > 16 )

312 
	`SSL_DEBUG_MSG
( 1, ( "bad client hello message" ) );

313 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_HELLO
 );

316 
	`SSL_DEBUG_BUF
( 3, "client hello,„andom bytes",

317 
buf
 + 6, 32 );

318 
	`SSL_DEBUG_BUF
( 3, "client hello, session id",

319 
buf
 + 38, 
£ss_Ën
 );

320 
	`SSL_DEBUG_BUF
( 3, "client hello, cipherlist",

321 
buf
 + 41 + 
£ss_Ën
, 
ch_Ën
 );

322 
	`SSL_DEBUG_BUF
( 3, "client hello, compression",

323 
buf
 + 42 + 
£ss_Ën
 + 
ch_Ën
, 
comp_Ën
 );

328  
i
 = 0; 
s¦
->
ch”s
[i] != 0; i++ )

330  
j
 = 0, 
p
 = 
buf
 + 41 + 
£ss_Ën
; j < 
ch_Ën
;

331 
j
 +ğ2, 
p
 += 2 )

333 ifĞ
p
[0] =ğ0 &&…[1] =ğ
s¦
->
ch”s
[
i
] )

334 
have_ch”
;

339 
	`SSL_DEBUG_MSG
( 1, ( "got‚o ciphers in common" ) );

341 Ğ
POLARSSL_ERR_SSL_NO_CIPHER_CHOSEN
 );

343 
have_ch”
:

345 
s¦
->
£ssiÚ
->
ch”
 = s¦->
ch”s
[
i
];

346 
s¦
->
š_Ëá
 = 0;

347 
s¦
->
¡©e
++;

349 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse client hello" ) );

352 
	}
}

354 
	$s¦_wr™e_£rv”_h–lo
Ğ
s¦_cÚ‹xt
 *
s¦
 )

356 
time_t
 
t
;

357 
»t
, 
i
, 
n
;

358 *
buf
, *
p
;

360 
	`SSL_DEBUG_MSG
( 2, ( "=> write server hello" ) );

369 
buf
 = 
s¦
->
out_msg
;

370 
p
 = 
buf
 + 4;

372 *
p
++ = (è
s¦
->
majÜ_v”
;

373 *
p
++ = (è
s¦
->
mšÜ_v”
;

375 
	`SSL_DEBUG_MSG
( 3, ( "server hello, chosen version: [%d:%d]",

376 
buf
[4], buf[5] ) );

378 
t
 = 
	`time
Ğ
NULL
 );

379 *
p
++ = ()Ğ
t
 >> 24 );

380 *
p
++ = ()Ğ
t
 >> 16 );

381 *
p
++ = ()Ğ
t
 >> 8 );

382 *
p
++ = ()Ğ
t
 );

384 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, cu¼’ˆtime: %lu", 
t
 ) );

386  
i
 = 28; i > 0; i-- )

387 *
p
++ = (è
s¦
->
	`f_ºg
Ğs¦->
p_ºg
 );

389 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32, 
buf
 + 6, 32 );

391 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo,„ªdom by‹s", 
buf
 + 6, 32 );

399 
s¦
->
£ssiÚ
->
Ëngth
 = 
n
 = 32;

400 *
p
++ = (è
s¦
->
£ssiÚ
->
Ëngth
;

402 ifĞ
s¦
->
s_g‘
 =ğ
NULL
 ||

403 
s¦
->
	`s_g‘
( ssl ) != 0 )

408 
s¦
->
»sume
 = 0;

409 
s¦
->
¡©e
++;

411  
i
 = 0; i < 
n
; i++ )

412 
s¦
->
£ssiÚ
->
id
[
i
] =

413 (è
s¦
->
	`f_ºg
Ğs¦->
p_ºg
 );

420 
s¦
->
»sume
 = 1;

421 
s¦
->
¡©e
 = 
SSL_SERVER_CHANGE_CIPHER_SPEC
;

423 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

425 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

426 Ğ
»t
 );

430 
	`memıy
Ğ
p
, 
s¦
->
£ssiÚ
->
id
, s¦->£ssiÚ->
Ëngth
 );

431 
p
 +ğ
s¦
->
£ssiÚ
->
Ëngth
;

433 
	`SSL_DEBUG_MSG
Ğ3, ( "£rv” h–lo, sessiÚ id†’.: %d", 
n
 ) );

434 
	`SSL_DEBUG_BUF
Ğ3, "£rv” h–lo, sessiÚ id", 
buf
 + 39, 
n
 );

435 
	`SSL_DEBUG_MSG
( 3, ( "%s session has been„esumed",

436 
s¦
->
»sume
 ? "a" : "no" ) );

438 *
p
++ = ()Ğ
s¦
->
£ssiÚ
->
ch”
 >> 8 );

439 *
p
++ = ()Ğ
s¦
->
£ssiÚ
->
ch”
 );

440 *
p
++ = 
SSL_COMPRESS_NULL
;

442 
	`SSL_DEBUG_MSG
( 3, ( "server hello, chosen cipher: %d",

443 
s¦
->
£ssiÚ
->
ch”
 ) );

444 
	`SSL_DEBUG_MSG
( 3, ( "server hello, compress‡lg.: %d", 0 ) );

446 
s¦
->
out_msgËn
 = 
p
 - 
buf
;

447 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

448 
s¦
->
out_msg
[0] = 
SSL_HS_SERVER_HELLO
;

450 
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 );

452 
	`SSL_DEBUG_MSG
( 2, ( "<= write server hello" ) );

454 Ğ
»t
 );

455 
	}
}

457 
	$s¦_wr™e_û¹ifiÿ‹_»que¡
Ğ
s¦_cÚ‹xt
 *
s¦
 )

459 
»t
, 
n
;

460 *
buf
, *
p
;

461 cÚ¡ 
x509_û¹
 *
üt
;

463 
	`SSL_DEBUG_MSG
( 2, ( "=> write certificate„equest" ) );

465 
s¦
->
¡©e
++;

467 ifĞ
s¦
->
authmode
 =ğ
SSL_VERIFY_NONE
 )

469 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write certificate„equest" ) );

483 
buf
 = 
s¦
->
out_msg
;

484 
p
 = 
buf
 + 4;

489 *
p
++ = 1;

490 *
p
++ = 1;

492 
p
 += 2;

493 
üt
 = 
s¦
->
ÿ_chaš
;

495  
üt
 !ğ
NULL
 )

497 ifĞ
p
 - 
buf
 > 4096 )

500 
n
 = 
üt
->
subjeù_¿w
.
Ën
;

501 *
p
++ = ()Ğ
n
 >> 8 );

502 *
p
++ = ()Ğ
n
 );

503 
	`memıy
Ğ
p
, 
üt
->
subjeù_¿w
.p, 
n
 );

505 
	`SSL_DEBUG_BUF
Ğ3, "»que¡ed DN", 
p
, 
n
 );

506 
p
 +ğ
n
; 
üt
 = c¹->
Ãxt
;

509 
s¦
->
out_msgËn
 = 
n
 = 
p
 - 
buf
;

510 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

511 
s¦
->
out_msg
[0] = 
SSL_HS_CERTIFICATE_REQUEST
;

512 
s¦
->
out_msg
[6] = ()ĞĞ
n
 - 8 ) >> 8 );

513 
s¦
->
out_msg
[7] = ()ĞĞ
n
 - 8 ) );

515 
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 );

517 
	`SSL_DEBUG_MSG
( 2, ( "<= write certificate„equest" ) );

519 Ğ
»t
 );

520 
	}
}

522 
	$s¦_wr™e_£rv”_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

524 
»t
, 
n
;

525 
hash
[36];

526 
md5_cÚ‹xt
 
md5
;

527 
sha1_cÚ‹xt
 
sha1
;

529 
	`SSL_DEBUG_MSG
( 2, ( "=> write server keyƒxchange" ) );

531 ifĞ
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_DES_168_SHA
 &&

532 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_128_SHA
 &&

533 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_AES_256_SHA
 &&

534 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 &&

535 
s¦
->
£ssiÚ
->
ch”
 !ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

537 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write server keyƒxchange" ) );

538 
s¦
->
¡©e
++;

542 #ià!
	`defšed
(
POLARSSL_DHM_C
)

543 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm is‚ot‡vailable" ) );

544 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

555 ifĞĞ
»t
 = 
	`dhm_make_·¿ms
Ğ&
s¦
->
dhm_ùx
, 256, s¦->
out_msg
 + 4,

556 &
n
, 
s¦
->
f_ºg
, s¦->
p_ºg
 ) ) != 0 )

558 
	`SSL_DEBUG_RET
Ğ1, "dhm_make_·¿ms", 
»t
 );

559 Ğ
»t
 );

562 
	`SSL_DEBUG_MPI
Ğ3, "DHM: X ", &
s¦
->
dhm_ùx
.
X
 );

563 
	`SSL_DEBUG_MPI
Ğ3, "DHM: P ", &
s¦
->
dhm_ùx
.
P
 );

564 
	`SSL_DEBUG_MPI
Ğ3, "DHM: G ", &
s¦
->
dhm_ùx
.
G
 );

565 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GX", &
s¦
->
dhm_ùx
.
GX
 );

580 
	`md5_¡¬ts
Ğ&
md5
 );

581 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
¿ndby‹s
, 64 );

582 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
out_msg
 + 4, 
n
 );

583 
	`md5_fšish
Ğ&
md5
, 
hash
 );

585 
	`sha1_¡¬ts
Ğ&
sha1
 );

586 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

587 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
out_msg
 + 4, 
n
 );

588 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

590 
	`SSL_DEBUG_BUF
Ğ3, "·¿m‘” hash", 
hash
, 36 );

592 
s¦
->
out_msg
[4 + 
n
] = ()Ğs¦->
r§_key
->
Ën
 >> 8 );

593 
s¦
->
out_msg
[5 + 
n
] = ()Ğs¦->
r§_key
->
Ën
 );

595 
»t
 = 
	`r§_pkcs1_sign
Ğ
s¦
->
r§_key
, 
RSA_PRIVATE
,

596 
SIG_RSA_RAW
, 36, 
hash
, 
s¦
->
out_msg
 + 6 + 
n
 );

597 ifĞ
»t
 != 0 )

599 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_sign", 
»t
 );

600 Ğ
»t
 );

603 
	`SSL_DEBUG_BUF
Ğ3, "my RSA sig", 
s¦
->
out_msg
 + 6 + 
n
,

604 
s¦
->
r§_key
->
Ën
 );

606 
s¦
->
out_msgËn
 = 6 + 
n
 + s¦->
r§_key
->
Ën
;

607 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

608 
s¦
->
out_msg
[0] = 
SSL_HS_SERVER_KEY_EXCHANGE
;

610 
s¦
->
¡©e
++;

612 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

614 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

615 Ğ
»t
 );

618 
	`SSL_DEBUG_MSG
( 2, ( "<= write server keyƒxchange" ) );

622 
	}
}

624 
	$s¦_wr™e_£rv”_h–lo_dÚe
Ğ
s¦_cÚ‹xt
 *
s¦
 )

626 
»t
;

628 
	`SSL_DEBUG_MSG
( 2, ( "=> write server hello done" ) );

630 
s¦
->
out_msgËn
 = 4;

631 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

632 
s¦
->
out_msg
[0] = 
SSL_HS_SERVER_HELLO_DONE
;

634 
s¦
->
¡©e
++;

636 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

638 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

639 Ğ
»t
 );

642 
	`SSL_DEBUG_MSG
( 2, ( "<= write server hello done" ) );

645 
	}
}

647 
	$s¦_·r£_ş›Á_key_exchªge
Ğ
s¦_cÚ‹xt
 *
s¦
 )

649 
»t
, 
i
, 
n
;

651 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse client keyƒxchange" ) );

653 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

655 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

656 Ğ
»t
 );

659 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

661 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

662 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

665 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_CLIENT_KEY_EXCHANGE
 )

667 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

668 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

671 ifĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_DES_168_SHA
 ||

672 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

673 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
 ||

674 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

675 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

677 #ià!
	`defšed
(
POLARSSL_DHM_C
)

678 
	`SSL_DEBUG_MSG
( 1, ( "support for dhm is‚ot‡vailable" ) );

679 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

684 
n
 = ( 
s¦
->
š_msg
[4] << 8 ) | ssl->in_msg[5];

686 ifĞ
n
 < 1 ||‚ > 
s¦
->
dhm_ùx
.
Ën
 ||

687 
n
 + 6 !ğ
s¦
->
š_h¦’
 )

689 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

690 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

693 ifĞĞ
»t
 = 
	`dhm_»ad_public
Ğ&
s¦
->
dhm_ùx
,

694 
s¦
->
š_msg
 + 6, 
n
 ) ) != 0 )

696 
	`SSL_DEBUG_RET
Ğ1, "dhm_»ad_public", 
»t
 );

697 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 | 
»t
 );

700 
	`SSL_DEBUG_MPI
Ğ3, "DHM: GY", &
s¦
->
dhm_ùx
.
GY
 );

702 
s¦
->
pm¦’
 = s¦->
dhm_ùx
.
Ën
;

704 ifĞĞ
»t
 = 
	`dhm_ÿlc_£ü‘
Ğ&
s¦
->
dhm_ùx
,

705 
s¦
->
´ema¡”
, &s¦->
pm¦’
 ) ) != 0 )

707 
	`SSL_DEBUG_RET
Ğ1, "dhm_ÿlc_£ü‘", 
»t
 );

708 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 | 
»t
 );

711 
	`SSL_DEBUG_MPI
Ğ3, "DHM: K ", &
s¦
->
dhm_ùx
.
K
 );

719 
i
 = 4;

720 
n
 = 
s¦
->
r§_key
->
Ën
;

721 
s¦
->
pm¦’
 = 48;

723 ifĞ
s¦
->
mšÜ_v”
 !ğ
SSL_MINOR_VERSION_0
 )

725 
i
 += 2;

726 ifĞ
s¦
->
š_msg
[4] !ğĞĞ
n
 >> 8 ) & 0xFF ) ||

727 
s¦
->
š_msg
[5] !ğĞĞ
n
 ) & 0xFF ) )

729 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

730 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

734 ifĞ
s¦
->
š_h¦’
 !ğ
i
 + 
n
 )

736 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

737 Ğ
POLARSSL_ERR_SSL_BAD_HS_CLIENT_KEY_EXCHANGE
 );

740 
»t
 = 
	`r§_pkcs1_deüy±
Ğ
s¦
->
r§_key
, 
RSA_PRIVATE
, &s¦->
pm¦’
,

741 
s¦
->
š_msg
 + 
i
, s¦->
´ema¡”
,

742 (
s¦
->
´ema¡”
) );

744 ifĞ
»t
 !ğ0 || 
s¦
->
pm¦’
 != 48 ||

745 
s¦
->
´ema¡”
[0] !ğs¦->
max_majÜ_v”
 ||

746 
s¦
->
´ema¡”
[1] !ğs¦->
max_mšÜ_v”
 )

748 
	`SSL_DEBUG_MSG
( 1, ( "bad client keyƒxchange message" ) );

756 
s¦
->
pm¦’
 = 48;

758  
i
 = 0; i < 
s¦
->
pm¦’
; i++ )

759 
s¦
->
´ema¡”
[
i
] = (ès¦->
	`f_ºg
Ğs¦->
p_ºg
 );

763 ifĞĞ
»t
 = 
	`s¦_d”ive_keys
Ğ
s¦
 ) ) != 0 )

765 
	`SSL_DEBUG_RET
Ğ1, "s¦_d”ive_keys", 
»t
 );

766 Ğ
»t
 );

769 ifĞ
s¦
->
s_£t
 !ğ
NULL
 )

770 
s¦
->
	`s_£t
( ssl );

772 
s¦
->
¡©e
++;

774 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse client keyƒxchange" ) );

777 
	}
}

779 
	$s¦_·r£_û¹ifiÿ‹_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
 )

781 
n1
, 
n2
, 
»t
;

782 
hash
[36];

784 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse certificate verify" ) );

786 ifĞ
s¦
->
³”_û¹
 =ğ
NULL
 )

788 
	`SSL_DEBUG_MSG
( 2, ( "<= skip…arse certificate verify" ) );

789 
s¦
->
¡©e
++;

793 
	`s¦_ÿlc_v”ify
Ğ
s¦
, 
hash
 );

795 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

797 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

798 Ğ
»t
 );

801 
s¦
->
¡©e
++;

803 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

805 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate verify message" ) );

806 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 );

809 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_CERTIFICATE_VERIFY
 )

811 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate verify message" ) );

812 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 );

815 
n1
 = 
s¦
->
³”_û¹
->
r§
.
Ën
;

816 
n2
 = ( 
s¦
->
š_msg
[4] << 8 ) | ssl->in_msg[5];

818 ifĞ
n1
 + 6 !ğ
s¦
->
š_h¦’
 ||‚1 !ğ
n2
 )

820 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate verify message" ) );

821 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE_VERIFY
 );

824 
»t
 = 
	`r§_pkcs1_v”ify
Ğ&
s¦
->
³”_û¹
->
r§
, 
RSA_PUBLIC
,

825 
SIG_RSA_RAW
, 36, 
hash
, 
s¦
->
š_msg
 + 6 );

826 ifĞ
»t
 != 0 )

828 
	`SSL_DEBUG_RET
Ğ1, "r§_pkcs1_v”ify", 
»t
 );

829 Ğ
»t
 );

832 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse certificate verify" ) );

835 
	}
}

840 
	$s¦_hªdshake_£rv”
Ğ
s¦_cÚ‹xt
 *
s¦
 )

842 
»t
 = 0;

844 
	`SSL_DEBUG_MSG
( 2, ( "=> handshake server" ) );

846  
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

848 
	`SSL_DEBUG_MSG
Ğ2, ( "£rv” s‹: %d", 
s¦
->
¡©e
 ) );

850 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

853  
s¦
->
¡©e
 )

855 
SSL_HELLO_REQUEST
:

856 
s¦
->
¡©e
 = 
SSL_CLIENT_HELLO
;

862 
SSL_CLIENT_HELLO
:

863 
»t
 = 
	`s¦_·r£_ş›Á_h–lo
Ğ
s¦
 );

873 
SSL_SERVER_HELLO
:

874 
»t
 = 
	`s¦_wr™e_£rv”_h–lo
Ğ
s¦
 );

877 
SSL_SERVER_CERTIFICATE
:

878 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹
Ğ
s¦
 );

881 
SSL_SERVER_KEY_EXCHANGE
:

882 
»t
 = 
	`s¦_wr™e_£rv”_key_exchªge
Ğ
s¦
 );

885 
SSL_CERTIFICATE_REQUEST
:

886 
»t
 = 
	`s¦_wr™e_û¹ifiÿ‹_»que¡
Ğ
s¦
 );

889 
SSL_SERVER_HELLO_DONE
:

890 
»t
 = 
	`s¦_wr™e_£rv”_h–lo_dÚe
Ğ
s¦
 );

900 
SSL_CLIENT_CERTIFICATE
:

901 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹
Ğ
s¦
 );

904 
SSL_CLIENT_KEY_EXCHANGE
:

905 
»t
 = 
	`s¦_·r£_ş›Á_key_exchªge
Ğ
s¦
 );

908 
SSL_CERTIFICATE_VERIFY
:

909 
»t
 = 
	`s¦_·r£_û¹ifiÿ‹_v”ify
Ğ
s¦
 );

912 
SSL_CLIENT_CHANGE_CIPHER_SPEC
:

913 
»t
 = 
	`s¦_·r£_chªge_ch”_¥ec
Ğ
s¦
 );

916 
SSL_CLIENT_FINISHED
:

917 
»t
 = 
	`s¦_·r£_fšished
Ğ
s¦
 );

924 
SSL_SERVER_CHANGE_CIPHER_SPEC
:

925 
»t
 = 
	`s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦
 );

928 
SSL_SERVER_FINISHED
:

929 
»t
 = 
	`s¦_wr™e_fšished
Ğ
s¦
 );

932 
SSL_FLUSH_BUFFERS
:

933 
	`SSL_DEBUG_MSG
( 2, ( "handshake: done" ) );

934 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

938 
	`SSL_DEBUG_MSG
Ğ1, ( "šv®id s‹ %d", 
s¦
->
¡©e
 ) );

939 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

942 ifĞ
»t
 != 0 )

946 
	`SSL_DEBUG_MSG
( 2, ( "<= handshake server" ) );

948 Ğ
»t
 );

949 
	}
}

	@tools/src/polarssl/ssl_tls.c

34 
	~"pŞ¬s¦/cÚfig.h
"

36 #ià
defšed
(
POLARSSL_SSL_TLS_C
)

38 
	~"pŞ¬s¦/«s.h
"

39 
	~"pŞ¬s¦/¬c4.h
"

40 
	~"pŞ¬s¦/ÿm–lŸ.h
"

41 
	~"pŞ¬s¦/des.h
"

42 
	~"pŞ¬s¦/debug.h
"

43 
	~"pŞ¬s¦/s¦.h
"

45 
	~<¡ršg.h
>

46 
	~<¡dlib.h
>

47 
	~<time.h
>

52 
	$s1_´f
Ğ*
£ü‘
, 
¦’
, *
Ïb–
,

53 *
¿ndom
, 
¾’
,

54 *
d¡buf
, 
dËn
 )

56 
nb
, 
hs
;

57 
i
, 
j
, 
k
;

58 *
S1
, *
S2
;

59 
tmp
[128];

60 
h_i
[20];

62 ifĞĞ
tmp
 ) < 20 + 
	`¡¾’
Ğ
Ïb–
 ) + 
¾’
 )

63 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

65 
hs
 = ( 
¦’
 + 1 ) / 2;

66 
S1
 = 
£ü‘
;

67 
S2
 = 
£ü‘
 + 
¦’
 - 
hs
;

69 
nb
 = 
	`¡¾’
Ğ
Ïb–
 );

70 
	`memıy
Ğ
tmp
 + 20, 
Ïb–
, 
nb
 );

71 
	`memıy
Ğ
tmp
 + 20 + 
nb
, 
¿ndom
, 
¾’
 );

72 
nb
 +ğ
¾’
;

77 
	`md5_hmac
Ğ
S1
, 
hs
, 
tmp
 + 20, 
nb
, 4 +mp );

79  
i
 = 0; i < 
dËn
; i += 16 )

81 
	`md5_hmac
Ğ
S1
, 
hs
, 4 + 
tmp
, 16 + 
nb
, 
h_i
 );

82 
	`md5_hmac
Ğ
S1
, 
hs
, 4 + 
tmp
, 16, 4 +mp );

84 
k
 = ( 
i
 + 16 > 
dËn
 ) ? dlen % 16 : 16;

86  
j
 = 0; j < 
k
; j++ )

87 
d¡buf
[
i
 + 
j
] = 
h_i
[j];

93 
	`sha1_hmac
Ğ
S2
, 
hs
, 
tmp
 + 20, 
nb
,mp );

95  
i
 = 0; i < 
dËn
; i += 20 )

97 
	`sha1_hmac
Ğ
S2
, 
hs
, 
tmp
, 20 + 
nb
, 
h_i
 );

98 
	`sha1_hmac
Ğ
S2
, 
hs
, 
tmp
, 20,mp );

100 
k
 = ( 
i
 + 20 > 
dËn
 ) ? dlen % 20 : 20;

102  
j
 = 0; j < 
k
; j++ )

103 
d¡buf
[
i
 + 
j
] = ()Ğd¡buf[˜+ j] ^ 
h_i
[j] );

106 
	`mem£t
Ğ
tmp
, 0, (mp ) );

107 
	`mem£t
Ğ
h_i
, 0, ( h_i ) );

110 
	}
}

112 
	$s¦_d”ive_keys
Ğ
s¦_cÚ‹xt
 *
s¦
 )

114 
i
;

115 
md5_cÚ‹xt
 
md5
;

116 
sha1_cÚ‹xt
 
sha1
;

117 
tmp
[64];

118 
·ddšg
[16];

119 
sha1sum
[20];

120 
keyblk
[256];

121 *
key1
;

122 *
key2
;

124 
	`SSL_DEBUG_MSG
( 2, ( "=> derive keys" ) );

136 ifĞ
s¦
->
»sume
 == 0 )

138 
Ën
 = 
s¦
->
pm¦’
;

140 
	`SSL_DEBUG_BUF
Ğ3, "´ema¡” seü‘", 
s¦
->
´ema¡”
, 
Ën
 );

142 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

144  
i
 = 0; i < 3; i++ )

146 
	`mem£t
Ğ
·ddšg
, 'A' + 
i
, 1 + i );

148 
	`sha1_¡¬ts
Ğ&
sha1
 );

149 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 1 + 
i
 );

150 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
´ema¡”
, 
Ën
 );

151 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

152 
	`sha1_fšish
Ğ&
sha1
, 
sha1sum
 );

154 
	`md5_¡¬ts
Ğ&
md5
 );

155 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
´ema¡”
, 
Ën
 );

156 
	`md5_upd©e
Ğ&
md5
, 
sha1sum
, 20 );

157 
	`md5_fšish
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
 + 
i
 * 16 );

161 
	`s1_´f
Ğ
s¦
->
´ema¡”
, 
Ën
, "master secret",

162 
s¦
->
¿ndby‹s
, 64, s¦->
£ssiÚ
->
ma¡”
, 48 );

164 
	`mem£t
Ğ
s¦
->
´ema¡”
, 0, ( ssl->premaster ) );

167 
	`SSL_DEBUG_MSG
( 3, ( "no…remaster (session„esumed)" ) );

172 
	`memıy
Ğ
tmp
, 
s¦
->
¿ndby‹s
, 64 );

173 
	`memıy
Ğ
s¦
->
¿ndby‹s
, 
tmp
 + 32, 32 );

174 
	`memıy
Ğ
s¦
->
¿ndby‹s
 + 32, 
tmp
, 32 );

175 
	`mem£t
Ğ
tmp
, 0, (mp ) );

189 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

191  
i
 = 0; i < 16; i++ )

193 
	`mem£t
Ğ
·ddšg
, 'A' + 
i
, 1 + i );

195 
	`sha1_¡¬ts
Ğ&
sha1
 );

196 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 1 + 
i
 );

197 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

198 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
¿ndby‹s
, 64 );

199 
	`sha1_fšish
Ğ&
sha1
, 
sha1sum
 );

201 
	`md5_¡¬ts
Ğ&
md5
 );

202 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

203 
	`md5_upd©e
Ğ&
md5
, 
sha1sum
, 20 );

204 
	`md5_fšish
Ğ&
md5
, 
keyblk
 + 
i
 * 16 );

207 
	`mem£t
Ğ&
md5
, 0, ( md5 ) );

208 
	`mem£t
Ğ&
sha1
, 0, ( sha1 ) );

210 
	`mem£t
Ğ
·ddšg
, 0, (…adding ) );

211 
	`mem£t
Ğ
sha1sum
, 0, ( sha1sum ) );

214 
	`s1_´f
Ğ
s¦
->
£ssiÚ
->
ma¡”
, 48, "keyƒxpansion",

215 
s¦
->
¿ndby‹s
, 64, 
keyblk
, 256 );

217 
	`SSL_DEBUG_MSG
Ğ3, ( "ch” = %s", 
	`s¦_g‘_ch”
Ğ
s¦
 ) ) );

218 
	`SSL_DEBUG_BUF
Ğ3, "ma¡” seü‘", 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

219 
	`SSL_DEBUG_BUF
Ğ4, "¿ndom by‹s", 
s¦
->
¿ndby‹s
, 64 );

220 
	`SSL_DEBUG_BUF
Ğ4, "key block", 
keyblk
, 256 );

222 
	`mem£t
Ğ
s¦
->
¿ndby‹s
, 0, ( ssl->randbytes ) );

227  
s¦
->
£ssiÚ
->
ch”
 )

229 #ià
	`defšed
(
POLARSSL_ARC4_C
)

230 
SSL_RSA_RC4_128_MD5
:

231 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 16;

232 
s¦
->
ivËn
 = 0; s¦->
maş’
 = 16;

235 
SSL_RSA_RC4_128_SHA
:

236 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 20;

237 
s¦
->
ivËn
 = 0; s¦->
maş’
 = 20;

241 #ià
	`defšed
(
POLARSSL_DES_C
)

242 
SSL_RSA_DES_168_SHA
:

243 
SSL_EDH_RSA_DES_168_SHA
:

244 
s¦
->
keyËn
 = 24; s¦->
mšËn
 = 24;

245 
s¦
->
ivËn
 = 8; s¦->
maş’
 = 20;

249 #ià
	`defšed
(
POLARSSL_AES_C
)

250 
SSL_RSA_AES_128_SHA
:

251 
SSL_EDH_RSA_AES_128_SHA
:

252 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 32;

253 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

256 
SSL_RSA_AES_256_SHA
:

257 
SSL_EDH_RSA_AES_256_SHA
:

258 
s¦
->
keyËn
 = 32; s¦->
mšËn
 = 32;

259 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

263 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

264 
SSL_RSA_CAMELLIA_128_SHA
:

265 
SSL_EDH_RSA_CAMELLIA_128_SHA
:

266 
s¦
->
keyËn
 = 16; s¦->
mšËn
 = 32;

267 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

270 
SSL_RSA_CAMELLIA_256_SHA
:

271 
SSL_EDH_RSA_CAMELLIA_256_SHA
:

272 
s¦
->
keyËn
 = 32; s¦->
mšËn
 = 32;

273 
s¦
->
ivËn
 = 16; s¦->
maş’
 = 20;

278 
	`SSL_DEBUG_MSG
( 1, ( "cipher %s is‚ot‡vailable",

279 
	`s¦_g‘_ch”
Ğ
s¦
 ) ) );

280 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

283 
	`SSL_DEBUG_MSG
( 3, ( "keylen: %d, minlen: %d, ivlen: %d, maclen: %d",

284 
s¦
->
keyËn
, s¦->
mšËn
, s¦->
ivËn
, s¦->
maş’
 ) );

289 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

291 
key1
 = 
keyblk
 + 
s¦
->
maş’
 * 2;

292 
key2
 = 
keyblk
 + 
s¦
->
maş’
 * 2 + s¦->
keyËn
;

294 
	`memıy
Ğ
s¦
->
mac_’c
, 
keyblk
, s¦->
maş’
 );

295 
	`memıy
Ğ
s¦
->
mac_dec
, 
keyblk
 + s¦->
maş’
, ssl->maclen );

300 
	`memıy
Ğ
s¦
->
iv_’c
, 
key2
 + s¦->
keyËn
, s¦->
ivËn
 );

301 
	`memıy
Ğ
s¦
->
iv_dec
, 
key2
 + s¦->
keyËn
 + s¦->
ivËn
,

302 
s¦
->
ivËn
 );

306 
key1
 = 
keyblk
 + 
s¦
->
maş’
 * 2 + s¦->
keyËn
;

307 
key2
 = 
keyblk
 + 
s¦
->
maş’
 * 2;

309 
	`memıy
Ğ
s¦
->
mac_dec
, 
keyblk
, s¦->
maş’
 );

310 
	`memıy
Ğ
s¦
->
mac_’c
, 
keyblk
 + s¦->
maş’
, ssl->maclen );

315 
	`memıy
Ğ
s¦
->
iv_dec
, 
key1
 + s¦->
keyËn
, s¦->
ivËn
 );

316 
	`memıy
Ğ
s¦
->
iv_’c
, 
key1
 + s¦->
keyËn
 + s¦->
ivËn
,

317 
s¦
->
ivËn
 );

320  
s¦
->
£ssiÚ
->
ch”
 )

322 #ià
	`defšed
(
POLARSSL_ARC4_C
)

323 
SSL_RSA_RC4_128_MD5
:

324 
SSL_RSA_RC4_128_SHA
:

325 
	`¬c4_£tup
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, s¦->
keyËn
 );

326 
	`¬c4_£tup
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, s¦->
keyËn
 );

330 #ià
	`defšed
(
POLARSSL_DES_C
)

331 
SSL_RSA_DES_168_SHA
:

332 
SSL_EDH_RSA_DES_168_SHA
:

333 
	`des3_£t3key_’c
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
 );

334 
	`des3_£t3key_dec
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
 );

338 #ià
	`defšed
(
POLARSSL_AES_C
)

339 
SSL_RSA_AES_128_SHA
:

340 
SSL_EDH_RSA_AES_128_SHA
:

341 
	`«s_£tkey_’c
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 128 );

342 
	`«s_£tkey_dec
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 128 );

345 
SSL_RSA_AES_256_SHA
:

346 
SSL_EDH_RSA_AES_256_SHA
:

347 
	`«s_£tkey_’c
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 256 );

348 
	`«s_£tkey_dec
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 256 );

352 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

353 
SSL_RSA_CAMELLIA_128_SHA
:

354 
SSL_EDH_RSA_CAMELLIA_128_SHA
:

355 
	`ÿm–lŸ_£tkey_’c
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 128 );

356 
	`ÿm–lŸ_£tkey_dec
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 128 );

359 
SSL_RSA_CAMELLIA_256_SHA
:

360 
SSL_EDH_RSA_CAMELLIA_256_SHA
:

361 
	`ÿm–lŸ_£tkey_’c
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_’c
, 
key1
, 256 );

362 
	`ÿm–lŸ_£tkey_dec
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_dec
, 
key2
, 256 );

367 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

370 
	`mem£t
Ğ
keyblk
, 0, ( keyblk ) );

372 
	`SSL_DEBUG_MSG
( 2, ( "<= derive keys" ) );

375 
	}
}

377 
	$s¦_ÿlc_v”ify
Ğ
s¦_cÚ‹xt
 *
s¦
, 
hash
[36] )

379 
md5_cÚ‹xt
 
md5
;

380 
sha1_cÚ‹xt
 
sha1
;

381 
·d_1
[48];

382 
·d_2
[48];

384 
	`SSL_DEBUG_MSG
( 2, ( "=> calc verify" ) );

386 
	`memıy
Ğ&
md5
 , &
s¦
->
fš_md5
 , Ğ
md5_cÚ‹xt
 ) );

387 
	`memıy
Ğ&
sha1
, &
s¦
->
fš_sha1
, Ğ
sha1_cÚ‹xt
 ) );

389 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

391 
	`mem£t
Ğ
·d_1
, 0x36, 48 );

392 
	`mem£t
Ğ
·d_2
, 0x5C, 48 );

394 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

395 
	`md5_upd©e
Ğ&
md5
, 
·d_1
, 48 );

396 
	`md5_fšish
Ğ&
md5
, 
hash
 );

398 
	`md5_¡¬ts
Ğ&
md5
 );

399 
	`md5_upd©e
Ğ&
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

400 
	`md5_upd©e
Ğ&
md5
, 
·d_2
, 48 );

401 
	`md5_upd©e
Ğ&
md5
, 
hash
, 16 );

402 
	`md5_fšish
Ğ&
md5
, 
hash
 );

404 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

405 
	`sha1_upd©e
Ğ&
sha1
, 
·d_1
, 40 );

406 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

408 
	`sha1_¡¬ts
Ğ&
sha1
 );

409 
	`sha1_upd©e
Ğ&
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

410 
	`sha1_upd©e
Ğ&
sha1
, 
·d_2
, 40 );

411 
	`sha1_upd©e
Ğ&
sha1
, 
hash
 + 16, 20 );

412 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

416 
	`md5_fšish
Ğ&
md5
, 
hash
 );

417 
	`sha1_fšish
Ğ&
sha1
, 
hash
 + 16 );

420 
	`SSL_DEBUG_BUF
Ğ3, "ÿlcuÏ‹d v”ify„esuÉ", 
hash
, 36 );

421 
	`SSL_DEBUG_MSG
( 2, ( "<= calc verify" ) );

424 
	}
}

429 
	$s¦_mac_md5
Ğ*
£ü‘
,

430 *
buf
, 
Ën
,

431 *
ùr
, 
ty³
 )

433 
h—d”
[11];

434 
·ddšg
[48];

435 
md5_cÚ‹xt
 
md5
;

437 
	`memıy
Ğ
h—d”
, 
ùr
, 8 );

438 
h—d”
[ 8] = (è
ty³
;

439 
h—d”
[ 9] = ()Ğ
Ën
 >> 8 );

440 
h—d”
[10] = ()Ğ
Ën
 );

442 
	`mem£t
Ğ
·ddšg
, 0x36, 48 );

443 
	`md5_¡¬ts
Ğ&
md5
 );

444 
	`md5_upd©e
Ğ&
md5
, 
£ü‘
, 16 );

445 
	`md5_upd©e
Ğ&
md5
, 
·ddšg
, 48 );

446 
	`md5_upd©e
Ğ&
md5
, 
h—d”
, 11 );

447 
	`md5_upd©e
Ğ&
md5
, 
buf
, 
Ën
 );

448 
	`md5_fšish
Ğ&
md5
, 
buf
 + 
Ën
 );

450 
	`mem£t
Ğ
·ddšg
, 0x5C, 48 );

451 
	`md5_¡¬ts
Ğ&
md5
 );

452 
	`md5_upd©e
Ğ&
md5
, 
£ü‘
, 16 );

453 
	`md5_upd©e
Ğ&
md5
, 
·ddšg
, 48 );

454 
	`md5_upd©e
Ğ&
md5
, 
buf
 + 
Ën
, 16 );

455 
	`md5_fšish
Ğ&
md5
, 
buf
 + 
Ën
 );

456 
	}
}

458 
	$s¦_mac_sha1
Ğ*
£ü‘
,

459 *
buf
, 
Ën
,

460 *
ùr
, 
ty³
 )

462 
h—d”
[11];

463 
·ddšg
[40];

464 
sha1_cÚ‹xt
 
sha1
;

466 
	`memıy
Ğ
h—d”
, 
ùr
, 8 );

467 
h—d”
[ 8] = (è
ty³
;

468 
h—d”
[ 9] = ()Ğ
Ën
 >> 8 );

469 
h—d”
[10] = ()Ğ
Ën
 );

471 
	`mem£t
Ğ
·ddšg
, 0x36, 40 );

472 
	`sha1_¡¬ts
Ğ&
sha1
 );

473 
	`sha1_upd©e
Ğ&
sha1
, 
£ü‘
, 20 );

474 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 40 );

475 
	`sha1_upd©e
Ğ&
sha1
, 
h—d”
, 11 );

476 
	`sha1_upd©e
Ğ&
sha1
, 
buf
, 
Ën
 );

477 
	`sha1_fšish
Ğ&
sha1
, 
buf
 + 
Ën
 );

479 
	`mem£t
Ğ
·ddšg
, 0x5C, 40 );

480 
	`sha1_¡¬ts
Ğ&
sha1
 );

481 
	`sha1_upd©e
Ğ&
sha1
, 
£ü‘
, 20 );

482 
	`sha1_upd©e
Ğ&
sha1
, 
·ddšg
, 40 );

483 
	`sha1_upd©e
Ğ&
sha1
, 
buf
 + 
Ën
, 20 );

484 
	`sha1_fšish
Ğ&
sha1
, 
buf
 + 
Ën
 );

485 
	}
}

490 
	$s¦_’üy±_buf
Ğ
s¦_cÚ‹xt
 *
s¦
 )

492 
i
, 
·dËn
;

494 
	`SSL_DEBUG_MSG
( 2, ( "=>ƒncrypt buf" ) );

499 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

501 ifĞ
s¦
->
maş’
 == 16 )

502 
	`s¦_mac_md5
Ğ
s¦
->
mac_’c
,

503 
s¦
->
out_msg
, s¦->
out_msgËn
,

504 
s¦
->
out_ùr
, s¦->
out_msgty³
 );

506 ifĞ
s¦
->
maş’
 == 20 )

507 
	`s¦_mac_sha1
Ğ
s¦
->
mac_’c
,

508 
s¦
->
out_msg
, s¦->
out_msgËn
,

509 
s¦
->
out_ùr
, s¦->
out_msgty³
 );

513 ifĞ
s¦
->
maş’
 == 16 )

514 
	`md5_hmac
Ğ
s¦
->
mac_’c
, 16,

515 
s¦
->
out_ùr
, s¦->
out_msgËn
 + 13,

516 
s¦
->
out_msg
 + s¦->
out_msgËn
 );

518 ifĞ
s¦
->
maş’
 == 20 )

519 
	`sha1_hmac
Ğ
s¦
->
mac_’c
, 20,

520 
s¦
->
out_ùr
, s¦->
out_msgËn
 + 13,

521 
s¦
->
out_msg
 + s¦->
out_msgËn
 );

524 
	`SSL_DEBUG_BUF
( 4, "computed mac",

525 
s¦
->
out_msg
 + s¦->
out_msgËn
, s¦->
maş’
 );

527 
s¦
->
out_msgËn
 +ğs¦->
maş’
;

529  
i
 = 7; i >= 0; i-- )

530 ifĞ++
s¦
->
out_ùr
[
i
] != 0 )

533 ifĞ
s¦
->
ivËn
 == 0 )

535 #ià
	`defšed
(
POLARSSL_ARC4_C
)

536 
·dËn
 = 0;

538 
	`SSL_DEBUG_MSG
( 3, ( "beforeƒncrypt: msglen = %d, "

540 
s¦
->
out_msgËn
, 0 ) );

542 
	`SSL_DEBUG_BUF
( 4, "beforeƒncrypt: output…ayload",

543 
s¦
->
out_msg
, s¦->
out_msgËn
 );

545 
	`¬c4_üy±
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_’c
,

546 
s¦
->
out_msgËn
, s¦->
out_msg
,

547 
s¦
->
out_msg
 );

549 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

554 *
’c_msg
;

555 
’c_msgËn
;

557 
·dËn
 = 
s¦
->
ivËn
 - ( s¦->
out_msgËn
 + 1 ) % ssl->ivlen;

558 ifĞ
·dËn
 =ğ
s¦
->
ivËn
 )

559 
·dËn
 = 0;

561  
i
 = 0; i <ğ
·dËn
; i++ )

562 
s¦
->
out_msg
[s¦->
out_msgËn
 + 
i
] = (è
·dËn
;

564 
s¦
->
out_msgËn
 +ğ
·dËn
 + 1;

566 
’c_msgËn
 = 
s¦
->
out_msgËn
;

567 
’c_msg
 = 
s¦
->
out_msg
;

573 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_2
 )

578  
i
 = 0; i < 
s¦
->
ivËn
; i++ )

579 
s¦
->
iv_’c
[
i
] = s¦->
	`f_ºg
Ğs¦->
p_ºg
 );

584 
	`memmove
Ğ
s¦
->
out_msg
 + s¦->
ivËn
, s¦->out_msg, s¦->
out_msgËn
 );

585 
	`memıy
Ğ
s¦
->
out_msg
, s¦->
iv_’c
, s¦->
ivËn
 );

590 
’c_msg
 = 
s¦
->
out_msg
 + s¦->
ivËn
;

591 
’c_msgËn
 = 
s¦
->
out_msgËn
;

592 
s¦
->
out_msgËn
 +ğs¦->
ivËn
;

595 
	`SSL_DEBUG_MSG
( 3, ( "beforeƒncrypt: msglen = %d, "

597 
s¦
->
out_msgËn
, s¦->
ivËn
, 
·dËn
 + 1 ) );

599 
	`SSL_DEBUG_BUF
( 4, "beforeƒncrypt: output…ayload",

600 
s¦
->
out_msg
, s¦->
out_msgËn
 );

602  
s¦
->
ivËn
 )

605 #ià
	`defšed
(
POLARSSL_DES_C
)

606 
	`des3_üy±_cbc
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_’c
,

607 
DES_ENCRYPT
, 
’c_msgËn
,

608 
s¦
->
iv_’c
, 
’c_msg
,ƒnc_msg );

613 #ià
	`defšed
(
POLARSSL_AES_C
)

614 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_128_SHA
 ||

615 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

616 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_256_SHA
 ||

617 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
)

619 
	`«s_üy±_cbc
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_’c
,

620 
AES_ENCRYPT
, 
’c_msgËn
,

621 
s¦
->
iv_’c
, 
’c_msg
,ƒnc_msg);

626 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

627 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_128_SHA
 ||

628 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

629 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_256_SHA
 ||

630 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

632 
	`ÿm–lŸ_üy±_cbc
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_’c
,

633 
CAMELLIA_ENCRYPT
, 
’c_msgËn
,

634 
s¦
->
iv_’c
, 
’c_msg
,ƒnc_msg );

640 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

644 
	`SSL_DEBUG_MSG
( 2, ( "<=ƒncrypt buf" ) );

647 
	}
}

649 
	$s¦_deüy±_buf
Ğ
s¦_cÚ‹xt
 *
s¦
 )

651 
i
, 
·dËn
;

652 
tmp
[20];

654 
	`SSL_DEBUG_MSG
( 2, ( "=> decrypt buf" ) );

656 ifĞ
s¦
->
š_msgËn
 < s¦->
mšËn
 )

658 
	`SSL_DEBUG_MSG
( 1, ( "in_msglen (%d) < minlen (%d)",

659 
s¦
->
š_msgËn
, s¦->
mšËn
 ) );

660 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

663 ifĞ
s¦
->
ivËn
 == 0 )

665 #ià
	`defšed
(
POLARSSL_ARC4_C
)

666 
·dËn
 = 0;

667 
	`¬c4_üy±
Ğ(
¬c4_cÚ‹xt
 *è
s¦
->
ùx_dec
,

668 
s¦
->
š_msgËn
, s¦->
š_msg
,

669 
s¦
->
š_msg
 );

671 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

676 *
dec_msg
;

677 *
dec_msg_»suÉ
;

678 
dec_msgËn
;

683 ifĞ
s¦
->
š_msgËn
 % s¦->
ivËn
 != 0 )

685 
	`SSL_DEBUG_MSG
( 1, ( "msglen (%d) %% ivlen (%d) != 0",

686 
s¦
->
š_msgËn
, s¦->
ivËn
 ) );

687 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

690 
dec_msgËn
 = 
s¦
->
š_msgËn
;

691 
dec_msg
 = 
s¦
->
š_msg
;

692 
dec_msg_»suÉ
 = 
s¦
->
š_msg
;

697 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_2
 )

699 
dec_msg
 +ğ
s¦
->
ivËn
;

700 
dec_msgËn
 -ğ
s¦
->
ivËn
;

701 
s¦
->
š_msgËn
 -ğs¦->
ivËn
;

703  
i
 = 0; i < 
s¦
->
ivËn
; i++ )

704 
s¦
->
iv_dec
[
i
] = s¦->
š_msg
[i];

707  
s¦
->
ivËn
 )

709 #ià
	`defšed
(
POLARSSL_DES_C
)

711 
	`des3_üy±_cbc
Ğ(
des3_cÚ‹xt
 *è
s¦
->
ùx_dec
,

712 
DES_DECRYPT
, 
dec_msgËn
,

713 
s¦
->
iv_dec
, 
dec_msg
, 
dec_msg_»suÉ
 );

718 #ià
	`defšed
(
POLARSSL_AES_C
)

719 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_128_SHA
 ||

720 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_128_SHA
 ||

721 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_AES_256_SHA
 ||

722 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_AES_256_SHA
)

724 
	`«s_üy±_cbc
Ğ(
«s_cÚ‹xt
 *è
s¦
->
ùx_dec
,

725 
AES_DECRYPT
, 
dec_msgËn
,

726 
s¦
->
iv_dec
, 
dec_msg
, 
dec_msg_»suÉ
 );

731 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

732 iàĞ
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_128_SHA
 ||

733 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_128_SHA
 ||

734 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_RSA_CAMELLIA_256_SHA
 ||

735 
s¦
->
£ssiÚ
->
ch”
 =ğ
SSL_EDH_RSA_CAMELLIA_256_SHA
)

737 
	`ÿm–lŸ_üy±_cbc
Ğ(
ÿm–lŸ_cÚ‹xt
 *è
s¦
->
ùx_dec
,

738 
CAMELLIA_DECRYPT
, 
dec_msgËn
,

739 
s¦
->
iv_dec
, 
dec_msg
, 
dec_msg_»suÉ
 );

745 Ğ
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
 );

748 
·dËn
 = 1 + 
s¦
->
š_msg
[s¦->
š_msgËn
 - 1];

750 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

752 ifĞ
·dËn
 > 
s¦
->
ivËn
 )

754 
	`SSL_DEBUG_MSG
( 1, ( "bad…adding†ength: is %d, "

756 
·dËn
, 
s¦
->
ivËn
 ) );

757 
·dËn
 = 0;

765  
i
 = 1; i <ğ
·dËn
; i++ )

767 ifĞ
s¦
->
š_msg
[s¦->
š_msgËn
 - 
i
] !ğ
·dËn
 - 1 )

769 
	`SSL_DEBUG_MSG
( 1, ( "bad…adding byte: should be "

770 "%02x, buˆi %02x", 
·dËn
 - 1,

771 
s¦
->
š_msg
[s¦->
š_msgËn
 - 
i
] ) );

772 
·dËn
 = 0;

778 
	`SSL_DEBUG_BUF
( 4, "raw buffer‡fter decryption",

779 
s¦
->
š_msg
, s¦->
š_msgËn
 );

784 
s¦
->
š_msgËn
 -ğĞs¦->
maş’
 + 
·dËn
 );

786 
s¦
->
š_hdr
[3] = ()Ğs¦->
š_msgËn
 >> 8 );

787 
s¦
->
š_hdr
[4] = ()Ğs¦->
š_msgËn
 );

789 
	`memıy
Ğ
tmp
, 
s¦
->
š_msg
 + s¦->
š_msgËn
, 20 );

791 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

793 ifĞ
s¦
->
maş’
 == 16 )

794 
	`s¦_mac_md5
Ğ
s¦
->
mac_dec
,

795 
s¦
->
š_msg
, s¦->
š_msgËn
,

796 
s¦
->
š_ùr
, s¦->
š_msgty³
 );

798 
	`s¦_mac_sha1
Ğ
s¦
->
mac_dec
,

799 
s¦
->
š_msg
, s¦->
š_msgËn
,

800 
s¦
->
š_ùr
, s¦->
š_msgty³
 );

804 ifĞ
s¦
->
maş’
 == 16 )

805 
	`md5_hmac
Ğ
s¦
->
mac_dec
, 16,

806 
s¦
->
š_ùr
, s¦->
š_msgËn
 + 13,

807 
s¦
->
š_msg
 + s¦->
š_msgËn
 );

809 
	`sha1_hmac
Ğ
s¦
->
mac_dec
, 20,

810 
s¦
->
š_ùr
, s¦->
š_msgËn
 + 13,

811 
s¦
->
š_msg
 + s¦->
š_msgËn
 );

814 
	`SSL_DEBUG_BUF
Ğ4, "mes§g mac", 
tmp
, 
s¦
->
maş’
 );

815 
	`SSL_DEBUG_BUF
Ğ4, "compu‹d mac", 
s¦
->
š_msg
 + s¦->
š_msgËn
,

816 
s¦
->
maş’
 );

818 ifĞ
	`memcmp
Ğ
tmp
, 
s¦
->
š_msg
 + s¦->
š_msgËn
,

819 
s¦
->
maş’
 ) != 0 )

821 
	`SSL_DEBUG_MSG
( 1, ( "message mac does‚ot match" ) );

822 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

829 ifĞ
s¦
->
ivËn
 !ğ0 && 
·dËn
 == 0 )

830 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

832 ifĞ
s¦
->
š_msgËn
 == 0 )

834 
s¦
->
nb_z”o
++;

840 ifĞ
s¦
->
nb_z”o
 > 3 )

842 
	`SSL_DEBUG_MSG
( 1, ( "received four consecutiveƒmpty "

844 Ğ
POLARSSL_ERR_SSL_INVALID_MAC
 );

848 
s¦
->
nb_z”o
 = 0;

850  
i
 = 7; i >= 0; i-- )

851 ifĞ++
s¦
->
š_ùr
[
i
] != 0 )

854 
	`SSL_DEBUG_MSG
( 2, ( "<= decrypt buf" ) );

857 
	}
}

862 
	$s¦_ãtch_šput
Ğ
s¦_cÚ‹xt
 *
s¦
, 
nb_wªt
 )

864 
»t
, 
Ën
;

866 
	`SSL_DEBUG_MSG
( 2, ( "=> fetch input" ) );

868  
s¦
->
š_Ëá
 < 
nb_wªt
 )

870 
Ën
 = 
nb_wªt
 - 
s¦
->
š_Ëá
;

871 
»t
 = 
s¦
->
	`f_»cv
Ğs¦->
p_»cv
, s¦->
š_hdr
 + s¦->
š_Ëá
, 
Ën
 );

873 
	`SSL_DEBUG_MSG
( 2, ( "in_left: %d,‚b_want: %d",

874 
s¦
->
š_Ëá
, 
nb_wªt
 ) );

875 
	`SSL_DEBUG_RET
Ğ2, "s¦->f_»cv", 
»t
 );

877 ifĞ
»t
 < 0 )

878 Ğ
»t
 );

880 
s¦
->
š_Ëá
 +ğ
»t
;

883 
	`SSL_DEBUG_MSG
( 2, ( "<= fetch input" ) );

886 
	}
}

891 
	$s¦_æush_ouut
Ğ
s¦_cÚ‹xt
 *
s¦
 )

893 
»t
;

894 *
buf
;

896 
	`SSL_DEBUG_MSG
( 2, ( "=> flush output" ) );

898  
s¦
->
out_Ëá
 > 0 )

900 
	`SSL_DEBUG_MSG
( 2, ( "message†ength: %d, out_left: %d",

901 5 + 
s¦
->
out_msgËn
, s¦->
out_Ëá
 ) );

903 
buf
 = 
s¦
->
out_hdr
 + 5 + s¦->
out_msgËn
 - s¦->
out_Ëá
;

904 
»t
 = 
s¦
->
	`f_£nd
Ğs¦->
p_£nd
, 
buf
, s¦->
out_Ëá
 );

905 
	`SSL_DEBUG_RET
Ğ2, "s¦->f_£nd", 
»t
 );

907 ifĞ
»t
 <= 0 )

908 Ğ
»t
 );

910 
s¦
->
out_Ëá
 -ğ
»t
;

913 
	`SSL_DEBUG_MSG
( 2, ( "<= flush output" ) );

916 
	}
}

921 
	$s¦_wr™e_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 )

923 
»t
, 
Ën
 = 
s¦
->
out_msgËn
;

925 
	`SSL_DEBUG_MSG
( 2, ( "=> write„ecord" ) );

927 
s¦
->
out_hdr
[0] = (ès¦->
out_msgty³
;

928 
s¦
->
out_hdr
[1] = (ès¦->
majÜ_v”
;

929 
s¦
->
out_hdr
[2] = (ès¦->
mšÜ_v”
;

930 
s¦
->
out_hdr
[3] = ()Ğ
Ën
 >> 8 );

931 
s¦
->
out_hdr
[4] = ()Ğ
Ën
 );

933 ifĞ
s¦
->
out_msgty³
 =ğ
SSL_MSG_HANDSHAKE
 )

935 
s¦
->
out_msg
[1] = ()ĞĞ
Ën
 - 4 ) >> 16 );

936 
s¦
->
out_msg
[2] = ()ĞĞ
Ën
 - 4 ) >> 8 );

937 
s¦
->
out_msg
[3] = ()ĞĞ
Ën
 - 4 ) );

939 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , s¦->
out_msg
, 
Ën
 );

940 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, s¦->
out_msg
, 
Ën
 );

943 ifĞ
s¦
->
do_üy±
 != 0 )

945 ifĞĞ
»t
 = 
	`s¦_’üy±_buf
Ğ
s¦
 ) ) != 0 )

947 
	`SSL_DEBUG_RET
Ğ1, "s¦_’üy±_buf", 
»t
 );

948 Ğ
»t
 );

951 
Ën
 = 
s¦
->
out_msgËn
;

952 
s¦
->
out_hdr
[3] = ()Ğ
Ën
 >> 8 );

953 
s¦
->
out_hdr
[4] = ()Ğ
Ën
 );

956 
s¦
->
out_Ëá
 = 5 + s¦->
out_msgËn
;

958 
	`SSL_DEBUG_MSG
( 3, ( "output„ecord: msgtype = %d, "

960 
s¦
->
out_hdr
[0], ssl->out_hdr[1], ssl->out_hdr[2],

961 Ğ
s¦
->
out_hdr
[3] << 8 ) | ssl->out_hdr[4] ) );

963 
	`SSL_DEBUG_BUF
( 4, "output„ecord sento‚etwork",

964 
s¦
->
out_hdr
, 5 + s¦->
out_msgËn
 );

966 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

968 
	`SSL_DEBUG_RET
Ğ1, "s¦_æush_ouut", 
»t
 );

969 Ğ
»t
 );

972 
	`SSL_DEBUG_MSG
( 2, ( "<= write„ecord" ) );

975 
	}
}

977 
	$s¦_»ad_»cÜd
Ğ
s¦_cÚ‹xt
 *
s¦
 )

979 
»t
;

981 
	`SSL_DEBUG_MSG
( 2, ( "=>„ead„ecord" ) );

983 ifĞ
s¦
->
š_h¦’
 != 0 &&

984 
s¦
->
š_h¦’
 < s¦->
š_msgËn
 )

989 
s¦
->
š_msgËn
 -ğs¦->
š_h¦’
;

991 
	`memıy
Ğ
s¦
->
š_msg
, s¦->š_msg + s¦->
š_h¦’
,

992 
s¦
->
š_msgËn
 );

994 
s¦
->
š_h¦’
 = 4;

995 
s¦
->
š_h¦’
 +ğĞs¦->
š_msg
[2] << 8 ) | ssl->in_msg[3];

997 
	`SSL_DEBUG_MSG
( 3, ( "handshake message: msglen ="

999 
s¦
->
š_msgËn
, s¦->
š_msg
[0], s¦->
š_h¦’
 ) );

1001 ifĞ
s¦
->
š_msgËn
 < 4 || s¦->
š_msg
[1] != 0 )

1003 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1004 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1007 ifĞ
s¦
->
š_msgËn
 < s¦->
š_h¦’
 )

1009 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1010 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1013 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , s¦->
š_msg
, s¦->
š_h¦’
 );

1014 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, s¦->
š_msg
, s¦->
š_h¦’
 );

1019 
s¦
->
š_h¦’
 = 0;

1024 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 ) ) != 0 )

1026 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

1027 Ğ
»t
 );

1030 
s¦
->
š_msgty³
 = s¦->
š_hdr
[0];

1031 
s¦
->
š_msgËn
 = ( s¦->
š_hdr
[3] << 8 ) | ssl->in_hdr[4];

1033 
	`SSL_DEBUG_MSG
( 3, ( "input„ecord: msgtype = %d, "

1035 
s¦
->
š_hdr
[0], ssl->in_hdr[1], ssl->in_hdr[2],

1036 Ğ
s¦
->
š_hdr
[3] << 8 ) | ssl->in_hdr[4] ) );

1038 ifĞ
s¦
->
š_hdr
[1] !ğs¦->
majÜ_v”
 )

1040 
	`SSL_DEBUG_MSG
( 1, ( "major version mismatch" ) );

1041 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1044 ifĞ
s¦
->
š_hdr
[2] > s¦->
max_mšÜ_v”
 )

1046 
	`SSL_DEBUG_MSG
( 1, ( "minor version mismatch" ) );

1047 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1053 ifĞ
s¦
->
do_üy±
 == 0 )

1055 ifĞ
s¦
->
š_msgËn
 < 1 ||

1056 
s¦
->
š_msgËn
 > 
SSL_MAX_CONTENT_LEN
 )

1058 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1059 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1064 ifĞ
s¦
->
š_msgËn
 < s¦->
mšËn
 )

1066 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1067 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1070 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 &&

1071 
s¦
->
š_msgËn
 > s¦->
mšËn
 + 
SSL_MAX_CONTENT_LEN
 )

1073 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1074 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1080 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_1
 &&

1081 
s¦
->
š_msgËn
 > s¦->
mšËn
 + 
SSL_MAX_CONTENT_LEN
 + 256 )

1083 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1084 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1091 ifĞĞ
»t
 = 
	`s¦_ãtch_šput
Ğ
s¦
, 5 + s¦->
š_msgËn
 ) ) != 0 )

1093 
	`SSL_DEBUG_RET
Ğ1, "s¦_ãtch_šput", 
»t
 );

1094 Ğ
»t
 );

1097 
	`SSL_DEBUG_BUF
( 4, "input„ecord from‚etwork",

1098 
s¦
->
š_hdr
, 5 + s¦->
š_msgËn
 );

1100 ifĞ
s¦
->
do_üy±
 != 0 )

1102 ifĞĞ
»t
 = 
	`s¦_deüy±_buf
Ğ
s¦
 ) ) != 0 )

1104 
	`SSL_DEBUG_RET
Ğ1, "s¦_deüy±_buf", 
»t
 );

1105 Ğ
»t
 );

1108 
	`SSL_DEBUG_BUF
( 4, "input…ayload‡fter decrypt",

1109 
s¦
->
š_msg
, s¦->
š_msgËn
 );

1111 ifĞ
s¦
->
š_msgËn
 > 
SSL_MAX_CONTENT_LEN
 )

1113 
	`SSL_DEBUG_MSG
( 1, ( "bad message†ength" ) );

1114 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1118 ifĞ
s¦
->
š_msgty³
 =ğ
SSL_MSG_HANDSHAKE
 )

1120 
s¦
->
š_h¦’
 = 4;

1121 
s¦
->
š_h¦’
 +ğĞs¦->
š_msg
[2] << 8 ) | ssl->in_msg[3];

1123 
	`SSL_DEBUG_MSG
( 3, ( "handshake message: msglen ="

1125 
s¦
->
š_msgËn
, s¦->
š_msg
[0], s¦->
š_h¦’
 ) );

1130 ifĞ
s¦
->
š_msgËn
 < 4 || s¦->
š_msg
[1] != 0 )

1132 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1133 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1136 ifĞ
s¦
->
š_msgËn
 < s¦->
š_h¦’
 )

1138 
	`SSL_DEBUG_MSG
( 1, ( "bad handshake†ength" ) );

1139 Ğ
POLARSSL_ERR_SSL_INVALID_RECORD
 );

1142 
	`md5_upd©e
Ğ&
s¦
->
fš_md5
 , s¦->
š_msg
, s¦->
š_h¦’
 );

1143 
	`sha1_upd©e
Ğ&
s¦
->
fš_sha1
, s¦->
š_msg
, s¦->
š_h¦’
 );

1146 ifĞ
s¦
->
š_msgty³
 =ğ
SSL_MSG_ALERT
 )

1148 
	`SSL_DEBUG_MSG
( 2, ( "got‡n‡lert message,ype: [%d:%d]",

1149 
s¦
->
š_msg
[0], ssl->in_msg[1] ) );

1154 ifĞ
s¦
->
š_msg
[0] =ğ
SSL_ALERT_LEVEL_FATAL
 )

1156 
	`SSL_DEBUG_MSG
( 1, ( "is‡ fatal‡lert message" ) );

1157 Ğ
POLARSSL_ERR_SSL_FATAL_ALERT_MESSAGE
 | 
s¦
->
š_msg
[1] );

1160 ifĞ
s¦
->
š_msg
[0] =ğ
SSL_ALERT_LEVEL_WARNING
 &&

1161 
s¦
->
š_msg
[1] =ğ
SSL_ALERT_MSG_CLOSE_NOTIFY
 )

1163 
	`SSL_DEBUG_MSG
( 2, ( "is‡ close‚otify message" ) );

1164 Ğ
POLARSSL_ERR_SSL_PEER_CLOSE_NOTIFY
 );

1168 
s¦
->
š_Ëá
 = 0;

1170 
	`SSL_DEBUG_MSG
( 2, ( "<=„ead„ecord" ) );

1173 
	}
}

1178 
	$s¦_wr™e_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1180 
»t
, 
i
, 
n
;

1181 cÚ¡ 
x509_û¹
 *
üt
;

1183 
	`SSL_DEBUG_MSG
( 2, ( "=> write certificate" ) );

1185 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1187 ifĞ
s¦
->
ş›Á_auth
 == 0 )

1189 
	`SSL_DEBUG_MSG
( 2, ( "<= skip write certificate" ) );

1190 
s¦
->
¡©e
++;

1198 ifĞ
s¦
->
own_û¹
 =ğ
NULL
 &&

1199 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

1201 
s¦
->
out_msgËn
 = 2;

1202 
s¦
->
out_msgty³
 = 
SSL_MSG_ALERT
;

1203 
s¦
->
out_msg
[0] = 
SSL_ALERT_LEVEL_WARNING
;

1204 
s¦
->
out_msg
[1] = 
SSL_ALERT_MSG_NO_CERT
;

1206 
	`SSL_DEBUG_MSG
( 2, ( "got‚o certificateo send" ) );

1207 
wr™e_msg
;

1212 ifĞ
s¦
->
own_û¹
 =ğ
NULL
 )

1214 
	`SSL_DEBUG_MSG
( 1, ( "got‚o certificateo send" ) );

1215 Ğ
POLARSSL_ERR_SSL_CERTIFICATE_REQUIRED
 );

1219 
	`SSL_DEBUG_CRT
Ğ3, "owÀû¹ifiÿ‹", 
s¦
->
own_û¹
 );

1230 
i
 = 7;

1231 
üt
 = 
s¦
->
own_û¹
;

1233  
üt
 !ğ
NULL
 )

1235 
n
 = 
üt
->
¿w
.
Ën
;

1236 ifĞ
i
 + 3 + 
n
 > 
SSL_MAX_CONTENT_LEN
 )

1238 
	`SSL_DEBUG_MSG
( 1, ( "certificateoo†arge, %d > %d",

1239 
i
 + 3 + 
n
, 
SSL_MAX_CONTENT_LEN
 ) );

1240 Ğ
POLARSSL_ERR_SSL_CERTIFICATE_TOO_LARGE
 );

1243 
s¦
->
out_msg
[
i
 ] = ()Ğ
n
 >> 16 );

1244 
s¦
->
out_msg
[
i
 + 1] = ()Ğ
n
 >> 8 );

1245 
s¦
->
out_msg
[
i
 + 2] = ()Ğ
n
 );

1247 
i
 +ğ3; 
	`memıy
Ğ
s¦
->
out_msg
 + i, 
üt
->
¿w
.
p
, 
n
 );

1248 
i
 +ğ
n
; 
üt
 = c¹->
Ãxt
;

1251 
s¦
->
out_msg
[4] = ()ĞĞ
i
 - 7 ) >> 16 );

1252 
s¦
->
out_msg
[5] = ()ĞĞ
i
 - 7 ) >> 8 );

1253 
s¦
->
out_msg
[6] = ()ĞĞ
i
 - 7 ) );

1255 
s¦
->
out_msgËn
 = 
i
;

1256 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

1257 
s¦
->
out_msg
[0] = 
SSL_HS_CERTIFICATE
;

1259 
wr™e_msg
:

1261 
s¦
->
¡©e
++;

1263 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

1265 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

1266 Ğ
»t
 );

1269 
	`SSL_DEBUG_MSG
( 2, ( "<= write certificate" ) );

1272 
	}
}

1274 
	$s¦_·r£_û¹ifiÿ‹
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1276 
»t
, 
i
, 
n
;

1278 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse certificate" ) );

1280 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 &&

1281 
s¦
->
authmode
 =ğ
SSL_VERIFY_NONE
 )

1283 
	`SSL_DEBUG_MSG
( 2, ( "<= skip…arse certificate" ) );

1284 
s¦
->
¡©e
++;

1288 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1290 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1291 Ğ
»t
 );

1294 
s¦
->
¡©e
++;

1299 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 &&

1300 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

1302 ifĞ
s¦
->
š_msgËn
 == 2 &&

1303 
s¦
->
š_msgty³
 =ğ
SSL_MSG_ALERT
 &&

1304 
s¦
->
š_msg
[0] =ğ
SSL_ALERT_LEVEL_WARNING
 &&

1305 
s¦
->
š_msg
[1] =ğ
SSL_ALERT_MSG_NO_CERT
 )

1307 
	`SSL_DEBUG_MSG
( 1, ( "SSLv3 client has‚o certificate" ) );

1309 ifĞ
s¦
->
authmode
 =ğ
SSL_VERIFY_OPTIONAL
 )

1312 Ğ
POLARSSL_ERR_SSL_NO_CLIENT_CERTIFICATE
 );

1316 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 &&

1317 
s¦
->
mšÜ_v”
 !ğ
SSL_MINOR_VERSION_0
 )

1319 ifĞ
s¦
->
š_h¦’
 == 7 &&

1320 
s¦
->
š_msgty³
 =ğ
SSL_MSG_HANDSHAKE
 &&

1321 
s¦
->
š_msg
[0] =ğ
SSL_HS_CERTIFICATE
 &&

1322 
	`memcmp
Ğ
s¦
->
š_msg
 + 4, "\0\0\0", 3 ) == 0 )

1324 
	`SSL_DEBUG_MSG
( 1, ( "TLSv1 client has‚o certificate" ) );

1326 ifĞ
s¦
->
authmode
 =ğ
SSL_VERIFY_REQUIRED
 )

1327 Ğ
POLARSSL_ERR_SSL_NO_CLIENT_CERTIFICATE
 );

1333 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

1335 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1336 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

1339 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_CERTIFICATE
 || s¦->
š_h¦’
 < 10 )

1341 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1342 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1348 
n
 = ( 
s¦
->
š_msg
[5] << 8 ) | ssl->in_msg[6];

1350 ifĞ
s¦
->
š_msg
[4] !ğ0 || s¦->
š_h¦’
 !ğ7 + 
n
 )

1352 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1353 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1356 ifĞĞ
s¦
->
³”_û¹
 = (
x509_û¹
 *è
	`m®loc
(

1357 Ğ
x509_û¹
 ) ) ) =ğ
NULL
 )

1359 
	`SSL_DEBUG_MSG
( 1, ( "malloc(%d bytes) failed",

1360 Ğ
x509_û¹
 ) ) );

1364 
	`mem£t
Ğ
s¦
->
³”_û¹
, 0, Ğ
x509_û¹
 ) );

1366 
i
 = 7;

1368  
i
 < 
s¦
->
š_h¦’
 )

1370 ifĞ
s¦
->
š_msg
[
i
] != 0 )

1372 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1373 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1376 
n
 = ( (è
s¦
->
š_msg
[
i
 + 1] << 8 )

1377 | (è
s¦
->
š_msg
[
i
 + 2];

1378 
i
 += 3;

1380 ifĞ
n
 < 128 || 
i
 +‚ > 
s¦
->
š_h¦’
 )

1382 
	`SSL_DEBUG_MSG
( 1, ( "bad certificate message" ) );

1383 Ğ
POLARSSL_ERR_SSL_BAD_HS_CERTIFICATE
 );

1386 
»t
 = 
	`x509·r£_üt
Ğ
s¦
->
³”_û¹
, s¦->
š_msg
 + 
i
, 
n
 );

1387 ifĞ
»t
 != 0 )

1389 
	`SSL_DEBUG_RET
Ğ1, " x509·r£_üt", 
»t
 );

1390 Ğ
»t
 );

1393 
i
 +ğ
n
;

1396 
	`SSL_DEBUG_CRT
Ğ3, "³” c”tifiÿ‹", 
s¦
->
³”_û¹
 );

1398 ifĞ
s¦
->
authmode
 !ğ
SSL_VERIFY_NONE
 )

1400 ifĞ
s¦
->
ÿ_chaš
 =ğ
NULL
 )

1402 
	`SSL_DEBUG_MSG
( 1, ( "got‚o CA chain" ) );

1403 Ğ
POLARSSL_ERR_SSL_CA_CHAIN_REQUIRED
 );

1406 
»t
 = 
	`x509·r£_v”ify
Ğ
s¦
->
³”_û¹
, s¦->
ÿ_chaš
, s¦->
ÿ_ül
,

1407 
s¦
->
³”_ú
, &s¦->
v”ify_»suÉ
 );

1409 ifĞ
»t
 != 0 )

1410 
	`SSL_DEBUG_RET
Ğ1, "x509_v”ify_û¹", 
»t
 );

1412 ifĞ
s¦
->
authmode
 !ğ
SSL_VERIFY_REQUIRED
 )

1413 
»t
 = 0;

1416 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse certificate" ) );

1418 Ğ
»t
 );

1419 
	}
}

1421 
	$s¦_wr™e_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1423 
»t
;

1425 
	`SSL_DEBUG_MSG
( 2, ( "=> write change cipher spec" ) );

1427 
s¦
->
out_msgty³
 = 
SSL_MSG_CHANGE_CIPHER_SPEC
;

1428 
s¦
->
out_msgËn
 = 1;

1429 
s¦
->
out_msg
[0] = 1;

1431 
s¦
->
do_üy±
 = 0;

1432 
s¦
->
¡©e
++;

1434 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

1436 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

1437 Ğ
»t
 );

1440 
	`SSL_DEBUG_MSG
( 2, ( "<= write change cipher spec" ) );

1443 
	}
}

1445 
	$s¦_·r£_chªge_ch”_¥ec
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1447 
»t
;

1449 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse change cipher spec" ) );

1451 
s¦
->
do_üy±
 = 0;

1453 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1455 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1456 Ğ
»t
 );

1459 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_CHANGE_CIPHER_SPEC
 )

1461 
	`SSL_DEBUG_MSG
( 1, ( "bad change cipher spec message" ) );

1462 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

1465 ifĞ
s¦
->
š_msgËn
 !ğ1 || s¦->
š_msg
[0] != 1 )

1467 
	`SSL_DEBUG_MSG
( 1, ( "bad change cipher spec message" ) );

1468 Ğ
POLARSSL_ERR_SSL_BAD_HS_CHANGE_CIPHER_SPEC
 );

1471 
s¦
->
¡©e
++;

1473 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse change cipher spec" ) );

1476 
	}
}

1478 
	$s¦_ÿlc_fšished
(

1479 
s¦_cÚ‹xt
 *
s¦
, *
buf
, 
äom
,

1480 
md5_cÚ‹xt
 *
md5
, 
sha1_cÚ‹xt
 *
sha1
 )

1482 
Ën
 = 12;

1483 *
£nd”
;

1484 
·dbuf
[48];

1485 
md5sum
[16];

1486 
sha1sum
[20];

1488 
	`SSL_DEBUG_MSG
( 2, ( "=> calc finished" ) );

1503 
	`SSL_DEBUG_BUF
( 4, "finished md5 state", (*)

1504 
md5
->
¡©e
, ( md5->state ) );

1506 
	`SSL_DEBUG_BUF
( 4, "finished sha1 state", (*)

1507 
sha1
->
¡©e
, ( sha1->state ) );

1509 ifĞ
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 )

1511 
£nd”
 = ( 
äom
 =ğ
SSL_IS_CLIENT
 ) ? (*) "CLNT"

1514 
	`mem£t
Ğ
·dbuf
, 0x36, 48 );

1516 
	`md5_upd©e
Ğ
md5
, (*è
£nd”
, 4 );

1517 
	`md5_upd©e
Ğ
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1518 
	`md5_upd©e
Ğ
md5
, 
·dbuf
, 48 );

1519 
	`md5_fšish
Ğ
md5
, 
md5sum
 );

1521 
	`sha1_upd©e
Ğ
sha1
, (*è
£nd”
, 4 );

1522 
	`sha1_upd©e
Ğ
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1523 
	`sha1_upd©e
Ğ
sha1
, 
·dbuf
, 40 );

1524 
	`sha1_fšish
Ğ
sha1
, 
sha1sum
 );

1526 
	`mem£t
Ğ
·dbuf
, 0x5C, 48 );

1528 
	`md5_¡¬ts
Ğ
md5
 );

1529 
	`md5_upd©e
Ğ
md5
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1530 
	`md5_upd©e
Ğ
md5
, 
·dbuf
, 48 );

1531 
	`md5_upd©e
Ğ
md5
, 
md5sum
, 16 );

1532 
	`md5_fšish
Ğ
md5
, 
buf
 );

1534 
	`sha1_¡¬ts
Ğ
sha1
 );

1535 
	`sha1_upd©e
Ğ
sha1
, 
s¦
->
£ssiÚ
->
ma¡”
, 48 );

1536 
	`sha1_upd©e
Ğ
sha1
, 
·dbuf
 , 40 );

1537 
	`sha1_upd©e
Ğ
sha1
, 
sha1sum
, 20 );

1538 
	`sha1_fšish
Ğ
sha1
, 
buf
 + 16 );

1540 
Ën
 += 24;

1544 
£nd”
 = ( 
äom
 =ğ
SSL_IS_CLIENT
 )

1548 
	`md5_fšish
Ğ
md5
, 
·dbuf
 );

1549 
	`sha1_fšish
Ğ
sha1
, 
·dbuf
 + 16 );

1551 
	`s1_´f
Ğ
s¦
->
£ssiÚ
->
ma¡”
, 48, 
£nd”
,

1552 
·dbuf
, 36, 
buf
, 
Ën
 );

1555 
	`SSL_DEBUG_BUF
Ğ3, "ÿløfšished„esuÉ", 
buf
, 
Ën
 );

1557 
	`mem£t
Ğ
md5
, 0, Ğ
md5_cÚ‹xt
 ) );

1558 
	`mem£t
Ğ
sha1
, 0, Ğ
sha1_cÚ‹xt
 ) );

1560 
	`mem£t
Ğ
·dbuf
, 0, (…adbuf ) );

1561 
	`mem£t
Ğ
md5sum
, 0, ( md5sum ) );

1562 
	`mem£t
Ğ
sha1sum
, 0, ( sha1sum ) );

1564 
	`SSL_DEBUG_MSG
( 2, ( "<= calc finished" ) );

1565 
	}
}

1567 
	$s¦_wr™e_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1569 
»t
, 
hash_Ën
;

1570 
md5_cÚ‹xt
 
md5
;

1571 
sha1_cÚ‹xt
 
sha1
;

1573 
	`SSL_DEBUG_MSG
( 2, ( "=> write finished" ) );

1575 
	`memıy
Ğ&
md5
 , &
s¦
->
fš_md5
 , Ğ
md5_cÚ‹xt
 ) );

1576 
	`memıy
Ğ&
sha1
, &
s¦
->
fš_sha1
, Ğ
sha1_cÚ‹xt
 ) );

1578 
	`s¦_ÿlc_fšished
Ğ
s¦
, s¦->
out_msg
 + 4,

1579 
s¦
->
’dpošt
, &
md5
, &
sha1
 );

1581 
hash_Ën
 = ( 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 ) ? 36 : 12;

1583 
s¦
->
out_msgËn
 = 4 + 
hash_Ën
;

1584 
s¦
->
out_msgty³
 = 
SSL_MSG_HANDSHAKE
;

1585 
s¦
->
out_msg
[0] = 
SSL_HS_FINISHED
;

1591 ifĞ
s¦
->
»sume
 != 0 )

1593 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1594 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

1596 
s¦
->
¡©e
 = 
SSL_CLIENT_CHANGE_CIPHER_SPEC
;

1599 
s¦
->
¡©e
++;

1601 
s¦
->
do_üy±
 = 1;

1603 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

1605 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

1606 Ğ
»t
 );

1609 
	`SSL_DEBUG_MSG
( 2, ( "<= write finished" ) );

1612 
	}
}

1614 
	$s¦_·r£_fšished
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1616 
»t
, 
hash_Ën
;

1617 
md5_cÚ‹xt
 
md5
;

1618 
sha1_cÚ‹xt
 
sha1
;

1619 
buf
[36];

1621 
	`SSL_DEBUG_MSG
( 2, ( "=>…arse finished" ) );

1623 
	`memıy
Ğ&
md5
 , &
s¦
->
fš_md5
 , Ğ
md5_cÚ‹xt
 ) );

1624 
	`memıy
Ğ&
sha1
, &
s¦
->
fš_sha1
, Ğ
sha1_cÚ‹xt
 ) );

1626 
s¦
->
do_üy±
 = 1;

1628 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1630 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1631 Ğ
»t
 );

1634 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_HANDSHAKE
 )

1636 
	`SSL_DEBUG_MSG
( 1, ( "bad finished message" ) );

1637 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

1640 
hash_Ën
 = ( 
s¦
->
mšÜ_v”
 =ğ
SSL_MINOR_VERSION_0
 ) ? 36 : 12;

1642 ifĞ
s¦
->
š_msg
[0] !ğ
SSL_HS_FINISHED
 ||

1643 
s¦
->
š_h¦’
 !ğ4 + 
hash_Ën
 )

1645 
	`SSL_DEBUG_MSG
( 1, ( "bad finished message" ) );

1646 Ğ
POLARSSL_ERR_SSL_BAD_HS_FINISHED
 );

1649 
	`s¦_ÿlc_fšished
Ğ
s¦
, 
buf
, s¦->
’dpošt
 ^ 1, &
md5
, &
sha1
 );

1651 ifĞ
	`memcmp
Ğ
s¦
->
š_msg
 + 4, 
buf
, 
hash_Ën
 ) != 0 )

1653 
	`SSL_DEBUG_MSG
( 1, ( "bad finished message" ) );

1654 Ğ
POLARSSL_ERR_SSL_BAD_HS_FINISHED
 );

1657 ifĞ
s¦
->
»sume
 != 0 )

1659 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1660 
s¦
->
¡©e
 = 
SSL_CLIENT_CHANGE_CIPHER_SPEC
;

1662 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 )

1663 
s¦
->
¡©e
 = 
SSL_HANDSHAKE_OVER
;

1666 
s¦
->
¡©e
++;

1668 
	`SSL_DEBUG_MSG
( 2, ( "<=…arse finished" ) );

1671 
	}
}

1676 
	$s¦_š™
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1678 
Ën
 = 
SSL_BUFFER_LEN
;

1680 
	`mem£t
Ğ
s¦
, 0, Ğ
s¦_cÚ‹xt
 ) );

1682 
s¦
->
š_ùr
 = (*è
	`m®loc
Ğ
Ën
 );

1683 
s¦
->
š_hdr
 = s¦->
š_ùr
 + 8;

1684 
s¦
->
š_msg
 = s¦->
š_ùr
 + 13;

1686 ifĞ
s¦
->
š_ùr
 =ğ
NULL
 )

1688 
	`SSL_DEBUG_MSG
Ğ1, ( "m®loc(%d by‹sèçed", 
Ën
 ) );

1692 
s¦
->
out_ùr
 = (*è
	`m®loc
Ğ
Ën
 );

1693 
s¦
->
out_hdr
 = s¦->
out_ùr
 + 8;

1694 
s¦
->
out_msg
 = s¦->
out_ùr
 + 13;

1696 ifĞ
s¦
->
out_ùr
 =ğ
NULL
 )

1698 
	`SSL_DEBUG_MSG
Ğ1, ( "m®loc(%d by‹sèçed", 
Ën
 ) );

1699 
	`ä“
Ğ
s¦
-> 
š_ùr
 );

1703 
	`mem£t
Ğ
s¦
-> 
š_ùr
, 0, 
SSL_BUFFER_LEN
 );

1704 
	`mem£t
Ğ
s¦
->
out_ùr
, 0, 
SSL_BUFFER_LEN
 );

1706 
s¦
->
ho¡Çme
 = 
NULL
;

1707 
s¦
->
ho¡Çme_Ën
 = 0;

1709 
	`md5_¡¬ts
Ğ&
s¦
->
fš_md5
 );

1710 
	`sha1_¡¬ts
Ğ&
s¦
->
fš_sha1
 );

1713 
	}
}

1718 
	$s¦_£t_’dpošt
Ğ
s¦_cÚ‹xt
 *
s¦
, 
’dpošt
 )

1720 
s¦
->
’dpošt
 =ƒndpoint;

1721 
	}
}

1723 
	$s¦_£t_authmode
Ğ
s¦_cÚ‹xt
 *
s¦
, 
authmode
 )

1725 
s¦
->
authmode
 =‡uthmode;

1726 
	}
}

1728 
s¦_£t_ºg
Ğ
s¦_cÚ‹xt
 *
s¦
,

1729 (*
f_ºg
)(*),

1730 *
p_ºg
 )

1732 
s¦
->
f_ºg
 = f_rng;

1733 
s¦
->
p_ºg
 =…_rng;

1734 
	}
}

1736 
s¦_£t_dbg
Ğ
s¦_cÚ‹xt
 *
s¦
,

1737 (*
f_dbg
)(*, , const *),

1738 *
p_dbg
 )

1740 
s¦
->
f_dbg
 = f_dbg;

1741 
s¦
->
p_dbg
 =…_dbg;

1742 
	}
}

1744 
s¦_£t_bio
Ğ
s¦_cÚ‹xt
 *
s¦
,

1745 (*
f_»cv
)(*, *, ), *
p_»cv
,

1746 (*
f_£nd
)(*, *, ), *
p_£nd
 )

1748 
s¦
->
f_»cv
 = f_recv;

1749 
s¦
->
f_£nd
 = f_send;

1750 
s¦
->
p_»cv
 =…_recv;

1751 
s¦
->
p_£nd
 =…_send;

1752 
	}
}

1754 
s¦_£t_scb
Ğ
s¦_cÚ‹xt
 *
s¦
,

1755 (*
s_g‘
)(
s¦_cÚ‹xt
 *),

1756 (*
s_£t
)(
s¦_cÚ‹xt
 *) )

1758 
s¦
->
s_g‘
 = s_get;

1759 
s¦
->
s_£t
 = s_set;

1760 
	}
}

1762 
	$s¦_£t_£ssiÚ
Ğ
s¦_cÚ‹xt
 *
s¦
, 
»sume
, 
timeout
,

1763 
s¦_£ssiÚ
 *
£ssiÚ
 )

1765 
s¦
->
»sume
 =„esume;

1766 
s¦
->
timeout
 =imeout;

1767 
s¦
->
£ssiÚ
 = session;

1768 
	}
}

1770 
	$s¦_£t_ch”s
Ğ
s¦_cÚ‹xt
 *
s¦
, *
ch”s
 )

1772 
s¦
->
ch”s
 = ciphers;

1773 
	}
}

1775 
	$s¦_£t_ÿ_chaš
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
ÿ_chaš
,

1776 
x509_ül
 *
ÿ_ül
, cÚ¡ *
³”_ú
 )

1778 
s¦
->
ÿ_chaš
 = ca_chain;

1779 
s¦
->
ÿ_ül
 = ca_crl;

1780 
s¦
->
³”_ú
 =…eer_cn;

1781 
	}
}

1783 
	$s¦_£t_own_û¹
Ğ
s¦_cÚ‹xt
 *
s¦
, 
x509_û¹
 *
own_û¹
,

1784 
r§_cÚ‹xt
 *
r§_key
 )

1786 
s¦
->
own_û¹
 = own_cert;

1787 
s¦
->
r§_key
 =„sa_key;

1788 
	}
}

1790 
	$s¦_£t_dh_·¿m
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
dhm_P
, cÚ¡ *
dhm_G
 )

1792 
»t
;

1794 ifĞĞ
»t
 = 
	`mpi_»ad_¡ršg
Ğ&
s¦
->
dhm_ùx
.
P
, 16, 
dhm_P
 ) ) != 0 )

1796 
	`SSL_DEBUG_RET
Ğ1, "mpi_»ad_¡ršg", 
»t
 );

1797 Ğ
»t
 );

1800 ifĞĞ
»t
 = 
	`mpi_»ad_¡ršg
Ğ&
s¦
->
dhm_ùx
.
G
, 16, 
dhm_G
 ) ) != 0 )

1802 
	`SSL_DEBUG_RET
Ğ1, "mpi_»ad_¡ršg", 
»t
 );

1803 Ğ
»t
 );

1807 
	}
}

1809 
	$s¦_£t_ho¡Çme
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
ho¡Çme
 )

1811 ifĞ
ho¡Çme
 =ğ
NULL
 )

1812 Ğ
POLARSSL_ERR_SSL_BAD_INPUT_DATA
 );

1814 
s¦
->
ho¡Çme_Ën
 = 
	`¡¾’
Ğ
ho¡Çme
 );

1815 
s¦
->
ho¡Çme
 = (*è
	`m®loc
Ğs¦->
ho¡Çme_Ën
 + 1 );

1817 
	`memıy
Ğ
s¦
->
ho¡Çme
, (*) hostname,

1818 
s¦
->
ho¡Çme_Ën
 );

1820 
s¦
->
ho¡Çme
[s¦->
ho¡Çme_Ën
] = '\0';

1823 
	}
}

1828 
	$s¦_g‘_by‹s_ava
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 )

1830 Ğ
s¦
->
š_ofá
 =ğ
NULL
 ? 0 : s¦->
š_msgËn
 );

1831 
	}
}

1833 
	$s¦_g‘_v”ify_»suÉ
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 )

1835 Ğ
s¦
->
v”ify_»suÉ
 );

1836 
	}
}

1838 cÚ¡ *
	$s¦_g‘_ch”
ĞcÚ¡ 
s¦_cÚ‹xt
 *
s¦
 )

1840  
s¦
->
£ssiÚ
->
ch”
 )

1842 #ià
	`defšed
(
POLARSSL_ARC4_C
)

1843 
SSL_RSA_RC4_128_MD5
:

1846 
SSL_RSA_RC4_128_SHA
:

1850 #ià
	`defšed
(
POLARSSL_DES_C
)

1851 
SSL_RSA_DES_168_SHA
:

1854 
SSL_EDH_RSA_DES_168_SHA
:

1858 #ià
	`defšed
(
POLARSSL_AES_C
)

1859 
SSL_RSA_AES_128_SHA
:

1862 
SSL_EDH_RSA_AES_128_SHA
:

1865 
SSL_RSA_AES_256_SHA
:

1868 
SSL_EDH_RSA_AES_256_SHA
:

1872 #ià
	`defšed
(
POLARSSL_CAMELLIA_C
)

1873 
SSL_RSA_CAMELLIA_128_SHA
:

1876 
SSL_EDH_RSA_CAMELLIA_128_SHA
:

1879 
SSL_RSA_CAMELLIA_256_SHA
:

1882 
SSL_EDH_RSA_CAMELLIA_256_SHA
:

1891 
	}
}

1893 
	gs¦_deçuÉ_ch”s
[] =

1895 #ià
defšed
(
POLARSSL_DHM_C
)

1896 #ià
defšed
(
POLARSSL_AES_C
)

1897 
SSL_EDH_RSA_AES_128_SHA
,

1898 
SSL_EDH_RSA_AES_256_SHA
,

1900 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

1901 
SSL_EDH_RSA_CAMELLIA_128_SHA
,

1902 
SSL_EDH_RSA_CAMELLIA_256_SHA
,

1904 #ià
defšed
(
POLARSSL_DES_C
)

1905 
SSL_EDH_RSA_DES_168_SHA
,

1909 #ià
defšed
(
POLARSSL_AES_C
)

1910 
SSL_RSA_AES_256_SHA
,

1912 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

1913 
SSL_RSA_CAMELLIA_256_SHA
,

1915 #ià
defšed
(
POLARSSL_AES_C
)

1916 
SSL_RSA_AES_128_SHA
,

1918 #ià
defšed
(
POLARSSL_CAMELLIA_C
)

1919 
SSL_RSA_CAMELLIA_128_SHA
,

1921 #ià
defšed
(
POLARSSL_DES_C
)

1922 
SSL_RSA_DES_168_SHA
,

1924 #ià
defšed
(
POLARSSL_ARC4_C
)

1925 
SSL_RSA_RC4_128_SHA
,

1926 
SSL_RSA_RC4_128_MD5
,

1934 
	$s¦_hªdshake
Ğ
s¦_cÚ‹xt
 *
s¦
 )

1936 
»t
 = 
POLARSSL_ERR_SSL_FEATURE_UNAVAILABLE
;

1938 
	`SSL_DEBUG_MSG
( 2, ( "=> handshake" ) );

1940 #ià
	`defšed
(
POLARSSL_SSL_CLI_C
)

1941 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_CLIENT
 )

1942 
»t
 = 
	`s¦_hªdshake_ş›Á
Ğ
s¦
 );

1945 #ià
	`defšed
(
POLARSSL_SSL_SRV_C
)

1946 ifĞ
s¦
->
’dpošt
 =ğ
SSL_IS_SERVER
 )

1947 
»t
 = 
	`s¦_hªdshake_£rv”
Ğ
s¦
 );

1950 
	`SSL_DEBUG_MSG
( 2, ( "<= handshake" ) );

1952 Ğ
»t
 );

1953 
	}
}

1958 
	$s¦_»ad
Ğ
s¦_cÚ‹xt
 *
s¦
, *
buf
, 
Ën
 )

1960 
»t
, 
n
;

1962 
	`SSL_DEBUG_MSG
( 2, ( "=>„ead" ) );

1964 ifĞ
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

1966 ifĞĞ
»t
 = 
	`s¦_hªdshake
Ğ
s¦
 ) ) != 0 )

1968 
	`SSL_DEBUG_RET
Ğ1, "s¦_hªdshake", 
»t
 );

1969 Ğ
»t
 );

1973 ifĞ
s¦
->
š_ofá
 =ğ
NULL
 )

1975 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1977 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1978 Ğ
»t
 );

1981 ifĞ
s¦
->
š_msgËn
 == 0 &&

1982 
s¦
->
š_msgty³
 =ğ
SSL_MSG_APPLICATION_DATA
 )

1987 ifĞĞ
»t
 = 
	`s¦_»ad_»cÜd
Ğ
s¦
 ) ) != 0 )

1989 
	`SSL_DEBUG_RET
Ğ1, "s¦_»ad_»cÜd", 
»t
 );

1990 Ğ
»t
 );

1994 ifĞ
s¦
->
š_msgty³
 !ğ
SSL_MSG_APPLICATION_DATA
 )

1996 
	`SSL_DEBUG_MSG
( 1, ( "bad‡pplication data message" ) );

1997 Ğ
POLARSSL_ERR_SSL_UNEXPECTED_MESSAGE
 );

2000 
s¦
->
š_ofá
 = s¦->
š_msg
;

2003 
n
 = ( 
Ën
 < 
s¦
->
š_msgËn
 )

2004 ? 
Ën
 : 
s¦
->
š_msgËn
;

2006 
	`memıy
Ğ
buf
, 
s¦
->
š_ofá
, 
n
 );

2007 
s¦
->
š_msgËn
 -ğ
n
;

2009 ifĞ
s¦
->
š_msgËn
 == 0 )

2011 
s¦
->
š_ofá
 = 
NULL
;

2014 
s¦
->
š_ofá
 +ğ
n
;

2016 
	`SSL_DEBUG_MSG
( 2, ( "<=„ead" ) );

2018 Ğ
n
 );

2019 
	}
}

2024 
	$s¦_wr™e
Ğ
s¦_cÚ‹xt
 *
s¦
, cÚ¡ *
buf
, 
Ën
 )

2026 
»t
, 
n
;

2028 
	`SSL_DEBUG_MSG
( 2, ( "=> write" ) );

2030 ifĞ
s¦
->
¡©e
 !ğ
SSL_HANDSHAKE_OVER
 )

2032 ifĞĞ
»t
 = 
	`s¦_hªdshake
Ğ
s¦
 ) ) != 0 )

2034 
	`SSL_DEBUG_RET
Ğ1, "s¦_hªdshake", 
»t
 );

2035 Ğ
»t
 );

2039 
n
 = ( 
Ën
 < 
SSL_MAX_CONTENT_LEN
 )

2040 ? 
Ën
 : 
SSL_MAX_CONTENT_LEN
;

2042 ifĞ
s¦
->
out_Ëá
 != 0 )

2044 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

2046 
	`SSL_DEBUG_RET
Ğ1, "s¦_æush_ouut", 
»t
 );

2047 Ğ
»t
 );

2052 
s¦
->
out_msgËn
 = 
n
;

2053 
s¦
->
out_msgty³
 = 
SSL_MSG_APPLICATION_DATA
;

2054 
	`memıy
Ğ
s¦
->
out_msg
, 
buf
, 
n
 );

2056 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

2058 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

2059 Ğ
»t
 );

2063 
	`SSL_DEBUG_MSG
( 2, ( "<= write" ) );

2065 Ğ
n
 );

2066 
	}
}

2071 
	$s¦_şo£_nÙify
Ğ
s¦_cÚ‹xt
 *
s¦
 )

2073 
»t
;

2075 
	`SSL_DEBUG_MSG
( 2, ( "=> write close‚otify" ) );

2077 ifĞĞ
»t
 = 
	`s¦_æush_ouut
Ğ
s¦
 ) ) != 0 )

2079 
	`SSL_DEBUG_RET
Ğ1, "s¦_æush_ouut", 
»t
 );

2080 Ğ
»t
 );

2083 ifĞ
s¦
->
¡©e
 =ğ
SSL_HANDSHAKE_OVER
 )

2085 
s¦
->
out_msgty³
 = 
SSL_MSG_ALERT
;

2086 
s¦
->
out_msgËn
 = 2;

2087 
s¦
->
out_msg
[0] = 
SSL_ALERT_LEVEL_WARNING
;

2088 
s¦
->
out_msg
[1] = 
SSL_ALERT_MSG_CLOSE_NOTIFY
;

2090 ifĞĞ
»t
 = 
	`s¦_wr™e_»cÜd
Ğ
s¦
 ) ) != 0 )

2092 
	`SSL_DEBUG_RET
Ğ1, "s¦_wr™e_»cÜd", 
»t
 );

2093 Ğ
»t
 );

2097 
	`SSL_DEBUG_MSG
( 2, ( "<= write close‚otify" ) );

2099 Ğ
»t
 );

2100 
	}
}

2105 
	$s¦_ä“
Ğ
s¦_cÚ‹xt
 *
s¦
 )

2107 
	`SSL_DEBUG_MSG
( 2, ( "=> free" ) );

2109 ifĞ
s¦
->
³”_û¹
 !ğ
NULL
 )

2111 
	`x509_ä“
Ğ
s¦
->
³”_û¹
 );

2112 
	`mem£t
Ğ
s¦
->
³”_û¹
, 0, Ğ
x509_û¹
 ) );

2113 
	`ä“
Ğ
s¦
->
³”_û¹
 );

2116 ifĞ
s¦
->
out_ùr
 !ğ
NULL
 )

2118 
	`mem£t
Ğ
s¦
->
out_ùr
, 0, 
SSL_BUFFER_LEN
 );

2119 
	`ä“
Ğ
s¦
->
out_ùr
 );

2122 ifĞ
s¦
->
š_ùr
 !ğ
NULL
 )

2124 
	`mem£t
Ğ
s¦
->
š_ùr
, 0, 
SSL_BUFFER_LEN
 );

2125 
	`ä“
Ğ
s¦
->
š_ùr
 );

2128 #ià
	`defšed
(
POLARSSL_DHM_C
)

2129 
	`dhm_ä“
Ğ&
s¦
->
dhm_ùx
 );

2132 iàĞ
s¦
->
ho¡Çme
 !ğ
NULL
)

2134 
	`mem£t
Ğ
s¦
->
ho¡Çme
, 0, s¦->
ho¡Çme_Ën
 );

2135 
	`ä“
Ğ
s¦
->
ho¡Çme
 );

2136 
s¦
->
ho¡Çme_Ën
 = 0;

2139 
	`SSL_DEBUG_MSG
( 2, ( "<= free" ) );

2142 
	`mem£t
Ğ
s¦
, 0, Ğ
s¦_cÚ‹xt
 ) );

2143 
	}
}

	@tools/src/polarssl/timing.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_TIMING_C
)

30 
	~"pŞ¬s¦/timšg.h
"

32 #ià
defšed
(
_WIN32
)

34 
	~<wšdows.h
>

35 
	~<wšba£.h
>

37 
	s_hr_time


39 
LARGE_INTEGER
 
	m¡¬t
;

44 
	~<uni¡d.h
>

45 
	~<sys/ty³s.h
>

46 
	~<sys/time.h
>

47 
	~<sigÇl.h
>

48 
	~<time.h
>

50 
	s_hr_time


52 
timev®
 
	m¡¬t
;

57 #ià
defšed
(
POLARSSL_HAVE_ASM
) && \

58 (
defšed
(
_MSC_VER
è&& defšed(
_M_IX86
)è|| 
	$defšed
(
__WATCOMC__
)

60 
	$h¬dşock
( )

62 
tsc
;

63 
__asm
 
rdtsc


64 
__asm
 
mov
 [
tsc
], 
—x


65 Ğ
tsc
 );

66 
	}
}

69 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__i386__
)

71 
	$h¬dşock
( )

73 
tsc
;

74 
	`asm
Ğ"rdtsc" : "÷" (
tsc
) );

75 Ğ
tsc
 );

76 
	}
}

79 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
) && \

80 (
defšed
(
__amd64__
è|| 
	$defšed
(
__x86_64__
))

82 
	$h¬dşock
( )

84 
lo
, 
hi
;

85 
	`asm
Ğ"rdtsc" : "÷" (
lo
), "=d" (
hi
) );

86 Ğ
lo
 | (
hi
 << 32) );

87 
	}
}

90 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
) && \

91 (
defšed
(
__pow”pc__
è|| 
	$defšed
(
__µc__
))

93 
	$h¬dşock
( )

95 
tbl
, 
tbu0
, 
tbu1
;

99 
	`asm
Ğ"mábu %0" : "ô" (
tbu0
) );

100 
	`asm
Ğ"máb %0" : "ô" (
tbl
 ) );

101 
	`asm
Ğ"mábu %0" : "ô" (
tbu1
) );

103  
tbu0
 !ğ
tbu1
 );

105 Ğ
tbl
 );

106 
	}
}

109 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__¥¬c__
)

111 
	$h¬dşock
( )

113 
tick
;

114 
	`asm
( ".byte 0x83, 0x41, 0x00, 0x00" );

115 
	`asm
Ğ"mov %%g1, %0" : "ô" (
tick
) );

116 Ğ
tick
 );

117 
	}
}

120 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__®pha__
)

122 
	$h¬dşock
( )

124 
cc
;

125 
	`asm
Ğ"½cø%0" : "ô" (
cc
) );

126 Ğ
cc
 & 0xFFFFFFFF );

127 
	}
}

130 #ià
defšed
(
POLARSSL_HAVE_ASM
è&& defšed(
__GNUC__
è&& defšed(
__Ÿ64__
)

132 
	$h¬dşock
( )

134 
™c
;

135 
	`asm
Ğ"mov %0 =‡r.™c" : "ô" (
™c
) );

136 Ğ
™c
 );

137 
	}
}

141 
	gh¬dşock_š™
 = 0;

142 
timev®
 
	gtv_š™
;

144 
	$h¬dşock
( )

146 
timev®
 
tv_cur
;

148 ifĞ
h¬dşock_š™
 == 0 )

150 
	`g‘timeofday
Ğ&
tv_š™
, 
NULL
 );

151 
h¬dşock_š™
 = 1;

154 
	`g‘timeofday
Ğ&
tv_cur
, 
NULL
 );

155 ĞĞ
tv_cur
.
tv_£c
 - 
tv_š™
.tv_sec ) * 1000000

156 + ( 
tv_cur
.
tv_u£c
 - 
tv_š™
.tv_usec ) );

157 
	}
}

167 
	g®¬med
 = 0;

169 #ià
defšed
(
_WIN32
)

171 
	$g‘_tim”
Ğ
hr_time
 *
v®
, 
»£t
 )

173 
d–
;

174 
LARGE_INTEGER
 
off£t
, 
häeq
;

175 
_hr_time
 *
t
 = (_hr_tim*è
v®
;

177 
	`Qu”yP”fÜmªûCouÁ”
Ğ&
off£t
 );

178 
	`Qu”yP”fÜmªûF»qu’cy
Ğ&
häeq
 );

180 
d–
 = ()( ( 1000 *

181 Ğ
off£t
.
QuadP¬t
 - 
t
->
¡¬t
.QuadPart ) ) /

182 
häeq
.
QuadP¬t
 );

184 ifĞ
»£t
 )

185 
	`Qu”yP”fÜmªûCouÁ”
Ğ&
t
->
¡¬t
 );

187 Ğ
d–
 );

188 
	}
}

190 
DWORD
 
WINAPI
 
	$Tim”Proc
Ğ
LPVOID
 
uEÏp£
 )

192 
	`SË•
Ğ(
DWORD
è
uEÏp£
 );

193 
®¬med
 = 1;

194 Ğ
TRUE
 );

195 
	}
}

197 
	$£t_®¬m
Ğ
£cÚds
 )

199 
DWORD
 
Th»adId
;

201 
®¬med
 = 0;

202 
	`Clo£HªdË
Ğ
	`C»©eTh»ad
Ğ
NULL
, 0, 
Tim”Proc
,

203 (
LPVOID
èĞ
£cÚds
 * 1000 ), 0, &
Th»adId
 ) );

204 
	}
}

206 
	$m_¦“p
Ğ
mli£cÚds
 )

208 
	`SË•
Ğ
mli£cÚds
 );

209 
	}
}

213 
	$g‘_tim”
Ğ
hr_time
 *
v®
, 
»£t
 )

215 
d–
;

216 
timev®
 
off£t
;

217 
_hr_time
 *
t
 = (_hr_tim*è
v®
;

219 
	`g‘timeofday
Ğ&
off£t
, 
NULL
 );

221 
d–
 = ( 
off£t
.
tv_£c
 - 
t
->
¡¬t
.tv_sec ) * 1000

222 + ( 
off£t
.
tv_u£c
 - 
t
->
¡¬t
.tv_usec ) / 1000;

224 ifĞ
»£t
 )

226 
t
->
¡¬t
.
tv_£c
 = 
off£t
.tv_sec;

227 
t
->
¡¬t
.
tv_u£c
 = 
off£t
.tv_usec;

230 Ğ
d–
 );

231 
	}
}

233 
	$sighªdËr
Ğ
signum
 )

235 
®¬med
 = 1;

236 
	`sigÇl
Ğ
signum
, 
sighªdËr
 );

237 
	}
}

239 
	$£t_®¬m
Ğ
£cÚds
 )

241 
®¬med
 = 0;

242 
	`sigÇl
Ğ
SIGALRM
, 
sighªdËr
 );

243 
	`®¬m
Ğ
£cÚds
 );

244 
	}
}

246 
	$m_¦“p
Ğ
mli£cÚds
 )

248 
timev®
 
tv
;

250 
tv
.
tv_£c
 = 
mli£cÚds
 / 1000;

251 
tv
.
tv_u£c
 = 
mli£cÚds
 * 1000;

253 
	`£Ëù
Ğ0, 
NULL
, NULL, NULL, &
tv
 );

254 
	}
}

	@tools/src/polarssl/timing.h

25 #iâdeà
POLARSSL_TIMING_H


26 
	#POLARSSL_TIMING_H


	)

31 
	shr_time


33 
	mİaque
[32];

36 #ifdeà
__ılu¥lus


40 
®¬med
;

45 
h¬dşock
( );

53 
g‘_tim”
Ğ
hr_time
 *
v®
, 
»£t
 );

60 
£t_®¬m
Ğ
£cÚds
 );

67 
m_¦“p
Ğ
mli£cÚds
 );

69 #ifdeà
__ılu¥lus


	@tools/src/polarssl/version.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_VERSION_C
)

30 
	~"pŞ¬s¦/v”siÚ.h
"

31 
	~<¡ršg.h
>

33 cÚ¡ 
	gv”siÚ
[] = 
POLARSSL_VERSION_STRING
;

35 
	$v”siÚ_g‘_numb”
()

37  
POLARSSL_VERSION_NUMBER
;

38 
	}
}

40 
	$v”siÚ_g‘_¡ršg
Ğ*
¡ršg
 )

42 
	`memıy
Ğ
¡ršg
, 
POLARSSL_VERSION_STRING
, ( POLARSSL_VERSION_STRING ) );

43 
	}
}

45 
	$v”siÚ_g‘_¡ršg_fuÎ
Ğ*
¡ršg
 )

47 
	`memıy
Ğ
¡ršg
, 
POLARSSL_VERSION_STRING_FULL
, ( POLARSSL_VERSION_STRING_FULL ) );

48 
	}
}

	@tools/src/polarssl/version.h

28 #iâdeà
POLARSSL_VERSION_H


29 
	#POLARSSL_VERSION_H


	)

31 
	~"pŞ¬s¦/cÚfig.h
"

37 
	#POLARSSL_VERSION_MAJOR
 0

	)

38 
	#POLARSSL_VERSION_MINOR
 14

	)

39 
	#POLARSSL_VERSION_PATCH
 3

	)

46 
	#POLARSSL_VERSION_NUMBER
 0x000E0300

	)

47 
	#POLARSSL_VERSION_STRING
 "0.14.3"

	)

48 
	#POLARSSL_VERSION_STRING_FULL
 "PŞ¬SSL 0.14.3"

	)

50 #ià
defšed
(
POLARSSL_VERSION_C
)

58 
v”siÚ_g‘_numb”
();

66 
v”siÚ_g‘_¡ršg
Ğ*
¡ršg
 );

74 
v”siÚ_g‘_¡ršg_fuÎ
Ğ*
¡ršg
 );

	@tools/src/polarssl/x509.h

25 #iâdeà
POLARSSL_X509_H


26 
	#POLARSSL_X509_H


	)

28 
	~"pŞ¬s¦/r§.h
"

36 
	#POLARSSL_ERR_ASN1_OUT_OF_DATA
 0x0014

	)

37 
	#POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 0x0016

	)

38 
	#POLARSSL_ERR_ASN1_INVALID_LENGTH
 0x0018

	)

39 
	#POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 0x001A

	)

40 
	#POLARSSL_ERR_ASN1_INVALID_DATA
 0x001C

	)

45 
	#POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 -0x0020

	)

46 
	#POLARSSL_ERR_X509_CERT_INVALID_PEM
 -0x0040

	)

47 
	#POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 -0x0060

	)

48 
	#POLARSSL_ERR_X509_CERT_INVALID_VERSION
 -0x0080

	)

49 
	#POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 -0x00A0

	)

50 
	#POLARSSL_ERR_X509_CERT_INVALID_ALG
 -0x00C0

	)

51 
	#POLARSSL_ERR_X509_CERT_INVALID_NAME
 -0x00E0

	)

52 
	#POLARSSL_ERR_X509_CERT_INVALID_DATE
 -0x0100

	)

53 
	#POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 -0x0120

	)

54 
	#POLARSSL_ERR_X509_CERT_INVALID_SIGNATURE
 -0x0140

	)

55 
	#POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 -0x0160

	)

56 
	#POLARSSL_ERR_X509_CERT_UNKNOWN_VERSION
 -0x0180

	)

57 
	#POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 -0x01A0

	)

58 
	#POLARSSL_ERR_X509_CERT_UNKNOWN_PK_ALG
 -0x01C0

	)

59 
	#POLARSSL_ERR_X509_CERT_SIG_MISMATCH
 -0x01E0

	)

60 
	#POLARSSL_ERR_X509_CERT_VERIFY_FAILED
 -0x0200

	)

61 
	#POLARSSL_ERR_X509_KEY_INVALID_PEM
 -0x0220

	)

62 
	#POLARSSL_ERR_X509_KEY_INVALID_VERSION
 -0x0240

	)

63 
	#POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 -0x0260

	)

64 
	#POLARSSL_ERR_X509_KEY_INVALID_ENC_IV
 -0x0280

	)

65 
	#POLARSSL_ERR_X509_KEY_UNKNOWN_ENC_ALG
 -0x02A0

	)

66 
	#POLARSSL_ERR_X509_KEY_PASSWORD_REQUIRED
 -0x02C0

	)

67 
	#POLARSSL_ERR_X509_KEY_PASSWORD_MISMATCH
 -0x02E0

	)

68 
	#POLARSSL_ERR_X509_POINT_ERROR
 -0x0300

	)

69 
	#POLARSSL_ERR_X509_VALUE_TO_LENGTH
 -0x0320

	)

74 
	#BADCERT_EXPIRED
 1

	)

75 
	#BADCERT_REVOKED
 2

	)

76 
	#BADCERT_CN_MISMATCH
 4

	)

77 
	#BADCERT_NOT_TRUSTED
 8

	)

78 
	#BADCRL_NOT_TRUSTED
 16

	)

79 
	#BADCRL_EXPIRED
 32

	)

84 
	#ASN1_BOOLEAN
 0x01

	)

85 
	#ASN1_INTEGER
 0x02

	)

86 
	#ASN1_BIT_STRING
 0x03

	)

87 
	#ASN1_OCTET_STRING
 0x04

	)

88 
	#ASN1_NULL
 0x05

	)

89 
	#ASN1_OID
 0x06

	)

90 
	#ASN1_UTF8_STRING
 0x0C

	)

91 
	#ASN1_SEQUENCE
 0x10

	)

92 
	#ASN1_SET
 0x11

	)

93 
	#ASN1_PRINTABLE_STRING
 0x13

	)

94 
	#ASN1_T61_STRING
 0x14

	)

95 
	#ASN1_IA5_STRING
 0x16

	)

96 
	#ASN1_UTC_TIME
 0x17

	)

97 
	#ASN1_GENERALIZED_TIME
 0x18

	)

98 
	#ASN1_UNIVERSAL_STRING
 0x1C

	)

99 
	#ASN1_BMP_STRING
 0x1E

	)

100 
	#ASN1_PRIMITIVE
 0x00

	)

101 
	#ASN1_CONSTRUCTED
 0x20

	)

102 
	#ASN1_CONTEXT_SPECIFIC
 0x80

	)

107 
	#X520_COMMON_NAME
 3

	)

108 
	#X520_COUNTRY
 6

	)

109 
	#X520_LOCALITY
 7

	)

110 
	#X520_STATE
 8

	)

111 
	#X520_ORGANIZATION
 10

	)

112 
	#X520_ORG_UNIT
 11

	)

113 
	#PKCS9_EMAIL
 1

	)

115 
	#X509_OUTPUT_DER
 0x01

	)

116 
	#X509_OUTPUT_PEM
 0x02

	)

117 
	#PEM_LINE_LENGTH
 72

	)

118 
	#X509_ISSUER
 0x01

	)

119 
	#X509_SUBJECT
 0x02

	)

121 
	#OID_X520
 "\x55\x04"

	)

122 
	#OID_CN
 "\x55\x04\x03"

	)

123 
	#OID_PKCS1
 "\x2A\x86\x48\x86\xF7\x0D\x01\x01"

	)

124 
	#OID_PKCS1_RSA
 "\x2A\x86\x48\x86\xF7\x0D\x01\x01\x01"

	)

125 
	#OID_RSA_SHA_OBS
 "\x2B\x0E\x03\x02\x1D"

	)

126 
	#OID_PKCS9
 "\x2A\x86\x48\x86\xF7\x0D\x01\x09"

	)

127 
	#OID_PKCS9_EMAIL
 "\x2A\x86\x48\x86\xF7\x0D\x01\x09\x01"

	)

132 
	s_x509_buf


134 
	mg
;

135 
	mËn
;

136 *
	mp
;

138 
	tx509_buf
;

140 
	s_x509_Çme


142 
x509_buf
 
	moid
;

143 
x509_buf
 
	mv®
;

144 
_x509_Çme
 *
	mÃxt
;

146 
	tx509_Çme
;

148 
	s_x509_time


150 
	my—r
, 
	mmÚ
, 
	mday
;

151 
	mhour
, 
	mmš
, 
	m£c
;

153 
	tx509_time
;

155 
	s_x509_û¹


157 
x509_buf
 
	m¿w
;

158 
x509_buf
 
	mtbs
;

160 
	mv”siÚ
;

161 
x509_buf
 
	m£rŸl
;

162 
x509_buf
 
	msig_oid1
;

164 
x509_buf
 
	missu”_¿w
;

165 
x509_buf
 
	msubjeù_¿w
;

167 
x509_Çme
 
	missu”
;

168 
x509_Çme
 
	msubjeù
;

170 
x509_time
 
	mv®id_äom
;

171 
x509_time
 
	mv®id_to
;

173 
x509_buf
 
	mpk_oid
;

174 
r§_cÚ‹xt
 
	mr§
;

176 
x509_buf
 
	missu”_id
;

177 
x509_buf
 
	msubjeù_id
;

178 
x509_buf
 
	mv3_ext
;

180 
	mÿ_i¡rue
;

181 
	mmax_·thËn
;

183 
x509_buf
 
	msig_oid2
;

184 
x509_buf
 
	msig
;

185 
	msig_®g
;

187 
_x509_û¹
 *
	mÃxt
;

189 
	tx509_û¹
;

191 
	s_x509_ül_’Œy


193 
x509_buf
 
	m¿w
;

195 
x509_buf
 
	m£rŸl
;

197 
x509_time
 
	m»voÿtiÚ_d©e
;

199 
x509_buf
 
	m’Œy_ext
;

201 
_x509_ül_’Œy
 *
	mÃxt
;

203 
	tx509_ül_’Œy
;

205 
	s_x509_ül


207 
x509_buf
 
	m¿w
;

208 
x509_buf
 
	mtbs
;

210 
	mv”siÚ
;

211 
x509_buf
 
	msig_oid1
;

213 
x509_buf
 
	missu”_¿w
;

215 
x509_Çme
 
	missu”
;

217 
x509_time
 
	mthis_upd©e
;

218 
x509_time
 
	mÃxt_upd©e
;

220 
x509_ül_’Œy
 
	m’Œy
;

222 
x509_buf
 
	mül_ext
;

224 
x509_buf
 
	msig_oid2
;

225 
x509_buf
 
	msig
;

226 
	msig_®g
;

228 
_x509_ül
 *
	mÃxt
;

230 
	tx509_ül
;

235 
	s_x509_node


237 *
	md©a
;

238 *
	mp
;

239 *
	m’d
;

241 
size_t
 
	mËn
;

243 
	tx509_node
;

245 
	s_x509_¿w


247 
x509_node
 
	m¿w
;

248 
x509_node
 
	mtbs
;

250 
x509_node
 
	mv”siÚ
;

251 
x509_node
 
	m£rŸl
;

252 
x509_node
 
	mtbs_sigÇlg
;

253 
x509_node
 
	missu”
;

254 
x509_node
 
	mv®id™y
;

255 
x509_node
 
	msubjeù
;

256 
x509_node
 
	msubpubkey
;

258 
x509_node
 
	msigÇlg
;

259 
x509_node
 
	msign
;

261 
	tx509_¿w
;

263 #ifdeà
__ılu¥lus


277 
x509·r£_üt
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 );

288 
x509·r£_ütfe
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
·th
 );

300 
x509·r£_ül
Ğ
x509_ül
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 );

311 
x509·r£_ülfe
Ğ
x509_ül
 *
chaš
, cÚ¡ *
·th
 );

324 
x509·r£_key
Ğ
r§_cÚ‹xt
 *
r§
,

325 cÚ¡ *
key
, 
keyËn
,

326 cÚ¡ *
pwd
, 
pwdËn
 );

337 
x509·r£_keyfe
Ğ
r§_cÚ‹xt
 *
r§
, cÚ¡ *
·th
,

338 cÚ¡ *
·sswÜd
 );

351 
x509·r£_dn_g‘s
Ğ*
buf
, 
size_t
 
size
, cÚ¡ 
x509_Çme
 *
dn
 );

365 
x509·r£_û¹_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

366 cÚ¡ 
x509_û¹
 *
üt
 );

380 
x509·r£_ül_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

381 cÚ¡ 
x509_ül
 *
ül
 );

392 
x509·r£_time_expœed
ĞcÚ¡ 
x509_time
 *
time
 );

414 
x509·r£_v”ify
Ğ
x509_û¹
 *
üt
,

415 
x509_û¹
 *
Œu¡_ÿ
,

416 
x509_ül
 *
ÿ_ül
,

417 cÚ¡ *
ú
, *
æags
 );

424 
x509_ä“
Ğ
x509_û¹
 *
üt
 );

431 
x509_ül_ä“
Ğ
x509_ül
 *
ül
 );

438 
x509_£lf_‹¡
Ğ
v”bo£
 );

440 #ifdeà
__ılu¥lus


	@tools/src/polarssl/x509parse.c

37 
	~"pŞ¬s¦/cÚfig.h
"

39 #ià
defšed
(
POLARSSL_X509_PARSE_C
)

41 
	~"pŞ¬s¦/x509.h
"

42 
	~"pŞ¬s¦/ba£64.h
"

43 
	~"pŞ¬s¦/des.h
"

44 
	~"pŞ¬s¦/md2.h
"

45 
	~"pŞ¬s¦/md4.h
"

46 
	~"pŞ¬s¦/md5.h
"

47 
	~"pŞ¬s¦/sha1.h
"

48 
	~"pŞ¬s¦/sha2.h
"

49 
	~"pŞ¬s¦/sha4.h
"

51 
	~<¡ršg.h
>

52 
	~<¡dlib.h
>

53 
	~<¡dio.h
>

54 
	~<time.h
>

59 
	$a¢1_g‘_Ën
Ğ**
p
,

60 cÚ¡ *
’d
,

61 *
Ën
 )

63 ifĞĞ
’d
 - *
p
 ) < 1 )

64 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

66 ifĞĞ**
p
 & 0x80 ) == 0 )

67 *
Ën
 = *(*
p
)++;

70  **
p
 & 0x7F )

73 ifĞĞ
’d
 - *
p
 ) < 2 )

74 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

76 *
Ën
 = (*
p
)[1];

77 (*
p
) += 2;

81 ifĞĞ
’d
 - *
p
 ) < 3 )

82 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

84 *
Ën
 = ( (*
p
)[1] << 8 ) | (*p)[2];

85 (*
p
) += 3;

89 Ğ
POLARSSL_ERR_ASN1_INVALID_LENGTH
 );

94 ifĞ*
Ën
 > (èĞ
’d
 - *
p
 ) )

95 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

98 
	}
}

100 
	$a¢1_g‘_g
Ğ**
p
,

101 cÚ¡ *
’d
,

102 *
Ën
, 
g
 )

104 ifĞĞ
’d
 - *
p
 ) < 1 )

105 Ğ
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

107 ifĞ**
p
 !ğ
g
 )

108 Ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

110 (*
p
)++;

112 Ğ
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, 
Ën
 ) );

113 
	}
}

115 
	$a¢1_g‘_boŞ
Ğ**
p
,

116 cÚ¡ *
’d
,

117 *
v®
 )

119 
»t
, 
Ën
;

121 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_BOOLEAN
 ) ) != 0 )

122 Ğ
»t
 );

124 ifĞ
Ën
 != 1 )

125 Ğ
POLARSSL_ERR_ASN1_INVALID_LENGTH
 );

127 *
v®
 = ( **
p
 != 0 ) ? 1 : 0;

128 (*
p
)++;

131 
	}
}

133 
	$a¢1_g‘_št
Ğ**
p
,

134 cÚ¡ *
’d
,

135 *
v®
 )

137 
»t
, 
Ën
;

139 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_INTEGER
 ) ) != 0 )

140 Ğ
»t
 );

142 ifĞ
Ën
 > (èĞè|| ( **
p
 & 0x80 ) != 0 )

143 Ğ
POLARSSL_ERR_ASN1_INVALID_LENGTH
 );

145 *
v®
 = 0;

147  
Ën
-- > 0 )

149 *
v®
 = ( *v® << 8 ) | **
p
;

150 (*
p
)++;

154 
	}
}

156 
	$a¢1_g‘_mpi
Ğ**
p
,

157 cÚ¡ *
’d
,

158 
mpi
 *
X
 )

160 
»t
, 
Ën
;

162 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_INTEGER
 ) ) != 0 )

163 Ğ
»t
 );

165 
»t
 = 
	`mpi_»ad_bš¬y
Ğ
X
, *
p
, 
Ën
 );

167 *
p
 +ğ
Ën
;

169 Ğ
»t
 );

170 
	}
}

175 
	$x509_g‘_v”siÚ
Ğ**
p
,

176 cÚ¡ *
’d
,

177 *
v”
 )

179 
»t
, 
Ën
;

181 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

182 
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_CONSTRUCTED
 | 0 ) ) != 0 )

184 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

185 Ğ*
v”
 = 0 );

187 Ğ
»t
 );

190 
’d
 = *
p
 + 
Ën
;

192 ifĞĞ
»t
 = 
	`a¢1_g‘_št
Ğ
p
, 
’d
, 
v”
 ) ) != 0 )

193 Ğ
POLARSSL_ERR_X509_CERT_INVALID_VERSION
 | 
»t
 );

195 ifĞ*
p
 !ğ
’d
 )

196 Ğ
POLARSSL_ERR_X509_CERT_INVALID_VERSION
 |

197 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

200 
	}
}

205 
	$x509_g‘_£rŸl
Ğ**
p
,

206 cÚ¡ *
’d
,

207 
x509_buf
 *
£rŸl
 )

209 
»t
;

211 ifĞĞ
’d
 - *
p
 ) < 1 )

212 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 |

213 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

215 ifĞ**
p
 !ğĞ
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_PRIMITIVE
 | 2 ) &&

216 **
p
 !ğ
ASN1_INTEGER
 )

217 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 |

218 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

220 
£rŸl
->
g
 = *(*
p
)++;

222 ifĞĞ
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
£rŸl
->
Ën
 ) ) != 0 )

223 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SERIAL
 | 
»t
 );

225 
£rŸl
->
p
 = *p;

226 *
p
 +ğ
£rŸl
->
Ën
;

229 
	}
}

236 
	$x509_g‘_®g
Ğ**
p
,

237 cÚ¡ *
’d
,

238 
x509_buf
 *
®g
 )

240 
»t
, 
Ën
;

242 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

243 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

244 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 | 
»t
 );

246 
’d
 = *
p
 + 
Ën
;

247 
®g
->
g
 = **
p
;

249 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
®g
->
Ën
, 
ASN1_OID
 ) ) != 0 )

250 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 | 
»t
 );

252 
®g
->
p
 = *p;

253 *
p
 +ğ
®g
->
Ën
;

255 ifĞ*
p
 =ğ
’d
 )

261 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_NULL
 ) ) != 0 )

262 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 | 
»t
 );

264 ifĞ*
p
 !ğ
’d
 )

265 Ğ
POLARSSL_ERR_X509_CERT_INVALID_ALG
 |

266 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

269 
	}
}

280 
	$x509_g‘_©Œ_ty³_v®ue
Ğ**
p
,

281 cÚ¡ *
’d
,

282 
x509_Çme
 *
cur
 )

284 
»t
, 
Ën
;

285 
x509_buf
 *
oid
;

286 
x509_buf
 *
v®
;

288 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

289 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

290 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

292 
oid
 = &
cur
->oid;

293 
oid
->
g
 = **
p
;

295 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
oid
->
Ën
, 
ASN1_OID
 ) ) != 0 )

296 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

298 
oid
->
p
 = *p;

299 *
p
 +ğ
oid
->
Ën
;

301 ifĞĞ
’d
 - *
p
 ) < 1 )

302 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 |

303 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

305 ifĞ**
p
 !ğ
ASN1_BMP_STRING
 && **°!ğ
ASN1_UTF8_STRING
 &&

306 **
p
 !ğ
ASN1_T61_STRING
 && **°!ğ
ASN1_PRINTABLE_STRING
 &&

307 **
p
 !ğ
ASN1_IA5_STRING
 && **°!ğ
ASN1_UNIVERSAL_STRING
 )

308 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 |

309 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

311 
v®
 = &
cur
->val;

312 
v®
->
g
 = *(*
p
)++;

314 ifĞĞ
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
v®
->
Ën
 ) ) != 0 )

315 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

317 
v®
->
p
 = *p;

318 *
p
 +ğ
v®
->
Ën
;

320 
cur
->
Ãxt
 = 
NULL
;

323 
	}
}

337 
	$x509_g‘_Çme
Ğ**
p
,

338 cÚ¡ *
’d
,

339 
x509_Çme
 *
cur
 )

341 
»t
, 
Ën
;

342 cÚ¡ *
’d2
;

343 
x509_Çme
 *
u£
;

345 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

346 
ASN1_CONSTRUCTED
 | 
ASN1_SET
 ) ) != 0 )

347 Ğ
POLARSSL_ERR_X509_CERT_INVALID_NAME
 | 
»t
 );

349 
’d2
 = 
’d
;

350 
’d
 = *
p
 + 
Ën
;

351 
u£
 = 
cur
;

355 ifĞĞ
»t
 = 
	`x509_g‘_©Œ_ty³_v®ue
Ğ
p
, 
’d
, 
u£
 ) ) != 0 )

356 Ğ
»t
 );

358 ifĞ*
p
 !ğ
’d
 )

360 
u£
->
Ãxt
 = (
x509_Çme
 *è
	`m®loc
(

361 Ğ
x509_Çme
 ) );

363 ifĞ
u£
->
Ãxt
 =ğ
NULL
 )

366 
	`mem£t
Ğ
u£
->
Ãxt
, 0, Ğ
x509_Çme
 ) );

368 
u£
 = u£->
Ãxt
;

371  *
p
 !ğ
’d
 );

376 ifĞ*
p
 =ğ
’d2
 )

379 
cur
->
Ãxt
 = (
x509_Çme
 *è
	`m®loc
(

380 Ğ
x509_Çme
 ) );

382 ifĞ
cur
->
Ãxt
 =ğ
NULL
 )

385 Ğ
	`x509_g‘_Çme
Ğ
p
, 
’d2
, 
cur
->
Ãxt
 ) );

386 
	}
}

393 
	$x509_g‘_time
Ğ**
p
,

394 cÚ¡ *
’d
,

395 
x509_time
 *
time
 )

397 
»t
, 
Ën
;

398 
d©e
[64];

399 
g
;

401 ifĞĞ
’d
 - *
p
 ) < 1 )

402 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

404 
g
 = **
p
;

406 iàĞ
g
 =ğ
ASN1_UTC_TIME
 )

408 (*
p
)++;

409 
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
Ën
 );

411 ifĞ
»t
 != 0 )

412 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
»t
 );

414 
	`mem£t
Ğ
d©e
, 0, ( date ) );

415 
	`memıy
Ğ
d©e
, *
p
, ( 
Ën
 < () ( date ) - 1 ) ?

416 
Ën
 : (èĞ
d©e
 ) - 1 );

418 ifĞ
	`ssÿnf
Ğ
d©e
, "%2d%2d%2d%2d%2d%2d",

419 &
time
->
y—r
, &time->
mÚ
, &time->
day
,

420 &
time
->
hour
, &time->
mš
, &time->
£c
 ) < 5 )

421 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 );

423 
time
->
y—r
 += 100 * (ime->year < 50 );

424 
time
->
y—r
 += 1900;

426 *
p
 +ğ
Ën
;

430 iàĞ
g
 =ğ
ASN1_GENERALIZED_TIME
 )

432 (*
p
)++;

433 
»t
 = 
	`a¢1_g‘_Ën
Ğ
p
, 
’d
, &
Ën
 );

435 ifĞ
»t
 != 0 )

436 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
»t
 );

438 
	`mem£t
Ğ
d©e
, 0, ( date ) );

439 
	`memıy
Ğ
d©e
, *
p
, ( 
Ën
 < () ( date ) - 1 ) ?

440 
Ën
 : (èĞ
d©e
 ) - 1 );

442 ifĞ
	`ssÿnf
Ğ
d©e
, "%4d%2d%2d%2d%2d%2d",

443 &
time
->
y—r
, &time->
mÚ
, &time->
day
,

444 &
time
->
hour
, &time->
mš
, &time->
£c
 ) < 5 )

445 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 );

447 *
p
 +ğ
Ën
;

452 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 );

453 
	}
}

461 
	$x509_g‘_d©es
Ğ**
p
,

462 cÚ¡ *
’d
,

463 
x509_time
 *
äom
,

464 
x509_time
 *
to
 )

466 
»t
, 
Ën
;

468 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

469 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

470 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 | 
»t
 );

472 
’d
 = *
p
 + 
Ën
;

474 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ
p
, 
’d
, 
äom
 ) ) != 0 )

475 Ğ
»t
 );

477 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ
p
, 
’d
, 
to
 ) ) != 0 )

478 Ğ
»t
 );

480 ifĞ*
p
 !ğ
’d
 )

481 Ğ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 |

482 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

485 
	}
}

492 
	$x509_g‘_pubkey
Ğ**
p
,

493 cÚ¡ *
’d
,

494 
x509_buf
 *
pk_®g_oid
,

495 
mpi
 *
N
, mp˜*
E
 )

497 
»t
, 
Ën
, 
ÿn_hªdË
;

498 *
’d2
;

500 ifĞĞ
»t
 = 
	`x509_g‘_®g
Ğ
p
, 
’d
, 
pk_®g_oid
 ) ) != 0 )

501 Ğ
»t
 );

506 
ÿn_hªdË
 = 0;

508 ifĞ
pk_®g_oid
->
Ën
 == 9 &&

509 
	`memcmp
Ğ
pk_®g_oid
->
p
, 
OID_PKCS1_RSA
, 9 ) == 0 )

510 
ÿn_hªdË
 = 1;

512 ifĞ
pk_®g_oid
->
Ën
 == 9 &&

513 
	`memcmp
Ğ
pk_®g_oid
->
p
, 
OID_PKCS1
, 8 ) == 0 )

515 ifĞ
pk_®g_oid
->
p
[8] >= 2 &&…k_alg_oid->p[8] <= 5 )

516 
ÿn_hªdË
 = 1;

518 iàĞ
pk_®g_oid
->
p
[8] >= 11 &&…k_alg_oid->p[8] <= 14 )

519 
ÿn_hªdË
 = 1;

522 ifĞ
pk_®g_oid
->
Ën
 == 5 &&

523 
	`memcmp
Ğ
pk_®g_oid
->
p
, 
OID_RSA_SHA_OBS
, 5 ) == 0 )

524 
ÿn_hªdË
 = 1;

526 ifĞ
ÿn_hªdË
 == 0 )

527 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_PK_ALG
 );

529 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_BIT_STRING
 ) ) != 0 )

530 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 | 
»t
 );

532 ifĞĞ
’d
 - *
p
 ) < 1 )

533 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 |

534 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 );

536 
’d2
 = *
p
 + 
Ën
;

538 ifĞ*(*
p
)++ != 0 )

539 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 );

547 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d2
, &
Ën
,

548 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

549 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 | 
»t
 );

551 ifĞ*
p
 + 
Ën
 !ğ
’d2
 )

552 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 |

553 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

555 ifĞĞ
»t
 = 
	`a¢1_g‘_mpi
Ğ
p
, 
’d2
, 
N
 ) ) != 0 ||

556 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ
p
, 
’d2
, 
E
 ) ) != 0 )

557 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 | 
»t
 );

559 ifĞ*
p
 !ğ
’d
 )

560 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PUBKEY
 |

561 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

564 
	}
}

566 
	$x509_g‘_sig
Ğ**
p
,

567 cÚ¡ *
’d
,

568 
x509_buf
 *
sig
 )

570 
»t
, 
Ën
;

572 
sig
->
g
 = **
p
;

574 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
, 
ASN1_BIT_STRING
 ) ) != 0 )

575 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SIGNATURE
 | 
»t
 );

577 ifĞ--
Ën
 < 1 || *(*
p
)++ != 0 )

578 Ğ
POLARSSL_ERR_X509_CERT_INVALID_SIGNATURE
 );

580 
sig
->
Ën
 =†en;

581 
sig
->
p
 = *p;

583 *
p
 +ğ
Ën
;

586 
	}
}

591 
	$x509_g‘_uid
Ğ**
p
,

592 cÚ¡ *
’d
,

593 
x509_buf
 *
uid
, 
n
 )

595 
»t
;

597 ifĞ*
p
 =ğ
’d
 )

600 
uid
->
g
 = **
p
;

602 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
uid
->
Ën
,

603 
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_CONSTRUCTED
 | 
n
 ) ) != 0 )

605 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

608 Ğ
»t
 );

611 
uid
->
p
 = *p;

612 *
p
 +ğ
uid
->
Ën
;

615 
	}
}

621 
	$x509_g‘_ext
Ğ**
p
,

622 cÚ¡ *
’d
,

623 
x509_buf
 *
ext
 )

625 
»t
, 
Ën
;

627 ifĞ*
p
 =ğ
’d
 )

630 
ext
->
g
 = **
p
;

632 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
ext
->
Ën
,

633 
ASN1_CONTEXT_SPECIFIC
 | 
ASN1_CONSTRUCTED
 | 3 ) ) != 0 )

634 Ğ
»t
 );

636 
ext
->
p
 = *p;

637 
’d
 = *
p
 + 
ext
->
Ën
;

647 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

648 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

649 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

651 ifĞ
’d
 !ğ*
p
 + 
Ën
 )

652 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

653 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

656 
	}
}

661 
	$x509_g‘_ül_ext
Ğ**
p
,

662 cÚ¡ *
’d
,

663 
x509_buf
 *
ext
 )

665 
»t
, 
Ën
;

667 ifĞĞ
»t
 = 
	`x509_g‘_ext
Ğ
p
, 
’d
, 
ext
 ) ) != 0 )

669 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

672 Ğ
»t
 );

675  *
p
 < 
’d
 )

677 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

678 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

679 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

681 *
p
 +ğ
Ën
;

684 ifĞ*
p
 !ğ
’d
 )

685 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

686 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

689 
	}
}

694 
	$x509_g‘_üt_ext
Ğ**
p
,

695 cÚ¡ *
’d
,

696 
x509_buf
 *
ext
,

697 *
ÿ_i¡rue
,

698 *
max_·thËn
 )

700 
»t
, 
Ën
;

701 
is_ü™iÿl
 = 1;

702 
is_ÿû¹
 = 0;

703 *
’d_ext_d©a
, *
’d_ext_où‘
;

705 ifĞĞ
»t
 = 
	`x509_g‘_ext
Ğ
p
, 
’d
, 
ext
 ) ) != 0 )

707 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

710 Ğ
»t
 );

713  *
p
 < 
’d
 )

715 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën
,

716 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

717 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

719 
’d_ext_d©a
 = *
p
 + 
Ën
;

721 ifĞ
	`memcmp
Ğ*
p
, "\x06\x03\x55\x1D\x13", 5 ) != 0 )

723 *
p
 +ğ
Ën
;

727 *
p
 += 5;

729 ifĞĞ
»t
 = 
	`a¢1_g‘_boŞ
Ğ
p
, 
’d_ext_d©a
, &
is_ü™iÿl
 ) ) != 0 &&

730 Ğ
»t
 !ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 ) )

731 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

733 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d_ext_d©a
, &
Ën
,

734 
ASN1_OCTET_STRING
 ) ) != 0 )

735 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

742 
’d_ext_où‘
 = *
p
 + 
Ën
;

744 ifĞ
’d_ext_où‘
 !ğ
’d_ext_d©a
 )

745 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

746 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

748 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d_ext_où‘
, &
Ën
,

749 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

750 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

752 ifĞ*
p
 =ğ
’d_ext_où‘
 )

755 ifĞĞ
»t
 = 
	`a¢1_g‘_boŞ
Ğ
p
, 
’d_ext_où‘
, &
is_ÿû¹
 ) ) != 0 )

757 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

758 
»t
 = 
	`a¢1_g‘_št
Ğ
p
, 
’d_ext_où‘
, &
is_ÿû¹
 );

760 ifĞ
»t
 != 0 )

761 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

763 ifĞ
is_ÿû¹
 != 0 )

764 
is_ÿû¹
 = 1;

767 ifĞ*
p
 =ğ
’d_ext_où‘
 )

770 ifĞĞ
»t
 = 
	`a¢1_g‘_št
Ğ
p
, 
’d_ext_où‘
, 
max_·thËn
 ) ) != 0 )

771 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 | 
»t
 );

773 ifĞ*
p
 !ğ
’d_ext_où‘
 )

774 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

775 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

777 
max_·thËn
++;

780 ifĞ*
p
 !ğ
’d
 )

781 Ğ
POLARSSL_ERR_X509_CERT_INVALID_EXTENSIONS
 |

782 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

784 *
ÿ_i¡rue
 = 
is_ü™iÿl
 & 
is_ÿû¹
;

787 
	}
}

792 
	$x509_g‘_’Œ›s
Ğ**
p
,

793 cÚ¡ *
’d
,

794 
x509_ül_’Œy
 *
’Œy
 )

796 
»t
, 
’Œy_Ën
;

797 
x509_ül_’Œy
 *
cur_’Œy
 = 
’Œy
;

799 ifĞ*
p
 =ğ
’d
 )

802 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
’Œy_Ën
,

803 
ASN1_SEQUENCE
 | 
ASN1_CONSTRUCTED
 ) ) != 0 )

805 ifĞ
»t
 =ğ
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 )

808 Ğ
»t
 );

811 
’d
 = *
p
 + 
’Œy_Ën
;

813  *
p
 < 
’d
 )

815 
Ën2
;

817 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ
p
, 
’d
, &
Ën2
,

818 
ASN1_SEQUENCE
 | 
ASN1_CONSTRUCTED
 ) ) != 0 )

820 Ğ
»t
 );

823 
cur_’Œy
->
¿w
.
g
 = **
p
;

824 
cur_’Œy
->
¿w
.
p
 = *p;

825 
cur_’Œy
->
¿w
.
Ën
 = 
Ën2
;

827 ifĞĞ
»t
 = 
	`x509_g‘_£rŸl
Ğ
p
, 
’d
, &
cur_’Œy
->
£rŸl
 ) ) != 0 )

828 Ğ
»t
 );

830 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ
p
, 
’d
, &
cur_’Œy
->
»voÿtiÚ_d©e
 ) ) != 0 )

831 Ğ
»t
 );

833 ifĞĞ
»t
 = 
	`x509_g‘_ül_ext
Ğ
p
, 
’d
, &
cur_’Œy
->
’Œy_ext
 ) ) != 0 )

834 Ğ
»t
 );

836 iàĞ*
p
 < 
’d
 ) {

837 
cur_’Œy
->
Ãxt
 = 
	`m®loc
ĞĞ
x509_ül_’Œy
 ) );

838 
cur_’Œy
 = cur_’Œy->
Ãxt
;

839 
	`mem£t
Ğ
cur_’Œy
, 0, Ğ
x509_ül_’Œy
 ) );

844 
	}
}

846 
	$x509_g‘_sig_®g
ĞcÚ¡ 
x509_buf
 *
sig_oid
, *
sig_®g
 )

848 ifĞ
sig_oid
->
Ën
 == 9 &&

849 
	`memcmp
Ğ
sig_oid
->
p
, 
OID_PKCS1
, 8 ) == 0 )

851 ifĞ
sig_oid
->
p
[8] >= 2 && sig_oid->p[8] <= 5 )

853 *
sig_®g
 = 
sig_oid
->
p
[8];

857 iàĞ
sig_oid
->
p
[8] >= 11 && sig_oid->p[8] <= 14 )

859 *
sig_®g
 = 
sig_oid
->
p
[8];

863 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 );

865 ifĞ
sig_oid
->
Ën
 == 5 &&

866 
	`memcmp
Ğ
sig_oid
->
p
, 
OID_RSA_SHA_OBS
, 5 ) == 0 )

868 *
sig_®g
 = 
SIG_RSA_SHA1
;

872 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 );

873 
	}
}

878 
	$x509·r£_üt
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 )

880 
»t
, 
Ën
;

881 cÚ¡ *
s1
, *
s2
;

882 *
p
, *
’d
;

883 
x509_û¹
 *
üt
;

885 
üt
 = 
chaš
;

890 ifĞ
üt
 =ğ
NULL
 || 
buf
 == NULL )

893  
üt
->
v”siÚ
 !ğ0 && c¹->
Ãxt
 !ğ
NULL
 )

894 
üt
 = c¹->
Ãxt
;

899 iàĞ
üt
->
v”siÚ
 !ğ0 && c¹->
Ãxt
 =ğ
NULL
)

901 
üt
->
Ãxt
 = (
x509_û¹
 *è
	`m®loc
( ( x509_cert ) );

903 ifĞ
üt
->
Ãxt
 =ğ
NULL
 )

905 
	`x509_ä“
Ğ
üt
 );

909 
üt
 = c¹->
Ãxt
;

910 
	`mem£t
Ğ
üt
, 0, Ğ
x509_û¹
 ) );

916 
s1
 = (*è
	`¡r¡r
Ğ(*è
buf
,

919 ifĞ
s1
 !ğ
NULL
 )

921 
s2
 = (*è
	`¡r¡r
Ğ(*è
buf
,

924 ifĞ
s2
 =ğ
NULL
 || s2 <ğ
s1
 )

925 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

927 
s1
 += 27;

928 ifĞ*
s1
 == '\r' ) s1++;

929 ifĞ*
s1
 == '\n' ) s1++;

930 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

935 
Ën
 = 0;

936 
»t
 = 
	`ba£64_decode
Ğ
NULL
, &
Ën
, 
s1
, 
s2
 - s1 );

938 ifĞ
»t
 =ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 )

939 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

941 ifĞĞ
p
 = (*è
	`m®loc
Ğ
Ën
 ) ) =ğ
NULL
 )

944 ifĞĞ
»t
 = 
	`ba£64_decode
Ğ
p
, &
Ën
, 
s1
, 
s2
 - s1 ) ) != 0 )

946 
	`ä“
Ğ
p
 );

947 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

953 
s2
 += 25;

954 ifĞ*
s2
 == '\r' ) s2++;

955 ifĞ*
s2
 == '\n' ) s2++;

958 
	`ä“
Ğ
p
 );

959 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

962 
buæ’
 -ğ
s2
 - 
buf
;

963 
buf
 = 
s2
;

970 
p
 = (*è
	`m®loc
Ğ
Ën
 = 
buæ’
 );

972 ifĞ
p
 =ğ
NULL
 )

975 
	`memıy
Ğ
p
, 
buf
, 
buæ’
 );

977 
buæ’
 = 0;

980 
üt
->
¿w
.
p
 =…;

981 
üt
->
¿w
.
Ën
 =†en;

982 
’d
 = 
p
 + 
Ën
;

990 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

991 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

993 
	`x509_ä“
Ğ
üt
 );

994 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 );

997 ifĞ
Ën
 !ğ(èĞ
’d
 - 
p
 ) )

999 
	`x509_ä“
Ğ
üt
 );

1000 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1001 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1007 
üt
->
tbs
.
p
 =…;

1009 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1010 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1012 
	`x509_ä“
Ğ
üt
 );

1013 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1016 
’d
 = 
p
 + 
Ën
;

1017 
üt
->
tbs
.
Ën
 = 
’d
 - c¹->tbs.
p
;

1026 ifĞĞ
»t
 = 
	`x509_g‘_v”siÚ
Ğ&
p
, 
’d
, &
üt
->
v”siÚ
 ) ) != 0 ||

1027 Ğ
»t
 = 
	`x509_g‘_£rŸl
Ğ&
p
, 
’d
, &
üt
->
£rŸl
 ) ) != 0 ||

1028 Ğ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
üt
->
sig_oid1
 ) ) != 0 )

1030 
	`x509_ä“
Ğ
üt
 );

1031 Ğ
»t
 );

1034 
üt
->
v”siÚ
++;

1036 ifĞ
üt
->
v”siÚ
 > 3 )

1038 
	`x509_ä“
Ğ
üt
 );

1039 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_VERSION
 );

1042 ifĞĞ
»t
 = 
	`x509_g‘_sig_®g
Ğ&
üt
->
sig_oid1
, &üt->
sig_®g
 ) ) != 0 )

1044 
	`x509_ä“
Ğ
üt
 );

1045 Ğ
»t
 );

1051 
üt
->
issu”_¿w
.
p
 =…;

1053 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1054 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1056 
	`x509_ä“
Ğ
üt
 );

1057 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1060 ifĞĞ
»t
 = 
	`x509_g‘_Çme
Ğ&
p
,… + 
Ën
, &
üt
->
issu”
 ) ) != 0 )

1062 
	`x509_ä“
Ğ
üt
 );

1063 Ğ
»t
 );

1066 
üt
->
issu”_¿w
.
Ën
 = 
p
 - crt->issuer_raw.p;

1074 ifĞĞ
»t
 = 
	`x509_g‘_d©es
Ğ&
p
, 
’d
, &
üt
->
v®id_äom
,

1075 &
üt
->
v®id_to
 ) ) != 0 )

1077 
	`x509_ä“
Ğ
üt
 );

1078 Ğ
»t
 );

1084 
üt
->
subjeù_¿w
.
p
 =…;

1086 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1087 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1089 
	`x509_ä“
Ğ
üt
 );

1090 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1093 ifĞĞ
»t
 = 
	`x509_g‘_Çme
Ğ&
p
,… + 
Ën
, &
üt
->
subjeù
 ) ) != 0 )

1095 
	`x509_ä“
Ğ
üt
 );

1096 Ğ
»t
 );

1099 
üt
->
subjeù_¿w
.
Ën
 = 
p
 - crt->subject_raw.p;

1106 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1107 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1109 
	`x509_ä“
Ğ
üt
 );

1110 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1113 ifĞĞ
»t
 = 
	`x509_g‘_pubkey
Ğ&
p
,… + 
Ën
, &
üt
->
pk_oid
,

1114 &
üt
->
r§
.
N
, &üt->r§.
E
 ) ) != 0 )

1116 
	`x509_ä“
Ğ
üt
 );

1117 Ğ
»t
 );

1120 ifĞĞ
»t
 = 
	`r§_check_pubkey
Ğ&
üt
->
r§
 ) ) != 0 )

1122 
	`x509_ä“
Ğ
üt
 );

1123 Ğ
»t
 );

1126 
üt
->
r§
.
Ën
 = 
	`mpi_size
Ğ&üt->r§.
N
 );

1136 ifĞ
üt
->
v”siÚ
 == 2 || crt->version == 3 )

1138 
»t
 = 
	`x509_g‘_uid
Ğ&
p
, 
’d
, &
üt
->
issu”_id
, 1 );

1139 ifĞ
»t
 != 0 )

1141 
	`x509_ä“
Ğ
üt
 );

1142 Ğ
»t
 );

1146 ifĞ
üt
->
v”siÚ
 == 2 || crt->version == 3 )

1148 
»t
 = 
	`x509_g‘_uid
Ğ&
p
, 
’d
, &
üt
->
subjeù_id
, 2 );

1149 ifĞ
»t
 != 0 )

1151 
	`x509_ä“
Ğ
üt
 );

1152 Ğ
»t
 );

1156 ifĞ
üt
->
v”siÚ
 == 3 )

1158 
»t
 = 
	`x509_g‘_üt_ext
Ğ&
p
, 
’d
, &
üt
->
v3_ext
,

1159 &
üt
->
ÿ_i¡rue
, &üt->
max_·thËn
 );

1160 ifĞ
»t
 != 0 )

1162 
	`x509_ä“
Ğ
üt
 );

1163 Ğ
»t
 );

1167 ifĞ
p
 !ğ
’d
 )

1169 
	`x509_ä“
Ğ
üt
 );

1170 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1171 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1174 
’d
 = 
üt
->
¿w
.
p
 + c¹->¿w.
Ën
;

1180 ifĞĞ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
üt
->
sig_oid2
 ) ) != 0 )

1182 
	`x509_ä“
Ğ
üt
 );

1183 Ğ
»t
 );

1186 ifĞ
	`memcmp
Ğ
üt
->
sig_oid1
.
p
, c¹->
sig_oid2
.p, c¹->sig_oid1.
Ën
 ) != 0 )

1188 
	`x509_ä“
Ğ
üt
 );

1189 Ğ
POLARSSL_ERR_X509_CERT_SIG_MISMATCH
 );

1192 ifĞĞ
»t
 = 
	`x509_g‘_sig
Ğ&
p
, 
’d
, &
üt
->
sig
 ) ) != 0 )

1194 
	`x509_ä“
Ğ
üt
 );

1195 Ğ
»t
 );

1198 ifĞ
p
 !ğ
’d
 )

1200 
	`x509_ä“
Ğ
üt
 );

1201 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1202 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1205 ifĞ
buæ’
 > 0 )

1207 
üt
->
Ãxt
 = (
x509_û¹
 *è
	`m®loc
( ( x509_cert ) );

1209 ifĞ
üt
->
Ãxt
 =ğ
NULL
 )

1211 
	`x509_ä“
Ğ
üt
 );

1215 
üt
 = c¹->
Ãxt
;

1216 
	`mem£t
Ğ
üt
, 0, Ğ
x509_û¹
 ) );

1218 Ğ
	`x509·r£_üt
Ğ
üt
, 
buf
, 
buæ’
 ) );

1222 
	}
}

1227 
	$x509·r£_ül
Ğ
x509_ül
 *
chaš
, cÚ¡ *
buf
, 
buæ’
 )

1229 
»t
, 
Ën
;

1230 *
s1
, *
s2
;

1231 *
p
, *
’d
;

1232 
x509_ül
 *
ül
;

1234 
ül
 = 
chaš
;

1239 ifĞ
ül
 =ğ
NULL
 || 
buf
 == NULL )

1242  
ül
->
v”siÚ
 !ğ0 && c¾->
Ãxt
 !ğ
NULL
 )

1243 
ül
 = c¾->
Ãxt
;

1248 iàĞ
ül
->
v”siÚ
 !ğ0 && c¾->
Ãxt
 =ğ
NULL
)

1250 
ül
->
Ãxt
 = (
x509_ül
 *è
	`m®loc
( ( x509_crl ) );

1252 ifĞ
ül
->
Ãxt
 =ğ
NULL
 )

1254 
	`x509_ül_ä“
Ğ
ül
 );

1258 
ül
 = c¾->
Ãxt
;

1259 
	`mem£t
Ğ
ül
, 0, Ğ
x509_ül
 ) );

1265 
s1
 = (*è
	`¡r¡r
Ğ(*è
buf
,

1268 ifĞ
s1
 !ğ
NULL
 )

1270 
s2
 = (*è
	`¡r¡r
Ğ(*è
buf
,

1273 ifĞ
s2
 =ğ
NULL
 || s2 <ğ
s1
 )

1274 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

1276 
s1
 += 24;

1277 ifĞ*
s1
 == '\r' ) s1++;

1278 ifĞ*
s1
 == '\n' ) s1++;

1279 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

1284 
Ën
 = 0;

1285 
»t
 = 
	`ba£64_decode
Ğ
NULL
, &
Ën
, 
s1
, 
s2
 - s1 );

1287 ifĞ
»t
 =ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 )

1288 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

1290 ifĞĞ
p
 = (*è
	`m®loc
Ğ
Ën
 ) ) =ğ
NULL
 )

1293 ifĞĞ
»t
 = 
	`ba£64_decode
Ğ
p
, &
Ën
, 
s1
, 
s2
 - s1 ) ) != 0 )

1295 
	`ä“
Ğ
p
 );

1296 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 | 
»t
 );

1302 
s2
 += 22;

1303 ifĞ*
s2
 == '\r' ) s2++;

1304 ifĞ*
s2
 == '\n' ) s2++;

1307 
	`ä“
Ğ
p
 );

1308 Ğ
POLARSSL_ERR_X509_CERT_INVALID_PEM
 );

1311 
buæ’
 -ğ
s2
 - 
buf
;

1312 
buf
 = 
s2
;

1319 
p
 = (*è
	`m®loc
Ğ
Ën
 = 
buæ’
 );

1321 ifĞ
p
 =ğ
NULL
 )

1324 
	`memıy
Ğ
p
, 
buf
, 
buæ’
 );

1326 
buæ’
 = 0;

1329 
ül
->
¿w
.
p
 =…;

1330 
ül
->
¿w
.
Ën
 =†en;

1331 
’d
 = 
p
 + 
Ën
;

1339 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1340 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1342 
	`x509_ül_ä“
Ğ
ül
 );

1343 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 );

1346 ifĞ
Ën
 !ğ(èĞ
’d
 - 
p
 ) )

1348 
	`x509_ül_ä“
Ğ
ül
 );

1349 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1350 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1356 
ül
->
tbs
.
p
 =…;

1358 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1359 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1361 
	`x509_ül_ä“
Ğ
ül
 );

1362 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1365 
’d
 = 
p
 + 
Ën
;

1366 
ül
->
tbs
.
Ën
 = 
’d
 - c¾->tbs.
p
;

1374 ifĞĞ
»t
 = 
	`x509_g‘_v”siÚ
Ğ&
p
, 
’d
, &
ül
->
v”siÚ
 ) ) != 0 ||

1375 Ğ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
ül
->
sig_oid1
 ) ) != 0 )

1377 
	`x509_ül_ä“
Ğ
ül
 );

1378 Ğ
»t
 );

1381 
ül
->
v”siÚ
++;

1383 ifĞ
ül
->
v”siÚ
 > 2 )

1385 
	`x509_ül_ä“
Ğ
ül
 );

1386 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_VERSION
 );

1389 ifĞĞ
»t
 = 
	`x509_g‘_sig_®g
Ğ&
ül
->
sig_oid1
, &ül->
sig_®g
 ) ) != 0 )

1391 
	`x509_ül_ä“
Ğ
ül
 );

1392 Ğ
POLARSSL_ERR_X509_CERT_UNKNOWN_SIG_ALG
 );

1398 
ül
->
issu”_¿w
.
p
 =…;

1400 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1401 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1403 
	`x509_ül_ä“
Ğ
ül
 );

1404 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 | 
»t
 );

1407 ifĞĞ
»t
 = 
	`x509_g‘_Çme
Ğ&
p
,… + 
Ën
, &
ül
->
issu”
 ) ) != 0 )

1409 
	`x509_ül_ä“
Ğ
ül
 );

1410 Ğ
»t
 );

1413 
ül
->
issu”_¿w
.
Ën
 = 
p
 - crl->issuer_raw.p;

1419 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ&
p
, 
’d
, &
ül
->
this_upd©e
 ) ) != 0 )

1421 
	`x509_ül_ä“
Ğ
ül
 );

1422 Ğ
»t
 );

1425 ifĞĞ
»t
 = 
	`x509_g‘_time
Ğ&
p
, 
’d
, &
ül
->
Ãxt_upd©e
 ) ) != 0 )

1427 iàĞ
»t
 !ğĞ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 |

1428 
POLARSSL_ERR_ASN1_UNEXPECTED_TAG
 ) &&

1429 
»t
 !ğĞ
POLARSSL_ERR_X509_CERT_INVALID_DATE
 |

1430 
POLARSSL_ERR_ASN1_OUT_OF_DATA
 ) )

1432 
	`x509_ül_ä“
Ğ
ül
 );

1433 Ğ
»t
 );

1445 ifĞĞ
»t
 = 
	`x509_g‘_’Œ›s
Ğ&
p
, 
’d
, &
ül
->
’Œy
 ) ) != 0 )

1447 
	`x509_ül_ä“
Ğ
ül
 );

1448 Ğ
»t
 );

1455 ifĞ
ül
->
v”siÚ
 == 2 )

1457 
»t
 = 
	`x509_g‘_ül_ext
Ğ&
p
, 
’d
, &
ül
->
ül_ext
 );

1459 ifĞ
»t
 != 0 )

1461 
	`x509_ül_ä“
Ğ
ül
 );

1462 Ğ
»t
 );

1466 ifĞ
p
 !ğ
’d
 )

1468 
	`x509_ül_ä“
Ğ
ül
 );

1469 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1470 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1473 
’d
 = 
ül
->
¿w
.
p
 + c¾->¿w.
Ën
;

1479 ifĞĞ
»t
 = 
	`x509_g‘_®g
Ğ&
p
, 
’d
, &
ül
->
sig_oid2
 ) ) != 0 )

1481 
	`x509_ül_ä“
Ğ
ül
 );

1482 Ğ
»t
 );

1485 ifĞ
	`memcmp
Ğ
ül
->
sig_oid1
.
p
, c¾->
sig_oid2
.p, c¾->sig_oid1.
Ën
 ) != 0 )

1487 
	`x509_ül_ä“
Ğ
ül
 );

1488 Ğ
POLARSSL_ERR_X509_CERT_SIG_MISMATCH
 );

1491 ifĞĞ
»t
 = 
	`x509_g‘_sig
Ğ&
p
, 
’d
, &
ül
->
sig
 ) ) != 0 )

1493 
	`x509_ül_ä“
Ğ
ül
 );

1494 Ğ
»t
 );

1497 ifĞ
p
 !ğ
’d
 )

1499 
	`x509_ül_ä“
Ğ
ül
 );

1500 Ğ
POLARSSL_ERR_X509_CERT_INVALID_FORMAT
 |

1501 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1504 ifĞ
buæ’
 > 0 )

1506 
ül
->
Ãxt
 = (
x509_ül
 *è
	`m®loc
( ( x509_crl ) );

1508 ifĞ
ül
->
Ãxt
 =ğ
NULL
 )

1510 
	`x509_ül_ä“
Ğ
ül
 );

1514 
ül
 = c¾->
Ãxt
;

1515 
	`mem£t
Ğ
ül
, 0, Ğ
x509_ül
 ) );

1517 Ğ
	`x509·r£_ül
Ğ
ül
, 
buf
, 
buæ’
 ) );

1521 
	}
}

1526 
	$lßd_fe
ĞcÚ¡ *
·th
, **
buf
, 
size_t
 *
n
 )

1528 
FILE
 *
f
;

1530 ifĞĞ
f
 = 
	`fİ’
Ğ
·th
, "rb" ) ) =ğ
NULL
 )

1533 
	`f£ek
Ğ
f
, 0, 
SEEK_END
 );

1534 *
n
 = (
size_t
è
	`á–l
Ğ
f
 );

1535 
	`f£ek
Ğ
f
, 0, 
SEEK_SET
 );

1537 ifĞĞ*
buf
 = (*è
	`m®loc
Ğ*
n
 + 1 ) ) =ğ
NULL
 )

1540 ifĞ
	`ä—d
Ğ*
buf
, 1, *
n
, 
f
 ) != *n )

1542 
	`fşo£
Ğ
f
 );

1543 
	`ä“
Ğ*
buf
 );

1547 
	`fşo£
Ğ
f
 );

1549 (*
buf
)[*
n
] = '\0';

1552 
	}
}

1557 
	$x509·r£_ütfe
Ğ
x509_û¹
 *
chaš
, cÚ¡ *
·th
 )

1559 
»t
;

1560 
size_t
 
n
;

1561 *
buf
;

1563 iàĞ
	`lßd_fe
Ğ
·th
, &
buf
, &
n
 ) )

1566 
»t
 = 
	`x509·r£_üt
Ğ
chaš
, 
buf
, (è
n
 );

1568 
	`mem£t
Ğ
buf
, 0, 
n
 + 1 );

1569 
	`ä“
Ğ
buf
 );

1571 Ğ
»t
 );

1572 
	}
}

1577 
	$x509·r£_ülfe
Ğ
x509_ül
 *
chaš
, cÚ¡ *
·th
 )

1579 
»t
;

1580 
size_t
 
n
;

1581 *
buf
;

1583 iàĞ
	`lßd_fe
Ğ
·th
, &
buf
, &
n
 ) )

1586 
»t
 = 
	`x509·r£_ül
Ğ
chaš
, 
buf
, (è
n
 );

1588 
	`mem£t
Ğ
buf
, 0, 
n
 + 1 );

1589 
	`ä“
Ğ
buf
 );

1591 Ğ
»t
 );

1592 
	}
}

1594 #ià
defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1598 
	$x509_g‘_iv
ĞcÚ¡ *
s
, 
iv
[8] )

1600 
i
, 
j
, 
k
;

1602 
	`mem£t
Ğ
iv
, 0, 8 );

1604  
i
 = 0; i < 16; i++, 
s
++ )

1606 ifĞ*
s
 >ğ'0' && * <ğ'9' ) 
j
 = *s - '0'; 

1607 ifĞ*
s
 >ğ'A' && * <ğ'F' ) 
j
 = *s - '7'; 

1608 ifĞ*
s
 >ğ'a' && * <ğ'f' ) 
j
 = *s - 'W'; 

1609 Ğ
POLARSSL_ERR_X509_KEY_INVALID_ENC_IV
 );

1611 
k
 = ( ( 
i
 & 1 ) !ğ0 ) ? 
j
 : j << 4;

1613 
iv
[
i
 >> 1] = ()Ğiv[˜>> 1] | 
k
 );

1617 
	}
}

1622 
	$x509_des3_deüy±
Ğ
des3_iv
[8],

1623 *
buf
, 
buæ’
,

1624 cÚ¡ *
pwd
, 
pwdËn
 )

1626 
md5_cÚ‹xt
 
md5_ùx
;

1627 
des3_cÚ‹xt
 
des3_ùx
;

1628 
md5sum
[16];

1629 
des3_key
[24];

1635 
	`md5_¡¬ts
Ğ&
md5_ùx
 );

1636 
	`md5_upd©e
Ğ&
md5_ùx
, 
pwd
, 
pwdËn
 );

1637 
	`md5_upd©e
Ğ&
md5_ùx
, 
des3_iv
, 8 );

1638 
	`md5_fšish
Ğ&
md5_ùx
, 
md5sum
 );

1639 
	`memıy
Ğ
des3_key
, 
md5sum
, 16 );

1641 
	`md5_¡¬ts
Ğ&
md5_ùx
 );

1642 
	`md5_upd©e
Ğ&
md5_ùx
, 
md5sum
, 16 );

1643 
	`md5_upd©e
Ğ&
md5_ùx
, 
pwd
, 
pwdËn
 );

1644 
	`md5_upd©e
Ğ&
md5_ùx
, 
des3_iv
, 8 );

1645 
	`md5_fšish
Ğ&
md5_ùx
, 
md5sum
 );

1646 
	`memıy
Ğ
des3_key
 + 16, 
md5sum
, 8 );

1648 
	`des3_£t3key_dec
Ğ&
des3_ùx
, 
des3_key
 );

1649 
	`des3_üy±_cbc
Ğ&
des3_ùx
, 
DES_DECRYPT
, 
buæ’
,

1650 
des3_iv
, 
buf
, buf );

1652 
	`mem£t
Ğ&
md5_ùx
, 0, ( md5_ctx ) );

1653 
	`mem£t
Ğ&
des3_ùx
, 0, ( des3_ctx ) );

1654 
	`mem£t
Ğ
md5sum
, 0, 16 );

1655 
	`mem£t
Ğ
des3_key
, 0, 24 );

1656 
	}
}

1662 
	$x509·r£_key
Ğ
r§_cÚ‹xt
 *
r§
, cÚ¡ *
key
, 
keyËn
,

1663 cÚ¡ *
pwd
, 
pwdËn
 )

1665 
»t
, 
Ën
, 
’c
;

1666 *
buf
, *
s1
, *
s2
;

1667 *
p
, *
’d
;

1668 #ià
	`defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1669 
des3_iv
[8];

1671 ((è
pwd
);

1672 ((è
pwdËn
);

1675 
s1
 = (*è
	`¡r¡r
Ğ(*è
key
,

1678 ifĞ
s1
 !ğ
NULL
 )

1680 
s2
 = (*è
	`¡r¡r
Ğ(*è
key
,

1683 ifĞ
s2
 =ğ
NULL
 || s2 <ğ
s1
 )

1684 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1686 
s1
 += 31;

1687 ifĞ*
s1
 == '\r' ) s1++;

1688 ifĞ*
s1
 == '\n' ) s1++;

1689 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1691 
’c
 = 0;

1693 ifĞ
	`memcmp
Ğ
s1
, "Proc-Type: 4,ENCRYPTED", 22 ) == 0 )

1695 #ià
	`defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1696 
’c
++;

1698 
s1
 += 22;

1699 ifĞ*
s1
 == '\r' ) s1++;

1700 ifĞ*
s1
 == '\n' ) s1++;

1701 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1703 ifĞ
	`memcmp
Ğ
s1
, "DEK-Info: DES-EDE3-CBC,", 23 ) != 0 )

1704 Ğ
POLARSSL_ERR_X509_KEY_UNKNOWN_ENC_ALG
 );

1706 
s1
 += 23;

1707 ifĞ
	`x509_g‘_iv
Ğ
s1
, 
des3_iv
 ) != 0 )

1708 Ğ
POLARSSL_ERR_X509_KEY_INVALID_ENC_IV
 );

1710 
s1
 += 16;

1711 ifĞ*
s1
 == '\r' ) s1++;

1712 ifĞ*
s1
 == '\n' ) s1++;

1713 Ğ
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1715 Ğ
POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 );

1719 
Ën
 = 0;

1720 
»t
 = 
	`ba£64_decode
Ğ
NULL
, &
Ën
, 
s1
, 
s2
 - s1 );

1722 ifĞ
»t
 =ğ
POLARSSL_ERR_BASE64_INVALID_CHARACTER
 )

1723 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1725 ifĞĞ
buf
 = (*è
	`m®loc
Ğ
Ën
 ) ) =ğ
NULL
 )

1728 ifĞĞ
»t
 = 
	`ba£64_decode
Ğ
buf
, &
Ën
, 
s1
, 
s2
 - s1 ) ) != 0 )

1730 
	`ä“
Ğ
buf
 );

1731 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_PEM
 );

1734 
keyËn
 = 
Ën
;

1736 ifĞ
’c
 != 0 )

1738 #ià
	`defšed
(
POLARSSL_DES_C
è&& defšed(
POLARSSL_MD5_C
)

1739 ifĞ
pwd
 =ğ
NULL
 )

1741 
	`ä“
Ğ
buf
 );

1742 Ğ
POLARSSL_ERR_X509_KEY_PASSWORD_REQUIRED
 );

1745 
	`x509_des3_deüy±
Ğ
des3_iv
, 
buf
, 
keyËn
, 
pwd
, 
pwdËn
 );

1747 ifĞ
buf
[0] != 0x30 || buf[1] != 0x82 ||

1748 
buf
[4] != 0x02 || buf[5] != 0x01 )

1750 
	`ä“
Ğ
buf
 );

1751 Ğ
POLARSSL_ERR_X509_KEY_PASSWORD_MISMATCH
 );

1754 Ğ
POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 );

1760 
buf
 = 
NULL
;

1763 
	`mem£t
Ğ
r§
, 0, Ğ
r§_cÚ‹xt
 ) );

1765 
p
 = ( 
s1
 !ğ
NULL
 ) ? 
buf
 : (*è
key
;

1766 
’d
 = 
p
 + 
keyËn
;

1782 ifĞĞ
»t
 = 
	`a¢1_g‘_g
Ğ&
p
, 
’d
, &
Ën
,

1783 
ASN1_CONSTRUCTED
 | 
ASN1_SEQUENCE
 ) ) != 0 )

1785 ifĞ
s1
 !ğ
NULL
 )

1786 
	`ä“
Ğ
buf
 );

1788 
	`r§_ä“
Ğ
r§
 );

1789 Ğ
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 | 
»t
 );

1792 
’d
 = 
p
 + 
Ën
;

1794 ifĞĞ
»t
 = 
	`a¢1_g‘_št
Ğ&
p
, 
’d
, &
r§
->
v”
 ) ) != 0 )

1796 ifĞ
s1
 !ğ
NULL
 )

1797 
	`ä“
Ğ
buf
 );

1799 
	`r§_ä“
Ğ
r§
 );

1800 Ğ
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 | 
»t
 );

1803 ifĞ
r§
->
v”
 != 0 )

1805 ifĞ
s1
 !ğ
NULL
 )

1806 
	`ä“
Ğ
buf
 );

1808 
	`r§_ä“
Ğ
r§
 );

1809 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_VERSION
 );

1812 ifĞĞ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
N
 ) ) != 0 ||

1813 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
E
 ) ) != 0 ||

1814 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
D
 ) ) != 0 ||

1815 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
P
 ) ) != 0 ||

1816 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
Q
 ) ) != 0 ||

1817 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
DP
 ) ) != 0 ||

1818 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
DQ
 ) ) != 0 ||

1819 Ğ
»t
 = 
	`a¢1_g‘_mpi
Ğ&
p
, 
’d
, &
r§
->
QP
 ) ) != 0 )

1821 ifĞ
s1
 !ğ
NULL
 )

1822 
	`ä“
Ğ
buf
 );

1824 
	`r§_ä“
Ğ
r§
 );

1825 Ğ
»t
 | 
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 );

1828 
r§
->
Ën
 = 
	`mpi_size
Ğ&r§->
N
 );

1830 ifĞ
p
 !ğ
’d
 )

1832 ifĞ
s1
 !ğ
NULL
 )

1833 
	`ä“
Ğ
buf
 );

1835 
	`r§_ä“
Ğ
r§
 );

1836 Ğ
POLARSSL_ERR_X509_KEY_INVALID_FORMAT
 |

1837 
POLARSSL_ERR_ASN1_LENGTH_MISMATCH
 );

1840 ifĞĞ
»t
 = 
	`r§_check_´ivkey
Ğ
r§
 ) ) != 0 )

1842 ifĞ
s1
 !ğ
NULL
 )

1843 
	`ä“
Ğ
buf
 );

1845 
	`r§_ä“
Ğ
r§
 );

1846 Ğ
»t
 );

1849 ifĞ
s1
 !ğ
NULL
 )

1850 
	`ä“
Ğ
buf
 );

1853 
	}
}

1858 
	$x509·r£_keyfe
Ğ
r§_cÚ‹xt
 *
r§
, cÚ¡ *
·th
, cÚ¡ *
pwd
 )

1860 
»t
;

1861 
size_t
 
n
;

1862 *
buf
;

1864 iàĞ
	`lßd_fe
Ğ
·th
, &
buf
, &
n
 ) )

1867 ifĞ
pwd
 =ğ
NULL
 )

1868 
»t
 = 
	`x509·r£_key
Ğ
r§
, 
buf
, (è
n
, 
NULL
, 0 );

1870 
»t
 = 
	`x509·r£_key
Ğ
r§
, 
buf
, (è
n
,

1871 (*è
pwd
, 
	`¡¾’
(…wd ) );

1873 
	`mem£t
Ğ
buf
, 0, 
n
 + 1 );

1874 
	`ä“
Ğ
buf
 );

1876 Ğ
»t
 );

1877 
	}
}

1879 #ià
defšed
 
_MSC_VER
 && !defšed 
¢´štf


1880 
	~<¡d¬g.h
>

1882 #ià!
defšed
 
v¢´štf


1883 
	#v¢´štf
 
_v¢´štf


	)

1893 
	$com·t_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

1895 
va_li¡
 
­
;

1896 
»s
 = -1;

1898 
	`va_¡¬t
Ğ
­
, 
fÜm©
 );

1900 
»s
 = 
	`v¢´štf
Ğ
¡r
, 
size
, 
fÜm©
, 
­
 );

1902 
	`va_’d
Ğ
­
 );

1905 iàĞ
»s
 < 0 )

1906 Ğ
size
 + 20 );

1908  
»s
;

1909 
	}
}

1911 
	#¢´štf
 
com·t_¢´štf


	)

1914 
	#POLARSSL_ERR_DEBUG_BUF_TOO_SMALL
 -2

	)

1916 
	#SAFE_SNPRINTF
() \

1918 ifĞ
»t
 == -1 ) \

1921 iàĞ
»t
 > 
n
 ) { \

1922 
p
[
n
 - 1] = '\0'; \

1923  
POLARSSL_ERR_DEBUG_BUF_TOO_SMALL
;\

1926 
n
 -ğ
»t
; \

1927 
p
 +ğ
»t
; \

1928 }

	)

1934 
	$x509·r£_dn_g‘s
Ğ*
buf
, 
size_t
 
size
, cÚ¡ 
x509_Çme
 *
dn
 )

1936 
i
, 
»t
, 
n
;

1937 
c
;

1938 cÚ¡ 
x509_Çme
 *
Çme
;

1939 
s
[128], *
p
;

1941 
	`mem£t
Ğ
s
, 0, ( s ) );

1943 
Çme
 = 
dn
;

1944 
p
 = 
buf
;

1945 
n
 = 
size
;

1947  
Çme
 !ğ
NULL
 )

1949 ifĞ
Çme
 !ğ
dn
 ) {

1950 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, ", " );

1951 
	`SAFE_SNPRINTF
();

1954 ifĞ
	`memcmp
Ğ
Çme
->
oid
.
p
, 
OID_X520
, 2 ) == 0 )

1956  
Çme
->
oid
.
p
[2] )

1958 
X520_COMMON_NAME
:

1959 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "CN=" ); ;

1961 
X520_COUNTRY
:

1962 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "C=" ); ;

1964 
X520_LOCALITY
:

1965 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "L=" ); ;

1967 
X520_STATE
:

1968 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "ST=" ); ;

1970 
X520_ORGANIZATION
:

1971 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "O=" ); ;

1973 
X520_ORG_UNIT
:

1974 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "OU=" ); ;

1977 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "0x%02X=",

1978 
Çme
->
oid
.
p
[2] );

1981 
	`SAFE_SNPRINTF
();

1983 ifĞ
	`memcmp
Ğ
Çme
->
oid
.
p
, 
OID_PKCS9
, 8 ) == 0 )

1985  
Çme
->
oid
.
p
[8] )

1987 
PKCS9_EMAIL
:

1988 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "emailAddress=" ); ;

1991 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "0x%02X=",

1992 
Çme
->
oid
.
p
[8] );

1995 
	`SAFE_SNPRINTF
();

1999 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\?\?=" );

2000 
	`SAFE_SNPRINTF
();

2003  
i
 = 0; i < 
Çme
->
v®
.
Ën
; i++ )

2005 ifĞ
i
 >ğ(èĞ
s
 ) - 1 )

2008 
c
 = 
Çme
->
v®
.
p
[
i
];

2009 ifĞ
c
 < 32 || c == 127 || ( c > 128 && c < 160 ) )

2010 
s
[
i
] = '?';

2011 
s
[
i
] = 
c
;

2013 
s
[
i
] = '\0';

2014 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%s", 
s
 );

2015 
	`SAFE_SNPRINTF
();

2016 
Çme
 =‚ame->
Ãxt
;

2019 Ğ
size
 - 
n
 );

2020 
	}
}

2025 
	$x509·r£_û¹_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

2026 cÚ¡ 
x509_û¹
 *
üt
 )

2028 
i
, 
n
, 
Ä
, 
»t
;

2029 *
p
;

2031 
p
 = 
buf
;

2032 
n
 = 
size
;

2034 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%scert. version : %d\n",

2035 
´efix
, 
üt
->
v”siÚ
 );

2036 
	`SAFE_SNPRINTF
();

2037 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%sserial‚umber : ",

2038 
´efix
 );

2039 
	`SAFE_SNPRINTF
();

2041 
Ä
 = ( 
üt
->
£rŸl
.
Ën
 <= 32 )

2042 ? 
üt
->
£rŸl
.
Ën
 : 32;

2044  
i
 = 0; i < 
Ä
; i++ )

2046 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%02X%s",

2047 
üt
->
£rŸl
.
p
[
i
], ( i < 
Ä
 - 1 ) ? ":" : "" );

2048 
	`SAFE_SNPRINTF
();

2051 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sissu”‚am : ", 
´efix
 );

2052 
	`SAFE_SNPRINTF
();

2053 
»t
 = 
	`x509·r£_dn_g‘s
Ğ
p
, 
n
, &
üt
->
issu”
 );

2054 
	`SAFE_SNPRINTF
();

2056 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%ssubjeù‚am : ", 
´efix
 );

2057 
	`SAFE_SNPRINTF
();

2058 
»t
 = 
	`x509·r£_dn_g‘s
Ğ
p
, 
n
, &
üt
->
subjeù
 );

2059 
	`SAFE_SNPRINTF
();

2061 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sissued on : " \

2062 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2063 
üt
->
v®id_äom
.
y—r
, c¹->v®id_äom.
mÚ
,

2064 
üt
->
v®id_äom
.
day
, c¹->v®id_äom.
hour
,

2065 
üt
->
v®id_äom
.
mš
, c¹->v®id_äom.
£c
 );

2066 
	`SAFE_SNPRINTF
();

2068 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sexpires on : " \

2069 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2070 
üt
->
v®id_to
.
y—r
, c¹->v®id_to.
mÚ
,

2071 
üt
->
v®id_to
.
day
, c¹->v®id_to.
hour
,

2072 
üt
->
v®id_to
.
mš
, c¹->v®id_to.
£c
 );

2073 
	`SAFE_SNPRINTF
();

2075 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%ssigÃd usšg : RSA+", 
´efix
 );

2076 
	`SAFE_SNPRINTF
();

2078  
üt
->
sig_®g
 )

2080 
SIG_RSA_MD2
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD2" ); ;

2081 
SIG_RSA_MD4
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD4" ); ;

2082 
SIG_RSA_MD5
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD5" ); ;

2083 
SIG_RSA_SHA1
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA1" ); ;

2084 
SIG_RSA_SHA224
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA224" ); ;

2085 
SIG_RSA_SHA256
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA256" ); ;

2086 
SIG_RSA_SHA384
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA384" ); ;

2087 
SIG_RSA_SHA512
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA512" ); ;

2088 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "???" ); ;

2090 
	`SAFE_SNPRINTF
();

2092 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sRSA key siz : %d b™s\n", 
´efix
,

2093 
üt
->
r§
.
N
.
n
 * () ( ) * 8 );

2094 
	`SAFE_SNPRINTF
();

2096 Ğ
size
 - 
n
 );

2097 
	}
}

2102 
	$x509·r£_ül_šfo
Ğ*
buf
, 
size_t
 
size
, cÚ¡ *
´efix
,

2103 cÚ¡ 
x509_ül
 *
ül
 )

2105 
i
, 
n
, 
Ä
, 
»t
;

2106 *
p
;

2107 cÚ¡ 
x509_ül_’Œy
 *
’Œy
;

2109 
p
 = 
buf
;

2110 
n
 = 
size
;

2112 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%sCRL version : %d",

2113 
´efix
, 
ül
->
v”siÚ
 );

2114 
	`SAFE_SNPRINTF
();

2116 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sissu”‚am : ", 
´efix
 );

2117 
	`SAFE_SNPRINTF
();

2118 
»t
 = 
	`x509·r£_dn_g‘s
Ğ
p
, 
n
, &
ül
->
issu”
 );

2119 
	`SAFE_SNPRINTF
();

2121 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sthis update : " \

2122 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2123 
ül
->
this_upd©e
.
y—r
, c¾->this_upd©e.
mÚ
,

2124 
ül
->
this_upd©e
.
day
, c¾->this_upd©e.
hour
,

2125 
ül
->
this_upd©e
.
mš
, c¾->this_upd©e.
£c
 );

2126 
	`SAFE_SNPRINTF
();

2128 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%snext update : " \

2129 "%04d-%02d-%02d %02d:%02d:%02d", 
´efix
,

2130 
ül
->
Ãxt_upd©e
.
y—r
, c¾->Ãxt_upd©e.
mÚ
,

2131 
ül
->
Ãxt_upd©e
.
day
, c¾->Ãxt_upd©e.
hour
,

2132 
ül
->
Ãxt_upd©e
.
mš
, c¾->Ãxt_upd©e.
£c
 );

2133 
	`SAFE_SNPRINTF
();

2135 
’Œy
 = &
ül
->entry;

2137 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sRevoked certificates:",

2138 
´efix
 );

2139 
	`SAFE_SNPRINTF
();

2141  
’Œy
 !ğ
NULL
 &&ƒÁry->
¿w
.
Ën
 != 0 )

2143 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%sserial‚umber: ",

2144 
´efix
 );

2145 
	`SAFE_SNPRINTF
();

2147 
Ä
 = ( 
’Œy
->
£rŸl
.
Ën
 <= 32 )

2148 ? 
’Œy
->
£rŸl
.
Ën
 : 32;

2150  
i
 = 0; i < 
Ä
; i++ ) {

2151 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "%02X%s",

2152 
’Œy
->
£rŸl
.
p
[
i
], ( i < 
Ä
 - 1 ) ? ":" : "" );

2153 
	`SAFE_SNPRINTF
();

2156 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "„evocation date: " \

2158 
’Œy
->
»voÿtiÚ_d©e
.
y—r
,ƒÁry->»voÿtiÚ_d©e.
mÚ
,

2159 
’Œy
->
»voÿtiÚ_d©e
.
day
,ƒÁry->»voÿtiÚ_d©e.
hour
,

2160 
’Œy
->
»voÿtiÚ_d©e
.
mš
,ƒÁry->»voÿtiÚ_d©e.
£c
 );

2161 
	`SAFE_SNPRINTF
();

2163 
’Œy
 =ƒÁry->
Ãxt
;

2166 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n%ssigÃd usšg : RSA+", 
´efix
 );

2167 
	`SAFE_SNPRINTF
();

2169  
ül
->
sig_®g
 )

2171 
SIG_RSA_MD2
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD2" ); ;

2172 
SIG_RSA_MD4
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD4" ); ;

2173 
SIG_RSA_MD5
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "MD5" ); ;

2174 
SIG_RSA_SHA1
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA1" ); ;

2175 
SIG_RSA_SHA224
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA224" ); ;

2176 
SIG_RSA_SHA256
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA256" ); ;

2177 
SIG_RSA_SHA384
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA384" ); ;

2178 
SIG_RSA_SHA512
 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "SHA512" ); ;

2179 : 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "???" ); ;

2181 
	`SAFE_SNPRINTF
();

2183 
»t
 = 
	`¢´štf
Ğ
p
, 
n
, "\n" );

2184 
	`SAFE_SNPRINTF
();

2186 Ğ
size
 - 
n
 );

2187 
	}
}

2192 
	$x509·r£_time_expœed
ĞcÚ¡ 
x509_time
 *
to
 )

2194 
tm
 *
É
;

2195 
time_t
 
‰
;

2197 
‰
 = 
	`time
Ğ
NULL
 );

2198 
É
 = 
	`loÿÉime
Ğ&
‰
 );

2200 ifĞ
É
->
tm_y—r
 > 
to
->
y—r
 - 1900 )

2203 ifĞ
É
->
tm_y—r
 =ğ
to
->
y—r
 - 1900 &&

2204 
É
->
tm_mÚ
 > 
to
->
mÚ
 - 1 )

2207 ifĞ
É
->
tm_y—r
 =ğ
to
->
y—r
 - 1900 &&

2208 
É
->
tm_mÚ
 =ğ
to
->
mÚ
 - 1 &&

2209 
É
->
tm_mday
 > 
to
->
day
 )

2213 
	}
}

2218 
	$x509·r£_»voked
ĞcÚ¡ 
x509_û¹
 *
üt
, cÚ¡ 
x509_ül
 *
ül
 )

2220 cÚ¡ 
x509_ül_’Œy
 *
cur
 = &
ül
->
’Œy
;

2222  
cur
 !ğ
NULL
 && cur->
£rŸl
.
Ën
 != 0 )

2224 ifĞ
	`memcmp
Ğ
üt
->
£rŸl
.
p
, 
cur
->£rŸl.p, c¹->£rŸl.
Ën
 ) == 0 )

2226 ifĞ
	`x509·r£_time_expœed
Ğ&
cur
->
»voÿtiÚ_d©e
 ) )

2230 
cur
 = cur->
Ãxt
;

2234 
	}
}

2241 
	$x509_hash
ĞcÚ¡ *
š
, 
Ën
, 
®g
,

2242 *
out
 )

2244  
®g
 )

2246 #ià
	`defšed
(
POLARSSL_MD2_C
)

2247 
SIG_RSA_MD2
 : 
	`md2
Ğ
š
, 
Ën
, 
out
 ); ;

2249 #ià
	`defšed
(
POLARSSL_MD4_C
)

2250 
SIG_RSA_MD4
 : 
	`md4
Ğ
š
, 
Ën
, 
out
 ); ;

2252 #ià
	`defšed
(
POLARSSL_MD5_C
)

2253 
SIG_RSA_MD5
 : 
	`md5
Ğ
š
, 
Ën
, 
out
 ); ;

2255 #ià
	`defšed
(
POLARSSL_SHA1_C
)

2256 
SIG_RSA_SHA1
 : 
	`sha1
Ğ
š
, 
Ën
, 
out
 ); ;

2258 #ià
	`defšed
(
POLARSSL_SHA2_C
)

2259 
SIG_RSA_SHA224
 : 
	`sha2
Ğ
š
, 
Ën
, 
out
, 1 ); ;

2260 
SIG_RSA_SHA256
 : 
	`sha2
Ğ
š
, 
Ën
, 
out
, 0 ); ;

2262 #ià
	`defšed
(
POLARSSL_SHA4_C
)

2263 
SIG_RSA_SHA384
 : 
	`sha4
Ğ
š
, 
Ën
, 
out
, 1 ); ;

2264 
SIG_RSA_SHA512
 : 
	`sha4
Ğ
š
, 
Ën
, 
out
, 0 ); ;

2267 
	`mem£t
Ğ
out
, '\xFF', 64 );

2270 
	}
}

2275 
	$x509·r£_v”ify
Ğ
x509_û¹
 *
üt
,

2276 
x509_û¹
 *
Œu¡_ÿ
,

2277 
x509_ül
 *
ÿ_ül
,

2278 cÚ¡ *
ú
, *
æags
 )

2280 
ú_Ën
;

2281 
hash_id
;

2282 
·thËn
;

2283 
x509_û¹
 *
cur
;

2284 
x509_Çme
 *
Çme
;

2285 
hash
[64];

2287 *
æags
 = 0;

2289 ifĞ
	`x509·r£_time_expœed
Ğ&
üt
->
v®id_to
 ) )

2290 *
æags
 = 
BADCERT_EXPIRED
;

2292 ifĞ
ú
 !ğ
NULL
 )

2294 
Çme
 = &
üt
->
subjeù
;

2295 
ú_Ën
 = 
	`¡¾’
Ğ
ú
 );

2297  
Çme
 !ğ
NULL
 )

2299 ifĞ
	`memcmp
Ğ
Çme
->
oid
.
p
, 
OID_CN
, 3 ) == 0 &&

2300 
	`memcmp
Ğ
Çme
->
v®
.
p
, 
ú
, 
ú_Ën
 ) == 0 &&

2301 
Çme
->
v®
.
Ën
 =ğ
ú_Ën
 )

2304 
Çme
 =‚ame->
Ãxt
;

2307 ifĞ
Çme
 =ğ
NULL
 )

2308 *
æags
 |ğ
BADCERT_CN_MISMATCH
;

2311 *
æags
 |ğ
BADCERT_NOT_TRUSTED
;

2317 
cur
 = 
üt
->
Ãxt
;

2319 
·thËn
 = 1;

2321  
cur
 !ğ
NULL
 && cur->
v”siÚ
 != 0 )

2323 ifĞ
cur
->
ÿ_i¡rue
 == 0 ||

2324 
üt
->
issu”_¿w
.
Ën
 !ğ
cur
->
subjeù_¿w
.len ||

2325 
	`memcmp
Ğ
üt
->
issu”_¿w
.
p
, 
cur
->
subjeù_¿w
.p,

2326 
üt
->
issu”_¿w
.
Ën
 ) != 0 )

2328 
cur
 = cur->
Ãxt
;

2332 
hash_id
 = 
üt
->
sig_®g
;

2334 
	`x509_hash
Ğ
üt
->
tbs
.
p
, c¹->tbs.
Ën
, 
hash_id
, 
hash
 );

2336 ifĞ
	`r§_pkcs1_v”ify
Ğ&
cur
->
r§
, 
RSA_PUBLIC
, 
hash_id
,

2337 0, 
hash
, 
üt
->
sig
.
p
 ) != 0 )

2338 Ğ
POLARSSL_ERR_X509_CERT_VERIFY_FAILED
 );

2340 
·thËn
++;

2342 
üt
 = 
cur
;

2343 
cur
 = 
üt
->
Ãxt
;

2349  
Œu¡_ÿ
 !ğ
NULL
 &&ru¡_ÿ->
v”siÚ
 != 0 )

2351 ifĞ
üt
->
issu”_¿w
.
Ën
 !ğ
Œu¡_ÿ
->
subjeù_¿w
.len ||

2352 
	`memcmp
Ğ
üt
->
issu”_¿w
.
p
, 
Œu¡_ÿ
->
subjeù_¿w
.p,

2353 
üt
->
issu”_¿w
.
Ën
 ) != 0 )

2355 
Œu¡_ÿ
 =ru¡_ÿ->
Ãxt
;

2359 ifĞ
Œu¡_ÿ
->
max_·thËn
 > 0 &&

2360 
Œu¡_ÿ
->
max_·thËn
 < 
·thËn
 )

2363 
hash_id
 = 
üt
->
sig_®g
;

2365 
	`x509_hash
Ğ
üt
->
tbs
.
p
, c¹->tbs.
Ën
, 
hash_id
, 
hash
 );

2367 ifĞ
	`r§_pkcs1_v”ify
Ğ&
Œu¡_ÿ
->
r§
, 
RSA_PUBLIC
, 
hash_id
,

2368 0, 
hash
, 
üt
->
sig
.
p
 ) == 0 )

2373 *
æags
 &ğ~
BADCERT_NOT_TRUSTED
;

2377 
Œu¡_ÿ
 =ru¡_ÿ->
Ãxt
;

2390  
Œu¡_ÿ
 !ğ
NULL
 && 
ÿ_ül
 !ğNULL && ca_ül->
v”siÚ
 != 0 )

2392 ifĞ
ÿ_ül
->
issu”_¿w
.
Ën
 !ğ
Œu¡_ÿ
->
subjeù_¿w
.len ||

2393 
	`memcmp
Ğ
ÿ_ül
->
issu”_¿w
.
p
, 
Œu¡_ÿ
->
subjeù_¿w
.p,

2394 
ÿ_ül
->
issu”_¿w
.
Ën
 ) != 0 )

2396 
ÿ_ül
 = ca_ül->
Ãxt
;

2403 
hash_id
 = 
ÿ_ül
->
sig_®g
;

2405 
	`x509_hash
Ğ
ÿ_ül
->
tbs
.
p
, ca_ül->tbs.
Ën
, 
hash_id
, 
hash
 );

2407 ifĞ!
	`r§_pkcs1_v”ify
Ğ&
Œu¡_ÿ
->
r§
, 
RSA_PUBLIC
, 
hash_id
,

2408 0, 
hash
, 
ÿ_ül
->
sig
.
p
 ) == 0 )

2413 *
æags
 |ğ
BADCRL_NOT_TRUSTED
;

2420 ifĞ
	`x509·r£_time_expœed
Ğ&
ÿ_ül
->
Ãxt_upd©e
 ) )

2421 *
æags
 |ğ
BADCRL_EXPIRED
;

2426 ifĞ
	`x509·r£_»voked
(
üt
, 
ÿ_ül
) )

2428 *
æags
 |ğ
BADCERT_REVOKED
;

2432 
ÿ_ül
 = ca_ül->
Ãxt
;

2435 ifĞ*
æags
 != 0 )

2436 Ğ
POLARSSL_ERR_X509_CERT_VERIFY_FAILED
 );

2439 
	}
}

2444 
	$x509_ä“
Ğ
x509_û¹
 *
üt
 )

2446 
x509_û¹
 *
û¹_cur
 = 
üt
;

2447 
x509_û¹
 *
û¹_´v
;

2448 
x509_Çme
 *
Çme_cur
;

2449 
x509_Çme
 *
Çme_´v
;

2451 ifĞ
üt
 =ğ
NULL
 )

2456 
	`r§_ä“
Ğ&
û¹_cur
->
r§
 );

2458 
Çme_cur
 = 
û¹_cur
->
issu”
.
Ãxt
;

2459  
Çme_cur
 !ğ
NULL
 )

2461 
Çme_´v
 = 
Çme_cur
;

2462 
Çme_cur
 =‚ame_cur->
Ãxt
;

2463 
	`mem£t
Ğ
Çme_´v
, 0, Ğ
x509_Çme
 ) );

2464 
	`ä“
Ğ
Çme_´v
 );

2467 
Çme_cur
 = 
û¹_cur
->
subjeù
.
Ãxt
;

2468  
Çme_cur
 !ğ
NULL
 )

2470 
Çme_´v
 = 
Çme_cur
;

2471 
Çme_cur
 =‚ame_cur->
Ãxt
;

2472 
	`mem£t
Ğ
Çme_´v
, 0, Ğ
x509_Çme
 ) );

2473 
	`ä“
Ğ
Çme_´v
 );

2476 ifĞ
û¹_cur
->
¿w
.
p
 !ğ
NULL
 )

2478 
	`mem£t
Ğ
û¹_cur
->
¿w
.
p
, 0, c”t_cur->¿w.
Ën
 );

2479 
	`ä“
Ğ
û¹_cur
->
¿w
.
p
 );

2482 
û¹_cur
 = c”t_cur->
Ãxt
;

2484  
û¹_cur
 !ğ
NULL
 );

2486 
û¹_cur
 = 
üt
;

2489 
û¹_´v
 = 
û¹_cur
;

2490 
û¹_cur
 = c”t_cur->
Ãxt
;

2492 
	`mem£t
Ğ
û¹_´v
, 0, Ğ
x509_û¹
 ) );

2493 ifĞ
û¹_´v
 !ğ
üt
 )

2494 
	`ä“
Ğ
û¹_´v
 );

2496  
û¹_cur
 !ğ
NULL
 );

2497 
	}
}

2502 
	$x509_ül_ä“
Ğ
x509_ül
 *
ül
 )

2504 
x509_ül
 *
ül_cur
 = 
ül
;

2505 
x509_ül
 *
ül_´v
;

2506 
x509_Çme
 *
Çme_cur
;

2507 
x509_Çme
 *
Çme_´v
;

2508 
x509_ül_’Œy
 *
’Œy_cur
;

2509 
x509_ül_’Œy
 *
’Œy_´v
;

2511 ifĞ
ül
 =ğ
NULL
 )

2516 
Çme_cur
 = 
ül_cur
->
issu”
.
Ãxt
;

2517  
Çme_cur
 !ğ
NULL
 )

2519 
Çme_´v
 = 
Çme_cur
;

2520 
Çme_cur
 =‚ame_cur->
Ãxt
;

2521 
	`mem£t
Ğ
Çme_´v
, 0, Ğ
x509_Çme
 ) );

2522 
	`ä“
Ğ
Çme_´v
 );

2525 
’Œy_cur
 = 
ül_cur
->
’Œy
.
Ãxt
;

2526  
’Œy_cur
 !ğ
NULL
 )

2528 
’Œy_´v
 = 
’Œy_cur
;

2529 
’Œy_cur
 =ƒÁry_cur->
Ãxt
;

2530 
	`mem£t
Ğ
’Œy_´v
, 0, Ğ
x509_ül_’Œy
 ) );

2531 
	`ä“
Ğ
’Œy_´v
 );

2534 ifĞ
ül_cur
->
¿w
.
p
 !ğ
NULL
 )

2536 
	`mem£t
Ğ
ül_cur
->
¿w
.
p
, 0, c¾_cur->¿w.
Ën
 );

2537 
	`ä“
Ğ
ül_cur
->
¿w
.
p
 );

2540 
ül_cur
 = c¾_cur->
Ãxt
;

2542  
ül_cur
 !ğ
NULL
 );

2544 
ül_cur
 = 
ül
;

2547 
ül_´v
 = 
ül_cur
;

2548 
ül_cur
 = c¾_cur->
Ãxt
;

2550 
	`mem£t
Ğ
ül_´v
, 0, Ğ
x509_ül
 ) );

2551 ifĞ
ül_´v
 !ğ
ül
 )

2552 
	`ä“
Ğ
ül_´v
 );

2554  
ül_cur
 !ğ
NULL
 );

2555 
	}
}

2557 #ià
defšed
(
POLARSSL_SELF_TEST
)

2559 
	~"pŞ¬s¦/û¹s.h
"

2564 
	$x509_£lf_‹¡
Ğ
v”bo£
 )

2566 #ià
	`defšed
(
POLARSSL_MD5_C
)

2567 
»t
, 
i
, 
j
;

2568 
x509_û¹
 
ÿû¹
;

2569 
x509_û¹
 
şiû¹
;

2570 
r§_cÚ‹xt
 
r§
;

2572 ifĞ
v”bo£
 != 0 )

2573 
	`´štf
( " X.509 certificate†oad: " );

2575 
	`mem£t
Ğ&
şiû¹
, 0, Ğ
x509_û¹
 ) );

2577 
»t
 = 
	`x509·r£_üt
Ğ&
şiû¹
, (*è
‹¡_şi_üt
,

2578 
	`¡¾’
Ğ
‹¡_şi_üt
 ) );

2579 ifĞ
»t
 != 0 )

2581 ifĞ
v”bo£
 != 0 )

2582 
	`´štf
( "failed\n" );

2584 Ğ
»t
 );

2587 
	`mem£t
Ğ&
ÿû¹
, 0, Ğ
x509_û¹
 ) );

2589 
»t
 = 
	`x509·r£_üt
Ğ&
ÿû¹
, (*è
‹¡_ÿ_üt
,

2590 
	`¡¾’
Ğ
‹¡_ÿ_üt
 ) );

2591 ifĞ
»t
 != 0 )

2593 ifĞ
v”bo£
 != 0 )

2594 
	`´štf
( "failed\n" );

2596 Ğ
»t
 );

2599 ifĞ
v”bo£
 != 0 )

2600 
	`´štf
( "passed\n X.509…rivate key†oad: " );

2602 
i
 = 
	`¡¾’
Ğ
‹¡_ÿ_key
 );

2603 
j
 = 
	`¡¾’
Ğ
‹¡_ÿ_pwd
 );

2605 ifĞĞ
»t
 = 
	`x509·r£_key
Ğ&
r§
,

2606 (*è
‹¡_ÿ_key
, 
i
,

2607 (*è
‹¡_ÿ_pwd
, 
j
 ) ) != 0 )

2609 ifĞ
v”bo£
 != 0 )

2610 
	`´štf
( "failed\n" );

2612 Ğ
»t
 );

2615 ifĞ
v”bo£
 != 0 )

2616 
	`´štf
( "passed\n X.509 signature verify: ");

2618 
»t
 = 
	`x509·r£_v”ify
Ğ&
şiû¹
, &
ÿû¹
, 
NULL
, "PŞ¬SSL Cl›Á 2", &
i
 );

2619 ifĞ
»t
 != 0 )

2621 
	`´štf
("%02x", 
i
);

2622 ifĞ
v”bo£
 != 0 )

2623 
	`´štf
( "failed\n" );

2625 Ğ
»t
 );

2628 ifĞ
v”bo£
 != 0 )

2629 
	`´štf
( "passed\n\n" );

2631 
	`x509_ä“
Ğ&
ÿû¹
 );

2632 
	`x509_ä“
Ğ&
şiû¹
 );

2633 
	`r§_ä“
Ğ&
r§
 );

2637 ((è
v”bo£
);

2638 Ğ
POLARSSL_ERR_X509_FEATURE_UNAVAILABLE
 );

2640 
	}
}

	@tools/src/polarssl/xtea.c

26 
	~"pŞ¬s¦/cÚfig.h
"

28 #ià
defšed
(
POLARSSL_XTEA_C
)

30 
	~"pŞ¬s¦/x‹a.h
"

32 
	~<¡ršg.h
>

37 #iâdeà
GET_ULONG_BE


38 
	#GET_ULONG_BE
(
n
,
b
,
i
) \

40 (
n
èğĞ(è(
b
)[(
i
) ] << 24 ) \

41 | ( (è(
b
)[(
i
) + 1] << 16 ) \

42 | ( (è(
b
)[(
i
) + 2] << 8 ) \

43 | ( (è(
b
)[(
i
) + 3] ); \

44 }

	)

47 #iâdeà
PUT_ULONG_BE


48 
	#PUT_ULONG_BE
(
n
,
b
,
i
) \

50 (
b
)[(
i
è] = (èĞ(
n
) >> 24 ); \

51 (
b
)[(
i
è+ 1] = (èĞ(
n
) >> 16 ); \

52 (
b
)[(
i
è+ 2] = (èĞ(
n
) >> 8 ); \

53 (
b
)[(
i
è+ 3] = (èĞ(
n
) ); \

54 }

	)

60 
	$x‹a_£tup
Ğ
x‹a_cÚ‹xt
 *
ùx
, 
key
[16] )

62 
i
;

64 
	`mem£t
(
ùx
, 0, (
x‹a_cÚ‹xt
));

66  
i
 = 0; i < 4; i++ )

68 
	`GET_ULONG_BE
Ğ
ùx
->
k
[
i
], 
key
, i << 2 );

70 
	}
}

75 
	$x‹a_üy±_ecb
Ğ
x‹a_cÚ‹xt
 *
ùx
, 
mode
, 
šput
[8],

76 
ouut
[8])

78 
ušt32_t
 *
k
, 
v0
, 
v1
, 
i
;

80 
k
 = 
ùx
->k;

82 
	`GET_ULONG_BE
Ğ
v0
, 
šput
, 0 );

83 
	`GET_ULONG_BE
Ğ
v1
, 
šput
, 4 );

85 ifĞ
mode
 =ğ
XTEA_ENCRYPT
 )

87 
ušt32_t
 
sum
 = 0, 
d–
 = 0x9E3779B9;

89  
i
 = 0; i < 32; i++ )

91 
v0
 +ğ(((
v1
 << 4è^ (v1 >> 5)è+ v1è^ (
sum
 + 
k
[sum & 3]);

92 
sum
 +ğ
d–
;

93 
v1
 +ğ(((
v0
 << 4è^ (v0 >> 5)è+ v0è^ (
sum
 + 
k
[(sum>>11) & 3]);

98 
ušt32_t
 
d–
 = 0x9E3779B9, 
sum
 = delta * 32;

100  
i
 = 0; i < 32; i++ )

102 
v1
 -ğ(((
v0
 << 4è^ (v0 >> 5)è+ v0è^ (
sum
 + 
k
[(sum>>11) & 3]);

103 
sum
 -ğ
d–
;

104 
v0
 -ğ(((
v1
 << 4è^ (v1 >> 5)è+ v1è^ (
sum
 + 
k
[sum & 3]);

108 
	`PUT_ULONG_BE
Ğ
v0
, 
ouut
, 0 );

109 
	`PUT_ULONG_BE
Ğ
v1
, 
ouut
, 4 );

112 
	}
}

114 #ià
defšed
(
POLARSSL_SELF_TEST
)

116 
	~<¡ršg.h
>

117 
	~<¡dio.h
>

123 cÚ¡ 
	gx‹a_‹¡_key
[6][16] =

139 cÚ¡ 
	gx‹a_‹¡_±
[6][8] =

149 cÚ¡ 
	gx‹a_‹¡_ù
[6][8] =

162 
	$x‹a_£lf_‹¡
Ğ
v”bo£
 )

164 
i
;

165 
buf
[8];

166 
x‹a_cÚ‹xt
 
ùx
;

168  
i
 = 0; i < 6; i++ )

170 ifĞ
v”bo£
 != 0 )

171 
	`´štf
Ğ" XTEAe¡ #%d: ", 
i
 + 1 );

173 
	`memıy
Ğ
buf
, 
x‹a_‹¡_±
[
i
], 8 );

175 
	`x‹a_£tup
Ğ&
ùx
, (*è
x‹a_‹¡_key
[
i
] );

176 
	`x‹a_üy±_ecb
Ğ&
ùx
, 
XTEA_ENCRYPT
, 
buf
, buf );

178 ifĞ
	`memcmp
Ğ
buf
, 
x‹a_‹¡_ù
[
i
], 8 ) != 0 )

180 ifĞ
v”bo£
 != 0 )

181 
	`´štf
( "failed\n" );

186 ifĞ
v”bo£
 != 0 )

187 
	`´štf
( "passed\n" );

190 ifĞ
v”bo£
 != 0 )

191 
	`´štf
( "\n" );

194 
	}
}

	@tools/src/polarssl/xtea.h

25 #iâdeà
POLARSSL_XTEA_H


26 
	#POLARSSL_XTEA_H


	)

28 #ifdeà
_MSC_VER


29 
	~<ba£tsd.h
>

30 
UINT32
 
	tušt32_t
;

32 
	~<š‰y³s.h
>

35 
	#XTEA_ENCRYPT
 1

	)

36 
	#XTEA_DECRYPT
 0

	)

44 
ušt32_t
 
	mk
[4];

46 
	tx‹a_cÚ‹xt
;

48 #ifdeà
__ılu¥lus


58 
x‹a_£tup
Ğ
x‹a_cÚ‹xt
 *
ùx
, 
key
[16] );

70 
x‹a_üy±_ecb
Ğ
x‹a_cÚ‹xt
 *
ùx
,

71 
mode
,

72 
šput
[8],

73 
ouut
[8] );

80 
x‹a_£lf_‹¡
Ğ
v”bo£
 );

82 #ifdeà
__ılu¥lus


	@tools/src/proxy.c

35 
	~<¡dio.h
>

36 
	~<¡ršg.h
>

37 
	~<”ºo.h
>

38 
	~<uni¡d.h
>

39 
	~<¡dlib.h
>

40 
	~<sys/sock‘.h
>

41 
	~<dbg.h
>

42 
	~<´oxy.h
>

43 
	~<as£¹.h
>

44 
	~<¡dlib.h
>

45 
	~<mem/h®loc.h
>

46 
	~<cÚÃùiÚ.h
>

47 
	~<h‰p11/h‰pş›Á_·r£r.h
>

49 
	gPROXY_READ_RETRIES
 = 100;

50 
	gPROXY_READ_RETRY_WARN
 = 10;

52 
	$Proxy_de¡roy
(
Proxy
 *
´oxy
)

54 if(
´oxy
) {

55 if(
´oxy
->
£rv”
è
	`bde¡roy
(proxy->server);

56 
	`h_ä“
(
´oxy
);

58 
	}
}

60 
Proxy
 *
	$Proxy_ü—‹
(
b¡ršg
 
£rv”
, 
pÜt
)

62 
Proxy
 *
´oxy
 = 
	`h_ÿÎoc
((Proxy), 1);

63 
	`check_mem
(
´oxy
);

65 
´oxy
->
£rv”
 = 
	`b¡rıy
(server);

66 
´oxy
->
pÜt
 =…ort;

67 
´oxy
->
ruÂšg
 = 1;

69  
´oxy
;

71 
”rÜ
:

72 
	`Proxy_de¡roy
(
´oxy
);

73  
NULL
;

74 
	}
}

76 
	$Proxy_»ad_ªd_·r£
(
CÚÃùiÚ
 *
cÚn
)

78 
ava
 = 0;

79 
Å¬£d
 = 0;

80 *
d©a
 = 
NULL
;

81 
Œ›s
 = 0;

83 
	`as£¹
(
cÚn
->
ş›Á
 && "httpclient_parser‚ot configured.");

84 
	`as£¹
(
cÚn
->
´oxy_iob
 && "conn->proxy_iob‚ot configured.");

86 
	`h‰pş›Á_·r£r_š™
(
cÚn
->
ş›Á
);

88 
Œ›s
 = 0;r› < 
PROXY_READ_RETRIES
;ries++) {

89 
d©a
 = 
	`IOBuf_»ad_some
(
cÚn
->
´oxy_iob
, &
ava
);

90 
	`check
(
d©a
 !ğ
NULL
, "Failedo„ead from…roxy.");

91 
	`check
(
ava
 > 0, "Proxy„ead„eturned %d bytes.",‡vail);

93 
d©a
[
ava
] = '\0';

94 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(
cÚn
->
ş›Á
, 
d©a
, 
ava
,‚parsed);

95 
	`check
(
Å¬£d
 != -1, "Major…arsing failure from…roxy backend, Tell Zed.");

96 
	`check
(!
	`h‰pş›Á_·r£r_has_”rÜ
(
cÚn
->
ş›Á
), "Parsingƒrror from server.");

98 if(
	`h‰pş›Á_·r£r_fšish
(
cÚn
->
ş›Á
) == 0) {

99 
	`fdwa™
(
cÚn
->
´oxy_iob
->
fd
, 'r');

105 if(
Œ›s
 > 
PROXY_READ_RETRY_WARN
) {

106 
	`log_w¬n
("Th´oxy back’d ha ¨bad I/O…©‹ºh©„equœed %d„—d befÜ¨h—d” wa com¶‘ed. You should wÜry‡bouˆ™ ³rfÜmªû.", 
Œ›s
);

109 
	`check
(
Œ›s
 < 
PROXY_READ_RETRIES
, "Backend…roxy sendsoo many small…ackets,ried %dimeso„ead from it.",ries);

110 
	`check
(()
cÚn
->
ş›Á
->
body_¡¬t
 <ğ
ava
, "Readoo much.");

113  
Å¬£d
;

115 
”rÜ
:

117 
	}
}

120 
šlše
 
	$·r£_chunks
(*
d©a
, 
h‰pş›Á_·r£r
 *
ş›Á
, 
ava
)

123 
d©a
[
ava
] = '\0';

124 
	`h‰pş›Á_·r£r_š™
(
ş›Á
);

125 
rc
 = 
	`h‰pş›Á_·r£r_execu‹
(
ş›Á
, 
d©a
, 
ava
, 0);

126 
	`check
(
rc
 != -1, "Fatal…arsingƒrror from…roxy, Tell Zed.");

127 
	`check
(!
	`h‰pş›Á_·r£r_has_”rÜ
(
ş›Á
), "Parsingƒrror from server.");

128 
	`check
(
	`h‰pş›Á_·r£r_fšish
(
ş›Á
), "Parser didn't get‡ full„esponse.");

130  
rc
;

131 
”rÜ
:

133 
	}
}

136 
	$Proxy_¡»am_chunks
(
CÚÃùiÚ
 *
cÚn
)

138 
rc
 = 0;

139 
IOBuf
 *
´oxy_iob
 = 
cÚn
->proxy_iob;

140 
	`as£¹
(
´oxy_iob
 && "proxy IOBuf‚ot configured.");

142 
ava
 = 
	`IOBuf_ava
(
´oxy_iob
);

143 *
d©a
 = 
NULL
;

144 
h‰pş›Á_·r£r
 *
ş›Á
 = 
cÚn
->client;

146 
	`as£¹
(
ş›Á
 && "httpclient_parser‚ot configured.");

147 
	`as£¹
(
ş›Á
->
chunked
 && "parser should indicate it has chunks.");

148 
	`as£¹
(!
ş›Á
->
chunks_dÚe
 && "parser should‚ot be in chunks done state.");

149 
	`as£¹
(
ava
 >= 0 && "Can't have‡ < 0‡vail.");

151 
d©a
 = 
ava
 =ğ0 ? 
	`IOBuf_»ad_some
(
´oxy_iob
, &avaè: 
	`IOBuf_¡¬t
(proxy_iob);

154 
rc
 = 
	`·r£_chunks
(
d©a
, 
ş›Á
, 
ava
);

155 
	`check_debug
(
rc
 != -1, "Failedo…arse chunkedƒncoding from client.");

158 
rc
 = 
	`IOBuf_¡»am
(
´oxy_iob
, 
cÚn
->
iob
, 
ş›Á
->
body_¡¬t
 + cl›Á->
cÚ‹Á_Ën
 + 2);

159 
	`check_debug
(
rc
 != -1, "Failedo stream contento client.");

161  
ş›Á
->
chunks_dÚe
;

163 
”rÜ
:

165 
	}
}

168 
	$Proxy_¡»am_to_şo£
(
CÚÃùiÚ
 *
cÚn
)

170 
cÚn
->
ş›Á
->
şo£
 = 1;

172 
tÙ®
 = 
cÚn
->
iob
->
Ën
 <ğcÚn->
´oxy_iob
->len ?

173 
cÚn
->
iob
->
Ën
 : cÚn->
´oxy_iob
->len;

175 
rc
 = 
	`IOBuf_£nd_®l
(
cÚn
->
iob
, 
	`IOBuf_¡¬t
(cÚn->
´oxy_iob
),

176 
	`IOBuf_ava
(
cÚn
->
´oxy_iob
));

178 
	`check_debug
(
rc
 != -1, "Failure sending‡ll on…roxy stream.");

180 
	`check
(
	`IOBuf_»ad_comm™
(
cÚn
->
´oxy_iob
, 
	`IOBuf_ava
(conn->proxy_iob)) != -1, "Final commit failed…roxy streaming until closed.");

182 
rc
 = 0;„c != -1;) {

183 
rc
 = 
	`IOBuf_¡»am
(
cÚn
->
´oxy_iob
, cÚn->
iob
, 
tÙ®
);

188 
”rÜ
:

190 
	}
}

	@tools/src/proxy.h

35 #iâdeà
_´oxy_h


36 
	#_´oxy_h


	)

38 
	~<b¡ršg.h
>

40 
	sProxy
 {

41 
b¡ršg
 
	m£rv”
;

42 
	mpÜt
;

43 
	mruÂšg
;

44 } 
	tProxy
;

46 
Proxy
 *
Proxy_ü—‹
(
b¡ršg
 
£rv”
, 
pÜt
);

48 
Proxy_de¡roy
(
Proxy
 *
´oxy
);

50 
	gCÚÃùiÚ
;

51 
Proxy_¡»am_»¥Ú£
(
CÚÃùiÚ
 *
cÚn
, 
tÙ®
, 
Ä—d
);

53 
Proxy_¡»am_chunks
(
CÚÃùiÚ
 *
cÚn
);

55 
Proxy_»ad_ªd_·r£
(
CÚÃùiÚ
 *
cÚn
);

57 
Proxy_¡»am_to_şo£
(
CÚÃùiÚ
 *
cÚn
);

59 
PROXY_READ_RETRIES
;

60 
PROXY_READ_RETRY_WARN
;

	@tools/src/register.c

35 
	~<as£¹.h
>

36 
	~<”ºo.h
>

37 
	~<¡ršg.h
>

38 
	~<uni¡d.h
>

39 
	~<sys/ty³s.h
>

40 
	~"Š‘¡ršgs.h
"

41 
	~"Š‘¡ršgs_im¶.h
"

43 
	~"»gi¡”.h
"

44 
	~"cÚÃùiÚ.h
"

45 
	~"dbg.h
"

46 
	~"sk/sk.h
"

47 
	~"adt/d¬¿y.h
"

48 
	~"£‰šg.h
"

51 
ušt32_t
 
	gTHE_CURRENT_TIME_IS
 = 0;

53 
d¬¿y_t
 *
	gREGISTRATIONS
 = 
NULL
;

54 
d¬¿y_t
 *
	gREG_ID_TO_FD
 = 
NULL
;

55 
ušt16_t
 
	gREG_COUNT
 = 0;

56 
	gNUM_REG_FD
 = 0;

58 
	$Regi¡”_š™
()

60 
THE_CURRENT_TIME_IS
 = 
	`time
(
NULL
);

61 
REGISTRATIONS
 = 
	`d¬¿y_ü—‹
((
Regi¡¿tiÚ
), 
MAX_REGISTERED_FDS
);

62 
REG_ID_TO_FD
 = 
	`d¬¿y_ü—‹
(0, 
MAX_REGISTERED_FDS
);

63 
	}
}

65 
šlše
 
	$Regi¡”_ş—r
(
Regi¡¿tiÚ
 *
»g
)

67 
»g
->
d©a
 = 
NULL
;

68 
»g
->
Ï¡_pšg
 = 0;

69 
»g
->
by‹s_»ad
 = 0;

70 
»g
->
by‹s_wr™‹n
 = 0;

71 
»g
->
Ï¡_»ad
 = 0;

72 
»g
->
Ï¡_wr™e
 = 0;

73 
	`d¬¿y_»move
(
REG_ID_TO_FD
, 
»g
->
id
);

74 
	}
}

76 
	$Regi¡”_cÚÃù
(
fd
, 
CÚÃùiÚ
* 
d©a
)

78 
rc
 = 0;

79 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

80 
	`check
(
d©a
 !ğ
NULL
, "data can't be NULL");

82 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

84 if(
»g
 =ğ
NULL
) {

85 
»g
 = 
	`d¬¿y_Ãw
(
REGISTRATIONS
);

87 
	`d¬¿y_£t
(
REGISTRATIONS
, 
fd
, 
»g
);

88 
	`check
(
»g
 !ğ
NULL
, "Failedo‡llocate‡‚ew„egistration.");

91 if(
	`Regi¡”_v®id
(
»g
)) {

92 
	`debug
("Look lik¡®»gi¡¿tiÚ iÀ%d, kÈ™ befÜ™ g‘ out.", 
fd
);

94 
rc
 = 
	`Regi¡”_discÚÃù
(
fd
);

95 
	`check
(
rc
 !ğ-1, "Weœdƒ¼Ü,r›dØdiscÚÃù som‘hšgh©ƒxi¡ th’ gÙ‡À”rÜ: %d", 
fd
);

98 
»g
->
d©a
 = data;

99 
»g
->
Ï¡_pšg
 = 
THE_CURRENT_TIME_IS
;

100 
»g
->
fd
 = fd;

103 
»g
->
id
 = 
REG_COUNT
++;

104 
	`d¬¿y_£t
(
REG_ID_TO_FD
, 
»g
->
id
,„eg);

107 
NUM_REG_FD
++;

109  
»g
->
id
;

110 
”rÜ
:

112 
	}
}

115 
	$Regi¡”_discÚÃù
(
fd
)

117 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

118 
	`check
(
fd
 >= 0, "Invalid FD given for disconnect.");

120 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

122 
	`check_debug
(
	`Regi¡”_v®id
(
»g
), "A‰em±ØuÄegi¡” FD %d which i ®»ady gÚe.", 
fd
);

123 
	`check
(
»g
->
fd
 == fd, "Askedo disconnect fd %d but„egister had %d", fd,„eg->fd);

126 ià(
»g
->
d©a
->
iob
 !ğ
NULL
) {

127 
»g
->
d©a
->
iob
->
şo£d
=1;

130 
	`Regi¡”_ş—r
(
»g
);

131 
	`şo£
(
»g
->
fd
);

134 
NUM_REG_FD
--;

135  
»g
->
id
;

137 
”rÜ
:

138 
	`fdşo£
(
fd
);

140 
	}
}

142 
	$Regi¡”_pšg
(
fd
)

144 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

145 
	`check
(
fd
 >= 0, "Invalid FD given for…ing: %d", fd);

146 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

148 
	`check_debug
(
	`Regi¡”_v®id
(
»g
), "A‰em±Øpšg‡ÀFDh© i¢'ˆ»gi¡”ed: %d", 
fd
);

150 
»g
->
Ï¡_pšg
 = 
THE_CURRENT_TIME_IS
;

151  
»g
->
Ï¡_pšg
;

153 
”rÜ
:

155 
	}
}

158 
	$Regi¡”_»ad
(
fd
, 
off_t
 
by‹s
)

160 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

161 
	`check
(
fd
 >= 0, "Invalid FD given for Register_read: %d", fd);

162 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

164 if(
	`Regi¡”_v®id
(
»g
)) {

165 
»g
->
Ï¡_»ad
 = 
THE_CURRENT_TIME_IS
;

166 
»g
->
by‹s_»ad
 +ğ
by‹s
;

167  
»g
->
Ï¡_»ad
;

172 
”rÜ
:

174 
	}
}

177 
	$Regi¡”_wr™e
(
fd
, 
off_t
 
by‹s
)

179 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

180 
	`check
(
fd
 >= 0, "Invalid FD given for Register_write: %d", fd);

181 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

183 if(
	`Regi¡”_v®id
(
»g
)) {

184 
»g
->
Ï¡_wr™e
 = 
THE_CURRENT_TIME_IS
;

185 
»g
->
by‹s_wr™‹n
 +ğ
by‹s
;

186  
»g
->
Ï¡_wr™e
;

191 
”rÜ
:

193 
	}
}

196 
CÚÃùiÚ
 *
	$Regi¡”_fd_exi¡s
(
fd
)

198 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

199 
	`check
(
fd
 >= 0, "Invalid FD given forƒxists check");

201 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

203  
»g
 !ğ
NULL
 ?„eg->
d©a
 : NULL;

204 
”rÜ
:

205  
NULL
;

206 
	}
}

209 
	$Regi¡”_fd_fÜ_id
(
id
)

211 
	`check
(
id
 < 
MAX_REGISTERED_FDS
, "Ident (id) giveno„egister is greaterhan max.");

212 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REG_ID_TO_FD
, 
id
);

214 
	`check
(
	`Regi¡”_v®id
(
»g
), "NÙhšg„egi¡”ed und” id %d.", 
id
);

216  
»g
->
fd
;

217 
”rÜ
:

219 
	}
}

221 
	$Regi¡”_id_fÜ_fd
(
fd
)

223 
	`check
(
fd
 < 
MAX_REGISTERED_FDS
, "FD giveno„egister is greaterhan max.");

224 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
fd
);

225 
	`check
(
	`Regi¡”_v®id
(
»g
), "NØID fÜ fd: %d", 
fd
);

227  
»g
->
id
;

228 
”rÜ
:

230 
	}
}

232 
	#ZERO_OR_DELTA
(
N
, 
T
è(T =ğ0 ? T : N - T)

	)

235 
gb¡ršg
 
	gREGISTER_HEADERS
 = 
bsStic
("86:2:id,2:fd,4:type,9:last_ping,9:last_read,10:last_write,10:bytes_read,13:bytes_written,]");

237 
Šs_v®ue_t
 *
	$Regi¡”_šfo
()

239 
i
 = 0;

240 
Regi¡¿tiÚ
 *
»g
;

241 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

242 
nsÿÂed
 = 0;

244 
time_t
 
now
 = 
THE_CURRENT_TIME_IS
;

246 
i
 = 0, 
nsÿÂed
 = 0; i < 
	`d¬¿y_max
(
REGISTRATIONS
è&&‚sÿÂed < 
NUM_REG_FD
; i++) {

247 
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
i
);

249 if(
	`Regi¡”_v®id
(
»g
)) {

250 
nsÿÂed
++;

252 
Šs_v®ue_t
 *
d©a
 = 
	`Šs_Ãw_li¡
();

253 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->
id
));

254 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
i
));

255 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->d©a->
ty³
));

256 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
	`ZERO_OR_DELTA
(
now
, 
»g
->
Ï¡_pšg
)));

257 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
	`ZERO_OR_DELTA
(
now
, 
»g
->
Ï¡_»ad
)));

258 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
	`ZERO_OR_DELTA
(
now
, 
»g
->
Ï¡_wr™e
)));

259 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->
by‹s_»ad
));

260 
	`Šs_add_to_li¡
(
d©a
, 
	`Šs_Ãw_š‹g”
(
»g
->
by‹s_wr™‹n
));

261 
	`Šs_add_to_li¡
(
rows
, 
d©a
);

265  
	`Šs_¡ªd¬d_bË
(&
REGISTER_HEADERS
, 
rows
);

266 
	}
}

268 
	$Regi¡”_ş—nout
()

270 
i
 = 0;

271 
nkËd
 = 0;

272 
nsÿÂed
 = 0;

273 
time_t
 
now
 = 
THE_CURRENT_TIME_IS
;

274 
mš_pšg
 = 
	`S‘tšg_g‘_št
("lim™s.mš_pšg", 
DEFAULT_MIN_PING
);

275 
mš_wr™e_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_wr™e_¿‹", 
DEFAULT_MIN_READ_RATE
);

276 
mš_»ad_¿‹
 = 
	`S‘tšg_g‘_št
("lim™s.mš_»ad_¿‹", 
DEFAULT_MIN_WRITE_RATE
);

277 
kl_lim™
 = 
	`S‘tšg_g‘_št
("lim™s.kl_lim™", 
DEFAULT_KILL_LIMIT
);

279 
i
 = 0, 
nsÿÂed
 = 0; i < 
	`d¬¿y_max
(
REGISTRATIONS
è&&‚sÿÂed < 
NUM_REG_FD
; i++) {

280 
Regi¡¿tiÚ
 *
»g
 = 
	`d¬¿y_g‘
(
REGISTRATIONS
, 
i
);

282 if(
	`Regi¡”_v®id
(
»g
)) {

283 
nsÿÂed
++;

285 
Ï¡_pšg
 = 
	`ZERO_OR_DELTA
(
now
, 
»g
->last_ping);

286 
off_t
 
»ad_¿‹
 = 
»g
->
by‹s_»ad
 / (
	`ZERO_OR_DELTA
(
now
,„eg->
Ï¡_»ad
) + 1);

287 
off_t
 
wr™e_¿‹
 = 
»g
->
by‹s_wr™‹n
 / (
	`ZERO_OR_DELTA
(
now
,„eg->
Ï¡_wr™e
) + 1);

288 
should_kl
 = 0;

290 
	`debug
("Checking fd=%d:conn_id=%d‡gainst†ast_ping: %d,„ead_rate: %d, write_rate: %d",

291 
i
, 
»g
->
id
, 
Ï¡_pšg
, 
»ad_¿‹
, 
wr™e_¿‹
);

294 if(
mš_pšg
 !ğ0 && 
Ï¡_pšg
 > min_ping) {

295 
	`debug
("Connection fd=%d:conn_id=%d over†imits.min_pingime: %d < %d",

296 
i
, 
»g
->
id
, 
mš_pšg
, 
Ï¡_pšg
);

297 
should_kl
++;

300 if(
mš_»ad_¿‹
 !ğ0 && 
»ad_¿‹
 < min_read_rate) {

301 
	`debug
("Connection fd=%d:conn_id=%d„ead„ate†owerhan‡llowed: %d < %d",

302 
i
, 
»g
->
id
, 
»ad_¿‹
, 
mš_»ad_¿‹
);

303 
should_kl
++;

306 if(
mš_wr™e_¿‹
 !ğ0 && 
wr™e_¿‹
 < min_write_rate) {

307 
	`debug
("Connection fd=%d:conn_id=%d write„ate†owerhan‡llowed: %d < %d",

308 
i
, 
»g
->
id
, 
wr™e_¿‹
, 
mš_wr™e_¿‹
);

309 
should_kl
++;

312 if(
should_kl
 > 
kl_lim™
) {

313 
nkËd
++;

314 
	`Regi¡”_discÚÃù
(
i
);

319 if(
nkËd
) {

320 
	`log_w¬n
("KËd %d cÚÃùiÚ accÜdšgØmš_pšg: %d, mš_wr™e_¿‹: %d, mš_»ad_¿‹: %d", 
nkËd
, 
mš_pšg
, 
mš_wr™e_¿‹
, 
mš_»ad_¿‹
);

323  
nkËd
;

324 
	}
}

	@tools/src/register.h

35 #iâdeà
_»gi¡”_h


36 
	#_»gi¡”_h


	)

38 
	~<time.h
>

39 
	~<¡dšt.h
>

40 
	~<b¡ršg.h
>

41 
	~<sys/ty³s.h
>

43 
	#MAX_REGISTERED_FDS
 64 * 1024

	)

44 
	#DEFAULT_MIN_PING
 120

	)

45 
	#DEFAULT_MIN_READ_RATE
 300

	)

46 
	#DEFAULT_MIN_WRITE_RATE
 300

	)

47 
	#DEFAULT_KILL_LIMIT
 2

	)

50 
ušt32_t
 
THE_CURRENT_TIME_IS
;

52 
	sRegi¡¿tiÚ
 {

53 
CÚÃùiÚ
 *
	md©a
;

54 
ušt16_t
 
	mfd
;

55 
ušt16_t
 
	mid
;

56 
ušt32_t
 
	mÏ¡_pšg
;

57 
off_t
 
	mÏ¡_»ad
;

58 
off_t
 
	mÏ¡_wr™e
;

59 
off_t
 
	mby‹s_»ad
;

60 
off_t
 
	mby‹s_wr™‹n
;

61 } 
	tRegi¡¿tiÚ
;

63 
Regi¡”_cÚÃù
(
fd
, 
CÚÃùiÚ
 *
d©a
);

65 
Regi¡”_discÚÃù
(
fd
);

67 
Regi¡”_pšg
(
fd
);

69 
Regi¡”_»ad
(
fd
, 
off_t
 
by‹s
);

71 
Regi¡”_wr™e
(
fd
, 
off_t
 
by‹s
);

73 
Regi¡”_š™
();

75 
CÚÃùiÚ
 *
Regi¡”_fd_exi¡s
(
fd
);

77 
Regi¡”_id_fÜ_fd
(
fd
);

79 
Regi¡”_fd_fÜ_id
(
id
);

81 
Regi¡”_ş—nout
();

83 
Šs_v®ue_t
 *
Regi¡”_šfo
();

85 
	#Regi¡”_v®id
(
R
è((Rè!ğ
NULL
 && (R)->
d©a
 !ğNULL)

	)

	@tools/src/request.c

35 
	#_XOPEN_SOURCE
 1

	)

37 
	~<¡dlib.h
>

38 
	~<as£¹.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

42 
	~"£‰šg.h
"

43 
	~"»gi¡”.h
"

44 
	~"h—d”s.h
"

45 
	~"adt/hash.h
"

46 
	~"dbg.h
"

47 
	~"»que¡.h
"

48 
	~"Š‘¡ršgs.h
"

50 
	gMAX_HEADER_COUNT
=0;

51 
	gMAX_DUPE_HEADERS
=5;

53 
	$Reque¡_š™
()

55 
MAX_HEADER_COUNT
 = 
	`S‘tšg_g‘_št
("limits.header_count", 128 * 10);

56 
	`log_šfo
("MAX†im™s.h—d”_couÁ=%d", 
MAX_HEADER_COUNT
);

57 
	}
}

60 
hnode_t
 *
	$»q_®loc_hash
(*
nÙu£d
)

62  (
hnode_t
 *)
	`m®loc
((hnode_t));

63 
	}
}

65 
	$»q_ä“_hash
(
hnode_t
 *
node
, *
nÙu£d
)

67 
	`b¡rLi¡De¡roy
((
b¡rLi¡
 *)
	`hnode_g‘
(
node
));

68 
	`bde¡roy
((
b¡ršg
)
	`hnode_g‘key
(
node
));

69 
	`ä“
(
node
);

70 
	}
}

73 
	$»que¡_m‘hod_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

75 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

76 
»q
->
»que¡_m‘hod
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

77 
	}
}

79 
	$äagm’t_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

81 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

82 
»q
->
äagm’t
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

83 
	}
}

85 
	$h‰p_v”siÚ_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

87 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

88 
»q
->
v”siÚ
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

89 
	}
}

92 
	$h—d”_dÚe_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

94 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

97 cÚ¡ *
ş’
 = 
	`bd©a
(
	`Reque¡_g‘
(
»q
, &
HTTP_CONTENT_LENGTH
));

98 if(
ş’
è
»q
->
·r£r
.
cÚ‹Á_Ën
 = 
	`©oi
(clen);

101 
»q
->
ho¡
 = 
	`Reque¡_g‘
Ôeq, &
HTTP_HOST
);

102 
cŞÚ
 = 
	`b¡rchr
(
»q
->
ho¡
, ':');

103 if(
»q
->
ho¡
) {

104 
»q
->
ho¡_Çme
 = 
cŞÚ
 > 0 ? 
	`bH—d
Ôeq->
ho¡
, cŞÚè: 
	`b¡rıy
(req->host);

106 
	}
}

108 
	$uri_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

110 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

111 
»q
->
uri
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

112 
	}
}

114 
	$·th_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

116 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

117 
	`as£¹
(
»q
->
·th
 =ğ
NULL
 && "This should‚ot happen, Tell Zed.");

118 
»q
->
·th
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

119 
	}
}

121 
	$qu”y_¡ršg_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

123 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

124 
»q
->
qu”y_¡ršg
 = 
	`blk2b¡r
(
©
, 
Ëngth
);

125 
	}
}

128 
	$h—d”_f›ld_cb
(*
d©a
, cÚ¡ *
f›ld
, 
size_t
 
æ’
,

129 cÚ¡ *
v®ue
, 
size_t
 
vËn
)

131 
Reque¡
 *
»q
 = (Reque¡ *)
d©a
;

133 if(
	`hash_isfuÎ
(
»q
->
h—d”s
)) {

134 
	`log_”r
("Request had morehan %d headers‡llowed by†imits.header_count.",

135 
MAX_HEADER_COUNT
);

137 
b¡ršg
 
v¡r
 = 
	`blk2b¡r
(
v®ue
, 
vËn
);

138 
b¡ršg
 
f¡r
 = 
	`blk2b¡r
(
f›ld
, 
æ’
);

139 
	`btŞow”
(
f¡r
);

141 
	`Reque¡_£t
(
»q
, 
f¡r
, 
v¡r
, 0);

143 
	}
}

146 
	$Reque¡_£t
(
Reque¡
 *
»q
, 
b¡ršg
 
key
, b¡ršg 
v®
, 
»¶aû
)

148 
hnode_t
 *
n
 = 
	`hash_lookup
(
»q
->
h—d”s
, 
key
);

149 
b¡rLi¡
 *
v®_li¡
 = 
NULL
;

150 
rc
 = 0;

151 
i
 = 0;

153 if(
n
 =ğ
NULL
) {

155 
v®_li¡
 = 
	`b¡rLi¡C»©e
();

156 
rc
 = 
	`b¡rLi¡AÎoc
(
v®_li¡
, 
MAX_DUPE_HEADERS
);

157 
	`check
(
rc
 =ğ
BSTR_OK
, "Couldn't‡llocate space for header values.");

159 
v®_li¡
->
’Œy
[0] = 
v®
;

160 
v®_li¡
->
qty
 = 1;

161 
	`hash_®loc_š£¹
(
»q
->
h—d”s
, 
key
, 
v®_li¡
);

163 
v®_li¡
 = 
	`hnode_g‘
(
n
);

164 
	`bde¡roy
(
key
);

166 if(
»¶aû
) {

168 
i
 = 0; i < 
v®_li¡
->
qty
; i++) {

169 
	`bde¡roy
(
v®_li¡
->
’Œy
[
i
]);

172 
v®_li¡
->
’Œy
[0] = 
v®
;

173 
v®_li¡
->
qty
 = 1;

175 
	`check
(
v®_li¡
->
qty
 < 
MAX_DUPE_HEADERS
,

177 
	`bd©a
(
key
), 
MAX_DUPE_HEADERS
);

179 
v®_li¡
->
’Œy
[v®_li¡->
qty
++] = 
v®
;

183 
”rÜ
: ;

184 
	}
}

186 
Reque¡
 *
	$Reque¡_ü—‹
()

188 
Reque¡
 *
»q
 = 
	`ÿÎoc
((Request), 1);

189 
	`check_mem
(
»q
);

191 
»q
->
·r£r
.
h‰p_f›ld
 = 
h—d”_f›ld_cb
;

192 
»q
->
·r£r
.
»que¡_m‘hod
 = 
»que¡_m‘hod_cb
;

193 
»q
->
·r£r
.
»que¡_uri
 = 
uri_cb
;

194 
»q
->
·r£r
.
äagm’t
 = 
äagm’t_cb
;

195 
»q
->
·r£r
.
»que¡_·th
 = 
·th_cb
;

196 
»q
->
·r£r
.
qu”y_¡ršg
 = 
qu”y_¡ršg_cb
;

197 
»q
->
·r£r
.
h‰p_v”siÚ
 = 
h‰p_v”siÚ_cb
;

198 
»q
->
·r£r
.
h—d”_dÚe
 = 
h—d”_dÚe_cb
;

200 
»q
->
h—d”s
 = 
	`hash_ü—‹
(
MAX_HEADER_COUNT
, (
hash_comp_t
)
b¡rcmp
, 
b¡r_hash_fun
);

201 
	`check_mem
(
»q
->
h—d”s
);

202 
	`hash_£t_®loÿtÜ
(
»q
->
h—d”s
, 
»q_®loc_hash
, 
»q_ä“_hash
, 
NULL
);

204 
»q
->
·r£r
.
d©a
 =„eq;

206  
»q
;

208 
”rÜ
:

209 
	`Reque¡_de¡roy
(
»q
);

210  
NULL
;

211 
	}
}

213 
šlše
 
	$Reque¡_nuke_·¹s
(
Reque¡
 *
»q
)

215 
	`bde¡roy
(
»q
->
»que¡_m‘hod
);„eq->»que¡_m‘hod = 
NULL
;

216 
	`bde¡roy
(
»q
->
v”siÚ
);„eq->v”siÚ = 
NULL
;

217 
	`bde¡roy
(
»q
->
uri
);„eq->ur˜ğ
NULL
;

218 
	`bde¡roy
(
»q
->
·th
);„eq->·th = 
NULL
;

219 
	`bde¡roy
(
»q
->
qu”y_¡ršg
);„eq->qu”y_¡ršg = 
NULL
;

220 
	`bde¡roy
(
»q
->
äagm’t
);„eq->äagm’ˆğ
NULL
;

221 
	`bde¡roy
(
»q
->
ho¡_Çme
);„eq->ho¡_Çmğ
NULL
;

224 
»q
->
·‰”n
 = 
NULL
;

225 
»q
->
´efix
 = 
NULL
;

226 
»q
->
ho¡
 = 
NULL
;

228 
»q
->
¡©us_code
 = 0;

229 
»q
->
»¥Ú£_size
 = 0;

230 
»q
->
·r£r
.
jsÚ_£Á
 = 0;

231 
»q
->
·r£r
.
xml_£Á
 = 0;

232 
	}
}

234 
	$Reque¡_de¡roy
(
Reque¡
 *
»q
)

236 if(
»q
) {

237 
	`Reque¡_nuke_·¹s
(
»q
);

238 
	`hash_ä“_nodes
(
»q
->
h—d”s
);

239 
	`hash_de¡roy
(
»q
->
h—d”s
);

240 
	`ä“
(
»q
);

242 
	}
}

245 
	$Reque¡_¡¬t
(
Reque¡
 *
»q
)

247 
	`as£¹
(
»q
 && "NULL…ointerƒrror.");

248 
	`h‰p_·r£r_š™
(&(
»q
->
·r£r
));

250 
	`Reque¡_nuke_·¹s
(
»q
);

252 if(
»q
->
h—d”s
) {

253 
	`hash_ä“_nodes
(
»q
->
h—d”s
);

255 
	}
}

257 
	$Reque¡_·r£
(
Reque¡
 *
»q
, *
buf
, 
size_t
 
Ä—d
, size_ˆ*
out_Å¬£d
)

259 
	`as£¹
(
»q
 && "NULL…ointerƒrror.");

261 *
out_Å¬£d
 = 
	`h‰p_·r£r_execu‹
(&(
»q
->
·r£r
), 
buf
, 
Ä—d
, *out_nparsed);

263 
fšished
 = 
	`h‰p_·r£r_fšish
(&(
»q
->
·r£r
));

265  
fšished
;

266 
	}
}

269 
b¡ršg
 
	$Reque¡_g‘
(
Reque¡
 *
»q
, 
b¡ršg
 
f›ld
)

271 
hnode_t
 *
node
 = 
	`hash_lookup
(
»q
->
h—d”s
, 
f›ld
);

272 
b¡rLi¡
 *
v®s
 = 
NULL
;

274 if(
node
 =ğ
NULL
) {

275  
NULL
;

277 
v®s
 = 
	`hnode_g‘
(
node
);

278  
v®s
->
’Œy
[0];

280 
	}
}

283 
	$Reque¡_g‘_d©e
(
Reque¡
 *
»q
, 
b¡ršg
 
f›ld
, cÚ¡ *
fÜm©
)

285 
tm
 
tm_v®
;

286 
b¡ršg
 
v®ue
 = 
	`Reque¡_g‘
(
»q
, 
f›ld
);

288 if(
v®ue
) {

289 
	`mem£t
(&
tm_v®
, 0, (
tm
));

290 if(
	`¡½time
(
	`bd©a
(
v®ue
), 
fÜm©
, &
tm_v®
è=ğ
NULL
) {

293  ()
	`mktime
(&
tm_v®
);

298 
	}
}

300 
šlše
 
b¡ršg
 
	$jsÚ_esÿ³
(
b¡ršg
 
š
)

302 if(
š
 =ğ
NULL
)  NULL;

305 
b¡ršg
 
v¡r
 = 
	`b¡rıy
(
š
);

307 
i
;

308 
i
 = 0; i < 
	`bËngth
(
v¡r
); i++)

310 if(
	`bd©a
(
v¡r
)[
i
] == '\\')

312 
	`bš£¹ch
(
v¡r
, 
i
, 1, '\\');

313 
i
++;

315 if(
	`bd©a
(
v¡r
)[
i
] == '"')

317 
	`bš£¹ch
(
v¡r
, 
i
, 1, '\\');

318 
i
++;

322  
v¡r
;

323 
	}
}

325 
gb¡ršg
 
	gJSON_LISTSEP
 = 
bsStic
("\",\"");

326 
gb¡ršg
 
	gJSON_OBJSEP
 = 
bsStic
("\":\"");

329 cÚ¡ 
	gPAYLOAD_GUESS
 = 256;

331 
šlše
 
	$B
(
b¡ršg
 
h—d”s
, cÚ¡ b¡ršg 
k
, cÚ¡ b¡ršg 
v
)

333 if(
v
)

335 
	`bÿtc¡r
(
h—d”s
, ",\"");

336 
	`bcÚÿt
(
h—d”s
, 
k
);

337 
	`bcÚÿt
(
h—d”s
, &
JSON_OBJSEP
);

339 
b¡ršg
 
v¡r
 = 
	`jsÚ_esÿ³
(
v
);

340 
	`bcÚÿt
(
h—d”s
, 
v¡r
);

341 
	`bÿtc¡r
(
h—d”s
, "\"");

343 
	`bde¡roy
(
v¡r
);

345 
	}
}

347 
šlše
 
b¡ršg
 
	$»que¡_d‘”mše_m‘hod
(
Reque¡
 *
»q
)

349 if(
	`Reque¡_is_jsÚ
(
»q
)) {

350  &
JSON_METHOD
;

351 } if(
	`Reque¡_is_xml
(
»q
)) {

352  &
XML_METHOD
;

354  
»q
->
»que¡_m‘hod
;

356 
	}
}

358 
b¡ršg
 
	$Reque¡_to_Š‘¡ršg
(
Reque¡
 *
»q
, 
b¡ršg
 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
)

360 
Šs_outbuf
 
outbuf
 = {.
bufãr
 = 
NULL
};

361 
b¡ršg
 
m‘hod
 = 
	`»que¡_d‘”mše_m‘hod
(
»q
);

362 
	`check
(
m‘hod
, "Impossible, got‡n invalid„equest method.");

364 
id
 = 
	`Regi¡”_id_fÜ_fd
(
fd
);

365 
	`check
(
id
 !ğ-1, "AskedØg’”©¨·ylßd fÜ‡ fdh© dÛ¢'ˆexi¡: %d", 
fd
);

367 
h—d”_¡¬t
 = 
	`Šs_»nd”_»que¡_¡¬t
(&
outbuf
);

368 
	`check
(
h—d”_¡¬t
 != -1, "Failedo initialize outbuf.");

370 
	`check
(
	`Šs_»nd”_»que¡_h—d”s
(&
outbuf
, 
»q
->
h—d”s
) == 0,

373 if(
»q
->
·th
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_PATH
,„eq->path);

374 if(
»q
->
v”siÚ
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_VERSION
,„eq->version);

375 if(
»q
->
uri
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_URI
,„eq->uri);

376 if(
»q
->
qu”y_¡ršg
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_QUERY
,„eq->query_string);

377 if(
»q
->
äagm’t
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_FRAGMENT
,„eq->fragment);

378 if(
»q
->
·‰”n
è
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_PATTERN
,„eq->pattern);

380 
	`Šs_»nd”_hash_·œ
(&
outbuf
, &
HTTP_METHOD
, 
m‘hod
);

382 
	`check
(
	`Šs_»nd”_»que¡_’d
(&
outbuf
, 
h—d”_¡¬t
, 
uuid
, 
id
, 
	`Reque¡_·th
(
»q
)) != -1, "Failedo finalize„equest.");

385 
b¡ršg
 
h—d”s
 = 
	`Šs_outbuf_to_b¡ršg
(&
outbuf
);

386 
	`bfÜm©a
(
h—d”s
, "%d:", 
Ën
);

387 
	`bÿtblk
(
h—d”s
, 
buf
, 
Ën
);

388 
	`bcÚch¬
(
h—d”s
, ',');

390  
h—d”s
;

391 
”rÜ
:

392 if(
outbuf
.
bufãr
è
	`ä“
(outbuf.buffer);

393  
NULL
;

394 
	}
}

396 
b¡ršg
 
	$Reque¡_to_·ylßd
(
Reque¡
 *
»q
, 
b¡ršg
 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
)

398 
b¡ršg
 
h—d”s
 = 
NULL
;

399 
b¡ršg
 
»suÉ
 = 
NULL
;

401 
id
 = 
	`Regi¡”_id_fÜ_fd
(
fd
);

402 
	`check
(
id
 !ğ-1, "AskedØg’”©¨·ylßd fÜ‡ fdh© dÛ¢'ˆexi¡: %d", 
fd
);

404 
h—d”s
 = 
	`bäomc¡¿Îoc
(
PAYLOAD_GUESS
, "{\"");

405 
	`bcÚÿt
(
h—d”s
, &
HTTP_PATH
);

406 
	`bcÚÿt
(
h—d”s
, &
JSON_OBJSEP
);

407 
	`bcÚÿt
(
h—d”s
, 
»q
->
·th
);

408 
	`bcÚch¬
(
h—d”s
, '"');

410 
hsÿn_t
 
sÿn
;

411 
hnode_t
 *
i
;

412 
	`hash_sÿn_begš
(&
sÿn
, 
»q
->
h—d”s
);

413 
i
 = 
	`hash_sÿn_Ãxt
(&
sÿn
); i !ğ
NULL
; i = hash_scan_next(&scan))

415 
b¡rLi¡
 *
v®_li¡
 = 
	`hnode_g‘
(
i
);

416 
b¡ršg
 
key
 = (b¡ršg)
	`hnode_g‘key
(
i
);

418 if(
v®_li¡
->
qty
 > 1)

420 
b¡rLi¡
 *
esÿ³d
 = 
	`b¡rLi¡C»©e
();

421 
	`b¡rLi¡AÎoc
(
esÿ³d
, 
v®_li¡
->
qty
);

422 
esÿ³d
->
qty
 = 
v®_li¡
->qty;

424 
x
 = 0;

425 
x
 = 0; x < 
v®_li¡
->
qty
; x++) {

426 
esÿ³d
->
’Œy
[
x
] = 
	`jsÚ_esÿ³
(
v®_li¡
->entry[x]);

429 
b¡ršg
 
li¡
 = 
	`bjoš
(
esÿ³d
, &
JSON_LISTSEP
);

430 
	`bÿtc¡r
(
h—d”s
, ",\"");

431 
	`bcÚÿt
(
h—d”s
, 
key
);

432 
	`bÿtc¡r
(
h—d”s
, "\":[\"");

433 
	`bcÚÿt
(
h—d”s
, 
li¡
);

434 
	`bÿtc¡r
(
h—d”s
, "\"]");

435 
	`bde¡roy
(
li¡
);

436 
	`b¡rLi¡De¡roy
(
esÿ³d
);

440 
	`B
(
h—d”s
, 
key
, 
v®_li¡
->
’Œy
[0]);

447 if(
	`Reque¡_is_jsÚ
(
»q
)) {

448 
	`B
(
h—d”s
, &
HTTP_METHOD
, &
JSON_METHOD
);

449 } if(
	`Reque¡_is_xml
(
»q
)) {

450 
	`B
(
h—d”s
, &
HTTP_METHOD
, &
XML_METHOD
);

452 
	`B
(
h—d”s
, &
HTTP_METHOD
, 
»q
->
»que¡_m‘hod
);

455 
	`B
(
h—d”s
, &
HTTP_VERSION
, 
»q
->
v”siÚ
);

456 
	`B
(
h—d”s
, &
HTTP_URI
, 
»q
->
uri
);

457 
	`B
(
h—d”s
, &
HTTP_QUERY
, 
»q
->
qu”y_¡ršg
);

458 
	`B
(
h—d”s
, &
HTTP_FRAGMENT
, 
»q
->
äagm’t
);

459 
	`B
(
h—d”s
, &
HTTP_PATTERN
, 
»q
->
·‰”n
);

461 
	`bcÚch¬
(
h—d”s
, '}');

463 
»suÉ
 = 
	`bfÜm©
("% %d % %d:%s,%d:", 
	`bd©a
(
uuid
), 
id
,

464 
	`bd©a
(
	`Reque¡_·th
(
»q
)),

465 
	`bËngth
(
h—d”s
),

466 
	`bd©a
(
h—d”s
),

467 
Ën
);

469 
	`bde¡roy
(
h—d”s
);

471 
	`bÿtblk
(
»suÉ
, 
buf
, 
Ën
);

472 
	`bcÚch¬
(
»suÉ
, ',');

474 
	`check
(
»suÉ
, "Failedo construct…ayload„esult.");

476  
»suÉ
;

478 
”rÜ
:

479 
	`bde¡roy
(
h—d”s
);

480 
	`bde¡roy
(
»suÉ
);

482  
NULL
;

483 
	}
}

	@tools/src/request.h

35 #iâdeà
_»que¡_h


36 
	#_»que¡_h


	)

38 
	~<h‰p11/h‰p11_·r£r.h
>

39 
	~<adt/hash.h
>

40 
	~<b¡ršg.h
>

41 
	~<hªdËr.h
>

42 
	~<h—d”s.h
>

43 
	~<ho¡.h
>

46 
	mREQUEST_EXTRA_HEADERS
 = 6

49 
	sReque¡
 {

50 
b¡ršg
 
	m»que¡_m‘hod
;

51 
b¡ršg
 
	mv”siÚ
;

52 
b¡ršg
 
	muri
;

53 
b¡ršg
 
	m·th
;

54 
b¡ršg
 
	mqu”y_¡ršg
;

55 
b¡ršg
 
	mäagm’t
;

56 
b¡ršg
 
	mho¡
;

57 
b¡ršg
 
	mho¡_Çme
;

58 
b¡ršg
 
	m·‰”n
;

59 
b¡ršg
 
	m´efix
;

60 
Ho¡
 *
	mrg‘_ho¡
;

61 
hash_t
 *
	mh—d”s
;

62 
Back’d
 *
	maùiÚ
;

63 
	m¡©us_code
;

64 
	m»¥Ú£_size
;

65 
h‰p_·r£r
 
	m·r£r
;

66 } 
	tReque¡
;

68 
Reque¡
 *
Reque¡_ü—‹
();

70 
Reque¡_·r£
(
Reque¡
 *
»q
, *
buf
, 
size_t
 
Ä—d
, size_ˆ*
out_Å¬£d
);

72 
Reque¡_¡¬t
(
Reque¡
 *
»q
);

74 
Reque¡_de¡roy
(
Reque¡
 *
»q
);

76 
b¡ršg
 
Reque¡_g‘
(
Reque¡
 *
»q
, b¡ršg 
f›ld
);

78 
Reque¡_£t
(
Reque¡
 *
»q
, 
b¡ršg
 
key
, b¡ršg 
v®
, 
»¶aû
);

80 
Reque¡_g‘_d©e
(
Reque¡
 *
»q
, 
b¡ršg
 
f›ld
, cÚ¡ *
fÜm©
);

82 
	#Reque¡_·r£r
(
R
è(&((R)->
·r£r
))

	)

84 
	#Reque¡_is_jsÚ
(
R
è((R)->
·r£r
.
jsÚ_£Á
 =ğ1)

	)

86 
	#Reque¡_is_xml
(
R
è((R)->
·r£r
.
xml_£Á
 =ğ1)

	)

88 
	#Reque¡_is_h‰p
(
R
è(!(
	`Reque¡_is_jsÚ
(Rè|| 
	`Reque¡_is_xml
(R)))

	)

90 
	#Reque¡_g‘_aùiÚ
(
R
, 
T
è((R)->
aùiÚ
 ? (R)->aùiÚ->
rg‘
.T : 
NULL
)

	)

92 
	#Reque¡_£t_aùiÚ
(
R
, 
V
è((R)->
aùiÚ
 = (V))

	)

94 
	#Reque¡_·th
(
R
è((R)->
·th
)

	)

96 
	#Reque¡_cÚ‹Á_Ëngth
(
R
è((R)->
·r£r
.
cÚ‹Á_Ën
)

	)

98 
	#Reque¡_h—d”_Ëngth
(
R
è((R)->
·r£r
.
body_¡¬t
)

	)

100 
b¡ršg
 
Reque¡_to_Š‘¡ršg
(
Reque¡
 *
»q
, b¡ršg 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
);

102 
b¡ršg
 
Reque¡_to_·ylßd
(
Reque¡
 *
»q
, b¡ršg 
uuid
, 
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
);

104 
Reque¡_š™
();

	@tools/src/response.c

36 
	~<»¥Ú£.h
>

37 
	~<sk/sk.h
>

38 
	~<dbg.h
>

39 
	~<as£¹.h
>

40 
	~"v”siÚ.h
"

45 
gb¡ršg
 
	gHTTP_400
 = 
bsStic
("HTTP/1.1 400 Bad Request\r\n"

49 "S”v”: " 
VERSION


53 
gb¡ršg
 
	gHTTP_404
 = 
bsStic
("HTTP/1.1 404 Not Found\r\n"

57 "S”v”: " 
VERSION


62 
gb¡ršg
 
	gHTTP_413
 = 
bsStic
("HTTP/1.1 413 Request Entity Too Large\r\n"

66 "S”v”: " 
VERSION


70 
gb¡ršg
 
	gHTTP_501
 = 
bsStic
("HTTP/1.1 501 Not Implemented\r\n"

74 "S”v”: " 
VERSION


78 
gb¡ršg
 
	gHTTP_502
 = 
bsStic
("HTTP/1.1 502 Bad Gateway\r\n"

82 "S”v”: " 
VERSION


86 
gb¡ršg
 
	gHTTP_500
 = 
bsStic
("HTTP/1.1 500 Internal Server Error\r\n"

90 "S”v”: " 
VERSION


94 
gb¡ršg
 
	gHTTP_405
 = 
bsStic
("HTTP/1.1 405 Method Not Allowed\r\n"

98 "S”v”: " 
VERSION


103 
gb¡ršg
 
	gHTTP_412
 = 
bsStic
("HTTP/1.1 412 Precondition Failed\r\n"

107 "S”v”: " 
VERSION


112 
gb¡ršg
 
	gHTTP_304
 = 
bsStic
("HTTP/1.1 304 Not Modified\r\n"

115 "S”v”: " 
VERSION


119 
gb¡ršg
 
	gFLASH_RESPONSE
 = 
bsStic
("<?xml version=\"1.0\"?>"

124 
	$Re¥Ú£_£nd_¡©us
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
”rÜ
)

126  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(
”rÜ
), 
	`bËngth
(error));

127 
	}
}

130 
	$Re¥Ú£_£nd_sock‘_pŞicy
(
CÚÃùiÚ
 *
cÚn
)

133  
	`IOBuf_£nd
(
cÚn
->
iob
, 
	`bd©a
(&
FLASH_RESPONSE
),

134 
	`bËngth
(&
FLASH_RESPONSE
) + 1);

136 
	}
}

	@tools/src/response.h

35 #iâdeà
_»¥Ú£_h


36 
	#_»¥Ú£_h


	)

38 
	~<b¡ršg.h
>

39 
	~<cÚÃùiÚ.h
>

41 
gb¡ršg
 
HTTP_304
;

42 
gb¡ršg
 
HTTP_400
;

43 
gb¡ršg
 
HTTP_404
;

44 
gb¡ršg
 
HTTP_405
;

45 
gb¡ršg
 
HTTP_412
;

46 
gb¡ršg
 
HTTP_413
;

47 
gb¡ršg
 
HTTP_500
;

48 
gb¡ršg
 
HTTP_501
;

49 
gb¡ršg
 
HTTP_502
;

51 
gb¡ršg
 
FLASH_RESPONSE
;

53 
Re¥Ú£_£nd_¡©us
(
CÚÃùiÚ
 *
cÚn
, 
b¡ršg
 
”rÜ
);

55 
Re¥Ú£_£nd_sock‘_pŞicy
(
CÚÃùiÚ
 *
cÚn
);

	@tools/src/routing.c

35 
	~<routšg.h
>

36 
	~<dbg.h
>

37 
	~<¡ršg.h
>

38 
	~<as£¹.h
>

39 
	~<·‰”n.h
>

40 
	~<ho¡.h
>

41 
	~<mem/h®loc.h
>

42 
	~<b¡ršg.h
>

46 
Rou‹M­
 *
	$Rou‹M­_ü—‹
(
rou‹m­_de¡roy_cb
 
de¡roy
)

48 
Rou‹M­
 *
m­
 = 
	`h_ÿÎoc
((RouteMap), 1);

49 
	`check_mem
(
m­
);

51 
m­
->
de¡roy
 = destroy;

53  
m­
;

55 
”rÜ
:

56  
NULL
;

57 
	}
}

59 
	$Rou‹M­_ş—nup
(*
v®ue
, *
d©a
)

61 
Rou‹
 *
rou‹
 = (Rou‹ *)
v®ue
;

62 
Rou‹M­
 *
m­
 = (Rou‹M­ *)
d©a
;

64 if(
m­
->
de¡roy
) {

65 
m­
->
	`de¡roy
(
rou‹
, map);

68 
	`bde¡roy
(
rou‹
->
·‰”n
);

69 
	`bde¡roy
(
rou‹
->
´efix
);

70 
	}
}

72 
	$Rou‹M­_de¡roy
(
Rou‹M­
 *
m­
)

74 if(
m­
) {

75 
	`t¡_Œav”£
(
m­
->
rou‹s
, 
Rou‹M­_ş—nup
, map);

76 
	`t¡_de¡roy
(
m­
->
rou‹s
);

77 
	`h_ä“
(
m­
);

79 
	}
}

81 
Rou‹
 *
	$Rou‹M­_š£¹_ba£
(
Rou‹M­
 *
m­
, 
b¡ršg
 
´efix
, b¡ršg 
·‰”n
)

83 
Rou‹
 *
rou‹
 = 
	`h_m®loc
((Route));

84 
	`check_mem
(
rou‹
);

86 
rou‹
->
·‰”n
 =…attern;

87 
	`check
(
rou‹
->
·‰”n
, "Pattern is„equired.");

89 
rou‹
->
´efix
 =…refix;

90 
	`check
(
rou‹
->
´efix
, "Prefix is„equired.");

92 
	`debug
("ADDING…»fix: %s,…©‹º: %s", 
	`bd©a
(
´efix
), bd©a(
·‰”n
));

94 
m­
->
rou‹s
 = 
	`t¡_š£¹
(m­->rou‹s, 
	`bd©a
(
´efix
), 
	`bËngth
Õ»fix), 
rou‹
);

96 
	`h©ch
(
rou‹
, 
m­
);

98 
	`check
(
m­
->
rou‹s
, "Failedo insert into TST.");

100  
rou‹
;

102 
”rÜ
:

103  
NULL
;

104 
	}
}

106 
	$Rou‹M­_š£¹
(
Rou‹M­
 *
m­
, 
b¡ršg
 
·‰”n
, *
d©a
)

108 
Rou‹
 *
rou‹
 = 
NULL
;

109 
fœ¡_·»n
 = 
	`b¡rchr
(
·‰”n
, '(');

110 
b¡ršg
 
´efix
 = 
NULL
;

112 if(
fœ¡_·»n
 >= 0) {

113 
´efix
 = 
	`bH—d
(
·‰”n
, 
fœ¡_·»n
);

115 
´efix
 = 
	`b¡rıy
(
·‰”n
);

118 
	`check_mem
(
´efix
);

121 
rou‹
 = 
	`Rou‹M­_š£¹_ba£
(
m­
, 
´efix
, 
·‰”n
);

122 
	`check
(
rou‹
, "FaedØš£¹„ou‹: %s", 
	`bd©a
(
·‰”n
));

125 
rou‹
->
has_·‰”n
 = 
fœ¡_·»n
 >= 0;

126 
rou‹
->
fœ¡_·»n
 = first_paren;

127 
rou‹
->
d©a
 = data;

131 
”rÜ
:

133 
	}
}

135 
	$Rou‹M­_š£¹_»v”£d
(
Rou‹M­
 *
m­
, 
b¡ršg
 
·‰”n
, *
d©a
)

137 
Rou‹
 *
rou‹
 = 
NULL
;

138 
b¡ršg
 
»v”£d_´efix
 = 
NULL
;

140 
Ï¡_·»n
 = 
	`b¡¼chr
(
·‰”n
, ')');

142 if(
Ï¡_·»n
 >= 0) {

143 
»v”£d_´efix
 = 
	`bTa
(
·‰”n
, 
	`bËngth
Õ©‹ºè- 
Ï¡_·»n
 - 1);

145 
»v”£d_´efix
 = 
	`b¡rıy
(
·‰”n
);

148 
	`check_mem
(
»v”£d_´efix
);

149 
	`bRev”£
(
»v”£d_´efix
);

152 
rou‹
 = 
	`Rou‹M­_š£¹_ba£
(
m­
, 
»v”£d_´efix
, 
·‰”n
);

153 
	`check
(
rou‹
, "Failedo‡dd host.");

155 
rou‹
->
has_·‰”n
 = 
Ï¡_·»n
 >= 0;

156 
rou‹
->
´efix
 = 
»v”£d_´efix
;

157 
rou‹
->
d©a
 = data;

161 
”rÜ
:

163 
	}
}

166 
	$Rou‹M­_cŞËù_m©ch
(*
v®ue
, cÚ¡ *
key
, 
size_t
 
Ën
)

168 
	`as£¹
(
v®ue
 && "NULL value from TST.");

169 
Rou‹
 *
rou‹
 = (Rou‹ *)
v®ue
;

171 if(
rou‹
->
has_·‰”n
) {

172  
	`·‰”n_m©ch
(
key
 + 
rou‹
->
fœ¡_·»n
,

173 
Ën
 - 
rou‹
->
fœ¡_·»n
,

174 
	`bd©aofs
(
rou‹
->
·‰”n
,„ou‹->
fœ¡_·»n
)è!ğ
NULL
;

178 
	}
}

180 
li¡_t
 *
	$Rou‹M­_m©ch
(
Rou‹M­
 *
m­
, 
b¡ršg
 
·th
)

182  
	`t¡_cŞËù
(
m­
->
rou‹s
, 
	`bd©a
(
·th
),

183 
	`bËngth
(
·th
), 
Rou‹M­_cŞËù_m©ch
);

184 
	}
}

186 
šlše
 
Rou‹
 *
	$m©ch_rou‹_·‰”n
(
b¡ršg
 
rg‘
, 
Rou‹
 *
rou‹
)

188 cÚ¡ *
sourû
 = 
	`bd©aofs
(
rg‘
, 
	`bËngth
(
rou‹
->
´efix
));

189 
sourû_Ëngth
 = 
	`bËngth
(
rg‘
è- bËngth(
rou‹
->
´efix
);

190 cÚ¡ *
·‰”n
 = 
	`bd©aofs
(
rou‹
->·‰”n,„ou‹->
fœ¡_·»n
);

192  
	`·‰”n_m©ch
(
sourû
, 
sourû_Ëngth
, 
·‰”n
è? 
rou‹
 : 
NULL
;

193 
	}
}

195 
Rou‹
 *
	$Rou‹M­_m©ch_suffix
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
)

197 
Rou‹
 *
rou‹
 = 
	`t¡_£¬ch_suffix
(
m­
->
rou‹s
, 
	`bd©a
(
rg‘
), 
	`bËngth
(target));

199 if(
rou‹
) {

200 
	`debug
("Found sim¶suffix: %s", 
	`bd©a
(
rou‹
->
·‰”n
));

202 if(
rou‹
->
has_·‰”n
) {

203  
	`m©ch_rou‹_·‰”n
(
rg‘
, 
rou‹
);

205  
rou‹
;

208  
NULL
;

210 
	}
}

213 
Rou‹
 *
	$Rou‹M­_sim¶e_´efix_m©ch
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
)

215 
	`debug
("S—rchšg fÜ„ou‹: % š m­: %p", 
	`bd©a
(
rg‘
), 
m­
);

216 
Rou‹
 *
rou‹
 = 
	`t¡_£¬ch_´efix
(
m­
->
rou‹s
, 
	`bd©a
(
rg‘
), 
	`bËngth
(target));

218 if(
rou‹
) {

219 
	`debug
("Found sim¶´efix: %s", 
	`bd©a
(
rou‹
->
·‰”n
));

221 if(
rou‹
->
has_·‰”n
) {

222  
	`m©ch_rou‹_·‰”n
(
rg‘
, 
rou‹
);

224  
rou‹
;

227  
NULL
;

229 
	}
}

	@tools/src/routing.h

35 #iâdeà
_routšg_h


36 
	#_routšg_h


	)

38 
	~<adt/t¡.h
>

39 
	~<¡dlib.h
>

40 
	~<adt/li¡.h
>

41 
	~<b¡ršg.h
>

43 
	sRou‹
 {

44 
b¡ršg
 
	m·‰”n
;

45 
b¡ršg
 
	m´efix
;

46 *
	md©a
;

47 
	mhas_·‰”n
;

48 
	mfœ¡_·»n
;

49 } 
	tRou‹
;

51 
	gRou‹M­
;

53 (*
	trou‹m­_de¡roy_cb
)(
	tRou‹
 *
	trou‹
, 
	tRou‹M­
 *
	tm­
);

55 
	sRou‹M­
 {

56 
t¡_t
 *
rou‹s
;

57 
rou‹m­_de¡roy_cb
 
de¡roy
;

58 } 
	tRou‹M­
;

60 
Rou‹M­
 *
	`Rou‹M­_ü—‹
(
rou‹m­_de¡roy_cb
 
de¡roy
);

62 
	`Rou‹M­_de¡roy
(
Rou‹M­
 *
m­
);

64 
	`Rou‹M­_š£¹
(
Rou‹M­
 *
rou‹s
, 
b¡ršg
 
·‰”n
, *
d©a
);

66 
li¡_t
 *
	`Rou‹M­_m©ch
(
Rou‹M­
 *
rou‹s
, 
b¡ršg
 
·th
);

68 
	`Rou‹M­_š£¹_»v”£d
(
Rou‹M­
 *
rou‹s
, 
b¡ršg
 
·‰”n
, *
d©a
);

70 
Rou‹
 *
	`Rou‹M­_m©ch_suffix
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
);

72 
Rou‹
 *
	`Rou‹M­_sim¶e_´efix_m©ch
(
Rou‹M­
 *
m­
, 
b¡ršg
 
rg‘
);

	@tools/src/server.c

35 
	~"dbg.h
"

36 
	~"sk/sk.h
"

37 
	~"cÚÃùiÚ.h
"

38 
	~"»gi¡”.h
"

39 
	~"£rv”.h
"

40 
	~"ho¡.h
"

41 
	~<as£¹.h
>

42 
	~<¡ršg.h
>

43 
	~"mem/h®loc.h
"

44 
	~"routšg.h
"

45 
	~"£‰šg.h
"

46 
	~"·‰”n.h
"

47 
	~"cÚfig/cÚfig.h
"

48 
	~<sigÇl.h
>

50 
	gRUNNING
=1;

52 *
	gs¦_deçuÉ_dhm_P
 =

62 *
	gs¦_deçuÉ_dhm_G
 = "4";

64 
	$ho¡_de¡roy_cb
(
Rou‹
 *
r
, 
Rou‹M­
 *
m­
)

66 if(
r
->
d©a
) {

67 
	`Ho¡_de¡roy
((
Ho¡
 *)
r
->
d©a
);

68 
r
->
d©a
 = 
NULL
;

70 
	}
}

72 
	$S”v”_lßd_ch”s
(
S”v”
 *
¤v
, 
b¡ršg
 
s¦_ch”s_v®
)

74 
b¡rLi¡
 *
s¦_ch”_li¡
 = 
	`b¥l™
(
s¦_ch”s_v®
, ' ');

75 
i
 = 0;

76 
max_num_ch”s
 = 0;

77 *
ch”s
 = 
NULL
;

79 
	`check
(
s¦_ch”_li¡
 !ğ
NULL
 && s¦_ch”_li¡->
qty
 > 0,

83 
s¦_deçuÉ_ch”s
[
max_num_ch”s
] != 0) {

84 
max_num_ch”s
++;

87 
ch”s
 = 
	`h_ÿÎoc
(
max_num_ch”s
 + 1, ());

88 
	`check_mem
(
ch”s
);

90 
i
 = 0; i < 
s¦_ch”_li¡
->
qty
; i++) {

91 
b¡ršg
 
ch”
 = 
s¦_ch”_li¡
->
’Œy
[
i
];

93 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_RC4_128_MD5"))

94 
ch”s
[
i
] = 
SSL_RSA_RC4_128_MD5
;

95 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_RC4_128_SHA"))

96 
ch”s
[
i
] = 
SSL_RSA_RC4_128_SHA
;

97 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_DES_168_SHA"))

98 
ch”s
[
i
] = 
SSL_RSA_DES_168_SHA
;

99 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_DES_168_SHA"))

100 
ch”s
[
i
] = 
SSL_EDH_RSA_DES_168_SHA
;

101 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_AES_128_SHA"))

102 
ch”s
[
i
] = 
SSL_RSA_AES_128_SHA
;

103 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_AES_128_SHA"))

104 
ch”s
[
i
] = 
SSL_EDH_RSA_AES_128_SHA
;

105 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_AES_256_SHA"))

106 
ch”s
[
i
] = 
SSL_RSA_AES_256_SHA
;

107 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_AES_256_SHA"))

108 
ch”s
[
i
] = 
SSL_EDH_RSA_AES_256_SHA
;

109 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_CAMELLIA_128_SHA"))

110 
ch”s
[
i
] = 
SSL_RSA_CAMELLIA_128_SHA
;

111 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_CAMELLIA_128_SHA"))

112 
ch”s
[
i
] = 
SSL_EDH_RSA_CAMELLIA_128_SHA
;

113 if(
	`bi£qc¡r
(
ch”
, "SSL_RSA_CAMELLIA_256_SHA"))

114 
ch”s
[
i
] = 
SSL_RSA_CAMELLIA_256_SHA
;

115 if(
	`bi£qc¡r
(
ch”
, "SSL_EDH_RSA_CAMELLIA_256_SHA"))

116 
ch”s
[
i
] = 
SSL_EDH_RSA_CAMELLIA_256_SHA
;

118 
	`£Áš–
("UÄecognized ch”: %s", 
	`bd©a
(
ch”
));

121 
	`b¡rLi¡De¡roy
(
s¦_ch”_li¡
);

122 
ch”s
[
i
] = 0;

123 
¤v
->
ch”s
 = ciphers;

124 
	`h©ch
(
ch”s
, 
¤v
);

127 
”rÜ
:

128 if(
s¦_ch”_li¡
è
	`b¡rLi¡De¡roy
(ssl_cipher_list);

129 if(
ch”s
 !ğ
NULL
è
	`h_ä“
(ciphers);

131 
	}
}

134 
	$S”v”_š™_s¦
(
S”v”
 *
¤v
)

136 
rc
 = 0;

137 
b¡ršg
 
û¹·th
 = 
NULL
;

138 
b¡ršg
 
key·th
 = 
NULL
;

140 
b¡ršg
 
û¹dœ
 = 
	`S‘tšg_g‘_¡r
("û¹dœ", 
NULL
);

141 
	`check
(
û¹dœ
 !ğ
NULL
, "to use ssl, you must specify‡ certdir");

143 
û¹·th
 = 
	`bfÜm©
("%s%s.üt", 
	`bd©a
(
û¹dœ
), bd©a(
¤v
->
uuid
));

144 
	`check_mem
(
û¹·th
);

146 
key·th
 = 
	`bfÜm©
("%s%s.key", 
	`bd©a
(
û¹dœ
), bd©a(
¤v
->
uuid
));

147 
	`check_mem
(
key·th
);

149 
rc
 = 
	`x509·r£_ütfe
(&
¤v
->
own_û¹
, 
	`bd©a
(
û¹·th
));

150 
	`check
(
rc
 =ğ0, "FaedØlßd c”ˆäom %s", 
	`bd©a
(
û¹·th
));

152 
rc
 = 
	`x509·r£_keyfe
(&
¤v
->
r§_key
, 
	`bd©a
(
key·th
), 
NULL
);

153 
	`check
(
rc
 =ğ0, "FaedØlßd key from %s", 
	`bd©a
(
key·th
));

155 
b¡ršg
 
s¦_ch”s_v®
 = 
	`S‘tšg_g‘_¡r
("s¦_ch”s", 
NULL
);

157 if(
s¦_ch”s_v®
 !ğ
NULL
) {

158 
rc
 = 
	`S”v”_lßd_ch”s
(
¤v
, 
s¦_ch”s_v®
);

159 
	`check
(
rc
 == 0, "Failedo†oad„equested SSL ciphers.");

161 
¤v
->
ch”s
 = 
s¦_deçuÉ_ch”s
;

164 
¤v
->
dhm_P
 = 
s¦_deçuÉ_dhm_P
;

165 
¤v
->
dhm_G
 = 
s¦_deçuÉ_dhm_G
;

167 
	`bde¡roy
(
û¹·th
);

168 
	`bde¡roy
(
key·th
);

172 
”rÜ
:

174 if(
û¹·th
 !ğ
NULL
è
	`bde¡roy
(certpath);

175 if(
key·th
 !ğ
NULL
è
	`bde¡roy
(keypath);

177 
	}
}

179 
S”v”
 *
	$S”v”_ü—‹
(
b¡ršg
 
uuid
, b¡ršg 
deçuÉ_ho¡
,

180 
b¡ršg
 
bšd_addr
, 
pÜt
, b¡ršg 
chroÙ
, b¡ršg 
acûss_log
,

181 
b¡ršg
 
”rÜ_log
, b¡ršg 
pid_fe
, 
u£_s¦
)

183 
S”v”
 *
¤v
 = 
NULL
;

184 
rc
 = 0;

186 
¤v
 = 
	`h_ÿÎoc
((
S”v”
), 1);

187 
	`check_mem
(
¤v
);

189 
¤v
->
ho¡s
 = 
	`Rou‹M­_ü—‹
(
ho¡_de¡roy_cb
);

190 
	`check
(
¤v
->
ho¡s
 !ğ
NULL
, "Failedo create host RouteMap.");

192 
¤v
->
hªdËrs
 = 
	`d¬¿y_ü—‹
((
HªdËr
), 20);

193 
	`check_mem
(
¤v
->
hªdËrs
);

195 
	`check
(
pÜt
 > 0, "Invalid…ort given, must be > 0: %d",…ort);

196 
¤v
->
pÜt
 =…ort;

197 
¤v
->
li¡’_fd
 = 0;

199 
¤v
->
bšd_addr
 = 
	`b¡rıy
(bšd_addr); 
	`check_mem
(srv->bind_addr);

200 
¤v
->
uuid
 = 
	`b¡rıy
(uuid); 
	`check_mem
(srv->uuid);

201 
¤v
->
chroÙ
 = 
	`b¡rıy
(chroÙ); 
	`check_mem
(srv->chroot);

202 
¤v
->
acûss_log
 = 
	`b¡rıy
×cûss_log); 
	`check_mem
(srv->access_log);

203 
¤v
->
”rÜ_log
 = 
	`b¡rıy
Ó¼Ü_log); 
	`check_mem
(srv->error_log);

204 
¤v
->
pid_fe
 = 
	`b¡rıy
Õid_fe); 
	`check_mem
(srv->pid_file);

205 
¤v
->
deçuÉ_ho¡Çme
 = 
	`b¡rıy
(
deçuÉ_ho¡
);

206 
¤v
->
u£_s¦
 = use_ssl;

208 if(
¤v
->
u£_s¦
) {

209 
rc
 = 
	`S”v”_š™_s¦
(
¤v
);

210 
	`check
(
rc
 =ğ0, "FaedØš™Ÿlizs¦ fÜ s”v” %s", 
	`bd©a
(
uuid
));

213  
¤v
;

215 
”rÜ
:

216 
	`S”v”_de¡roy
(
¤v
);

217  
NULL
;

218 
	}
}

222 
	$S”v”_de¡roy
(
S”v”
 *
¤v
)

224 if(
¤v
) {

225 if(
¤v
->
u£_s¦
) {

226 
	`x509_ä“
(&
¤v
->
own_û¹
);

227 
	`r§_ä“
(&
¤v
->
r§_key
);

231 
	`Rou‹M­_de¡roy
(
¤v
->
ho¡s
);

233 if(
¤v
->
hªdËrs
è
	`h_ä“
(srv->handlers);

235 
	`bde¡roy
(
¤v
->
bšd_addr
);

236 
	`bde¡roy
(
¤v
->
uuid
);

237 
	`bde¡roy
(
¤v
->
chroÙ
);

238 
	`bde¡roy
(
¤v
->
acûss_log
);

239 
	`bde¡roy
(
¤v
->
”rÜ_log
);

240 
	`bde¡roy
(
¤v
->
pid_fe
);

241 
	`bde¡roy
(
¤v
->
deçuÉ_ho¡Çme
);

243 
	`fdşo£
(
¤v
->
li¡’_fd
);

244 
	`h_ä“
(
¤v
);

246 
	}
}

249 
	$S”v”_š™
()

251 
mq_th»ads
 = 
	`S‘tšg_g‘_št
("zeromq.threads", 1);

253 if(
mq_th»ads
 > 1) {

254 
	`log_šfo
("WARNING: Setting zeromq.threads greaterhan 1 can cause†ockups in your handlers.");

257 
	`log_šfo
("S¹šg 0MQ w™h %dh»ads.", 
mq_th»ads
);

258 
	`mqš™
(
mq_th»ads
);

259 
	`Regi¡”_š™
();

260 
	`Reque¡_š™
();

261 
	`CÚÃùiÚ_š™
();

262 
	}
}

265 
	$S”v”_¡¬t
(
S”v”
 *
¤v
)

267 
cfd
 = -1;

268 
½Üt
 = -1;

269 
»mÙe
[
IPADDR_SIZE
];

270 
	`skÇme
("SERVER");

272 
	`log_šfo
("S¹šg s”v” oÀpÜˆ%d", 
¤v
->
pÜt
);

274 
RUNNING
) {

275 
cfd
 = 
	`Ãcû±
(
¤v
->
li¡’_fd
, 
»mÙe
, &
½Üt
);

276 
acû±_good
 = 0;

278 if(
cfd
 >= 0) {

279 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
¤v
, 
cfd
, 
½Üt
, 
»mÙe
);

281 if(
	`CÚÃùiÚ_acû±
(
cÚn
) != 0) {

282 
	`log_”r
("Failedo„egister connection, overloaded.");

283 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

284 
acû±_good
 = 0;

286 
acû±_good
 = 1;

289 
acû±_good
 = 0;

292 if(!
acû±_good
) {

293 
ş—»d
 = 
	`Regi¡”_ş—nout
();

295 if(
ş—»d
 == 0) {

296 
	`skd–ay
(1000);

301 
	`debug
("SERVER EXITED w™hƒ¼Ü: % ªd„‘uº v®ue: %d", 
	`¡»¼Ü
(
”ºo
), 
cfd
);

304 
	}
}

308 
	$S”v”_add_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
)

310 
	`check
(
ho¡
->
m©chšg
 !ğ
NULL
, "Host's matching can't be NULL.");

311  
	`Rou‹M­_š£¹_»v”£d
(
¤v
->
ho¡s
, 
ho¡
->
m©chšg
, host);

313 
”rÜ
:

315 
	}
}

318 
	$S”v”_£t_deçuÉ_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
)

320 
¤v
->
deçuÉ_ho¡
 = 
ho¡
;

321 
	}
}

325 
Ho¡
 *
	$S”v”_m©ch_back’d
(
S”v”
 *
¤v
, 
b¡ršg
 
rg‘
)

327 
	`check
(
¤v
 !ğ
NULL
, "Server is NULL?!");

329 if(
¤v
->
deçuÉ_ho¡
) {

330 
	`check
(
¤v
->
deçuÉ_ho¡
->
m©chšg
 !ğ
NULL
, "Server has‡ default_host without matching.");

333 
	`debug
("Lookšg fÜ¬g‘ ho¡: %s", 
	`bd©a
(
rg‘
));

334 
Rou‹
 *
found
 = 
	`Rou‹M­_m©ch_suffix
(
¤v
->
ho¡s
, 
rg‘
);

336  
found
 !ğ
NULL
 ? found->
d©a
 : 
¤v
->
deçuÉ_ho¡
;

338 
”rÜ
:

339  
NULL
;

340 
	}
}

342 
šlše
 
	$§me_hªdËr
(
HªdËr
 *
äom
, HªdË¸*
to
)

344  
	`bi£q
(
äom
->
£nd_id’t
, 
to
->send_ident) &&

345 
	`bi£q
(
äom
->
»cv_id’t
, 
to
->recv_ident) &&

346 
	`bi£q
(
äom
->
»cv_¥ec
, 
to
->recv_spec) &&

347 
	`bi£q
(
äom
->
£nd_¥ec
, 
to
->send_spec);

348 
	}
}

350 
	sRou‹Upd©”
 {

351 
HªdËr
 *
	mÜigš®
;

352 
HªdËr
 *
	m»¶aûm’t
;

353 } 
	tRou‹Upd©”
;

355 
	$upd©e_rou‹s
(*
v®ue
, *
d©a
)

357 
Rou‹Upd©”
 *
upd©e
 = 
d©a
;

358 
Back’d
 *
back’d
 = ((
Rou‹
 *)
v®ue
)->
d©a
;

360 if(
back’d
->
ty³
 =ğ
BACKEND_HANDLER
 && back’d->
rg‘
.
hªdËr
 =ğ
upd©e
->
Üigš®
) {

361 
	`debug
("Found backendhat‚eeds„eplacing: %p„eplaced with %p",

362 
upd©e
->
Üigš®
, upd©e->
»¶aûm’t
);

363 
back’d
->
rg‘
.
hªdËr
 = 
upd©e
->
»¶aûm’t
;

365 
	}
}

367 
	$upd©e_ho¡_rou‹s
(*
v®ue
, *
d©a
)

369 
Ho¡
 *
ho¡
 = ((
Rou‹
 *)
v®ue
)->
d©a
;

370 
	`t¡_Œav”£
(
ho¡
->
rou‹s
->rou‹s, 
upd©e_rou‹s
, 
d©a
);

371 
	}
}

373 
šlše
 
	$S”v”_cİy_aùive_hªdËrs
(
S”v”
 *
¤v
, S”v” *
cİy_äom
)

375 
i
 = 0;

376 
i
 = 0; i < 
	`d¬¿y_’d
(
cİy_äom
->
hªdËrs
); i++) {

377 
HªdËr
 *
äom
 = 
	`d¬¿y_g‘
(
cİy_äom
->
hªdËrs
, 
i
);

379 
j
 = 0;

380 
j
 = 0; j < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); j++) {

381 
HªdËr
 *
to
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
j
);

383 if(
	`§me_hªdËr
(
äom
, 
to
))

385 
	`debug
("Sw­pšg %°Üigš® fÜ %°»¶aûm’t", 
to
, 
äom
);

386 
Rou‹Upd©”
 
upd©e
 = {.
Üigš®
 = 
to
, .
»¶aûm’t
 = 
äom
};

387 
	`t¡_Œav”£
(
¤v
->
ho¡s
->
rou‹s
, 
upd©e_ho¡_rou‹s
, &
upd©e
);

389 
	`d¬¿y_£t
(
¤v
->
hªdËrs
, 
j
, 
äom
);

391 
	`d¬¿y_£t
(
cİy_äom
->
hªdËrs
, 
i
, 
to
);

392 
to
->
ruÂšg
 = 0;

399 
	}
}

401 
	$S”v”_¡¬t_hªdËrs
(
S”v”
 *
¤v
, S”v” *
cİy_äom
)

403 
i
 = 0;

404 
rc
 = 0;

406 if(
cİy_äom
 !ğ
NULL
) {

407 
rc
 = 
	`S”v”_cİy_aùive_hªdËrs
(
¤v
, 
cİy_äom
);

408 
	`check
(
rc
 != -1, "Failedo copy old handlerso‚ew server config.");

411 
i
 = 0; i < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); i++) {

412 
HªdËr
 *
hªdËr
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
i
);

413 
	`check
(
hªdËr
 !ğ
NULL
, "Invalid handler, can't be NULL.");

415 if(!
hªdËr
->
ruÂšg
) {

416 
	`log_šfo
("LOADING HªdË¸%s", 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

417 
rc
 = 
	`skü—‹
(
HªdËr_sk
, 
hªdËr
, 
HANDLER_STACK
);

418 
	`check
(
rc
 != -1, "Failedo start handlerask.");

419 
hªdËr
->
ruÂšg
 = 1;

424 
”rÜ
:

426 
	}
}

429 
	$S”v”_¡İ_hªdËrs
(
S”v”
 *
¤v
)

431 
i
 = 0;

432 
i
 = 0; i < 
	`d¬¿y_’d
(
¤v
->
hªdËrs
); i++) {

433 
HªdËr
 *
hªdËr
 = 
	`d¬¿y_g‘
(
¤v
->
hªdËrs
, 
i
);

434 
	`check
(
hªdËr
 !ğ
NULL
, "Invalid handler, can't be NULL.");

436 
	`debug
("############################### HANDLER SHUTDOWN: %p,„unning: %d,ask: %p",

437 
hªdËr
, hªdËr->
ruÂšg
, hªdËr->
sk
);

438 if(
hªdËr
->
ruÂšg
) {

439 
	`log_šfo
("STOPPING HANDLER %s", 
	`bd©a
(
hªdËr
->
£nd_¥ec
));

440 if(
hªdËr
->
sk
 !ğ
NULL
) {

441 
	`sksigÇl
(
hªdËr
->
sk
, 
SIGINT
);

442 
hªdËr
->
ruÂšg
 = 0;

443 
	`skd–ay
(1);

447 if(
hªdËr
->
»cv_sock‘
è
	`zmq_şo£
(handler->recv_socket);

448 if(
hªdËr
->
£nd_sock‘
è
	`zmq_şo£
(handler->send_socket);

449 
hªdËr
->
»cv_sock‘
 = 
NULL
;

450 
hªdËr
->
£nd_sock‘
 = 
NULL
;

454 
”rÜ
:

456 
	}
}

	@tools/src/server.h

35 #iâdeà
_£rv”_h


36 
	#_£rv”_h


	)

38 
	~"adt/t¡.h
"

39 
	~"adt/d¬¿y.h
"

40 
	~"ho¡.h
"

41 
	~"routšg.h
"

42 
	~"pŞ¬s¦/s¦.h
"

43 
	~"pŞ¬s¦/x509.h
"

44 
	~"pŞ¬s¦/r§.h
"

48 
	mIPADDR_SIZE
 = 40

51 
	sS”v”
 {

52 
	mpÜt
;

53 
	mli¡’_fd
;

54 
Ho¡
 *
	mdeçuÉ_ho¡
;

55 
Rou‹M­
 *
	mho¡s
;

56 
d¬¿y_t
 *
	mhªdËrs
;

57 
b¡ršg
 
	mbšd_addr
;

58 
b¡ršg
 
	muuid
;

59 
b¡ršg
 
	mchroÙ
;

60 
b¡ršg
 
	macûss_log
;

61 
b¡ršg
 
	m”rÜ_log
;

62 
b¡ršg
 
	mpid_fe
;

63 
b¡ršg
 
	mdeçuÉ_ho¡Çme
;

64 
	mu£_s¦
;

65 
x509_û¹
 
	mown_û¹
;

66 
r§_cÚ‹xt
 
	mr§_key
;

67 *
	mch”s
;

68 *
	mdhm_P
;

69 *
	mdhm_G
;

70 } 
	tS”v”
;

72 
S”v”
 *
S”v”_ü—‹
(
b¡ršg
 
uuid
, b¡ršg 
deçuÉ_ho¡
,

73 
b¡ršg
 
bšd_addr
, 
pÜt
, b¡ršg 
chroÙ
,

74 
b¡ršg
 
acûss_log
, b¡ršg 
”rÜ_log
, b¡ršg 
pid_fe
, 
u£_s¦
);

76 
S”v”_de¡roy
(
S”v”
 *
¤v
);

78 
S”v”_š™
();

80 
S”v”_¡¬t
(
S”v”
 *
¤v
);

82 
S”v”_add_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
);

84 
S”v”_£t_deçuÉ_ho¡
(
S”v”
 *
¤v
, 
Ho¡
 *
ho¡
);

86 
Ho¡
 *
S”v”_m©ch_back’d
(
S”v”
 *
¤v
, 
b¡ršg
 
rg‘
);

88 
S”v”_¡¬t_hªdËrs
(
S”v”
 *
¤v
, S”v” *
cİy_äom
);

90 
S”v”_¡İ_hªdËrs
(
S”v”
 *
¤v
);

	@tools/src/setting.c

35 
	~<£‰šg.h
>

36 
	~<adt/t¡.h
>

37 
	~<dbg.h
>

39 
t¡_t
 *
	gSETTINGS_MAP
 = 
NULL
;

42 
	$S‘tšg_add
(cÚ¡ *
key
, cÚ¡ *
v®ue
)

44 
b¡ršg
 
key_¡r
 = 
	`bäomc¡r
(
key
);

45 
b¡ršg
 
v®ue_¡r
 = 
	`bäomc¡r
(
v®ue
);

47 
	`check
(!
	`t¡_£¬ch
(
SETTINGS_MAP
, 
	`bd©a
(
key_¡r
), 
	`bËngth
(
v®ue_¡r
)),

49 
key
, key, 
v®ue
);

51 
SETTINGS_MAP
 = 
	`t¡_š£¹
(SETTINGS_MAP, 
	`bd©a
(
key_¡r
),

52 
	`bËngth
(
key_¡r
), 
v®ue_¡r
);

54 
	`bde¡roy
(
key_¡r
);

57 
”rÜ
:

58 
	`bde¡roy
(
key_¡r
);

59 
	`bde¡roy
(
v®ue_¡r
);

61 
	}
}

64 
b¡ršg
 
	$S‘tšg_g‘_¡r
(cÚ¡ *
key
, 
b¡ršg
 
def
)

66 
b¡ršg
 
v®ue
 = 
	`t¡_£¬ch
(
SETTINGS_MAP
, 
key
, 
	`¡¾’
(key));

68  
v®ue
 =ğ
NULL
 ? 
def
 : value;

69 
	}
}

71 
	$S‘tšg_g‘_št
(cÚ¡ *
key
, 
def
)

73 
b¡ršg
 
v®ue
 = 
	`t¡_£¬ch
(
SETTINGS_MAP
, 
key
, 
	`¡¾’
(key));

75 if(
v®ue
) {

76  
	`©oi
((cÚ¡ *)
v®ue
->
d©a
);

78  
def
;

80 
	}
}

82 
	$S‘tšg_Œav”£_de¡roy
(*
v®ue
, *
d©a
)

84 
	`bde¡roy
((
b¡ršg
)
v®ue
);

85 
	}
}

87 
	$S‘tšg_de¡roy
()

89 if(
SETTINGS_MAP
) {

90 
	`t¡_Œav”£
(
SETTINGS_MAP
, 
S‘tšg_Œav”£_de¡roy
, 
NULL
);

91 
	`t¡_de¡roy
(
SETTINGS_MAP
);

92 
SETTINGS_MAP
 = 
NULL
;

94 
	}
}

	@tools/src/setting.h

35 #iâdeà
_£‰šg_h


36 
	#_£‰šg_h


	)

38 
	~<¡dlib.h
>

39 
	~<b¡ršg.h
>

41 
S‘tšg_add
(cÚ¡ *
key
, cÚ¡ *
v®ue
);

43 
b¡ršg
 
S‘tšg_g‘_¡r
(cÚ¡ *
key
, b¡ršg 
def
);

45 
S‘tšg_g‘_št
(cÚ¡ *
key
, 
def
);

47 
S‘tšg_de¡roy
();

	@tools/src/state.c

37 
	~<¡dlib.h
>

38 
	~<¡dio.h
>

39 
	~<¡©e.h
>

40 
	~<dbg.h
>

41 
	~<ev’ts.h
>

42 
	~<as£¹.h
>

44 
	#CALL
(
A
, 
C
è
	`TRACE
(A,C); if(
¡©e
->
aùiÚs
 && s‹->aùiÚs->Aè
Ãxt
 = s‹->aùiÚs->
	`A
(
cÚn
)

	)

52 cÚ¡ 
	gS‹AùiÚs_¡¬t
 = 16;

53 cÚ¡ 
	gS‹AùiÚs_fœ¡_fš®
 = 16;

54 cÚ¡ 
	gS‹AùiÚs_”rÜ
 = 0;

56 cÚ¡ 
	gS‹AùiÚs_’_Proxy
 = 10;

57 cÚ¡ 
	gS‹AùiÚs_’_maš
 = 16;

58 cÚ¡ 
	gS‹AùiÚs_’_maš_CÚÃùiÚ_IdË
 = 5;

59 cÚ¡ 
	gS‹AùiÚs_’_maš_CÚÃùiÚ_HTTPRoutšg
 = 3;

64 
	$S‹_š™
(
S‹
 *
¡©e
, 
S‹AùiÚs
 *
aùiÚs
)

66 
¡©e
->
aùiÚs
 =‡ctions;

71 
¡©e
->
cs
 = 
S‹AùiÚs_¡¬t
;

76 
	}
}

78 
	$S‹_šv¬ŸÁ
(
S‹
 *
¡©e
)

80 iàĞ
¡©e
->
cs
 ==

88 iàĞ
¡©e
->
cs
 >=

97 
	}
}

99 
	$S‹_exec
(
S‹
 *
¡©e
, 
ev’t
, 
CÚÃùiÚ
 *
cÚn
)

101 
ev’t_queue
[2] = {0};

102 
ev’t_queue
[0] = 
ev’t
;

103 
Ãxt
 = 0;

105 cÚ¡ *
p
 = 
ev’t_queue
;

106 cÚ¡ *
³
 = 
p
+1;

107 cÚ¡ *
eof
 = 
ev’t
 =ğ
CLOSE
 ? 
³
 : 
NULL
;

112 iàĞ
p
 =ğ
³
 )

113 
_‹¡_eof
;

114  
¡©e
->
cs
 )

117 iàĞ(*
p
) == 107 )

118 
Œ20
;

119 
¡0
;

120 
Œ0
:

122 { 
	`CALL
(
”rÜ
, (*
p
)); }

123 
¡0
;

125 
¡0
:

126 
¡©e
->
cs
 = 0;

127 
_out
;

128 
Œ20
:

130 { 
	`CALL
(
·r£
, (*
p
)); }

131 
¡1
;

132 
¡1
:

133 iàĞ++
p
 =ğ
³
 )

134 
_‹¡_eof1
;

137  (*
p
) ) {

138 100: 
Œ1
;

139 110: 
Œ2
;

141 
Œ0
;

142 
Œ1
:

144 { 
	`CALL
(
şo£
, (*
p
)); }

145 
¡17
;

146 
¡17
:

147 iàĞ++
p
 =ğ
³
 )

148 
_‹¡_eof17
;

151 iàĞ(*
p
) == 107 )

152 
Œ20
;

153 
Œ0
;

154 
Œ2
:

156 { 
	`CALL
(
»gi¡”_»que¡
, (*
p
)); }

157 
¡2
;

158 
¡2
:

159 iàĞ++
p
 =ğ
³
 )

160 
_‹¡_eof2
;

163  (*
p
) ) {

164 100: 
Œ1
;

165 105: 
Œ3
;

166 106: 
Œ4
;

167 113: 
Œ5
;

169 
Œ0
;

170 
Œ3
:

172 { 
	`CALL
(
rou‹_»que¡
, (*
p
)); }

173 
¡3
;

174 
¡3
:

175 iàĞ++
p
 =ğ
³
 )

176 
_‹¡_eof3
;

179  (*
p
) ) {

180 100: 
Œ1
;

181 102: 
Œ6
;

182 104: 
Œ7
;

183 108: 
Œ8
;

185 
Œ0
;

186 
Œ5
:

188 { 
	`CALL
(
£nd_sock‘_»¥Ú£
, (*
p
)); }

189 
¡4
;

190 
Œ6
:

192 { 
	`CALL
(
h‰p_to_dœeùÜy
, (*
p
)); }

193 
¡4
;

194 
¡4
:

195 iàĞ++
p
 =ğ
³
 )

196 
_‹¡_eof4
;

199  (*
p
) ) {

200 100: 
Œ1
;

201 112: 
Œ9
;

203 
Œ0
;

204 
Œ9
:

206 { 
	`CALL
(
·r£
, (*
p
)); }

207 
¡5
;

208 
¡5
:

209 iàĞ++
p
 =ğ
³
 )

210 
_‹¡_eof5
;

213  (*
p
) ) {

214 100: 
Œ1
;

215 110: 
Œ10
;

217 
Œ0
;

218 
Œ10
:

220 { 
	`CALL
(
id’tify_»que¡
, (*
p
)); }

221 
¡6
;

222 
¡6
:

223 iàĞ++
p
 =ğ
³
 )

224 
_‹¡_eof6
;

227  (*
p
) ) {

228 105: 
Œ3
;

229 106: 
Œ4
;

230 113: 
Œ5
;

232 
Œ0
;

233 
Œ4
:

235 { 
	`CALL
(
rou‹_»que¡
, (*
p
)); }

236 
¡7
;

237 
¡7
:

238 iàĞ++
p
 =ğ
³
 )

239 
_‹¡_eof7
;

242 iàĞ(*
p
) == 104 )

243 
Œ11
;

244 
Œ0
;

245 
Œ7
:

247 { 
	`CALL
(
h‰p_to_hªdËr
, (*
p
)); }

248 
¡8
;

249 
Œ11
:

251 { 
	`CALL
(
msg_to_hªdËr
, (*
p
)); }

252 
¡8
;

253 
¡8
:

254 iàĞ++
p
 =ğ
³
 )

255 
_‹¡_eof8
;

258 iàĞ(*
p
) == 111 )

259 
Œ9
;

260 
Œ0
;

261 
Œ8
:

263 { 
	`CALL
(
h‰p_to_´oxy
, (*
p
)); {
¡10
;} }

264 
¡9
;

265 
¡9
:

266 iàĞ++
p
 =ğ
³
 )

267 
_‹¡_eof9
;

270 
Œ0
;

271 
¡10
:

272 iàĞ++
p
 =ğ
³
 )

273 
_‹¡_eof10
;

275  (*
p
) ) {

276 101: 
Œ12
;

277 103: 
Œ14
;

279 
¡0
;

280 
Œ12
:

282 { 
	`CALL
(
´oxy_d–iv”
, (*
p
)); }

283 
¡11
;

284 
¡11
:

285 iàĞ++
p
 =ğ
³
 )

286 
_‹¡_eof11
;

289  (*
p
) ) {

290 109: 
Œ15
;

291 111: 
Œ16
;

293 
Œ0
;

294 
Œ14
:

296 { 
	`CALL
(
´oxy_çed
, (*
p
)); }

297 
¡12
;

298 
Œ15
:

300 { 
	`CALL
(
´oxy_şo£
, (*
p
)); }

301 
¡12
;

302 
¡12
:

303 iàĞ++
p
 =ğ
³
 )

304 
_‹¡_eof12
;

307 iàĞ(*
p
) == 100 )

308 
Œ17
;

309 
Œ0
;

310 
Œ17
:

313 
p
--;

314 {
¡5
;}

316 
¡13
;

317 
Œ19
:

320 
	`CALL
(
´oxy_şo£
, (*
p
));

321 
p
--;

322 {
¡3
;}

324 
¡13
;

325 
¡13
:

326 iàĞ++
p
 =ğ
³
 )

327 
_‹¡_eof13
;

330 
Œ0
;

331 
Œ16
:

333 { 
	`CALL
(
´oxy_»¶y_·r£
, (*
p
)); }

334 
¡14
;

335 
¡14
:

336 iàĞ++
p
 =ğ
³
 )

337 
_‹¡_eof14
;

340  (*
p
) ) {

341 109: 
Œ15
;

342 110: 
Œ18
;

344 
Œ0
;

345 
Œ18
:

347 { 
	`CALL
(
´oxy_»q_·r£
, (*
p
)); }

348 
¡15
;

349 
¡15
:

350 iàĞ++
p
 =ğ
³
 )

351 
_‹¡_eof15
;

354  (*
p
) ) {

355 102: 
Œ19
;

356 104: 
Œ19
;

357 105: 
Œ12
;

358 108: 
Œ19
;

359 109: 
Œ15
;

361 
Œ0
;

363 
_‹¡_eof1
: 
¡©e
->
cs
 = 1; 
_‹¡_eof
;

364 
_‹¡_eof17
: 
¡©e
->
cs
 = 17; 
_‹¡_eof
;

365 
_‹¡_eof2
: 
¡©e
->
cs
 = 2; 
_‹¡_eof
;

366 
_‹¡_eof3
: 
¡©e
->
cs
 = 3; 
_‹¡_eof
;

367 
_‹¡_eof4
: 
¡©e
->
cs
 = 4; 
_‹¡_eof
;

368 
_‹¡_eof5
: 
¡©e
->
cs
 = 5; 
_‹¡_eof
;

369 
_‹¡_eof6
: 
¡©e
->
cs
 = 6; 
_‹¡_eof
;

370 
_‹¡_eof7
: 
¡©e
->
cs
 = 7; 
_‹¡_eof
;

371 
_‹¡_eof8
: 
¡©e
->
cs
 = 8; 
_‹¡_eof
;

372 
_‹¡_eof9
: 
¡©e
->
cs
 = 9; 
_‹¡_eof
;

373 
_‹¡_eof10
: 
¡©e
->
cs
 = 10; 
_‹¡_eof
;

374 
_‹¡_eof11
: 
¡©e
->
cs
 = 11; 
_‹¡_eof
;

375 
_‹¡_eof12
: 
¡©e
->
cs
 = 12; 
_‹¡_eof
;

376 
_‹¡_eof13
: 
¡©e
->
cs
 = 13; 
_‹¡_eof
;

377 
_‹¡_eof14
: 
¡©e
->
cs
 = 14; 
_‹¡_eof
;

378 
_‹¡_eof15
: 
¡©e
->
cs
 = 15; 
_‹¡_eof
;

380 
_‹¡_eof
: {}

381 iàĞ
p
 =ğ
eof
 )

383  
¡©e
->
cs
 ) {

399 { 
	`CALL
(
”rÜ
, (*
p
)); }

405 
_out
: {}

410  
Ãxt
;

411 
	}
}

415 cÚ¡ *
	gEVENT_NAMES
[] = {

432 cÚ¡ *
	$S‹_ev’t_Çme
(
ev’t
)

434 if(
ev’t
 =ğ0èev’ˆğ
CLOSE
;

436 
	`as£¹
(
ev’t
 >ğ
CLOSE
 &&ƒv’ˆ< 
EVENT_END
 && "Event is outside„ange.");

438  
EVENT_NAMES
[
ev’t
 - 
CLOSE
];

439 
	}
}

	@tools/src/state.h

35 #iâdeà
_¡©e_h


36 
	#_¡©e_h


	)

38 
	gS‹
;

39 
	gCÚÃùiÚ
;

41 (*
	t¡©e_aùiÚ_cb
)(
	tCÚÃùiÚ
 *
	tcÚn
);

43 
	sS‹AùiÚs
 {

44 
¡©e_aùiÚ_cb
 
”rÜ
;

45 
¡©e_aùiÚ_cb
 
şo£
;

46 
¡©e_aùiÚ_cb
 
·r£
;

47 
¡©e_aùiÚ_cb
 
»gi¡”_»que¡
;

48 
¡©e_aùiÚ_cb
 
id’tify_»que¡
;

49 
¡©e_aùiÚ_cb
 
rou‹_»que¡
;

50 
¡©e_aùiÚ_cb
 
£nd_sock‘_»¥Ú£
;

51 
¡©e_aùiÚ_cb
 
msg_to_hªdËr
;

52 
¡©e_aùiÚ_cb
 
h‰p_to_hªdËr
;

53 
¡©e_aùiÚ_cb
 
h‰p_to_´oxy
;

54 
¡©e_aùiÚ_cb
 
h‰p_to_dœeùÜy
;

55 
¡©e_aùiÚ_cb
 
´oxy_d–iv”
;

56 
¡©e_aùiÚ_cb
 
´oxy_çed
;

57 
¡©e_aùiÚ_cb
 
´oxy_»¶y_·r£
;

58 
¡©e_aùiÚ_cb
 
´oxy_»q_·r£
;

59 
¡©e_aùiÚ_cb
 
´oxy_şo£
;

60 } 
	tS‹AùiÚs
;

62 
	sS‹
 {

63 
cs
;

64 *
d©a
;

65 
S‹AùiÚs
 *
aùiÚs
;

66 } 
	tS‹
;

68 
	`S‹_exec
(
S‹
 *
¡©e
, 
ev’t
, 
CÚÃùiÚ
 *
cÚn
);

69 
	`S‹_šv¬ŸÁ
(
S‹
 *
¡©e
);

70 
	`S‹_š™
(
S‹
 *
¡©e
, 
S‹AùiÚs
 *
aùiÚs
);

72 cÚ¡ *
	`S‹_ev’t_Çme
(
ev’t
);

	@tools/src/superpoll.c

36 
	~<su³½Şl.h
>

37 
	~<mem/h®loc.h
>

38 
	~<dbg.h
>

39 
	~<as£¹.h
>

40 
	~<sys/»sourû.h
>

41 
	~<uni¡d.h
>

42 
	~<as£¹.h
>

43 
	~<£‰šg.h
>

45 #ifdeà
__lšux__


46 
	#HAS_EPOLL
 1

	)

48 
	#HAS_EPOLL
 0

	)

51 
	gMAXFD
 = 0;

54 
	mMAX_NOFILE
 = 1024 * 10

57 
	$Su³rPŞl_de¡roy
(
Su³rPŞl
 *
¥
)

59 if(
¥
) {

60 if(
HAS_EPOLL
) {

61 if(
¥
->
idË_fd
 > 0è
	`şo£
(sp->idle_fd);

62 if(
¥
->
idË_aùive
) {

63 
	`li¡_de¡roy_nodes
(
¥
->
idË_aùive
);

64 
	`li¡_de¡roy
(
¥
->
idË_aùive
);

67 if(
¥
->
idË_ä“
) {

68 
	`li¡_de¡roy_nodes
(
¥
->
idË_ä“
);

69 
	`li¡_de¡roy
(
¥
->
idË_ä“
);

73 
	`h_ä“
(
¥
);

75 
	}
}

78 
šlše
 
Su³rPŞl_¬m_idË_fd
(
Su³rPŞl
 *
¥
);

79 
šlše
 
Su³rPŞl_£tup_idË
(
Su³rPŞl
 *
¥
, 
tÙ®_İ’_fd
);

80 
šlše
 
Su³rPŞl_add_idË
(
Su³rPŞl
 *
¥
, *
d©a
, 
fd
, 
rw
);

81 
šlše
 
Su³rPŞl_add_idË_h™s
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
);

84 
Su³rPŞl
 *
	$Su³rPŞl_ü—‹
()

86 
Su³rPŞl
 *
¥
 = 
	`h_ÿÎoc
((SuperPoll), 1);

87 
	`check_mem
(
¥
);

88 
rc
 = 0;

90 
tÙ®_İ’_fd
 = 
	`Su³rPŞl_g‘_max_fd
();

91 
¥
->
nfd_hÙ
 = 0;

93 if(
HAS_EPOLL
) {

94 
hÙ_divid’d
 = 
	`S‘tšg_g‘_št
("superpoll.hot_dividend", 4);

96 
¥
->
max_hÙ
 = 
tÙ®_İ’_fd
 / 
hÙ_divid’d
;

98 
rc
 = 
	`Su³rPŞl_£tup_idË
(
¥
, 
tÙ®_İ’_fd
);

99 
	`check
(
rc
 == 0, "Failedo configureƒpoll. Disabling.");

101 
	`log_šfo
("Allowing for %d hot‡nd %d idle file descriptors (dividend was %d)",

102 
¥
->
max_hÙ
, sp->
max_idË
, 
hÙ_divid’d
);

104 
¥
->
max_hÙ
 = 
tÙ®_İ’_fd
;

106 
	`log_šfo
("You dØnÙ hav•ŞÈsuµÜt. AÎowšg fÜ %d fdesütÜ through…Şl.", 
¥
->
max_hÙ
);

109 
¥
->
pŞlfd
 = 
	`h_ÿÎoc
((
zmq_pŞl™em_t
), sp->
max_hÙ
);

110 
	`check_mem
(
¥
->
pŞlfd
);

111 
	`h©ch
(
¥
->
pŞlfd
, sp);

113 
¥
->
hÙ_d©a
 = 
	`h_ÿÎoc
((*), sp->
max_hÙ
);

114 
	`check_mem
(
¥
->
hÙ_d©a
);

115 
	`h©ch
(
¥
->
hÙ_d©a
, sp);

117 if(
HAS_EPOLL
) {

118 
rc
 = 
	`Su³rPŞl_¬m_idË_fd
(
¥
);

119 
	`check
(
rc
 != -1, "Failedo‡ddheƒpoll socketohe…oll†ist.");

122  
¥
;

124 
”rÜ
:

125 
	`Su³rPŞl_de¡roy
(
¥
);

127  
NULL
;

128 
	}
}

132 
šlše
 
	$Su³rPŞl_add_pŞl
(
Su³rPŞl
 *
¥
, *
d©a
, *
sock‘
, 
fd
, 
rw
)

134 
cur_fd
 = 
¥
->
nfd_hÙ
;

135 
b™s
 = 0;

137 
	`check
(
sock‘
 !ğ
NULL
 || 
fd
 >ğ0, "A‰em±Ø% äom d—d fdesütÜ: %d", 
rw
 == 'r' ? "read" : "write", fd);

138 
	`check
(
cur_fd
 < 
	`Su³rPŞl_max_hÙ
(
¥
), "Too many %s: %d is greaterhan hot %d max.",

139 
sock‘
 ? "handler„equests outstanding, your handler isn't„unning" : "files open",

140 
cur_fd
, 
	`Su³rPŞl_max_hÙ
(
¥
));

143 if(
rw
 == 'r') {

144 
b™s
 |ğ
ZMQ_POLLIN
;

145 } if(
rw
 == 'w') {

146 
b™s
 |ğ
ZMQ_POLLOUT
;

148 
	`£Áš–
("Inv®idƒv’ˆ%øhªdedØsu³½Şl.„/w oÆy.", 
rw
);

151 
¥
->
pŞlfd
[
cur_fd
].
fd
 = fd;

152 
¥
->
pŞlfd
[
cur_fd
].
sock‘
 = socket;

153 
¥
->
pŞlfd
[
cur_fd
].
ev’ts
 = 
b™s
;

154 
¥
->
pŞlfd
[
cur_fd
].
»v’ts
 = 0;

155 
¥
->
hÙ_d©a
[
cur_fd
] = 
d©a
;

156 
¥
->
nfd_hÙ
++;

158  
¥
->
nfd_hÙ
;

160 
”rÜ
:

162 
	}
}

164 
	$Su³rPŞl_add
(
Su³rPŞl
 *
¥
, *
d©a
, *
sock‘
, 
fd
, 
rw
, 
hÙ
)

166 if(
sock‘
 || 
hÙ
 || !
HAS_EPOLL
) {

167  
	`Su³rPŞl_add_pŞl
(
¥
, 
d©a
, 
sock‘
, 
fd
, 
rw
);

169 
	`as£¹
(!
sock‘
 && "Cannot‡dd‡ 0MQ socketohe idle (!hot) set.");

170  
	`Su³rPŞl_add_idË
(
¥
, 
d©a
, 
fd
, 
rw
);

172 
	}
}

174 
	$Su³rPŞl_d–
(
Su³rPŞl
 *
¥
, *
sock‘
, 
fd
, 
hÙ
)

176 
i
 = 0;

177 
¦Ù
 = 0;

179 
i
 = 0; i < 
¥
->
nfd_hÙ
; i++) {

180 if(
sock‘
) {

181 if(
¥
->
pŞlfd
[
i
].
sock‘
 == socket) {

182 
¦Ù
 = 
i
; ;

184 } if(
hÙ
) {

185 if(
¥
->
pŞlfd
[
i
].
fd
 == fd) {

186 
¦Ù
 = 
i
; ;

189 
	`£Áš–
("Not implemented yet.");

193 
	`Su³rPŞl_com·ù_down
(
¥
, 
¦Ù
);

196 
”rÜ
:

198 
	}
}

201 
	$Su³rPŞl_com·ù_down
(
Su³rPŞl
 *
¥
, 
i
)

203 
¥
->
nfd_hÙ
--;

204 if(
¥
->
nfd_hÙ
 >= 0) {

205 
¥
->
pŞlfd
[
i
] = sp->pŞlfd[¥->
nfd_hÙ
];

206 
¥
->
hÙ_d©a
[
i
] = sp->hÙ_d©a[¥->
nfd_hÙ
];

208 
	}
}

210 
šlše
 
	$Su³rPŞl_add_h™
(
PŞlResuÉ
 *
»suÉ
, 
zmq_pŞl™em_t
 *
p
, *
d©a
)

212 
»suÉ
->
h™s
[»suÉ->
nh™s
].
ev
 = *
p
;

213 
»suÉ
->
h™s
[»suÉ->
nh™s
].
d©a
 = data;

214 
»suÉ
->
nh™s
++;

215 
	}
}

218 
	$Su³rPŞl_pŞl
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
, 
ms
)

220 
i
 = 0;

221 
nfound
 = 0;

222 
cur_i
 = 0;

223 
rc
 = 0;

224 
h™_idË
 = 0;

226 
»suÉ
->
nh™s
 = 0;

229 
nfound
 = 
	`zmq_pŞl
(
¥
->
pŞlfd
, sp->
nfd_hÙ
, 
ms
 * 1000);

230 
	`check
(
nfound
 >ğ0 || 
”ºo
 =ğ
EINTR
, "zmq_poll failed.");

232 
»suÉ
->
hÙ_fds
 = 
nfound
;

234 
i
 = 0; i < 
nfound
; i++) {

235 
cur_i
 < 
¥
->
nfd_hÙ
 && !¥->
pŞlfd
[cur_i].
»v’ts
) {

236 
cur_i
++;

239 if(
HAS_EPOLL
 && 
¥
->
pŞlfd
[
cur_i
].
fd
 =ğ¥->
idË_fd
) {

240 
h™_idË
 = 1;

241 
rc
 = 
	`Su³rPŞl_add_idË_h™s
(
¥
, 
»suÉ
);

242 
	`check
(
rc
 != -1, "Failedo‡dd idle hits.");

244 
	`Su³rPŞl_add_h™
(
»suÉ
, &
¥
->
pŞlfd
[
cur_i
], sp->
hÙ_d©a
[cur_i]);

247 
	`Su³rPŞl_com·ù_down
(
¥
, 
cur_i
);

250 if(
h™_idË
) {

251 
	`Su³rPŞl_¬m_idË_fd
(
¥
);

254  
»suÉ
->
nh™s
;

256 
”rÜ
:

259 
	}
}

261 
	$Su³rPŞl_g‘_max_fd
()

263 
rc
 = 0;

264 
¾im™
 
¾
;

266 if(
MAXFD
)  MAXFD;

268 
»que¡ed_max
 = 
	`S‘tšg_g‘_št
("su³½Şl.max_fd", 
MAX_NOFILE
);

270 
	`debug
("A‰em±šgØfÜû NOFILE†im™Ø%d", 
»que¡ed_max
);

271 
¾
.
¾im_cur
 = 
»que¡ed_max
;

272 
¾
.
¾im_max
 = 
»que¡ed_max
;

274 
rc
 = 
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾
);

276 if(
rc
 == 0) {

277 
MAXFD
 = 
»que¡ed_max
;

279 
	`log_šfo
("Could‚Ù fÜû NOFILE high”, you'Î‚“dØruÀa roÙ: %s", 
	`¡»¼Ü
(
”ºo
));

280 
rc
 = 
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾
);

281 
	`check
(
rc
 == 0, "Failedo get your max open file†imit,otally weird.");

282 
MAXFD
 = 
¾
.
¾im_cur
;

285 
	`log_šfo
("MAX o³ÀfdesütÜ i %d‚ow.", 
MAXFD
);

286  
MAXFD
;

288 
”rÜ
:

289 
	`log_”r
("TOTAL CATASTROPHE, ifhis happens we can't get your„limit for max files,…icking 256o be safe.");

291 
MAXFD
 = 256;

292  
MAXFD
;

293 
	}
}

296 
	$PŞlResuÉ_š™
(
Su³rPŞl
 *
p
, 
PŞlResuÉ
 *
»suÉ
)

298 
	`mem£t
(
»suÉ
, 0, (
PŞlResuÉ
));

299 
»suÉ
->
h™s
 = 
	`h_ÿÎoc
((
PŞlEv’t
), 
	`Su³rPŞl_max_hÙ
(
p
è+ 
	`Su³rPŞl_max_idË
(p));

300 
	`h©ch
(
»suÉ
->
h™s
, 
p
);

301 
	`check_mem
(
»suÉ
->
h™s
);

305 
”rÜ
:

307 
	}
}

309 
	$PŞlResuÉ_ş—n
(
PŞlResuÉ
 *
»suÉ
)

311 if(
»suÉ
) {

312 if(
»suÉ
->
h™s
è
	`h_ä“
(result->hits);

314 
	}
}

317 #ià
defšed
 
HAS_EPOLL
 && HAS_EPOLL == 0

319 
šlše
 
	$Su³rPŞl_¬m_idË_fd
(
Su³rPŞl
 *
¥
)

321 
	`as£¹
(0 && "Should‚ot get called.");

323 
	}
}

325 
šlše
 
	$Su³rPŞl_£tup_idË
(
Su³rPŞl
 *
¥
, 
tÙ®_İ’_fd
)

327 
¥
->
max_idË
 = 0;

328 
¥
->
ev’ts
 = 
NULL
;

329 
¥
->
idË_fd
 = -1;

330 
¥
->
idË_d©a
 = 
NULL
;

331 
¥
->
idË_ä“
 = 
NULL
;

332 
¥
->
idË_aùive
 = 
NULL
;

334 
	}
}

336 
šlše
 
	$Su³rPŞl_add_idË
(
Su³rPŞl
 *
¥
, *
d©a
, 
fd
, 
rw
)

338  
	`Su³rPŞl_add_pŞl
(
¥
, 
d©a
, 
NULL
, 
fd
, 
rw
);

339 
	}
}

341 
šlše
 
	$Su³rPŞl_add_idË_h™s
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
)

344 
	}
}

348 
	~<sys/•Şl.h
>

350 
	#Su³rPŞl_•Şl_ev’ts
(
S
è((
•Şl_ev’t
 *)(S->
ev’ts
))

	)

352 
šlše
 
	$Su³rPŞl_¬m_idË_fd
(
Su³rPŞl
 *
¥
)

354  
	`Su³rPŞl_add
(
¥
, 
NULL
, NULL, sp->
idË_fd
, 'r', 1);

355 
	}
}

357 
šlše
 
	$Su³rPŞl_£tup_idË
(
Su³rPŞl
 *
¥
, 
tÙ®_İ’_fd
)

359 
	`as£¹
(
HAS_EPOLL
 == 1 && "This function should‚ot„un unless HAS_EPOLL is 1.");

361 
i
 = 0;

363 
¥
->
max_idË
 = 
tÙ®_İ’_fd
 - sp->
max_hÙ
;

364 
	`as£¹
(
¥
->
max_idË
 >= 0 && "max idle is can't be†esshan zero.");

367 
¥
->
ev’ts
 = 
	`h_ÿÎoc
((
•Şl_ev’t
), sp->
max_idË
);

368 
	`check_mem
(
¥
->
ev’ts
);

369 
	`h©ch
(
¥
->
ev’ts
, sp);

371 
¥
->
idË_fd
 = 
	`•Şl_ü—‹
(¥->
max_idË
);

372 
	`check
(
¥
->
idË_fd
 != -1, "Failedo createheƒpoll structure.");

374 
¥
->
idË_d©a
 = 
	`h_ÿÎoc
((
IdËD©a
), sp->
max_idË
);

375 
	`check_mem
(
¥
->
idË_d©a
);

376 
	`h©ch
(
¥
->
idË_d©a
, sp);

378 
¥
->
idË_ä“
 = 
	`li¡_ü—‹
(¥->
max_idË
);

379 
	`check_mem
(
¥
->
idË_ä“
);

382 
	`debug
("Budšg u°¦Ù fÜ %d sock‘ š idË. Couldak¨mšu‹.", 
¥
->
max_idË
);

383 
i
 = 0; i < 
¥
->
max_idË
; i++) {

384 
Êode_t
 *
n
 = 
	`Êode_ü—‹
(&
¥
->
idË_d©a
[
i
]);

385 
	`check_mem
(
n
);

386 
	`li¡_­³nd
(
¥
->
idË_ä“
, 
n
);

389 
¥
->
idË_aùive
 = 
	`li¡_ü—‹
(¥->
max_idË
);

390 
	`check_mem
(
¥
->
idË_aùive
);

393 
”rÜ
:

395 
	}
}

398 
šlše
 
	$Su³rPŞl_add_idË
(
Su³rPŞl
 *
¥
, *
d©a
, 
fd
, 
rw
)

401 
	`check
(!
	`li¡_i£m±y
(
¥
->
idË_ä“
), "Too many open files,‚o free idle slots.");

403 
Êode_t
 *
Ãxt
 = 
	`li¡_d–_Ï¡
(
¥
->
idË_ä“
);

405 
IdËD©a
 *
id
 = (IdËD©¨*)
	`Êode_g‘
(
Ãxt
);

406 
	`as£¹
(
id
 && "Got‡n id NULL…tr fromhe free†ist.");

408 
id
->
fd
 = fd;

409 
id
->
d©a
 = data;

411 
	`li¡_­³nd
(
¥
->
idË_aùive
, 
Ãxt
);

414 
•Şl_ev’t
 
ev’t
;

416 if(
rw
 == 'r') {

417 
•Şl_ev’t
 
ev
 = {.
d©a
 = {.
±r
 = 
Ãxt
}, .
ev’ts
 = 
EPOLLIN
 | 
EPOLLONESHOT
};

418 
ev’t
 = 
ev
;

419 } if(
rw
 == 'w') {

420 
•Şl_ev’t
 
ev
 = {.
d©a
 = {.
±r
 = 
Ãxt
}, .
ev’ts
 = 
EPOLLOUT
 | 
EPOLLONESHOT
};

421 
ev’t
 = 
ev
;

423 
	`£Áš–
("Inv®idƒv’ˆ%øhªdedØsu³½Şl.„/w oÆy.", 
rw
);

427 
rc
 = 
	`•Şl_ùl
(
¥
->
idË_fd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
);

429 if(
rc
 =ğ-1 && 
”ºo
 =ğ
EEXIST
) {

431 
rc
 = 
	`•Şl_ùl
(
¥
->
idË_fd
, 
EPOLL_CTL_MOD
, 
fd
, &
ev’t
);

432 
	`check
(
rc
 != -1, "Could‚ot MOD fdhat's‡lready inƒpoll.");

433 } if(
rc
 == -1) {

434 
	`£Áš–
("Failedo‡dd FDoƒpoll.");

439 
”rÜ
:

441 
	}
}

444 
šlše
 
	$Su³rPŞl_add_idË_h™s
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
)

446 
nfds
 = 0;

447 
i
 = 0;

448 
rc
 = 0;

449 
zmq_pŞl™em_t
 
ev
 = {.
sock‘
 = 
NULL
};

451 
nfds
 = 
	`•Şl_wa™
(
¥
->
idË_fd
, 
	`Su³rPŞl_•Şl_ev’ts
(¥), sp->
max_idË
, 0);

452 
	`check
(
nfds
 >= 0, "Error doingƒpoll.");

453 
•Şl_ev’t
 *
ev’ts
 = 
	`Su³rPŞl_•Şl_ev’ts
(
¥
);

455 
i
 = 0; i < 
nfds
; i++) {

456 
Êode_t
 *
node
 = (Êode_ˆ*)
ev’ts
[
i
].
d©a
.
±r
;

457 
IdËD©a
 *
d©a
 = 
	`Êode_g‘
(
node
);

458 
ev
.
fd
 = 
d©a
->fd;

460 if(
ev’ts
[
i
].ev’t & 
EPOLLIN
) {

461 
ev
.
»v’ts
 = 
ZMQ_POLLIN
;

464 if(
ev’ts
[
i
].ev’t & 
EPOLLOUT
) {

465 
ev
.
»v’ts
 = 
ZMQ_POLLOUT
;

468 if(
ev
.
»v’ts
) {

469 
	`Su³rPŞl_add_h™
(
»suÉ
, &
ev
, 
d©a
->data);

473 
rc
 = 
	`•Şl_ùl
(
¥
->
idË_fd
, 
EPOLL_CTL_DEL
, 
ev
.
fd
, 
NULL
);

474 
	`check
(
rc
 !ğ-1, "FaedØ»movfd %d fromƒpŞl.", 
ev
.
fd
);

477 
node
 = 
	`li¡_d–‘e
(
¥
->
idË_aùive
,‚ode);

478 
	`li¡_­³nd
(
¥
->
idË_ä“
, 
node
);

480 
	`as£¹
(
	`li¡_couÁ
(
¥
->
idË_aùive
è+†i¡_couÁ(¥->
idË_ä“
è=ğ()¥->
max_idË
 && "We†ost one somewhere.");

483 
»suÉ
->
idË_fds
 = 
nfds
;

484  
nfds
;

486 
”rÜ
:

488 
	}
}

	@tools/src/superpoll.h

35 #iâdeà
_su³½Şl_h


36 
	#_su³½Şl_h


	)

38 
	~<adt/li¡.h
>

39 
	~<zmq.h
>

41 
	sIdËD©a
 {

42 
	mfd
;

43 *
	md©a
;

44 } 
	tIdËD©a
;

46 
	sSu³rPŞl
 {

49 
zmq_pŞl™em_t
 *
	mpŞlfd
;

51 **
	mhÙ_d©a
;

52 
	mnfd_hÙ
;

53 
	mmax_hÙ
;

56 *
	mev’ts
;

57 
	midË_fd
;

59 
	mmax_idË
;

60 
IdËD©a
 *
	midË_d©a
;

61 
li¡_t
 *
	midË_aùive
;

62 
li¡_t
 *
	midË_ä“
;

63 } 
	tSu³rPŞl
;

66 
	sPŞlEv’t
 {

67 
zmq_pŞl™em_t
 
	mev
;

68 *
	md©a
;

69 } 
	tPŞlEv’t
;

72 
	sPŞlResuÉ
 {

73 
	mhÙ_fds
;

74 
	mhÙ_©r
;

76 
	midË_fds
;

77 
	midË_©r
;

79 
	mnh™s
;

80 
PŞlEv’t
 *
	mh™s
;

81 } 
	tPŞlResuÉ
;

83 
Su³rPŞl_de¡roy
(
Su³rPŞl
 *
¥
);

85 
Su³rPŞl
 *
Su³rPŞl_ü—‹
();

87 
Su³rPŞl_add
(
Su³rPŞl
 *
¥
, *
d©a
, *
sock‘
, 
fd
, 
rw
, 
hÙ
);

88 
Su³rPŞl_d–
(
Su³rPŞl
 *
¥
, *
sock‘
, 
fd
, 
hÙ
);

90 
Su³rPŞl_com·ù_down
(
Su³rPŞl
 *
¥
, 
i
);

92 
Su³rPŞl_pŞl
(
Su³rPŞl
 *
¥
, 
PŞlResuÉ
 *
»suÉ
, 
ms
);

94 
Su³rPŞl_g‘_max_fd
();

96 
	#Su³rPŞl_aùive_hÙ
(
S
è((S)->
nfd_hÙ
)

	)

98 
	#Su³rPŞl_aùive_idË
(
S
è((S)->
idË_aùive
 ? 
	`li¡_couÁ
((S)->idË_aùiveè:0)

	)

100 
	#Su³rPŞl_aùive_couÁ
(
S
è(
	`Su³rPŞl_aùive_hÙ
(Sè+ 
	`Su³rPŞl_aùive_idË
(S))

	)

102 
	#Su³rPŞl_max_hÙ
(
S
è((S)->
max_hÙ
)

	)

103 
	#Su³rPŞl_max_idË
(
S
è((S)->
max_idË
)

	)

105 
	#Su³rPŞl_d©a
(
S
, 
I
è((S)->
hÙ_d©a
[(I)])

	)

107 
PŞlResuÉ_š™
(
Su³rPŞl
 *
p
, 
PŞlResuÉ
 *
»suÉ
);

109 
PŞlResuÉ_ş—n
(
PŞlResuÉ
 *
»suÉ
);

	@tools/src/task/386-ucontext.h

1 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

2 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

3 
mcÚ‹xt
 
	tmcÚ‹xt_t
;

4 
ucÚ‹xt
 
	tucÚ‹xt_t
;

6 
sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

7 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

8 
g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

9 
£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

73 
	smcÚ‹xt
 {

79 
	mmc_Ú¡ack
;

80 
	mmc_gs
;

81 
	mmc_fs
;

82 
	mmc_es
;

83 
	mmc_ds
;

84 
	mmc_edi
;

85 
	mmc_esi
;

86 
	mmc_ebp
;

87 
	mmc_i¥
;

88 
	mmc_ebx
;

89 
	mmc_edx
;

90 
	mmc_ecx
;

91 
	mmc_—x
;

92 
	mmc_Œ­no
;

93 
	mmc_”r
;

94 
	mmc_e
;

95 
	mmc_cs
;

96 
	mmc_eæags
;

97 
	mmc_e¥
;

98 
	mmc_ss
;

100 
	mmc_å»gs
[28];

101 
	m__¥¬e__
[17];

104 
	sucÚ‹xt
 {

113 
sig£t_t
 
	muc_sigmask
;

114 
mcÚ‹xt_t
 
	muc_mcÚ‹xt
;

116 
__ucÚ‹xt
 *
	muc_lšk
;

117 
¡ack_t
 
	muc_¡ack
;

118 
	m__¥¬e__
[8];

	@tools/src/task/amd64-ucontext.h

1 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

2 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

3 
mcÚ‹xt
 
	tmcÚ‹xt_t
;

4 
ucÚ‹xt
 
	tucÚ‹xt_t
;

6 
sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

7 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

8 
g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

9 
£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

73 
	smcÚ‹xt
 {

79 
	mmc_Ú¡ack
;

80 
	mmc_rdi
;

81 
	mmc_rsi
;

82 
	mmc_rdx
;

83 
	mmc_rcx
;

84 
	mmc_r8
;

85 
	mmc_r9
;

86 
	mmc_¿x
;

87 
	mmc_rbx
;

88 
	mmc_rbp
;

89 
	mmc_r10
;

90 
	mmc_r11
;

91 
	mmc_r12
;

92 
	mmc_r13
;

93 
	mmc_r14
;

94 
	mmc_r15
;

95 
	mmc_Œ­no
;

96 
	mmc_addr
;

97 
	mmc_æags
;

98 
	mmc_”r
;

99 
	mmc_r
;

100 
	mmc_cs
;

101 
	mmc_ræags
;

102 
	mmc_r¥
;

103 
	mmc_ss
;

105 
	mmc_Ën
;

106 
	#_MC_FPFMT_NODEV
 0x10000

	)

107 
	#_MC_FPFMT_XMM
 0x10002

	)

108 
	mmc_åfÜm©
;

109 
	#_MC_FPOWNED_NONE
 0x20000

	)

110 
	#_MC_FPOWNED_FPU
 0x20001

	)

111 
	#_MC_FPOWNED_PCB
 0x20002

	)

112 
	mmc_owÃdå
;

116 
	mmc_å¡©e
[64];

117 
	mmc_¥¬e
[8];

120 
	sucÚ‹xt
 {

129 
sig£t_t
 
	muc_sigmask
;

130 
mcÚ‹xt_t
 
	muc_mcÚ‹xt
;

132 
__ucÚ‹xt
 *
	muc_lšk
;

133 
¡ack_t
 
	muc_¡ack
;

134 
	m__¥¬e__
[8];

	@tools/src/task/context.c

3 
	~"skim¶.h
"

5 #ià
defšed
(
__APPLE__
)

6 #ià
defšed
(
__i386__
)

7 
	#NEEDX86MAKECONTEXT


	)

8 
	#NEEDSWAPCONTEXT


	)

9 #–ià
defšed
(
__x86_64__
)

10 
	#NEEDAMD64MAKECONTEXT


	)

11 
	#NEEDSWAPCONTEXT


	)

13 
	#NEEDPOWERMAKECONTEXT


	)

14 
	#NEEDSWAPCONTEXT


	)

18 #ià
defšed
(
__F»eBSD__
è&& defšed(
__i386__
) && __FreeBSD__ < 5

19 
	#NEEDX86MAKECONTEXT


	)

20 
	#NEEDSWAPCONTEXT


	)

23 #ià
defšed
(
__O³nBSD__
)

24 #ià
defšed
(
__i386__
)

25 
	#NEEDX86MAKECONTEXT


	)

26 
	#NEEDSWAPCONTEXT


	)

27 #–ià
defšed
(
__x86_64__
)

28 
	#NEEDAMD64MAKECONTEXT


	)

29 
	#NEEDSWAPCONTEXT


	)

33 #ià
defšed
(
__lšux__
è&& defšed(
__¬m__
)

34 
	#NEEDSWAPCONTEXT


	)

35 
	#NEEDARMMAKECONTEXT


	)

38 #ifdeà
NEEDPOWERMAKECONTEXT


39 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uı
, (*
func
)(), 
¬gc
, ...)

41 
ulÚg
 *
¥
, *
tos
;

42 
va_li¡
 
¬g
;

44 
tos
 = (
ulÚg
*)
uı
->
uc_¡ack
.
ss_¥
+uı->uc_¡ack.
ss_size
/(ulong);

45 
¥
 = 
tos
 - 16;

46 
uı
->
mc
.
pc
 = ()
func
;

47 
uı
->
mc
.
¥
 = ()sp;

48 
	`va_¡¬t
(
¬g
, 
¬gc
);

49 
uı
->
mc
.
r3
 = 
	`va_¬g
(
¬g
, );

50 
	`va_’d
(
¬g
);

51 
	}
}

54 #ifdeà
NEEDX86MAKECONTEXT


55 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uı
, (*
func
)(), 
¬gc
, ...)

57 *
¥
;

59 
¥
 = (*)
uı
->
uc_¡ack
.
ss_¥
+uı->uc_¡ack.
ss_size
/4;

60 
¥
 -ğ
¬gc
;

61 
¥
 = (*)((
ušŒ_t
)sp - (uintptr_t)sp%16);

62 
	`memmove
(
¥
, &
¬gc
+1,‡rgc*());

64 *--
¥
 = 0;

65 
uı
->
uc_mcÚ‹xt
.
mc_e
 = ()
func
;

66 
uı
->
uc_mcÚ‹xt
.
mc_e¥
 = ()
¥
;

67 
	}
}

70 #ifdeà
NEEDAMD64MAKECONTEXT


71 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uı
, (*
func
)(), 
¬gc
, ...)

73 *
¥
;

74 
va_li¡
 
va
;

76 
	`mem£t
(&
uı
->
uc_mcÚ‹xt
, 0,  ucp->uc_mcontext);

77 if(
¬gc
 != 2)

79 
	`va_¡¬t
(
va
, 
¬gc
);

80 
uı
->
uc_mcÚ‹xt
.
mc_rdi
 = 
	`va_¬g
(
va
, );

81 
uı
->
uc_mcÚ‹xt
.
mc_rsi
 = 
	`va_¬g
(
va
, );

82 
	`va_’d
(
va
);

83 
¥
 = (*)
uı
->
uc_¡ack
.
ss_¥
+uı->uc_¡ack.
ss_size
/();

84 
¥
 -ğ
¬gc
;

85 
¥
 = (*)((
ušŒ_t
)sp - (uintptr_t)sp%16);

86 *--
¥
 = 0;

87 
uı
->
uc_mcÚ‹xt
.
mc_r
 = ()
func
;

88 
uı
->
uc_mcÚ‹xt
.
mc_r¥
 = ()
¥
;

89 
	}
}

92 #ifdeà
NEEDARMMAKECONTEXT


93 
makecÚ‹xt
(
ucÚ‹xt_t
 *
uc
, (*
â
)(), 
¬gc
, ...)

95 
i
, *
¥
;

96 
va_li¡
 
¬g
;

98 
¥
 = (*)
uc
->
uc_¡ack
.
ss_¥
+uc->uc_¡ack.
ss_size
/4;

99 
	`va_¡¬t
(
¬g
, 
¬gc
);

101 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r0
 = 
	`va_¬g
(
¬g
, 
ušt
);

102 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r1
 = 
	`va_¬g
(
¬g
, 
ušt
);

103 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r2
 = 
	`va_¬g
(
¬g
, 
ušt
);

104 if(
¬gc
-- > 0è
uc
->
uc_mcÚ‹xt
.
¬m_r3
 = 
	`va_¬g
(
¬g
, 
ušt
);

106 
	`va_’d
(
¬g
);

107 
uc
->
uc_mcÚ‹xt
.
¬m_¥
 = (
ušt
)
¥
;

108 
uc
->
uc_mcÚ‹xt
.
¬m_Ì
 = (
ušt
)
â
;

109 
	}
}

112 #ifdeà
NEEDSWAPCONTEXT


113 
	$sw­cÚ‹xt
(
ucÚ‹xt_t
 *
ouı
, cÚ¡ ucÚ‹xt_ˆ*
uı
)

115 if(
	`g‘cÚ‹xt
(
ouı
) == 0) {

116 
	`£tcÚ‹xt
(
uı
);

120 
	}
}

	@tools/src/task/fd.c

1 
	~"skim¶.h
"

2 
	~<zmq.h
>

3 
	~<sys/pŞl.h
>

4 
	~<fú.h
>

5 
	~<¡dio.h
>

6 
	~<sigÇl.h
>

7 
	~<sys/sock‘.h
>

9 
	~"su³½Şl.h
"

10 
	~"dbg.h
"

11 
	~"£‰šg.h
"

12 
	~"»gi¡”.h
"

15 
	gSTARTED_FDTASK
 = 0;

16 
Taskli¡
 
	g¦“pšg
;

17 
	g¦“pšgcouÁed
;

18 
uvlÚg
 
n£c
();

19 
Su³rPŞl
 *
	gPOLL
 = 
NULL
;

20 
Task
 *
	gFDTASK
;

22 *
	gZMQ_CTX
 = 
NULL
;

24 
	gFDSTACK
= 100 * 1024;

26 #iâdeà
MSG_NOSIGNAL


27 
	#MSG_NOSIGNAL
 0

	)

30 
	$mqš™
(
th»ads
)

32 if(
ZMQ_CTX
 =ğ
NULL
) {

33 
ZMQ_CTX
 = 
	`zmq_š™
(
th»ads
);

35 if(!
ZMQ_CTX
) {

36 
	`´štf
("Error setting up 0mq.\n");

37 
	`ex™
(1);

40 
	}
}

42 
šlše
 
	$Ãxt_sk_¦“±ime
(
mš
)

44 
Task
 *
t
;

45 
uvlÚg
 
now
 = 0;

46 
ms
 = 0;

48 if((
t
=
¦“pšg
.
h—d
è=ğ
NULL
)

49 
ms
 = -1;

51 
now
 = 
	`n£c
();

52 if(
now
 >ğ
t
->
®¬mtime
) {

53 
ms
 = 0;

55 
ms
 = (
t
->
®¬mtime
 - 
now
) / 1000000;

58 if(
ms
 % 
mš
 != 0) ms = ms - (ms % min);

61 if(
ms
 =ğ0èm ğ
mš
;

63  
ms
;

64 
	}
}

66 
šlše
 
	$wake_¦“³rs
()

68 
Task
 *
t
;

69 
uvlÚg
 
now
 = 
	`n£c
();

71 (
t
 =
¦“pšg
.
h—d
è&& 
now
 >ğt->
®¬mtime
){

72 
	`d–sk
(&
¦“pšg
, 
t
);

74 if(!
t
->
sy¡em
 && --
¦“pšgcouÁed
 =ğ0è
skcouÁ
--;

76 
	`sk»ady
(
t
);

78 
	}
}

80 
šlše
 
	$fdsk_shutdown
()

82 
i
 = 0;

84 
i
 = 0; i < 
	`Su³rPŞl_aùive_hÙ
(
POLL
); i++) {

85 
	`Su³rPŞl_com·ù_down
(
POLL
, 
i
);

89 
Task
 *
t
 = 
NULL
;

90 (
t
 = 
¦“pšg
.
h—d
)){

91 
	`d–sk
(&
¦“pšg
, 
t
);

92 
	`sksigÇl
(
t
, 
	`sk_was_sigÇËd
());

94 
	}
}

96 
	$fdsk
(*
v
)

98 
i
, 
ms
;

99 
PŞlResuÉ
 
»suÉ
;

100 
rc
 = 0;

101 
FDTASK
 = 
	`sk£lf
();

103 
rc
 = 
	`PŞlResuÉ_š™
(
POLL
, &
»suÉ
);

104 
	`check
(
rc
 == 0, "Failedo initializehe…oll„esult.");

106 
	`sksy¡em
();

107 
	`skÇme
("fdtask");

111 
	`sky›ld
() > 0)

115 
”ºo
 = 0;

116 
	`sk¡©e
("poll");

118 
ms
 = 
	`Ãxt_sk_¦“±ime
(500);

120 if(
	`sk_was_sigÇËd
()) {

121 
	`fdsk_shutdown
();

122 
	`sk_ş—r_sigÇl
();

125 
rc
 = 
	`Su³rPŞl_pŞl
(
POLL
, &
»suÉ
, 
ms
);

126 
	`check
(
rc
 != -1, "SuperPoll failure,‡borting.");

128 
i
 = 0; i < 
rc
; i++) {

129 
	`sk»ady
(
»suÉ
.
h™s
[
i
].
d©a
);

132 
	`wake_¦“³rs
();

137 
	`PŞlResuÉ_ş—n
(&
»suÉ
);

138 
FDTASK
 = 
NULL
;

141 
”rÜ
:

142 
	`skex™®l
(1);

143 
	}
}

147 
šlše
 
	$¡¬tfdsk
()

149 if(!
STARTED_FDTASK
) {

150 
FDSTACK
 = 
	`S‘tšg_g‘_št
("limits.fdtask_stack", 100 * 1024);

151 
	`log_šfo
("MAX†im™s.fdsk_¡ack=%d", 
FDSTACK
);

153 
POLL
 = 
	`Su³rPŞl_ü—‹
();

154 
STARTED_FDTASK
 = 1;

155 
	`skü—‹
(
fdsk
, 0, 
FDSTACK
);

157 
	}
}

159 
	$skwa™šg
()

161 
	`¡¬tfdsk
();

163  
	`Su³rPŞl_aùive_couÁ
(
POLL
);

164 
	}
}

167 
ušt
 
	$skd–ay
(
ušt
 
ms
)

169 
uvlÚg
 
wh’
 = 0L;

170 
uvlÚg
 
now
 = 0L;

171 
Task
 *
t
 = 
NULL
;

173 
	`¡¬tfdsk
();

175 
now
 = 
	`n£c
();

176 
wh’
 = 
now
 + (
uvlÚg
)
ms
 * 1000000;

177 
t
=
¦“pšg
.
h—d
; !ğ
NULL
 &&->
®¬mtime
 < 
wh’
;ñ->
Ãxt
)

180 if(
t
) {

181 
skruÂšg
->
´ev
 = 
t
->prev;

182 
skruÂšg
->
Ãxt
 = 
t
;

184 
skruÂšg
->
´ev
 = 
¦“pšg
.

;

185 
skruÂšg
->
Ãxt
 = 
NULL
;

188 
t
 = 
skruÂšg
;

189 
t
->
®¬mtime
 = 
wh’
;

191 if(
t
->
´ev
) {

192 
t
->
´ev
->
Ãxt
 =;

194 
¦“pšg
.
h—d
 = 
t
;

197 if(
t
->
Ãxt
) {

198 
t
->
Ãxt
->
´ev
 =;

200 
¦“pšg
.

 = 
t
;

203 if(!
t
->
sy¡em
 && 
¦“pšgcouÁed
++ == 0) {

204 
skcouÁ
++;

207 
	`sksw™ch
();

209  (
	`n£c
(è- 
now
) / 1000000;

210 
	}
}

212 
	$_wa™
(*
sock‘
, 
fd
, 
rw
)

214 
	`¡¬tfdsk
();

215 
	`check
(
sock‘
 !ğ
NULL
 || 
fd
 >= 0, "Attempto wait on‡ dead socket/fd: %p or %d", socket, fd);

217 
max
 = 0;

218 
hÙ_add
 = 
	`Su³rPŞl_aùive_hÙ
(
POLL
è< 
	`Su³rPŞl_max_hÙ
(POLL);

219 
was_»gi¡”ed
 = 0;

221 if(
sock‘
 !ğ
NULL
) {

222 
	`sk¡©e
(
rw
 == 'r' ? "read handler" : "write handler");

224 
was_»gi¡”ed
 = 
	`Regi¡”_fd_exi¡s
(
fd
è!ğ
NULL
;

225 
	`sk¡©e
(
rw
 == 'r' ? "read fd" : "write fd");

228 
max
 = 
	`Su³rPŞl_add
(
POLL
, (*)
skruÂšg
, 
sock‘
, 
fd
, 
rw
, 
hÙ_add
);

229 
	`check
(
max
 !ğ-1, "E¼Ü‡ddšg fd: %d o¸sock‘: %°tØsk wa™†i¡.", 
fd
, 
sock‘
);

231 
	`sksw™ch
();

233 if(
	`sk_was_sigÇËd
()) {

234 
	`debug
("GOT SIGNAL %d AFTER WAIT", 
skruÂšg
->
sigÇl
);

235 
	`Su³rPŞl_d–
(
POLL
, 
sock‘
, 
fd
, 
hÙ_add
);

237 } if(
was_»gi¡”ed
 && 
	`Regi¡”_fd_exi¡s
(
fd
è=ğ
NULL
) {

238 
	`debug
("Sock‘ %d wa şo£d‡á”‡ wa™.", 
fd
);

244 
”rÜ
:

246 
	}
}

248 
	$fdwa™
(
fd
, 
rw
)

250  
	`_wa™
(
NULL
, 
fd
, 
rw
);

251 
	}
}

253 *
	$mqsock‘
(
ty³
)

255 *
sock
 = 
	`zmq_sock‘
(
ZMQ_CTX
, 
ty³
);

256 
	`check
(
sock
 !ğ
NULL
, "Failedo create zmq socket.");

258 #ifdeà
ZMQ_LINGER


259 
İt
 = 0;

260 
rc
 = 
	`zmq_£tsockİt
(
sock
, 
ZMQ_LINGER
, &
İt
, (opt));

261 
	`check
(
rc
 == 0, "Failedo set†ingerimeout for socket.");

264  
sock
;

266 
”rÜ
:

267 if(
sock
è
	`zmq_şo£
(sock);

268  
NULL
;

269 
	}
}

271 
	$mqwa™
(*
sock‘
, 
rw
)

273  
	`_wa™
(
sock‘
, -1, 
rw
);

274 
	}
}

276 
	$mq»cv
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
)

278 
rc
 = -1;

281 
rc
 = 
	`zmq_»cv
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

284 
rc
 !ğ0 && 
æags
 !ğ
ZMQ_NOBLOCK
 && 
”ºo
 =ğ
EAGAIN
) {

285 if(
	`mqwa™
(
sock‘
, 'r') == -1) {

289 
rc
 = 
	`zmq_»cv
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

292  
rc
;

293 
	}
}

295 
	$mq£nd
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
)

297 
rc
 = -1;

300 
rc
 = 
	`zmq_£nd
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

303 
rc
 !ğ0 && 
æags
 !ğ
ZMQ_NOBLOCK
 && 
”ºo
 =ğ
EAGAIN
) {

304 if(
	`mqwa™
(
sock‘
, 'w') == -1) {

308 
rc
 = 
	`zmq_£nd
(
sock‘
, 
msg
, 
ZMQ_NOBLOCK
);

311  
rc
;

312 
	}
}

316 
	$fd»ad1
(
fd
, *
buf
, 
n
)

318 
m
;

321 if(
	`fdwa™
(
fd
, 'r') == -1) {

324 } (
m
 = 
	`»ad
(
fd
, 
buf
, 
n
)è< 0 && 
”ºo
 =ğ
EAGAIN
);

326  
m
;

327 
	}
}

329 
	$fd»cv1
(
fd
, *
buf
, 
n
)

331 
m
;

334 if(
	`fdwa™
(
fd
, 'r') == -1) {

337 } (
m
 = 
	`»cv
(
fd
, 
buf
, 
n
, 
MSG_NOSIGNAL
)è< 0 && 
”ºo
 =ğ
EAGAIN
);

339  
m
;

340 
	}
}

342 
	$fd»ad
(
fd
, *
buf
, 
n
)

344 
m
;

346 (
m
=
	`»ad
(
fd
, 
buf
, 
n
)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

347 if(
	`fdwa™
(
fd
, 'r') == -1) {

351  
m
;

352 
	}
}

354 
	$fd»cv
(
fd
, *
buf
, 
n
)

356 
m
;

358 (
m
=
	`»cv
(
fd
, 
buf
, 
n
, 
MSG_NOSIGNAL
)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

359 if(
	`fdwa™
(
fd
, 'r') == -1) {

363  
m
;

364 
	}
}

366 
	$fdwr™e
(
fd
, *
buf
, 
n
)

368 
m
 = 0;

369 
tÙ
 = 0;

371 
tÙ
 = 0;Ù < 
n
;Ù +ğ
m
){

372 (
m
=
	`wr™e
(
fd
, (*)
buf
+
tÙ
, 
n
-tÙ)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

373 if(
	`fdwa™
(
fd
, 'w') == -1) {

378 if(
m
 < 0)  m;

379 if(
m
 == 0) ;

382  
tÙ
;

383 
	}
}

385 
	$fd£nd
(
fd
, *
buf
, 
n
)

387 
m
 = 0;

388 
tÙ
 = 0;

390 
tÙ
 = 0;Ù < 
n
;Ù +ğ
m
){

391 (
m
=
	`£nd
(
fd
, (*)
buf
+
tÙ
, 
n
-tÙ, 
MSG_NOSIGNAL
)è< 0 && 
”ºo
 =ğ
EAGAIN
) {

392 if(
	`fdwa™
(
fd
, 'w') == -1) {

397 if(
m
 < 0)  m;

398 if(
m
 == 0) ;

400  
tÙ
;

401 
	}
}

403 
	$fdnoblock
(
fd
)

405 #ifdeà
SO_NOSIGPIPE


406 
£t
 = 1;

407 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_NOSIGPIPE
, (*)&
£t
, ());

410  
	`fú
(
fd
, 
F_SETFL
, fú(fd, 
F_GETFL
)|
O_NONBLOCK
);

411 
	}
}

413 
uvlÚg
 
	$n£c
()

415 
timev®
 
tv
;

417 if(
	`g‘timeofday
(&
tv
, 0) < 0) {

421  (
uvlÚg
)
tv
.
tv_£c
*1000*1000*1000 +v.
tv_u£c
*1000;

422 
	}
}

	@tools/src/task/net.c

1 
	~"skim¶.h
"

2 
	~"dbg.h
"

3 
	~"£rv”.h
"

4 
	~<sys/ty³s.h
>

5 
	~<sys/sock‘.h
>

6 
	~<Ãtdb.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<Ãtš‘/tı.h
>

9 
	~<sys/pŞl.h
>

10 
	~<¡dio.h
>

11 
	~<¬·/š‘.h
>

26 
	mCB_BIND
 = 0,

27 
	mCB_CONNECT


30 
	gMAX_LISTEN_BACKLOG
 = 128;

31 
	gSET_NODELAY
 = 1;

33 
	$addr_Áİ
(*
sšx
, *
rg‘
, 
size
)

35 
sockaddr_š6
 *
sš6
 = 
sšx
;

36 
sockaddr_š
 *
sš
 = 
sšx
;

38 if(
sš6
->
sš6_çmy
 =ğ
AF_INET6
) {

39 
	`š‘_Áİ
(
AF_INET6
, &
sš6
->
sš6_addr
, 
rg‘
, 
size
);

41 
	`š‘_Áİ
(
AF_INET
, &
sš
->
sš_addr
, 
rg‘
, 
size
);

43 
	}
}

45 
	$cb_bšd
(
fd
, 
i¡ı
, 
sockaddr
 *
p§
, 
size_t
 
sz
)

47 
n
 = 0;

48 
sockËn_t
 
¢
 = (
n
);

49 
¡r
[
IPADDR_SIZE
+1];

50 
rc
 = 0;

52 
	`addr_Áİ
(
p§
, 
¡r
, 
IPADDR_SIZE
);

53 
	`debug
("BšdšgØ%s:%d!", 
¡r
, 
	`Áohs
(((
sockaddr_š6
*)
p§
)->
sš6_pÜt
));

56 if(
i¡ı
 && 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_TYPE
, (*)&
n
, &
¢
) >= 0){

57 
n
 = 1;

58 
rc
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
n
, ‚);

59 
	`check
(
rc
 != -1, "Failedo set bind socketo SO_REUSEADDR,hat's messed up.");

62 
rc
 = 
	`bšd
(
fd
, 
p§
, 
sz
);

63 
	`check
(
rc
 != -1, "Failedo bindo‡ddress.");

65 if(
i¡ı
) {

66 
rc
 = 
	`li¡’
(
fd
, 
MAX_LISTEN_BACKLOG
);

67 
	`check
(
rc
 !ğ-1, "FaedØli¡’ w™h %d backlog", 
MAX_LISTEN_BACKLOG
);

70  
fd
;

72 
”rÜ
:

73 
	`sk¡©e
("bind failed");

74 
	`fdşo£
(
fd
);

76 
	}
}

78 
	$cb_cÚÃù
(
fd
, 
i¡ı
, 
sockaddr
 *
p§
, 
sockËn_t
 
¢
)

80 
n
 = 0;

81 
rc
 = 0;

84 if(!
i¡ı
) {

85 
n
 = 1;

86 
rc
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_BROADCAST
, &
n
, ‚);

87 
	`check
(
rc
 != -1, "Failedo set SO_BROADCAST on UDP socket.");

91 
rc
 = 
	`cÚÃù
(
fd
, 
p§
, 
¢
);

92 
	`check
(
rc
 !ğ-1 || 
”ºo
 =ğ
EINPROGRESS
, "Connect failed.");

95 
rc
 = 
	`fdwa™
(
fd
, 'w');

96 
	`check
(
rc
 != -1, "Failed waiting on‚on-blocking connect.");

98 
¢
 =  *
p§
;

99 
rc
 = 
	`g‘³”Çme
(
fd
, 
p§
, &
¢
);

100 
	`check_debug
(
rc
 != -1, "Connection failed,ƒither…ort isn't open or…eername isn't‡vailable.");

102  
fd
;

105 
”rÜ
:

107 
¢
 =  
n
;

108 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
n
, &
¢
);

109 
”ºo
 = 
n
 =ğ0 ? 
ECONNREFUSED
 :‚;

111 
	`fdşo£
(
fd
);

112 
	`sk¡©e
("connect failed");

115 
	}
}

118 
	$Ãtg‘sock‘
(
i¡ı
, *
£rv”
, 
pÜt
,

119 
is_aùive_İ’
)

121 
rc
 = 0;

122 
fd
 = -1;

123 
´Ùo
 = 
i¡ı
 ? 
SOCK_STREAM
 : 
SOCK_DGRAM
;

124 
¡r
[
IPADDR_SIZE
+1];

125 
addršfo
 *
»s
 = 
NULL
, *
»s§ve
 = NULL;

126 
·ssive
 = 
is_aùive_İ’
 && 
£rv”
 =ğ
NULL
 ? 0 : 
AI_PASSIVE
;

127 
num”ic
 = 
is_aùive_İ’
 ? 0 : 
AI_NUMERICHOST
;

129 
addršfo
 
hšts
 = {

130 .
ai_sockty³
 = 
´Ùo
,

131 .
ai_æags
 = 
num”ic
 | 
·ssive


135 
£rviû
[6] = {0};

137 
	`check
(
pÜt
 >= 0 &&…ort <= 65535, "Port %d is outsid‡llowed„ange.",…ort);

139 
	`debug
("Attempting‚etgetsocket: %d, %s:%d,‡ctive: %d",

140 
i¡ı
, 
£rv”
, 
pÜt
,

141 
is_aùive_İ’
);

143 
´Ùo
 = 
i¡ı
 ? 
SOCK_STREAM
 : 
SOCK_DGRAM
;

145 
hšts
.
ai_sockty³
 = 
´Ùo
;

148 
	`¢´štf
(
£rviû
, (£rviû), "%d", 
pÜt
);

149 
£rviû
[(service) - 1] = '\0';

151 
rc
 = 
	`g‘addršfo
(
£rv”
, 
£rviû
, &
hšts
, &
»s
);

152 
	`check
(
rc
 !ğ-1, "G‘‡ddršfØçed fÜ s”v”: %s.", 
£rv”
);

154 
»s§ve
 = 
»s
;

156 
	`debug
("Enumeratingargets...");

157 ; 
»s
;„e ğ»s->
ai_Ãxt
) {

158 
	`addr_Áİ
(
»s
->
ai_addr
, 
¡r
, 
IPADDR_SIZE
);

159 
	`debug
("Tryšg¬g‘: %s:%d,‡à%d,…rÙ %d", 
¡r
,

160 
	`Áohs
(((
sockaddr_š6
*)(
»s
->
ai_addr
))->
sš6_pÜt
),„es->
ai_çmy
,

161 
»s
->
ai_´ÙocŞ
);

163 
fd
 = 
	`sock‘
(
»s
->
ai_çmy
,

164 
´Ùo
,

165 
»s
->
ai_´ÙocŞ
);

167 if(
fd
 < 0) {

168 
”ºo
) {

169 
EAFNOSUPPORT
:

171 
EPROTONOSUPPORT
:

173 
	`debug
("Famy %d‚Ù suµÜ‹d", 
»s
->
ai_çmy
);

176 
	`£Áš–
("Socket failureƒnumerating…ossible‡ddresses.");

179 
	`fdnoblock
(
fd
);

183 if(
is_aùive_İ’
) {

184 
fd
 = 
	`cb_cÚÃù
(fd, 
i¡ı
, (*)
»s
->
ai_addr
,„es->
ai_add¾’
);

186 
fd
 = 
	`cb_bšd
(fd, 
i¡ı
, (*è
»s
->
ai_addr
,„es->
ai_add¾’
);

189 if(
fd
 >= 0) {

195 if(
»s§ve
) {

196 
	`ä“addršfo
(
»s§ve
);

199  
fd
;

201 
”rÜ
:

202 if(
»s§ve
) {

203 
	`ä“addršfo
(
»s§ve
);

206 
	}
}

208 
	$ÃÂounû
(
i¡ı
, *
£rv”
, 
pÜt
)

210  
	`Ãtg‘sock‘
(
i¡ı
, 
£rv”
, 
pÜt
, 
CB_BIND
);

211 
	}
}

213 
	$Ãcû±
(
fd
, *
£rv”
, *
pÜt
)

215 
cfd
 = 0;

216 
İt
 = 0;

220 
sockaddr_š6
 
v6
;

221 
sockaddr_š
 
v4
;

222 } 
addr_cÚv”‹r
;

224 
sockËn_t
 
Ën
 = (
addr_cÚv”‹r
);

225 
rc
 = 0;

227 
cfd
 = 
	`acû±
(
fd
, (*)&
addr_cÚv”‹r
, &
Ën
);

229 if(
cfd
 == -1) {

230 if(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

231 
rc
 = 
	`fdwa™
(
fd
, 'r');

232 
	`check
(
rc
 != -1, "Failed waiting on‚on-block‡ccept.");

234 
cfd
 = 
	`acû±
(
fd
, (*)&
addr_cÚv”‹r
, &
Ën
);

235 
	`check
(
cfd
 != -1, "Failedo‡ccept‡fter doing‡…oll onhe socket.");

237 
	`£Áš–
("Faed c®lšg‡cû± oÀsock‘h© wa »ady: %d, %d", 
cfd
, 
”ºo
 =ğ
EAGAIN
);

241 if(
£rv”
) {

242 if(
addr_cÚv”‹r
.
v6
.
sš6_çmy
 =ğ
AF_INET
) {

243 
	`check
(
	`š‘_Áİ
(
addr_cÚv”‹r
.
v4
.
sš_çmy
, &addr_cÚv”‹r.v4.
sš_addr
, 
£rv”
, 
IPADDR_SIZE
è!ğ
NULL
,

246 
	`check
(
	`š‘_Áİ
(
addr_cÚv”‹r
.
v6
.
sš6_çmy
, &addr_cÚv”‹r.v6.
sš6_addr
, 
£rv”
, 
IPADDR_SIZE
è!ğ
NULL
,

251 if(
pÜt
) {

252 if(
addr_cÚv”‹r
.
v6
.
sš6_çmy
 =ğ
AF_INET
) {

253 *
pÜt
 = 
	`Áohs
(
addr_cÚv”‹r
.
v4
.
sš_pÜt
);

255 *
pÜt
 = 
	`Áohs
(
addr_cÚv”‹r
.
v6
.
sš6_pÜt
);

259 
	`fdnoblock
(
cfd
);

261 if(
SET_NODELAY
) {

262 
İt
 = 1;

263 
	`£tsockİt
(
cfd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
İt
,  opt);

266 
	`sk¡©e
("netaccept succeeded");

267  
cfd
;

269 
”rÜ
:

270 
	`sk¡©e
("accept failed");

272 
	}
}

275 
	$ÃtdŸl
(
i¡ı
, *
£rv”
, 
pÜt
)

277  
	`Ãtg‘sock‘
(
i¡ı
, 
£rv”
, 
pÜt
, 
CB_CONNECT
);

278 
	}
}

	@tools/src/task/power-ucontext.h

1 
	#£tcÚ‹xt
(
u
è
	`_£tmcÚ‹xt
(&(u)->
mc
)

	)

2 
	#g‘cÚ‹xt
(
u
è
	`_g‘mcÚ‹xt
(&(u)->
mc
)

	)

3 
mcÚ‹xt
 
	tmcÚ‹xt_t
;

4 
ucÚ‹xt
 
	tucÚ‹xt_t
;

5 
	smcÚ‹xt


7 
ulÚg
 
	mpc
;

8 
ulÚg
 
	mü
;

9 
ulÚg
 
	mùr
;

10 
ulÚg
 
	mx”
;

11 
ulÚg
 
	m¥
;

12 
ulÚg
 
	mtoc
;

13 
ulÚg
 
	mr3
;

14 
ulÚg
 
	mg´
[19];

23 
	sucÚ‹xt


26 *
	mss_¥
;

27 
ušt
 
	mss_size
;

28 } 
	muc_¡ack
;

29 
sig£t_t
 
	muc_sigmask
;

30 
mcÚ‹xt_t
 
	mmc
;

33 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

34 
	`sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

35 
	`_g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

36 
	`_£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

	@tools/src/task/qlock.c

1 
	~"skim¶.h
"

2 
	~"dbg.h
"

7 
	$_qlock
(
QLock
 *
l
, 
block
)

9 if(
l
->
owÃr
 =ğ
NULL
){

10 
l
->
owÃr
 = 
skruÂšg
;

14 if(!
block
) {

18 
	`addsk
(&
l
->
wa™šg
, 
skruÂšg
);

19 
	`sk¡©e
("qlock");

20 
	`sksw™ch
();

22 
	`as£¹
(
l
->
owÃr
 =ğ
skruÂšg
 && "qlockƒrror, owner is‚othe„unningask");

25 
	}
}

27 
	$qlock
(
QLock
 *
l
)

29 
	`_qlock
(
l
, 1);

30 
	}
}

32 
	$ÿnqlock
(
QLock
 *
l
)

34  
	`_qlock
(
l
, 0);

35 
	}
}

37 
	$quÆock
(
QLock
 *
l
)

39 
Task
 *
»ady
 = 
NULL
;

41 
	`as£¹
(
l
->
owÃr
 != 0 && "qunlock: owner == 0\n");

43 if((
l
->
owÃr
 = 
»ady
 =†->
wa™šg
.
h—d
è!ğ
NULL
) {

44 
	`d–sk
(&
l
->
wa™šg
, 
»ady
);

45 
	`sk»ady
(
»ady
);

47 
	}
}

49 
	$_¾ock
(
RWLock
 *
l
, 
block
)

51 if(
l
->
wr™”
 =ğ
NULL
 &&†->
wwa™šg
.
h—d
 == NULL){

52 
l
->
»ad”s
++;

56 if(!
block
) {

60 
	`addsk
(&
l
->
rwa™šg
, 
skruÂšg
);

61 
	`sk¡©e
("rlock");

62 
	`sksw™ch
();

65 
	}
}

67 
	$¾ock
(
RWLock
 *
l
)

69 
	`_¾ock
(
l
, 1);

70 
	}
}

72 
	$ÿÄlock
(
RWLock
 *
l
)

74  
	`_¾ock
(
l
, 0);

75 
	}
}

77 
	$_wlock
(
RWLock
 *
l
, 
block
)

79 if(
l
->
wr™”
 =ğ
NULL
 &&†->
»ad”s
 == 0) {

80 
l
->
wr™”
 = 
skruÂšg
;

84 if(!
block
) {

88 
	`addsk
(&
l
->
wwa™šg
, 
skruÂšg
);

89 
	`sk¡©e
("wlock");

90 
	`sksw™ch
();

92 
	}
}

94 
	$wlock
(
RWLock
 *
l
)

96 
	`_wlock
(
l
, 1);

97 
	}
}

99 
	$ÿnwlock
(
RWLock
 *
l
)

101  
	`_wlock
(
l
, 0);

102 
	}
}

104 
	$ruÆock
(
RWLock
 *
l
)

106 
Task
 *
t
 = 
NULL
;

108 if(--
l
->
»ad”s
 =ğ0 && (
t
 =†->
wwa™šg
.
h—d
è!ğ
NULL
) {

109 
	`d–sk
(&
l
->
wwa™šg
, 
t
);

110 
l
->
wr™”
 = 
t
;

111 
	`sk»ady
(
t
);

113 
	}
}

115 
	$wuÆock
(
RWLock
 *
l
)

117 
Task
 *
t
 = 
NULL
;

119 
	`as£¹
(
l
->
wr™”
 !ğ
NULL
 && "wunlock:‚ot†ocked.");

121 
l
->
wr™”
 = 
NULL
;

122 
	`as£¹
(
l
->
»ad”s
 == 0 && "wunlock:„eaders is wrong.");

124 (
t
 = 
l
->
rwa™šg
.
h—d
è!ğ
NULL
){

125 
	`d–sk
(&
l
->
rwa™šg
, 
t
);

126 
l
->
»ad”s
++;

127 
	`sk»ady
(
t
);

130 if(
l
->
»ad”s
 =ğ0 && (
t
 =†->
wwa™šg
.
h—d
è!ğ
NULL
){

131 
	`d–sk
(&
l
->
wwa™šg
, 
t
);

132 
l
->
wr™”
 = 
t
;

133 
	`sk»ady
(
t
);

135 
	}
}

	@tools/src/task/rendez.c

1 
	~"skim¶.h
"

6 
	$sk¦“p
(
R’dez
 *
r
)

8 
	`addsk
(&
r
->
wa™šg
, 
skruÂšg
);

10 if(
r
->
l
) {

11 
	`quÆock
(
r
->
l
);

14 
	`sk¡©e
("sleep");

15 
	`sksw™ch
();

17 if(
r
->
l
) {

18 
	`qlock
(
r
->
l
);

20 
	}
}

22 
	$_skwakeup
(
R’dez
 *
r
, 
®l
)

24 
i
;

25 
Task
 *
t
;

27 
i
=0;; i++){

28 if(
i
==1 && !
®l
) {

32 if((
t
 = 
r
->
wa™šg
.
h—d
è=ğ
NULL
) {

36 
	`d–sk
(&
r
->
wa™šg
, 
t
);

37 
	`sk»ady
(
t
);

40  
i
;

41 
	}
}

43 
	$skwakeup
(
R’dez
 *
r
)

45  
	`_skwakeup
(
r
, 0);

46 
	}
}

48 
	$skwakeu·Î
(
R’dez
 *
r
)

50  
	`_skwakeup
(
r
, 1);

51 
	}
}

53 
	$skb¬r›r
(
R’dez
 *
r
)

55 
n
 = 
	`skwakeu·Î
(
r
);

57 if(!
n
) {

58 
	`sk¦“p
(
r
);

61  
n
;

62 
	}
}

	@tools/src/task/task.c

3 
	~"skim¶.h
"

4 
	~<fú.h
>

5 
	~<¡dio.h
>

6 
	~"dbg.h
"

7 
	~"Š‘¡ršgs.h
"

8 
	~"Š‘¡ršgs_im¶.h
"

10 
	gskcouÁ
;

11 
	gsknsw™ch
;

12 
	gskex™v®
;

13 
Task
 *
	gskruÂšg
;

15 
CÚ‹xt
 
	gskschedcÚ‹xt
;

16 
Taskli¡
 
	gskrunqueue
;

19 
	mTASK_LIST_GROWTH
=256

22 
Task
 **
	g®Éask
;

23 
	gÇÎsk
;

25 
cÚ‹xtsw™ch
(
CÚ‹xt
 *
äom
, CÚ‹xˆ*
to
);

27 
	$sk¡¬t
(
ušt
 
y
, ušˆ
x
)

29 
Task
 *
t
;

30 
ulÚg
 
z
;

32 
z
 = 
x
<<16;

33 
z
 <<= 16;

34 
z
 |ğ
y
;

35 
t
 = (
Task
*)
z
;

37 
t
->
	`¡¬tâ
Ñ->
¡¬rg
);

38 
	`skex™
(0);

39 
	}
}

41 
	gskidg’
;

43 
Task
* 
sk®loc
((*
â
)(*), *
¬g
, 
ušt
 
¡ack
)

45 
Task
 *
t
 = 
NULL
;

46 
sig£t_t
 
z”o
;

47 
ušt
 
x
 = 0;

48 
ušt
 
y
 = 0;

49 
ulÚg
 
z
 = 0L;

52 
t
 = 
	`ÿÎoc
((
Task
è+ 
¡ack
, 1);

53 
	`check_mem
(
t
);

55 
t
->
¡k
 = (
uch¬
*)(t+1);

56 
t
->
¡ksize
 = 
¡ack
;

57 
t
->
id
 = ++
skidg’
;

58 
t
->
¡¬tâ
 = 
â
;

59 
t
->
¡¬rg
 = 
¬g
;

62 
	`sigem±y£t
(&
z”o
);

63 
	`sig´ocmask
(
SIG_BLOCK
, &
z”o
, &
t
->
cÚ‹xt
.
uc
.
uc_sigmask
);

66 
	`check
(
	`g‘cÚ‹xt
(&
t
->
cÚ‹xt
.
uc
) >= 0, "getcontext failed.");

70 
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_¥
 = (*é->
¡k
+8;

71 
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_size
 =->
¡ksize
-64;

73 #ià
	`defšed
(
__sun__
è&& !defšed(
__MAKECONTEXT_V2_SOURCE
)

76 
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_¥
 =

77 (*)
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_¥


78 +
t
->
cÚ‹xt
.
uc
.
uc_¡ack
.
ss_size
;

86 
z
 = (
ulÚg
)
t
;

87 
y
 = 
z
;

88 
z
 >>= 16;

89 
x
 = 
z
>>16;

91 
	`makecÚ‹xt
(&
t
->
cÚ‹xt
.
uc
, ((*)())
sk¡¬t
, 2, 
y
, 
x
);

93  
t
;

95 
”rÜ
:

96 
	`abÜt
();

97 
	}
}

99 
skü—‹
((*
â
)(*), *
¬g
, 
ušt
 
¡ack
)

101 
Task
 *
t
 = 
	`sk®loc
(
â
, 
¬g
, 
¡ack
);

102 
id
 = 
t
->id;

104 
skcouÁ
++;

106 if(
ÇÎsk
 % 
TASK_LIST_GROWTH
 == 0){

107 
®Éask
 = 
	`»®loc
×Îsk, (
ÇÎsk
 + 
TASK_LIST_GROWTH
)*(alltask[0]));

108 
	`check_mem
(
®Éask
);

111 
t
->
®Éask¦Ù
 = 
ÇÎsk
;

112 
®Éask
[
ÇÎsk
++] = 
t
;

113 
	`sk»ady
(
t
);

115  
id
;

117 
”rÜ
:

119 
	}
}

121 
	$sksy¡em
()

123 if(!
skruÂšg
->
sy¡em
) {

124 
skruÂšg
->
sy¡em
 = 1;

125 --
skcouÁ
;

127 
	}
}

129 
	$sksw™ch
()

131 
	`Ãed¡ack
(0);

132 
	`cÚ‹xtsw™ch
(&
skruÂšg
->
cÚ‹xt
, &
skschedcÚ‹xt
);

133 
	}
}

135 
	$sk»ady
(
Task
 *
t
)

137 
t
->
»ady
 = 1;

138 
	`addsk
(&
skrunqueue
, 
t
);

139 
	}
}

141 
	$sky›ld
()

143 
n
 = 
sknsw™ch
;

144 
	`sk»ady
(
skruÂšg
);

145 
	`sk¡©e
("yield");

146 
	`sksw™ch
();

148  
sknsw™ch
 - 
n
 - 1;

149 
	}
}

151 
	$ªy»ady
()

153  
skrunqueue
.
h—d
 !ğ
NULL
;

154 
	}
}

156 
	$skex™®l
(
v®
)

158 
	`ex™
(
v®
);

159 
	}
}

161 
	$skex™
(
v®
)

163 
skex™v®
 = 
v®
;

164 
skruÂšg
->
ex™šg
 = 1;

165 
	`sksw™ch
();

166 
	}
}

168 
	$cÚ‹xtsw™ch
(
CÚ‹xt
 *
äom
, CÚ‹xˆ*
to
)

170 if(
	`sw­cÚ‹xt
(&
äom
->
uc
, &
to
->uc) < 0){

171 
	`log_”r
("swapcontext failed.");

172 
	`abÜt
();

174 
	}
}

176 
	$sk¤uÂšg
()

178 
i
 = 0;

180 
	`debug
("Task ruÂšg‚®Éask=%d,askcouÁ=%d", 
ÇÎsk
, 
skcouÁ
);

181 
i
 = 0; i < 
ÇÎsk
; i++) {

182 
	`debug
("RUNNING id=%d:%p", 
®Éask
[
i
]->
id
,‡lltask[i]);

185  
ÇÎsk
;

186 
	}
}

189 
	$skscheduËr
()

191 
i
 = 0;

192 
Task
 *
t
 = 
NULL
;

195 if(
skcouÁ
 == 0) {

196 
	`ex™
(
skex™v®
);

199 
t
 = 
skrunqueue
.
h—d
;

201 if(
t
 =ğ
NULL
) {

202 
	`debug
("NÙhšg„uÂabË, h”e' thsk th©‡» sÎed (%d,%d):", 
ÇÎsk
, 
skcouÁ
);

203 
i
 = 0; i < 
ÇÎsk
; i++) {

204 
	`debug
("STALLED id=%d:%p", 
®Éask
[
i
]->
id
,‡lltask[i]);

208 
	`check
(
t
 !ğ
NULL
, "NØruÂabËasks, %dask ¡®Ëd", 
skcouÁ
);

210 
	`d–sk
(&
skrunqueue
, 
t
);

212 
t
->
»ady
 = 0;

213 
skruÂšg
 = 
t
;

214 
sknsw™ch
++;

216 
	`cÚ‹xtsw™ch
(&
skschedcÚ‹xt
, &
t
->
cÚ‹xt
);

217 
skruÂšg
 = 
NULL
;

219 if(
t
->
ex™šg
){

220 if(!
t
->
sy¡em
) {

221 
skcouÁ
--;

224 
i
 = 
t
->
®Éask¦Ù
;

225 
®Éask
[
i
] =‡Îsk[--
ÇÎsk
];

226 
®Éask
[
i
]->
®Éask¦Ù
 = i;

227 
	`debug
("FREEING TASK: %p", 
t
);

228 
	`ä“
(
t
);

232 
”rÜ
:

233 
	`abÜt
();

234 
	}
}

239 
	$skÇme
(*
Çme
)

241 
Ën
 = 
	`¡¾’
(
Çme
);

242 
	`memıy
(
skruÂšg
->
Çme
,‚ame, 
Ën
 < 
MAX_STATE_LENGTH
 ?†en : MAX_STATE_LENGTH);

243 
skruÂšg
->
Çme
[
Ën
] = '\0';

244 
	}
}

246 * 
	$skg‘Çme
()

248  
skruÂšg
->
Çme
;

249 
	}
}

252 
	$sk¡©e
(*
¡©e
)

254 
Ën
 = 
	`¡¾’
(
¡©e
);

255 
	`memıy
(
skruÂšg
->
¡©e
, s‹, 
Ën
 < 
MAX_STATE_LENGTH
 ?†en : MAX_STATE_LENGTH);

256 
skruÂšg
->
¡©e
[
Ën
] = '\0';

257 
	}
}

259 * 
	$skg‘¡©e
()

261  
skruÂšg
->
¡©e
;

262 
	}
}

264 
	$Ãed¡ack
(
n
)

266 
Task
 *
t
 = 
skruÂšg
;

268 if((*)&
t
 <ğ(*é->
¡k


269 || (*)&
t
 - (*é->
¡k
 < 256+
n
) {

270 
	`årštf
(
¡d”r
, "sk sck ov”æow: &t=%°t¡k=%°n=%d\n", &
t
,->
¡k
, 256+
n
);

272 
	}
}

274 
gb¡ršg
 
	gTASKINFO_HEADERS
 = 
bsStic
("38:2:id,6:system,4:name,5:state,6:status,]");

276 
Šs_v®ue_t
 *
	$skg‘šfo
()

278 
i
 = 0;

279 
Task
 *
t
 = 
NULL
;

280 
Šs_v®ue_t
 *
rows
 = 
	`Šs_Ãw_li¡
();

281 * 
¡©us
 = 
NULL
;

283 
i
 = 0; i < 
ÇÎsk
; i++)

285 
t
 = 
®Éask
[
i
];

287 if(
t
 =ğ
skruÂšg
) {

288 
¡©us
 = "running";

289 } if(
t
->
»ady
) {

290 
¡©us
 = "ready";

291 } if(
t
->
ex™šg
) {

292 
¡©us
 = "exiting";

294 
¡©us
 = "idle";

297 
Šs_v®ue_t
 *
–
 = 
	`Šs_Ãw_li¡
();

298 
	`Šs_add_to_li¡
(
–
, 
	`Šs_Ãw_š‹g”
(
t
->
id
));

299 
	`Šs_add_to_li¡
(
–
, 
t
->
sy¡em
 ? 
	`Šs_g‘_Œue
(è: 
	`Šs_g‘_çl£
());

300 
	`Šs_add_to_li¡
(
–
, 
	`Šs_·r£_¡ršg
(
t
->
Çme
, 
	`¡¾’
(t->name)));

301 
	`Šs_add_to_li¡
(
–
, 
	`Šs_·r£_¡ršg
(
t
->
¡©e
, 
	`¡¾’
(t->state)));

302 
	`Šs_add_to_li¡
(
–
, 
	`Šs_·r£_¡ršg
(
¡©us
, 
	`¡¾’
(status)));

304 
	`Šs_add_to_li¡
(
rows
, 
–
);

307  
	`Šs_¡ªd¬d_bË
(&
TASKINFO_HEADERS
, 
rows
);

308 
	}
}

314 
	gsk¬gc
;

315 **
	gsk¬gv
;

316 #ià
defšed
(
__F»eBSD__
)

317 
	gMAINSTACKSIZE
 = 96 * 1024;

319 
	gMAINSTACKSIZE
 = 32 * 1024;

322 
	$skmaš¡¬t
(*
v
)

324 
	`skÇme
("taskmain");

325 
	`skmaš
(
sk¬gc
, 
sk¬gv
);

326 
	}
}

328 
	$maš
(
¬gc
, **
¬gv
)

330 
sk¬gc
 = 
¬gc
;

331 
sk¬gv
 = 
¬gv
;

333 
	`skü—‹
(
skmaš¡¬t
, 
NULL
, 
MAINSTACKSIZE
);

334 
	`skscheduËr
();

336 
	`årštf
(
¡d”r
, "taskscheduler„eturned in main!\n");

337 
	`abÜt
();

340 
	}
}

345 
	$addsk
(
Taskli¡
 *
l
, 
Task
 *
t
)

347 
Task
 *
‹¡
 = 
NULL
;

348 
‹¡
 = 
skrunqueue
.
h—d
;e¡ !ğ
NULL
;e¡ =e¡->
Ãxt
)

350 
	`as£¹
(
‹¡
 !ğ
t
 && "Fucking double‡ddtask mother fucker!");

353 if(
l
->

) {

354 
l
->

->
Ãxt
 = 
t
;

355 
t
->
´ev
 = 
l
->

;

357 
l
->
h—d
 = 
t
;

358 
t
->
´ev
 = 
NULL
;

361 
l
->

 = 
t
;

362 
t
->
Ãxt
 = 
NULL
;

363 
	}
}

365 
	$d–sk
(
Taskli¡
 *
l
, 
Task
 *
t
)

367 if(
t
->
´ev
) {

368 
t
->
´ev
->
Ãxt
 =->next;

370 
l
->
h—d
 = 
t
->
Ãxt
;

373 if(
t
->
Ãxt
) {

374 
t
->
Ãxt
->
´ev
 =->prev;

376 
l
->

 = 
t
->
´ev
;

379 
t
->
Ãxt
 = 
NULL
;

380 
t
->
´ev
 = 
NULL
;

381 
	}
}

383 
	$skid
()

385  
skruÂšg
->
id
;

386 
	}
}

389 
Task
 *
	$sk£lf
()

391  
skruÂšg
;

392 
	}
}

394 
	$skg‘id
(
Task
 *
sk
)

396  
sk
->
id
;

397 
	}
}

399 
	$sksigÇl
(
Task
 *
sk
, 
sigÇl
)

401 
	`check
(
sk
 !ğ
NULL
, "Task was NULL,hat's„eally bad.");

402 
	`check
(
sigÇl
 > 0, "Signal haso be greaterhan 0.");

404 
sk
->
sigÇl
 = signal;

405 
	`sk»ady
(
sk
);

408 
”rÜ
:

410 
	}
}

412 
	$sk®lsigÇl
(
sigÇl
)

414 
	`debug
("S’dšg %dØ®Èsks.", 
sigÇl
);

415 
i
 = 0;

416 
Task
 *
t
 = 
NULL
;

417 
	`check
(
sigÇl
 > 0, "Signal must be greaterhan 0.");

419 if(
FDTASK
 !ğ
NULL
) {

420 
	`debug
("MAKE THE FDTASK SIGNAL FIRST");

421 
FDTASK
->
sigÇl
 = signal;

422 
	`skd–ay
(1);

423 
	`debug
("BACK NOW CLEAR THE REST.");

427 
t
 = 
skrunqueue
.
h—d
; !ğ
NULL
 ; =->
Ãxt
) {

428 if(
t
 !ğ
FDTASK
 && !t->
ex™šg
 &&->
sigÇl
 == 0) {

429 
	`debug
("SIGNAL RUNNING: id=%d, %p", 
t
->
id
,);

430 
t
->
sigÇl
 = signal;

435 
i
 = 0; i < 
ÇÎsk
; i++)

437 
t
 = 
®Éask
[
i
];

439 if(
t
 !ğ
NULL
 && !t->
ex™šg
 && !ğ
skruÂšg
 &&->
sigÇl
 =ğ0 &&->
Ãxt
 =ğNULL &&->
´ev
 == NULL) {

440 
	`debug
("SIGNAL IDLE: id=%d, %p", 
t
->
id
,);

441 
t
->
sigÇl
 = signal;

442 
	`sk»ady
(
t
);

446 (
i
 = 
	`sky›ld
()) > 0) {

447 
	`debug
("BACK FROM THE FINAL SWITCH! TASK YIELD: %d", 
i
);

451 
”rÜ
:

453 
	}
}

455 
	$sk_was_sigÇËd
()

457  
skruÂšg
->
sigÇl
;

458 
	}
}

460 
	$sk_ş—r_sigÇl
()

462 
skruÂšg
->
sigÇl
 = 0;

463 
	}
}

	@tools/src/task/task.h

3 #iâdeà
_TASK_H_


4 
	#_TASK_H_
 1

	)

6 #ifdeà
__ılu¥lus


10 
	~<¡d¬g.h
>

11 
	~<uni¡d.h
>

12 
	~<š‰y³s.h
>

13 
	~<zmq.h
>

15 
Šs_v®ue_t
;

21 
Task
 
	tTask
;

22 
Taskli¡
 
	tTaskli¡
;

24 
	#MAX_STATE_LENGTH
 30

	)

26 
ªy»ady
();

27 
skü—‹
((*
f
)(*
¬g
), *¬g, 
¡acksize
);

28 
skex™
();

29 
skex™®l
();

30 
skmaš
(
¬gc
, *
¬gv
[]);

31 
sky›ld
();

32 ** 
skd©a
();

33 
Ãed¡ack
();

34 
skÇme
(*);

35 
sk¡©e
(*);

36 * 
skg‘Çme
();

37 * 
skg‘¡©e
();

38 
Šs_v®ue_t
 *
skg‘šfo
();

39 
sksy¡em
();

40 
skd–ay
();

41 
skid
();

42 
skg‘id
(
Task
 *
sk
);

43 
skwa™šg
();

44 
sk¤uÂšg
();

45 
sk»ady
(
Task
 *
t
);

46 
Task
 *
sk£lf
();

47 
sksw™ch
();

49 
	sTaskli¡


51 
Task
 *
h—d
;

52 
Task
 *

;

57 
sksigÇl
(
Task
 *
sk
, 
sigÇl
);

58 
sk_was_sigÇËd
();

59 
sk_ş—r_sigÇl
();

60 
sk®lsigÇl
(
sigÇl
);

65 
QLock
 
	tQLock
;

66 
	sQLock


68 
Task
 *
owÃr
;

69 
Taskli¡
 
wa™šg
;

72 
qlock
(
QLock
*);

73 
ÿnqlock
(
QLock
*);

74 
quÆock
(
QLock
*);

79 
RWLock
 
	tRWLock
;

80 
	sRWLock


82 
»ad”s
;

83 
Task
 *
wr™”
;

84 
Taskli¡
 
rwa™šg
;

85 
Taskli¡
 
wwa™šg
;

88 
¾ock
(
RWLock
*);

89 
ÿÄlock
(
RWLock
*);

90 
ruÆock
(
RWLock
*);

92 
wlock
(
RWLock
*);

93 
ÿnwlock
(
RWLock
*);

94 
wuÆock
(
RWLock
*);

99 
R’dez
 
	tR’dez
;

101 
	sR’dez


103 
QLock
 *
l
;

104 
Taskli¡
 
wa™šg
;

107 
sk¦“p
(
R’dez
*);

108 
skwakeup
(
R’dez
*);

109 
skwakeu·Î
(
R’dez
*);

110 
skb¬r›r
(
R’dez
 *
r
);

117 
fd»ad
(, *, );

118 
fd»ad1
(, *, );

119 
fd»cv1
(, *, );

120 
fdwr™e
(, *, );

121 
fd£nd
(, *, );

122 
fd»cv
(, *, );

123 
fdwa™
(, );

124 
fdnoblock
();

126 
Task
 *
FDTASK
;

128 
	#fdşo£
(
fd
èif(fd >ğ0è
	`şo£
(fd)

	)

130 
fdsk
(*);

135 
mqš™
(
th»ads
);

136 *
mqsock‘
(
ty³
);

137 
mqwa™
(*
sock‘
, 
rw
);

138 
mq»cv
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
);

139 
mq£nd
(*
sock‘
, 
zmq_msg_t
 *
msg
, 
æags
);

141 *
ZMQ_CTX
;

148 
	gUDP
 = 0,

149 
	gTCP
 = 1,

152 
ÃÂounû
(, *, );

153 
Ãcû±
(, *, *);

154 
ÃtdŸl
(, *, );

155 
Ãookup
(*, 
ušt32_t
*);

157 #ifdeà
__ılu¥lus


	@tools/src/task/taskimpl.h

3 #ià
defšed
(
__sun__
)

4 
	#__EXTENSIONS__
 1

	)

5 #ià
defšed
(
__SunOS5_6__
è|| defšed(
__SunOS5_7__
è|| defšed(
__SunOS5_8__
)

8 
	#__MAKECONTEXT_V2_SOURCE
 1

	)

12 
	#USE_UCONTEXT
 1

	)

14 #ià
defšed
(
__O³nBSD__
)

15 #undeà
USE_UCONTEXT


16 
	#USE_UCONTEXT
 0

	)

19 #ià
defšed
(
__APPLE__
)

20 
	~<Avaab™yMaüos.h
>

21 #ià
defšed
(
MAC_OS_X_VERSION_10_5
)

22 #undeà
USE_UCONTEXT


23 
	#USE_UCONTEXT
 0

	)

27 
	~<”ºo.h
>

28 
	~<¡dlib.h
>

29 
	~<uni¡d.h
>

30 
	~<¡ršg.h
>

31 
	~<as£¹.h
>

32 
	~<time.h
>

33 
	~<sys/time.h
>

34 
	~<sys/ty³s.h
>

35 
	~<sys/wa™.h
>

36 
	~<sched.h
>

37 
	~<sigÇl.h
>

38 #ià
USE_UCONTEXT


39 
	~<ucÚ‹xt.h
>

41 
	~<sys/ut¢ame.h
>

42 
	~<š‰y³s.h
>

43 
	~"sk.h
"

45 
	#ÃËm
(
x
è((x)/((x)[0]))

	)

47 
	#ulÚg
 
sk_ulÚg


	)

48 
	#ušt
 
sk_ušt


	)

49 
	#uch¬
 
sk_uch¬


	)

50 
	#ushÜt
 
sk_ushÜt


	)

51 
	#uvlÚg
 
sk_uvlÚg


	)

52 
	#vlÚg
 
sk_vlÚg


	)

54 
	tulÚg
;

55 
	tušt
;

56 
	tuch¬
;

57 
	tushÜt
;

58 
	tuvlÚg
;

59 
	tvlÚg
;

61 #ià
defšed
(
__F»eBSD__
) && __FreeBSD__ < 5

62 
g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

63 
£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

64 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

65 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
(&(u)->
uc_mcÚ‹xt
)

	)

66 
sw­cÚ‹xt
(
ucÚ‹xt_t
*, const ucontext_t*);

67 
makecÚ‹xt
(
ucÚ‹xt_t
*, (*)(), , ...);

70 #ià
defšed
(
__APPLE__
)

71 
	#mcÚ‹xt
 
libth»ad_mcÚ‹xt


	)

72 
	#mcÚ‹xt_t
 
libth»ad_mcÚ‹xt_t


	)

73 
	#ucÚ‹xt
 
libth»ad_ucÚ‹xt


	)

74 
	#ucÚ‹xt_t
 
libth»ad_ucÚ‹xt_t


	)

75 #ià
defšed
(
__i386__
)

76 
	~"386-ucÚ‹xt.h
"

77 #–ià
defšed
(
__x86_64__
)

78 
	~"amd64-ucÚ‹xt.h
"

80 
	~"pow”-ucÚ‹xt.h
"

84 #ià
defšed
(
__O³nBSD__
)

85 
	#mcÚ‹xt
 
libth»ad_mcÚ‹xt


	)

86 
	#mcÚ‹xt_t
 
libth»ad_mcÚ‹xt_t


	)

87 
	#ucÚ‹xt
 
libth»ad_ucÚ‹xt


	)

88 
	#ucÚ‹xt_t
 
libth»ad_ucÚ‹xt_t


	)

89 #ià
defšed
 
__i386__


90 
	~"386-ucÚ‹xt.h
"

91 #–ià
defšed
(
__x86_64__
)

92 
	~"amd64-ucÚ‹xt.h
"

94 
	~"pow”-ucÚ‹xt.h
"

96 
pid_t
 
rfÜk_th»ad
(, *, (*)(*), *);

99 #ià0 && 
	`defšed
(
__sun__
)

100 
	#mcÚ‹xt
 
libth»ad_mcÚ‹xt


	)

101 
	#mcÚ‹xt_t
 
libth»ad_mcÚ‹xt_t


	)

102 
	#ucÚ‹xt
 
libth»ad_ucÚ‹xt


	)

103 
	#ucÚ‹xt_t
 
libth»ad_ucÚ‹xt_t


	)

104 
	~"¥¬c-ucÚ‹xt.h
"

107 #ià
	`defšed
(
__¬m__
)

108 
	`g‘mcÚ‹xt
(
mcÚ‹xt_t
*);

109 
	`£tmcÚ‹xt
(cÚ¡ 
mcÚ‹xt_t
*);

110 
	#£tcÚ‹xt
(
u
è
	`£tmcÚ‹xt
((*)&((u)->
uc_mcÚ‹xt
.
¬m_r0
))

	)

111 
	#g‘cÚ‹xt
(
u
è
	`g‘mcÚ‹xt
((*)&((u)->
uc_mcÚ‹xt
.
¬m_r0
))

	)

114 
CÚ‹xt
 
	tCÚ‹xt
;

118 
STACK
 = 8192

121 
	sCÚ‹xt


123 
ucÚ‹xt_t
 
uc
;

126 
	sTask


128 
Çme
[
MAX_STATE_LENGTH
];

129 
¡©e
[
MAX_STATE_LENGTH
];

130 
Task
 *
Ãxt
;

131 
Task
 *
´ev
;

132 
CÚ‹xt
 
cÚ‹xt
;

133 
uvlÚg
 
®¬mtime
;

134 
ušt
 
id
;

135 
uch¬
 *
¡k
;

136 
ušt
 
¡ksize
;

137 
ex™šg
;

138 
®Éask¦Ù
;

139 
sy¡em
;

140 
»ady
;

141 (*
¡¬tâ
)(*);

142 *
¡¬rg
;

143 
sigÇl
;

146 
	`sk»ady
(
Task
*);

147 
	`sksw™ch
();

149 
	`addsk
(
Taskli¡
*, 
Task
*);

150 
	`d–sk
(
Taskli¡
*, 
Task
*);

152 
Task
 *
skruÂšg
;

153 
skcouÁ
;

	@tools/src/tnetstrings.c

1 
	~"Š‘¡ršgs.h
"

2 
	~<¡ršg.h
>

3 
	~"dbg.h
"

4 
	~<as£¹.h
>

5 
	~"mem/h®loc.h
"

7 
	#MAX_NUM_LEN
 22

8 

	)

9 
šlše
 

10 
Šs_·r£_diù
(*
diù
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

12 
šlše
 

13 
Šs_·r£_li¡
(*
li¡
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

15 
šlše
 

16 
Šs_»nd”_v®ue
(*
v®
, 
Šs_outbuf
 *
outbuf
);

18 
šlše
 

19 
Šs_outbuf_™ß
(
size_t
 
n
, 
Šs_outbuf
 *
outbuf
);

21 
šlše
 

22 
Šs_outbuf_š™
(
Šs_outbuf
 *
outbuf
);

24 
šlše
 

25 
Šs_outbuf_ä“
(
Šs_outbuf
 *
outbuf
);

27 
šlše
 

28 
Šs_outbuf_ex‹nd
(
Šs_outbuf
 *
outbuf
);

30 
šlše
 

31 
Šs_outbuf_putc
(
Šs_outbuf
 *
outbuf
, 
c
);

33 
šlše
 

34 
Šs_outbuf_½uts
(
Šs_outbuf
 *
outbuf
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

36 
šlše
 

37 
Šs_š¶aû_»v”£
(*
d©a
, 
size_t
 
Ën
);

39 
	~"Š‘¡ršgs_im¶.h
"

42 
šlše
 
	$Šs_»nd”_¡ršg
(*
v®
, 
Šs_outbuf
 *
outbuf
)

44 
Šs_v®ue_t
 *
t
 = (Šs_v®ue_ˆ*)
v®
;

45 
	`as£¹
(
t
->
ty³
 =ğ
Šs_g_¡ršg
 && "Value is‚ot‡ string.");

46  
	`Šs_outbuf_½uts
(
outbuf
, 
	`bd©a
(
t
->
v®ue
.
¡ršg
), 
	`bËngth
(t->value.string));

47 
	}
}

49 
šlše
 
	$Šs_»nd”_numb”
(*
v®
, 
Šs_outbuf
 *
outbuf
)

51 
Šs_v®ue_t
 *
t
 = (Šs_v®ue_ˆ*)
v®
;

52 
	`as£¹
(
t
->
ty³
 =ğ
Šs_g_numb”
 && "Value is‚ot‡‚umber.");

54 
numb”
 = 
t
->
v®ue
.number;

55 
Ãg©ive
 = 
numb”
 < 0;

57 
	`as£¹
(
numb”
 !ğ
LONG_MIN
 && "LONG_MIN cannot be handled");

59 
outbuf
->
®loc_size
 < outbuf->
u£d_size
 + 
MAX_NUM_LEN
) {

60 
	`check
(
	`Šs_outbuf_ex‹nd
(
outbuf
) != -1, "Failedoƒxtend buffer.");

63 ià(
Ãg©ive
) {

64 
numb”
 = -number;

68 
outbuf
->
bufãr
[outbuf->
u£d_size
++] = '0' + (
numb”
%10);

69 } 
numb”
 /= 10);

71 ià(
Ãg©ive
) {

72 
outbuf
->
bufãr
[outbuf->
u£d_size
++] = '-';

77 
”rÜ
:

79 
	}
}

81 
šlše
 
	$Šs_»nd”_boŞ
(*
v®
, 
Šs_outbuf
 *
outbuf
)

83 
Šs_v®ue_t
 *
t
 = (Šs_v®ue_ˆ*)
v®
;

84 
	`as£¹
(
t
->
ty³
 =ğ
Šs_g_boŞ
 && "Value is‚ot‡ bool.");

86 if(
t
->
v®ue
.
boŞ
) {

87  
	`Šs_outbuf_½uts
(
outbuf
, "true", 4);

89  
	`Šs_outbuf_½uts
(
outbuf
, "false", 5);

91 
	}
}

94 
šlše
 
	$Šs_»nd”_diù
(*
diù
, 
Šs_outbuf
 *
outbuf
)

96 
hash_t
 *
h
 = ((
Šs_v®ue_t
 *)
diù
)->
v®ue
.dict;

97 
hsÿn_t
 
hs
;

98 
hnode_t
 *
node
;

99 
	`hash_sÿn_begš
(&
hs
, 
h
);

100 
Šs_v®ue_t
 
key
;

102 (
node
 = 
	`hash_sÿn_Ãxt
(&
hs
))) {

103 
	`check
(
	`Šs_»nd”_v®ue
(
	`hnode_g‘
(
node
), 
outbuf
) == 0, "Failedo„ender dict value.");

105 
key
.
ty³
 = 
Šs_g_¡ršg
;

106 
key
.
v®ue
.
¡ršg
 = (
b¡ršg
)
	`hnode_g‘key
(
node
);

108 
	`check
(
	`Šs_»nd”_v®ue
(&
key
, 
outbuf
) == 0, "Failedo„ender dict key.");

112 
”rÜ
:

114 
	}
}

116 
šlše
 
	$Šs_»nd”_li¡
(*
li¡
, 
Šs_outbuf
 *
outbuf
)

118 
d¬¿y_t
 *
L
 = ((
Šs_v®ue_t
 *)
li¡
)->
v®ue
.list;

119 
i
 = 0;

121 
i
 = 
	`d¬¿y_’d
(
L
) - 1; i >= 0; i--) {

122 
Šs_v®ue_t
 *
v®
 = 
	`d¬¿y_g‘
(
L
, 
i
);

123 
	`check
(
v®
 !ğ
NULL
, "Invalidns†ist structure, got‡ NULL.");

124 
	`check
(
	`Šs_»nd”_v®ue
(
v®
, 
outbuf
) == 0, "Failedo„ender†istƒlement.");

128 
”rÜ
:

130 
	}
}

134 
	$Šs_v®ue_de¡roy
(
Šs_v®ue_t
 *
v®ue
)

136 if(
v®ue
 =ğ
NULL
) ;

137 
d¬¿y_t
 *
L
 = 
v®ue
->v®ue.
li¡
;

138 
i
 = 0;

140 
v®ue
->
ty³
) {

141 
Šs_g_boŞ
:

143 
Šs_g_diù
:

144 
	`hash_ä“_nodes
(
v®ue
->v®ue.
diù
);

145 
	`hash_ä“
(
v®ue
->v®ue.
diù
);

147 
Šs_g_li¡
:

148 
i
 = 0; i < 
	`d¬¿y_’d
(
L
); i++) {

149 
	`Šs_v®ue_de¡roy
(
	`d¬¿y_g‘
(
L
, 
i
));

151 
	`h_ä“
(
L
);

153 
Šs_g_nuÎ
:

155 
Šs_g_numb”
:

157 
Šs_g_¡ršg
:

158 
	`bde¡roy
(
v®ue
->v®ue.
¡ršg
);

161 
	`£Áš–
("Inv®idy³ giv’: '%c'", 
v®ue
->
ty³
);

164 
”rÜ
:

165 
	`ä“
(
v®ue
);

167 
	}
}

169 
	$Šs_hnode_ä“
(
hnode_t
 *
node
, *
nÙu£d
)

171 
	`bde¡roy
((
b¡ršg
)
	`hnode_g‘key
(
node
));

172 
	`Šs_v®ue_de¡roy
(
	`hnode_g‘
(
node
));

173 
	`ä“
(
node
);

174 
	}
}

176 
hnode_t
 *
	$Šs_hnode_®loc
(*
nÙu£d
)

178  
	`m®loc
((
hnode_t
));

179 
	}
}

182 * 
	$Šs_·r£
(cÚ¡ *
d©a
, 
size_t
 
Ën
, **
»maš
)

184 *
v®
 = 
NULL
;

185 *
v®¡r
 = 
NULL
;

186 
Šs_ty³_g
 
ty³
 = 
Šs_g_nuÎ
;

187 
size_t
 
v®Ën
 = 0;

190 
v®Ën
 = 
	`¡¹Ş
(
d©a
, &
v®¡r
, 10);

191 
	`check
(
v®¡r
 !ğ
d©a
, "Not‡netstring:‚o†ength…refix.");

192 
	`check
((
v®¡r
 + 
v®Ën
 + 1è< (
d©a
 + 
Ën
) && *valstr == ':', "Not‡netstring: invalid†ength…refix.");

193 
v®¡r
++;

196 
ty³
 = 
v®¡r
[
v®Ën
];

199 if(
»maš
 !ğ
NULL
) {

200 *
»maš
 = 
v®¡r
 + 
v®Ën
 + 1;

204 
ty³
) {

206 
Šs_g_¡ršg
:

207 
v®
 = 
	`Šs_·r£_¡ršg
(
v®¡r
, 
v®Ën
);

210 
Šs_g_numb”
:

211 
v®
 = 
	`Šs_·r£_š‹g”
(
v®¡r
, 
v®Ën
);

212 
	`check
(
v®
 !ğ
NULL
, "Not‡netstring: invalid integer†iteral.");

214 
Šs_g_æßt
:

215 
v®
 = 
	`Šs_·r£_æßt
(
v®¡r
, 
v®Ën
);

216 
	`check
(
v®
 !ğ
NULL
, "Not‡netstring: invalid float†iteral.");

220 
Šs_g_boŞ
:

221 if(
v®Ën
 =ğ4 && 
v®¡r
[0] == 't') {

222 
v®
 = 
	`Šs_g‘_Œue
();

223 } if(
v®Ën
 =ğ5 && 
v®¡r
[0] == 'f') {

224 
v®
 = 
	`Šs_g‘_çl£
();

226 
	`£Áš–
("Not‡netstring: invalid boolean†iteral.");

231 
Šs_g_nuÎ
:

232 
	`check
(
v®Ën
 == 0, "Not‡netstring: invalid‚ull†iteral.");

233 
v®
 = 
	`Šs_g‘_nuÎ
();

237 
Šs_g_diù
:

238 
v®
 = 
	`Šs_Ãw_diù
();

239 
	`check
(
	`Šs_·r£_diù
(
v®
,
v®¡r
,
v®Ën
) != -1, "Not‡netstring: broken dict items.");

243 
Šs_g_li¡
:

244 
v®
 = 
	`Šs_Ãw_li¡
();

245 
	`check
(
	`Šs_·r£_li¡
(
v®
,
v®¡r
,
v®Ën
) != -1, "not‡netstring: broken†ist items");

248 
	`£Áš–
("not‡netstring: invalidypeag");

251  
v®
;

253 
”rÜ
:

254 
	`Šs_v®ue_de¡roy
(
v®
);

255  
NULL
;

256 
	}
}

259 
	$Šs_outbuf_şamp
(
Šs_outbuf
 *
outbuf
, 
Üig_size
)

261 
size_t
 
d©®’
 = 
outbuf
->
u£d_size
 - 
Üig_size
;

262 
	`Šs_outbuf_putc
(
outbuf
, ':');

263 
	`Šs_outbuf_™ß
(
d©®’
, 
outbuf
);

264 
	}
}

266 *
	$Šs_»nd”
(*
v®
, 
size_t
 *
Ën
)

268 *
ouut
 = 
NULL
;

270 
ouut
 = 
	`Šs_»nd”_»v”£d
(
v®
, 
Ën
);

271 
	`check
(
ouut
 !ğ
NULL
, "Failedo„endernetstring.");

273 
	`Šs_š¶aû_»v”£
(
ouut
, *
Ën
);

274 
ouut
[*
Ën
] = '\0';

276  
ouut
;

278 
”rÜ
:

279  
NULL
;

280 
	}
}

282 
šlše
 
	$Šs_»nd”_hash_·œ_li¡
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
key
, 
b¡rLi¡
 *
v®ue
)

284 
i
 = 0;

285 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_¡ršg
};

286 
	`Šs_outbuf_putc
(
outbuf
, ']');

287 
Üig_size
 = 
outbuf
->
u£d_size
;

289 
i
 = 
v®ue
->
qty
 - 1; i >= 0 ; i--) {

290 
v®
.
v®ue
.
¡ršg
 = v®ue->
’Œy
[
i
];

291 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

294 
	`Šs_outbuf_şamp
(
outbuf
, 
Üig_size
);

295 
v®
.
v®ue
.
¡ršg
 = 
key
;

296 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

297 
	}
}

299 
	$Šs_»nd”_hash_·œ
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
key
, b¡ršg 
v®ue
)

301 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_¡ršg
, .
v®ue
.
¡ršg
 = value};

302 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

304 
v®
.
v®ue
.
¡ršg
 = 
key
;

305 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

306 
	}
}

308 
	$Šs_»nd”_numb”_´•’d
(
Šs_outbuf
 *
outbuf
, 
v®ue
)

310 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = value};

311 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

312 
	}
}

314 
	$Šs_»nd”_¡ršg_´•’d
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
v®ue
)

316 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_¡ršg
, .
v®ue
.
¡ršg
 = value};

317 
	`Šs_»nd”_v®ue
(&
v®
, 
outbuf
);

318 
	}
}

320 
	$Šs_»nd”_»que¡_¡¬t
(
Šs_outbuf
 *
outbuf
)

322 
	`check
(
	`Šs_outbuf_š™
(
outbuf
) != -1, "Failedo init buffer.");

324 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, '}') != -1, "Failedƒnding„equest.");

326  
outbuf
->
u£d_size
;

327 
”rÜ
:

329 
	}
}

331 
	$Šs_»nd”_»que¡_’d
(
Šs_outbuf
 *
outbuf
, 
h—d”_¡¬t
, 
b¡ršg
 
uuid
, 
id
, b¡ršg 
·th
)

334 
	`Šs_outbuf_şamp
(
outbuf
, 
h—d”_¡¬t
);

336 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ' ') != -1, "Failedƒnding„equest.");

337 
	`check
(
	`Šs_outbuf_½uts
(
outbuf
, 
	`bd©a
(
·th
), 
	`bËngth
(path)) != -1, "Failedƒnding„equest.");

339 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ' ') != -1, "Failedƒnding„equest.");

340 
	`check
(
	`Šs_outbuf_™ß
(
id
, 
outbuf
) != -1, "Failedƒnding„equest.");

342 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ' ') != -1, "Failedƒnding„equest.");

343 
	`check
(
	`Šs_outbuf_½uts
(
outbuf
, 
	`bd©a
(
uuid
), 
	`bËngth
(uuid)) != -1, "Failedƒnding„equest.");

347 
”rÜ
:

349 
	}
}

351 
	$Šs_»nd”_log_¡¬t
(
Šs_outbuf
 *
outbuf
)

353 
	`check
(
	`Šs_outbuf_š™
(
outbuf
) != -1, "Failedo init buffer.");

355 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, ']') != -1, "Failedƒnding„equest.");

357  
outbuf
->
u£d_size
;

358 
”rÜ
:

360 
	}
}

362 
	$Šs_»nd”_log_’d
(
Šs_outbuf
 *
outbuf
)

364 
	`Šs_outbuf_şamp
(
outbuf
, 1);

365 
	}
}

367 
	$Šs_»nd”_»que¡_h—d”s
(
Šs_outbuf
 *
outbuf
, 
hash_t
 *
h—d”s
)

369 
hsÿn_t
 
sÿn
;

370 
hnode_t
 *
n
 = 
NULL
;

371 
	`hash_sÿn_begš
(&
sÿn
, 
h—d”s
);

373 
n
 = 
	`hash_sÿn_Ãxt
(&
sÿn
);‚ !ğ
NULL
;‚ = hash_scan_next(&scan)) {

374 
b¡rLi¡
 *
v®_li¡
 = 
	`hnode_g‘
(
n
);

375 if(
v®_li¡
->
qty
 == 0) ;

377 
b¡ršg
 
key
 = (b¡ršg)
	`hnode_g‘key
(
n
);

379 if(
v®_li¡
->
qty
 == 1) {

380 
	`Šs_»nd”_hash_·œ
(
outbuf
, 
key
, 
v®_li¡
->
’Œy
[0]);

382 
	`Šs_»nd”_hash_·œ_li¡
(
outbuf
, 
key
, 
v®_li¡
);

387 
	}
}

389 
b¡ršg
 
	$Šs_outbuf_to_b¡ršg
(
Šs_outbuf
 *
outbuf
)

391 if(
outbuf
->
u£d_size
 =ğoutbuf->
®loc_size
) {

392 
	`Šs_outbuf_ex‹nd
(
outbuf
);

395 
	`Šs_š¶aû_»v”£
(
outbuf
->
bufãr
, outbuf->
u£d_size
);

397 
b¡ršg
 
b
 = 
	`m®loc
((
gb¡ršg
));

398 
b
->
¦’
 = 
outbuf
->
u£d_size
;

399 
b
->
d©a
 = (*)
outbuf
->
bufãr
;

400 
b
->
d©a
[b->
¦’
] = '\0';

401 
b
->
mËn
 = 
outbuf
->
®loc_size
;

403  
b
;

404 
	}
}

406 *
	$Šs_»nd”_»v”£d
(*
v®
, 
size_t
 *
Ën
)

408 
Šs_outbuf
 
outbuf
;

410 
	`check
(
	`Šs_outbuf_š™
(&
outbuf
) != -1, "Failedo initialize outbuf.");

412 
	`check
(
	`Šs_»nd”_v®ue
(
v®
, &
outbuf
) != -1, "Failedo„ender value.");

413 *
Ën
 = 
outbuf
.
u£d_size
;

415 if(
outbuf
.
u£d_size
 =ğoutbuf.
®loc_size
) {

417 
outbuf
.
bufãr
 = 
	`»®loc
(outbuf.bufãr, outbuf.
u£d_size
 + 1);

418 
	`check_mem
(
outbuf
.
bufãr
);

421  
outbuf
.
bufãr
;

423 
”rÜ
:

424 
	`Šs_outbuf_ä“
(&
outbuf
);

425  
NULL
;

426 
	}
}

429 
šlše
 

430 
	$Šs_»nd”_v®ue
(*
v®
, 
Šs_outbuf
 *
outbuf
)

432 
Šs_ty³_g
 
ty³
 = 
Šs_g_nuÎ
;

433 
»s
 = -1;

434 
size_t
 
d©®’
 = 0;

437 
ty³
 = 
	`Šs_g‘_ty³
(
v®
);

438 
	`check
(
ty³
 != 0, "type‚ot serializable");

440 
	`Šs_outbuf_putc
(
outbuf
, 
ty³
);

441 
d©®’
 = 
outbuf
->
u£d_size
;

445 
ty³
) {

446 
Šs_g_¡ršg
:

447 
»s
 = 
	`Šs_»nd”_¡ršg
(
v®
, 
outbuf
);

449 
Šs_g_numb”
:

450 
»s
 = 
	`Šs_»nd”_numb”
(
v®
, 
outbuf
);

452 
Šs_g_boŞ
:

453 
»s
 = 
	`Šs_»nd”_boŞ
(
v®
, 
outbuf
);

455 
Šs_g_nuÎ
:

456 
»s
 = 0;

458 
Šs_g_diù
:

459 
»s
 = 
	`Šs_»nd”_diù
(
v®
, 
outbuf
);

461 
Šs_g_li¡
:

462 
»s
 = 
	`Šs_»nd”_li¡
(
v®
, 
outbuf
);

464 
Šs_g_šv®id
:

465 
	`£Áš–
("invalidns value, can't be NULL");

468 
	`£Áš–
("unknowÀty³ag: '%c'", 
ty³
);

471 
	`check
(
»s
 =ğ0, "FaedØ»nd” v®uty³: '%c'", 
ty³
);

473 
d©®’
 = 
outbuf
->
u£d_size
 - datalen;

474 
	`Šs_outbuf_putc
(
outbuf
, ':');

475 
»s
 = 
	`Šs_outbuf_™ß
(
d©®’
, 
outbuf
);

477  
»s
;

478 
”rÜ
:

480 
	}
}

484 
	$Šs_š¶aû_»v”£
(*
d©a
, 
size_t
 
Ën
)

486 *
d’d
 = 
NULL
;

487 
c
 = '\0';

488 
	`as£¹
(
d©a
 !ğ
NULL
 && "Data cannot be NULL.");

490 
d’d
 = 
d©a
 + 
Ën
 - 1;

491 
d’d
 > 
d©a
) {

492 
c
 = *
d©a
;

493 *
d©a
 = *
d’d
;

494 *
d’d
 = 
c
;

495 
d©a
++;

496 
d’d
--;

498 
	}
}

500 
	#Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
) {\

501 
Ën
 =†’ - (
»maš
 - 
d©a
);\

502 
	`check
(
Ën
 < 
Üig_Ën
, "Error…arsing data, buffer math is off.");\

503 
d©a
 = 
»maš
;\

504 }

	)

507 
	$Šs_·r£_li¡
(*
v®
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

509 *
™em
 = 
NULL
;

510 *
»maš
 = 
NULL
;

511 
size_t
 
Üig_Ën
 = 
Ën
;

513 
	`as£¹
(
v®
 !ğ
NULL
 && "Value cannot be NULL.");

514 
	`as£¹
(
d©a
 !ğ
NULL
 && "data cannot be NULL.");

516 
Ën
 > 0) {

517 
™em
 = 
	`Šs_·r£
(
d©a
, 
Ën
, &
»maš
);

518 
	`check
(
™em
 !ğ
NULL
, "Failedo…arse†ist.");

519 
	`Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
);

520 
	`check
(
	`Šs_add_to_li¡
(
v®
, 
™em
) != -1, "Failedo‡ddƒlemento†ist.");

521 
™em
 = 
NULL
;

526 
”rÜ
:

527 if(
™em
è
	`Šs_v®ue_de¡roy
(item);

529 
	}
}

532 
šlše
 

533 
	$Šs_·r£_diù
(*
v®
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

535 *
key
 = 
NULL
;

536 *
™em
 = 
NULL
;

537 *
»maš
 = 
NULL
;

538 
size_t
 
Üig_Ën
 = 
Ën
;

540 
	`as£¹
(
v®
 !ğ
NULL
 && "Value cannot be NULL.");

541 
	`as£¹
(
d©a
 !ğ
NULL
 && "Data cannot be NULL.");

543 
Ën
 > 0) {

544 
key
 = 
	`Šs_·r£
(
d©a
, 
Ën
, &
»maš
);

545 
	`check
(
key
 !ğ
NULL
, "Failedo…arse dict key fromnetstring.");

546 
	`Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
);

548 
™em
 = 
	`Šs_·r£
(
d©a
, 
Ën
, &
»maš
);

549 
	`check
(
™em
 !ğ
NULL
, "Failedo…arse dict key fromnetstring.");

551 
	`Šs_rÙ©e_bufãr
(
d©a
, 
»maš
, 
Ën
, 
Üig_Ën
);

552 
	`check
(
	`Šs_add_to_diù
(
v®
,
key
,
™em
) != -1, "Failedo‡ddƒlemento dict.");

553 
key
 = 
NULL
;

554 
™em
 = 
NULL
;

559 
”rÜ
:

560 if(
key
è
	`Šs_v®ue_de¡roy
(key);

561 if(
™em
è
	`Šs_v®ue_de¡roy
(item);

563 
	}
}

566 
šlše
 

567 
	$Šs_outbuf_™ß
(
size_t
 
n
, 
Šs_outbuf
 *
outbuf
)

570 
	`check
(
	`Šs_outbuf_putc
(
outbuf
, 
n
%10+'0') != -1, "Failedo write intonetstring buffer.");

571 
n
 =‚ / 10;

572 } 
n
 > 0);

576 
”rÜ
:

578 
	}
}

581 
šlše
 

582 
	$Šs_outbuf_š™
(
Šs_outbuf
 *
outbuf
)

584 
outbuf
->
bufãr
 = 
	`m®loc
(64);

585 
	`check_mem
(
outbuf
->
bufãr
);

587 
outbuf
->
®loc_size
 = 64;

588 
outbuf
->
u£d_size
 = 0;

591 
”rÜ
:

592 
outbuf
->
®loc_size
 = 0;

593 
outbuf
->
u£d_size
 = 0;

595 
	}
}

598 
šlše
 

599 
	$Šs_outbuf_ä“
(
Šs_outbuf
 *
outbuf
)

601 if(
outbuf
) {

602 
	`ä“
(
outbuf
->
bufãr
);

603 
outbuf
->
bufãr
 = 
NULL
;

604 
outbuf
->
®loc_size
 = 0;

605 
outbuf
->
u£d_size
 = 0;

607 
	}
}

610 
šlše
 

611 
	$Šs_outbuf_ex‹nd
(
Šs_outbuf
 *
outbuf
)

613 *
Ãw_buf
 = 
NULL
;

614 
size_t
 
Ãw_size
 = 
outbuf
->
®loc_size
 * 2;

616 
Ãw_buf
 = 
	`»®loc
(
outbuf
->
bufãr
, 
Ãw_size
);

617 
	`check_mem
(
Ãw_buf
);

619 
outbuf
->
bufãr
 = 
Ãw_buf
;

620 
outbuf
->
®loc_size
 = 
Ãw_size
;

624 
”rÜ
:

626 
	}
}

629 
šlše
 

630 
	$Šs_outbuf_putc
(
Šs_outbuf
 *
outbuf
, 
c
)

632 if(
outbuf
->
®loc_size
 =ğoutbuf->
u£d_size
) {

633 
	`check
(
	`Šs_outbuf_ex‹nd
(
outbuf
) != -1, "Failedoƒxtend buffer.");

636 
outbuf
->
bufãr
[outbuf->
u£d_size
++] = 
c
;

639 
”rÜ
:

641 
	}
}

644 
šlše
 

645 
	$Šs_outbuf_½uts
(
Šs_outbuf
 *
outbuf
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

647 cÚ¡ *
d’d
 = 
NULL
;

648 *
bufãr
 = 
NULL
;

651 
outbuf
->
®loc_size
 - outbuf->
u£d_size
 < 
Ën
) {

652 
	`check
(
	`Šs_outbuf_ex‹nd
(
outbuf
) != -1, "Failedo„puts into‡netstring buffer.");

656 
bufãr
 = 
outbuf
->bufã¸+ outbuf->
u£d_size
;

657 
d’d
 = 
d©a
 + 
Ën
 - 1;

659 
d’d
 >ğ
d©a
) {

660 *
bufãr
 = *
d’d
;

661 
bufãr
++;

662 
d’d
--;

665 
outbuf
->
u£d_size
 +ğ
Ën
;

668 
”rÜ
:

670 
	}
}

672 
Šs_v®ue_t
 *
	$Šs_¡ªd¬d_bË
(
b¡ršg
 
h—d”_d©a
, 
Šs_v®ue_t
 *
rows
)

674 
Šs_v®ue_t
 *
h—d”s
 = 
	`Šs_·r£
(
	`bd©a
(
h—d”_d©a
), 
	`bËngth
(h—d”_d©a), 
NULL
);

675 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_Ãw_diù
();

677 
	`Šs_diù_£tc¡r
(
»suÉ
, "h—d”s", 
h—d”s
);

678 
	`Šs_diù_£tc¡r
(
»suÉ
, "rows", 
rows
);

680  
»suÉ
;

681 
	}
}

	@tools/src/tnetstrings.h

1 #iâdeà
_Š‘¡ršgs_h


2 
	#_Š‘¡ršgs_h


	)

4 
	~<¡dlib.h
>

5 
	~<¡ddef.h
>

6 
	~<ùy³.h
>

7 
	~"b¡ršg.h
"

8 
	~"adt/hash.h
"

9 
	~"adt/d¬¿y.h
"

11 
	sŠs_outbuf_s
 {

12 *
	mbufãr
;

13 
size_t
 
	mu£d_size
;

14 
size_t
 
	m®loc_size
;

15 } 
	tŠs_outbuf
;

17 
	eŠs_ty³_g_e
 {

18 
	mŠs_g_¡ršg
 = ',',

19 
	mŠs_g_numb”
 = '#',

20 
	mŠs_g_æßt
 = '^',

21 
	mŠs_g_boŞ
 = '!',

22 
	mŠs_g_nuÎ
 = '~',

23 
	mŠs_g_diù
 = '}',

24 
	mŠs_g_li¡
 = ']',

25 
	mŠs_g_šv®id
 = 'Z',

26 } 
	tŠs_ty³_g
;

28 
	sŠs_v®ue_t
 {

29 
Šs_ty³_g
 
	mty³
;

32 
b¡ršg
 
	m¡ršg
;

33 
	mnumb”
;

34 
	måošt
;

35 
	mboŞ
;

36 
d¬¿y_t
 *
	mli¡
;

37 
hash_t
 *
	mdiù
;

38 } 
	mv®ue
;

39 } 
	tŠs_v®ue_t
;

41 
	#MAX_HASH_COUNT
 
HASHCOUNT_T_MAX


	)

43 
Šs_hnode_ä“
(
hnode_t
 *
node
, *
nÙu£d
);

45 
hnode_t
 *
Šs_hnode_®loc
(*
nÙu£d
);

47 
Šs_v®ue_de¡roy
(
Šs_v®ue_t
 *
v®ue
);

55 *
Šs_·r£
(cÚ¡ *
d©a
, 
size_t
 
Ën
, ** 
»maš
);

65 *
Šs_»nd”
(*
v®
, 
size_t
 *
Ën
);

75 *
Šs_»nd”_»v”£d
(*
v®
, 
size_t
 *
Ën
);

78 
Šs_»nd”_hash_·œ
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
key
, b¡ršg 
v®ue
);

80 
Šs_»nd”_»que¡_h—d”s
(
Šs_outbuf
 *
outbuf
, 
hash_t
 *
h—d”s
);

82 
b¡ršg
 
Šs_outbuf_to_b¡ršg
(
Šs_outbuf
 *
outbuf
);

84 
Šs_outbuf_şamp
(
Šs_outbuf
 *
outbuf
, 
Üig_size
);

87 
Šs_»nd”_»que¡_¡¬t
(
Šs_outbuf
 *
outbuf
);

89 
Šs_»nd”_»que¡_’d
(
Šs_outbuf
 *
outbuf
, 
h—d”_¡¬t
, 
b¡ršg
 
uuid
, 
id
, b¡ršg 
·th
);

91 
Šs_»nd”_log_¡¬t
(
Šs_outbuf
 *
outbuf
);

93 
Šs_»nd”_log_’d
(
Šs_outbuf
 *
outbuf
);

95 
Šs_»nd”_¡ršg_´•’d
(
Šs_outbuf
 *
outbuf
, 
b¡ršg
 
v®ue
);

96 
Šs_»nd”_numb”_´•’d
(
Šs_outbuf
 *
outbuf
, 
v®ue
);

98 
Šs_v®ue_t
 *
Šs_¡ªd¬d_bË
(
b¡ršg
 
h—d”_d©a
,ns_v®ue_ˆ*
rows
);

100 
	#Šs_g‘_ty³
(
T
è(((
Šs_v®ue_t
 *)(T)è=ğ
NULL
 ? 
Šs_g_šv®id
 : (Ñns_v®ue_ˆ*)(T))->
ty³
)

	)

	@tools/src/tnetstrings_impl.h

1 #iâdeà
_Š‘¡ršgs_im¶_h


2 
	#_Š‘¡ršgs_im¶_h


	)

4 
	~"dbg.h
"

5 
	~<as£¹.h
>

7 
šlše
 
Šs_v®ue_t
 *
	$Šs_v®ue_ü—‹
(
Šs_ty³_g
 
g
)

9 
Šs_v®ue_t
 *
v®
 = 
	`m®loc
((tns_value_t));

10 
v®
->
ty³
 = 
g
;

11  
v®
;

12 
	}
}

16 
šlše
 *
	$Šs_Ãw_diù
()

18 
Šs_v®ue_t
 *
v®
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_diù
);

19 
v®
->
v®ue
.
diù
 = 
	`hash_ü—‹
(
MAX_HASH_COUNT
, (
hash_comp_t
)
b¡rcmp
, 
b¡r_hash_fun
);

20 
	`hash_£t_®loÿtÜ
(
v®
->
v®ue
.
diù
, 
Šs_hnode_®loc
, 
Šs_hnode_ä“
, 
NULL
);

22  
v®
;

23 
	}
}

25 
šlše
 
	$Šs_add_to_diù
(*
diù
, *
key
, *
™em
)

27 
	`check
(
	`Šs_g‘_ty³
(
diù
è=ğ
Šs_g_diù
, "Can't‡ddohat, it's‚ot‡ dict.");

28 
hash_t
 *
h
 = ((
Šs_v®ue_t
 *)
diù
)->
v®ue
.dict;

29 
Šs_v®ue_t
 *
k
 = 
key
;

31 
	`check
(
k
->
ty³
 =ğ
Šs_g_¡ršg
, "Only strings can be keys.");

32 
	`check
(
	`hash_®loc_š£¹
(
h
, 
k
->
v®ue
.
¡ršg
, 
™em
), "Failedo insert key into dict.");

34 
	`ä“
(
k
);

36 
”rÜ
:

38 
	}
}

42 
šlše
 *
	$Šs_g‘_nuÎ
()

44  
	`Šs_v®ue_ü—‹
(
Šs_g_nuÎ
);

45 
	}
}

47 
šlše
 *
	$Šs_g‘_Œue
()

49 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_boŞ
);

50 
t
->
v®ue
.
boŞ
 = 1;

51  
t
;

52 
	}
}

54 
šlše
 *
	$Šs_g‘_çl£
()

56 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_boŞ
);

57 
t
->
v®ue
.
boŞ
 = 0;

58  
t
;

59 
	}
}

61 
šlše
 *
	$Šs_Ãw_li¡
()

63 
Šs_v®ue_t
 *
v®
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_li¡
);

64 
v®
->
v®ue
.
li¡
 = 
	`d¬¿y_ü—‹
((
Šs_v®ue_t
), 100);

66  
v®
;

67 
	}
}

69 
šlše
 
	$Šs_add_to_li¡
(*
li¡
, *
™em
)

71 
	`check
(
	`Šs_g‘_ty³
(
li¡
è=ğ
Šs_g_li¡
, "Can't‡ddohat, it's‚ot‡†ist.");

72 
d¬¿y_t
 *
L
 = ((
Šs_v®ue_t
 *)
li¡
)->
v®ue
.list;

73 
	`d¬¿y_push
(
L
, 
™em
);

75 
”rÜ
:

77 
	}
}

80 
šlše
 *
	$Šs_·r£_¡ršg
(cÚ¡ *
d©a
, 
size_t
 
Ën
)

82 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_¡ršg
);

83 
t
->
v®ue
.
¡ršg
 = 
	`blk2b¡r
(
d©a
, 
Ën
);

84  
t
;

85 
	}
}

87 
šlše
 *
	$Šs_·r£_š‹g”
(cÚ¡ *
d©a
, 
size_t
 
Ën
)

89 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_numb”
);

90 *
’d±r
 = 
NULL
;

91 
t
->
v®ue
.
numb”
 = 
	`¡¹Ş
(
d©a
, &
’d±r
, 10);

92 
	`check
(
’d±r
 !ğ
NULL
 &&ƒnd±¸- 
d©a
 =ğ()
Ën
, "Failedo…arse integer.");

93 
	`check
(
”ºo
 !ğ
ERANGE
, "Integer isoo†arge.");

95  
t
;

96 
”rÜ
:

97  
NULL
;

98 
	}
}

100 
šlše
 *
	$Šs_·r£_æßt
(cÚ¡ *
d©a
, 
size_t
 
Ën
)

102 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_æßt
);

103 *
’d±r
 = 
NULL
;

104 
t
->
v®ue
.
åošt
 = 
	`¡¹od
(
d©a
, 
NULL
);

105 
	`check
(
’d±r
 !ğ
NULL
 &&ƒnd±¸- 
d©a
 =ğ()
Ën
, "Failedo…arse float.");

106 
	`check
(
”ºo
 !ğ
ERANGE
, "Float isoo†arge.");

108  
t
;

109 
”rÜ
:

110  
NULL
;

111 
	}
}

114 
šlše
 *
	$Šs_Ãw_š‹g”
(
numb”
)

116 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_numb”
);

117 
t
->
v®ue
.
numb”
 =‚umber;

118  
t
;

119 
	}
}

121 
šlše
 *
	$Šs_Ãw_æßt
(
åošt
)

123 
Šs_v®ue_t
 *
t
 = 
	`Šs_v®ue_ü—‹
(
Šs_g_æßt
);

124 
t
->
v®ue
.
åošt
 = fpoint;

125  
t
;

126 
	}
}

129 
šlše
 
	$Šs_diù_£tc¡r
(
Šs_v®ue_t
 *
d
, cÚ¡ *
key
,ns_v®ue_ˆ*
v®
)

131  
	`Šs_add_to_diù
(
d
, 
	`Šs_·r£_¡ršg
(
key
, 
	`¡¾’
(key)), 
v®
);

132 
	}
}

134 
šlše
 
	$Šs_diù_£t
(
Šs_v®ue_t
 *
d
, 
b¡ršg
 
key
,ns_v®ue_ˆ*
v®
)

136  
	`Šs_add_to_diù
(
d
, 
	`Šs_·r£_¡ršg
(
	`bd©a
(
key
), 
	`bËngth
(key)), 
v®
);

137 
	}
}

139 
šlše
 
	$Šs_li¡_add¡r
(
Šs_v®ue_t
 *
d
, 
b¡ršg
 
–em’t
)

141  
	`Šs_add_to_li¡
(
d
,

142 
	`Šs_·r£_¡ršg
(
	`bd©a
(
–em’t
), 
	`bËngth
(element)));

143 
	}
}

	@tools/src/unixy.c

35 
	~<unixy.h
>

36 
	~<dbg.h
>

37 
	~<uni¡d.h
>

38 
	~<sys/ty³s.h
>

39 
	~<sys/¡©.h
>

40 
	~<sys/ty³s.h
>

41 
	~<sigÇl.h
>

42 
	~<lim™s.h
>

43 
	~<¡dlib.h
>

47 
	$Unixy_chroÙ
(
b¡ršg
 
·th
)

49 
rc
 = 0;

50 cÚ¡ *
to_dœ
 = 
	`bd©a
(
·th
);

52 
	`check
(
to_dœ
 && 
	`bËngth
(
·th
) > 0, "Invalid orƒmpty…ath for chroot.");

54 
rc
 = 
	`chroÙ
(
to_dœ
);

55 
	`check
(
rc
 =ğ0, "Cª'ˆchroÙØ%s,„”uÀa roÙ iàthi i wh© you wªt.", 
	`bd©a
(
·th
));

57 
rc
 = 
	`chdœ
("/");

58 
	`check
(
rc
 == 0, "Can't chdiro / directory inside chroot.");

62 
”rÜ
:

64 
	}
}

67 
	$Unixy_drİ_´iv
(
b¡ršg
 
·th
)

69 cÚ¡ *
äom_dœ
 = 
	`bd©a
(
·th
);

70 
¡©
 
sb
;

72 
	`check
(
äom_dœ
 && 
	`bËngth
(
·th
), "Chroot…ath can't beƒmpty.");

74 
rc
 = 
	`¡©
(
äom_dœ
, &
sb
);

75 
	`check
(
rc
 =ğ0, "FaedØ¡©¬g‘ chroÙ dœeùÜy: %s", 
	`bd©a
(
·th
));

77 
rc
 = 
	`£Œegid
(
sb
.
¡_gid
, sb.st_gid);

78 
	`check
(
rc
 =ğ0 && 
	`g‘gid
(è=ğ
sb
.
¡_gid
 && 
	`g‘egid
() == sb.st_gid, "Failedo changeo GID: %d", sb.st_gid);

80 
rc
 = 
	`£Œeuid
(
sb
.
¡_uid
, sb.st_uid);

81 
	`check
(
rc
 =ğ0 && 
	`g‘uid
(è=ğ
sb
.
¡_uid
 && 
	`g‘euid
() == sb.st_uid, "Failedo changeo UID: %d", sb.st_uid);

83 
	`log_šfo
("Now„uÂšg‡ UID:%d, GID:%d", 
sb
.
¡_uid
, sb.
¡_gid
);

86 
”rÜ
:

88 
	}
}

91 
pid_t
 
	$Unixy_pid_»ad
(
b¡ršg
 
pid_·th
)

93 
pid_t
 
pid
 = -1;

94 
FILE
 *
pid_fe
 = 
NULL
;

96 
	`check
(
pid_·th
, "PID file has‚ot been set yet.");

98 
pid_fe
 = 
	`fİ’
(
	`bd©a
(
pid_·th
), "r");

99 
	`check
(
pid_fe
, "FaedØİ’ PID f% fÜ„—dšg.", 
	`bd©a
(
pid_·th
));

101 
	`check
(
	`fsÿnf
(
pid_fe
, "%d", &
pid
è!ğ-1, "FaedØ»ad‡Àš‹g” from PID fe: %s", 
	`bd©a
(
pid_·th
));

103 
	`fşo£
(
pid_fe
);

104  
pid
;

105 
”rÜ
:

107 if(
pid_fe
è
	`fşo£
(pid_file);

109 
	}
}

111 
	$Unixy_¡l_ruÂšg
(
b¡ršg
 
pid_·th
, 
pid_t
 *
pid
)

113 
rc
 = 0;

115 *
pid
 = 
	`Unixy_pid_»ad
(
pid_·th
);

117 if(*
pid
 < 0) {

122 
rc
 = 
	`kl
(*
pid
, 0);

123  
rc
 == 0;

124 
	}
}

127 
	$Unixy_»move_d—d_pidfe
(
b¡ršg
 
pid_·th
)

129 
rc
 = 0;

130 
pid_t
 
pid
 = 0;

132 
rc
 = 
	`Unixy_¡l_ruÂšg
(
pid_·th
, &
pid
);

134 
	`check
(
rc
 !ğ-1, "FaedØfigu» ouˆià´oûs %d i ¡ÈruÂšg. You…robably dÚ'ˆhav/´oøÜ‡ weœd oÃ.", 
pid
);

135 
	`check
(
rc
 !ğ1, "Proûs %d i ¡ÈruÂšg, shuˆ™ dowÀfœ¡.", 
pid
);

137 if(
pid
 == -1) {

138 
	`log_šfo
("No…revious Mongrel2„unning, continuing on.");

140 
	`log_šfo
("Proûs %d i nÙ„uÂšg‡nymÜe, sØ»movšg PID f%s.", 
pid
, 
	`bd©a
(
pid_·th
));

141 
rc
 = 
	`uÆšk
((cÚ¡ *)
pid_·th
->
d©a
);

142 
	`check
(
rc
 =ğ0, "FaedØ»movthPID f%s, mª you'» sØho£d I givup.", 
	`bd©a
(
pid_·th
));

147 
”rÜ
:

149 
	}
}

151 
	$Unixy_pid_fe
(
b¡ršg
 
·th
)

153 
FILE
 *
pid_fe
 = 
NULL
;

154 
rc
 = 0;

155 
¡©
 
sb
;

156 *
pid_·th
 = 
NULL
;

158 
pid_·th
 = 
	`b¡r2c¡r
(
·th
, '\0');

159 
	`check_mem
(
pid_·th
);

161 
rc
 = 
	`¡©
(
pid_·th
, &
sb
);

162 
	`check
(
rc
 == -1, "PID file‡lreadyƒxists, something bad happened.");

165 
pid_fe
 = 
	`fİ’
(
pid_·th
, "w");

166 
	`check
(
pid_fe
, "FaedØİ’ PID f% fÜ wr™šg.", 
pid_·th
);

168 
rc
 = 
	`årštf
(
pid_fe
, "%d", 
	`g‘pid
());

169 
	`check
(
rc
 > 0, "FaedØwr™PIDØf%s", 
pid_·th
);

172 if(
pid_·th
è
	`ä“
(pid_path);

173 
	`fşo£
(
pid_fe
);

176 
”rÜ
:

177 if(
pid_·th
è
	`ä“
(pid_path);

178 if(
pid_fe
è
	`fşo£
(pid_file);

180 
	}
}

183 
	$Unixy_d«mÚize
()

186 
rc
 = 
	`d«mÚ
(0, 1);

187 
	`check
(
rc
 == 0, "Failedo daemonize.");

191 
”rÜ
:

193 
	}
}

196 
b¡ršg
 
	$Unixy_g‘cwd
()

198 *
wd
 = 
	`ÿÎoc
(
PATH_MAX
 + 1, 1);

199 
b¡ršg
 
dœ
 = 
NULL
;

201 
	`check
(
	`g‘cwd
(
wd
, 
PATH_MAX
-1), "Could‚ot get current working directory.");

202 
wd
[
PATH_MAX
] = '\0';

204 
dœ
 = 
	`bäomc¡r
(
wd
);

206 
”rÜ
:

208 
	`ä“
(
wd
);

209  
dœ
;

210 
	}
}

	@tools/src/unixy.h

35 #iâdeà
_unixy_h


36 
	#_unixy_h


	)

38 
	~<b¡ršg.h
>

39 
	~<uni¡d.h
>

41 
Unixy_chroÙ
(
b¡ršg
 
·th
);

43 
Unixy_drİ_´iv
(
b¡ršg
 
·th
);

45 
b¡ršg
 
Unixy_g‘cwd
();

47 
Unixy_pid_fe
(
b¡ršg
 
·th
);

49 
Unixy_d«mÚize
();

51 
Unixy_¡l_ruÂšg
(
b¡ršg
 
pid_·th
, 
pid_t
 *
pid
);

53 
Unixy_»move_d—d_pidfe
(
b¡ršg
 
pid_·th
);

55 
pid_t
 
Unixy_pid_»ad
(
b¡ršg
 
pid_·th
);

	@tools/src/upload.c

35 
	~<sys/¡©.h
>

36 
	~"u¶ßd.h
"

37 
	~"dbg.h
"

38 
	~"£‰šg.h
"

39 
	~"»¥Ú£.h
"

41 
b¡ršg
 
	gUPLOAD_STORE
 = 
NULL
;

42 
mode_t
 
	gUPLOAD_MODE
 = 0;

43 
gb¡ršg
 
	gUPLOAD_MODE_DEFAULT
 = 
bsStic
("0600");

45 
šlše
 
	$¡»am_to_disk
(
IOBuf
 *
iob
, 
cÚ‹Á_Ën
, 
tmpfd
)

47 *
d©a
 = 
NULL
;

48 
ava
 = 0;

50 
	`debug
("max cÚ‹Á†’gth: %d, cÚ‹Á_Ën: %d", 
MAX_CONTENT_LENGTH
, 
cÚ‹Á_Ën
);

52 
	`IOBuf_»size
(
iob
, 
MAX_CONTENT_LENGTH
);

54 
cÚ‹Á_Ën
 > 0) {

55 
d©a
 = 
	`IOBuf_»ad_some
(
iob
, &
ava
);

56 
	`check
(!
	`IOBuf_şo£d
(
iob
), "Closed while„eading from IOBuf.");

57 
cÚ‹Á_Ën
 -ğ
ava
;

58 
	`check
(
	`wr™e
(
tmpfd
, 
d©a
, 
ava
) ==‡vail, "Failedo write„equested‡mountoempfile: %d",‡vail);

60 
	`check
(
	`IOBuf_»ad_comm™
(
iob
, 
ava
) != -1, "Final commit failed streamingo disk.");

63 
	`check
(
cÚ‹Á_Ën
 == 0, "Failedo writeƒverythingohe†arge uploadmpfile.");

67 
”rÜ
:

69 
	}
}

72 
	$U¶ßd_nÙify
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, cÚ¡ *
¡age
, 
b¡ršg
 
tmp_Çme
)

74 
b¡ršg
 
key
 = 
	`bfÜm©
("x-mÚg»l2-u¶ßd-%s", 
¡age
);

75 
	`Reque¡_£t
(
cÚn
->
»q
, 
key
, 
	`b¡rıy
(
tmp_Çme
), 1);

77  
	`CÚÃùiÚ_£nd_to_hªdËr
(
cÚn
, 
hªdËr
, "", 0);

78 
	}
}

80 
	$U¶ßd_fe
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, 
cÚ‹Á_Ën
)

82 
rc
 = 0;

83 
tmpfd
 = 0;

84 
b¡ršg
 
tmp_Çme
 = 
NULL
;

85 
b¡ršg
 
»suÉ
 = 
NULL
;

87 if(
UPLOAD_STORE
 =ğ
NULL
) {

88 
UPLOAD_STORE
 = 
	`S‘tšg_g‘_¡r
("u¶ßd.‹mp_¡Üe", 
NULL
);

89 
	`”rÜ_uÆess
(
UPLOAD_STORE
, 
cÚn
, 413, "Reque¡ƒÁ™y i toØÏrge: %d,‡nd‚Øu¶ßd.‹mp_¡Ü£‰šg fÜ wh”tØpuˆthbig fes.", 
cÚ‹Á_Ën
);

91 
UPLOAD_STORE
 = 
	`b¡rıy
(UPLOAD_STORE);

94 if(
UPLOAD_MODE
 == 0) {

95 
b¡ršg
 
mode
 = 
	`S‘tšg_g‘_¡r
("u¶ßd.‹mp_¡Üe_mode", &
UPLOAD_MODE_DEFAULT
);

96 
	`log_šfo
("WÈ£ˆmodfÜ u¶ßdem°¡Üto: %s", 
	`bd©a
(
mode
));

98 
UPLOAD_MODE
 = 
	`¡¹oul
((cÚ¡ *)
mode
->
d©a
, 
NULL
, 0);

99 
	`check
(
UPLOAD_MODE
 > 0, "Failedo convert upload.temp_store_modeo‡‚umber.");

100 
	`check
(
UPLOAD_MODE
 < 066666, "Inv®id modth©' wayoØbig: %s.", 
	`bd©a
(
mode
));

103 
tmp_Çme
 = 
	`b¡rıy
(
UPLOAD_STORE
);

105 
tmpfd
 = 
	`mk¡emp
((*)
tmp_Çme
->
d©a
);

106 
	`check
(
tmpfd
 != -1, "Failedo create secureempfile, did youƒnd it with XXXXXX?");

108 
	`log_šfo
("Wr™šgempf% fÜ†¬gu¶ßd.", 
	`bd©a
(
tmp_Çme
));

110 
rc
 = 
	`chmod
((*)
tmp_Çme
->
d©a
, 
UPLOAD_MODE
);

111 
	`check
(
rc
 == 0, "Failedo chmod.");

113 
rc
 = 
	`U¶ßd_nÙify
(
cÚn
, 
hªdËr
, "¡¬t", 
tmp_Çme
);

114 
	`check
(
rc
 == 0, "Failedo‚otify ofhe start of upload.");

116 
rc
 = 
	`¡»am_to_disk
(
cÚn
->
iob
, 
cÚ‹Á_Ën
, 
tmpfd
);

117 
	`check
(
rc
 == 0, "Failedo streamo disk.");

119 
rc
 = 
	`U¶ßd_nÙify
(
cÚn
, 
hªdËr
, "dÚe", 
tmp_Çme
);

120 
	`check
(
rc
 == 0, "Failedo‚otifyheƒnd ofhe upload.");

122 
	`bde¡roy
(
»suÉ
);

123 
	`bde¡roy
(
tmp_Çme
);

124 
	`fdşo£
(
tmpfd
);

127 
”rÜ
:

128 if(
»suÉ
è
	`bde¡roy
(result);

129 
	`fdşo£
(
tmpfd
);

131 if(
tmp_Çme
 !ğ
NULL
) {

132 
	`uÆšk
((*)
tmp_Çme
->
d©a
);

133 
	`bde¡roy
(
tmp_Çme
);

137 
	}
}

	@tools/src/upload.h

1 #iâdeà
_u¶ßd_h


2 
	#_u¶ßd_h


	)

4 
	~"cÚÃùiÚ.h
"

5 
	~"hªdËr.h
"

7 
U¶ßd_fe
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, 
cÚ‹Á_Ën
);

8 
U¶ßd_nÙify
(
CÚÃùiÚ
 *
cÚn
, 
HªdËr
 *
hªdËr
, cÚ¡ *
¡age
, 
b¡ršg
 
tmp_Çme
);

	@tools/src/version.h

1 
	#VERSION
 "MÚg»l2/1.7.5"

	)

	@tools/tests/bstr_tests.c

1 #undeà
NDEBUG


2 
	~<¡dio.h
>

3 
	~<b¡r/b¡¾ib.h
>

4 
	~<b¡r/b¡¿ux.h
>

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<¡d¬g.h
>

8 
	~<lim™s.h
>

9 
	~<ùy³.h
>

10 
	~<dbg.h
>

12 
	$tWr™e
 (cÚ¡ * 
buf
, 
size_t
 
–size
, size_ˆ
ÃËm
, * 
·rm
) {

13 
b¡ršg
 
b
 = (b¡ršgè
·rm
;

14 
size_t
 
i
;

16 ià(
NULL
 =ğ
b
 || NULL =ğ
buf
 || 0 =ğ
–size
 || 0 =ğ
ÃËm
)

17  -
__LINE__
;

19 
i
=0; i < 
ÃËm
; i++) {

20 ià(0 > 
	`bÿtblk
 (
b
, 
buf
, 
–size
)) ;

21 
buf
 = (cÚ¡ *è(
–size
 + (const *) buf);

23  (è
i
;

24 
	}
}

26 
	$‹¡aux0
 () {

27 
bwr™eSŒ—m
 * 
ws
;

28 
b¡ršg
 
s
;

29 
»t
 = 0;

31 
	`debug
 ("TEST: struct bwriteStream functions.");

33 
ws
 = 
	`bwsO³n
 ((
bNwr™e
è
tWr™e
, (
s
 = 
	`bäomc¡r
 ("")));

34 
	`bwsBuffL’gth
 (
ws
, 8);

35 
»t
 +ğ8 !ğ
	`bwsBuffL’gth
 (
ws
, 0);

36 
	`bwsWr™eBlk
 (
ws
, 
	`bsSticBlkP¬ms
 ("Hello "));

37 
»t
 +ğ0 =ğ
	`bi£qc¡r
 (
s
, "");

38 
	`bwsWr™eBlk
 (
ws
, 
	`bsSticBlkP¬ms
 ("World"));

39 
»t
 +ğ0 =ğ
	`bi£qc¡r
 (
s
, "Hello Wo");

40 
»t
 +ğ
s
 !ğ
	`bwsClo£
 (
ws
);

41 
»t
 +ğ0 =ğ
	`bi£qc¡r
 (
s
, "Hello World");

43 
	`bde¡roy
(
s
);

45 
	`debug
 ("\t# fau»s: %d", 
»t
);

47  
»t
;

48 
	}
}

50 
	$‹¡aux1
 () {

51 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

52 
b¡ršg
 
b
, 
c
, 
d
;

53 
»t
 = 0;

55 
	`debug
 ("TEST: bTail‡nd bHead functions.");

56 
b
 = 
	`bTa
 (&
t
, 5);

57 
c
 = 
	`bH—d
 (&
t
, 5);

58 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "world");

59 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
c
, "Hello");

60 
	`bde¡roy
 (
b
);

61 
	`bde¡roy
 (
c
);

63 
b
 = 
	`bTa
 (&
t
, 0);

64 
c
 = 
	`bH—d
 (&
t
, 0);

65 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

66 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
c
, "");

67 
	`bde¡roy
 (
b
);

68 
	`bde¡roy
 (
c
);

70 
d
 = 
	`b¡rıy
 (&
t
);

71 
b
 = 
	`bTa
 (
d
, 5);

72 
c
 = 
	`bH—d
 (
d
, 5);

73 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "world");

74 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
c
, "Hello");

75 
	`bde¡roy
 (
b
);

76 
	`bde¡roy
 (
c
);

77 
	`bde¡roy
 (
d
);

79 
	`debug
 ("\t# fau»s: %d", 
»t
);

81  
»t
;

82 
	}
}

84 
	$‹¡aux2
 () {

85 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

86 
b¡ršg
 
b
;

87 
»t
 = 0, 
»to
;

89 
	`debug
 ("TEST: bSetChar function.");

90 
»t
 +ğ0 <ğ
	`bS‘Ch¬
 (&
t
, 4, ',');

91 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
 = 
	`b¡rıy
 (&
t
), 4, ',');

92 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hell, world");

93 
»t
 +ğ0 <ğ
	`bS‘Ch¬
 (
b
, -1, 'x');

94 
b
->
¦’
 = 2;

95 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
, 1, 'i');

96 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hi");

97 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
, 2, 's');

98 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "His");

99 
»t
 +ğ0 > 
	`bS‘Ch¬
 (
b
, 1, '\0');

100 
»t
 +ğ
	`bËngth
 (
b
) != 3;

101 
»t
 +ğ
	`bch¬e
 (
b
, 0, '?') != 'H';

102 
»t
 +ğ
	`bch¬e
 (
b
, 1, '?') != '\0';

103 
»t
 +ğ
	`bch¬e
 (
b
, 2, '?') != 's';

104 
	`bde¡roy
 (
b
);

106 
	`debug
 ("\t# fau»s: %d", 
»t
);

108 
»to
 = 
»t
;

109 
»t
 = 0;

111 
	`debug
 ("TEST: bSetCstrChar function.");

112 
»t
 +ğ0 <ğ
	`bS‘C¡rCh¬
 (&
t
, 4, ',');

113 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
 = 
	`b¡rıy
 (&
t
), 4, ',');

114 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hell, world");

115 
»t
 +ğ0 <ğ
	`bS‘C¡rCh¬
 (
b
, -1, 'x');

116 
b
->
¦’
 = 2;

117 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
, 1, 'i');

118 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hi");

119 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
, 2, 's');

120 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "His");

121 
»t
 +ğ0 > 
	`bS‘C¡rCh¬
 (
b
, 1, '\0');

122 
»t
 +ğ
	`bËngth
 (
b
) != 1;

123 
»t
 +ğ
	`bch¬e
 (
b
, 0, '?') != 'H';

124 
	`bde¡roy
 (
b
);

126 
	`debug
 ("\t# fau»s: %d", 
»t
);

128  
»to
 + 
»t
;

129 
	}
}

131 
	$‹¡aux3
 () {

132 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

133 
b¡ršg
 
b
;

134 
»t
 = 0;

136 
	`debug
 ("TEST: bFill function.");

137 
»t
 +ğ0 <ğ
	`bFl
 (&
t
, 'x', 7);

138 
»t
 +ğ0 > 
	`bFl
 (
b
 = 
	`b¡rıy
 (&
t
), 'x', 7);

139 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "xxxxxxx");

140 
»t
 +ğ0 <ğ
	`bFl
 (
b
, 'x', -1);

141 
»t
 +ğ0 > 
	`bFl
 (
b
, 'x', 0);

142 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

143 
	`bde¡roy
 (
b
);

145 
	`debug
 ("\t# fau»s: %d", 
»t
);

147  
»t
;

148 
	}
}

150 
	$‹¡aux4
 () {

151 
gb¡ršg
 
t
 = 
	`bsStic
 ("foo");

152 
b¡ršg
 
b
;

153 
»t
 = 0;

155 
	`debug
 ("TEST: bReplicate function.");

156 
»t
 +ğ0 <ğ
	`bR•liÿ‹
 (&
t
, 4);

157 
»t
 +ğ0 <ğ
	`bR•liÿ‹
 (
b
 = 
	`b¡rıy
 (&
t
), -1);

158 
»t
 +ğ0 > 
	`bR•liÿ‹
 (
b
, 4);

159 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "foofoofoofoo");

160 
»t
 +ğ0 > 
	`bR•liÿ‹
 (
b
, 0);

161 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

162 
	`bde¡roy
 (
b
);

164 
	`debug
 ("\t# fau»s: %d", 
»t
);

166  
»t
;

167 
	}
}

169 
	$‹¡aux5
 () {

170 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

171 
b¡ršg
 
b
;

172 
»t
 = 0;

174 
	`debug
 ("TEST: bReverse function.");

175 
»t
 +ğ0 <ğ
	`bRev”£
 (&
t
);

176 
»t
 +ğ0 > 
	`bRev”£
 (
b
 = 
	`b¡rıy
 (&
t
));

177 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "dlrow olleH");

178 
b
->
¦’
 = 0;

179 
»t
 +ğ0 > 
	`bRev”£
 (
b
);

180 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "");

181 
	`bde¡roy
 (
b
);

183 
	`debug
 ("\t# fau»s: %d", 
»t
);

185  
»t
;

186 
	}
}

188 
	$‹¡aux6
 () {

189 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

190 
b¡ršg
 
b
;

191 
»t
 = 0;

193 
	`debug
 ("TEST: bInsertChrs function.");

194 
»t
 +ğ0 <ğ
	`bIn£¹Chrs
 (&
t
, 6, 4, 'x', '?');

195 
»t
 +ğ0 > 
	`bIn£¹Chrs
 (
b
 = 
	`b¡rıy
 (&
t
), 6, 4, 'x', '?');

196 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "Hello xxxxworld");

197 
	`bde¡roy
 (
b
);

199 
	`debug
 ("\t# fau»s: %d", 
»t
);

201  
»t
;

202 
	}
}

204 
	$‹¡aux7
 () {

205 
gb¡ršg
 
t
 = 
	`bsStic
 (" i‡m ");

206 
b¡ršg
 
b
;

207 
»t
 = 0;

209 
	`debug
 ("TEST: bJustify functions.");

210 
»t
 +ğ0 <ğ
	`bJu¡ifyLeá
 (&
t
, ' ');

211 
»t
 +ğ0 <ğ
	`bJu¡ifyRight
 (&
t
, 8, ' ');

212 
»t
 +ğ0 <ğ
	`bJu¡ifyM¬gš
 (&
t
, 8, ' ');

213 
»t
 +ğ0 <ğ
	`bJu¡ifyC’‹r
 (&
t
, 8, ' ');

214 
»t
 +ğ0 > 
	`bJu¡ifyLeá
 (
b
 = 
	`b¡rıy
 (&
t
), ' ');

215 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "i‡m");

216 
»t
 +ğ0 > 
	`bJu¡ifyRight
 (
b
, 8, ' ');

217 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, " i‡m");

218 
»t
 +ğ0 > 
	`bJu¡ifyM¬gš
 (
b
, 8, ' ');

219 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "i‡m");

220 
»t
 +ğ0 > 
	`bJu¡ifyC’‹r
 (
b
, 8, ' ');

221 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, " i‡m");

222 
	`bde¡roy
 (
b
);

224 
	`debug
 ("\t# fau»s: %d", 
»t
);

226  
»t
;

227 
	}
}

229 
	$‹¡aux8
 () {

230 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

231 
b¡ršg
 
b
;

232 * 
c
;

233 
»t
 = 0;

235 
	`debug
 ("TEST: NetStr functions.");

236 
c
 = 
	`bSŒ2N‘SŒ
 (&
t
);

237 
»t
 +ğ0 !ğ
	`¡rcmp
 (
c
, "11:Hello world,");

238 
b
 = 
	`bN‘SŒ2B¡r
 (
c
);

239 
»t
 +ğ0 >ğ
	`bi£q
 (
b
, &
t
);

240 
	`bde¡roy
 (
b
);

241 
	`bc¡rä“
 (
c
);

243 
	`debug
 ("\t# fau»s: %d", 
»t
);

245  
»t
;

246 
	}
}

248 
	$‹¡aux9
 () {

249 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

250 
b¡ršg
 
b
, 
c
;

251 
”r
, 
»t
 = 0;

253 
	`debug
 ("TEST: Base 64 codec.");

255 
b
 = 
	`bBa£64Encode
 (&
t
);

256 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "SGVsbG8gd29ybGQ=");

257 
c
 = 
	`bBa£64DecodeEx
 (
b
, &
”r
);

258 
»t
 +ğ0 !ğ
”r
;

259 
»t
 +ğ0 >ğ
	`bi£q
 (
c
, &
t
);

260 
	`bde¡roy
 (
b
);

261 
	`bde¡roy
 (
c
);

263 
	`debug
 ("\t# fau»s: %d", 
»t
);

265  
»t
;

266 
	}
}

268 
	$‹¡aux10
 () {

269 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

270 
b¡ršg
 
b
, 
c
;

271 
”r
, 
»t
 = 0;

273 
	`debug
 ("TEST: UU codec.");

275 
b
 = 
	`bUuEncode
 (&
t
);

276 
»t
 +ğ0 >ğ
	`bi£qc¡r
 (
b
, "+2&5L;&\\@=V]R;&0`\r\n");

277 
c
 = 
	`bUuDecodeEx
 (
b
, &
”r
);

278 
»t
 +ğ0 !ğ
”r
;

279 
»t
 +ğ0 >ğ
	`bi£q
 (
c
, &
t
);

280 
	`bde¡roy
 (
b
);

281 
	`bde¡roy
 (
c
);

283 
	`debug
 ("\t# fau»s: %d", 
»t
);

285  
»t
;

286 
	}
}

288 
	$‹¡aux11
 () {

289 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

290 
Yt¡r
[] = {0x72, 0x8f, 0x96, 0x96, 0x99, 0x4a, 0xa1, 0x99, 0x9c, 0x96, 0x8e};

291 
b¡ršg
 
b
, 
c
;

292 
»t
 = 0;

294 
	`debug
 ("TEST: Y codec.");

296 
b
 = 
	`bYEncode
 (&
t
);

297 
»t
 +ğ11 !ğ
b
->
¦’
;

298 
»t
 +ğ0 >ğ
	`bis¡emeqblk
 (
b
, 
Yt¡r
, 11);

299 
c
 = 
	`bYDecode
 (
b
);

300 
»t
 +ğ0 >ğ
	`bi£q
 (
c
, &
t
);

301 
	`bde¡roy
 (
b
);

302 
	`bde¡roy
 (
c
);

304 
	`debug
 ("\t# fau»s: %d", 
»t
);

306  
»t
;

307 
	}
}

309 
	$‹¡aux12
 () {

310 
gb¡ršg
 
t
 = 
	`bsStic
 ("Hello world");

311 
bSŒ—m
 * 
s
;

312 
b¡ršg
 
b
;

313 
»t
 = 0;

315 
	`debug
 ("TEST: bsFromBstr.");

317 
»t
 = 
	`b¤—d
 (
b
 = 
	`bäomc¡r
 (""), 
s
 = 
	`bsFromB¡r
 (&
t
), 6);

318 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b
, "Hello ");

319 ià(
b
èb->
¦’
 = 0;

320 
»t
 = 
	`b¤—d
 (
b
, 
s
, 6);

321 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b
, "world");

323 
	`bde¡roy
 (
b
);

324 
	`bsşo£
 (
s
);

326 
	`debug
 ("\t# fau»s: %d", 
»t
);

328  
»t
;

329 
	}
}

331 
	svfg‘c
 {

332 
	mofs
;

333 
b¡ršg
 
	mba£
;

345 
b¡ršg
 
	gdumpOut
[16];

346 
	grÙ
 = 0;

348 * 
	$dumpB¡ršg
 (cÚ¡ 
gb¡ršg
 * 
b
) {

349 
rÙ
 = (rot + 1) % ()16;

350 ià(
dumpOut
[
rÙ
] =ğ
NULL
) {

351 
dumpOut
[
rÙ
] = 
	`bäomc¡r
 ("");

352 ià(
dumpOut
[
rÙ
] =ğ
NULL
)  "FATAL INTERNAL ERROR";

354 
dumpOut
[
rÙ
]->
¦’
 = 0;

355 ià(
b
 =ğ
NULL
) {

356 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "NULL");

358 
msg
[256];

359 
	`¥rštf
(
msg
, "%p", (*)
b
);

360 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], 
msg
);

362 ià(
b
->
¦’
 < 0) {

363 
	`¥rštf
 (
msg
, ":[”r:¦’=%d<0]", 
b
->
¦’
);

364 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], 
msg
);

366 ià(
b
->
mËn
 > 0 && b->mËÀ< b->
¦’
) {

367 
	`¥rštf
 (
msg
, ":[”r:mËn=%d<¦’=%d]", 
b
->
mËn
, b->
¦’
);

368 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], 
msg
);

370 ià(
b
->
mËn
 == -1) {

371 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "[p]");

372 } ià(
b
->
mËn
 < 0) {

373 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "[c]");

375 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], ":");

376 ià(
b
->
d©a
 =ğ
NULL
) {

377 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "[err:data=NULL]");

379 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "\"");

380 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], (cÚ¡ *è
b
->
d©a
);

381 
	`bÿtc¡r
 (
dumpOut
[
rÙ
], "\"");

386  (*è
dumpOut
[
rÙ
]->
d©a
;

387 
	}
}

389 
	$‹¡0_0
 (cÚ¡ * 
s
, cÚ¡ * 
»s
) {

390 
b¡ršg
 
b0
 = 
	`bäomc¡r
 (
s
);

391 
»t
 = 0;

393 ià(
s
 =ğ
NULL
) {

394 ià(
»s
 !ğ
NULL
è
»t
++;

395 
	`debug
 (".\tbäomc¡¸(NULLèğ%s", 
	`dumpB¡ršg
 (
b0
));

396  
»t
;

399 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b0
->
¦’
)

400 || (0 !ğ
	`memcmp
 (
»s
, 
b0
->
d©a
, b0->
¦’
));

401 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

403 
	`debug
 (".\tbäomc¡¸(\"%s\"èğ%s", 
s
, 
	`dumpB¡ršg
 (
b0
));

404 
	`bde¡roy
 (
b0
);

405  
»t
;

406 
	}
}

408 
	$‹¡0_1
 (cÚ¡ * 
s
, 
Ën
, cÚ¡ * 
»s
) {

409 
b¡ršg
 
b0
 = 
	`bäomc¡¿Îoc
 (
Ën
, 
s
);

410 
»t
 = 0;

412 ià(
s
 =ğ
NULL
) {

413 ià(
»s
 !ğ
NULL
è
»t
++;

414 
	`debug
 (".\tbäomc¡¿Îoø(*, NULLèğ%s", 
	`dumpB¡ršg
 (
b0
));

415  
»t
;

418 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b0
->
¦’
)

419 || (0 !ğ
	`memcmp
 (
»s
, 
b0
->
d©a
, b0->
¦’
));

420 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

421 
»t
 +ğ
Ën
 > 
b0
->
mËn
;

423 
	`debug
 (".\tbäomc¡¿Îoø(%d, \"%s\"èğ%s", 
Ën
, 
s
, 
	`dumpB¡ršg
 (
b0
));

424 
	`bde¡roy
 (
b0
);

425  
»t
;

426 
	}
}

428 
	#EMPTY_STRING
 ""

	)

429 
	#SHORT_STRING
 "bogus"

	)

430 
	#LONG_STRING
 "Thi i ¨bogu buˆ»asÚably†Úg sŒšg. Ju¡†ÚgƒnoughØÿu£ somm®locšg."

	)

432 
	$‹¡0
 () {

433 
»t
 = 0;

435 
	`debug
 ("TEST: bstring bfromcstr (const char * str);");

438 
»t
 +ğ
	`‹¡0_0
 (
NULL
, NULL);

441 
»t
 +ğ
	`‹¡0_0
 (
EMPTY_STRING
, EMPTY_STRING);

442 
»t
 +ğ
	`‹¡0_0
 (
SHORT_STRING
, SHORT_STRING);

443 
»t
 +ğ
	`‹¡0_0
 (
LONG_STRING
, LONG_STRING);

444 
	`debug
 ("\t# fau»s: %d", 
»t
);

446 
	`debug
 ("TEST: bstring bfromcstralloc (int†en, const char * str);");

449 
»t
 +ğ
	`‹¡0_1
 (
NULL
, 0, NULL);

450 
»t
 +ğ
	`‹¡0_1
 (
NULL
, 30, NULL);

453 
»t
 +ğ
	`‹¡0_1
 (
EMPTY_STRING
, 0, EMPTY_STRING);

454 
»t
 +ğ
	`‹¡0_1
 (
EMPTY_STRING
, 30, EMPTY_STRING);

455 
»t
 +ğ
	`‹¡0_1
 (
SHORT_STRING
, 0, SHORT_STRING);

456 
»t
 +ğ
	`‹¡0_1
 (
SHORT_STRING
, 30, SHORT_STRING);

457 
»t
 +ğ
	`‹¡0_1
 ( 
LONG_STRING
, 0, LONG_STRING);

458 
»t
 +ğ
	`‹¡0_1
 ( 
LONG_STRING
, 30, LONG_STRING);

459 
	`debug
 ("\t# fau»s: %d", 
»t
);

461  
»t
;

462 
	}
}

464 
	$‹¡1_0
 (cÚ¡ * 
blk
, 
Ën
, cÚ¡ * 
»s
) {

465 
b¡ršg
 
b0
 = 
	`blk2b¡r
 (
blk
, 
Ën
);

466 
»t
 = 0;

467 ià(
b0
 =ğ
NULL
) {

468 ià(
»s
 !ğ
NULL
è
»t
++;

469 
	`debug
 (".\tblk2b¡¸(NULL,†’=%dèğ%s", 
Ën
, 
	`dumpB¡ršg
 (
b0
));

471 
»t
 +ğ(
»s
 =ğ
NULL
è|| (
Ën
 !ğ
b0
->
¦’
)

472 || (0 !ğ
	`memcmp
 (
»s
, 
b0
->
d©a
, 
Ën
));

473 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

474 
	`debug
 (".\tblk2b¡¸(blk=%p,†’=%dèğ%s", 
blk
, 
Ën
, 
	`dumpB¡ršg
 (
b0
));

477 ià(
»t
) {

478 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

479 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

480 
	`debug
 (")");

482 
	`bde¡roy
 (
b0
);

483  
»t
;

484 
	}
}

486 
	$‹¡1
 () {

487 
»t
 = 0;

489 
	`debug
 ("TEST: bstring blk2bstr (const void * blk, int†en);");

492 
»t
 +ğ
	`‹¡1_0
 (
NULL
, 10, NULL);

493 
»t
 +ğ
	`‹¡1_0
 (
NULL
, 0, NULL);

494 
»t
 +ğ
	`‹¡1_0
 (
NULL
, -1, NULL);

497 
»t
 +ğ
	`‹¡1_0
 (
SHORT_STRING
,  (SHORT_STRING)-1, SHORT_STRING);

498 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
,  (LONG_STRING)-1, LONG_STRING);

499 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
, 5, "This ");

500 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
, 0, "");

501 
»t
 +ğ
	`‹¡1_0
 (
LONG_STRING
, -1, 
NULL
);

502 
	`debug
 ("\t# fau»s: %d", 
»t
);

503  
»t
;

504 
	}
}

506 
	$‹¡2_0
 (
cÚ¡_b¡ršg
 
b
, 
z
, cÚ¡ * 
»s
) {

507 * 
s
 = 
	`b¡r2c¡r
 (
b
, 
z
);

508 
»t
 = 0;

509 ià(
s
 =ğ
NULL
) {

510 ià(
»s
 !ğ
NULL
è
»t
++;

511 
	`debug
 (".\tb¡r2c¡¸(%s, %02XèğNULL", 
	`dumpB¡ršg
 (
b
), 
z
);

512 
	`bc¡rä“
(
s
);

513  
»t
;

516 ià(
»s
 =ğ
NULL
è
»t
++;

518 ià(
z
 !ğ'\0'èià((è
	`¡¾’
 (
s
è!ğ
b
->
¦’
è
»t
++;

519 ià(!
»t
) {

520 
»t
 +ğ(0 !ğ
	`memcmp
 (
»s
, 
b
->
d©a
, b->
¦’
));

524 
	`debug
 (".\tb¡r2c¡¸(%s, %02Xèğ\"%s\"", 
	`dumpB¡ršg
 (
b
), 
z
, 
s
);

525 
	`bc¡rä“
 (
s
);

526  
»t
;

527 
	}
}

529 
gb¡ršg
 
	gem±yB¡ršg
 = 
bsStic
 ("");

530 
gb¡ršg
 
	gshÜtB¡ršg
 = 
bsStic
 ("bogus");

531 
gb¡ršg
 
	glÚgB¡ršg
 = 
bsStic
 ("This is‡ bogus but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

533 
gb¡ršg
 
	gbadB¡ršg1
 = {8, 4, 
NULL
};

534 
gb¡ršg
 
	gbadB¡ršg2
 = {2, -5, (*) "bogus"};

535 
gb¡ršg
 
	gbadB¡ršg3
 = {2, 5, (*) "bogus"};

537 
gb¡ršg
 
	gxxxxxB¡ršg
 = 
bsStic
 ("xxxxx");

539 
	$‹¡2
 () {

540 
»t
 = 0;

542 
	`debug
 ("TEST: char * bstr2cstr (const_bstring s, char z);");

545 
»t
 +ğ
	`‹¡2_0
 (
NULL
, () '?', NULL);

548 
»t
 +ğ
	`‹¡2_0
 (&
em±yB¡ršg
, (è'?',ƒm±yB¡ršg.
d©a
);

549 
»t
 +ğ
	`‹¡2_0
 (&
shÜtB¡ršg
, (è'?', shÜtB¡ršg.
d©a
);

550 
»t
 +ğ
	`‹¡2_0
 (&
lÚgB¡ršg
, (è'?',†ÚgB¡ršg.
d©a
);

551 
»t
 +ğ
	`‹¡2_0
 (&
badB¡ršg1
, (è'?', 
NULL
);

552 
»t
 +ğ
	`‹¡2_0
 (&
badB¡ršg2
, (è'?', 
NULL
);

553 
	`debug
 ("\t# fau»s: %d", 
»t
);

554  
»t
;

555 
	}
}

557 
	$‹¡3_0
 (
cÚ¡_b¡ršg
 
b
) {

558 
b¡ršg
 
b0
 = 
	`b¡rıy
 (
b
);

559 
»t
 = 0;

560 
	`debug
 (".\tb¡rıy (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
b0
));

561 ià(
b0
 =ğ
NULL
) {

562 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >ğ0è
»t
++;

564 
»t
 +ğ(
b
 =ğ
NULL
è|| (b->
¦’
 !ğ
b0
->slen)

565 || (0 !ğ
	`memcmp
 (
b
->
d©a
, 
b0
->d©a, b->
¦’
));

566 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

568 
	`bde¡roy
 (
b0
);

569  
»t
;

570 
	}
}

572 
	$‹¡3
 () {

573 
»t
 = 0;

575 
	`debug
 ("TEST: bstring bstrcpy (const_bstring b1);");

578 
»t
 +ğ
	`‹¡3_0
 (
NULL
);

579 
»t
 +ğ
	`‹¡3_0
 (&
badB¡ršg1
);

580 
»t
 +ğ
	`‹¡3_0
 (&
badB¡ršg2
);

583 
»t
 +ğ
	`‹¡3_0
 (&
em±yB¡ršg
);

584 
»t
 +ğ
	`‹¡3_0
 (&
shÜtB¡ršg
);

585 
»t
 +ğ
	`‹¡3_0
 (&
lÚgB¡ršg
);

586 
	`debug
 ("\t# fau»s: %d", 
»t
);

587  
»t
;

588 
	}
}

590 
	$‹¡4_0
 (
cÚ¡_b¡ršg
 
b
, 
Ëá
, 
Ën
, cÚ¡ * 
»s
) {

591 
b¡ršg
 
b0
 = 
	`bmid¡r
 (
b
, 
Ëá
, 
Ën
);

592 
»t
 = 0;

593 
	`debug
 (".\tbmid¡¸(%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b
), 
Ëá
, 
Ën
, dumpB¡ršg (
b0
));

594 ià(
b0
 =ğ
NULL
) {

595 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >ğ0 && 
Ën
 >ğ0è
»t
++;

597 
»t
 +ğ(
b
 =ğ
NULL
è|| (
»s
 =ğNULLè|| (
b0
->
¦’
 > 
Ën
 &&†en >= 0)

598 || (
b0
->
¦’
 !ğ(è
	`¡¾’
 (
»s
))

599 || (
b0
->
¦’
 > 0 && 0 !ğ
	`memcmp
 (
»s
, b0->
d©a
, b0->slen));

600 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

602 ià(
»t
) {

603 
	`debug
 ("(b =ğNULLè = %d", (
b
 =ğ
NULL
));

604 
	`debug
 ("Ôe =ğNULLè = %d", (
»s
 =ğ
NULL
));

605 
	`debug
 ("(b0->¦’ >†’ &&†’ >ğ0èğ%d", (
b0
->
¦’
 > 
Ën
 &&†en >= 0));

606 ià(
»s
è
	`debug
 ("(b0->¦’ !ğ¡¾’ (»s)è = %d", (
b0
->
¦’
 !ğ(è
	`¡¾’
 (res)));

607 
	`debug
 ("(b0->¦’ > 0 && 0 !ğmemcm°Ôes, b0->d©a, b0->¦’èğ%d", (
b0
->
¦’
 > 0 && 0 !ğ
	`memcmp
 (
»s
, b0->
d©a
, b0->slen)));

609 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

610 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

611 
	`debug
 (")");

613 
	`bde¡roy
 (
b0
);

614  
»t
;

615 
	}
}

617 
	$‹¡4
 () {

618 
»t
 = 0;

620 
	`debug
 ("TEST: bstring bmidstr (const_bstring b, int†eft, int†en);");

623 
»t
 +ğ
	`‹¡4_0
 (
NULL
, 0, 0, NULL);

624 
»t
 +ğ
	`‹¡4_0
 (
NULL
, 0, 2, NULL);

625 
»t
 +ğ
	`‹¡4_0
 (
NULL
, 0, -2, NULL);

626 
»t
 +ğ
	`‹¡4_0
 (
NULL
, -5, 2, NULL);

627 
»t
 +ğ
	`‹¡4_0
 (
NULL
, -5, -2, NULL);

628 
»t
 +ğ
	`‹¡4_0
 (&
badB¡ršg1
, 1, 3, 
NULL
);

629 
»t
 +ğ
	`‹¡4_0
 (&
badB¡ršg2
, 1, 3, 
NULL
);

632 
»t
 +ğ
	`‹¡4_0
 (&
em±yB¡ršg
, 0, 0, "");

633 
»t
 +ğ
	`‹¡4_0
 (&
em±yB¡ršg
, 0, -1, "");

634 
»t
 +ğ
	`‹¡4_0
 (&
em±yB¡ršg
, 1, 3, "");

635 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 0, 0, "");

636 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 0, -1, "");

637 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 1, 3, "ogu");

638 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, -1, 3, "bo");

639 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, -1, 9, "bogus");

640 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 3, -1, "");

641 
»t
 +ğ
	`‹¡4_0
 (&
shÜtB¡ršg
, 9, 3, "");

642 
	`debug
 ("\t# fau»s: %d", 
»t
);

643  
»t
;

644 
	}
}

646 
	$‹¡5_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
, cÚ¡ * 
»s
) {

647 
b¡ršg
 
b2
;

648 
rv
, 
»t
 = 0;

650 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

651 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0 ) {

652 
b2
 = 
	`b¡rıy
 (
b0
);

653 
	`bwr™•rÙeù
 (*
b2
);

655 
	`debug
 (".\tbcÚÿˆ(%s, ", 
	`dumpB¡ršg
 (
b2
));

657 
rv
 = 
	`bcÚÿt
 (
b2
, 
b1
);

658 
»t
 +ğ(
rv
 == 0);

659 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

661 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

663 
	`bwr™—Îow
 (*
b2
);

665 
	`debug
 (".\tbcÚÿˆ(%s, ", 
	`dumpB¡ršg
 (
b2
));

667 
rv
 = 
	`bcÚÿt
 (
b2
, 
b1
);

669 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

671 ià(
b1
è
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen + b1->slen);

672 
»t
 +ğ((0 !ğ
rv
è&& (
b1
 !ğ
NULL
)) || ((0 ==„v) && (b1 == NULL));

673 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

674 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

675 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

676 
	`bde¡roy
 (
b2
);

678 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bcÚÿt
 (
b0
, 
b1
)));

679 
	`debug
 (".\tbcÚÿˆ(%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

682 ià(
»t
) {

683 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

684 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

685 
	`debug
 (")");

687  
»t
;

688 
	}
}

690 
	$‹¡5_1
 () {

691 
b¡ršg
 
b
, 
c
;

692 
gb¡ršg
 
t
;

693 
i
, 
»t
;

695 
	`debug
 ("TEST: bconcat‡liasing");

696 
»t
=
i
=0; i < 
lÚgB¡ršg
.
¦’
; i++) {

697 
b
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

698 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

699 
	`bmid2tb¡r
 (
t
, 
b
, 
i
, 
lÚgB¡ršg
.
¦’
);

700 
»t
 +ğ0 !ğ
	`bcÚÿt
 (
c
, &
t
);

701 
»t
 +ğ0 !ğ
	`bcÚÿt
 (
b
, &
t
);

702 
»t
 +ğ!
	`bi£q
 (
b
, 
c
);

703 
	`bde¡roy
 (
b
);

704 
	`bde¡roy
 (
c
);

707 
b
 = 
	`bäomc¡r
 ("abcd");

708 
c
 = 
	`bäomc¡r
 ("abcd");

710 
»t
=
i
=0; i < 100; i++) {

711 
	`bmid2tb¡r
 (
t
, 
b
, 0, 3);

712 
»t
 +ğ0 !ğ
	`bÿtc¡r
 (
c
, "abc");

713 
»t
 +ğ0 !ğ
	`bcÚÿt
 (
b
, &
t
);

714 
»t
 +ğ!
	`bi£q
 (
b
, 
c
);

717 
	`bde¡roy
 (
b
);

718 
	`bde¡roy
 (
c
);

720 ià(
»t
) {

721 
	`debug
 ("\t\lŸ çu»s(%dèğ%d", 
__LINE__
, 
»t
);

724  
»t
;

725 
	}
}

727 
	$‹¡5
 () {

728 
»t
 = 0;

730 
	`debug
 ("TEST: int bconcat (bstring b0, const_bstring b1);");

733 
»t
 +ğ
	`‹¡5_0
 (
NULL
, NULL, NULL);

734 
»t
 +ğ
	`‹¡5_0
 (
NULL
, &
em±yB¡ršg
, NULL);

735 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, 
NULL
, "");

736 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
NULL
);

737 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 
NULL
);

738 
»t
 +ğ
	`‹¡5_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
NULL
);

739 
»t
 +ğ
	`‹¡5_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 
NULL
);

742 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &emptyBstring, "");

743 
»t
 +ğ
	`‹¡5_0
 (&
em±yB¡ršg
, &
shÜtB¡ršg
, "bogus");

744 
»t
 +ğ
	`‹¡5_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, "bogus");

745 
»t
 +ğ
	`‹¡5_0
 (&
shÜtB¡ršg
, &shortBstring, "bogusbogus");

747 
»t
 +ğ
	`‹¡5_1
 ();

749 
	`debug
 ("\t# fau»s: %d", 
»t
);

750  
»t
;

751 
	}
}

753 
	$‹¡6_0
 (
b¡ršg
 
b
, 
c
, cÚ¡ * 
»s
) {

754 
b¡ršg
 
b0
;

755 
rv
, 
»t
 = 0;

757 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

758 
b0
 = 
	`b¡rıy
 (
b
);

759 
	`bwr™•rÙeù
 (*
b0
);

760 
rv
 = 
	`bcÚch¬
 (
b0
, 
c
);

761 
»t
 +ğ(
rv
 == 0);

762 ià(!
	`bi£q
 (
b0
, 
b
)è
»t
++;

764 
	`debug
 (".\tbcÚch¬ (%s, %cèğ%s", 
	`dumpB¡ršg
 (
b
), 
c
, dumpB¡ršg (
b0
));

766 
	`bwr™—Îow
 (*
b0
);

767 
rv
 = 
	`bcÚch¬
 (
b0
, 
c
);

768 
»t
 +ğ(0 !ğ
rv
);

769 
»t
 +ğ(
b0
->
¦’
 !ğ
b
->slen + 1);

770 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b0
->
¦’
)

771 || (0 !ğ
	`memcmp
 (
b0
->
d©a
, 
»s
, b0->
¦’
));

772 
»t
 +ğ
b0
->
d©a
[b0->
¦’
] != '\0';

773 
	`debug
 (".\tbcÚch¬ (%s, %cèğ%s", 
	`dumpB¡ršg
 (
b
), 
c
, dumpB¡ršg (
b0
));

775 
	`bde¡roy
 (
b0
);

777 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bcÚch¬
 (
b
, 
c
)));

778 
	`debug
 (".\tbcÚch¬ (%s, %cèğ%d", 
	`dumpB¡ršg
 (
b
), 
c
, 
rv
);

781 ià(
»t
) {

782 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

783 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

784 
	`debug
 (")");

786  
»t
;

787 
	}
}

789 
	$‹¡6
 () {

790 
»t
 = 0;

792 
	`debug
 ("TEST: int bconchar (bstring b, char c);");

795 
»t
 +ğ
	`‹¡6_0
 (
NULL
, () 'x', NULL);

796 
»t
 +ğ
	`‹¡6_0
 (&
badB¡ršg1
, (è'x', 
NULL
);

797 
»t
 +ğ
	`‹¡6_0
 (&
badB¡ršg2
, (è'x', 
NULL
);

800 
»t
 +ğ
	`‹¡6_0
 (&
em±yB¡ršg
, () 'x', "x");

801 
»t
 +ğ
	`‹¡6_0
 (&
shÜtB¡ršg
, () 'x', "bogusx");

802 
	`debug
 ("\t# fau»s: %d", 
»t
);

803  
»t
;

804 
	}
}

806 
‹¡7x8_0
 (* 
âÇme
, (* 
â±r
è(cÚ¡ 
gb¡ršg
 *, cÚ¡ gb¡ršg *), cÚ¡ gb¡ršg * 
b0
, cÚ¡ gb¡ršg * 
b1
, 
»s
) {

807 
rv
, 
»t
 = 0;

809 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`â±r
 (
b0
, 
b1
)));

810 
	`debug
 (".\t% (%s, %sèğ%d", 
âÇme
, 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

811 ià(
»t
) {

812 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

814  
»t
;

815 
	}
}

817 
‹¡7x8
 (* 
âÇme
, (* 
â±r
è(cÚ¡ 
gb¡ršg
 *, const tagbstring *),

818 
»tFa
, 
»tLT
, 
»tGT
, 
»tEQ
) {

819 
»t
 = 0;

821 
	`debug
 ("TEST: iÁ % (cÚ¡_b¡ršg b0, cÚ¡_b¡ršg b1);", 
âÇme
);

824 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
NULL
, NULL, 
»tFa
);

825 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
em±yB¡ršg
, 
NULL
, 
»tFa
);

826 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
NULL
, &
em±yB¡ršg
, 
»tFa
);

827 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, 
NULL
, 
»tFa
);

828 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
NULL
, &
shÜtB¡ršg
, 
»tFa
);

829 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
badB¡ršg1
, &badB¡ršg1, 
»tFa
);

830 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
badB¡ršg2
, &badB¡ršg2, 
»tFa
);

831 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
badB¡ršg2
, 
»tFa
);

832 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
badB¡ršg2
, &
shÜtB¡ršg
, 
»tFa
);

835 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
em±yB¡ršg
, &em±yB¡ršg, 
»tEQ
);

836 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
em±yB¡ršg
, 
»tGT
);

837 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
em±yB¡ršg
, &
shÜtB¡ršg
, 
»tLT
);

838 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &shÜtB¡ršg, 
»tEQ
);

841 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

842 
b
->
d©a
[1]++;

843 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, 
b
, &
shÜtB¡ršg
, 
»tGT
);

844 
	`bde¡roy
 (
b
);

847 ià(
â±r
 =ğ
bi£q
) {

848 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
lÚgB¡ršg
, 
»tGT
);

849 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
lÚgB¡ršg
, &
shÜtB¡ršg
, 
»tLT
);

851 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
shÜtB¡ršg
, &
lÚgB¡ršg
, 'b'-'T');

852 
»t
 +ğ
	`‹¡7x8_0
 (
âÇme
, 
â±r
, &
lÚgB¡ršg
, &
shÜtB¡ršg
, 'T'-'b');

855 
	`debug
 ("\t# fau»s: %d", 
»t
);

856  
»t
;

857 
	}
}

859 
	#‹¡7
(è
	`‹¡7x8
 ("bi£q", 
bi£q
, -1, 0, 0, 1)

	)

860 
	#‹¡8
(è
	`‹¡7x8
 ("b¡rcmp", 
b¡rcmp
, 
SHRT_MIN
, -1, 1, 0)

	)

862 
	$‹¡9_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
, 
»s
) {

863 
rv
, 
»t
 = 0;

865 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`b¡ºcmp
 (
b0
, 
b1
, 
n
)));

866 
	`debug
 (".\tb¡ºcm°(%s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
n
, 
rv
);

867 ià(
»t
) {

868 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

870  
»t
;

871 
	}
}

873 
	$‹¡9
 () {

874 
»t
 = 0;

876 
	`debug
 ("TEST: int bstrncmp (const_bstring b0, const_bstring b1, int‚);");

879 
»t
 +ğ
	`‹¡9_0
 (
NULL
, NULL, 0, 
SHRT_MIN
);

880 
»t
 +ğ
	`‹¡9_0
 (
NULL
, NULL, -1, 
SHRT_MIN
);

881 
»t
 +ğ
	`‹¡9_0
 (
NULL
, NULL, 1, 
SHRT_MIN
);

882 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, 
NULL
, 0, 
SHRT_MIN
);

883 
»t
 +ğ
	`‹¡9_0
 (
NULL
, &
em±yB¡ršg
, 0, 
SHRT_MIN
);

884 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, 
NULL
, 1, 
SHRT_MIN
);

885 
»t
 +ğ
	`‹¡9_0
 (
NULL
, &
em±yB¡ršg
, 1, 
SHRT_MIN
);

886 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg1
, &badB¡ršg1, 1, 
SHRT_MIN
);

887 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg2
, &badB¡ršg2, 1, 
SHRT_MIN
);

888 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 1, 
SHRT_MIN
);

889 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 1, 
SHRT_MIN
);

890 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 1, 
SHRT_MIN
);

891 
»t
 +ğ
	`‹¡9_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 1, 
SHRT_MIN
);

894 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &emptyBstring, -1, 0);

895 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &emptyBstring, 0, 0);

896 
»t
 +ğ
	`‹¡9_0
 (&
em±yB¡ršg
, &emptyBstring, 1, 0);

897 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, -1, 0);

898 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, 0, 0);

899 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, 1, 0);

900 
»t
 +ğ
	`‹¡9_0
 (&
shÜtB¡ršg
, &shortBstring, 9, 0);

901 
	`debug
 ("\t# fau»s: %d", 
»t
);

902  
»t
;

903 
	}
}

905 
	$‹¡10_0
 (
b¡ršg
 
b
, 
»s
, 
nochªge
) {

906 
gb¡ršg
 
sb
 = 
	`bsStic
 ("<NULL>");

907 
rv
, 
x
, 
»t
 = 0;

909 ià(
b
è
sb
 = *b;

910 
	`debug
 (".\tbde¡roy (%sèğ", 
	`dumpB¡ršg
 (
b
));

911 
rv
 = 
	`bde¡roy
 (
b
);

912 
	`debug
 ("%d", 
rv
);

914 ià(
b
 !ğ
NULL
) {

915 ià(
rv
 >= 0)

918 
x
 = 1;

920 
x
 = 
	`memcmp
 (&
sb
, 
b
,  sb);

921 } 
x
 = !
nochªge
;

922 
»t
 +ğ(
rv
 !ğ
»s
);

923 
»t
 +ğ(!
nochªge
è=ğ(!
x
);

924 ià(
»t
) {

925 
	`debug
 ("\t\tçu»(%dè» ğ%d‚ochªgğ%d, x = %d, sb.¦’ = %d, sb.mËÀğ%d, sb.d©¨ğ%p", 
__LINE__
, 
»s
, 
nochªge
, 
x
, 
sb
.
¦’
, sb.
mËn
, sb.
d©a
);

927  
»t
;

928 
	}
}

930 
	$‹¡10
 () {

931 
b¡ršg
 
c
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

932 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
em±yB¡ršg
);

933 
»t
 = 0;

935 
	`debug
 ("TEST: int bdestroy (const_bstring b);");

937 
»t
 +ğ
	`‹¡10_0
 (
NULL
, 
BSTR_ERR
, 1);

940 
	`bwr™•rÙeù
 (*
b
);

941 
	`bwr™•rÙeù
 (*
c
);

942 
»t
 +ğ
	`‹¡10_0
 (
b
, 
BSTR_ERR
, 1);

943 
»t
 +ğ
	`‹¡10_0
 (
c
, 
BSTR_ERR
, 1);

944 
	`bwr™—Îow
 (*
b
);

945 
	`bwr™—Îow
 (*
c
);

946 
»t
 +ğ
	`‹¡10_0
 (
b
, 
BSTR_OK
, 0);

947 
»t
 +ğ
	`‹¡10_0
 (
c
, 
BSTR_OK
, 0);

948 
»t
 +ğ
	`‹¡10_0
 (&
em±yB¡ršg
, 
BSTR_ERR
, 1);

949 
	`bwr™—Îow
 (
em±yB¡ršg
);

950 
»t
 +ğ
	`‹¡10_0
 (&
em±yB¡ršg
, 
BSTR_ERR
, 1);

951 
»t
 +ğ
	`‹¡10_0
 (&
shÜtB¡ršg
, 
BSTR_ERR
, 1);

952 
	`bwr™—Îow
 (
em±yB¡ršg
);

953 
»t
 +ğ
	`‹¡10_0
 (&
shÜtB¡ršg
, 
BSTR_ERR
, 1);

954 
»t
 +ğ
	`‹¡10_0
 (&
badB¡ršg1
, 
BSTR_ERR
, 1);

955 
»t
 +ğ
	`‹¡10_0
 (&
badB¡ršg2
, 
BSTR_ERR
, 1);

957 
	`debug
 ("\t# fau»s: %d", 
»t
);

958  
»t
;

959 
	}
}

961 
	$‹¡11_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

962 
rv
, 
»t
 = 0;

964 
	`debug
 (".\tbš¡¸(%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

965 
rv
 = 
	`bš¡r
 (
s1
, 
pos
, 
s2
);

966 
	`debug
 ("%d", 
rv
);

967 
»t
 +ğ(
rv
 !ğ
»s
);

968 ià(
»t
) {

969 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

971  
»t
;

972 
	}
}

974 
	$‹¡11_1
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

975 
rv
, 
»t
 = 0;

977 
	`debug
 (".\tbš¡rÿ£Ës (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

978 
rv
 = 
	`bš¡rÿ£Ëss
 (
s1
, 
pos
, 
s2
);

979 
	`debug
 ("%d", 
rv
);

980 
»t
 +ğ(
rv
 !ğ
»s
);

981 ià(
»t
) {

982 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

984  
»t
;

985 
	}
}

987 
	$‹¡11
 () {

988 
b¡ršg
 
b
, 
c
;

989 
»t
 = 0;

991 
	`debug
 ("TEST: int binstr (const_bstring s1, int…os, const_bstring s2);");

992 
»t
 +ğ
	`‹¡11_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

993 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

994 
»t
 +ğ
	`‹¡11_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

995 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

996 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

997 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

998 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

999 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1000 
»t
 +ğ
	`‹¡11_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1002 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1003 
»t
 +ğ
	`‹¡11_0
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1004 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 1, &shÜtB¡ršg, 
BSTR_ERR
);

1005 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1006 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1007 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1008 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1009 
	`bde¡roy
 (
b
);

1010 
»t
 +ğ
	`‹¡11_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 
BSTR_ERR
);

1011 
	`bde¡roy
 (
b
);

1012 
»t
 +ğ
	`‹¡11_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 10);

1013 
»t
 +ğ
	`‹¡11_0
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 
BSTR_ERR
);

1015 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 0, 
b
 = bfromcstr ("sap"), 8);

1016 
	`bde¡roy
 (
c
);

1017 
	`bde¡roy
 (
b
);

1018 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 3, 
b
 = bfromcstr ("sap"), 8);

1019 
	`bde¡roy
 (
c
);

1020 
	`bde¡roy
 (
b
);

1021 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("sssssssss§p"), 3, 
b
 = bfromcstr ("sap"), 9);

1022 
	`bde¡roy
 (
c
);

1023 
	`bde¡roy
 (
b
);

1024 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 0, 
b
 = bfromcstr ("s"), 0);

1025 
	`bde¡roy
 (
c
);

1026 
	`bde¡roy
 (
b
);

1027 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 3, 
b
 = bfromcstr ("s"), 3);

1028 
	`bde¡roy
 (
c
);

1029 
	`bde¡roy
 (
b
);

1030 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 0, 
b
 = bfromcstr ("a"), 9);

1031 
	`bde¡roy
 (
c
);

1032 
	`bde¡roy
 (
b
);

1033 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("ssssssss§p"), 5, 
b
 = bfromcstr ("a"), 9);

1034 
	`bde¡roy
 (
c
);

1035 
	`bde¡roy
 (
b
);

1036 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("§§§§§p"), 0, 
b
 = bfromcstr ("sap"), 8);

1037 
	`bde¡roy
 (
c
);

1038 
	`bde¡roy
 (
b
);

1039 
»t
 +ğ
	`‹¡11_0
 (
c
 = 
	`bäomc¡r
 ("s§§§§§p"), 0, 
b
 = bfromcstr ("sap"), 9);

1040 
	`bde¡roy
 (
c
);

1041 
	`bde¡roy
 (
b
);

1043 
	`debug
 ("TEST: int binstrcaseless (const_bstring s1, int…os, const_bstring s2);");

1044 
»t
 +ğ
	`‹¡11_1
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1045 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1046 
»t
 +ğ
	`‹¡11_1
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1047 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1048 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1049 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1050 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1051 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1052 
»t
 +ğ
	`‹¡11_1
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1054 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1055 
»t
 +ğ
	`‹¡11_1
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1056 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 1, &shÜtB¡ršg, 
BSTR_ERR
);

1057 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1058 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1059 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1060 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1061 
	`bde¡roy
 (
b
);

1062 
»t
 +ğ
	`‹¡11_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 0);

1063 
	`bde¡roy
 (
b
);

1064 
»t
 +ğ
	`‹¡11_1
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 10);

1065 
»t
 +ğ
	`‹¡11_1
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 
BSTR_ERR
);

1067 
	`debug
 ("\t# fau»s: %d", 
»t
);

1068  
»t
;

1069 
	}
}

1071 
	$‹¡12_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1072 
rv
, 
»t
 = 0;

1074 
	`debug
 (".\tbš¡¼ (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1075 
rv
 = 
	`bš¡¼
 (
s1
, 
pos
, 
s2
);

1076 
	`debug
 ("%d", 
rv
);

1077 
»t
 +ğ(
rv
 !ğ
»s
);

1078 ià(
»t
) {

1079 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1081  
»t
;

1082 
	}
}

1084 
	$‹¡12_1
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1085 
rv
, 
»t
 = 0;

1087 
	`debug
 (".\tbš¡¼ÿ£Ës (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1088 
rv
 = 
	`bš¡¼ÿ£Ëss
 (
s1
, 
pos
, 
s2
);

1089 
	`debug
 ("%d", 
rv
);

1090 
»t
 +ğ(
rv
 !ğ
»s
);

1091 ià(
»t
) {

1092 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1094  
»t
;

1095 
	}
}

1097 
	$‹¡12
 () {

1098 
b¡ršg
 
b
;

1099 
»t
 = 0;

1101 
	`debug
 ("TEST: int binstrr (const_bstring s1, int…os, const_bstring s2);");

1102 
»t
 +ğ
	`‹¡12_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1103 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1104 
»t
 +ğ
	`‹¡12_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1105 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1106 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1107 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1108 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1109 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1110 
»t
 +ğ
	`‹¡12_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1112 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1113 
»t
 +ğ
	`‹¡12_0
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1114 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 1, &shortBstring, 0);

1115 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1116 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1117 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1118 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1119 
	`bde¡roy
 (
b
);

1120 
»t
 +ğ
	`‹¡12_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 
BSTR_ERR
);

1121 
	`bde¡roy
 (
b
);

1122 
»t
 +ğ
	`‹¡12_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1123 
»t
 +ğ
	`‹¡12_0
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 10);

1125 
	`debug
 ("TEST: int binstrrcaseless (const_bstring s1, int…os, const_bstring s2);");

1126 
»t
 +ğ
	`‹¡12_1
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1127 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1128 
»t
 +ğ
	`‹¡12_1
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1129 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1130 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1131 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1132 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1133 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1134 
»t
 +ğ
	`‹¡12_1
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1136 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 0, &emptyBstring, 0);

1137 
»t
 +ğ
	`‹¡12_1
 (&
em±yB¡ršg
, 1, &em±yB¡ršg, 
BSTR_ERR
);

1138 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 1, &shortBstring, 0);

1139 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 5, &
em±yB¡ršg
, 5);

1140 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1141 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1142 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1143 
	`bde¡roy
 (
b
);

1144 
»t
 +ğ
	`‹¡12_1
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`bäomc¡r
 ("BOGUS"), 0);

1145 
	`bde¡roy
 (
b
);

1146 
»t
 +ğ
	`‹¡12_1
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1147 
»t
 +ğ
	`‹¡12_1
 (&
lÚgB¡ršg
, 20, &
shÜtB¡ršg
, 10);

1149 
	`debug
 ("\t# fau»s: %d", 
»t
);

1150  
»t
;

1151 
	}
}

1153 
	$‹¡13_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1154 
rv
, 
»t
 = 0;

1156 
	`debug
 (".\tbšch¸(%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1157 
rv
 = 
	`bšchr
 (
s1
, 
pos
, 
s2
);

1158 
	`debug
 ("%d", 
rv
);

1159 
»t
 +ğ(
rv
 !ğ
»s
);

1160 ià(
»t
) {

1161 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1163  
»t
;

1164 
	}
}

1166 
	$‹¡13
 () {

1167 
b¡ršg
 
b
;

1168 
»t
 = 0;

1169 
gb¡ršg
 
muÉËOs
 = 
	`bsStic
 ("ooooo");

1171 
	`debug
 ("TEST: int binchr (const_bstring s1, int…os, const_bstring s2);");

1172 
»t
 +ğ
	`‹¡13_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1173 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1174 
»t
 +ğ
	`‹¡13_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1175 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1176 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1177 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1178 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1179 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1180 
»t
 +ğ
	`‹¡13_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1182 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

1183 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1184 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1185 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, &
muÉËOs
, 1);

1186 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1187 
	`bde¡roy
 (
b
);

1188 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1189 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 10, &shÜtB¡ršg, 
BSTR_ERR
);

1190 
»t
 +ğ
	`‹¡13_0
 (&
shÜtB¡ršg
, 1, &shortBstring, 1);

1191 
»t
 +ğ
	`‹¡13_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1192 
»t
 +ğ
	`‹¡13_0
 (&
xxxxxB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1193 
»t
 +ğ
	`‹¡13_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 3);

1194 
»t
 +ğ
	`‹¡13_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 10);

1195 
	`debug
 ("\t# fau»s: %d", 
»t
);

1196  
»t
;

1197 
	}
}

1199 
	$‹¡14_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

1200 
rv
, 
»t
 = 0;

1202 
	`debug
 (".\tbšch¼ (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

1203 
rv
 = 
	`bšch¼
 (
s1
, 
pos
, 
s2
);

1204 
	`debug
 ("%d", 
rv
);

1205 
»t
 +ğ(
rv
 !ğ
»s
);

1206 ià(
»t
) {

1207 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1209  
»t
;

1210 
	}
}

1212 
	$‹¡14
 () {

1213 
b¡ršg
 
b
;

1214 
»t
 = 0;

1216 
	`debug
 ("TEST: int binchrr (const_bstring s1, int…os, const_bstring s2);");

1217 
»t
 +ğ
	`‹¡14_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1218 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

1219 
»t
 +ğ
	`‹¡14_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1220 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

1221 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1222 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1223 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1224 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1225 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

1226 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg2
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

1227 
»t
 +ğ
	`‹¡14_0
 (&
badB¡ršg1
, 0, &
badB¡ršg2
, 
BSTR_ERR
);

1229 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 0, &shortBstring, 0);

1230 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 0, 
b
 = 
	`b¡rıy
 (&shortBstring), 0);

1231 
	`bde¡roy
 (
b
);

1232 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, -1, &shÜtB¡ršg, 
BSTR_ERR
);

1233 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 5, &shortBstring, 4);

1234 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 4, &shortBstring, 4);

1235 
»t
 +ğ
	`‹¡14_0
 (&
shÜtB¡ršg
, 1, &shortBstring, 1);

1236 
»t
 +ğ
	`‹¡14_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1237 
»t
 +ğ
	`‹¡14_0
 (&
xxxxxB¡ršg
, 4, &
shÜtB¡ršg
, 
BSTR_ERR
);

1238 
»t
 +ğ
	`‹¡14_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

1239 
»t
 +ğ
	`‹¡14_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 10);

1240 
	`debug
 ("\t# fau»s: %d", 
»t
);

1241  
»t
;

1242 
	}
}

1244 
	$‹¡15_0
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
, * 
»s
) {

1245 
b¡ršg
 
b2
;

1246 
rv
, 
»t
 = 0, 
lš’um
 = 0;

1248 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

1249 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

1250 
b2
 = 
	`b¡rıy
 (
b0
);

1251 
	`bwr™•rÙeù
 (*
b2
);

1253 
	`debug
 (".\tb£t¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

1255 
rv
 = 
	`b£t¡r
 (
b2
, 
pos
, 
b1
, 
fl
);

1256 
»t
 +ğ(
rv
 =ğ0); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1257 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++; iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1259 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1261 
	`bwr™—Îow
 (*
b2
);

1263 
	`debug
 (".\tb£t¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

1265 
rv
 = 
	`b£t¡r
 (
b2
, 
pos
, 
b1
, 
fl
);

1266 ià(
b1
) {

1267 
»t
 +ğ(
pos
 >ğ0è&& (
b2
->
¦’
 !ğ
b0
->¦’ + 
b1
->¦’è&& (b2->¦’ !ğpo + b1->¦’); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1268 
»t
 +ğ(
pos
 < 0è&& (
b2
->
¦’
 !ğ
b0
->¦’); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1271 
»t
 +ğ((
rv
 =ğ0è!ğ(
pos
 >ğ0)); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1272 
»t
 +ğ(
»s
 =ğ
NULL
); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1273 
»t
 +ğ((è
	`¡¾’
 (
»s
è> 
b2
->
¦’
); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1274 
»t
 +ğ(0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
)); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1275 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] !ğ'\0'; iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1277 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1279 
	`bde¡roy
 (
b2
);

1281 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`b£t¡r
 (
b0
, 
pos
, 
b1
, 
fl
))); iàÔ‘ && 0 =ğ
lš’um
èlš’um = 
__LINE__
;

1282 
	`debug
 (".\tb£t¡¸(%s, %d, %s, %02Xèğ%d", 
	`dumpB¡ršg
 (
b0
), 
pos
, dumpB¡ršg (
b1
), 
fl
, 
rv
);

1285 ià(
»t
) {

1286 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
lš’um
, 
»t
, 
»s
);

1287 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1288 
	`debug
 (")");

1290  
»t
;

1291 
	}
}

1293 
	$‹¡15
 () {

1294 
»t
 = 0;

1295 
	`debug
 ("TEST: int bsetstr (bstring b0, int…os, const_bstring b1, unsigned char fill);");

1297 
»t
 +ğ
	`‹¡15_0
 (
NULL
, 0, NULL, () '?', NULL);

1298 
»t
 +ğ
	`‹¡15_0
 (
NULL
, 0, &
em±yB¡ršg
, () '?', NULL);

1299 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg1
, 0, 
NULL
, () '?', NULL);

1300 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg1
, 0, &badB¡ršg1, (è'?', 
NULL
);

1301 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, (è'?', 
NULL
);

1302 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1303 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg2
, 0, 
NULL
, () '?', NULL);

1304 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg2
, 0, &badB¡ršg2, (è'?', 
NULL
);

1305 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, (è'?', 
NULL
);

1306 
»t
 +ğ
	`‹¡15_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1309 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &emptyBstring, () '?', "");

1310 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 5, &emptyBstring, () '?', "?????");

1311 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 5, &
shÜtB¡ršg
, () '?', "?????bogus");

1312 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, () '?', "bogus");

1313 
»t
 +ğ
	`‹¡15_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, () '?', "bogus");

1314 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 0, &shortBstring, () '?', "bogus");

1315 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, -1, &shortBstring, () '?', "bogus");

1316 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 2, &shortBstring, () '?', "bobogus");

1317 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 6, &shortBstring, () '?', "bogus?bogus");

1318 
»t
 +ğ
	`‹¡15_0
 (&
shÜtB¡ršg
, 6, 
NULL
, () '?', "bogus?");

1319 
	`debug
 ("\t# fau»s: %d", 
»t
);

1320  
»t
;

1321 
	}
}

1323 
	$‹¡16_0
 (
b¡ršg
 
b0
, 
pos
, 
cÚ¡_b¡ršg
 
b1
, 
fl
, * 
»s
) {

1324 
b¡ršg
 
b2
;

1325 
rv
, 
»t
 = 0;

1327 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

1328 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

1329 
b2
 = 
	`b¡rıy
 (
b0
);

1330 
	`bwr™•rÙeù
 (*
b2
);

1332 
	`debug
 (".\tbš£¹ (%s, ", 
	`dumpB¡ršg
 (
b2
));

1334 
rv
 = 
	`bš£¹
 (
b2
, 
pos
, 
b1
, 
fl
);

1335 
»t
 +ğ(
rv
 == 0);

1336 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

1338 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1340 
	`bwr™—Îow
 (*
b2
);

1342 
	`debug
 (".\tbš£¹ (%s, ", 
	`dumpB¡ršg
 (
b2
));

1344 
rv
 = 
	`bš£¹
 (
b2
, 
pos
, 
b1
, 
fl
);

1345 ià(
b1
) {

1346 
»t
 +ğ(
pos
 >ğ0è&& (
b2
->
¦’
 !ğ
b0
->¦’ + 
b1
->slen) && (b2->slen !=…os + b1->slen);

1347 
»t
 +ğ(
pos
 < 0è&& (
b2
->
¦’
 !ğ
b0
->slen);

1348 
»t
 +ğ((
rv
 =ğ0è!ğ(
pos
 >ğ0 &&…o <ğ
b2
->
¦’
));

1351 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

1352 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

1353 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

1355 
	`debug
 ("%d, %s, %02Xèğ%s", 
pos
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

1357 
	`bde¡roy
 (
b2
);

1359 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bš£¹
 (
b0
, 
pos
, 
b1
, 
fl
)));

1360 
	`debug
 (".\tbš£¹ (%s, %d, %s, %02Xèğ%d", 
	`dumpB¡ršg
 (
b0
), 
pos
, dumpB¡ršg (
b1
), 
fl
, 
rv
);

1363 ià(
»t
) {

1364 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

1365 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1366 
	`debug
 (")");

1368  
»t
;

1369 
	}
}

1371 
	$‹¡16
 () {

1372 
»t
 = 0;

1373 
	`debug
 ("TEST: int binsert (bstring b0, int…os, const_bstring b1, unsigned char fill);");

1375 
»t
 +ğ
	`‹¡16_0
 (
NULL
, 0, NULL, () '?', NULL);

1376 
»t
 +ğ
	`‹¡16_0
 (
NULL
, 0, &
em±yB¡ršg
, () '?', NULL);

1377 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg1
, 0, 
NULL
, () '?', NULL);

1378 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg1
, 0, &badB¡ršg1, (è'?', 
NULL
);

1379 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg1
, (è'?', 
NULL
);

1380 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg1
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1381 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg2
, 0, 
NULL
, () '?', NULL);

1382 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg2
, 0, &badB¡ršg2, (è'?', 
NULL
);

1383 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &
badB¡ršg2
, (è'?', 
NULL
);

1384 
»t
 +ğ
	`‹¡16_0
 (&
badB¡ršg2
, 0, &
em±yB¡ršg
, (è'?', 
NULL
);

1387 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &emptyBstring, () '?', "");

1388 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 5, &emptyBstring, () '?', "?????");

1389 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 5, &
shÜtB¡ršg
, () '?', "?????bogus");

1390 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, () '?', "bogus");

1391 
»t
 +ğ
	`‹¡16_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, () '?', "bogus");

1392 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 0, &shortBstring, () '?', "bogusbogus");

1393 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, -1, &shortBstring, () '?', "bogus");

1394 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 2, &shortBstring, () '?', "bobogusgus");

1395 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 6, &shortBstring, () '?', "bogus?bogus");

1396 
»t
 +ğ
	`‹¡16_0
 (&
shÜtB¡ršg
, 6, 
NULL
, () '?', "bogus");

1397 
	`debug
 ("\t# fau»s: %d", 
»t
);

1398  
»t
;

1399 
	}
}

1401 
	$‹¡17_0
 (
b¡ršg
 
s1
, 
pos
, 
Ën
, * 
»s
) {

1402 
b¡ršg
 
b2
;

1403 
rv
, 
»t
 = 0;

1405 ià(
s1
 !ğ
NULL
 && s1->
d©a
 !ğNULL && s1->
¦’
 >= 0) {

1406 
b2
 = 
	`b¡rıy
 (
s1
);

1407 
	`bwr™•rÙeù
 (*
b2
);

1409 
	`debug
 (".\tbd–‘(%s, ", 
	`dumpB¡ršg
 (
b2
));

1411 
rv
 = 
	`bd–‘e
 (
b2
, 
pos
, 
Ën
);

1412 
»t
 +ğ(
rv
 == 0);

1413 ià(!
	`bi£q
 (
s1
, 
b2
)è
»t
++;

1415 
	`debug
 ("%d, %dèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b2
));

1417 
	`bwr™—Îow
 (*
b2
);

1419 
	`debug
 (".\tbd–‘(%s, ", 
	`dumpB¡ršg
 (
b2
));

1421 
rv
 = 
	`bd–‘e
 (
b2
, 
pos
, 
Ën
);

1422 
»t
 +ğ(
Ën
 >ğ0è!ğ(
rv
 == 0);

1423 
»t
 +ğ(
b2
->
¦’
 > 
s1
->¦’è|| (b2->¦’ < 
pos
 && s1->slen >=…os);

1425 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

1426 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

1427 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

1429 
	`debug
 ("%d, %dèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b2
));

1431 
	`bde¡roy
 (
b2
);

1433 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bd–‘e
 (
s1
, 
pos
, 
Ën
)));

1434 
	`debug
 (".\tbd–‘(%s, %d, %dèğ%d", 
	`dumpB¡ršg
 (
s1
), 
pos
, 
Ën
, 
rv
);

1437 ià(
»t
) {

1438 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

1439 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1440 
	`debug
 (")");

1442  
»t
;

1443 
	}
}

1445 
	$‹¡17
 () {

1446 
»t
 = 0;

1447 
	`debug
 ("TEST: int bdelete (bstring s1, int…os, int†en);");

1449 
»t
 +ğ
	`‹¡17_0
 (
NULL
, 0, 0, NULL);

1450 
»t
 +ğ
	`‹¡17_0
 (&
badB¡ršg1
, 0, 0, 
NULL
);

1451 
»t
 +ğ
	`‹¡17_0
 (&
badB¡ršg2
, 0, 0, 
NULL
);

1454 
»t
 +ğ
	`‹¡17_0
 (&
em±yB¡ršg
, 0, 0, "");

1455 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 1, 3, "bs");

1456 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, -1, 3, "gus");

1457 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 1, -3, "bogus");

1458 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 3, 9, "bog");

1459 
»t
 +ğ
	`‹¡17_0
 (&
shÜtB¡ršg
, 3, 1, "bogs");

1460 
»t
 +ğ
	`‹¡17_0
 (&
lÚgB¡ršg
, 4, 300, "This");

1462 
	`debug
 ("\t# fau»s: %d", 
»t
);

1463  
»t
;

1464 
	}
}

1466 
	$‹¡18_0
 (
b¡ršg
 
b
, 
Ën
, 
»s
, 
mËn
) {

1467 
»t
 = 0;

1468 
rv
;

1469 
Ş
 = 0;

1471 
	`debug
 (".\tb®loø(%s, %dèğ", 
	`dumpB¡ršg
 (
b
), 
Ën
);

1472 ià(
b
è
Ş
 = b->
mËn
;

1473 
rv
 = 
	`b®loc
 (
b
, 
Ën
);

1474 
	`debug
 ("%d", 
rv
);

1476 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >=0 && 
Ş
 > b->
mËn
) {

1477 
	`debug
 ("\t\tçu»(%dèŞdmËÀğ%d,‚ewmËÀ%d", 
__LINE__
, 
Ş
, 
b
->
mËn
);

1478 
»t
++;

1481 ià(
rv
 !ğ
»s
) {

1482 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

1483 
»t
++;

1485 ià(
b
 !ğ
NULL
 && (
mËn
 > b->mlen || b->mlen == 0)) {

1486 
	`debug
 ("\t\tçu»(%dèb->mËÀğ%d mËÀğ%d", 
__LINE__
, 
b
->
mËn
, mlen);

1487 
»t
++;

1489  
»t
;

1490 
	}
}

1492 
	$‹¡18_1_št
 (
b¡ršg
 
b
, 
Ën
, 
»s
, 
mËn
, 
__lše__
) {

1493 
»t
 = 0;

1494 
rv
;

1495 
Ş
 = 0;

1497 
	`debug
 (".\tb®locmš (%s, %dèğ", 
	`dumpB¡ršg
 (
b
), 
Ën
);

1498 ià(
b
è
Ş
 = b->
mËn
;

1500 
rv
 = 
	`b®locmš
 (
b
, 
Ën
);

1501 
	`debug
 ("[%d] %d", 
__LINE__
, 
rv
);

1503 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
mËn
 != mlen) {

1504 
	`debug
 ("\t\t[%d] fau»(%dèŞdmËÀğ%d,‚ewmËÀğ%d, mËÀğ%d†’ = %d", 
__lše__
, 
__LINE__
, 
Ş
, 
b
->
mËn
, mËn, b->
¦’
);

1505 
»t
++;

1508 ià(
rv
 !ğ
»s
) {

1509 
	`debug
 ("\t\t[%d] fau»(%dè» ğ%d", 
__lše__
, 
__LINE__
, 
»s
);

1510 
»t
++;

1513  
»t
;

1514 
	}
}

1516 
	#‹¡18_1
(
b
, 
Ën
, 
»s
, 
mËn
è
	`‹¡18_1_št
 (b,†’,„es, mËn, 
__LINE__
)

	)

1518 
	$‹¡18
 () {

1519 
»t
 = 0, 
»to
;

1520 
b¡ršg
 
b
 = 
	`bäomc¡r
 ("test");

1522 
	`debug
 ("TEST: int balloc (bstring s, int†en);");

1524 
»t
 +ğ
	`‹¡18_0
 (
NULL
, 2, 
BSTR_ERR
, 0);

1525 
»t
 +ğ
	`‹¡18_0
 (&
badB¡ršg1
, 2, 
BSTR_ERR
, 0);

1526 
»t
 +ğ
	`‹¡18_0
 (&
badB¡ršg2
, 2, 
BSTR_ERR
, 0);

1529 
»t
 +ğ
	`‹¡18_0
 (
b
, 2, 0, b->
mËn
);

1530 
»t
 +ğ
	`‹¡18_0
 (
b
, -1, 
BSTR_ERR
, b->
mËn
);

1531 
»t
 +ğ
	`‹¡18_0
 (
b
, 9, 0, 9);

1532 
»t
 +ğ
	`‹¡18_0
 (
b
, 2, 0, 9);

1533 
	`bwr™•rÙeù
 (*
b
);

1534 
»t
 +ğ
	`‹¡18_0
 (
b
, 4, 
BSTR_ERR
, b->
mËn
);

1535 
	`bwr™—Îow
 (*
b
);

1536 
»t
 +ğ
	`‹¡18_0
 (
b
, 2, 0, b->
mËn
);

1537 
»t
 +ğ
	`‹¡18_0
 (&
em±yB¡ršg
, 9, 
BSTR_ERR
,ƒm±yB¡ršg.
mËn
);

1539 
	`bde¡roy
 (
b
);

1540 
	`debug
 ("\t# fau»s: %d", 
»t
);

1542 
»to
 = 
»t
;

1543 
»t
 = 0;

1545 
b
 = 
	`bäomc¡r
 ("test");

1547 
	`debug
 ("TEST: int ballocmin (bstring s, int†en);");

1549 
»t
 +ğ
	`‹¡18_1
 (
NULL
, 2, 
BSTR_ERR
, 0);

1550 
»t
 +ğ
	`‹¡18_1
 (&
badB¡ršg1
, 2, 
BSTR_ERR
, 0);

1551 
»t
 +ğ
	`‹¡18_1
 (&
badB¡ršg2
, 2, 
BSTR_ERR
, 2);

1554 
»t
 +ğ
	`‹¡18_1
 (
b
, 2, 0, b->
¦’
 + 1);

1555 
»t
 +ğ
	`‹¡18_1
 (
b
, -1, 
BSTR_ERR
, b->
mËn
);

1556 
»t
 +ğ
	`‹¡18_1
 (
b
, 9, 0, 9);

1557 
»t
 +ğ
	`‹¡18_1
 (
b
, 2, 0, b->
¦’
 + 1);

1558 
»t
 +ğ
	`‹¡18_1
 (
b
, 9, 0, 9);

1559 
	`bwr™•rÙeù
 (*
b
);

1560 
»t
 +ğ
	`‹¡18_1
 (
b
, 4, 
BSTR_ERR
, -1);

1561 
	`bwr™—Îow
 (*
b
);

1562 
»t
 +ğ
	`‹¡18_1
 (
b
, 2, 0, b->
¦’
 + 1);

1563 
»t
 +ğ
	`‹¡18_1
 (&
em±yB¡ršg
, 9, 
BSTR_ERR
,ƒm±yB¡ršg.
mËn
);

1565 
	`bde¡roy
 (
b
);

1566 
	`debug
 ("\t# fau»s: %d", 
»t
);

1568  
»to
 + 
»t
;

1569 
	}
}

1571 
	$‹¡19_0
 (
b¡ršg
 
b
, 
Ën
, cÚ¡ * 
»s
, 
”v
) {

1572 
rv
, 
»t
 = 0;

1573 
b¡ršg
 
b1
;

1575 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

1576 
b1
 = 
	`b¡rıy
 (
b
);

1577 
	`bwr™•rÙeù
 (*
b1
);

1578 
»t
 +ğ
	`b·‰”n
 (
b1
, 
Ën
è!ğ
BSTR_ERR
;

1579 
»t
 +ğ!
	`bi£q
 (
b1
, 
b
);

1580 
	`bwr™—Îow
 (*
b1
);

1582 
	`debug
 (".\tb·‰”À(%s, %dèğ", 
	`dumpB¡ršg
 (
b1
), 
Ën
);

1584 
rv
 = 
	`b·‰”n
 (
b1
, 
Ën
);

1586 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b1
));

1588 
»t
 +ğ(
rv
 !ğ
”v
);

1589 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b1
->
¦’
)

1590 || (0 !ğ
	`memcmp
 (
b1
->
d©a
, 
»s
, b1->
¦’
));

1591 
»t
 +ğ
b1
->
d©a
[b1->
¦’
] != '\0';

1593 
	`bde¡roy
(
b1
);

1595 
»t
 +ğ
BSTR_ERR
 !ğ(
rv
 = 
	`b·‰”n
 (
b
, 
Ën
));

1596 
	`debug
 (".\tb·‰”À(%s, %dèğ%d", 
	`dumpB¡ršg
 (
b
), 
Ën
, 
rv
);

1599 ià(
»t
) {

1600 
	`debug
 ("\t\tçu»(%dèrv = %dƒrv = %d (» ğ%p", 
__LINE__
, 
rv
, 
”v
, 
»s
);

1601 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

1602 
	`debug
 (")");

1605  
»t
;

1606 
	}
}

1608 
	$‹¡19
 () {

1609 
»t
 = 0;

1611 
	`debug
 ("TEST: int bpattern (bstring b, int†en);");

1613 
»t
 +ğ
	`‹¡19_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

1614 
»t
 +ğ
	`‹¡19_0
 (
NULL
, 5, NULL, 
BSTR_ERR
);

1615 
»t
 +ğ
	`‹¡19_0
 (
NULL
, -5, NULL, 
BSTR_ERR
);

1616 
»t
 +ğ
	`‹¡19_0
 (&
badB¡ršg1
, 5, 
NULL
, 
BSTR_ERR
);

1617 
»t
 +ğ
	`‹¡19_0
 (&
badB¡ršg2
, 5, 
NULL
, 
BSTR_ERR
);

1620 
»t
 +ğ
	`‹¡19_0
 (&
em±yB¡ršg
, 0, "", 
BSTR_ERR
);

1621 
»t
 +ğ
	`‹¡19_0
 (&
em±yB¡ršg
, 10, "", 
BSTR_ERR
);

1622 
»t
 +ğ
	`‹¡19_0
 (&
em±yB¡ršg
, -1, "", 
BSTR_ERR
);

1623 
»t
 +ğ
	`‹¡19_0
 (&
shÜtB¡ršg
, 0, "", 0);

1624 
»t
 +ğ
	`‹¡19_0
 (&
shÜtB¡ršg
, 12, "bogusbogusbo", 0);

1625 
»t
 +ğ
	`‹¡19_0
 (&
shÜtB¡ršg
, -1, "bogus", 
BSTR_ERR
);

1627 
	`debug
 ("\t# fau»s: %d", 
»t
);

1628  
»t
;

1629 
	}
}

1631 
	$‹¡20
 () {

1632 
»t
 = 0;

1634 #ià!
	`defšed
 (
BSTRLIB_NOVSNP
)

1635 
rv
;

1636 
b¡ršg
 
b
, 
c
;

1638 
	`debug
 ("TEST: bstring bformat (const char * fmt, ...);");

1640 
	`debug
 (".\tbformat (NULL, 1, 2) = ");

1641 
b
 = 
	`bfÜm©
 (
NULL
, 1, 2);

1642 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1643 
»t
 +ğ
b
 !ğ
NULL
;

1646 
	`debug
 (".\tbformat (\"%%d %%s\", 1, \"xy\") = ");

1647 
b
 = 
	`bfÜm©
 ("%d %s", 1, "xy");

1648 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1649 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("1 xy"), 
b
);

1650 
	`bde¡roy
 (
b
);

1652 
	`debug
 (".\tbfÜm© (\"%%d %%s(%%s)\", 6, %s, %sèğ", 
	`dumpB¡ršg
 (
c
), dumpB¡ršg (&
shÜtB¡ršg
));

1653 
b
 = 
	`bfÜm©
 ("%d %s(%s)", 6, 
c
->
d©a
, 
shÜtB¡ršg
.data);

1654 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1655 
	`bde¡roy
 (
c
);

1656 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("6 1 xy(bogus)"), 
b
);

1657 
	`bde¡roy
 (
c
);

1658 
	`bde¡roy
 (
b
);

1660 
	`debug
 (".\tbformat (\"%%s%%s%%s%%s%%s%%s%%s%%s\", ...) ...");

1661 
b
 = 
	`bfÜm©
 ("%s%s%s%s%s%s%s%s", 
lÚgB¡ršg
.
d©a
,†ongBstring.data

1662 , 
lÚgB¡ršg
.
d©a
,†ongBstring.data

1663 , 
lÚgB¡ršg
.
d©a
,†ongBstring.data

1664 , 
lÚgB¡ršg
.
d©a
,†ongBstring.data);

1665 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

1666 
	`bcÚÿt
 (
c
, c);

1667 
	`bcÚÿt
 (
c
, c);

1668 
	`bcÚÿt
 (
c
, c);

1669 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1670 
	`bde¡roy
 (
c
);

1671 
	`bde¡roy
 (
b
);

1673 
	`debug
 ("\t# fau»s: %d", 
»t
);

1675 
b
 = 
	`bäomc¡r
 ("");

1676 
	`debug
 ("TEST: int bformata (bstring b, const char * fmt, ...);");

1678 
	`debug
 (".\tbfÜm©¨(%s, NULL, 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1679 
rv
 = 
	`bfÜm©a
 (
b
, 
NULL
, 1, 2);

1680 
	`debug
 ("%d", 
rv
);

1681 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1682 
	`debug
 (".\tbfÜm©¨(%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (&
badB¡ršg1
));

1683 
rv
 = 
	`bfÜm©a
 (&
badB¡ršg1
, "%d %d", 1, 2);

1684 
	`debug
 ("%d", 
rv
);

1685 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1686 
	`debug
 (".\tbfÜm©¨(%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1687 
rv
 = 
	`bfÜm©a
 (
b
, "%d %d", 1, 2);

1688 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1689 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("1 2"), 
b
);

1690 
	`bde¡roy
 (
c
);

1691 
	`bde¡roy
 (
b
);

1693 
	`debug
 (".\tbformata (\"x\", \"%%s%%s%%s%%s%%s%%s%%s%%s\", ...) ...");

1694 
rv
 = 
	`bfÜm©a
 (
b
 = 
	`bäomc¡r
 ("x"), "%s%s%s%s%s%s%s%s",

1695 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1696 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1697 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1698 
lÚgB¡ršg
.
d©a
,†ongBstring.data);

1699 
»t
 +ğ
rv
 =ğ
BSTR_ERR
;

1700 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

1701 
	`bcÚÿt
 (
c
, c);

1702 
	`bcÚÿt
 (
c
, c);

1703 
	`bcÚÿt
 (
c
, c);

1704 
	`bš£¹ch
 (
c
, 0, 1, () 'x');

1705 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1706 
	`bde¡roy
 (
c
);

1707 
	`bde¡roy
 (
b
);

1709 
	`debug
 ("\t# fau»s: %d", 
»t
);

1711 
b
 = 
	`bäomc¡r
 ("Initial");

1712 
	`debug
 ("TEST: int bassignformat (bstring b, const char * fmt, ...);");

1714 
	`debug
 (".\tbassignfÜm© (%s, NULL, 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1715 
rv
 = 
	`bassignfÜm©
 (
b
, 
NULL
, 1, 2);

1716 
	`debug
 ("%d", 
rv
);

1717 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1718 
	`debug
 (".\tbassignfÜm© (%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (&
badB¡ršg1
));

1719 
rv
 = 
	`bassignfÜm©
 (&
badB¡ršg1
, "%d %d", 1, 2);

1720 
	`debug
 ("%d", 
rv
);

1721 
»t
 +ğ
rv
 !ğ
BSTR_ERR
;

1722 
	`debug
 (".\tbassignfÜm© (%s, \"%%d %%d\", 1, 2èğ", 
	`dumpB¡ršg
 (
b
));

1723 
rv
 = 
	`bassignfÜm©
 (
b
, "%d %d", 1, 2);

1724 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
b
));

1725 
»t
 +ğ!
	`bi£q
 (
c
 = 
	`bäomc¡r
 ("1 2"), 
b
);

1726 
	`bde¡roy
 (
c
);

1727 
	`bde¡roy
 (
b
);

1729 
	`debug
 (".\tbassignformat (\"x\", \"%%s%%s%%s%%s%%s%%s%%s%%s\", ...) ...");

1730 
rv
 = 
	`bassignfÜm©
 (
b
 = 
	`bäomc¡r
 ("x"), "%s%s%s%s%s%s%s%s",

1731 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1732 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1733 
lÚgB¡ršg
.
d©a
,†ongBstring.data,

1734 
lÚgB¡ršg
.
d©a
,†ongBstring.data);

1735 
»t
 +ğ
rv
 =ğ
BSTR_ERR
;

1736 
c
 = 
	`b¡rıy
 (&
lÚgB¡ršg
);

1737 
	`bcÚÿt
 (
c
, c);

1738 
	`bcÚÿt
 (
c
, c);

1739 
	`bcÚÿt
 (
c
, c);

1740 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1741 
	`bde¡roy
 (
c
);

1742 
	`bde¡roy
 (
b
);

1744 
	`debug
 ("\t# fau»s: %d", 
»t
);

1747  
»t
;

1748 
	}
}

1750 
	$‹¡21_0
 (
b¡ršg
 
b
, 
sc
, 
ns
) {

1751 
b¡rLi¡
 * 
l
;

1752 
»t
 = 0;

1754 
	`debug
 (".\tb¥l™ (%s, '%c'èğ", 
	`dumpB¡ršg
 (
b
), 
sc
);

1756 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

1757 
b¡ršg
 
c
;

1758 
gb¡ršg
 
t
;

1760 
	`blk2tb¡r
(
t
,&
sc
,1);

1762 
	`debug
 ("{");

1764 
l
 = 
	`b¥l™
 (
b
, 
sc
);

1766 ià(
l
) {

1767 
i
;

1768 
i
=0; i < 
l
->
qty
; i++) {

1769 ià(
i
 !ğ0è
	`debug
 (", ");

1770 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
l
->
’Œy
[
i
]));

1772 
	`debug
 (":<%d>", 
l
->
qty
);

1773 ià(
ns
 !ğ
l
->
qty
è
»t
++;

1775 
	`debug
 ("NULL");

1776 
»t
 ++;

1779 
	`debug
 ("}");

1781 
c
 = 
	`bjoš
 (
l
, &
t
);

1782 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1783 
	`bde¡roy
 (
c
);

1784 
»t
 +ğ0 !ğ
	`b¡rLi¡De¡roy
 (
l
);

1786 
l
 = 
	`b¥l™
 (
b
, 
sc
);

1787 
»t
 +ğ(
l
 !ğ
NULL
);

1788 
	`debug
 ("%p", (*è
l
);

1791 ià(
»t
) {

1792 
	`debug
 ("\t\tçu»(%dèn ğ%d", 
__LINE__
, 
ns
);

1795  
»t
;

1796 
	}
}

1798 
	$‹¡21_1
 (
b¡ršg
 
b
, 
cÚ¡_b¡ršg
 
sc
, 
ns
) {

1799 
b¡rLi¡
 * 
l
;

1800 
»t
 = 0;

1802 
	`debug
 (".\tb¥l™¡¸(%s, %sèğ", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
sc
));

1804 ià(
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0) {

1805 
b¡ršg
 
c
;

1807 
	`debug
 ("{");

1809 
l
 = 
	`b¥l™¡r
 (
b
, 
sc
);

1811 ià(
l
) {

1812 
i
;

1813 
i
=0; i < 
l
->
qty
; i++) {

1814 ià(
i
 !ğ0è
	`debug
 (", ");

1815 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
l
->
’Œy
[
i
]));

1817 
	`debug
 (":<%d>", 
l
->
qty
);

1818 ià(
ns
 !ğ
l
->
qty
è
»t
++;

1820 
	`debug
 ("NULL");

1821 
»t
 ++;

1824 
	`debug
 ("}");

1826 
c
 = 
	`bjoš
 (
l
, 
sc
);

1827 
»t
 +ğ!
	`bi£q
 (
c
, 
b
);

1828 
	`bde¡roy
 (
c
);

1829 
»t
 +ğ0 !ğ
	`b¡rLi¡De¡roy
 (
l
);

1831 
l
 = 
	`b¥l™¡r
 (
b
, 
sc
);

1832 
»t
 +ğ(
l
 !ğ
NULL
);

1833 
	`debug
 ("%p", (*è
l
);

1836 ià(
»t
) {

1837 
	`debug
 ("\t\tçu»(%dèn ğ%d", 
__LINE__
, 
ns
);

1840  
»t
;

1841 
	}
}

1843 
	$‹¡21
 () {

1844 
gb¡ršg
 
is
 = 
	`bsStic
 ("is");

1845 
gb¡ršg
 
ng
 = 
	`bsStic
 ("ng");

1846 
»t
 = 0;

1848 
	`debug
 ("TEST: struct bstrList * bsplit (const_bstring str, unsigned char splitChar);");

1850 
»t
 +ğ
	`‹¡21_0
 (
NULL
, () '?', 0);

1851 
»t
 +ğ
	`‹¡21_0
 (&
badB¡ršg1
, () '?', 0);

1852 
»t
 +ğ
	`‹¡21_0
 (&
badB¡ršg2
, () '?', 0);

1855 
»t
 +ğ
	`‹¡21_0
 (&
em±yB¡ršg
, () '?', 1);

1856 
»t
 +ğ
	`‹¡21_0
 (&
shÜtB¡ršg
, () 'o', 2);

1857 
»t
 +ğ
	`‹¡21_0
 (&
shÜtB¡ršg
, () 's', 2);

1858 
»t
 +ğ
	`‹¡21_0
 (&
shÜtB¡ršg
, () 'b', 2);

1859 
»t
 +ğ
	`‹¡21_0
 (&
lÚgB¡ršg
, () 'o', 9);

1861 
	`debug
 ("TEST: struct bstrList * bsplitstr (bstring str, const_bstring splitStr);");

1863 
»t
 +ğ
	`‹¡21_1
 (
NULL
, NULL, 0);

1864 
»t
 +ğ
	`‹¡21_1
 (&
badB¡ršg1
, &
em±yB¡ršg
, 0);

1865 
»t
 +ğ
	`‹¡21_1
 (&
badB¡ršg2
, &
em±yB¡ršg
, 0);

1868 
»t
 +ğ
	`‹¡21_1
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, 5);

1869 
»t
 +ğ
	`‹¡21_1
 (&
lÚgB¡ršg
, &
is
, 3);

1870 
»t
 +ğ
	`‹¡21_1
 (&
lÚgB¡ršg
, &
ng
, 5);

1872 ià(0 =ğ
»t
) {

1873 
b¡rLi¡
 * 
l
;

1874 
c
;

1875 
gb¡ršg
 
t
;

1876 
b¡ršg
 
b
;

1877 
b¡ršg
 
li¡
[3] = { &
em±yB¡ršg
, &
shÜtB¡ršg
, &
lÚgB¡ršg
 };

1878 
i
;

1880 
	`blk2tb¡r
 (
t
, &
c
, 1);

1882 
i
=0; i < 3; i++) {

1883 
c
 = () '\0';

1885 
b
 = 
	`bjoš
 (
l
 = 
	`b¥l™
 (
li¡
[
i
], 
c
), &
t
);

1886 ià(!
	`bi£q
 (
b
, 
li¡
[
i
])) {

1887 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

1888 
	`debug
 ("još (b¥l™ (%s, x%02X), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
b
));

1889 
»t
++;

1891 
	`bde¡roy
 (
b
);

1892 
	`b¡rLi¡De¡roy
 (
l
);

1893 ià(
»t
) ;

1895 
b
 = 
	`bjoš
 (
l
 = 
	`b¥l™¡r
 (
li¡
[
i
], &
t
), &t);

1896 ià(!
	`bi£q
 (
b
, 
li¡
[
i
])) {

1897 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

1898 
	`debug
 ("još (b¥l™¡¸(%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
b
));

1899 
»t
++;

1901 
	`bde¡roy
 (
b
);

1902 
	`b¡rLi¡De¡roy
 (
l
);

1903 ià(
»t
) ;

1905 ià(
UCHAR_MAX
 =ğ
c
) ;

1906 
c
++;

1908 ià(
»t
) ;

1912 
	`debug
 ("\t# fau»s: %d", 
»t
);

1913  
»t
;

1914 
	}
}

1916 
	$‹¡22_0
 (
cÚ¡_b¡ršg
 
b
, cÚ¡_b¡ršg 
£p
, 
ns
, ...) {

1917 
va_li¡
 
¬gli¡
;

1918 
b¡rLi¡
 * 
l
;

1919 
»t
 = 0;

1921 
	`debug
 (".\tb¥l™ (%s, %s)", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
£p
));

1922 iàĞ
b
 !ğ
NULL
 && b->
d©a
 !ğNULL && b->
¦’
 >= 0 &&

1923 
£p
 !ğ
NULL
 && s•->
d©a
 !ğNULL && s•->
¦’
 >= 0) {

1924 
	`debug
 (" {");

1926 
l
 = 
	`b¥l™s
 (
b
, 
£p
);

1928 ià(
l
) {

1929 
i
;

1930 
	`va_¡¬t
 (
¬gli¡
, 
ns
);

1932 
i
=0; i < 
l
->
qty
; i++) {

1933 * 
»s
;

1935 
»s
 = 
	`va_¬g
 (
¬gli¡
, *);

1937 ià(
i
 !ğ0è
	`debug
 (", ");

1938 
	`debug
 ("%s", 
	`dumpB¡ršg
 (
l
->
’Œy
[
i
]));

1940 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
l
->
’Œy
[
i
]->
¦’
)

1941 || (0 !ğ
	`memcmp
 (
l
->
’Œy
[
i
]->
d©a
, 
»s
,†->’Œy[i]->
¦’
));

1942 
»t
 +ğ
l
->
’Œy
[
i
]->
d©a
[l->’Œy[i]->
¦’
] != '\0';

1945 
	`va_’d
 (
¬gli¡
);

1947 
	`debug
 (":<%d>", 
l
->
qty
);

1948 ià(
ns
 !ğ
l
->
qty
è
»t
++;

1950 
	`debug
 ("NULL");

1951 
»t
 +ğ(
ns
 != 0);

1954 
	`debug
 ("}");

1956 
»t
 +ğ(0 !ğ
	`b¡rLi¡De¡roy
 (
l
è&&† !ğ
NULL
);

1958 
l
 = 
	`b¥l™s
 (
b
, 
£p
);

1959 
»t
 +ğ(
l
 !ğ
NULL
);

1960 
	`debug
 (" = %p", (*è
l
);

1963 ià(
»t
) {

1964 
	`debug
 ("\t\tçu»(%dèn ğ%d", 
__LINE__
, 
ns
);

1967  
»t
;

1968 
	}
}

1970 
	$‹¡22
 () {

1971 
»t
 = 0;

1972 
gb¡ršg
 
o
=
	`bsStic
("o");

1973 
gb¡ršg
 
s
=
	`bsStic
("s");

1974 
gb¡ršg
 
b
=
	`bsStic
("b");

1975 
gb¡ršg
 
bs
=
	`bsStic
("bs");

1976 
gb¡ršg
 
uo
=
	`bsStic
("uo");

1978 
	`debug
 ("TEST:ƒxtern struct bstrList * bsplits (const_bstring str, const_bstring splitStr);");

1980 
»t
 +ğ
	`‹¡22_0
 (
NULL
, &
o
, 0);

1981 
»t
 +ğ
	`‹¡22_0
 (&
o
, 
NULL
, 0);

1984 
»t
 +ğ
	`‹¡22_0
 (&
em±yB¡ršg
, &
o
, 1, "");

1985 
»t
 +ğ
	`‹¡22_0
 (&
em±yB¡ršg
, &
uo
, 1, "");

1986 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, 1, "bogus");

1987 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
o
, 2, "b", "gus");

1988 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
s
, 2, "bogu", "");

1989 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
b
, 2, "" , "ogus");

1990 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
bs
, 3, "" , "ogu", "");

1991 
»t
 +ğ
	`‹¡22_0
 (&
lÚgB¡ršg
, &
o
, 9, "This is‡ b", "gus but„eas", "nably†", "ng string. Just†", "ngƒn", "ugh", " cause s", "me mall", "cing.");

1992 
»t
 +ğ
	`‹¡22_0
 (&
shÜtB¡ršg
, &
uo
, 3, "b", "g", "s");

1994 ià(0 =ğ
»t
) {

1995 
b¡rLi¡
 * 
l
;

1996 
c
;

1997 
gb¡ršg
 
t
;

1998 
b¡ršg
 
bb
;

1999 
b¡ršg
 
li¡
[3] = { &
em±yB¡ršg
, &
shÜtB¡ršg
, &
lÚgB¡ršg
 };

2000 
i
;

2002 
	`blk2tb¡r
 (
t
, &
c
, 1);

2004 
i
=0; i < 3; i++) {

2005 
c
 = () '\0';

2007 
bb
 = 
	`bjoš
 (
l
 = 
	`b¥l™s
 (
li¡
[
i
], &
t
), &t);

2008 ià(!
	`bi£q
 (
bb
, 
li¡
[
i
])) {

2009 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

2010 
	`debug
 ("još (b¥l™ (%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
bb
));

2011 
»t
++;

2013 
	`bde¡roy
 (
bb
);

2014 
	`b¡rLi¡De¡roy
 (
l
);

2015 ià(
»t
) ;

2016 ià(
UCHAR_MAX
 =ğ
c
) ;

2017 
c
++;

2019 ià(
»t
) ;

2023 
	`debug
 ("\t# fau»s: %d", 
»t
);

2024  
»t
;

2025 
	}
}

2027 
	ssb¡r
 {

2028 
	mofs
;

2029 
b¡ršg
 
	mb
;

2032 
size_t
 
	$‹¡23_aux_»ad
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, *
·rm
) {

2033 
sb¡r
 * 
sb
 = (sb¡¸*)
·rm
;

2034 
–s
, 
Ën
;

2036 ià(
·rm
 =ğ
NULL
 || 
–size
 =ğ0 || 
ÃËm
 == 0)  0;

2037 
Ën
 = (è(
ÃËm
 * 
–size
); if (len <= 0)  0;

2038 ià(
Ën
 + 
sb
->
ofs
 > sb->
b
->
¦’
)†en = sb->b->slen - sb->ofs;

2039 
–s
 = (è(
Ën
 / 
–size
);

2040 
Ën
 = (è(
–s
 * 
–size
);

2041 ià(
Ën
 > 0) {

2042 
	`memıy
 (
buff
, 
sb
->
b
->
d©a
 + sb->
ofs
, 
Ën
);

2043 
sb
->
ofs
 +ğ
Ën
;

2045  
–s
;

2046 
	}
}

2048 
	$‹¡23_aux_İ’
 (
sb¡r
 * 
sb
, 
b¡ršg
 
b
) {

2049 ià(!
sb
 || 
b
 =ğ
NULL
 || b->
d©a
 =ğNULLè -
__LINE__
;

2050 
sb
->
ofs
 = 0;

2051 
sb
->
b
 = b;

2053 
	}
}

2055 
	$‹¡23_aux_¥l™cb
 (* 
·rm
, 
ofs
, cÚ¡ 
gb¡ršg
 * 
’Œy
) {

2056 
b¡ršg
 
b
 = (b¡ršgè
·rm
;

2058 
ofs
 = ofs;

2059 ià(
b
->
¦’
 > 0è
	`bcÚch¬
 (b, () '|');

2060 
	`bcÚÿt
 (
b
, 
’Œy
);

2062 
	}
}

2064 
	sgBss
 {

2065 
	mfœ¡
;

2066 
	msc
;

2067 
b¡ršg
 
	mb
;

2070 
	$‹¡23_aux_¥l™cbx
 (* 
·rm
, 
ofs
, cÚ¡ 
gb¡ršg
 * 
’Œy
) {

2071 
gBss
 * 
p
 = (gBs *è
·rm
;

2073 
ofs
 = ofs;

2074 ià(!
p
->
fœ¡
) {

2075 
	`bcÚch¬
 (
p
->
b
, (èp->
sc
);

2076 } 
p
->
fœ¡
 = 0;

2078 
	`bcÚÿt
 (
p
->
b
, 
’Œy
);

2080 
	}
}

2082 
	$‹¡23
 () {

2083 
gb¡ršg
 
¥aû
 = 
	`bsStic
 (" ");

2084 
sb¡r
 
sb
;

2085 
bSŒ—m
 * 
bs
;

2086 
b¡ršg
 
b
;

2087 
l
, 
»t
 = 0;

2089 
	`debug
 ("TEST: bstream integratedest");

2090 
	`‹¡23_aux_İ’
 (&
sb
, &
lÚgB¡ršg
);

2091 
»t
 +ğ
NULL
 !ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
èNULL, &
sb
));

2092 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2093 
»t
 +ğ(
	`b£of
 (
bs
) != 0);

2094 
»t
 +ğ
BSTR_ERR
 !ğ
	`bsbufæ’gth
 (
NULL
, -1);

2095 
»t
 +ğ
BSTR_ERR
 !ğ
	`bsbufæ’gth
 (
NULL
, 1);

2096 
»t
 +ğ
BSTR_ERR
 !ğ
	`bsbufæ’gth
 (
bs
, -1);

2097 
	`debug
 (".\tbsbufæ’gth (bs, 0è-> %d", 
	`bsbufæ’gth
 (
bs
, 0));

2098 
»t
 +ğ
BSTR_ERR
 =ğ
	`bsbufæ’gth
 (
bs
, 1);

2099 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¥“k
 (
NULL
, 
bs
);

2100 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¤—dÊ
 (
NULL
, 
bs
, () '?');

2101 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¤—dÊ
 (&
em±yB¡ršg
, 
bs
, () '?');

2102 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¥“k
 (&
em±yB¡ršg
, 
bs
);

2104 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¥“k
 (
b
 = 
	`bäomc¡r
 (""), 
bs
);

2106 
	`debug
 (".\tb¥“k (è-> %s", 
	`dumpB¡ršg
 (
b
));

2107 
»t
 +ğ
BSTR_ERR
 !ğ
	`b¤—dÊ
 (
b
, 
NULL
, () '?');

2108 
b
->
¦’
 = 0;

2109 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '?');

2110 
»t
 +ğ(
	`b£of
 (
bs
) <= 0);

2111 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2112 
	`debug
 (".\tb¤—dÊ ('?'è-> %s", 
	`dumpB¡ršg
 (
b
));

2113 
»t
 +ğ
BSTR_ERR
 =ğ
	`bsuÄ—d
 (
bs
, 
b
);

2114 
»t
 +ğ(
	`b£of
 (
bs
) != 0);

2115 
	`debug
 (".\tbsuÄ—d (%s)", 
	`dumpB¡ršg
 (
b
));

2116 
b
->
¦’
 = 0;

2117 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¥“k
 (
b
, 
bs
);

2118 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2119 
	`debug
 (".\tb¥“k (è-> %s", 
	`dumpB¡ršg
 (
b
));

2120 
b
->
¦’
 = 0;

2121 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '?');

2122 
»t
 +ğ(
	`b£of
 (
bs
) <= 0);

2123 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2124 
	`debug
 (".\tb¤—dÊ ('?'è-> %s", 
	`dumpB¡ršg
 (
b
));

2125 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2126 
sb
.
ofs
 = 0;

2128 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2129 
b
->
¦’
 = 0;

2130 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '.');

2131 
l
 = 
b
->
¦’
;

2132 
»t
 +ğ(0 !ğ
	`b¡ºcmp
 (
b
, &
lÚgB¡ršg
, 
l
)è|| (lÚgB¡ršg.
d©a
[l-1] != '.');

2133 
	`debug
 (".\tb¤—dÊ ('.'è-> %s", 
	`dumpB¡ršg
 (
b
));

2134 
»t
 +ğ
BSTR_ERR
 =ğ
	`bsuÄ—d
 (
bs
, 
b
);

2136 
	`debug
 (".\tbsuÄ—d (%s)", 
	`dumpB¡ršg
 (
b
));

2137 
b
->
¦’
 = 0;

2138 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¥“k
 (
b
, 
bs
);

2139 
»t
 +ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
) < 0;

2140 
	`debug
 (".\tb¥“k (è-> %s", 
	`dumpB¡ršg
 (
b
));

2141 
b
->
¦’
 = 0;

2142 
»t
 +ğ
BSTR_ERR
 =ğ
	`b¤—dÊ
 (
b
, 
bs
, () '.');

2144 
»t
 +ğ
b
->
¦’
 !ğ
l
 || (0 !ğ
	`b¡ºcmp
 (b, &
lÚgB¡ršg
,†)è|| (lÚgB¡ršg.
d©a
[l-1] != '.');

2145 
	`debug
 (".\tb¤—dÊ ('.'è-> %s", 
	`dumpB¡ršg
 (
b
));

2146 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2148 
	`‹¡23_aux_İ’
 (&
sb
, &
lÚgB¡ršg
);

2149 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2150 
»t
 +ğ(
	`b£of
 (
bs
) != 0);

2151 
b
->
¦’
 = 0;

2152 
l
 = 
	`bs¥l™scb
 (
bs
, &
¥aû
, 
‹¡23_aux_¥l™cb
, 
b
);

2153 
»t
 +ğ(
	`b£of
 (
bs
) <= 0);

2154 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2155 
	`debug
 (".\tbs¥l™scb (' 'è-> %s", 
	`dumpB¡ršg
 (
b
));

2157 
l
=1;† < 4;†++) {

2158 * 
¡r
;

2159 
¡r
 = (*è
lÚgB¡ršg
.
d©a
; *str; str++) {

2160 
	`‹¡23_aux_İ’
 (&
sb
, &
lÚgB¡ršg
);

2161 
»t
 +ğ
NULL
 =ğ(
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
));

2162 
»t
 +ğ
	`b£of
 (
bs
) != 0;

2163 
»t
 +ğ0 > 
	`bsbufæ’gth
 (
bs
, 
l
);

2164 
b
->
¦’
 = 0;

2165 0 =ğ
	`b¤—dÊa
 (
b
, 
bs
, *
¡r
)) ;

2166 
»t
 +ğ0 =ğ
	`bi£q
 (
b
, &
lÚgB¡ršg
);

2167 
»t
 +ğ
	`b£of
 (
bs
) <= 0;

2168 
»t
 +ğ
NULL
 =ğ
	`bsşo£
 (
bs
);

2169 ià(
»t
) ;

2171 ià(
»t
) ;

2174 
	`bde¡roy
 (
b
);

2176 ià(0 =ğ
»t
) {

2177 
c
;

2178 
gb¡ršg
 
t
;

2179 
b¡ršg
 
li¡
[3] = { &
em±yB¡ršg
, &
shÜtB¡ršg
, &
lÚgB¡ršg
 };

2180 
i
;

2182 
	`blk2tb¡r
 (
t
, &
c
, 1);

2184 
i
=0; i < 3; i++) {

2185 
c
 = () '\0';

2187 
gBss
 
bss
;

2189 
bss
.
sc
 = 
c
;

2190 
bss
.
b
 = 
	`bäomc¡r
 ("");

2191 
bss
.
fœ¡
 = 1;

2193 
	`‹¡23_aux_İ’
 (&
sb
, 
li¡
[
i
]);

2194 
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
);

2195 
	`bs¥l™scb
 (
bs
, &
t
, 
‹¡23_aux_¥l™cbx
, &
bss
);

2196 
	`bsşo£
 (
bs
);

2198 ià(!
	`bi£q
 (
bss
.
b
, 
li¡
[
i
])) {

2199 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

2200 
	`debug
 ("još (bs¥l™scb (%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
bss
.
b
));

2201 
»t
++;

2203 
	`bde¡roy
 (
bss
.
b
);

2204 ià(
»t
) ;

2205 ià(
UCHAR_MAX
 =ğ
c
) ;

2206 
c
++;

2208 ià(
»t
) ;

2211 
gBss
 
bss
;

2213 
bss
.
sc
 = 
c
;

2214 
bss
.
b
 = 
	`bäomc¡r
 ("");

2215 
bss
.
fœ¡
 = 1;

2217 
	`‹¡23_aux_İ’
 (&
sb
, 
li¡
[
i
]);

2218 
bs
 = 
	`bsİ’
 ((
bN»ad
è
‹¡23_aux_»ad
, &
sb
);

2219 
	`bs¥l™¡rcb
 (
bs
, &
t
, 
‹¡23_aux_¥l™cbx
, &
bss
);

2220 
	`bsşo£
 (
bs
);

2222 ià(!
	`bi£q
 (
bss
.
b
, 
li¡
[
i
])) {

2223 
	`debug
 ("\t\tçu»(%dè", 
__LINE__
);

2224 
	`debug
 ("još (bs¥l™¡rcb (%s, {x%02X}), {x%02X}èğ%s", 
	`dumpB¡ršg
 (
li¡
[
i
]), 
c
, c, dumpB¡ršg (
bss
.
b
));

2225 
»t
++;

2227 
	`bde¡roy
 (
bss
.
b
);

2228 ià(
»t
) ;

2229 ià(
UCHAR_MAX
 =ğ
c
) ;

2230 
c
++;

2232 ià(
»t
) ;

2236 
	`debug
 ("\t# fau»s: %d", 
»t
);

2237  
»t
;

2238 
	}
}

2240 
	$‹¡24_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

2241 
rv
, 
»t
 = 0;

2243 
	`debug
 (".\tbnšch¸(%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

2244 
rv
 = 
	`bnšchr
 (
s1
, 
pos
, 
s2
);

2245 
	`debug
 ("%d", 
rv
);

2246 
»t
 +ğ(
rv
 !ğ
»s
);

2247 ià(
»t
) {

2248 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2250  
»t
;

2251 
	}
}

2253 
	$‹¡24
 () {

2254 
b¡ršg
 
b
;

2255 
»t
 = 0;

2257 
	`debug
 ("TEST: int bninchr (const_bstring s1, int…os, const_bstring s2);");

2258 
»t
 +ğ
	`‹¡24_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

2259 
»t
 +ğ
	`‹¡24_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

2260 
»t
 +ğ
	`‹¡24_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2261 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 3, &
badB¡ršg1
, 
BSTR_ERR
);

2262 
»t
 +ğ
	`‹¡24_0
 (&
badB¡ršg1
, 3, &
shÜtB¡ršg
, 
BSTR_ERR
);

2264 
»t
 +ğ
	`‹¡24_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

2265 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2266 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 0, &shÜtB¡ršg, 
BSTR_ERR
);

2267 
»t
 +ğ
	`‹¡24_0
 (&
shÜtB¡ršg
, 1, &shÜtB¡ršg, 
BSTR_ERR
);

2268 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 3, &
shÜtB¡ršg
, 4);

2269 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 3, 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
), 4);

2270 
	`bde¡roy
 (
b
);

2271 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, -1, &
shÜtB¡ršg
, 
BSTR_ERR
);

2272 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 1000, &
shÜtB¡ršg
, 
BSTR_ERR
);

2273 
»t
 +ğ
	`‹¡24_0
 (&
xxxxxB¡ršg
, 0, &
shÜtB¡ršg
, 0);

2274 
»t
 +ğ
	`‹¡24_0
 (&
xxxxxB¡ršg
, 1, &
shÜtB¡ršg
, 1);

2275 
»t
 +ğ
	`‹¡24_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

2277 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 0, &
shÜtB¡ršg
, 0);

2278 
»t
 +ğ
	`‹¡24_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 15);

2279 
	`debug
 ("\t# fau»s: %d", 
»t
);

2280  
»t
;

2281 
	}
}

2283 
	$‹¡25_0
 (
b¡ršg
 
s1
, 
pos
, 
cÚ¡_b¡ršg
 
s2
, 
»s
) {

2284 
rv
, 
»t
 = 0;

2286 
	`debug
 (".\tbnšch¼ (%s, %d, %sèğ", 
	`dumpB¡ršg
 (
s1
), 
pos
, dumpB¡ršg (
s2
));

2287 
rv
 = 
	`bnšch¼
 (
s1
, 
pos
, 
s2
);

2288 
	`debug
 ("%d", 
rv
);

2289 
»t
 +ğ(
rv
 !ğ
»s
);

2290 ià(
»t
) {

2291 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2293  
»t
;

2294 
	}
}

2296 
	$‹¡25
 () {

2297 
b¡ršg
 
b
;

2298 
»t
 = 0;

2300 
	`debug
 ("TEST: int bninchrr (const_bstring s1, int…os, const_bstring s2);");

2301 
»t
 +ğ
	`‹¡25_0
 (
NULL
, 0, NULL, 
BSTR_ERR
);

2302 
»t
 +ğ
	`‹¡25_0
 (&
em±yB¡ršg
, 0, 
NULL
, 
BSTR_ERR
);

2303 
»t
 +ğ
	`‹¡25_0
 (
NULL
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2304 
»t
 +ğ
	`‹¡25_0
 (&
em±yB¡ršg
, 0, &em±yB¡ršg, 
BSTR_ERR
);

2305 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 0, &
em±yB¡ršg
, 
BSTR_ERR
);

2306 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 0, &
badB¡ršg1
, 
BSTR_ERR
);

2307 
»t
 +ğ
	`‹¡25_0
 (&
badB¡ršg1
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

2309 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 0, &shÜtB¡ršg, 
BSTR_ERR
);

2310 
»t
 +ğ
	`‹¡25_0
 (&
shÜtB¡ršg
, 4, &shÜtB¡ršg, 
BSTR_ERR
);

2311 
»t
 +ğ
	`‹¡25_0
 (&
lÚgB¡ršg
, 10, &
shÜtB¡ršg
, 9);

2312 
»t
 +ğ
	`‹¡25_0
 (&
lÚgB¡ršg
, 10, 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
), 9);

2313 
	`bde¡roy
 (
b
);

2314 
»t
 +ğ
	`‹¡25_0
 (&
xxxxxB¡ršg
, 4, &
shÜtB¡ršg
, 4);

2315 
»t
 +ğ
	`‹¡25_0
 (&
em±yB¡ršg
, 0, &
shÜtB¡ršg
, 
BSTR_ERR
);

2317 
	`debug
 ("\t# fau»s: %d", 
»t
);

2318  
»t
;

2319 
	}
}

2321 
	$‹¡26_0
 (
b¡ršg
 
b0
, 
pos
, 
Ën
, 
cÚ¡_b¡ršg
 
b1
, 
fl
, * 
»s
) {

2322 
b¡ršg
 
b2
;

2323 
rv
, 
»t
 = 0;

2325 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2326 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

2327 
b2
 = 
	`b¡rıy
 (
b0
);

2328 
	`bwr™•rÙeù
 (*
b2
);

2330 
	`debug
 (".\tb»¶aû (%s, ", 
	`dumpB¡ršg
 (
b2
));

2332 
rv
 = 
	`b»¶aû
 (
b2
, 
pos
, 
Ën
, 
b1
, 
fl
);

2333 
»t
 +ğ(
rv
 == 0);

2334 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2336 
	`debug
 ("%d, %d, %s, %02Xèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

2338 
	`bwr™—Îow
 (*
b2
);

2340 
	`debug
 (".\tb»¶aû (%s, ", 
	`dumpB¡ršg
 (
b2
));

2342 
rv
 = 
	`b»¶aû
 (
b2
, 
pos
, 
Ën
, 
b1
, 
fl
);

2343 ià(
b1
) {

2344 
»t
 +ğ(
pos
 < 0è&& (
b2
->
¦’
 !ğ
b0
->slen);

2345 
»t
 +ğ((
rv
 =ğ0è!ğ(
pos
 >ğ0 &&…o <ğ
b2
->
¦’
));

2348 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

2349 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2350 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2352 
	`debug
 ("%d, %d, %s, %02Xèğ%s", 
pos
, 
Ën
, 
	`dumpB¡ršg
 (
b1
), 
fl
, dumpB¡ršg (
b2
));

2354 
	`bde¡roy
 (
b2
);

2356 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`b»¶aû
 (
b0
, 
pos
, 
Ën
, 
b1
, 
fl
)));

2357 
	`debug
 (".\tb»¶aû (%s, %d, %d, %s, %02Xèğ%d", 
	`dumpB¡ršg
 (
b0
), 
pos
, 
Ën
, dumpB¡ršg (
b1
), 
fl
, 
rv
);

2360 ià(
»t
) {

2361 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2362 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2363 
	`debug
 (")");

2365  
»t
;

2366 
	}
}

2368 
	$‹¡26
 () {

2369 
»t
 = 0;

2370 
	`debug
 ("TEST: int breplace (bstring b0, int…os, int†en, const_bstring b1, unsigned char fill);");

2372 
»t
 +ğ
	`‹¡26_0
 (
NULL
, 0, 0, NULL, () '?', NULL);

2373 
»t
 +ğ
	`‹¡26_0
 (
NULL
, 0, 0, &
em±yB¡ršg
, () '?', NULL);

2374 
»t
 +ğ
	`‹¡26_0
 (&
badB¡ršg1
, 1, 3, &
shÜtB¡ršg
, (è'?', 
NULL
);

2375 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 1, 3, &
badB¡ršg1
, (è'?', 
NULL
);

2378 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 0, 0, &emptyBstring, () '?', "");

2379 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 5, 0, &emptyBstring, () '?', "?????");

2380 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 5, 0, &
shÜtB¡ršg
, () '?', "?????bogus");

2381 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 0, 0, &
em±yB¡ršg
, () '?', "bogus");

2382 
»t
 +ğ
	`‹¡26_0
 (&
em±yB¡ršg
, 0, 0, &
shÜtB¡ršg
, () '?', "bogus");

2383 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 0, 0, &shortBstring, () '?', "bogusbogus");

2384 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 1, 3, &shortBstring, () '?', "bboguss");

2385 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 3, 8, &shortBstring, () '?', "bogbogus");

2386 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, -1, 0, &shortBstring, () '?', "bogus");

2387 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 2, 0, &shortBstring, () '?', "bobogusgus");

2388 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 6, 0, &shortBstring, () '?', "bogus?bogus");

2389 
»t
 +ğ
	`‹¡26_0
 (&
shÜtB¡ršg
, 6, 0, 
NULL
, () '?', "bogus");

2390 
	`debug
 ("\t# fau»s: %d", 
»t
);

2391  
»t
;

2392 
	}
}

2394 
	$‹¡27_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
, cÚ¡ * 
»s
) {

2395 
b¡ršg
 
b2
;

2396 
rv
, 
»t
 = 0;

2398 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2399 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

2400 
b2
 = 
	`b¡rıy
 (
b0
);

2401 
	`bwr™•rÙeù
 (*
b2
);

2403 
	`debug
 (".\tbassigÀ(%s, ", 
	`dumpB¡ršg
 (
b2
));

2405 
rv
 = 
	`bassign
 (
b2
, 
b1
);

2406 
»t
 +ğ(
rv
 == 0);

2407 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2409 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

2411 
	`bwr™—Îow
 (*
b2
);

2413 
	`debug
 (".\tbassigÀ(%s, ", 
	`dumpB¡ršg
 (
b2
));

2415 
rv
 = 
	`bassign
 (
b2
, 
b1
);

2417 
	`debug
 ("%sèğ%s", 
	`dumpB¡ršg
 (
b1
), dumpB¡ršg (
b2
));

2419 ià(
b1
è
»t
 +ğ(
b2
->
¦’
 != b1->slen);

2420 
»t
 +ğ((0 !ğ
rv
è&& (
b1
 !ğ
NULL
)) || ((0 ==„v) && (b1 == NULL));

2421 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2422 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2423 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2424 
	`bde¡roy
 (
b2
);

2426 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bassign
 (
b0
, 
b1
)));

2427 
	`debug
 (".\tbassigÀ(%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

2430 ià(
»t
) {

2431 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2432 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2433 
	`debug
 (")");

2435  
»t
;

2436 
	}
}

2438 
	$‹¡27
 () {

2439 
»t
 = 0;

2441 
	`debug
 ("TEST: int bassign (bstring b0, const_bstring b1);");

2444 
»t
 +ğ
	`‹¡27_0
 (
NULL
, NULL, NULL);

2445 
»t
 +ğ
	`‹¡27_0
 (
NULL
, &
em±yB¡ršg
, NULL);

2446 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, 
NULL
, "");

2447 
»t
 +ğ
	`‹¡27_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
NULL
);

2448 
»t
 +ğ
	`‹¡27_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 
NULL
);

2449 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
NULL
);

2450 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 
NULL
);

2453 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &emptyBstring, "");

2454 
»t
 +ğ
	`‹¡27_0
 (&
em±yB¡ršg
, &
shÜtB¡ršg
, "bogus");

2455 
»t
 +ğ
	`‹¡27_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, "");

2456 
»t
 +ğ
	`‹¡27_0
 (&
shÜtB¡ršg
, &shortBstring, "bogus");

2457 
	`debug
 ("\t# fau»s: %d", 
»t
);

2458  
»t
;

2459 
	}
}

2461 
	$‹¡28_0
 (
b¡ršg
 
s1
, 
c
, 
»s
) {

2462 
rv
, 
»t
 = 0;

2464 
	`debug
 (".\tb¡rch¸(%s, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
);

2465 
rv
 = 
	`b¡rchr
 (
s1
, 
c
);

2466 
	`debug
 ("%d", 
rv
);

2467 
»t
 +ğ(
rv
 !ğ
»s
);

2468 ià(
»t
) {

2469 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2471  
»t
;

2472 
	}
}

2474 
	$‹¡28_1
 (
b¡ršg
 
s1
, 
c
, 
»s
) {

2475 
rv
, 
»t
 = 0;

2477 
	`debug
 (".\tb¡¼ch¸(%s, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
);

2478 
rv
 = 
	`b¡¼chr
 (
s1
, 
c
);

2479 
	`debug
 ("%d", 
rv
);

2480 
»t
 +ğ(
rv
 !ğ
»s
);

2481 ià(
»t
) {

2482 
	`debug
 ("\t\tçu»(%dè» ğ%d„v = %d", 
__LINE__
, 
»s
, 
rv
);

2484  
»t
;

2485 
	}
}

2487 
	$‹¡28_2
 (
b¡ršg
 
s1
, 
c
, 
pos
, 
»s
) {

2488 
rv
, 
»t
 = 0;

2490 
	`debug
 (".\tb¡rch½ (%s, %d, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
, 
pos
);

2491 
rv
 = 
	`b¡rch½
 (
s1
, 
c
, 
pos
);

2492 
	`debug
 ("%d", 
rv
);

2493 
»t
 +ğ(
rv
 !ğ
»s
);

2494 ià(
»t
) {

2495 
	`debug
 ("\t\tçu»(%dè» ğ%d", 
__LINE__
, 
»s
);

2497  
»t
;

2498 
	}
}

2500 
	$‹¡28_3
 (
b¡ršg
 
s1
, 
c
, 
pos
, 
»s
) {

2501 
rv
, 
»t
 = 0;

2503 
	`debug
 (".\tb¡¼ch½ (%s, %d, %dèğ", 
	`dumpB¡ršg
 (
s1
), 
c
, 
pos
);

2504 
rv
 = 
	`b¡¼ch½
 (
s1
, 
c
, 
pos
);

2505 
	`debug
 ("%d", 
rv
);

2506 
»t
 +ğ(
rv
 !ğ
»s
);

2507 ià(
»t
) {

2508 
	`debug
 ("\t\tçu»(%dè» ğ%d„v = %d", 
__LINE__
, 
»s
, 
rv
);

2510  
»t
;

2511 
	}
}

2513 
	$‹¡28
 () {

2514 
»t
 = 0;

2516 
	`debug
 ("TEST: int bstrchr (const_bstring s1, int c);");

2517 
»t
 +ğ
	`‹¡28_0
 (
NULL
, 0, 
BSTR_ERR
);

2518 
»t
 +ğ
	`‹¡28_0
 (&
badB¡ršg1
, 'b', 
BSTR_ERR
);

2519 
»t
 +ğ
	`‹¡28_0
 (&
badB¡ršg2
, 's', 
BSTR_ERR
);

2521 
»t
 +ğ
	`‹¡28_0
 (&
em±yB¡ršg
, 0, 
BSTR_ERR
);

2522 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 0, 
BSTR_ERR
);

2523 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 'b', 0);

2524 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 's', 4);

2525 
»t
 +ğ
	`‹¡28_0
 (&
shÜtB¡ršg
, 'q', 
BSTR_ERR
);

2526 
»t
 +ğ
	`‹¡28_0
 (&
xxxxxB¡ršg
, 0, 
BSTR_ERR
);

2527 
»t
 +ğ
	`‹¡28_0
 (&
xxxxxB¡ršg
, 'b', 
BSTR_ERR
);

2528 
»t
 +ğ
	`‹¡28_0
 (&
lÚgB¡ršg
, 'i', 2);

2530 
	`debug
 ("TEST: int bstrrchr (const_bstring s1, int c);");

2531 
»t
 +ğ
	`‹¡28_1
 (
NULL
, 0, 
BSTR_ERR
);

2532 
»t
 +ğ
	`‹¡28_1
 (&
badB¡ršg1
, 'b', 
BSTR_ERR
);

2533 
»t
 +ğ
	`‹¡28_1
 (&
badB¡ršg2
, 's', 
BSTR_ERR
);

2535 
»t
 +ğ
	`‹¡28_1
 (&
em±yB¡ršg
, 0, 
BSTR_ERR
);

2536 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 0, 
BSTR_ERR
);

2537 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 'b', 0);

2538 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 's', 4);

2539 
»t
 +ğ
	`‹¡28_1
 (&
shÜtB¡ršg
, 'q', 
BSTR_ERR
);

2540 
»t
 +ğ
	`‹¡28_1
 (&
xxxxxB¡ršg
, 0, 
BSTR_ERR
);

2541 
»t
 +ğ
	`‹¡28_1
 (&
xxxxxB¡ršg
, 'b', 
BSTR_ERR
);

2542 
»t
 +ğ
	`‹¡28_1
 (&
lÚgB¡ršg
, 'i', 82);

2544 
	`debug
 ("TEST: int bstrchrp (const_bstring s1, int c, int…os);");

2545 
»t
 +ğ
	`‹¡28_2
 (
NULL
, 0, 0, 
BSTR_ERR
);

2546 
»t
 +ğ
	`‹¡28_2
 (&
badB¡ršg1
, 'b', 0, 
BSTR_ERR
);

2547 
»t
 +ğ
	`‹¡28_2
 (&
badB¡ršg2
, 's', 0, 
BSTR_ERR
);

2548 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', -1, 
BSTR_ERR
);

2549 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', shÜtB¡ršg.
¦’
, 
BSTR_ERR
);

2551 
»t
 +ğ
	`‹¡28_2
 (&
em±yB¡ršg
, 0, 0, 
BSTR_ERR
);

2552 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 0, 0, 
BSTR_ERR
);

2553 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', 0, 0);

2554 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'b', 1, 
BSTR_ERR
);

2555 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 's', 0, 4);

2556 
»t
 +ğ
	`‹¡28_2
 (&
shÜtB¡ršg
, 'q', 0, 
BSTR_ERR
);

2558 
	`debug
 ("TEST: int bstrrchrp (const_bstring s1, int c, int…os);");

2559 
»t
 +ğ
	`‹¡28_3
 (
NULL
, 0, 0, 
BSTR_ERR
);

2560 
»t
 +ğ
	`‹¡28_3
 (&
badB¡ršg1
, 'b', 0, 
BSTR_ERR
);

2561 
»t
 +ğ
	`‹¡28_3
 (&
badB¡ršg2
, 's', 0, 
BSTR_ERR
);

2562 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', -1, 
BSTR_ERR
);

2563 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', shÜtB¡ršg.
¦’
, 
BSTR_ERR
);

2565 
»t
 +ğ
	`‹¡28_3
 (&
em±yB¡ršg
, 0, 0, 
BSTR_ERR
);

2566 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 0, 0, 
BSTR_ERR
);

2567 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', 0, 0);

2568 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 'b', shÜtB¡ršg.
¦’
 - 1, 0);

2569 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 's', shÜtB¡ršg.
¦’
 - 1, 4);

2570 
»t
 +ğ
	`‹¡28_3
 (&
shÜtB¡ršg
, 's', 0, 
BSTR_ERR
);

2572 
	`debug
 ("\t# fau»s: %d", 
»t
);

2573  
»t
;

2574 
	}
}

2576 
	$‹¡29_0
 (
b¡ršg
 
b0
, * 
s
, cÚ¡ * 
»s
) {

2577 
b¡ršg
 
b2
;

2578 
rv
, 
»t
 = 0;

2580 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2581 
b2
 = 
	`b¡rıy
 (
b0
);

2582 
	`bwr™•rÙeù
 (*
b2
);

2584 
	`debug
 (".\tbÿtc¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

2586 
rv
 = 
	`bÿtc¡r
 (
b2
, 
s
);

2587 
»t
 +ğ(
rv
 == 0);

2588 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2590 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2592 
	`bwr™—Îow
 (*
b2
);

2594 
	`debug
 (".\tbÿtc¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

2596 
rv
 = 
	`bÿtc¡r
 (
b2
, 
s
);

2598 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2600 ià(
s
è
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->¦’ + (è
	`¡¾’
 (s));

2601 
»t
 +ğ((0 !ğ
rv
è&& (
s
 !ğ
NULL
)) || ((0 ==„v) && (s == NULL));

2602 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2603 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2604 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2605 
	`bde¡roy
 (
b2
);

2607 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bÿtc¡r
 (
b0
, 
s
)));

2608 
	`debug
 (".\tbÿtc¡¸(%s, %pèğ%d", 
	`dumpB¡ršg
 (
b0
), 
s
, 
rv
);

2611 ià(
»t
) {

2612 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2613 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2614 
	`debug
 (")");

2616  
»t
;

2617 
	}
}

2619 
	$‹¡29
 () {

2620 
»t
 = 0;

2622 
	`debug
 ("TEST: int bcatcstr (bstring b0, const char * s);");

2625 
»t
 +ğ
	`‹¡29_0
 (
NULL
, NULL, NULL);

2626 
»t
 +ğ
	`‹¡29_0
 (
NULL
, "", NULL);

2627 
»t
 +ğ
	`‹¡29_0
 (&
em±yB¡ršg
, 
NULL
, "");

2628 
»t
 +ğ
	`‹¡29_0
 (&
badB¡ršg1
, "bogus", 
NULL
);

2629 
»t
 +ğ
	`‹¡29_0
 (&
badB¡ršg2
, "bogus", 
NULL
);

2632 
»t
 +ğ
	`‹¡29_0
 (&
em±yB¡ršg
, "", "");

2633 
»t
 +ğ
	`‹¡29_0
 (&
em±yB¡ršg
, "bogus", "bogus");

2634 
»t
 +ğ
	`‹¡29_0
 (&
shÜtB¡ršg
, "", "bogus");

2635 
»t
 +ğ
	`‹¡29_0
 (&
shÜtB¡ršg
, "bogus", "bogusbogus");

2636 
	`debug
 ("\t# fau»s: %d", 
»t
);

2637  
»t
;

2638 
	}
}

2640 
	$‹¡30_0
 (
b¡ršg
 
b0
, cÚ¡ * 
s
, 
Ën
, cÚ¡ * 
»s
) {

2641 
b¡ršg
 
b2
;

2642 
rv
, 
»t
 = 0;

2644 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2645 
b2
 = 
	`b¡rıy
 (
b0
);

2646 
	`bwr™•rÙeù
 (*
b2
);

2648 
	`debug
 (".\tbÿtblk (%s, ", 
	`dumpB¡ršg
 (
b2
));

2650 
rv
 = 
	`bÿtblk
 (
b2
, 
s
, 
Ën
);

2651 
»t
 +ğ(
rv
 == 0);

2652 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2654 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2656 
	`bwr™—Îow
 (*
b2
);

2658 
	`debug
 (".\tbÿtblk (%s, ", 
	`dumpB¡ršg
 (
b2
));

2660 
rv
 = 
	`bÿtblk
 (
b2
, 
s
, 
Ën
);

2662 
	`debug
 ("%pèğ%s", 
s
, 
	`dumpB¡ršg
 (
b2
));

2664 ià(
s
) {

2665 ià(
Ën
 >ğ0è
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen +†en);

2666 
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen);

2668 
»t
 +ğ((0 !ğ
rv
è&& (
s
 !ğ
NULL
 && 
Ën
 >= 0)) || ((0 ==„v) && (s == NULL ||†en < 0));

2669 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2670 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2671 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2672 
	`bde¡roy
 (
b2
);

2674 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bÿtblk
 (
b0
, 
s
, 
Ën
)));

2675 
	`debug
 (".\tbÿtblk (%s, %p, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), 
s
, 
Ën
, 
rv
);

2678 ià(
»t
) {

2679 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2680 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2681 
	`debug
 (")");

2683  
»t
;

2684 
	}
}

2686 
	$‹¡30
 () {

2687 
»t
 = 0;

2689 
	`debug
 ("TEST: int bcatblk (bstring b0, const char * s);");

2692 
»t
 +ğ
	`‹¡30_0
 (
NULL
, NULL, 0, NULL);

2693 
»t
 +ğ
	`‹¡30_0
 (
NULL
, (*) "", 0, NULL);

2694 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, 
NULL
, 0, "");

2695 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, 
NULL
, -1, "");

2696 
»t
 +ğ
	`‹¡30_0
 (&
badB¡ršg1
, 
NULL
, 0, NULL);

2697 
»t
 +ğ
	`‹¡30_0
 (&
badB¡ršg2
, 
NULL
, 0, NULL);

2700 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, (*) "", -1, "");

2701 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, (*) "", 0, "");

2702 
»t
 +ğ
	`‹¡30_0
 (&
em±yB¡ršg
, (*) "bogus", 5, "bogus");

2703 
»t
 +ğ
	`‹¡30_0
 (&
shÜtB¡ršg
, (*) "", 0, "bogus");

2704 
»t
 +ğ
	`‹¡30_0
 (&
shÜtB¡ršg
, (*) "bogus", 5, "bogusbogus");

2705 
»t
 +ğ
	`‹¡30_0
 (&
shÜtB¡ršg
, (*) "bogus", -1, "bogus");

2706 
	`debug
 ("\t# fau»s: %d", 
»t
);

2707  
»t
;

2708 
	}
}

2710 
	$‹¡31_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶aû
, 
pos
, * 
»s
) {

2711 
b¡ršg
 
b2
;

2712 
rv
, 
»t
 = 0;

2714 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2715 
fšd
 !ğ
NULL
 && fšd->
d©a
 !ğNULL && fšd->
¦’
 >= 0 &&

2716 
»¶aû
 !ğ
NULL
 &&„•Ïû->
d©a
 !ğNULL &&„•Ïû->
¦’
 >= 0) {

2717 
b2
 = 
	`b¡rıy
 (
b0
);

2718 
	`bwr™•rÙeù
 (*
b2
);

2720 
	`debug
 (".\tbfšd»¶aû (%s, %s, %s, %dèğ", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2722 
rv
 = 
	`bfšd»¶aû
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2723 
»t
 +ğ(
rv
 == 0);

2724 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2726 
	`debug
 ("%d", 
rv
);

2728 
	`bwr™—Îow
 (*
b2
);

2730 
	`debug
 (".\tbfšd»¶aû (%s, %s, %s, %d)", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2732 
rv
 = 
	`bfšd»¶aû
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2734 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

2735 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2736 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2738 
	`debug
 (" -> %s", 
	`dumpB¡ršg
 (
b2
));

2740 
	`bde¡roy
 (
b2
);

2742 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bfšd»¶aû
 (
b0
, 
fšd
, 
»¶aû
, 
pos
)));

2743 
	`debug
 (".\tbfšd»¶aû (%s, %s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
, 
rv
);

2746 ià(
»t
) {

2747 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2748 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2749 
	`debug
 (")");

2751  
»t
;

2752 
	}
}

2754 
	$‹¡31_1
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
fšd
, cÚ¡_b¡ršg 
»¶aû
, 
pos
, * 
»s
) {

2755 
b¡ršg
 
b2
;

2756 
rv
, 
»t
 = 0;

2758 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

2759 
fšd
 !ğ
NULL
 && fšd->
d©a
 !ğNULL && fšd->
¦’
 >= 0 &&

2760 
»¶aû
 !ğ
NULL
 &&„•Ïû->
d©a
 !ğNULL &&„•Ïû->
¦’
 >= 0) {

2761 
b2
 = 
	`b¡rıy
 (
b0
);

2762 
	`bwr™•rÙeù
 (*
b2
);

2764 
	`debug
 (".\tbfšd»¶aûÿ£Ës (%s, %s, %s, %dèğ", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2766 
rv
 = 
	`bfšd»¶aûÿ£Ëss
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2767 
»t
 +ğ(
rv
 == 0);

2768 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2770 
	`debug
 ("%d", 
rv
);

2772 
	`bwr™—Îow
 (*
b2
);

2774 
	`debug
 (".\tbfšd»¶aûÿ£Ës (%s, %s, %s, %d)", 
	`dumpB¡ršg
 (
b2
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
);

2776 
rv
 = 
	`bfšd»¶aûÿ£Ëss
 (
b2
, 
fšd
, 
»¶aû
, 
pos
);

2778 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè> 
b2
->
¦’
)

2779 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2780 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2782 
	`debug
 (" -> %s", 
	`dumpB¡ršg
 (
b2
));

2784 
	`bde¡roy
 (
b2
);

2786 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bfšd»¶aûÿ£Ëss
 (
b0
, 
fšd
, 
»¶aû
, 
pos
)));

2787 
	`debug
 (".\tbfšd»¶aûÿ£Ës (%s, %s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
fšd
), dumpB¡ršg (
»¶aû
), 
pos
, 
rv
);

2790 ià(
»t
) {

2791 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2792 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2793 
	`debug
 (")");

2795  
»t
;

2796 
	}
}

2798 
	#LOTS_OF_S
 "ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss"

	)

2800 
	$‹¡31
 () {

2801 
»t
 = 0;

2802 
gb¡ršg
 
t0
 = 
	`bsStic
 ("funny");

2803 
gb¡ršg
 
t1
 = 
	`bsStic
 ("weird");

2804 
gb¡ršg
 
t2
 = 
	`bsStic
 ("s");

2805 
gb¡ršg
 
t3
 = 
	`bsStic
 ("long");

2806 
gb¡ršg
 
t4
 = 
	`bsStic
 ("big");

2807 
gb¡ršg
 
t5
 = 
	`bsStic
 ("ss");

2808 
gb¡ršg
 
t6
 = 
	`bsStic
 ("sstsst");

2809 
gb¡ršg
 
t7
 = 
	`bsStic
 ("xx" 
LOTS_OF_S
 "xx");

2810 
gb¡ršg
 
t8
 = 
	`bsStic
 ("S");

2811 
gb¡ršg
 
t9
 = 
	`bsStic
 ("LONG");

2813 
	`debug
 ("TEST: int bfindreplace (bstring b, const_bstring f, const_bstring„, int…os);");

2815 
»t
 +ğ
	`‹¡31_0
 (
NULL
, NULL, NULL, 0, NULL);

2816 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, 
NULL
, &
t1
, 0, (*èshÜtB¡ršg.
d©a
);

2817 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, &
t2
, 
NULL
, 0, (*èshÜtB¡ršg.
d©a
);

2818 
»t
 +ğ
	`‹¡31_0
 (&
badB¡ršg1
, &
t2
, &
t1
, 0, 
NULL
);

2819 
»t
 +ğ
	`‹¡31_0
 (&
badB¡ršg2
, &
t2
, &
t1
, 0, 
NULL
);

2822 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
shÜtB¡ršg
, &
t0
, 0, "This is‡ funny but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

2823 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 0, "Thiweird iweird‡ boguweird but„eaweirdonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2824 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, &
t2
, &
t1
, 0, "boguweird");

2825 
»t
 +ğ
	`‹¡31_0
 (&
shÜtB¡ršg
, &
t8
, &
t1
, 0, "bogus");

2826 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 27, "This is‡ bogus but„easonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2827 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t3
, &
t4
, 0, "This is‡ bogus but„easonably big string. Just bigƒnougho cause some mallocing.");

2828 
»t
 +ğ
	`‹¡31_0
 (&
lÚgB¡ršg
, &
t9
, &
t4
, 0, "This is‡ bogus but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

2829 
»t
 +ğ
	`‹¡31_0
 (&
t6
, &
t2
, &
t5
, 0, "sssstsssst");

2830 
»t
 +ğ
	`‹¡31_0
 (&
t7
, &
t2
, &
t5
, 0, "xx" 
LOTS_OF_S
 LOTS_OF_S "xx");

2832 
	`debug
 ("TEST: int bfindreplacecaseless (bstring b, const_bstring f, const_bstring„, int…os);");

2834 
»t
 +ğ
	`‹¡31_1
 (
NULL
, NULL, NULL, 0, NULL);

2835 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, 
NULL
, &
t1
, 0, (*èshÜtB¡ršg.
d©a
);

2836 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, &
t2
, 
NULL
, 0, (*èshÜtB¡ršg.
d©a
);

2837 
»t
 +ğ
	`‹¡31_1
 (&
badB¡ršg1
, &
t2
, &
t1
, 0, 
NULL
);

2838 
»t
 +ğ
	`‹¡31_1
 (&
badB¡ršg2
, &
t2
, &
t1
, 0, 
NULL
);

2841 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
shÜtB¡ršg
, &
t0
, 0, "This is‡ funny but„easonably†ong string. Just†ongƒnougho cause some mallocing.");

2842 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 0, "Thiweird iweird‡ boguweird but„eaweirdonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2843 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, &
t2
, &
t1
, 0, "boguweird");

2844 
»t
 +ğ
	`‹¡31_1
 (&
shÜtB¡ršg
, &
t8
, &
t1
, 0, "boguweird");

2845 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t2
, &
t1
, 27, "This is‡ bogus but„easonably†ong weirdtring. Juweirdt†ongƒnougho cauweirde weirdome mallocing.");

2846 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t3
, &
t4
, 0, "This is‡ bogus but„easonably big string. Just bigƒnougho cause some mallocing.");

2847 
»t
 +ğ
	`‹¡31_1
 (&
lÚgB¡ršg
, &
t9
, &
t4
, 0, "This is‡ bogus but„easonably big string. Just bigƒnougho cause some mallocing.");

2848 
»t
 +ğ
	`‹¡31_1
 (&
t6
, &
t2
, &
t5
, 0, "sssstsssst");

2849 
»t
 +ğ
	`‹¡31_1
 (&
t6
, &
t8
, &
t5
, 0, "sssstsssst");

2850 
»t
 +ğ
	`‹¡31_1
 (&
t7
, &
t2
, &
t5
, 0, "xx" 
LOTS_OF_S
 LOTS_OF_S "xx");

2852 
	`debug
 ("\t# fau»s: %d", 
»t
);

2853  
»t
;

2854 
	}
}

2856 
	$‹¡32_0
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
, 
»s
) {

2857 
rv
, 
»t
 = 0;

2859 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`bi£qc¡r
 (
b
, 
s
)));

2860 
	`debug
 (".\tbi£qc¡¸(%s, %p:<%s>èğ%d", 
	`dumpB¡ršg
 (
b
), 
s
, ( ? s : 
NULL
), 
rv
);

2861 ià(
»t
) {

2862 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

2864  
»t
;

2865 
	}
}

2867 
	$‹¡32_1
 (
cÚ¡_b¡ršg
 
b
, cÚ¡ * 
s
, 
»s
) {

2868 
rv
, 
»t
 = 0;

2870 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`bi£qc¡rÿ£Ëss
 (
b
, 
s
)));

2871 
	`debug
 (".\tbi£qc¡rÿ£Ës (%s, %p:<%s>èğ%d", 
	`dumpB¡ršg
 (
b
), 
s
, ( ? s : 
NULL
), 
rv
);

2872 ià(
»t
) {

2873 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

2875  
»t
;

2876 
	}
}

2879 
	$‹¡32
 () {

2880 
»t
 = 0;

2882 
	`debug
 ("TEST: int biseqcstr (const_bstring b, const char * s);");

2885 
»t
 +ğ
	`‹¡32_0
 (
NULL
, NULL, 
BSTR_ERR
);

2886 
»t
 +ğ
	`‹¡32_0
 (&
em±yB¡ršg
, 
NULL
, 
BSTR_ERR
);

2887 
»t
 +ğ
	`‹¡32_0
 (
NULL
, "", 
BSTR_ERR
);

2888 
»t
 +ğ
	`‹¡32_0
 (&
badB¡ršg1
, "", 
BSTR_ERR
);

2889 
»t
 +ğ
	`‹¡32_0
 (&
badB¡ršg2
, "bogus", 
BSTR_ERR
);

2892 
»t
 +ğ
	`‹¡32_0
 (&
em±yB¡ršg
, "", 1);

2893 
»t
 +ğ
	`‹¡32_0
 (&
shÜtB¡ršg
, "bogus", 1);

2894 
»t
 +ğ
	`‹¡32_0
 (&
em±yB¡ršg
, "bogus", 0);

2895 
»t
 +ğ
	`‹¡32_0
 (&
shÜtB¡ršg
, "", 0);

2898 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

2899 
b
->
d©a
[1]++;

2900 
»t
 +ğ
	`‹¡32_0
 (
b
, (*è
shÜtB¡ršg
.
d©a
, 0);

2901 
	`bde¡roy
 (
b
);

2904 
	`debug
 ("TEST: int biseqcstrcaseless (const_bstring b, const char * s);");

2907 
»t
 +ğ
	`‹¡32_1
 (
NULL
, NULL, 
BSTR_ERR
);

2908 
»t
 +ğ
	`‹¡32_1
 (&
em±yB¡ršg
, 
NULL
, 
BSTR_ERR
);

2909 
»t
 +ğ
	`‹¡32_1
 (
NULL
, "", 
BSTR_ERR
);

2910 
»t
 +ğ
	`‹¡32_1
 (&
badB¡ršg1
, "", 
BSTR_ERR
);

2911 
»t
 +ğ
	`‹¡32_1
 (&
badB¡ršg2
, "bogus", 
BSTR_ERR
);

2914 
»t
 +ğ
	`‹¡32_1
 (&
em±yB¡ršg
, "", 1);

2915 
»t
 +ğ
	`‹¡32_1
 (&
shÜtB¡ršg
, "bogus", 1);

2916 
»t
 +ğ
	`‹¡32_1
 (&
shÜtB¡ršg
, "BOGUS", 1);

2917 
»t
 +ğ
	`‹¡32_1
 (&
em±yB¡ršg
, "bogus", 0);

2918 
»t
 +ğ
	`‹¡32_1
 (&
shÜtB¡ršg
, "", 0);

2921 
b¡ršg
 
b
 = 
	`b¡rıy
 (&
shÜtB¡ršg
);

2922 
b
->
d©a
[1]++;

2923 
»t
 +ğ
	`‹¡32_1
 (
b
, (*è
shÜtB¡ršg
.
d©a
, 0);

2924 
	`bde¡roy
 (
b
);

2927 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

2928  
»t
;

2929 
	}
}

2931 
	$‹¡33_0
 (
b¡ršg
 
b0
, cÚ¡ * 
»s
) {

2932 
b¡ršg
 
b2
;

2933 
rv
, 
»t
 = 0;

2935 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2936 
b2
 = 
	`b¡rıy
 (
b0
);

2937 
	`bwr™•rÙeù
 (*
b2
);

2939 
	`debug
 (".\tbtouµ” (%s)", 
	`dumpB¡ršg
 (
b2
));

2941 
rv
 = 
	`btouµ”
 (
b2
);

2942 
»t
 +ğ(
rv
 == 0);

2943 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

2945 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

2947 
	`bwr™—Îow
 (*
b2
);

2949 
	`debug
 (".\tbtouµ” (%s)", 
	`dumpB¡ršg
 (
b2
));

2951 
rv
 = 
	`btouµ”
 (
b2
);

2953 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

2955 
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen);

2956 
»t
 +ğ(0 !ğ
rv
);

2957 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

2958 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

2959 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

2960 
	`bde¡roy
 (
b2
);

2962 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`btouµ”
 (
b0
)));

2963 
	`debug
 (".\tbtouµ” (%sèğ%d", 
	`dumpB¡ršg
 (
b0
), 
rv
);

2966 ià(
»t
) {

2967 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

2968 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

2969 
	`debug
 (")");

2971  
»t
;

2972 
	}
}

2974 
	$‹¡33
 () {

2975 
»t
 = 0;

2977 
	`debug
 ("TEST: int btoupper (bstring b);");

2980 
»t
 +ğ
	`‹¡33_0
 (
NULL
, NULL);

2981 
»t
 +ğ
	`‹¡33_0
 (&
badB¡ršg1
, 
NULL
);

2982 
»t
 +ğ
	`‹¡33_0
 (&
badB¡ršg2
, 
NULL
);

2985 
»t
 +ğ
	`‹¡33_0
 (&
em±yB¡ršg
, "");

2986 
»t
 +ğ
	`‹¡33_0
 (&
shÜtB¡ršg
, "BOGUS");

2987 
»t
 +ğ
	`‹¡33_0
 (&
lÚgB¡ršg
, "THIS IS A BOGUS BUT REASONABLY LONG STRING. JUST LONG ENOUGH TO CAUSE SOME MALLOCING.");

2989 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

2990  
»t
;

2991 
	}
}

2993 
	$‹¡34_0
 (
b¡ršg
 
b0
, cÚ¡ * 
»s
) {

2994 
b¡ršg
 
b2
;

2995 
rv
, 
»t
 = 0;

2997 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0) {

2998 
b2
 = 
	`b¡rıy
 (
b0
);

2999 
	`bwr™•rÙeù
 (*
b2
);

3001 
	`debug
 (".\tbtŞow” (%s)", 
	`dumpB¡ršg
 (
b2
));

3003 
rv
 = 
	`btŞow”
 (
b2
);

3004 
»t
 +ğ(
rv
 == 0);

3005 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

3007 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

3009 
	`bwr™—Îow
 (*
b2
);

3011 
	`debug
 (".\tbtŞow” (%s)", 
	`dumpB¡ršg
 (
b2
));

3013 
rv
 = 
	`btŞow”
 (
b2
);

3015 
	`debug
 (" = %s", 
	`dumpB¡ršg
 (
b2
));

3017 
»t
 +ğ(
b2
->
¦’
 !ğ
b0
->slen);

3018 
»t
 +ğ(0 !ğ
rv
);

3019 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

3020 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

3021 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

3022 
	`bde¡roy
 (
b2
);

3024 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`btŞow”
 (
b0
)));

3025 
	`debug
 (".\tbtŞow” (%sèğ%d", 
	`dumpB¡ršg
 (
b0
), 
rv
);

3028 ià(
»t
) {

3029 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

3030 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

3031 
	`debug
 (")");

3033  
»t
;

3034 
	}
}

3036 
	$‹¡34
 () {

3037 
»t
 = 0;

3039 
	`debug
 ("TEST: int btolower (bstring b);");

3042 
»t
 +ğ
	`‹¡34_0
 (
NULL
, NULL);

3043 
»t
 +ğ
	`‹¡34_0
 (&
badB¡ršg1
, 
NULL
);

3044 
»t
 +ğ
	`‹¡34_0
 (&
badB¡ršg2
, 
NULL
);

3047 
»t
 +ğ
	`‹¡34_0
 (&
em±yB¡ršg
, "");

3048 
»t
 +ğ
	`‹¡34_0
 (&
shÜtB¡ršg
, "bogus");

3049 
»t
 +ğ
	`‹¡34_0
 (&
lÚgB¡ršg
, "this is‡ bogus but„easonably†ong string. just†ongƒnougho cause some mallocing.");

3051 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3052  
»t
;

3053 
	}
}

3055 
	$‹¡35_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
»s
) {

3056 
rv
, 
»t
 = 0;

3058 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`b¡ricmp
 (
b0
, 
b1
)));

3059 
	`debug
 (".\tb¡ricm°(%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

3060 ià(
»t
) {

3061 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

3063  
»t
;

3064 
	}
}

3066 
	$‹¡35
 () {

3067 
»t
 = 0;

3068 
gb¡ršg
 
t0
 = 
	`bsStic
 ("bOgUs");

3069 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bOgUR");

3070 
gb¡ršg
 
t2
 = 
	`bsStic
 ("bOgUt");

3072 
	`debug
 ("TEST: int bstricmp (const_bstring b0, const_bstring b1);");

3075 
»t
 +ğ
	`‹¡35_0
 (
NULL
, NULL, 
SHRT_MIN
);

3076 
»t
 +ğ
	`‹¡35_0
 (&
em±yB¡ršg
, 
NULL
, 
SHRT_MIN
);

3077 
»t
 +ğ
	`‹¡35_0
 (
NULL
, &
em±yB¡ršg
, 
SHRT_MIN
);

3078 
»t
 +ğ
	`‹¡35_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
SHRT_MIN
);

3079 
»t
 +ğ
	`‹¡35_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
SHRT_MIN
);

3080 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
badB¡ršg2
, 
SHRT_MIN
);

3081 
»t
 +ğ
	`‹¡35_0
 (&
badB¡ršg2
, &
shÜtB¡ršg
, 
SHRT_MIN
);

3084 
»t
 +ğ
	`‹¡35_0
 (&
em±yB¡ršg
, &emptyBstring, 0);

3085 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t0
, 0);

3086 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t1
, 
	`tŞow”
 (shÜtB¡ršg.
d©a
[4]) -olower (t1.data[4]));

3087 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t2
, 
	`tŞow”
 (shÜtB¡ršg.
d©a
[4]) -olower (t2.data[4]));

3089 
t0
.
¦’
++;

3090 
»t
 +ğ
	`‹¡35_0
 (&
shÜtB¡ršg
, &
t0
, -(
UCHAR_MAX
+1));

3091 
»t
 +ğ
	`‹¡35_0
 (&
t0
, &
shÜtB¡ršg
, (
UCHAR_MAX
+1));

3093 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3094  
»t
;

3095 
	}
}

3097 
	$‹¡36_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
n
, 
»s
) {

3098 
rv
, 
»t
 = 0;

3100 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`b¡ºicmp
 (
b0
, 
b1
, 
n
)));

3101 
	`debug
 (".\tb¡ºicm°(%s, %s, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
n
, 
rv
);

3102 ià(
»t
) {

3103 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

3105  
»t
;

3106 
	}
}

3108 
	$‹¡36
 () {

3109 
»t
 = 0;

3110 
gb¡ršg
 
t0
 = 
	`bsStic
 ("bOgUs");

3111 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bOgUR");

3112 
gb¡ršg
 
t2
 = 
	`bsStic
 ("bOgUt");

3114 
	`debug
 ("TEST: int bstrnicmp (const_bstring b0, const_bstring b1);");

3117 
»t
 +ğ
	`‹¡36_0
 (
NULL
, NULL, 0, 
SHRT_MIN
);

3118 
»t
 +ğ
	`‹¡36_0
 (&
em±yB¡ršg
, 
NULL
, 0, 
SHRT_MIN
);

3119 
»t
 +ğ
	`‹¡36_0
 (
NULL
, &
em±yB¡ršg
, 0, 
SHRT_MIN
);

3120 
»t
 +ğ
	`‹¡36_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 0, 
SHRT_MIN
);

3121 
»t
 +ğ
	`‹¡36_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 0, 
SHRT_MIN
);

3122 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
badB¡ršg2
, 5, 
SHRT_MIN
);

3123 
»t
 +ğ
	`‹¡36_0
 (&
badB¡ršg2
, &
shÜtB¡ršg
, 5, 
SHRT_MIN
);

3126 
»t
 +ğ
	`‹¡36_0
 (&
em±yB¡ršg
, &emptyBstring, 0, 0);

3127 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 0, 0);

3128 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 5, 0);

3129 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 4, 0);

3130 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 6, 0);

3131 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t1
, 5, shÜtB¡ršg.
d©a
[4] -1.data[4]);

3132 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t1
, 4, 0);

3133 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t1
, 6, shÜtB¡ršg.
d©a
[4] -1.data[4]);

3134 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t2
, 5, shÜtB¡ršg.
d©a
[4] -2.data[4]);

3135 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t2
, 4, 0);

3136 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t2
, 6, shÜtB¡ršg.
d©a
[4] -2.data[4]);

3138 
t0
.
¦’
++;

3139 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 5, 0);

3140 
»t
 +ğ
	`‹¡36_0
 (&
shÜtB¡ršg
, &
t0
, 6, -(
UCHAR_MAX
+1));

3141 
»t
 +ğ
	`‹¡36_0
 (&
t0
, &
shÜtB¡ršg
, 6, (
UCHAR_MAX
+1));

3143 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3144  
»t
;

3145 
	}
}

3147 
	$‹¡37_0
 (
cÚ¡_b¡ršg
 
b0
, cÚ¡_b¡ršg 
b1
, 
»s
) {

3148 
rv
, 
»t
 = 0;

3150 
»t
 +ğ(
»s
 !ğ(
rv
 = 
	`bi£qÿ£Ëss
 (
b0
, 
b1
)));

3151 
	`debug
 (".\tbi£qÿ£Ës (%s, %sèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
rv
);

3152 ià(
»t
) {

3153 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%d)", 
__LINE__
, 
»t
, 
»s
);

3155  
»t
;

3156 
	}
}

3158 
	$‹¡37
 () {

3159 
»t
 = 0;

3160 
gb¡ršg
 
t0
 = 
	`bsStic
 ("bOgUs");

3161 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bOgUR");

3162 
gb¡ršg
 
t2
 = 
	`bsStic
 ("bOgUt");

3164 
	`debug
 ("TEST: int biseqcaseless (const_bstring b0, const_bstring b1);");

3167 
»t
 +ğ
	`‹¡37_0
 (
NULL
, NULL, 
BSTR_ERR
);

3168 
»t
 +ğ
	`‹¡37_0
 (&
em±yB¡ršg
, 
NULL
, 
BSTR_ERR
);

3169 
»t
 +ğ
	`‹¡37_0
 (
NULL
, &
em±yB¡ršg
, 
BSTR_ERR
);

3170 
»t
 +ğ
	`‹¡37_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 
BSTR_ERR
);

3171 
»t
 +ğ
	`‹¡37_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 
BSTR_ERR
);

3172 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
badB¡ršg2
, 
BSTR_ERR
);

3173 
»t
 +ğ
	`‹¡37_0
 (&
badB¡ršg2
, &
shÜtB¡ršg
, 
BSTR_ERR
);

3176 
»t
 +ğ
	`‹¡37_0
 (&
em±yB¡ršg
, &emptyBstring, 1);

3177 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
t0
, 1);

3178 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
t1
, 0);

3179 
»t
 +ğ
	`‹¡37_0
 (&
shÜtB¡ršg
, &
t2
, 0);

3181 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3182  
»t
;

3183 
	}
}

3185 
	semuFe
 {

3186 
	mofs
;

3187 
b¡ršg
 
	mcÚ‹Ás
;

3190 
	$‹¡38_aux_bNg‘c
 (
emuFe
 * 
f
) {

3191 
v
 = 
EOF
;

3192 ià(
NULL
 !ğ
f
 && 
EOF
 !ğ(
v
 = 
	`bch¬e
 (f->
cÚ‹Ás
, f->
ofs
, EOF))) f->ofs++;

3193  
v
;

3194 
	}
}

3196 
size_t
 
	$‹¡38_aux_bN»ad
 (*
buff
, 
size_t
 
–size
, size_ˆ
ÃËm
, 
emuFe
 * 
f
) {

3197 * 
b
 = (*è
buff
;

3198 
v
;

3199 
size_t
 
i
, 
j
, 
c
 = 0;

3201 ià(
NULL
 =ğ
f
 || NULL =ğ
b
è 
c
;

3202 
i
=0; i < 
ÃËm
; i++è
j
=0; j < 
–size
; j++) {

3203 
v
 = 
	`‹¡38_aux_bNg‘c
 (
f
);

3204 ià(
EOF
 =ğ
v
) {

3205 *
b
 = () '\0';

3206  
c
;

3208 *
b
 = (è
v
;

3209 
b
++;

3210 
c
++;

3214  
c
;

3215 
	}
}

3217 
	$‹¡38_aux_bNİ’
 (
emuFe
 * 
f
, 
b¡ršg
 
b
) {

3218 ià(
NULL
 =ğ
f
 || NULL =ğ
b
è -
__LINE__
;

3219 
f
->
ofs
 = 0;

3220 
f
->
cÚ‹Ás
 = 
b
;

3222 
	}
}

3224 
	$‹¡38
 () {

3225 
emuFe
 
f
;

3226 
b¡ršg
 
b0
, 
b1
, 
b2
, 
b3
;

3227 
»t
 = 0;

3229 
	`debug
 ("TEST: bgets/breadsest");

3231 
	`‹¡38_aux_bNİ’
 (&
f
, &
shÜtB¡ršg
);

3235 
b0
 = 
	`bg‘s
 ((
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'b');

3236 
b1
 = 
	`b»ad
 ((
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3237 
b2
 = 
	`bg‘s
 ((
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () '\0');

3238 
b3
 = 
	`b»ad
 ((
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3240 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b0
, "b");

3241 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b1
, "ogus");

3242 
»t
 +ğ
NULL
 !ğ
b2
;

3243 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b3
, "");

3247 
f
.
ofs
 = 0;

3249 
»t
 +ğ0 <ğ
	`bg‘§
 (
NULL
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3250 
»t
 +ğ0 <ğ
	`b»ada
 (
NULL
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3251 
»t
 +ğ0 <ğ
	`bg‘§
 (&
shÜtB¡ršg
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3252 
»t
 +ğ0 <ğ
	`b»ada
 (&
shÜtB¡ršg
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3256 
»t
 +ğ0 > 
	`bg‘§
 (
b0
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3257 
»t
 +ğ0 > 
	`b»ada
 (
b1
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3259 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b0
, "bbo");

3260 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b1
, "ogusgus");

3264 
»t
 +ğ0 > 
	`bg‘§
 (
b0
, (
bNg‘c
è
‹¡38_aux_bNg‘c
, &
f
, () 'o');

3265 
»t
 +ğ0 > 
	`b»ada
 (
b1
, (
bN»ad
è
‹¡38_aux_bN»ad
, &
f
);

3267 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b0
, "bbo");

3268 
»t
 +ğ1 !ğ
	`bi£qc¡r
 (
b1
, "ogusgus");

3270 
	`bde¡roy
 (
b0
);

3271 
	`bde¡roy
 (
b1
);

3272 
	`bde¡roy
 (
b2
);

3273 
	`bde¡roy
 (
b3
);

3275 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3276  
»t
;

3277 
	}
}

3279 
	$‹¡39_0
 (
cÚ¡_b¡ršg
 
b
, cÚ¡_b¡ršg 
É
, cÚ¡_b¡ršg 
¹
, cÚ¡_b¡ršg 
t
) {

3280 
b¡ršg
 
r
;

3281 
»t
 = 0;

3283 
»t
 +ğ0 <ğ
	`bÉrimws
 (
NULL
);

3284 
»t
 +ğ0 <ğ
	`b¹rimws
 (
NULL
);

3285 
»t
 +ğ0 <ğ
	`bŒimws
 (
NULL
);

3287 
r
 = 
	`b¡rıy
 (
b
);

3288 
	`bwr™•rÙeù
 (*
r
);

3289 
»t
 +ğ0 <ğ
	`bÉrimws
 (
r
);

3290 
»t
 +ğ0 <ğ
	`b¹rimws
 (
r
);

3291 
»t
 +ğ0 <ğ
	`bŒimws
 (
r
);

3292 
	`bwr™—Îow
(*
r
);

3293 
»t
 +ğ0 !ğ
	`bÉrimws
 (
r
);

3294 
	`debug
 (".\tbÉrim (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3295 
»t
 +ğ!
	`bi£q
 (
r
, 
É
);

3296 
	`bde¡roy
 (
r
);

3298 
r
 = 
	`b¡rıy
 (
b
);

3299 
»t
 +ğ0 !ğ
	`b¹rimws
 (
r
);

3300 
	`debug
 (".\tb¹rim (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3301 
»t
 +ğ!
	`bi£q
 (
r
, 
¹
);

3302 
	`bde¡roy
 (
r
);

3304 
r
 = 
	`b¡rıy
 (
b
);

3305 
»t
 +ğ0 !ğ
	`bŒimws
 (
r
);

3306 
	`debug
 (".\tbŒim (%sèğ%s", 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3307 
»t
 +ğ!
	`bi£q
 (
r
, 
t
);

3308 
	`bde¡roy
 (
r
);

3310  
»t
;

3311 
	}
}

3313 
	$‹¡39
 () {

3314 
»t
 = 0;

3315 
gb¡ršg
 
t0
 = 
	`bsStic
 (" bogus string ");

3316 
gb¡ršg
 
t1
 = 
	`bsStic
 ("bogus string ");

3317 
gb¡ršg
 
t2
 = 
	`bsStic
 (" bogus string");

3318 
gb¡ršg
 
t3
 = 
	`bsStic
 ("bogus string");

3319 
gb¡ršg
 
t4
 = 
	`bsStic
 (" ");

3320 
gb¡ršg
 
t5
 = 
	`bsStic
 ("");

3322 
	`debug
 ("TEST:rim functions");

3324 
»t
 +ğ
	`‹¡39_0
 (&
t0
, &
t1
, &
t2
, &
t3
);

3325 
»t
 +ğ
	`‹¡39_0
 (&
t1
, &t1, &
t3
, &t3);

3326 
»t
 +ğ
	`‹¡39_0
 (&
t2
, &
t3
, &t2, &t3);

3327 
»t
 +ğ
	`‹¡39_0
 (&
t3
, &t3, &t3, &t3);

3328 
»t
 +ğ
	`‹¡39_0
 (&
t4
, &
t5
, &t5, &t5);

3329 
»t
 +ğ
	`‹¡39_0
 (&
t5
, &t5, &t5, &t5);

3331 ià(
»t
è
	`debug
 ("\t# failures: %d",„et);

3332  
»t
;

3333 
	}
}

3335 
	$‹¡40_0
 (
b¡ršg
 
b0
, 
cÚ¡_b¡ršg
 
b1
, 
Ëá
, 
Ën
, cÚ¡ * 
»s
) {

3336 
b¡ršg
 
b2
;

3337 
rv
, 
»t
 = 0;

3339 ià(
b0
 !ğ
NULL
 && b0->
d©a
 !ğNULL && b0->
¦’
 >= 0 &&

3340 
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

3341 
b2
 = 
	`b¡rıy
 (
b0
);

3342 
	`bwr™•rÙeù
 (*
b2
);

3344 
	`debug
 (".\tbassignmid¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

3346 
rv
 = 
	`bassignmid¡r
 (
b2
, 
b1
, 
Ëá
, 
Ën
);

3347 
»t
 +ğ(
rv
 == 0);

3348 ià(!
	`bi£q
 (
b0
, 
b2
)è
»t
++;

3350 
	`debug
 ("%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b2
));

3352 
	`bwr™—Îow
 (*
b2
);

3354 
	`debug
 (".\tbassignmid¡¸(%s, ", 
	`dumpB¡ršg
 (
b2
));

3356 
rv
 = 
	`bassignmid¡r
 (
b2
, 
b1
, 
Ëá
, 
Ën
);

3358 
	`debug
 ("%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b2
));

3360 ià(
b1
è
»t
 +ğ(
b2
->
¦’
 > 
Ën
) | (b2->slen < 0);

3361 
»t
 +ğ((0 !ğ
rv
è&& (
b1
 !ğ
NULL
)) || ((0 ==„v) && (b1 == NULL));

3362 
»t
 +ğ(
»s
 =ğ
NULL
è|| ((è
	`¡¾’
 (»sè!ğ
b2
->
¦’
)

3363 || (0 !ğ
	`memcmp
 (
b2
->
d©a
, 
»s
, b2->
¦’
));

3364 
»t
 +ğ
b2
->
d©a
[b2->
¦’
] != '\0';

3365 
	`bde¡roy
 (
b2
);

3367 
»t
 +ğ(
BSTR_ERR
 !ğ(
rv
 = 
	`bassignmid¡r
 (
b0
, 
b1
, 
Ëá
, 
Ën
)));

3368 
	`debug
 (".\tbassignmid¡¸(%s, %s, %d, %dèğ%d", 
	`dumpB¡ršg
 (
b0
), dumpB¡ršg (
b1
), 
Ëá
, 
Ën
, 
rv
);

3371 ià(
»t
) {

3372 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

3373 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

3374 
	`debug
 (")");

3376  
»t
;

3377 
	}
}

3379 
	$‹¡40
 () {

3380 
»t
 = 0;

3382 
	`debug
 ("TEST: int bassignmidstr (bstring b0, const_bstring b1, int†eft, int†en);");

3385 
»t
 +ğ
	`‹¡40_0
 (
NULL
, NULL, 0, 1, NULL);

3386 
»t
 +ğ
	`‹¡40_0
 (
NULL
, &
em±yB¡ršg
, 0, 1, NULL);

3387 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, 
NULL
, 0, 1, "");

3388 
»t
 +ğ
	`‹¡40_0
 (&
badB¡ršg1
, &
em±yB¡ršg
, 0, 1, 
NULL
);

3389 
»t
 +ğ
	`‹¡40_0
 (&
badB¡ršg2
, &
em±yB¡ršg
, 0, 1, 
NULL
);

3390 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &
badB¡ršg1
, 0, 1, 
NULL
);

3391 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &
badB¡ršg2
, 0, 1, 
NULL
);

3394 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &emptyBstring, 0, 1, "");

3395 
»t
 +ğ
	`‹¡40_0
 (&
em±yB¡ršg
, &
shÜtB¡ršg
, 1, 3, "ogu");

3396 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &
em±yB¡ršg
, 0, 1, "");

3397 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, 1, 3, "ogu");

3398 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, -1, 4, "bog");

3399 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, 1, 9, "ogus");

3400 
»t
 +ğ
	`‹¡40_0
 (&
shÜtB¡ršg
, &shortBstring, 9, 1, "");

3402 
	`debug
 ("\t# fau»s: %d", 
»t
);

3403  
»t
;

3404 
	}
}

3406 
	$‹¡41_0
 (
b¡ršg
 
b1
, 
Ëá
, 
Ën
, cÚ¡ * 
»s
) {

3407 
gb¡ršg
 
t
;

3408 
b¡ršg
 
b2
, 
b3
;

3409 
»t
 = 0;

3411 ià(
b1
 !ğ
NULL
 && b1->
d©a
 !ğNULL && b1->
¦’
 >= 0) {

3412 
b2
 = 
	`bäomc¡r
 ("");

3414 
	`bassignmid¡r
 (
b2
, 
b1
, 
Ëá
, 
Ën
);

3416 
	`bmid2tb¡r
 (
t
, 
b1
, 
Ëá
, 
Ën
);

3417 
b3
 = 
	`b¡rıy
 (&
t
);

3419 
	`debug
 (".\tbmid2tb¡¸(%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b3
));

3421 
»t
 +ğ!
	`bi£q
 (&
t
, 
b2
);

3423 
	`bde¡roy
 (
b2
);

3424 
	`bde¡roy
 (
b3
);

3426 
	`bmid2tb¡r
 (
t
, 
b1
, 
Ëá
, 
Ën
);

3427 
b3
 = 
	`b¡rıy
 (&
t
);

3428 
»t
 +ğ
t
.
¦’
 != 0;

3430 
	`debug
 (".\tbmid2tb¡¸(%s, %d, %dèğ%s", 
	`dumpB¡ršg
 (
b1
), 
Ëá
, 
Ën
, dumpB¡ršg (
b3
));

3431 
	`bde¡roy
 (
b3
);

3434 ià(
»t
) {

3435 
	`debug
 ("\t\tçu»(%dèğ%d (» ğ%p", 
__LINE__
, 
»t
, 
»s
);

3436 ià(
»s
è
	`debug
 (" = \"%s\"",„es);

3437 
	`debug
 (")");

3439  
»t
;

3440 
	}
}

3442 
	$‹¡41
 () {

3443 
»t
 = 0;

3445 
	`debug
 ("TEST: int bmid2tbstr (structagbstring &t, const_bstring b1, int†eft, int†en);");

3448 
»t
 +ğ
	`‹¡41_0
 (
NULL
, 0, 1, NULL);

3449 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, 
NULL
);

3450 
»t
 +ğ
	`‹¡41_0
 (
NULL
, 0, 1, "");

3451 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, 
NULL
);

3452 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, 
NULL
);

3453 
»t
 +ğ
	`‹¡41_0
 (&
badB¡ršg1
, 0, 1, 
NULL
);

3454 
»t
 +ğ
	`‹¡41_0
 (&
badB¡ršg2
, 0, 1, 
NULL
);

3457 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, "");

3458 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 1, 3, "ogu");

3459 
»t
 +ğ
	`‹¡41_0
 (&
em±yB¡ršg
, 0, 1, "");

3460 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 1, 3, "ogu");

3461 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, -1, 4, "bog");

3462 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 1, 9, "ogus");

3463 
»t
 +ğ
	`‹¡41_0
 (&
shÜtB¡ršg
, 9, 1, "");

3465 
	`debug
 ("\t# fau»s: %d", 
»t
);

3466  
»t
;

3467 
	}
}

3469 
	$‹¡42_0
 (
cÚ¡_b¡ršg
 
bi
, 
Ën
, cÚ¡ * 
»s
) {

3470 
b¡ršg
 
b
;

3471 
rv
, 
»t
 = 0;

3473 
rv
 = 
	`bŒunc
 (
b
 = 
	`b¡rıy
 (
bi
), 
Ën
);

3474 
»t
 +ğ(
Ën
 >ğ0è? (
rv
 < 0) : (rv >= 0);

3475 ià(
»s
è
»t
 +ğ(0 =ğ
	`bi£qc¡r
 (
b
,„es));

3476 
	`debug
 (".\tbŒunø(%s, %dèğ%s", 
	`dumpB¡ršg
 (
bi
), 
Ën
, dumpB¡ršg (
b
));

3477 
	`bde¡roy
 (
b
);

3478  
»t
;

3479 
	}
}

3481 
	$‹¡42
 () {

3482 
»t
 = 0;

3484 
	`debug
 ("TEST: int btrunc (bstring b, int‚);");

3487 
»t
 +ğ0 <ğ
	`bŒunc
 (
NULL
, 2);

3488 
»t
 +ğ0 <ğ
	`bŒunc
 (
NULL
, 0);

3489 
»t
 +ğ0 <ğ
	`bŒunc
 (
NULL
, -1);

3492 
»t
 +ğ0 <ğ
	`bŒunc
 (&
shÜtB¡ršg
, 2);

3493 
»t
 +ğ0 <ğ
	`bŒunc
 (&
shÜtB¡ršg
, 0);

3494 
»t
 +ğ0 <ğ
	`bŒunc
 (&
shÜtB¡ršg
, -1);

3496 
»t
 +ğ
	`‹¡42_0
 (&
em±yB¡ršg
, 10, "");

3497 
»t
 +ğ
	`‹¡42_0
 (&
em±yB¡ršg
, 0, "");

3498 
»t
 +ğ
	`‹¡42_0
 (&
em±yB¡ršg
, -1, 
NULL
);

3500 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, 10, "bogus");

3501 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, 3, "bog");

3502 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, 0, "");

3503 
»t
 +ğ
	`‹¡42_0
 (&
shÜtB¡ršg
, -1, 
NULL
);

3505 
	`debug
 ("\t# fau»s: %d", 
»t
);

3506  
»t
;

3507 
	}
}

3509 
	$‹¡43
 () {

3510 
gb¡ršg
 
ts0
 = 
	`bsStic
 ("");

3511 
gb¡ršg
 
ts1
 = 
	`bsStic
 (" ");

3512 
gb¡ršg
 
ts2
 = 
	`bsStic
 ("‡bc");

3513 
gb¡ršg
 
ts3
 = 
	`bsStic
 ("abc ");

3514 
gb¡ršg
 
ts4
 = 
	`bsStic
 ("‡bc ");

3515 
gb¡ršg
 
ts5
 = 
	`bsStic
 ("abc");

3516 
b¡ršg
 
t¡rs
[6] = { &
ts0
, &
ts1
, &
ts2
, &
ts3
, &
ts4
, &
ts5
 };

3517 
»t
 = 0;

3518 
i
;

3520 
	`debug
 ("TEST: int btfromblk*trim (structagbstring, void * s, int†);");

3522 
i
=0; i < 6; i++) {

3523 
gb¡ršg
 
t
;

3524 
b¡ršg
 
b
;

3526 
	`btäomblkÉrimws
 (
t
, 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3527 
	`bÉrimws
 (
b
 = 
	`b¡rıy
 (
t¡rs
[
i
]));

3528 ià(!
	`bi£q
 (
b
, &
t
)) {

3529 
»t
++;

3530 
	`bassign
 (
b
, &
t
);

3531 
	`debug
 ("btäomblkÉrimw çu»: <%s> -> <%s>", 
t¡rs
[
i
]->
d©a
, 
b
->data);

3533 
	`debug
 (".\tbtäomblkÉrimw (\"%s\", \"%s\", %d)", (*è
	`bd©«
 (
b
, 
NULL
), 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3534 
	`bde¡roy
 (
b
);

3536 
	`btäomblk¹rimws
 (
t
, 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3537 
	`b¹rimws
 (
b
 = 
	`b¡rıy
 (
t¡rs
[
i
]));

3538 ià(!
	`bi£q
 (
b
, &
t
)) {

3539 
»t
++;

3540 
	`bassign
 (
b
, &
t
);

3541 
	`debug
 ("btäomblk¹rimw çu»: <%s> -> <%s>", 
t¡rs
[
i
]->
d©a
, 
b
->data);

3543 
	`debug
 (".\tbtäomblk¹rimw (\"%s\", \"%s\", %d)", (*è
	`bd©«
 (
b
, 
NULL
), 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3544 
	`bde¡roy
 (
b
);

3546 
	`btäomblkŒimws
 (
t
, 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3547 
	`bŒimws
 (
b
 = 
	`b¡rıy
 (
t¡rs
[
i
]));

3548 ià(!
	`bi£q
 (
b
, &
t
)) {

3549 
»t
++;

3550 
	`bassign
 (
b
, &
t
);

3551 
	`debug
 ("btäomblkŒimw çu»: <%s> -> <%s>", 
t¡rs
[
i
]->
d©a
, 
b
->data);

3553 
	`debug
 (".\tbtäomblkŒimw (\"%s\", \"%s\", %d)", (*è
	`bd©«
 (
b
, 
NULL
), 
t¡rs
[
i
]->
d©a
,¡rs[i]->
¦’
);

3554 
	`bde¡roy
 (
b
);

3557 
	`debug
 ("\t# fau»s: %d", 
»t
);

3558  
»t
;

3559 
	}
}

3561 
	$‹¡44_0
 (cÚ¡ * 
¡r
) {

3562 
»t
 = 0, 
v
;

3563 
b¡ršg
 
b
 = 
	`bäomc¡r
("");

3565 ià(
NULL
 =ğ
¡r
) {

3566 
»t
 +ğ0 <ğ
	`bassignc¡r
 (
NULL
, "test");

3567 
	`debug
 (".\tbassignc¡¸(b = %s, NULL)", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")));

3568 
»t
 +ğ0 <ğ(
v
 = 
	`bassignc¡r
 (
b
, 
NULL
));

3569 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3570 
»t
 +ğ0 <ğ
	`bassignc¡r
 (&
shÜtB¡ršg
, 
NULL
);

3571 
	`bde¡roy
 (
b
);

3572  
»t
;

3575 
»t
 +ğ0 <ğ
	`bassignc¡r
 (
NULL
, 
¡r
);

3576 
	`debug
 (".\tbassignc¡¸(b = %s, \"%s\")", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")), 
¡r
);

3577 
»t
 +ğ0 > (
v
 = 
	`bassignc¡r
 (
b
, 
¡r
));

3578 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3579 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), 
¡r
);

3580 
»t
 +ğ((
size_t
è
b
->
¦’
è!ğ
	`¡¾’
 (
¡r
);

3581 
»t
 +ğ0 > 
	`bassignc¡r
 (
b
, "xxxxx");

3582 
	`bwr™•rÙeù
(*
b
)

3583 
	`log_šfo
(".\tbassignc¡¸(b = %s, \"%s\")", 
	`dumpB¡ršg
 (
b
), 
¡r
);

3584 
»t
 +ğ0 <ğ(
v
 = 
	`bassignc¡r
 (
b
, 
¡r
));

3585 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3586 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), "xxxxx");

3587 
»t
 +ğ((
size_t
è
b
->
¦’
è!ğ
	`¡¾’
 ("xxxxx");

3588 
	`bwr™—Îow
(*
b
)

3589 
»t
 +ğ0 <ğ
	`bassignc¡r
 (&
shÜtB¡ršg
, 
¡r
);

3590 
	`bde¡roy
 (
b
);

3591 
	`debug
 (".\tbassignc¡¸× = %s, \"%s\")", 
	`dumpB¡ršg
 (&
shÜtB¡ršg
), 
¡r
);

3592 
»t
 +ğ0 <ğ(
v
 = 
	`bassignc¡r
 (&
shÜtB¡ršg
, 
¡r
));

3593 
	`debug
 (" = %d;‡ -> %s", 
v
, 
	`dumpB¡ršg
 (&
shÜtB¡ršg
));

3594  
»t
;

3595 
	}
}

3597 
	$‹¡44
 () {

3598 
»t
 = 0;

3600 
	`debug
 ("TEST: int bassigncstr (bstring‡, char * str);");

3603 
»t
 +ğ
	`‹¡44_0
 (
NULL
);

3605 
»t
 +ğ
	`‹¡44_0
 (
EMPTY_STRING
);

3606 
»t
 +ğ
	`‹¡44_0
 (
SHORT_STRING
);

3607 
»t
 +ğ
	`‹¡44_0
 (
LONG_STRING
);

3609 
	`debug
 ("\t# fau»s: %d", 
»t
);

3610  
»t
;

3611 
	}
}

3613 
	$‹¡45_0
 (cÚ¡ * 
¡r
) {

3614 
»t
 = 0, 
v
, 
Ën
;

3615 
b¡ršg
 
b
 = 
	`bäomc¡r
("");

3616 ià(
NULL
 =ğ
¡r
) {

3617 
»t
 +ğ0 <ğ
	`bassignblk
 (
NULL
, "test", 4);

3618 
	`debug
 (".\tbassignblk (b = %s, NULL, 1)", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")));

3619 
»t
 +ğ0 <ğ(
v
 = 
	`bassignblk
 (
b
, 
NULL
, 1));

3620 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3621 
»t
 +ğ0 <ğ
	`bassignblk
 (&
shÜtB¡ršg
, 
NULL
, 1);

3622 
	`bde¡roy
 (
b
);

3623  
»t
;

3626 
Ën
 = (è
	`¡¾’
 (
¡r
);

3627 
»t
 +ğ0 <ğ
	`bassignblk
 (
NULL
, 
¡r
, 
Ën
);

3628 
	`debug
 (".\tbassignblk (b = %s, \"%s\", %d)", 
	`dumpB¡ršg
 (
b
 = 
	`bäomc¡r
 ("")), 
¡r
, 
Ën
);

3629 
»t
 +ğ0 > (
v
 = 
	`bassignblk
 (
b
, 
¡r
, 
Ën
));

3630 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3631 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), 
¡r
);

3632 
»t
 +ğ
b
->
¦’
 !ğ
Ën
;

3633 
»t
 +ğ0 > 
	`bassignc¡r
 (
b
, "xxxxx");

3634 
	`bwr™•rÙeù
(*
b
)

3635 
	`debug
 (".\tbassignblk (b = %s, \"%s\", %d)", 
	`dumpB¡ršg
 (
b
), 
¡r
, 
Ën
);

3636 
»t
 +ğ0 <ğ(
v
 = 
	`bassignblk
 (
b
, 
¡r
, 
Ën
));

3637 
	`debug
 (" = %d; b -> %s", 
v
, 
	`dumpB¡ršg
 (
b
));

3638 
»t
 +ğ0 !ğ
	`¡rcmp
 (
	`bd©«
 (
b
, ""), "xxxxx");

3639 
»t
 +ğ((
size_t
è
b
->
¦’
è!ğ
	`¡¾’
 ("xxxxx");

3640 
	`bwr™—Îow
(*
b
)

3641 
»t
 +ğ0 <ğ
	`bassignblk
 (&
shÜtB¡ršg
, 
¡r
, 
Ën
);

3642 
	`bde¡roy
 (
b
);

3643 
	`debug
 (".\tbassignblk (¨ğ%s, \"%s\", %d)", 
	`dumpB¡ršg
 (&
shÜtB¡ršg
), 
¡r
, 
Ën
);

3644 
»t
 +ğ0 <ğ(
v
 = 
	`bassignblk
 (&
shÜtB¡ršg
, 
¡r
, 
Ën
));

3645 
	`debug
 (" = %d;‡ -> %s", 
v
, 
	`dumpB¡ršg
 (&
shÜtB¡ršg
));

3646  
»t
;

3647 
	}
}

3649 
	$‹¡45
 () {

3650 
»t
 = 0;

3652 
	`debug
 ("TEST: int bassignblk (bstring‡, const void * s, int†en);");

3655 
»t
 +ğ
	`‹¡45_0
 (
NULL
);

3657 
»t
 +ğ
	`‹¡45_0
 (
EMPTY_STRING
);

3658 
»t
 +ğ
	`‹¡45_0
 (
SHORT_STRING
);

3659 
»t
 +ğ
	`‹¡45_0
 (
LONG_STRING
);

3661 
	`debug
 ("\t# fau»s: %d", 
»t
);

3662  
»t
;

3663 
	}
}

3665 
	$‹¡46_0
 (
cÚ¡_b¡ršg
 
r
, 
b¡ršg
 
b
, 
couÁ
, cÚ¡ * 
fmt
, ...) {

3666 
»t
;

3667 
va_li¡
 
¬gli¡
;

3669 
	`debug
 (".\tbvcfÜm©¨(%s, %d, \"%s\", ...è-> ", 
	`dumpB¡ršg
 (
b
), 
couÁ
, 
fmt
);

3670 
	`va_¡¬t
 (
¬gli¡
, 
fmt
);

3671 
»t
 = 
	`bvcfÜm©a
 (
b
, 
couÁ
, 
fmt
, 
¬gli¡
);

3672 
	`va_’d
 (
¬gli¡
);

3673 
	`debug
 ("%d, % (%s)", 
»t
, 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3674 ià(
»t
 < 0è (
NULL
 !ğ
r
);

3675 
»t
 +ğ1 !ğ
	`bi£q
 (
r
, 
b
);

3676 ià(0 !ğ
»t
è
	`debug
 ("\t->failed");

3677  
»t
;

3678 
	}
}

3680 
	$‹¡46_1
 (
b¡ršg
 
b
, cÚ¡ * 
fmt
, 
cÚ¡_b¡ršg
 
r
, ...) {

3681 
»t
;

3683 
	`debug
 (".\tbvfÜm©¨(&, %s, \"%s\", ...è-> ", 
	`dumpB¡ršg
 (
b
), 
fmt
);

3684 
	`bvfÜm©a
 (
»t
, 
b
, 
fmt
, 
r
);

3685 
	`debug
 ("%d, % (%s)", 
»t
, 
	`dumpB¡ršg
 (
b
), dumpB¡ršg (
r
));

3686 ià(
»t
 < 0è (
NULL
 !ğ
r
);

3687 
»t
 +ğ1 !ğ
	`bi£q
 (
r
, 
b
);

3688 ià(0 !ğ
»t
è
	`debug
 ("\t->failed");

3689  
»t
;

3690 
	}
}

3692 
	$‹¡46
 () {

3693 
b¡ršg
 
b
;

3694 
»t
 = 0;

3696 
	`debug
 ("TEST: int bvcformata (bstring b, int count, const char * fmt, va_list‡rg);");

3698 
»t
 +ğ
	`‹¡46_0
 (
NULL
, NULL, 8, "[%d]", 15);

3699 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
shÜtB¡ršg
, 8, "[%d]", 15);

3700 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
badB¡ršg1
, 8, "[%d]", 15);

3701 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
badB¡ršg2
, 8, "[%d]", 15);

3702 
»t
 +ğ
	`‹¡46_0
 (
NULL
, &
badB¡ršg3
, 8, "[%d]", 15);

3704 
b
 = 
	`bäomc¡r
 ("");

3705 
»t
 +ğ
	`‹¡46_0
 (&
shÜtB¡ršg
, 
b
, shÜtB¡ršg.
¦’
, "%s", (*èshÜtB¡ršg.
d©a
);

3706 
b
->
¦’
 = 0;

3707 
»t
 +ğ
	`‹¡46_0
 (&
shÜtB¡ršg
, 
b
, shÜtB¡ršg.
¦’
 + 1, "%s", (*èshÜtB¡ršg.
d©a
);

3708 
b
->
¦’
 = 0;

3709 
»t
 +ğ
	`‹¡46_0
 (
NULL
, 
b
, 
shÜtB¡ršg
.
¦’
-1, "%s", (*èshÜtB¡ršg.
d©a
);

3711 
	`debug
 ("TEST: bvformata (int &ret, bstring b, const char * fmt, <type>†astarg);");

3713 
»t
 +ğ
	`‹¡46_1
 (
NULL
, "[%d]", NULL, 15);

3714 
»t
 +ğ
	`‹¡46_1
 (&
shÜtB¡ršg
, "[%d]", 
NULL
, 15);

3715 
»t
 +ğ
	`‹¡46_1
 (&
badB¡ršg1
, "[%d]", 
NULL
, 15);

3716 
»t
 +ğ
	`‹¡46_1
 (&
badB¡ršg2
, "[%d]", 
NULL
, 15);

3717 
»t
 +ğ
	`‹¡46_1
 (&
badB¡ršg3
, "[%d]", 
NULL
, 15);

3719 
b
->
¦’
 = 0;

3720 
»t
 +ğ
	`‹¡46_1
 (
b
, "%s", &
shÜtB¡ršg
, (*èshÜtB¡ršg.
d©a
);

3722 
b
->
¦’
 = 0;

3723 
»t
 +ğ
	`‹¡46_1
 (
b
, "%s", &
lÚgB¡ršg
, (*èlÚgB¡ršg.
d©a
);

3725 
	`bde¡roy
 (
b
);

3726 
	`debug
 ("\t# fau»s: %d", 
»t
);

3727  
»t
;

3728 
	}
}

3730 
	$skmaš
 (
¬gc
, * 
¬gv
[])

3732 
FILE
 *
log_fe
 = 
	`fİ’
("tests/tests.log", "a+");

3733 
	`£tbuf
(
log_fe
, 
NULL
);

3734 
	`dbg_£t_log
(
log_fe
);

3736 
»t
 = 0;

3738 
¬gc
 =‡rgc;

3739 
¬gv
 =‡rgv;

3741 
	`debug
 ("Direct caseesting of bstring core functions");

3743 
»t
 +ğ
	`‹¡0
 ();

3744 
»t
 +ğ
	`‹¡1
 ();

3745 
»t
 +ğ
	`‹¡2
 ();

3746 
»t
 +ğ
	`‹¡3
 ();

3747 
»t
 +ğ
	`‹¡4
 ();

3748 
»t
 +ğ
	`‹¡5
 ();

3749 
»t
 +ğ
	`‹¡6
 ();

3750 
»t
 +ğ
	`‹¡7
 ();

3751 
»t
 +ğ
	`‹¡8
 ();

3752 
»t
 +ğ
	`‹¡9
 ();

3753 
»t
 +ğ
	`‹¡10
 ();

3754 
»t
 +ğ
	`‹¡11
 ();

3755 
»t
 +ğ
	`‹¡12
 ();

3756 
»t
 +ğ
	`‹¡13
 ();

3757 
»t
 +ğ
	`‹¡14
 ();

3758 
»t
 +ğ
	`‹¡15
 ();

3759 
»t
 +ğ
	`‹¡16
 ();

3760 
»t
 +ğ
	`‹¡17
 ();

3761 
»t
 +ğ
	`‹¡18
 ();

3762 
»t
 +ğ
	`‹¡19
 ();

3763 
»t
 +ğ
	`‹¡20
 ();

3764 
»t
 +ğ
	`‹¡21
 ();

3765 
»t
 +ğ
	`‹¡22
 ();

3766 
»t
 +ğ
	`‹¡23
 ();

3767 
»t
 +ğ
	`‹¡24
 ();

3768 
»t
 +ğ
	`‹¡25
 ();

3769 
»t
 +ğ
	`‹¡26
 ();

3770 
»t
 +ğ
	`‹¡27
 ();

3771 
»t
 +ğ
	`‹¡28
 ();

3772 
»t
 +ğ
	`‹¡29
 ();

3773 
»t
 +ğ
	`‹¡30
 ();

3774 
»t
 +ğ
	`‹¡31
 ();

3775 
»t
 +ğ
	`‹¡32
 ();

3776 
»t
 +ğ
	`‹¡33
 ();

3777 
»t
 +ğ
	`‹¡34
 ();

3778 
»t
 +ğ
	`‹¡35
 ();

3779 
»t
 +ğ
	`‹¡36
 ();

3780 
»t
 +ğ
	`‹¡37
 ();

3781 
»t
 +ğ
	`‹¡38
 ();

3782 
»t
 +ğ
	`‹¡39
 ();

3783 
»t
 +ğ
	`‹¡40
 ();

3784 
»t
 +ğ
	`‹¡41
 ();

3785 
»t
 +ğ
	`‹¡42
 ();

3786 
»t
 +ğ
	`‹¡43
 ();

3787 
»t
 +ğ
	`‹¡44
 ();

3788 
»t
 +ğ
	`‹¡45
 ();

3789 
»t
 +ğ
	`‹¡46
 ();

3791 
	`debug
 ("#e¡ b¡¸çu»s: %d", 
»t
);

3793 
	`debug
 ("Direct caseesting of bstraux functions");

3795 
»t
 +ğ
	`‹¡aux0
 ();

3796 
»t
 +ğ
	`‹¡aux1
 ();

3797 
»t
 +ğ
	`‹¡aux2
 ();

3798 
»t
 +ğ
	`‹¡aux3
 ();

3799 
»t
 +ğ
	`‹¡aux4
 ();

3800 
»t
 +ğ
	`‹¡aux5
 ();

3801 
»t
 +ğ
	`‹¡aux6
 ();

3802 
»t
 +ğ
	`‹¡aux7
 ();

3803 
»t
 +ğ
	`‹¡aux8
 ();

3804 
»t
 +ğ
	`‹¡aux9
 ();

3805 
»t
 +ğ
	`‹¡aux10
 ();

3806 
»t
 +ğ
	`‹¡aux11
 ();

3807 
»t
 +ğ
	`‹¡aux12
 ();

3809 if(
»t
 > 0) {

3810 
	`´štf
("FAILED: %d fau» š b¡¾ib", 
»t
);

3813 
	`debug
 ("#e¡‡ux fau»s: %d", 
»t
);

3815  
»t
;

3816 
	}
}

	@tools/tests/cache_tests.c

1 
	~"mšun™.h
"

2 
	~<ÿche.h
>

3 
	~<as£¹.h
>

5 
	gÏ¡_eviùed
;

6 
	$‹¡_eviù
(*
d©a
) {

7 
Ï¡_eviùed
 = (è
d©a
;

8 
	}
}

10 
	$‹¡_lookup
(*
d©a
, *
key
) {

11  
d©a
 =ğ
key
;

12 
	}
}

14 *
	$‹¡_ÿche_eviù
()

16 
Ï¡_eviùed
 = -1;

18 
Cache
 *
ÿche
 = 
	`Cache_ü—‹
(
MIN_CACHE_SIZE
, 
‹¡_lookup
, 
‹¡_eviù
);

19 
	`mu_as£¹
(
ÿche
 !ğ
NULL
, "Failedo create cache");

21 
i
;

22 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

23 
	`Cache_add
(
ÿche
, (*è
i
);

24 
	`mu_as£¹
(
Ï¡_eviùed
 == -1, "Evicted somethingooƒarly");

27 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

28 
	`Cache_add
(
ÿche
, (*è
i
 + 
MIN_CACHE_SIZE
);

29 
	`mu_as£¹
(
Ï¡_eviùed
 =ğ
i
, "Evicted something out of order");

32 
	`Cache_de¡roy
(
ÿche
);

33  
NULL
;

34 
	}
}

36 *
	$‹¡_ÿche_mªu®_eviù
()

38 
Ï¡_eviùed
 = -1;

40 
Cache
 *
ÿche
 = 
	`Cache_ü—‹
(
MIN_CACHE_SIZE
, 
‹¡_lookup
, 
‹¡_eviù
);

41 
	`mu_as£¹
(
ÿche
 !ğ
NULL
, "Failedo create cache");

43 
i
;

44 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

45 
	`Cache_add
(
ÿche
, (*è
i
);

46 
	`mu_as£¹
(
Ï¡_eviùed
 == -1, "Evicted somethingooƒarly");

50 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

51 
	`Cache_eviù_objeù
(
ÿche
, (*è
i
);

52 
	`mu_as£¹
(
Ï¡_eviùed
 =ğ
i
, "Evicted something out of order");

55 
Ï¡_eviùed
 = -1;

56 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

57 
	`Cache_add
(
ÿche
, (*è
i
);

58 
	`mu_as£¹
(
Ï¡_eviùed
 == -1, "The cache wasn'tƒmpty'");

61 
	`Cache_de¡roy
(
ÿche
);

62  
NULL
;

63 
	}
}

65 *
	$‹¡_ÿche_lookup
()

67 
Cache
 *
ÿche
 = 
	`Cache_ü—‹
(
MIN_CACHE_SIZE
, 
‹¡_lookup
, 
‹¡_eviù
);

68 
	`mu_as£¹
(
ÿche
 !ğ
NULL
, "Failedo create cache");

69 
™em
;

71 
i
;

72 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

73 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
i
);

74 
	`mu_as£¹
(
™em
 == 0, "Found somethinghat wasn'there");

77 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++è
	`Cache_add
(
ÿche
, (*) i);

79 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

80 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
i
);

81 
	`mu_as£¹
(
™em
 =ğ
i
, "Did‚ot find somethinghat should behere");

84 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++è
	`Cache_add
(
ÿche
, (*) (i * 2));

86 
i
 = 1; i <ğ
MIN_CACHE_SIZE
; i++) {

87 
f
 = 
i
 * 2;

88 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
f
);

89 
	`mu_as£¹
(
™em
 =ğ
f
, "Did‚ot find somethinghat should behere");

90 
nf
 = 
f
 - 1;

91 
™em
 = (è
	`Cache_lookup
(
ÿche
, (*è
nf
);

92 
	`mu_as£¹
(
™em
 == 0, "Found somethinghat wasn'there");

95 
	`Cache_de¡roy
(
ÿche
);

97  
NULL
;

98 
	}
}

100 *
	$®l_‹¡s
() {

101 
	`mu_su™e_¡¬t
();

103 
	`mu_run_‹¡
(
‹¡_ÿche_eviù
);

104 
	`mu_run_‹¡
(
‹¡_ÿche_mªu®_eviù
);

105 
	`mu_run_‹¡
(
‹¡_ÿche_lookup
);

107  
NULL
;

108 
	}
}

110 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/config_tests.c

1 
	~"mšun™.h
"

2 
	~<zmq.h
>

3 
	~"£rv”.h
"

4 
	~"cÚfig/cÚfig.h
"

5 
	~"cÚfig/db.h
"

6 
	~"cÚfig/moduË.h
"

7 
	~"mime.h
"

8 
	~"£‰šg.h
"

10 *
	$‹¡_CÚfig_lßd_£‰šgs
()

12 
	`CÚfig_š™_db
("tests/config.sqlite");

14 
rc
 = 
	`CÚfig_lßd_£‰šgs
();

15 
	`debug
("LOADED %d SETTINGS", 
rc
);

16 
	`mu_as£¹
(
rc
 > 0, "Failedo†oadhe„ight‚umber of settings.");

18 
	`CÚfig_şo£_db
();

19 
	`S‘tšg_de¡roy
();

21  
NULL
;

22 
	}
}

24 
gb¡ršg
 
	gTEST_MIME
 = 
bsStic
("/test.txt");

26 *
	$‹¡_CÚfig_lßd_mim‘y³s
()

28 
	`CÚfig_š™_db
("tests/config.sqlite");

30 
rc
 = 
	`CÚfig_lßd_mim‘y³s
();

31 
	`debug
("LOADED %d MIME TYPES", 
rc
);

32 
	`mu_as£¹
(
rc
 > 2, "Failedo†oadhe„ight‚umber of mimetypes.");

34 
	`mu_as£¹
(
	`MIME_m©ch_ext
(&
TEST_MIME
, 
NULL
) != NULL, "Mime†oad failed.");

35 
	`CÚfig_şo£_db
();

36 
	`MIME_de¡roy
();

37  
NULL
;

38 
	}
}

40 *
	$‹¡_CÚfig_lßd
()

42 
	`CÚfig_š™_db
("tests/config.sqlite");

43 
S”v”
 *
£rv”
 = 
	`CÚfig_lßd_£rv”
("AC1F8236-5919-4696-9D40-0F38DE9E5861");

44 
	`mu_as£¹
(
£rv”
 !ğ
NULL
, "Failedo†oad server");

46 
	`S”v”_de¡roy
(
£rv”
);

47 
	`CÚfig_şo£_db
();

49  
NULL
;

50 
	}
}

52 *
	$‹¡_CÚfig_lßd_moduË
()

54 
rc
 = 
	`CÚfig_moduË_lßd
("tools/config_modules/null.so");

55 
	`mu_as£¹
(
rc
 == 0, "Failedo†oadhe‚ull module.");

57 
rc
 = 
CONFIG_MODULE
.
	`š™
("goodpath");

58 
	`mu_as£¹
(
rc
 == 0, "The‚ull module should fail init.");

60 
rc
 = 
CONFIG_MODULE
.
	`š™
("badpath");

61 
	`mu_as£¹
(
rc
 == -1, "The‚ull module should fail init.");

63  
NULL
;

64 
	}
}

67 * 
	$®l_‹¡s
()

69 
	`mu_su™e_¡¬t
();

71 
	`S”v”_š™
();

73 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd_mim‘y³s
);

74 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd_£‰šgs
);

75 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd
);

76 
	`mu_run_‹¡
(
‹¡_CÚfig_lßd_moduË
);

78 
	`zmq_‹rm
(
ZMQ_CTX
);

80  
NULL
;

81 
	}
}

83 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/connection_tests.c

1 
	~"mšun™.h
"

2 
	~<cÚÃùiÚ.h
>

3 
	~<uni¡d.h
>

4 
	~<sys/ty³s.h
>

5 
	~<fú.h
>

6 
	~<zmq.h
>

7 
	~<sk/sk.h
>

8 
	~<dœ.h
>

10 
S”v”
 *
	gSRV
 = 
NULL
;

12 *
	$‹¡_CÚÃùiÚ_ü—‹_de¡roy
()

14 cÚ¡ 
»mÙe
[
IPADDR_SIZE
];

16 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 0, 0, 
»mÙe
);

17 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo create‡ connection.");

18 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

20  
NULL
;

21 
	}
}

23 *
	$‹¡_CÚÃùiÚ_d–iv”
()

25 
b¡ršg
 
t1
;

26 cÚ¡ 
»mÙe
[
IPADDR_SIZE
];

27 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 1, 0, 
»mÙe
);

28 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo create‡ connection.");

30 
rc
 = 
	`CÚÃùiÚ_d–iv”
(
cÚn
, 
t1
 = 
	`bäomc¡r
("TEST"));

32 
	`mu_as£¹
(
rc
 == -1, "Should NOT be‡bleo write.");

34 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

35 
	`bde¡roy
(
t1
);

37  
NULL
;

38 
	}
}

40 
	$‹¡_sk_w™h_§m¶e
(cÚ¡ *
§m¶e_fe
)

42 
	`check
(
SRV
, "Server isn't configured.");

44 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
SRV
, 12, 1400, "127.0.0.1");

45 
	`check
(
cÚn
, "Failedo createhe conn.");

47 
	`£Áš–
("REWRITE NEEDED");

49 
	`CÚÃùiÚ_sk
(
cÚn
);

52 
”rÜ
:

54 
	}
}

56 *
	$‹¡_CÚÃùiÚ_sk
()

68  
NULL
;

69 
	}
}

71 * 
	$®l_‹¡s
() {

72 
	`mu_su™e_¡¬t
();

74 
	`S”v”_š™
();

75 
S”v”
 *
SRV
 = 
	`S”v”_ü—‹
(

76 
	`bäomc¡r
("uuid"),

77 
	`bäomc¡r
("localhost"),

78 
	`bäomc¡r
("0.0.0.0"),

80 
	`bäomc¡r
("chroot"),

81 
	`bäomc¡r
("access_log"),

82 
	`bäomc¡r
("error_log"),

83 
	`bäomc¡r
("pid_file"), 0);

85 
Ho¡
 *
zedshaw_com
 = 
	`Ho¡_ü—‹
(
	`bäomc¡r
("zedshaw.com"), bfromcstr("zedshaw.com"));

87 
	`Ho¡_add_back’d
(
zedshaw_com
, 
	`bäomc¡r
("@ch©"), 
BACKEND_HANDLER
, 
NULL
);

89 
Dœ
 *
‹¡s
 = 
	`Dœ_ü—‹
(

90 
	`bäomc¡r
("tests/"),

91 
	`bäomc¡r
("index.html"),

92 
	`bäomc¡r
("text/plain"),

95 
	`Ho¡_add_back’d
(
zedshaw_com
, 
	`bäomc¡r
("/‹¡s"), 
BACKEND_DIR
, 
‹¡s
);

97 
	`S”v”_£t_deçuÉ_ho¡
(
SRV
, 
zedshaw_com
);

99 
	`mu_run_‹¡
(
‹¡_CÚÃùiÚ_ü—‹_de¡roy
);

100 
	`mu_run_‹¡
(
‹¡_CÚÃùiÚ_d–iv”
);

101 
	`mu_run_‹¡
(
‹¡_CÚÃùiÚ_sk
);

103 
	`S”v”_de¡roy
(
SRV
);

105 
	`Ho¡_de¡roy
(
zedshaw_com
);

106 
	`zmq_‹rm
(
ZMQ_CTX
);

107  
NULL
;

108 
	}
}

110 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/darray_tests.c

1 
	~"mšun™.h
"

2 
	~<adt/d¬¿y.h
>

4 *
	$‹¡_d¬¿y_İ”©iÚs
()

6 
d¬¿y_t
 *
¬¿y
 = 
	`d¬¿y_ü—‹
((), 100);

7 
	`mu_as£¹
(
¬¿y
 !ğ
NULL
, "darray_create failed.");

8 
	`mu_as£¹
(
¬¿y
->
cÚ‹Ás
 !ğ
NULL
, "contents‡re wrong in darray");

9 
	`mu_as£¹
(
¬¿y
->
’d
 == 0, "end isn't‡the„ight spot");

10 
	`mu_as£¹
(
¬¿y
->
–em’t_size
 == (), "element size is wrong.");

11 
	`mu_as£¹
(
¬¿y
->
max
 == 100, "wrong max†ength on initial size");

13 *
v®1
 = 
	`d¬¿y_Ãw
(
¬¿y
);

14 
	`mu_as£¹
(
v®1
 !ğ
NULL
, "failedo make‡‚ewƒlement");

16 *
v®2
 = 
	`d¬¿y_Ãw
(
¬¿y
);

17 
	`mu_as£¹
(
v®2
 !ğ
NULL
, "failedo make‡‚ewƒlement");

19 
	`d¬¿y_£t
(
¬¿y
, 0, 
v®1
);

20 
	`d¬¿y_£t
(
¬¿y
, 1, 
v®2
);

22 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 0è=ğ
v®1
, "Wrong first value.");

23 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 1è=ğ
v®2
, "Wrong second value.");

25 *
v®_check
 = 
	`d¬¿y_»move
(
¬¿y
, 0);

26 
	`mu_as£¹
(
v®_check
 !ğ
NULL
, "Should‚ot get NULL.");

27 
	`mu_as£¹
(*
v®_check
 =ğ*
v®1
, "Should gethe first value.");

28 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 0è=ğ
NULL
, "Should be gone.");

29 
	`ä“
(
v®_check
);

31 
v®_check
 = 
	`d¬¿y_»move
(
¬¿y
, 1);

32 
	`mu_as£¹
(
v®_check
 !ğ
NULL
, "Should‚ot get NULL.");

33 
	`mu_as£¹
(*
v®_check
 =ğ*
v®2
, "Should gethe first value.");

34 
	`mu_as£¹
(
	`d¬¿y_g‘
(
¬¿y
, 1è=ğ
NULL
, "Should be gone.");

35 
	`ä“
(
v®_check
);

37 
Şd_max
 = 
¬¿y
->
max
;

38 
	`d¬¿y_ex·nd
(
¬¿y
);

39 
	`mu_as£¹
(
¬¿y
->
max
 =ğ
Şd_max
 +‡¼ay->
ex·nd_¿‹
, "Wrong size‡fterƒxpand.");

41 
	`d¬¿y_cÚŒaù
(
¬¿y
);

42 
	`mu_as£¹
(
¬¿y
->
max
 =ğ¬¿y->
ex·nd_¿‹
 + 1, "Should stay‡theƒxpand_rate‡t†east.");

44 
	`d¬¿y_cÚŒaù
(
¬¿y
);

45 
	`mu_as£¹
(
¬¿y
->
max
 =ğ¬¿y->
ex·nd_¿‹
 + 1, "Should stay‡theƒxpand_rate‡t†east.");

47 
i
 = 0;

48 
i
 = 0; i < 1000; i++) {

49 *
v®
 = 
	`d¬¿y_Ãw
(
¬¿y
);

50 *
v®
 = 
i
 * 333;

51 
	`d¬¿y_push
(
¬¿y
, 
v®
);

54 
	`mu_as£¹
(
¬¿y
->
max
 == 1201, "Wrong max size.");

56 
i
 = 999; i > 0; i--) {

57 *
v®
 = 
	`d¬¿y_pİ
(
¬¿y
);

58 
	`mu_as£¹
(
v®
 !ğ
NULL
, "Shouldn't get‡ NULL.");

59 
	`mu_as£¹
(*
v®
 =ğ
i
 * 333, "Wrong value.");

60 
	`ä“
(
v®
);

63 
	`d¬¿y_de¡roy
(
¬¿y
);

65  
NULL
;

66 
	}
}

69 * 
	$®l_‹¡s
() {

70 
	`mu_su™e_¡¬t
();

72 
	`mu_run_‹¡
(
‹¡_d¬¿y_İ”©iÚs
);

74  
NULL
;

75 
	}
}

77 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/db_tests.c

1 
	~"mšun™.h
"

2 
	~<cÚfig/db.h
>

3 
	~<dbg.h
>

5 *
	$‹¡_DB_š™
()

7 
	`mu_as£¹
(
	`DB_š™
("tests/empty.sqlite") == 0, "Database init failed.");

9  
NULL
;

10 
	}
}

12 *
	$‹¡_DB_şo£
()

14 
	`DB_şo£
();

16  
NULL
;

17 
	}
}

19 
gb¡ršg
 
	gEMPTY_RESULT
 = 
bsStic
("0:~");

21 
	$check_»suÉ
(
Šs_v®ue_t
 *
»s
, 
b¡ršg
 
ex³ùšg
)

23 *
v®
 = 
NULL
;

24 
size_t
 
Ën
 = 0;

26 
	`check
(
»s
 !ğ
NULL
, "Got NULL for„esult.");

27 
v®
 = 
	`Šs_»nd”
(
»s
, &
Ën
);

28 
	`check
(
v®
 !ğ
NULL
, "Failedo„ender value„esult.");

29 
	`check
(
	`bis¡emeqblk
(
ex³ùšg
, 
v®
, 
Ën
),

31 
	`bd©a
(
ex³ùšg
), ()
Ën
, 
v®
);

33 
	`ä“
(
v®
);

34 
	`Šs_v®ue_de¡roy
(
»s
);

37 
”rÜ
:

38 
	`ä“
(
v®
);

39 
	`Šs_v®ue_de¡roy
(
»s
);

41 
	}
}

43 *
	$‹¡_DB_exec
()

45 
	`DB_š™
("tests/empty.sqlite");

46 
Šs_v®ue_t
 *
»s
 = 
NULL
;

47 
cŞs
 = 0;

48 
rows
 = 0;

50 
»s
 = 
	`DB_exec
("DROP TABLE IF EXISTSesting");

51 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, &
EMPTY_RESULT
), "Dropable failed.");

53 
»s
 = 
	`DB_exec
("CREATE TABLEesting (name TEXT,‡ge INT)");

54 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

55 
	`mu_as£¹
(
rows
 == 0, "Should be 0†ength„esult.");

56 
	`mu_as£¹
(
cŞs
 == 0, "Should be 0 cols‡s well.");

57 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, &
EMPTY_RESULT
), "Createable failed");

59 
»s
 = 
	`DB_exec
("INSERT INTOesting VALUES ('Zed',35)");

60 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, &
EMPTY_RESULT
), "Insert failed");

62 
b¡ršg
 
£Ëù_»suÉ
 = 
	`bäomc¡r
("15:11:3:Zed,2:35#]]");

63 
»s
 = 
	`DB_exec
("SELECT * FROMesting");

64 
	`mu_as£¹
(
	`Šs_g‘_ty³
(
»s
è=ğ
Šs_g_li¡
, "Wrongype, should get‡†ist from select.");

68 
rows
 = 
	`DB_couÁs
(
»s
, &
cŞs
);

69 
	`mu_as£¹
(
rows
 != -1, "Failedo gethe counts ofhe„esult.");

70 
	`mu_as£¹
(
rows
 == 1, "Should get one„ow.");

71 
	`mu_as£¹
(
cŞs
 == 2, "Should getwo cols.");

73 
b¡ršg
 
Çme
 = 
	`DB_g‘_as
(
»s
, 0, 0, 
¡ršg
);

74 
	`mu_as£¹
(
	`bi£qc¡r
(
Çme
, "Zed"), "Wrong value for column 0.");

76 
age
 = 
	`DB_g‘_as
(
»s
, 0, 1, 
numb”
);

77 
	`debug
("GOT AGE: %d", 
age
);

78 
	`mu_as£¹
(
age
 == 35, "Wrong value for column 1.");

81 
i
 = 0;

82 
j
 = 0;

83 
i
 = 0; i < 
rows
; i++) {

84 
j
 = 0; j < 
cŞs
; j++) {

85 
Šs_v®ue_t
 *
–
 = 
	`DB_g‘
(
»s
, 
i
, 
j
);

86 
	`mu_as£¹
(
	`Šs_g‘_ty³
(
–
è!ğ
Šs_g_šv®id
, "Value should‚ot be invalid(NULL)");

91 
	`mu_as£¹
(
	`DB_g‘
(
»s
, 100, 0è=ğ
NULL
, "Should‚ot work with insane„ows.");

92 
	`mu_as£¹
(
	`DB_g‘
(
»s
, 0, 100è=ğ
NULL
, "Should‚ot work with insane cols.");

93 
	`mu_as£¹
(
	`DB_g‘
(
»s
, 32, 87è=ğ
NULL
, "Should‚ot work with insane cols‡nd„ows.");

95 
	`mu_as£¹
(
	`check_»suÉ
(
»s
, 
£Ëù_»suÉ
), "Select failed.");

96 
	`bde¡roy
(
£Ëù_»suÉ
);

99 
	`mu_as£¹
(
	`DB_couÁs
(
NULL
, &
cŞs
) == -1, "Should‡bort on NULL.");

100 
	`mu_as£¹
(
	`DB_g‘
(
NULL
, 0, 0) == NULL, "Should‡bort on NULL.");

102  
NULL
;

103 
	}
}

105 * 
	$®l_‹¡s
() {

106 
	`mu_su™e_¡¬t
();

108 
	`mu_run_‹¡
(
‹¡_DB_š™
);

109 
	`mu_run_‹¡
(
‹¡_DB_şo£
);

110 
	`mu_run_‹¡
(
‹¡_DB_exec
);

112 
	`DB_şo£
();

114  
NULL
;

115 
	}
}

117 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/dict_tests.c

1 
	~"mšun™.h
"

2 
	~<»gi¡”.h
>

3 
	~<adt/diù.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<ùy³.h
>

7 
	~<¡dlib.h
>

8 
	~<¡d¬g.h
>

10 
	tšput_t
[256];

12 
	$tok’ize
(*
¡ršg
, ...)

14 **
tok±r
;

15 
va_li¡
 
¬gli¡
;

16 
tokcouÁ
 = 0;

18 
	`va_¡¬t
(
¬gli¡
, 
¡ršg
);

19 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

20 
tok±r
) {

21 *
¡ršg
 && 
	`is¥aû
(() *string))

22 
¡ršg
++;

23 ià(!*
¡ršg
)

25 *
tok±r
 = 
¡ršg
;

26 *
¡ršg
 && !
	`is¥aû
(() *string))

27 
¡ršg
++;

28 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

29 
tokcouÁ
++;

30 ià(!*
¡ršg
)

32 *
¡ršg
++ = 0;

34 
	`va_’d
(
¬gli¡
);

36  
tokcouÁ
;

37 
	}
}

39 
	$com·»f
(cÚ¡ *
key1
, cÚ¡ *
key2
)

41  
	`¡rcmp
(
key1
, 
key2
);

42 
	}
}

44 *
	$dup¡ršg
(*
¡r
)

46 
sz
 = 
	`¡¾’
(
¡r
) + 1;

47 *
Ãw
 = 
	`m®loc
(
sz
);

48 ià(
Ãw
)

49 
	`memıy
(
Ãw
, 
¡r
, 
sz
);

50  
Ãw
;

51 
	}
}

53 
dnode_t
 *
	$Ãw_node
(*
c
)

55 
dnode_t
 
ãw
[5];

56 
couÁ
;

58 ià(
couÁ
 < 5)

59  
ãw
 + 
couÁ
++;

61  
NULL
;

62 
	}
}

64 
	$d–_node
(
dnode_t
 *
n
, *
c
)

66 
	}
}

68 
	g´om±
 = 0;

70 
	$cÚ¡ruù
(
diù_t
 *
d
)

72 
šput_t
 
š
;

73 
dÚe
 = 0;

74 
diù_lßd_t
 
dl
;

75 
dnode_t
 *
dn
;

76 *
tok1
, *
tok2
, *
v®
;

77 cÚ¡ *
key
;

78 *
h–p
 =

83 ià(!
	`diù_i£m±y
(
d
))

84 
	`puts
("warning: dictionary‚otƒmpty!");

86 
	`diù_lßd_begš
(&
dl
, 
d
);

88 !
dÚe
) {

89 ià(
´om±
)

90 
	`putch¬
('>');

91 
	`fæush
(
¡dout
);

93 ià(!
	`fg‘s
(
š
, (
šput_t
), 
¡dš
))

96 
š
[0]) {

98 
	`puts
(
h–p
);

101 
´om±
 = 1;

104 
dÚe
 = 1;

107 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

108 
	`puts
("what?");

111 
key
 = 
	`dup¡ršg
(
tok1
);

112 
v®
 = 
	`dup¡ršg
(
tok2
);

113 
dn
 = 
	`dnode_ü—‹
(
v®
);

115 ià(!
key
 || !
v®
 || !
dn
) {

116 
	`puts
("out of memory");

117 
	`ä“
((*è
key
);

118 
	`ä“
(
v®
);

119 ià(
dn
)

120 
	`dnode_de¡roy
(
dn
);

123 
	`diù_lßd_Ãxt
(&
dl
, 
dn
, 
key
);

126 
	`putch¬
('?');

127 
	`putch¬
('\n');

132 
	`diù_lßd_’d
(&
dl
);

133 
	}
}

135 *
	$‹¡_diù_İ”©iÚs
()

137 
šput_t
 
š
;

138 
diù_t
 
d¬¿y
[10];

139 
diù_t
 *
d
 = &
d¬¿y
[0];

140 
dnode_t
 *
dn
;

141 
i
;

142 *
tok1
, *
tok2
, *
v®
;

143 cÚ¡ *
key
;

144 
FILE
 *
d©a
 = 
	`fİ’
("tests/adt_data.txt", "r");

145 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Couldn't†oadest data.");

147 *
h–p
 =

164 
i
 = 0; i <  
d¬¿y
 /  *darray; i++)

165 
	`diù_š™
(&
d¬¿y
[
i
], 
DICTCOUNT_T_MAX
, 
com·»f
);

168 ià(
´om±
)

169 
	`putch¬
('>');

170 
	`fæush
(
¡dout
);

172 ià(!
	`fg‘s
(
š
, (
šput_t
), 
d©a
))

175 
š
[0]) {

177 
	`puts
(
h–p
);

180 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

181 
	`puts
("what?");

184 
key
 = 
	`dup¡ršg
(
tok1
);

185 
v®
 = 
	`dup¡ršg
(
tok2
);

187 ià(!
key
 || !
v®
) {

188 
	`puts
("out of memory");

189 
	`ä“
((*è
key
);

190 
	`ä“
(
v®
);

193 ià(!
	`diù_®loc_š£¹
(
d
, 
key
, 
v®
)) {

194 
	`puts
("dict_alloc_insert failed");

195 
	`ä“
((*è
key
);

196 
	`ä“
(
v®
);

201 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

202 
	`puts
("what?");

205 
dn
 = 
	`diù_lookup
(
d
, 
tok1
);

206 ià(!
dn
) {

209 
v®
 = 
	`dnode_g‘
(
dn
);

210 
key
 = 
	`dnode_g‘key
(
dn
);

211 
	`diù_d–‘e_ä“
(
d
, 
dn
);

213 
	`ä“
(
v®
);

214 
	`ä“
((*è
key
);

217 
	`diù_ä“
(
d
);

222 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

223 
	`puts
("what?");

226 
dn
 = 0;

227 
š
[0]) {

229 
dn
 = 
	`diù_lookup
(
d
, 
tok1
);

232 
dn
 = 
	`diù_low”_bound
(
d
, 
tok1
);

235 
dn
 = 
	`diù_uµ”_bound
(
d
, 
tok1
);

238 ià(!
dn
) {

241 
v®
 = 
	`dnode_g‘
(
dn
);

242 
	`puts
(
v®
);

245 
	`cÚ¡ruù
(
d
);

248 
	`diù_®low_du³s
(
d
);

251 
	`´štf
("%lu\n", (è
	`diù_couÁ
(
d
));

254 
dn
 = 
	`diù_fœ¡
(
d
); dn; dÀğ
	`diù_Ãxt
(d, dn)) {

255 
	`mu_as£¹
(
	`dnode_g‘key
(
dn
è!ğ
NULL
, "invalid key");

256 
	`mu_as£¹
(
	`dnode_g‘
(
dn
è!ğ
NULL
, "invalid value");

260  
NULL
;

265 
´om±
 = 1;

268 
	`diù_£t_®loÿtÜ
(
d
, 
Ãw_node
, 
d–_node
, 
NULL
);

271 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

272 
	`puts
("what?");

275 
diùnum
 = 
	`©oi
(
tok1
);

276 ià(
diùnum
 < 0 || dictnum > 9) {

277 
	`puts
("invalid‚umber");

280 
d
 = &
d¬¿y
[
diùnum
];

284 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

285 
	`puts
("what?");

288 
diù1
 = 
	`©oi
(
tok1
), 
diù2
 =‡toi(
tok2
);

289 ià(
diù1
 < 0 || diù1 > 9 || 
diù2
 < 0 || dict2 > 9) {

290 
	`puts
("invalid‚umber");

293 
	`diù_m”ge
(&
d¬¿y
[
diù1
], &d¬¿y[
diù2
]);

297 
	`putch¬
('?');

298 
	`putch¬
('\n');

303 
	`mu_as£¹
(
	`diù_v”ify
(
d
), "Dict became invalid.");

305  
NULL
;

306 
	}
}

308 * 
	$®l_‹¡s
() {

309 
	`mu_su™e_¡¬t
();

311 
	`mu_run_‹¡
(
‹¡_diù_İ”©iÚs
);

313  
NULL
;

314 
	}
}

316 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/dir_tests.c

1 
	~"mšun™.h
"

2 
	~"dœ.h
"

3 
	~"»gi¡”.h
"

4 
	~<¡ršg.h
>

5 
	~<fú.h
>

7 *
	$‹¡_Dœ_fšd_fe
()

9 
b¡ršg
 
ùy³
 = 
NULL
;

11 
FeRecÜd
 *
fe
 = 
	`Dœ_fšd_fe
(
	`bäomc¡r
("tests/sample.json"),

12 
ùy³
 = 
	`bäomc¡r
("text/plain"));

14 
	`mu_as£¹
(
fe
 !ğ
NULL
, "Failedo findhe file.");

16 
	`FeRecÜd_de¡roy
(
fe
);

17 
	`bde¡roy
(
ùy³
);

19  
NULL
;

20 
	}
}

22 *
	$‹¡_Dœ_fšd_fe_isdœ
(){

24 
b¡ršg
 
ùy³
 = 
NULL
;

26 
FeRecÜd
 *
fe
 = 
	`Dœ_fšd_fe
(
	`bäomc¡r
("tests/"),

27 
ùy³
 = 
	`bäomc¡r
("text/plain"));

29 
	`mu_as£¹
(
fe
 !ğ
NULL
, "Failedo findhe directory.");

30 
	`mu_as£¹
(
fe
->
is_dœ
 == 1, "Did‚ot„ecognized it's‡ directory");

32 
	`FeRecÜd_de¡roy
(
fe
);

33 
	`bde¡roy
(
ùy³
);

36  
NULL
;

37 
	}
}

40 *
	$‹¡_Dœ_»sŞve_fe
()

42 
Dœ
 *
‹¡
 = 
	`Dœ_ü—‹
(

43 
	`bäomc¡r
("tests/"),

44 
	`bäomc¡r
("sample.html"),

45 
	`bäomc¡r
("test/plain"),

47 
	`mu_as£¹
(
‹¡
 !ğ
NULL
, "Failedo makeest dir.");

49 
FeRecÜd
 *
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/sample.json"));

50 
	`mu_as£¹
(
»c
 !ğ
NULL
, "Failedo„esolve filehat should behere.");

52 
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/"));

53 
	`mu_as£¹
(
»c
 !ğ
NULL
, "Failedo find default file.");

55 
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/../../../../../etc/passwd"));

56 
	`mu_as£¹
(
»c
 =ğ
NULL
, "HACK! should‚ot findhis.");

58 
	`Dœ_de¡roy
(
‹¡
);

60 
‹¡
 = 
	`Dœ_ü—‹
(

61 
	`bäomc¡r
("foobar/"),

62 
	`bäomc¡r
("sample.html"),

63 
	`bäomc¡r
("test/plan"),

65 
	`mu_as£¹
(
‹¡
 !ğ
NULL
, "Failedo makehe failed dir.");

67 
»c
 = 
	`Dœ_»sŞve_fe
(
‹¡
, 
	`bäomc¡r
("/"), bfromcstr("/sample.json"));

68 
	`mu_as£¹
(
»c
 =ğ
NULL
, "Should‚ot get something from‡ bad base directory.");

70 
	`Dœ_de¡roy
(
‹¡
);

72  
NULL
;

73 
	}
}

75 cÚ¡ *
	gREQ_PATTERN
 = "%s %s HTTP/1.1\r\n\r\n";

77 
Reque¡
 *
	$çke_»q
(cÚ¡ *
m‘hod
, cÚ¡ *
´efix
, cÚ¡ *
·th
)

79 
rc
 = 0;

80 
size_t
 
Å¬£d
 = 0;

81 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

82 
	`Reque¡_¡¬t
(
»q
);

84 
b¡ršg
 
p
 = 
	`bäomc¡r
(
·th
);

85 
b¡ršg
 
½
 = 
	`bfÜm©
(
REQ_PATTERN
, 
m‘hod
, 
	`bd©a
(
p
));

87 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
½
), 
	`bËngth
Ôp), &
Å¬£d
);

88 
»q
->
´efix
 = 
	`bäomc¡r
(prefix);

89 
»q
->
·‰”n
 = 
	`bäomc¡r
(
´efix
);

91 
	`check
(
rc
 != 0, "Failedo…arse„equest.");

92 
	`check
(
Å¬£d
 =ğ
	`bËngth
(
½
), "Failedo…arse‡ll of„equest.");

94  
»q
;

96 
”rÜ
:

97  
NULL
;

98 
	}
}

101 *
	$‹¡_Dœ_£rve_fe
()

103 
rc
 = 0;

104 
Reque¡
 *
»q
 = 
NULL
;

106 
Dœ
 *
‹¡
 = 
	`Dœ_ü—‹
(

107 
	`bäomc¡r
("tests/"),

108 
	`bäomc¡r
("sample.html"),

109 
	`bäomc¡r
("test/plain"),

112 
CÚÃùiÚ
 
cÚn
 = {.
iob
 = 
NULL
};

113 
z”o_fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

114 
cÚn
.
iob
 = 
	`IOBuf_ü—‹
(1024, 
z”o_fd
, 
IOBUF_NULL
);

116 
»q
 = 
	`çke_»q
("GET", "/", "/sample.json");

117 
rc
 = 
	`Dœ_£rve_fe
(
‹¡
, 
»q
, &
cÚn
);

121 
»q
 = 
	`çke_»q
("HEAD", "/", "/sample.json");

122 
rc
 = 
	`Dœ_£rve_fe
(
‹¡
, 
»q
, &
cÚn
);

123 
	`mu_as£¹
(
rc
 == 0, "Should servehe HEAD of /sample.json");

125 
»q
 = 
	`çke_»q
("POST", "/", "/sample.json");

126 
rc
 = 
	`Dœ_£rve_fe
(
‹¡
, 
»q
, &
cÚn
);

127 
	`mu_as£¹
(
rc
 == -1, "POST should…asshrough but send‡nƒrror.");

129  
NULL
;

130 
	}
}

132 *
	$‹¡_Dœ_£rve_big_fes
(){

134 
¡©
 
Ëss1gb
;

135 
Ëss1gb
.
¡_size
 = 858993459;

137 
¡©
 
mÜe1gb
;

138 
mÜe1gb
.
¡_size
 = 399560397;

140 *
LESS_1GB
 = "HTTP/1.1 200 OK\r\n"

146 "S”v”: " 
VERSION


149 *
MORE_1GB
 = "HTTP/1.1 200 OK\r\n"

155 "S”v”: " 
VERSION


158 
b¡ršg
 
»¥Ú£_Ëss_1gb
 = 
	`bfÜm©
(
RESPONSE_FORMAT
, "", "", 
Ëss1gb
.
¡_size
, "", "");

159 
b¡ršg
 
»¥Ú£_mÜe_1gb
 = 
	`bfÜm©
(
RESPONSE_FORMAT
, "", "", 
mÜe1gb
.
¡_size
, "", "");

161 
	`mu_as£¹
(
	`b¡rcmp
(
»¥Ú£_Ëss_1gb
, 
	`bäomc¡r
(
LESS_1GB
)) == 0, "Wrong„esponse headers for <1GB files");

162 
	`debug
("MORE_1GB=%s\n", 
MORE_1GB
);

163 
	`debug
("RESPONSE=%s\n", 
	`bd©a
(
»¥Ú£_mÜe_1gb
));

164 
	`mu_as£¹
(
	`b¡rcmp
(
»¥Ú£_mÜe_1gb
, 
	`bäomc¡r
(
MORE_1GB
)) == 0, "Wrong„esponse headers for >1GB files");

165  
NULL
;

166 
	}
}

168 * 
	$®l_‹¡s
() {

169 
	`mu_su™e_¡¬t
();

170 
	`Regi¡”_š™
();

172 
	`mu_run_‹¡
(
‹¡_Dœ_fšd_fe
);

173 
	`mu_run_‹¡
(
‹¡_Dœ_£rve_fe
);

174 
	`mu_run_‹¡
(
‹¡_Dœ_»sŞve_fe
);

175 
	`mu_run_‹¡
(
‹¡_Dœ_£rve_big_fes
);

176 
	`mu_run_‹¡
(
‹¡_Dœ_fšd_fe_isdœ
);

178  
NULL
;

179 
	}
}

181 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/filter_tests.c

1 
	~"mšun™.h
"

2 
	~<f‹r.h
>

3 
	~<cÚÃùiÚ.h
>

5 *
	$‹¡_F‹r_lßd
()

7 
S”v”
 *
¤v
 = 
NULL
;

8 
b¡ršg
 
lßd_·th
 = 
	`bäomc¡r
("tests/filters/test_filter.so");

10 
»s
 = 
	`F‹r_lßd
(
¤v
, 
lßd_·th
);

11 
	`mu_as£¹
(
»s
 == 0, "Failedo†oadests/filters/test_filter.so");

12 
	`mu_as£¹
(
	`F‹r_aùiv©ed
(), "Filters‚ot‡ctivated.");

14  
NULL
;

15 
	}
}

17 *
	$‹¡_F‹r_run
()

19 
Ãxt
 = 
	`F‹r_run
(
HANDLER
, 
NULL
);

20 
	`debug
("HANDLER„‘uºed: %d", 
Ãxt
);

22 
	`mu_as£¹
(
Ãxt
 =ğ
CLOSE
, "Wrongƒvent for callback.");

24 
	`mu_as£¹
(
	`F‹r_run
(
MSG_REQ
, 
NULL
) == MSG_REQ, "Should„eturn same for‚on-registered.");

26  
NULL
;

27 
	}
}

30 *
	$‹¡_F‹r_run_chaš
(){

32 
	`F‹r_š™
();

33 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 0, 80, "");

35 
»s_f‹r_a
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_a.so"));

36 
	`mu_as£¹
(
»s_f‹r_a
 == 0, "Failedo†oadests/filters/test_filter_a.so");

38 
»s_f‹r_b
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_b.so"));

39 
	`mu_as£¹
(
»s_f‹r_b
 == 0, "Failedo†oadests/filters/test_filter_b.so");

41 
	`F‹r_run
(
CONNECT
, 
cÚn
);

44 
	`mu_as£¹
(
cÚn
->
½Üt
 == 90, "Not‡ll filters was„un,„port‚ot correctly changed");

46  
NULL
;

47 
	}
}

49 *
	$‹¡_F‹r_¡İ_f‹r_chaš
(){

50 
	`F‹r_š™
();

51 
CÚÃùiÚ
 *
cÚn
 = 
	`CÚÃùiÚ_ü—‹
(
NULL
, 0, 80, "");

53 
»s_f‹r_a
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_a.so"));

54 
	`mu_as£¹
(
»s_f‹r_a
 == 0, "Failedo†oadests/filters/test_filter_a.so");

56 
»s_f‹r_c
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_c.so"));

57 
	`mu_as£¹
(
»s_f‹r_c
 == 0, "Failedo†oadests/filters/test_filter_c.so");

59 
»s_f‹r_b
 = 
	`F‹r_lßd
(
NULL
, 
	`bäomc¡r
("tests/filters/test_filter_b.so"));

60 
	`mu_as£¹
(
»s_f‹r_b
 == 0, "Failedo†oadests/filters/test_filter_b.so");

62 
Ãxt
 = 
	`F‹r_run
(
CONNECT
, 
cÚn
);

63 
	`mu_as£¹
(
Ãxt
 =ğ
CLOSE
, "Last filter‚ot„un correctly");

66 
	`mu_as£¹
(
cÚn
->
½Üt
 == 87, "Not‡ll filters should be„un");

68  
NULL
;

69 
	}
}

73 * 
	$®l_‹¡s
() {

74 
	`mu_su™e_¡¬t
();

76 
	`mu_run_‹¡
(
‹¡_F‹r_lßd
);

77 
	`mu_run_‹¡
(
‹¡_F‹r_run
);

78 
	`mu_run_‹¡
(
‹¡_F‹r_run_chaš
);

79 
	`mu_run_‹¡
(
‹¡_F‹r_¡İ_f‹r_chaš
);

81  
NULL
;

82 
	}
}

84 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/filters/test_filter.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6  
CLOSE
;

7 
	}
}

10 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

12 
S‹Ev’t
 
¡©es
[] = {
HANDLER
};

13 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

14 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

16  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

18 
”rÜ
:

19  
NULL
;

20 
	}
}

	@tools/tests/filters/test_filter_a.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6 
cÚn
->
½Üt
 += 2;

7  
¡©e
;

8 
	}
}

11 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

13 
S‹Ev’t
 
¡©es
[] = {
CONNECT
};

14 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

15 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

17  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

19 
”rÜ
:

20  
NULL
;

21 
	}
}

	@tools/tests/filters/test_filter_b.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6 
cÚn
->
½Üt
 += 8;

7  
¡©e
;

8 
	}
}

11 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

13 
S‹Ev’t
 
¡©es
[] = {
CONNECT
};

14 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

15 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

17  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

19 
”rÜ
:

20  
NULL
;

21 
	}
}

	@tools/tests/filters/test_filter_c.c

1 
	~<f‹r.h
>

2 
	~<dbg.h
>

4 
S‹Ev’t
 
	$f‹r_Œªs™iÚ
(
S‹Ev’t
 
¡©e
, 
CÚÃùiÚ
 *
cÚn
)

6 
cÚn
->
½Üt
 += 5;

7  
CLOSE
;

8 
	}
}

11 
S‹Ev’t
 *
	$f‹r_š™
(
S”v”
 *
¤v
, 
b¡ršg
 
lßd_·th
, *
out_n¡©es
)

13 
S‹Ev’t
 
¡©es
[] = {
CONNECT
};

14 *
out_n¡©es
 = 
	`F‹r_¡©es_Ëngth
(
¡©es
);

15 
	`check
(*
out_n¡©es
 == 1, "Wrong state‡rray†ength.");

17  
	`F‹r_¡©e_li¡
(
¡©es
, *
out_n¡©es
);

19 
”rÜ
:

20  
NULL
;

21 
	}
}

	@tools/tests/handler_parser_tests.c

1 
	~"mšun™.h
"

2 
	~<hªdËr_·r£r.h
>

3 
	~<b¡ršg.h
>

5 
	$‹¡_·r£
(cÚ¡ *
‹¡
, 
rg‘_couÁ
)

7 
HªdËrP¬£r
 *
·r£r
 = 
	`HªdËrP¬£r_ü—‹
(128);

9 
b¡ršg
 
T1
 = 
	`bäomc¡r
(
‹¡
);

11 
rc
 = 
	`HªdËrP¬£r_execu‹
(
·r£r
, 
	`bd©a
(
T1
), 
	`bËngth
(T1));

13 
	`bde¡roy
(
T1
);

15  
rc
 =ğ1 && 
rg‘_couÁ
 =ğ
·r£r
->target_count;

16 
	}
}

18 
	#TEST
(
T
, 
C
, 
M
è
	`mu_as£¹
(
	`‹¡_·r£
(T, Cè=ğ1, "FaedØ·r£: " #M);

	)

19 
	#TEST_FAIL
(
T
, 
C
, 
M
è
	`mu_as£¹
(
	`‹¡_·r£
(T, Cè=ğ0, "SHOULD faØ·r£: " #M);

	)

21 *
	$‹¡_HªdËrP¬£r_execu‹
()

23 
	`TEST
("5a9a6354-fc33-4468-8ccd-5d736737dad7 2:12, The body", 1, "T1");

24 
	`TEST
("5a9a6354-fc33-4468-8ccd-5d736737dad7 11:0 1 2 3 4 5, The body", 6, "T2");

25 
	`TEST
("5a9a6354-fc33-4468-8ccd-5d736737dad7 5:12 34, Another body.", 2, "T3");

26 
	`TEST
("5a9a6354fc3344688ccd5d736737dad7 5:12 34, ", 2, "EMPTY");

28 
	`TEST_FAIL
("this.is.wrong 5:12 34, ", 2, "BAD UUID");

29 
	`TEST_FAIL
("5a9a6354fc3344688ccd5d736737dad7 10:12 34, ", 2, "TOO LONG NETSTRING");

30 
	`TEST_FAIL
("5a9a6354fc3344688ccd5d736737dad7 3:12 34, ", 2, "TOO SHORT NETSTRING");

31 
	`TEST_FAIL
("5a9a6354fc3344688ccd5d736737dad7 5:12 34,", 2, "NO TRAILING SPACE");

32 
	`TEST_FAIL
(" 5:12 34,", 2, "NO UUID");

34  
NULL
;

35 
	}
}

39 * 
	$®l_‹¡s
() {

40 
	`mu_su™e_¡¬t
();

42 
	`mu_run_‹¡
(
‹¡_HªdËrP¬£r_execu‹
);

44  
NULL
;

45 
	}
}

47 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/handler_tests.c

2 
	~"mšun™.h
"

3 
	~<hªdËr.h
>

4 
	~<¡ršg.h
>

5 
	~<sk/sk.h
>

8 *
	$‹¡_HªdËr_»cv_ü—‹
()

10 *
sock‘
 = 
	`HªdËr_»cv_ü—‹
("tcp://127.0.0.1:4321", "ZED");

11 
	`mu_as£¹
(
sock‘
 !ğ
NULL
, "Failedo make„ecv socket.");

12 
	`zmq_şo£
(
sock‘
);

13  
NULL
;

14 
	}
}

16 *
	$‹¡_HªdËr_£nd_ü—‹
()

19 *
sock‘
 = 
	`HªdËr_£nd_ü—‹
("tcp://127.0.0.1:12345", "ZED");

20 
	`mu_as£¹
(
sock‘
 !ğ
NULL
, "Failedo makehe send socket.");

22 
	`zmq_şo£
(
sock‘
);

24  
NULL
;

25 
	}
}

27 *
	$‹¡_HªdËr_d–iv”
()

29 *
sock‘
 = 
	`HªdËr_£nd_ü—‹
("tcp://127.0.0.1:12346", "ZED");

30 #ifdeà
ZMQ_LINGER


31 
İt
 = 0;

32 
	`zmq_£tsockİt
(
sock‘
, 
ZMQ_LINGER
, &
İt
, (opt));

35 
	`mu_as£¹
(
sock‘
 !ğ
NULL
, "Failedo makehe send socket.");

37 
b¡ršg
 
mes§ge
 = 
	`bäomc¡r
("{\"type\":\"join\"}");

38 
rc
 = 
	`HªdËr_d–iv”
(
sock‘
, 
	`bd©a
(
mes§ge
), 
	`bËngth
(message));

39 
	`ä“
(
mes§ge
);

41 
	`mu_as£¹
(
rc
 == 0, "Failedo deliverhe message.");

43 
	`zmq_şo£
(
sock‘
);

44  
NULL
;

45 
	}
}

48 *
	$‹¡_HªdËr_ü—‹_de¡roy
()

50 
HªdËr
 *
hªdËr
 = 
	`HªdËr_ü—‹
(

51 
	`bäomc¡r
("tcp://127.0.0.1:12348"),

52 
	`bäomc¡r
("ZED"),

53 
	`bäomc¡r
("tcp://127.0.0.1:4321"),

54 
	`bäomc¡r
("ZED"));

55 
	`mu_as£¹
(
hªdËr
 !ğ
NULL
, "Failedo makehe handler.");

57 
	`HªdËr_de¡roy
(
hªdËr
);

59  
NULL
;

60 
	}
}

62 * 
	$®l_‹¡s
() {

63 
	`mu_su™e_¡¬t
();

64 
	`mqš™
(2);

66 
	`mu_run_‹¡
(
‹¡_HªdËr_£nd_ü—‹
);

67 
	`mu_run_‹¡
(
‹¡_HªdËr_»cv_ü—‹
);

69 
	`mu_run_‹¡
(
‹¡_HªdËr_ü—‹_de¡roy
);

71 
	`zmq_‹rm
(
ZMQ_CTX
);

72  
NULL
;

73 
	}
}

75 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/hash_tests.c

1 
	~"mšun™.h
"

2 
	~<»gi¡”.h
>

3 
	~<adt/hash.h
>

5 
	~<¡dio.h
>

6 
	~<ùy³.h
>

7 
	~<¡d¬g.h
>

9 
	tšput_t
[256];

11 
	$tok’ize
(*
¡ršg
, ...)

13 **
tok±r
;

14 
va_li¡
 
¬gli¡
;

15 
tokcouÁ
 = 0;

17 
	`va_¡¬t
(
¬gli¡
, 
¡ršg
);

18 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

19 
tok±r
) {

20 *
¡ršg
 && 
	`is¥aû
(() *string))

21 
¡ršg
++;

22 ià(!*
¡ršg
)

24 *
tok±r
 = 
¡ršg
;

25 *
¡ršg
 && !
	`is¥aû
(() *string))

26 
¡ršg
++;

27 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

28 
tokcouÁ
++;

29 ià(!*
¡ršg
)

31 *
¡ršg
++ = 0;

33 
	`va_’d
(
¬gli¡
);

35  
tokcouÁ
;

36 
	}
}

38 *
	$dup¡ršg
(*
¡r
)

40 
sz
 = 
	`¡¾’
(
¡r
) + 1;

41 *
Ãw
 = 
	`m®loc
(
sz
);

42 ià(
Ãw
)

43 
	`memıy
(
Ãw
, 
¡r
, 
sz
);

44  
Ãw
;

45 
	}
}

47 
hnode_t
 *
	$Ãw_node
(*
c
)

49 
hnode_t
 
ãw
[5];

50 
couÁ
;

52 ià(
couÁ
 < 5)

53  
ãw
 + 
couÁ
++;

55  
NULL
;

56 
	}
}

58 
	$d–_node
(
hnode_t
 *
n
, *
c
)

60 
	}
}

62 *
	$‹¡_hash_İ”©iÚs
()

64 
šput_t
 
š
;

65 
hash_t
 *
h
 = 
	`hash_ü—‹
(
HASHCOUNT_T_MAX
, 0, 0);

66 
hnode_t
 *
hn
;

67 
hsÿn_t
 
hs
;

68 *
tok1
, *
tok2
, *
v®
;

69 cÚ¡ *
key
;

70 
´om±
 = 0;

71 
FILE
 *
d©a
 = 
	`fİ’
("tests/adt_data.txt", "r");

72 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Couldn't†oadest data.");

74 *
h–p
 =

88 ià(!
h
)

89 
	`puts
("hash_create failed");

92 ià(
´om±
)

93 
	`putch¬
('>');

94 
	`fæush
(
¡dout
);

97 ià(!
	`fg‘s
(
š
, (
šput_t
), 
d©a
))

100 
š
[0]) {

102 
	`puts
(
h–p
);

105 
	`´štf
("%d\n", 
hash_v®_t_b™
);

108 ià(
	`tok’ize
(
š
+1, &
tok1
, &
tok2
, (**) 0) != 2) {

109 
	`puts
("what?");

112 
key
 = 
	`dup¡ršg
(
tok1
);

113 
v®
 = 
	`dup¡ršg
(
tok2
);

115 ià(!
key
 || !
v®
) {

116 
	`puts
("out of memory");

117 
	`ä“
((*è
key
);

118 
	`ä“
(
v®
);

121 ià(!
	`hash_®loc_š£¹
(
h
, 
key
, 
v®
)) {

122 
	`puts
("hash_alloc_insert failed");

123 
	`ä“
((*è
key
);

124 
	`ä“
(
v®
);

129 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

130 
	`puts
("what?");

133 
hn
 = 
	`hash_lookup
(
h
, 
tok1
);

134 ià(!
hn
) {

137 
v®
 = 
	`hnode_g‘
(
hn
);

138 
key
 = 
	`hnode_g‘key
(
hn
);

139 
	`hash_sÿn_d–ä“
(
h
, 
hn
);

140 
	`ä“
((*è
key
);

141 
	`ä“
(
v®
);

144 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

145 
	`puts
("what?");

148 
hn
 = 
	`hash_lookup
(
h
, 
tok1
);

149 ià(!
hn
) {

152 
v®
 = 
	`hnode_g‘
(
hn
);

153 
	`puts
(
v®
);

156 
	`´štf
("%lu\n", (è
	`hash_size
(
h
));

159 
	`´štf
("%lu\n", (è
	`hash_couÁ
(
h
));

162 
	`hash_sÿn_begš
(&
hs
, 
h
);

163 (
hn
 = 
	`hash_sÿn_Ãxt
(&
hs
))) {

164 
	`mu_as£¹
(
	`hnode_g‘key
(
hn
è!ğ
NULL
, "invalid key");

165 
	`mu_as£¹
(
	`hnode_g‘
(
hn
è!ğ
NULL
, "invalid value");

169  
NULL
;

174 
´om±
 = 1;

177 
	`hash_£t_®loÿtÜ
(
h
, 
Ãw_node
, 
d–_node
, 
NULL
);

180 
	`putch¬
('?');

181 
	`putch¬
('\n');

186 
	`mu_as£¹
(
	`hash_v”ify
(
h
), "Hash became invalid.");

188  
NULL
;

189 
	}
}

191 * 
	$®l_‹¡s
() {

192 
	`mu_su™e_¡¬t
();

194 
	`mu_run_‹¡
(
‹¡_hash_İ”©iÚs
);

196  
NULL
;

197 
	}
}

199 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/host_tests.c

1 
	~"mšun™.h
"

2 
	~<ho¡.h
>

4 * 
	$‹¡_ü—‹_de¡roy
() {

5 
Ho¡
 *
ho¡
 = 
	`Ho¡_ü—‹
(
	`bäomc¡r
("zedshaw.com"), bfromcstr("zedshaw.com"));

7 
	`mu_as£¹
(
ho¡
 !ğ
NULL
, "Failedo make host.");

9 
	`Ho¡_de¡roy
(
ho¡
);

11  
NULL
;

12 
	}
}

14 *
	$®l_‹¡s
() {

15 
	`mu_su™e_¡¬t
();

17 
	`mu_run_‹¡
(
‹¡_ü—‹_de¡roy
);

19  
NULL
;

20 
	}
}

22 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/http11_tests.c

1 
	~"mšun™.h
"

2 
	~<h‰p11/h‰p11_·r£r.h
>

3 
	~<glob.h
>

4 
	~<b¡ršg.h
>

6 
	$debug_–em’t_cb
(*
d©a
, cÚ¡ *
©
, 
size_t
 
Ëngth
)

8 
	}
}

10 
	$debug_f›ld_cb
(*
d©a
, cÚ¡ *
f›ld
, 
size_t
 
æ’
, cÚ¡ *
v®ue
, size_ˆ
vËn
)

12 
	}
}

14 
h‰p_·r£r
 
	$£tup_·r£r
()

16 
h‰p_·r£r
 
p
;

17 
p
.
h‰p_f›ld
 = 
debug_f›ld_cb
;

18 
p
.
»que¡_m‘hod
 = 
debug_–em’t_cb
;

19 
p
.
»que¡_uri
 = 
debug_–em’t_cb
;

20 
p
.
äagm’t
 = 
debug_–em’t_cb
;

21 
p
.
»que¡_·th
 = 
debug_–em’t_cb
;

22 
p
.
qu”y_¡ršg
 = 
debug_–em’t_cb
;

23 
p
.
h‰p_v”siÚ
 = 
debug_–em’t_cb
;

24 
p
.
h—d”_dÚe
 = 
debug_–em’t_cb
;

26 
	`h‰p_·r£r_š™
(&
p
);

28  
p
;

29 
	}
}

31 *
	$‹¡_h‰p11_·r£r_basics
()

33 
h‰p_·r£r
 
p
 = 
	`£tup_·r£r
();

34 
rc
 = 0;

36 
rc
 = 
	`h‰p_·r£r_fšish
(&
p
);

37 
	`mu_as£¹
(
rc
 == 0, "Should NOT be finished if‚othing…arsed.");

39 
rc
 = 
	`h‰p_·r£r_has_”rÜ
(&
p
);

40 
	`mu_as£¹
(
rc
 == 0, "Should‚ot have‡nƒrror‡the beginning.");

42 
rc
 = 
	`h‰p_·r£r_is_fšished
(&
p
);

43 
	`mu_as£¹
(
rc
 == 0, "Should‚ot be finished since‚ever handed‡nything.");

44  
NULL
;

45 
	}
}

47 *
	$‹¡_·r£r_th¿shšg
()

49 
glob_t
 
‹¡_fes
;

50 
i
 = 0;

51 
Å¬£d
 = 0;

52 
d–
 = 0;

53 
‹¡s_run
 = 0;

54 
execs_run
 = 0;

55 
unfšished
 = 0;

56 
”rÜs
 = 0;

58 
rc
 = 
	`glob
("‹¡s/ªd_su™e/*", 0, 
NULL
, &
‹¡_fes
);

59 
	`mu_as£¹
(
rc
 == 0, "Failedo glob file sinests/and_suite/*");

61 
i
 = 0; i < 
‹¡_fes
.
gl_·thc
; i++) {

62 
FILE
 *
šfe
 = 
	`fİ’
(
‹¡_fes
.
gl_·thv
[
i
], "r");

63 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

65 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

66 
	`fşo£
(
šfe
);

67 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

69 
‹¡s_run
++;

71 
h‰p_·r£r
 
p
 = 
	`£tup_·r£r
();

73 
Å¬£d
 = 0;

74 
d–
 = 0;

76 
Å¬£d
 < 
	`bËngth
(
d©a
)) {

77 
	`debug
("jsÚ PARSING: %d oà%d‡ˆ%s", 
Å¬£d
, 
	`bËngth
(
d©a
), 
	`bd©aofs
(data,‚parsed));

79 
d–
 = 
	`h‰p_·r£r_execu‹
(&
p
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
Å¬£d
);

80 
execs_run
++;

82 if(
d–
 == 0) { ; }

84 if(!
	`h‰p_·r£r_fšish
(&
p
)) {

85 
unfšished
++;

88 
Å¬£d
 +ğ
d–
;

90 if(
	`h‰p_·r£r_has_”rÜ
(&
p
)) {

91 
”rÜs
++;

94 
	`debug
("TEST %s„esults: delta %d, has_error: %d, is_finished: %d",

95 
‹¡_fes
.
gl_·thv
[
i
],

96 
Å¬£d
, 
	`h‰p_·r£r_has_”rÜ
(&
p
), 
	`h‰p_·r£r_is_fšished
(&p));

98 
	`h‰p_·r£r_š™
(&
p
);

102 
	`debug
("HTTP PARSING:ests_run: %d,ƒxecs_run: %d, unfinished: %d,ƒrrors: %d",

103 
‹¡s_run
, 
execs_run
, 
unfšished
, 
”rÜs
);

105  
NULL
;

106 
	}
}

109 * 
	$®l_‹¡s
() {

110 
	`mu_su™e_¡¬t
();

112 
	`mu_run_‹¡
(
‹¡_h‰p11_·r£r_basics
);

113 
	`mu_run_‹¡
(
‹¡_·r£r_th¿shšg
);

115  
NULL
;

116 
	}
}

118 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/httpclient_tests.c

2 
	~"mšun™.h
"

3 
	~<h‰p11/h‰pş›Á_·r£r.h
>

4 
	~<glob.h
>

5 
	~<b¡ršg.h
>

8 
h‰pş›Á_·r£r
 
	$£tup_·r£r
()

10 
h‰pş›Á_·r£r
 
p
;

11 
	`h‰pş›Á_·r£r_š™
(&
p
);

12 
p
.
h‰p_f›ld
 = 
NULL
;

13 
p
.
»asÚ_ph¿£
 = 
NULL
;

14 
p
.
¡©us_code
 = 
NULL
;

15 
p
.
chunk_size
 = 
NULL
;

16 
p
.
h‰p_v”siÚ
 = 
NULL
;

17 
p
.
h—d”_dÚe
 = 
NULL
;

18 
p
.
Ï¡_chunk
 = 
NULL
;

20  
p
;

21 
	}
}

23 *
	$‹¡_h‰pş›Á_·r£r_basics
()

25 
h‰pş›Á_·r£r
 
p
 = 
	`£tup_·r£r
();

26 
p
.
d©a
 = &p;

27 
rc
 = 0;

29 
rc
 = 
	`h‰pş›Á_·r£r_fšish
(&
p
);

30 
	`mu_as£¹
(
rc
 == 0, "Client…arser SHOULD be finished if‚othing…arsed.");

32 
rc
 = 
	`h‰pş›Á_·r£r_has_”rÜ
(&
p
);

33 
	`mu_as£¹
(
rc
 == 0, "Should‚ot have‡nƒrror‡the beginning.");

35 
rc
 = 
	`h‰pş›Á_·r£r_is_fšished
(&
p
);

36 
	`mu_as£¹
(
rc
 == 0, "Should‚ot be finished since‚ever handed‡nything.");

37  
NULL
;

38 
	}
}

40 
b¡ršg
 
	$lßd_‹¡_ÿ£
(cÚ¡ *
·th
)

42 
FILE
 *
šfe
 = 
	`fİ’
(
·th
, "r");

43 
	`check
(
šfe
 !ğ
NULL
, "Failedo openest file.");

45 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

46 
	`fşo£
(
šfe
);

47 
	`check
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

49  
d©a
;

51 
”rÜ
:

52 if(
šfe
è
	`fşo£
(infile);

53  
NULL
;

54 
	}
}

56 *
	$‹¡_·r£r_th¿shšg
()

58 
glob_t
 
‹¡_fes
;

59 
i
 = 0;

60 
Å¬£d
 = 0;

61 
‹¡s_run
 = 0;

62 
execs_run
 = 0;

63 
unfšished
 = 0;

64 
”rÜs
 = 0;

66 
rc
 = 
	`glob
("‹¡s/ş›Á_su™e/*", 0, 
NULL
, &
‹¡_fes
);

67 
	`mu_as£¹
(
rc
 == 0, "Failedo glob file sinests/client_suite/*");

69 
i
 = 0; i < 
‹¡_fes
.
gl_·thc
; i++) {

70 
	`debug
("TESTING: %s", 
‹¡_fes
.
gl_·thv
[
i
]);

71 
b¡ršg
 
d©a
 = 
	`lßd_‹¡_ÿ£
(
‹¡_fes
.
gl_·thv
[
i
]);

72 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo†oadest case.");

74 
‹¡s_run
++;

76 
h‰pş›Á_·r£r
 
p
 = 
	`£tup_·r£r
();

77 
p
.
d©a
 = &p;

79 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(&
p
, 
	`bd©a
(
d©a
), 
	`bËngth
(data), 0);

80 
execs_run
++;

82 if(!
	`h‰pş›Á_·r£r_fšish
(&
p
)) {

83 
unfšished
++;

86 if(
	`h‰pş›Á_·r£r_has_”rÜ
(&
p
)) {

87 
”rÜs
++;

88 
	`debug
("TEST %s„esults: delta %d, has_error: %d, is_finished: %d",

89 
‹¡_fes
.
gl_·thv
[
i
],

90 
Å¬£d
, 
	`h‰pş›Á_·r£r_has_”rÜ
(&
p
),

91 
	`h‰pş›Á_·r£r_is_fšished
(&
p
));

92 } if(
p
.
chunked
) {

93 
¡¬t
 = 
p
.
body_¡¬t
;

96 
	`h‰pş›Á_·r£r_š™
(&
p
);

98 
Å¬£d
 = 
	`h‰pş›Á_·r£r_execu‹
(&
p
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
¡¬t
);

99 
	`mu_as£¹
(
p
.
body_¡¬t
 > 
¡¬t
, "Didn't go…ast start.");

100 
	`mu_as£¹
(
p
.
chunked
, "Should still be chunked.");

101 
¡¬t
 = 
p
.
body_¡¬t
 +….
cÚ‹Á_Ën
 + 1;

103 
	`debug
("CHUNK:†ength: %d, done: %d, start: %d",

104 
p
.
cÚ‹Á_Ën
,….
chunks_dÚe
, 
¡¬t
);

105 } !
p
.
chunks_dÚe
 &&….
cÚ‹Á_Ën
 > 0 && !
	`h‰pş›Á_·r£r_has_”rÜ
(&p));

107 
	`mu_as£¹
(
p
.
chunks_dÚe
, "Should have chunks_done set.");

108 
	`mu_as£¹
(
p
.
cÚ‹Á_Ën
 == 0, "Should have 0 content_lenoo.");

112 
	`debug
("HTTP PARSING:ests_run: %d,ƒxecs_run: %d, unfinished: %d,ƒrrors: %d",

113 
‹¡s_run
, 
execs_run
, 
unfšished
, 
”rÜs
);

115  
NULL
;

116 
	}
}

119 * 
	$®l_‹¡s
() {

120 
	`mu_su™e_¡¬t
();

122 
	`mu_run_‹¡
(
‹¡_h‰pş›Á_·r£r_basics
);

123 
	`mu_run_‹¡
(
‹¡_·r£r_th¿shšg
);

125  
NULL
;

126 
	}
}

128 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/io_tests.c

2 
	~"mšun™.h
"

3 
	~<io.h
>

4 
	~<cÚÃùiÚ.h
>

5 
	~<»gi¡”.h
>

6 
	~<as£¹.h
>

7 
	~<mem/h®loc.h
>

8 
	~<fú.h
>

10 
CÚÃùiÚ
 *
	$çke_cÚn
(cÚ¡ *
fe
, 
mode
) {

11 
CÚÃùiÚ
 *
cÚn
 = 
	`h_ÿÎoc
((Connection), 1);

12 
	`as£¹
(
cÚn
 && "Failedo create connection.");

14 
fd
 = 
	`İ’
(
fe
, 
mode
);

15 
	`as£¹
(
fd
 != -1 && "Failedo open file.");

17 
cÚn
->
iob
 = 
	`IOBuf_ü—‹
(10 * 1024, 
fd
, 
IOBUF_FILE
);

18 
	`as£¹
(
cÚn
->
iob
 && "Failedo create iobuffer.");

19 
cÚn
->
ty³
 = 
CONN_TYPE_HTTP
;

21 
	`Regi¡”_cÚÃù
(
fd
, 
cÚn
);

23  
cÚn
;

24 
	}
}

26 
	$çke_cÚn_şo£
(
CÚÃùiÚ
 *
cÚn
)

28 
	`as£¹
(
cÚn
 && cÚn->
iob
 && "Invalid connection.");

29 
	`Regi¡”_discÚÃù
(
cÚn
->
iob
->
fd
);

30 
	`CÚÃùiÚ_de¡roy
(
cÚn
);

31 
	}
}

33 *
	$‹¡_IOBuf_»ad_İ”©iÚs
()

35 *
d©a
 = 
NULL
;

36 
ava
 = 0;

37 
CÚÃùiÚ
 *
cÚn
 = 
	`çke_cÚn
("/dev/z”o", 
O_RDONLY
);

38 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo make fake /dev/zero connection.");

39 
IOBuf
 *
buf
 = 
cÚn
->
iob
;

41 
	`IOBuf_»size
(
buf
, 31);

42 
	`mu_as£¹
(
buf
->
Ën
 == 31, "Wrong size‡fter„esize.");

44 
d©a
 = 
	`IOBuf_¡¬t
(
buf
);

45 
ava
 = 
	`IOBuf_ava
(
buf
);

46 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Didn't get‡ data„esponse on begin.");

47 
	`mu_as£¹
(
d©a
 =ğ
buf
->buf, "Begin on fresh iobuf should be‡the beginning.");

48 
	`mu_as£¹
(
ava
 == 0, "Should‚ot have‡nything‡vailable yet.");

50 
d©a
 = 
	`IOBuf_»ad
(
buf
, 10, &
ava
);

51 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

52 
	`mu_as£¹
(
d©a
 =ğ
	`IOBuf_¡¬t
(
buf
), "First„ead should work from start.");

53 
	`mu_as£¹
(
d©a
 =ğ
buf
->buf, "First„ead should be‡t start of internal buf.");

54 
	`mu_as£¹
(
ava
 == 10, "Should get 10 bytes.");

57 
	`mu_as£¹
(!
	`IOBuf_com·ù_Ãeded
(
buf
, 10), "Should‚ot‚eed compacting for 10.");

58 
	`mu_as£¹
(
	`IOBuf_com·ù_Ãeded
(
buf
, 100), "SHOULD‚eed compacting for 100.");

60 
	`mu_as£¹
(
	`IOBuf_»ad_comm™
(
buf
, 10) != -1, "Failedo commit.");

62 
d©a
 = 
	`IOBuf_¡¬t
(
buf
);

63 
ava
 = 
	`IOBuf_ava
(
buf
);

64 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Didn't get‡ data„esponse on begin.");

65 
	`mu_as£¹
(
d©a
 !ğ
buf
->buf, "Later„eads should‚ot be‡the start.");

66 
	`mu_as£¹
(
ava
 == 21, "Should have 21 bytes‡vailable inhe buf‡lready.");

68 
d©a
 = 
	`IOBuf_»ad
(
buf
, 10, &
ava
);

69 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

70 
	`mu_as£¹
(
ava
 == 10, "Should get 10 bytes.");

72 
	`mu_as£¹
(
	`IOBuf_»ad_comm™
(
buf
, 10) != -1, "Finaly commit failed.");

75 
d©a
 = 
	`IOBuf_¡¬t
(
buf
);

76 
ava
 = 
	`IOBuf_ava
(
buf
);

77 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Didn't get‡ data„esponse on begin.");

78 
	`mu_as£¹
(
d©a
 !ğ
buf
->buf, "Later„eads should‚ot be‡the start.");

79 
	`mu_as£¹
(
ava
 == 11, "Should have 11 bytes‡vailable inhe buf‡lready.");

83 
d©a
 = 
	`IOBuf_»ad
(
buf
, 5, &
ava
);

84 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

85 
	`mu_as£¹
(
ava
 == 5, "Should get 10 bytes.");

88 
d©a
 = 
	`IOBuf_»ad
(
buf
, 20, &
ava
);

89 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Should get something‡lways.");

90 
	`mu_as£¹
(
ava
 == 20, "Should get 10 bytes.");

92 
	`mu_as£¹
(
	`IOBuf_»ad_comm™
(
buf
, 21) != -1, "Final commit failed.");

93 
	`debug
("We'vgÙ %d‡va‡á”hÏ¡„—d.", 
buf
->
ava
);

94 
	`mu_as£¹
(
buf
->
ava
 == 10, "Should have 11 still inhe queue.");

96 
d©a
 = 
	`IOBuf_»ad_®l
(
buf
, 30, 1);

97 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„ead‡ll.");

98 
	`mu_as£¹
(
buf
->
ava
 == 1, "Should have 1 inhe queue.");

100 
d©a
 = 
	`IOBuf_»ad_some
(
buf
, &
ava
);

101 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„ead some.");

102 
	`mu_as£¹
(
buf
->
ava
 == 31, "Should be full.");

103 
	`mu_as£¹
(
ava
 == 31, "And we should gethe full‡mount.");

105 
	`çke_cÚn_şo£
(
cÚn
);

106  
NULL
;

107 
	}
}

109 *
	$‹¡_IOBuf_£nd_İ”©iÚs
()

111 
CÚÃùiÚ
 *
cÚn
 = 
	`çke_cÚn
("/dev/nuÎ", 
O_WRONLY
);

112 
	`mu_as£¹
(
cÚn
 !ğ
NULL
, "Failedo‡llocate buf.");

113 
IOBuf
 *
buf
 = 
cÚn
->
iob
;

114 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(
	`IOBuf_fd
(
buf
)è!ğ
NULL
, "Damn fd isn't„egistered.");

116 
rc
 = 
	`IOBuf_£nd
(
buf
, "012345789", 10);

117 
	`mu_as£¹
(!
	`IOBuf_şo£d
(
buf
), "Should‚ot be closed.");

118 
	`mu_as£¹
(
rc
 == 10, "Should have sent 10 bytes.");

120 
	`fdşo£
(
	`IOBuf_fd
(
buf
));

121 
rc
 = 
	`IOBuf_£nd
(
buf
, "012345789", 10);

122 
	`mu_as£¹
(
	`IOBuf_şo£d
(
buf
), "Should be closed.");

123 
	`mu_as£¹
(
rc
 == -1, "Should send‚othing.");

125 
	`çke_cÚn_şo£
(
cÚn
);

127  
NULL
;

128 
	}
}

131 *
	$‹¡_IOBuf_¡»amšg
()

134 
CÚÃùiÚ
 *
z”o
 = 
	`çke_cÚn
("/dev/z”o", 
O_RDONLY
);

135 
IOBuf
 *
äom
 = 
z”o
->
iob
;

136 
CÚÃùiÚ
 *
nuÎ
 = 
	`çke_cÚn
("/dev/nuÎ", 
O_WRONLY
);

137 
IOBuf
 *
to
 = 
nuÎ
->
iob
;

139 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 500);

140 
	`mu_as£¹
(
rc
 == 500, "Didn't streamhe„ight‡mount on smallest.");

142 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 10 * 1024);

143 
	`mu_as£¹
(
rc
 == 10 * 1024, "Didn't stream oversized‡mount.");

145 
	`fdşo£
(
äom
->
fd
);

146 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 10 * 1024);

147 
	`mu_as£¹
(
rc
 == -1, "Should fail if send side is closed.");

148 
	`mu_as£¹
(
äom
->
ava
 >= 0, "Avail should‚ever go below 0.");

150 
	`fdşo£
(
to
->
fd
);

151 
rc
 = 
	`IOBuf_¡»am
(
äom
, 
to
, 10 * 1024);

152 
	`mu_as£¹
(
rc
 == -1, "Should fail if„ecv side is closed.");

154 
	`çke_cÚn_şo£
(
z”o
);

155 
	`çke_cÚn_şo£
(
nuÎ
);

156  
NULL
;

157 
	}
}

159 * 
	$®l_‹¡s
() {

160 
	`Regi¡”_š™
();

161 
	`mu_su™e_¡¬t
();

163 
	`mu_run_‹¡
(
‹¡_IOBuf_»ad_İ”©iÚs
);

164 
	`mu_run_‹¡
(
‹¡_IOBuf_£nd_İ”©iÚs
);

165 
	`mu_run_‹¡
(
‹¡_IOBuf_¡»amšg
);

167  
NULL
;

168 
	}
}

170 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/list_tests.c

1 
	~"mšun™.h
"

2 
	~<»gi¡”.h
>

3 
	~<adt/li¡.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<ùy³.h
>

7 
	~<¡d¬g.h
>

9 
	tšput_t
[256];

11 
	$tok’ize
(*
¡ršg
, ...)

13 **
tok±r
;

14 
va_li¡
 
¬gli¡
;

15 
tokcouÁ
 = 0;

17 
	`va_¡¬t
(
¬gli¡
, 
¡ršg
);

18 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

19 
tok±r
) {

20 *
¡ršg
 && 
	`is¥aû
(() *string))

21 
¡ršg
++;

22 ià(!*
¡ršg
)

24 *
tok±r
 = 
¡ršg
;

25 *
¡ršg
 && !
	`is¥aû
(() *string))

26 
¡ršg
++;

27 
tok±r
 = 
	`va_¬g
(
¬gli¡
, **);

28 
tokcouÁ
++;

29 ià(!*
¡ršg
)

31 *
¡ršg
++ = 0;

33 
	`va_’d
(
¬gli¡
);

35  
tokcouÁ
;

36 
	}
}

38 
	$com·»f
(cÚ¡ *
key1
, cÚ¡ *
key2
)

40  
	`¡rcmp
(
key1
, 
key2
);

41 
	}
}

43 *
	$dup¡ršg
(*
¡r
)

45 
sz
 = 
	`¡¾’
(
¡r
) + 1;

46 *
Ãw
 = 
	`m®loc
(
sz
);

47 ià(
Ãw
)

48 
	`memıy
(
Ãw
, 
¡r
, 
sz
);

49  
Ãw
;

50 
	}
}

52 *
	$‹¡_li¡_İ”©iÚs
()

54 
šput_t
 
š
;

55 
li¡_t
 *
l
 = 
	`li¡_ü—‹
(
LISTCOUNT_T_MAX
);

56 
Êode_t
 *
Ê
;

57 *
tok1
, *
v®
;

58 
´om±
 = 0;

59 
FILE
 *
d©a
 = 
	`fİ’
("tests/adt_data.txt", "r");

60 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Couldn't†oadest data.");

62 *
h–p
 =

72 ià(!
l
)

73 
	`puts
("list_create failed");

76 ià(
´om±
)

77 
	`putch¬
('>');

78 
	`fæush
(
¡dout
);

81 ià(!
	`fg‘s
(
š
, (
šput_t
), 
d©a
))

84 
š
[0]) {

86 
	`puts
(
h–p
);

89 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

90 
	`puts
("what?");

93 
v®
 = 
	`dup¡ršg
(
tok1
);

94 
Ê
 = 
	`Êode_ü—‹
(
v®
);

96 ià(!
v®
 || !
Ê
) {

97 
	`puts
("allocation failure");

98 ià(
Ê
)

99 
	`Êode_de¡roy
(
Ê
);

100 
	`ä“
(
v®
);

104 
	`li¡_­³nd
(
l
, 
Ê
);

107 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

108 
	`puts
("what?");

111 
Ê
 = 
	`li¡_fšd
(
l
, 
tok1
, 
com·»f
);

112 ià(!
Ê
) {

115 
	`li¡_d–‘e
(
l
, 
Ê
);

116 
v®
 = 
	`Êode_g‘
(
Ê
);

117 
	`Êode_de¡roy
(
Ê
);

118 
	`ä“
(
v®
);

121 ià(
	`tok’ize
(
š
+1, &
tok1
, (**) 0) != 1) {

122 
	`puts
("what?");

125 
Ê
 = 
	`li¡_fšd
(
l
, 
tok1
, 
com·»f
);

128 
	`li¡_sÜt
(
l
, 
com·»f
);

131 
	`´štf
("%lu\n", (è
	`li¡_couÁ
(
l
));

134 
Ê
 = 
	`li¡_fœ¡
(
l
);†À!ğ0;†Àğ
	`li¡_Ãxt
(l,†n)) {

135 
	`mu_as£¹
(
	`Êode_g‘
(
Ê
), "invalidƒlement");

139  
NULL
;

144 
´om±
 = 1;

147 
	`putch¬
('?');

148 
	`putch¬
('\n');

153 
	`mu_as£¹
(
	`li¡_v”ify
(
l
), "List became invalid.");

155  
NULL
;

156 
	}
}

158 * 
	$®l_‹¡s
() {

159 
	`mu_su™e_¡¬t
();

161 
	`mu_run_‹¡
(
‹¡_li¡_İ”©iÚs
);

163  
NULL
;

164 
	}
}

166 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/mime_tests.c

1 
	~"mšun™.h
"

2 
	~<mime.h
>

4 *
	$‹¡_MIME_çu»s
()

6 
rc
 = 
	`MIME_add_ty³
("txt", "badtype");

7 
	`mu_as£¹
(
rc
 == -1, "Should‚ot‡cceptƒxtension with '.'");

8 
rc
 = 
	`MIME_add_ty³
("", "badtype");

9 
	`mu_as£¹
(
rc
 == -1, "Should„ejectƒmptyƒxt.");

10 
rc
 = 
	`MIME_add_ty³
(".txt", "");

11 
	`mu_as£¹
(
rc
 == -1, "Should„ejectƒmpty MIMEype.");

13  
NULL
;

14 
	}
}

17 *
	$‹¡_MIME_İs
()

19 
rc
 = 
	`MIME_add_ty³
(".txt", "text/plain");

20 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd .txt");

22 
rc
 = 
	`MIME_add_ty³
(".txt", "badtype");

23 
	`mu_as£¹
(
rc
 == -1, "Should‚ot‡dd duplicates");

25 
rc
 = 
	`MIME_add_ty³
(".json", "application/javascript");

26 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd .json");

28 
rc
 = 
	`MIME_add_ty³
(".html", "text/html");

29 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd .html");

32 
b¡ršg
 
ty³
;

33 
b¡ršg
 
t1
, 
t2
, 
t3
, 
t4
, 
t5
;

35 
ty³
 = 
	`MIME_m©ch_ext
(
t1
 = 
	`bäomc¡r
("‹¡.html"), 
NULL
);

36 
	`mu_as£¹
(
ty³
, "Didn't find .html file.");

37 
	`mu_as£¹
(
	`bi£qc¡r
(
ty³
, "text/html"), "Wrongype„eturned for.html.");

39 
ty³
 = 
	`MIME_m©ch_ext
(
t2
 = 
	`bäomc¡r
("‹¡.jsÚ"), 
NULL
);

40 
	`mu_as£¹
(
ty³
, "Didn't find .json file.");

41 
	`debug
("GOT jsÚy³: %s", 
	`bd©a
(
ty³
));

42 
	`mu_as£¹
(
	`bi£qc¡r
(
ty³
, "application/javascript"), "Wrongype„eturned for .json.");

44 
ty³
 = 
	`MIME_m©ch_ext
(
t3
 = 
	`bäomc¡r
("‹¡.ü­"), 
NULL
);

45 
	`mu_as£¹
(!
ty³
, "Should‚ot find unknownypes.");

47 
ty³
 = 
	`MIME_m©ch_ext
(
t4
 = 
	`bäomc¡r
("‹¡.ü­"), 
t5
 = bfromcstr("text/plain"));

48 
	`mu_as£¹
(
ty³
, "Should gethe defaultype.");

49 
	`mu_as£¹
(
	`bi£qc¡r
(
ty³
, "text/plain"), "Wrongype„eturned for.html.");

51 
	`bde¡roy
(
t1
);

52 
	`bde¡roy
(
t2
);

53 
	`bde¡roy
(
t3
);

54 
	`bde¡roy
(
t4
);

55 
	`bde¡roy
(
t5
);

56  
NULL
;

57 
	}
}

59 *
	$‹¡_MIME_de¡roy
()

61 
	`MIME_de¡roy
();

62  
NULL
;

63 
	}
}

66 * 
	$®l_‹¡s
() {

67 
	`mu_su™e_¡¬t
();

69 
	`mu_run_‹¡
(
‹¡_MIME_çu»s
);

70 
	`mu_run_‹¡
(
‹¡_MIME_İs
);

71 
	`mu_run_‹¡
(
‹¡_MIME_de¡roy
);

73  
NULL
;

74 
	}
}

76 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/minunit.h

1 #undeà
NDEBUG


2 #iâdeà
_mšun™_h


3 
	#_mšun™_h


	)

5 
	~<¡dio.h
>

6 
	~<dbg.h
>

7 
	~<¡dlib.h
>

9 
	#mu_su™e_¡¬t
(è*
mes§ge
 = 
NULL


	)

12 
	#mu_as£¹
(
‹¡
, 
mes§ge
èià(!Ñe¡)è{ 
	`log_”r
(mes§ge);  mes§ge; }

	)

13 
	#mu_run_‹¡
(
‹¡
è
	`debug
("\n-----%s", " " #‹¡); 
mes§ge
 = 
	`‹¡
(); 
‹¡s_run
++; ià(mes§geè mes§ge;

	)

15 
	#RUN_TESTS
(
Çme
è
	`skmaš
(
¬gc
, *
¬gv
[]) {\

16 
FILE
 *
log_fe
 = 
	`fİ’
("tests/tests.log", "a+");\

17 if(!
log_fe
è{ 
	`´štf
("CAN'T OPEN TEST LOG\n"); 
	`ex™
(1); } \

18 
	`£tbuf
(
log_fe
, 
NULL
);\

19 
	`dbg_£t_log
(
log_fe
);\

20 
	`debug
("----- RUNNING: %s", 
¬gv
[0]);\

21 
	`´štf
("----\nRUNNING: %s\n", 
¬gv
[0]);\

22 *
»suÉ
 = 
	`Çme
();\

23 ià(
»suÉ
 != 0) {\

24 
	`´štf
("FAILED: %s\n", 
»suÉ
);\

27 
	`´štf
("ALL TESTS PASSED\n");\

29 
	`´štf
("Te¡ run: %d\n", 
‹¡s_run
);\

30 
	`ex™
(
»suÉ
 != 0);\

31 }

	)

34 
	g‹¡s_run
;

	@tools/tests/pattern_tests.c

1 
	~"mšun™.h
"

2 
	~<·‰”n.h
>

3 
	~<¡ršg.h
>

5 cÚ¡ *
	gm
;

7 *
	$‹¡_sim¶e_m©ches
()

9 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZED");

10 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match†iteral identically.");

12 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z.D");

13 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match wildcard.");

15 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "FOO");

16 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

18  
NULL
;

19 
	}
}

21 *
	$‹¡_sim¶e_»³t™iÚs
()

23 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE*D");

24 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

26 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE*ED");

27 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

29 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZEEEED"), "ZE*ED");

30 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

32 
m
 = 
	`·‰”n_m©ch
("ZD", 
	`¡¾’
("ZD"), "ZE*D");

33 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

35 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZX*D");

36 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

38 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "Z.*D");

39 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

41 
m
 = 
	`·‰”n_m©ch
("ZXXXXD", 
	`¡¾’
("ZXXXXD"), "ZE.*D");

42 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

44 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE+D");

45 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

47 
m
 = 
	`·‰”n_m©ch
("ZD", 
	`¡¾’
("ZEEEED"), "ZE+D");

48 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

50 
m
 = 
	`·‰”n_m©ch
("ZEEEED", 
	`¡¾’
("ZEEEED"), "ZE-D");

51 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

53 
m
 = 
	`·‰”n_m©ch
("ZD", 
	`¡¾’
("ZEEEED"), "ZE-D");

54 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

56  
NULL
;

57 
	}
}

59 *
	$‹¡_ªchÜs
()

61 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZED$");

62 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match. Anchor‡theƒnd.");

64 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZE$");

65 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match. Should haveƒnded‡t $.'");

67 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ED");

68 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match. Implicit‡nchor‡the start of…attern.");

70  
NULL
;

71 
	}
}

73 *
	$‹¡_blocks
()

76 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZEED"), "Z(ED)");

77 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

79 
b¡ršg
 
s
 = 
	`bäomc¡r
("ZED");

80 
b¡ršg
 
p
 = 
	`bäomc¡r
("Z(ED)");

81 
m
 = 
	`b¡ršg_m©ch
(
s
, 
p
);

82 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

84 
	`bde¡roy
(
s
); bde¡roy(
p
);

85  
NULL
;

86 
	}
}

88 *
	$‹¡_äÚt›r
()

92 
m
 = 
	`·‰”n_m©ch
("THE (QUICK) brOWN FOx JUMPS",

93 
	`¡¾’
("THE (QUICK) brOWN FOx JUMPS"), "\\f[\\a]\\u-\\f[\\a]");

94 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

96  
NULL
;

97 
	}
}

99 *
	$‹¡_b®ªû
()

102 
m
 = 
	`·‰”n_m©ch
("/u£rs/{1234}", 
	`¡¾’
("/users/{1234}"), "/users/\\b{}");

103 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match balanced chars.");

105 
m
 = 
	`·‰”n_m©ch
("/u£rs/{1234", 
	`¡¾’
("/users/{1234}"), "/users/\\b{}");

106 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match balanced unchars.");

108 
m
 = 
	`·‰”n_m©ch
("/u£rs/1234}", 
	`¡¾’
("/users/{1234}"), "/users/\\b{}");

109 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match balanced unchars.");

111  
NULL
;

112 
	}
}

114 *
	$‹¡_£t
()

116 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z[OE]D");

117 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

119 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z[^OE]D");

120 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

122 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z[A-Z]D");

123 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

125  
NULL
;

126 
	}
}

128 *
	$‹¡_İtiÚ®
()

130 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "ZEE?D");

131 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

133 
m
 = 
	`·‰”n_m©ch
("ZEED", 
	`¡¾’
("ZEED"), "ZEE?D");

134 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match wildcard.");

136 
m
 = 
	`·‰”n_m©ch
("ZEEED", 
	`¡¾’
("ZEEED"), "ZEE?D");

137 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

139  
NULL
;

140 
	}
}

142 *
	$‹¡_esÿ³d
()

156 
m
 = 
	`·‰”n_m©ch
("a \t 9† . \n U w A \0", 19, "\\a \\c \\d \\l \\p \\s \\u \\w \\x \\z");

158 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

162 
m
 = 
	`·‰”n_m©ch
("ZED", 
	`¡¾’
("ZED"), "Z\\ED");

164 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

168 
m
 = 
	`·‰”n_m©ch
("*Z*E+D.", 
	`¡¾’
("*Z*E+D."), "\\*Z\\*E\\+D\\.");

170 
	`mu_as£¹
(
m
 !ğ
NULL
, "Should match.");

172 
m
 = 
	`·‰”n_m©ch
("ZED!", 
	`¡¾’
("ZED!"), "ZED\\.");

174 
	`mu_as£¹
(
m
 =ğ
NULL
, "Should‚ot match.");

176  
NULL
;

177 
	}
}

180 * 
	$®l_‹¡s
() {

181 
	`mu_su™e_¡¬t
();

183 
	`mu_run_‹¡
(
‹¡_sim¶e_m©ches
);

184 
	`mu_run_‹¡
(
‹¡_sim¶e_»³t™iÚs
);

185 
	`mu_run_‹¡
(
‹¡_ªchÜs
);

186 
	`mu_run_‹¡
(
‹¡_blocks
);

187 
	`mu_run_‹¡
(
‹¡_äÚt›r
);

188 
	`mu_run_‹¡
(
‹¡_b®ªû
);

189 
	`mu_run_‹¡
(
‹¡_£t
);

190 
	`mu_run_‹¡
(
‹¡_İtiÚ®
);

191 
	`mu_run_‹¡
(
‹¡_esÿ³d
);

193  
NULL
;

194 
	}
}

196 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/proxy_tests.c

1 
	~"mšun™.h
"

2 
	~<´oxy.h
>

3 
	~<¡dlib.h
>

4 
	~<mem/h®loc.h
>

7 *
	$‹¡_Proxy_ü—‹_de¡roy
()

9 
Proxy
 *
´oxy
 = 
	`Proxy_ü—‹
(
	`bäomc¡r
("127.0.0.1"), 80);

10 
	`mu_as£¹
(
´oxy
 !ğ
NULL
, "Didn't makehe…roxy.");

12 
	`Proxy_de¡roy
(
´oxy
);

14  
NULL
;

15 
	}
}

17 * 
	$®l_‹¡s
() {

18 
	`mu_su™e_¡¬t
();

20 
	`mu_run_‹¡
(
‹¡_Proxy_ü—‹_de¡roy
);

22  
NULL
;

23 
	}
}

25 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/register_tests.c

1 
	~"mšun™.h
"

2 
	~<cÚÃùiÚ.h
>

3 
	~<»gi¡”.h
>

5 
	gV_TEST_CONN_1
 = 1;

6 
	gV_TEST_CONN_2
 = 2;

7 
CÚÃùiÚ
 *
	gTEST_CONN_1
 = 
NULL
;

8 
CÚÃùiÚ
 *
	gTEST_CONN_2
 = 
NULL
;

10 *
	$‹¡_Regi¡”_š™
()

12 
	`Regi¡”_š™
();

14 
TEST_CONN_1
 = 
	`ÿÎoc
((
CÚÃùiÚ
), 1);

15 
TEST_CONN_2
 = 
	`ÿÎoc
((
CÚÃùiÚ
), 1);

17  
NULL
;

18 
	}
}

20 *
	$‹¡_Regi¡”_cÚÃù_discÚÃù
()

22 
id
 = 
	`Regi¡”_cÚÃù
(12, 
TEST_CONN_1
);

23 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12è=ğ
TEST_CONN_1
, "Didn't„egister.");

24 
	`mu_as£¹
(
id
 >= 0, "Got‡‚egative forhe ident.");

26 
fd
 = 
	`Regi¡”_fd_fÜ_id
(
id
);

27 
	`mu_as£¹
(
fd
 == 12, "Should get 12 forhe fd.");

29 
Şd_id
 = 
	`Regi¡”_id_fÜ_fd
(
fd
);

30 
	`mu_as£¹
(
Şd_id
 =ğ
id
, "Wrong id for fd.");

32 
Şd_id
 = 
	`Regi¡”_discÚÃù
(12);

33 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12) == 0, "Didn't disconnect.");

34 
	`mu_as£¹
(
id
 =ğ
Şd_id
, "Wrong id on disconnect.");

37 
Şd_id
 = 
	`Regi¡”_discÚÃù
(12);

38 
	`mu_as£¹
(
Şd_id
 == -1, "Should get‡nƒrror.");

39  
NULL
;

40 
	}
}

42 *
	$‹¡_Regi¡”_pšg
()

44 
id
 = 
	`Regi¡”_cÚÃù
(12232, 
TEST_CONN_1
);

45 
	`mu_as£¹
(
id
 >= 0, "Failedo connect 12232.");

46 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12232è=ğ
TEST_CONN_1
, "Didn't„egister.");

48 
	`mu_as£¹
(
	`Regi¡”_pšg
(12232), "Ping didn't work.");

51 
Ãw_id
 = 
	`Regi¡”_cÚÃù
(12232, 
TEST_CONN_2
);

52 
	`mu_as£¹
(
Ãw_id
 !ğ
id
, "Second„egister should get‚ew id.");

53 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12232è=ğ
TEST_CONN_2
, "Should have different connection");

55 
id
 = 
	`Regi¡”_discÚÃù
(12232);

56 
	`mu_as£¹
(
id
 != -1, "Didn't disconnect‡fter some…ings.");

57 
	`mu_as£¹
(
	`Regi¡”_fd_exi¡s
(12232) == 0, "Disconnect didn't work.");

59 
	`mu_as£¹
(
	`Regi¡”_pšg
(12) == -1, "Should getƒrror on…ing of disconnect.");

61  
NULL
;

62 
	}
}

65 * 
	$®l_‹¡s
() {

66 
	`mu_su™e_¡¬t
();

68 
	`mu_run_‹¡
(
‹¡_Regi¡”_š™
);

69 
	`mu_run_‹¡
(
‹¡_Regi¡”_cÚÃù_discÚÃù
);

70 
	`mu_run_‹¡
(
‹¡_Regi¡”_pšg
);

72  
NULL
;

73 
	}
}

75 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/request_tests.c

1 
	~"mšun™.h
"

2 
	~"»que¡.h
"

3 
	~"Š‘¡ršgs.h
"

4 
	~"h—d”s.h
"

5 
	~<glob.h
>

6 
	~"»gi¡”.h
"

7 
	~"cÚÃùiÚ.h
"

9 cÚ¡ *
	gRFC_822_TIME
 = "%a, %d %b %y %T";

11 *
	$‹¡_Reque¡_·ylßds
()

13 
glob_t
 
‹¡_fes
;

14 
b¡ršg
 
çke_£nd”
 = 
	`bäomc¡r
("FAKESENDER");

15 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

16 
size_t
 
Å¬£d
 = 0;

17 
i
 = 0;

18 
rc
 = 
	`glob
("‹¡s/ªd_su™e/*", 0, 
NULL
, &
‹¡_fes
);

19 
	`mu_as£¹
(
rc
 == 0, "Failedo glob file sinests/and_suite/*");

20 
FILE
 *
‹¡_ÿ£s
 = 
	`fİ’
("tests/request_payloads.txt", "w");

21 
	`mu_as£¹
(
‹¡_ÿ£s
 !ğ
NULL
, "Failedo createheests/request_payloads.txt file.");

23 
i
 = 0; i < 
‹¡_fes
.
gl_·thc
; i++) {

24 
Å¬£d
 = 0;

25 
FILE
 *
šfe
 = 
	`fİ’
(
‹¡_fes
.
gl_·thv
[
i
], "r");

26 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

28 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

29 
	`fşo£
(
šfe
);

30 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

32 
	`Reque¡_¡¬t
(
»q
);

33 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), &
Å¬£d
);

35 if(
rc
 == 1) {

36 
	`mu_as£¹
(
Å¬£d
 > 0, "Should have…arsed something.");

39 if(
»q
->
·th
 =ğ
NULL
è»q->·th = 
	`bäomc¡r
("/");

41 
b¡ršg
 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
»q
, 
çke_£nd”
, 0, "", 0);

42 
	`bcÚch¬
(
·ylßd
, '\n');

43 
	`fwr™e
(
·ylßd
->
d©a
, 
	`bËngth
Õaylßd), 1, 
‹¡_ÿ£s
);

44 
	`bde¡roy
(
·ylßd
);

46 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
»q
, 
çke_£nd”
, 0, "", 0);

47 
	`debug
("TNETSTRING PAYLOAD: '%.*s'", 
	`bËngth
(
·ylßd
), 
	`bd©a
(payload));

48 
	`bcÚch¬
(
·ylßd
, '\n');

49 
	`fwr™e
(
·ylßd
->
d©a
, 
	`bËngth
Õaylßd), 1, 
‹¡_ÿ£s
);

50 
	`bde¡roy
(
·ylßd
);

53 
	`bde¡roy
(
d©a
);

56 
	`globä“
(&
‹¡_fes
);

57 
	`fşo£
(
‹¡_ÿ£s
);

58 
	`bde¡roy
(
çke_£nd”
);

59 
	`Reque¡_de¡roy
(
»q
);

60  
NULL
;

61 
	}
}

63 *
	$‹¡_Reque¡_¥“ds
()

65 
i
 = 0;

66 
FILE
 *
šfe
 = 
	`fİ’
("tests/request_payloads.txt", "r");

67 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openheests/request_payloads.txtest file.");

68 
b¡rLi¡
 *
li¡
 = 
	`b¡rLi¡C»©e
();

69 
	`b¡rLi¡AÎoc
(
li¡
, 300);

72 
i
 = 0; i < 300; i++, 
li¡
->
qty
++) {

73 
b¡ršg
 
£nd”
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, ' ');

74 
b¡ršg
 
cÚn_id
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, ' ');

75 
b¡ršg
 
·th
 = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, ' ');

76 
li¡
->
’Œy
[
i
] = 
	`bg‘s
((
bNg‘c
)
fg‘c
, 
šfe
, '\n');

79 if(!(
£nd”
 && 
cÚn_id
 && 
·th
)) ;

81 
	`bde¡roy
(
£nd”
);

82 
	`bde¡roy
(
cÚn_id
);

83 
	`bde¡roy
(
·th
);

86 
	`fşo£
(
šfe
);

90 
j
 = 0;

91 
j
 = 0; j < 200; j++) {

92 
i
 = 0; i < 
li¡
->
qty
; i++) {

93 
Šs_v®ue_t
 *
v®
 = 
	`Šs_·r£
(
	`bd©a
(
li¡
->
’Œy
[
i
]), 
	`bËngth
Öi¡->’Œy[i]), 
NULL
);

94 
	`mu_as£¹
(
v®
->
ty³
 =ğ
Šs_g_¡ršg
 || v®->ty³ =ğ
Šs_g_diù
, "Got‡n invalid data chunk from file.");

96 
size_t
 
Ën
 = 0;

97 *
·ylßd
 = 
	`Šs_»nd”
(
v®
, &
Ën
);

98 
	`mu_as£¹
(
Ën
 > 0, "Failedo„enderhe…ayload.");

100 
	`ä“
(
·ylßd
);

101 
	`Šs_v®ue_de¡roy
(
v®
);

105 
	`b¡rLi¡De¡roy
(
li¡
);

106  
NULL
;

107 
	}
}

109 *
	$‹¡_Reque¡_ü—‹
()

111 
rc
 = 0;

112 
size_t
 
Å¬£d
 = 0;

113 
b¡ršg
 
çke_£nd”
 = 
	`bäomc¡r
("FAKESENDER");

115 
	`Reque¡_š™
();

117 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

118 
	`mu_as£¹
(
»q
 !ğ
NULL
, "Failedo create…arser for„equest.");

120 
FILE
 *
šfe
 = 
	`fİ’
("tests/and_suite/ex_httpd_tst_16", "r");

121 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

123 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

124 
	`fşo£
(
šfe
);

125 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

126 
	`mu_as£¹
(
	`bËngth
(
d©a
) > 0, "Nothing inhat file.");

128 
	`Reque¡_¡¬t
(
»q
);

130 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), &
Å¬£d
);

132 
	`mu_as£¹
(
rc
 == 1, "It should…arse.");

133 
	`mu_as£¹
(
Å¬£d
 > 0, "Should have…arsed something.");

135 
b¡ršg
 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
»q
, 
çke_£nd”
, 0, "", 0);

136 
	`debug
("PAYLOAD IS: %s", 
	`bd©a
(
·ylßd
));

137 
	`bde¡roy
(
·ylßd
);

139 
·ylßd
 = 
	`Reque¡_to_Š‘¡ršg
(
»q
, 
çke_£nd”
, 0, "", 0);

140 
	`debug
("TNETSTRING PAYLOAD: '%.*s'", 
	`bËngth
(
·ylßd
), 
	`bd©a
(payload));

142 
	`mu_as£¹
(
	`Reque¡_g‘
(
»q
, &
HTTP_IF_MODIFIED_SINCE
è!ğ
NULL
,

144 
	`mu_as£¹
(
»q
->
ho¡
 !ğ
NULL
, "Should have Host header.");

145 
	`mu_as£¹
(
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_MODIFIED_SINCE
, 
RFC_822_TIME
) > 0,

148 
	`mu_as£¹
(
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_UNMODIFIED_SINCE
, 
RFC_822_TIME
) == 0,

151 
	`mu_as£¹
(
	`Reque¡_g‘_d©e
(
»q
, &
HTTP_IF_NONE_MATCH
, 
RFC_822_TIME
) == 0,

154 
	`Reque¡_¡¬t
(
»q
);

156 
	`Reque¡_de¡roy
(
»q
);

159 
	`Reque¡_de¡roy
(
NULL
);

160 
	`bde¡roy
(
·ylßd
);

161 
	`bde¡roy
(
çke_£nd”
);

162 
	`bde¡roy
(
d©a
);

164  
NULL
;

165 
	}
}

167 
gb¡ršg
 
	gCOOKIE_HEADER
 = 
bsStic
("cookie");

168 
gb¡ršg
 
	gEXPECTED_COOKIE_HEADER
 = 
bsStic
("JSON 0 / 97:{\"PATH\":\"/\",\"cookie\":[\"foo=bar\",\"test=yes; go=no\"],\"METHOD\":\"GET\",\"VERSION\":\"HTTP/1.0\",\"URI\":\"/\"},0:,");

170 *
	$‹¡_MuÉË_H—d”_Reque¡
()

172 
rc
 = 0;

173 
size_t
 
Å¬£d
 = 0;

175 
	`Reque¡_š™
();

177 
Reque¡
 *
»q
 = 
	`Reque¡_ü—‹
();

178 
	`mu_as£¹
(
»q
 !ğ
NULL
, "Failedo create…arser for„equest.");

180 
FILE
 *
šfe
 = 
	`fİ’
("tests/and_suite/ex_httpd_tst_21", "r");

181 
	`mu_as£¹
(
šfe
 !ğ
NULL
, "Failedo openest file.");

183 
b¡ršg
 
d©a
 = 
	`b»ad
((
bN»ad
)
ä—d
, 
šfe
);

184 
	`fşo£
(
šfe
);

185 
	`mu_as£¹
(
d©a
 !ğ
NULL
, "Failedo„eadest file.");

186 
	`mu_as£¹
(
	`bËngth
(
d©a
) > 0, "Nothing inhat file.");

188 
	`Reque¡_¡¬t
(
»q
);

190 
rc
 = 
	`Reque¡_·r£
(
»q
, 
	`bd©a
(
d©a
), 
	`bËngth
(d©a), &
Å¬£d
);

192 
	`mu_as£¹
(
rc
 == 1, "It should…arse.");

193 
	`mu_as£¹
(
Å¬£d
 > 0, "Should have…arsed something.");

195 
	`mu_as£¹
(
	`Reque¡_g‘
(
»q
, &
COOKIE_HEADER
è!ğ
NULL
,

198 
b¡ršg
 
·ylßd
 = 
	`Reque¡_to_·ylßd
(
»q
, &
JSON_METHOD
, 0, "", 0);

199 
	`debug
("PAYLOAD IS: %s", 
	`bd©a
(
·ylßd
));

201 
	`mu_as£¹
(
	`b¡rcmp
(
·ylßd
, &
EXPECTED_COOKIE_HEADER
) == 0,

204 
	`Reque¡_de¡roy
(
»q
);

205 
	`bde¡roy
(
·ylßd
);

206 
	`bde¡roy
(
d©a
);

208  
NULL
;

209 
	}
}

212 * 
	$®l_‹¡s
() {

213 
	`mu_su™e_¡¬t
();

214 
	`Regi¡”_š™
();

217 
CÚÃùiÚ
 *
cÚn
 = 
	`ÿÎoc
((Connection), 1);

218 
cÚn
->
iob
 = 
NULL
;

219 
cÚn
->
ty³
 = 
CONN_TYPE_HTTP
;

220 
	`Regi¡”_cÚÃù
(0, 
cÚn
);

222 
	`mu_run_‹¡
(
‹¡_Reque¡_ü—‹
);

223 
	`mu_run_‹¡
(
‹¡_MuÉË_H—d”_Reque¡
);

224 
	`mu_run_‹¡
(
‹¡_Reque¡_·ylßds
);

225 
	`mu_run_‹¡
(
‹¡_Reque¡_¥“ds
);

227  
NULL
;

228 
	}
}

230 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/response_tests.c

1 
	~"mšun™.h
"

2 
	~"»¥Ú£.h
"

3 
	~"cÚÃùiÚ.h
"

4 
	~"»gi¡”.h
"

5 
	~<fú.h
>

8 *
	$‹¡_Re¥Ú£_£nd_¡©us
()

10 
z”o_fd
 = 
	`İ’
("/dev/z”o", 
O_WRONLY
);

11 
IOBuf
 *
buf
 = 
	`IOBuf_ü—‹
(1024, 
z”o_fd
, 
IOBUF_FILE
);

12 
CÚÃùiÚ
 
cÚn
 = {.
iob
 = 
buf
};

13 
	`Regi¡”_cÚÃù
(
z”o_fd
, &
cÚn
);

15 
rc
 = 
	`Re¥Ú£_£nd_¡©us
(&
cÚn
, &
HTTP_405
);

16 
	`mu_as£¹
(
rc
 != -1, "Failedo send 405 status.");

18 
	`Regi¡”_discÚÃù
(
z”o_fd
);

19  
NULL
;

20 
	}
}

22 *
	$‹¡_Re¥Ú£_£nd_sock‘_pŞicy
()

24 
z”o_fd
 = 
	`İ’
("/dev/z”o", 
O_WRONLY
);

25 
IOBuf
 *
buf
 = 
	`IOBuf_ü—‹
(1024, 
z”o_fd
, 
IOBUF_FILE
);

26 
CÚÃùiÚ
 
cÚn
 = {.
iob
 = 
buf
};

27 
	`Regi¡”_cÚÃù
(
z”o_fd
, &
cÚn
);

29 
rc
 = 
	`Re¥Ú£_£nd_sock‘_pŞicy
(&
cÚn
);

30 
	`mu_as£¹
(
rc
 != -1, "Failedo sendhe flash socket…olicy.");

32 
	`Regi¡”_discÚÃù
(
z”o_fd
);

33  
NULL
;

34 
	}
}

37 * 
	$®l_‹¡s
() {

38 
	`mu_su™e_¡¬t
();

39 
	`Regi¡”_š™
();

41 
	`mu_run_‹¡
(
‹¡_Re¥Ú£_£nd_¡©us
);

42 
	`mu_run_‹¡
(
‹¡_Re¥Ú£_£nd_sock‘_pŞicy
);

44  
NULL
;

45 
	}
}

47 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/routing_tests.c

1 
	~"mšun™.h
"

2 
	~<routšg.h
>

3 
	~<¡ršg.h
>

4 
	~<dbg.h
>

7 
	$check_routšg
(
li¡_t
 *
found
, 
Rou‹
 *
rou‹
, 
ex³ùed_couÁ
, cÚ¡ *
rou‹_d©a
)

9 if(
	`li¡_fœ¡
(
found
)) {

10 
rou‹
 = 
	`Êode_g‘
(
	`li¡_fœ¡
(
found
));

13 
	`check
(
	`li¡_couÁ
(
found
è=ğ
ex³ùed_couÁ
, "Didn't find„ight‚umber of„outes: got %d,ƒxpected %d.",

14 ()
	`li¡_couÁ
(
found
), 
ex³ùed_couÁ
);

16 if(
rou‹_d©a
 =ğ
NULL
) {

17 
	`check
(
rou‹
 =ğ
NULL
, "Should have‚o„outes found.");

19 
	`check
(
rou‹
->
d©a
 =ğ
rou‹_d©a
, "Wrong data„eturned.");

23 
”rÜ
:

24 if(
rou‹
è
	`debug
("Rou‹„‘uºed: %s", (cÚ¡ *ìou‹->
d©a
);

26 
	}
}

29 
	$check_sim¶e_´efix
(
Rou‹M­
 *
rou‹s
, cÚ¡ * 
·th
, cÚ¡ *
ex³ùed
)

31 
b¡ršg
 
·th_¡r
 = 
	`bäomc¡r
(
·th
);

32 
Rou‹
 *
found
 = 
	`Rou‹M­_sim¶e_´efix_m©ch
(
rou‹s
, 
·th_¡r
);

33 
	`debug
("Testing simple…refix: %so match %s‡nd found %s",

34 
·th
, 
ex³ùed
, 
found
 =ğ
NULL
 ? "NULL" : (cÚ¡ *)found->
d©a
);

36 if(
ex³ùed
 !ğ
NULL
) {

37 
	`check
(
found
 !ğ
NULL
, "Should find‡ match.");

38 
	`check
(
found
->
d©a
 =ğ
ex³ùed
, "Didn't match.");

40 
	`check
(
found
 =ğ
NULL
, "Should‚ot find‡ match.");

43 
	`bde¡roy
(
·th_¡r
);

45 
”rÜ
:

46 
	`bde¡roy
(
·th_¡r
);

48 
	}
}

50 *
	$‹¡_sim¶e_´efix_m©chšg
()

52 
Rou‹M­
 *
rou‹s
 = 
	`Rou‹M­_ü—‹
(
NULL
);

53 
	`mu_as£¹
(
rou‹s
 !ğ
NULL
, "Failedo makehe„oute map.");

54 *
rou‹_d©a0
 = "route0";

55 *
rou‹_d©a1
 = "route1";

56 *
rou‹_d©a2
 = "route2";

57 *
rou‹_d©a3
 = "route3";

58 *
rou‹_d©a4
 = "route4";

59 
b¡ršg
 
rou‹0
 = 
	`bäomc¡r
("/");

60 
b¡ršg
 
rou‹1
 = 
	`bäomc¡r
("/users/([0-9]+)");

61 
b¡ršg
 
rou‹2
 = 
	`bäomc¡r
("/users");

62 
b¡ršg
 
rou‹3
 = 
	`bäomc¡r
("/users/people/([0-9]+)$");

63 
b¡ršg
 
rou‹4
 = 
	`bäomc¡r
("/cars-fast/([a-z]-)$");

65 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹0
, 
rou‹_d©a0
);

66 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹1
, 
rou‹_d©a1
);

67 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹2
, 
rou‹_d©a2
);

68 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹3
, 
rou‹_d©a3
);

69 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹4
, 
rou‹_d©a4
);

71 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs/1234/‹¡šg", 
rou‹_d©a1
), "Failed.");

72 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs", 
rou‹_d©a2
), "Failed.");

73 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs/³İË/1234", 
rou‹_d©a3
), "Failed.");

74 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/ÿrs-ç¡/ÿdÏc", 
rou‹_d©a4
), "Failed.");

75 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rs/1234", 
rou‹_d©a1
), "Failed.");

76 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/", 
rou‹_d©a0
), "Failed.");

80 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/u£rsBLAAHAHAH", 
rou‹_d©a2
), "Failed.");

82 
	`mu_as£¹
(
	`check_sim¶e_´efix
(
rou‹s
, "/us", 
rou‹_d©a2
), "Failed.");

84 
	`Rou‹M­_de¡roy
(
rou‹s
);

86  
NULL
;

87 
	}
}

89 *
	$‹¡_routšg_m©ch
()

91 
Rou‹M­
 *
rou‹s
 = 
	`Rou‹M­_ü—‹
(
NULL
);

92 
	`mu_as£¹
(
rou‹s
 !ğ
NULL
, "Failedo makehe„oute map.");

93 *
rou‹_d©a0
 = "route0";

94 *
rou‹_d©a1
 = "route1";

95 *
rou‹_d©a2
 = "route2";

96 *
rou‹_d©a3
 = "route3";

97 *
rou‹_d©a4
 = "route4";

98 
b¡ršg
 
rou‹0
 = 
	`bäomc¡r
("/");

99 
b¡ršg
 
rou‹1
 = 
	`bäomc¡r
("/users/([0-9]+)");

100 
b¡ršg
 
rou‹2
 = 
	`bäomc¡r
("/users");

101 
b¡ršg
 
rou‹3
 = 
	`bäomc¡r
("/users/people/([0-9]+)$");

102 
b¡ršg
 
rou‹4
 = 
	`bäomc¡r
("/cars-fast/([a-z]-)$");

104 
Rou‹
 *
rou‹
 = 
NULL
;

106 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹0
, 
rou‹_d©a0
);

107 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹1
, 
rou‹_d©a1
);

108 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹2
, 
rou‹_d©a2
);

109 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹3
, 
rou‹_d©a3
);

110 
	`Rou‹M­_š£¹
(
rou‹s
, 
rou‹4
, 
rou‹_d©a4
);

112 
b¡ršg
 
·th1
 = 
	`bäomc¡r
("/users/1234/testing");

113 
b¡ršg
 
·th2
 = 
	`bäomc¡r
("/users");

114 
b¡ršg
 
·th3
 = 
	`bäomc¡r
("/users/people/1234");

115 
b¡ršg
 
·th4
 = 
	`bäomc¡r
("/cars-fast/cadillac");

116 
b¡ršg
 
·th5
 = 
	`bäomc¡r
("/users/1234");

117 
b¡ršg
 
·th6
 = 
	`bäomc¡r
("/");

118 
b¡ršg
 
·th7
 = 
	`bäomc¡r
("/users/people/1234/notgonnawork");

120 
li¡_t
 *
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th5
);

121 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a1
), "Pattern match„oute wrong.");

122 
	`li¡_de¡roy_nodes
(
found
);

123 
	`li¡_de¡roy
(
found
);

125 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th1
);

126 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a1
), "Pastƒnd„oute wrong.");

127 
	`li¡_de¡roy_nodes
(
found
);

128 
	`li¡_de¡roy
(
found
);

130 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th2
);

131 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a2
), "No…attern„oute wrong.");

132 
	`li¡_de¡roy_nodes
(
found
);

133 
	`li¡_de¡roy
(
found
);

135 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th3
);

136 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a3
), "Wrong $erminated„oute.");

137 
	`li¡_de¡roy_nodes
(
found
);

138 
	`li¡_de¡roy
(
found
);

140 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th4
);

141 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a4
), "Wrong†onger„oute match.");

142 
	`li¡_de¡roy_nodes
(
found
);

143 
	`li¡_de¡roy
(
found
);

145 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th5
);

146 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 1, 
rou‹_d©a1
), "Wrong„oute for /users/1234");

147 
	`li¡_de¡roy_nodes
(
found
);

148 
	`li¡_de¡roy
(
found
);

150 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th6
);

151 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 2, 
rou‹_d©a0
), "Should get„oot /„oute.");

152 
	`li¡_de¡roy_nodes
(
found
);

153 
	`li¡_de¡roy
(
found
);

155 
found
 = 
	`Rou‹M­_m©ch
(
rou‹s
, 
·th7
);

156 
	`mu_as£¹
(
	`check_routšg
(
found
, 
rou‹
, 0, 
NULL
), "Should‚ot match…astƒnd");

157 
	`li¡_de¡roy_nodes
(
found
);

158 
	`li¡_de¡roy
(
found
);

160 
	`bde¡roy
(
·th1
);

161 
	`bde¡roy
(
·th2
);

162 
	`bde¡roy
(
·th3
);

163 
	`bde¡roy
(
·th4
);

164 
	`bde¡roy
(
·th5
);

166 
	`Rou‹M­_de¡roy
(
rou‹s
);

168  
NULL
;

169 
	}
}

172 *
	$‹¡_routšg_m©ch_»v”£d
()

174 
Rou‹M­
 *
rou‹s
 = 
	`Rou‹M­_ü—‹
(
NULL
);

175 
	`mu_as£¹
(
rou‹s
 !ğ
NULL
, "Failedo makehe„oute map.");

176 *
rou‹_d©a1
 = "route1";

177 *
rou‹_d©a2
 = "route2";

178 *
rou‹_d©a3
 = "route3";

179 
b¡ršg
 
rou‹1
 = 
	`bäomc¡r
("foo");

180 
b¡ršg
 
rou‹2
 = 
	`bäomc¡r
("moo");

181 
b¡ršg
 
rou‹3
 = 
	`bäomc¡r
("fio");

183 
Rou‹
 *
rou‹
 = 
NULL
;

185 
	`Rou‹M­_š£¹_»v”£d
(
rou‹s
, 
rou‹1
, 
rou‹_d©a1
);

186 
	`Rou‹M­_š£¹_»v”£d
(
rou‹s
, 
rou‹2
, 
rou‹_d©a2
);

187 
	`Rou‹M­_š£¹_»v”£d
(
rou‹s
, 
rou‹3
, 
rou‹_d©a3
);

189 
b¡ršg
 
·th1
 = 
	`bäomc¡r
("foo");

190 
b¡ršg
 
·th2
 = 
	`bäomc¡r
("moo");

191 
b¡ršg
 
·th3
 = 
	`bäomc¡r
("fio");

193 
rou‹
 = 
	`Rou‹M­_m©ch_suffix
(
rou‹s
, 
·th1
);

194 
	`mu_as£¹
(
rou‹
 !ğ
NULL
, "Pattern match failed.");

195 
	`mu_as£¹
(
rou‹
->
d©a
 =ğ
rou‹_d©a1
, "Pattern matched wrong„oute.");

197 
rou‹
 = 
	`Rou‹M­_m©ch_suffix
(
rou‹s
, 
·th2
);

198 
	`mu_as£¹
(
rou‹
 !ğ
NULL
, "Pattern match failed.");

199 
	`mu_as£¹
(
rou‹
->
d©a
 =ğ
rou‹_d©a2
, "Pattern matched wrong„oute.");

201 
rou‹
 = 
	`Rou‹M­_m©ch_suffix
(
rou‹s
, 
·th3
);

202 
	`mu_as£¹
(
rou‹
 !ğ
NULL
, "Pattern match failed.");

203 
	`mu_as£¹
(
rou‹
->
d©a
 =ğ
rou‹_d©a3
, "Pattern matched wrong„oute.");

205 
	`bde¡roy
(
·th1
);

206 
	`bde¡roy
(
·th2
);

207 
	`bde¡roy
(
·th3
);

209 
	`Rou‹M­_de¡roy
(
rou‹s
);

211  
NULL
;

212 
	}
}

215 * 
	$®l_‹¡s
() {

216 
	`mu_su™e_¡¬t
();

218 
	`mu_run_‹¡
(
‹¡_routšg_m©ch
);

219 
	`mu_run_‹¡
(
‹¡_sim¶e_´efix_m©chšg
);

220 
	`mu_run_‹¡
(
‹¡_routšg_m©ch_»v”£d
);

222  
NULL
;

223 
	}
}

225 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/server_tests.c

1 
	~"mšun™.h
"

2 
	~<£rv”.h
>

3 
	~<¡ršg.h
>

4 
	~<sk/sk.h
>

6 *
	$‹¡_S”v”_š™
()

8 
	`mqš™
(1);

9 
	`S”v”_š™
();

11  
NULL
;

12 
	}
}

15 *
	$‹¡_S”v”_ü—‹_de¡roy
()

17 
S”v”
 *
£rv”
 = 
	`S”v”_ü—‹
(

18 
	`bäomc¡r
("uuid"),

19 
	`bäomc¡r
("localhost"),

20 
	`bäomc¡r
("0.0.0.0"),

22 
	`bäomc¡r
("chroot"),

23 
	`bäomc¡r
("access_log"),

24 
	`bäomc¡r
("error_log"),

25 
	`bäomc¡r
("pid_file"), 0);

26 
	`mu_as£¹
(
£rv”
 !ğ
NULL
, "Failedo makehe server, something on 8090?");

28 
	`S”v”_de¡roy
(
£rv”
);

30  
NULL
;

31 
	}
}

34 *
	$‹¡_S”v”_adds
()

36 
rc
 = 0;

38 
S”v”
 *
¤v
 = 
	`S”v”_ü—‹
(

39 
	`bäomc¡r
("uuid"),

40 
	`bäomc¡r
("localhost"),

41 
	`bäomc¡r
("0.0.0.0"),

43 
	`bäomc¡r
("chroot"),

44 
	`bäomc¡r
("access_log"),

45 
	`bäomc¡r
("error_log"),

46 
	`bäomc¡r
("pid_file"), 0);

47 
	`mu_as£¹
(
¤v
 !ğ
NULL
, "Failedo makehe server, something on 8090?");

49 
Ho¡
 *
ho¡
 = 
	`Ho¡_ü—‹
(
	`bäomc¡r
("zedshaw.com"), bfromcstr("zedshaw.com"));

50 
	`mu_as£¹
(
ho¡
 !ğ
NULL
, "Failedo make host.");

52 
rc
 = 
	`S”v”_add_ho¡
(
¤v
, 
ho¡
);

53 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd hosto server.");

55 
	`S”v”_£t_deçuÉ_ho¡
(
¤v
, 
ho¡
);

57 
Ho¡
 *
zedshaw
 = 
	`S”v”_m©ch_back’d
(
¤v
, 
ho¡
->
Çme
);

58 
	`mu_as£¹
(
zedshaw
 =ğ
ho¡
, "Didn't gethe„ight one back.");

60 
	`mu_as£¹
(
	`S”v”_m©ch_back’d
(
¤v
, 
	`bäomc¡r
("NOWAY")è=ğ
ho¡
, "Didn't fall backo default_host");

62 
	`S”v”_de¡roy
(
¤v
);

64  
NULL
;

65 
	}
}

68 *
	$®l_‹¡s
() {

69 
	`mu_su™e_¡¬t
();

71 
	`mu_run_‹¡
(
‹¡_S”v”_š™
);

72 
	`mu_run_‹¡
(
‹¡_S”v”_ü—‹_de¡roy
);

73 
	`mu_run_‹¡
(
‹¡_S”v”_adds
);

74 
	`zmq_‹rm
(
ZMQ_CTX
);

76  
NULL
;

77 
	}
}

79 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/setting_tests.c

1 
	~"mšun™.h
"

2 
	~<£‰šg.h
>

4 *
	$‹¡_S‘tšg_add_g‘
()

6 
rc
 = 
	`S‘tšg_add
("TEST1", "2345");

7 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd TEST1");

9 
rc
 = 
	`S‘tšg_add
("TEST2", "Hello");

10 
	`mu_as£¹
(
rc
 == 0, "Failedo‡dd TEST2");

12 
b¡ršg
 
t1
 = 
	`S‘tšg_g‘_¡r
("TEST1", 
NULL
);

13 
	`debug
("GÙ1: %s", 
	`bd©a
(
t1
));

14 
	`mu_as£¹
(
t1
 !ğ
NULL
, "Gothe default.");

15 
	`mu_as£¹
(
	`bi£qc¡r
(
t1
, "2345"), "Failedo get TEST1.");

17 
t1_št
 = 
	`S‘tšg_g‘_št
("TEST1", 999);

18 
	`debug
("GÙ %d fÜhTEST1", 
t1_št
);

19 
	`mu_as£¹
(
t1_št
 == 2345, "Wrong value for TEST1‡s int.");

21 
t3_št
 = 
	`S‘tšg_g‘_št
("TEST5", 999);

22 
	`mu_as£¹
(
t3_št
 == 999, "Should gethe default.");

24  
NULL
;

25 
	}
}

27 *
	$‹¡_S‘tšg_de¡roy
()

29 
	`S‘tšg_de¡roy
();

31  
NULL
;

32 
	}
}

34 * 
	$®l_‹¡s
() {

35 
	`mu_su™e_¡¬t
();

37 
	`mu_run_‹¡
(
‹¡_S‘tšg_add_g‘
);

38 
	`mu_run_‹¡
(
‹¡_S‘tšg_de¡roy
);

40  
NULL
;

41 
	}
}

43 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/state_tests.c

1 
	~"mšun™.h
"

2 
	~<¡©e.h
>

3 
	~<ev’ts.h
>

4 
	~<¡dšt.h
>

5 
	~"cÚÃùiÚ.h
"

7 
	$‹¡_aùiÚ_cb
(
CÚÃùiÚ
 *
d©a
)

10 
	}
}

12 
S‹AùiÚs
 
	g‹¡_aùiÚs
 = {

13 .
”rÜ
 = 
‹¡_aùiÚ_cb
,

14 .
	gşo£
 = 
‹¡_aùiÚ_cb
,

15 .
	g·r£
 = 
‹¡_aùiÚ_cb
,

16 .
	gid’tify_»que¡
 = 
‹¡_aùiÚ_cb
,

17 .
	g£nd_sock‘_»¥Ú£
 = 
‹¡_aùiÚ_cb
,

18 .
	grou‹_»que¡
 = 
‹¡_aùiÚ_cb
,

19 .
	gmsg_to_hªdËr
 = 
‹¡_aùiÚ_cb
,

20 .
	gh‰p_to_hªdËr
 = 
‹¡_aùiÚ_cb
,

21 .
	gh‰p_to_´oxy
 = 
‹¡_aùiÚ_cb
,

22 .
	gh‰p_to_dœeùÜy
 = 
‹¡_aùiÚ_cb
,

23 .
	g´oxy_d–iv”
 = 
‹¡_aùiÚ_cb
,

24 .
	g´oxy_çed
 = 
‹¡_aùiÚ_cb
,

25 .
	g´oxy_»q_·r£
 = 
‹¡_aùiÚ_cb
,

26 .
	g´oxy_»¶y_·r£
 = 
‹¡_aùiÚ_cb
,

27 .
	g´oxy_şo£
 = 
‹¡_aùiÚ_cb


34 
	$run_ev’ts
(
S‹
 *
¡©e
, cÚ¡ *
Çme
, *
ev’ts
)

36 
i
 = 0;

37 
rc
 = 0;

38 
	`S‹_š™
(
¡©e
, &
‹¡_aùiÚs
);

40 
	`debug
(">>> RUNNING %s", 
Çme
);

42 
i
 = 0; 
ev’ts
[i] != 0; i++) {

43 
rc
 = 
	`S‹_exec
(
¡©e
, 
ev’ts
[
i
], (*)(
šŒ_t
)i);

44 
	`check
(
	`S‹_šv¬ŸÁ
(
¡©e
è!ğ-1, "Faed oÀ´oûssšg %dƒv’t.", 
ev’ts
[
i
]);

47 
	`debug
("<<< FINAL RESULT: %d, fšished: %d", 
rc
, 
	`S‹_šv¬ŸÁ
(
¡©e
));

48  
	`S‹_šv¬ŸÁ
(
¡©e
);

50 
”rÜ
:

52 
	}
}

58 
	#RUN
(
N
, ...èN[] = { 
__VA_ARGS__
, 0 };\

59 
	`mu_as£¹
(
	`run_ev’ts
(&
¡©e
, "TEST " #N, 
N
), "Te¡ " #N " faed.");

	)

64 
	#FAILS
(
N
, ...èN[] = { 
__VA_ARGS__
, 0 };\

65 
	`mu_as£¹
(!
	`run_ev’ts
(&
¡©e
, "TEST " #N, 
N
), "Te¡ " #N " faed.");

	)

67 *
	$‹¡_S‹_msg
()

69 
S‹
 
¡©e
;

72 
	`RUN
(
msg_hªdËr
,

73 
OPEN
,

74 
REQ_RECV
, 
MSG_REQ
, 
HANDLER
, 
REQ_SENT
, 
CLOSE
);

77 
	`RUN
(
sock‘_¡¬t
, 
OPEN
, 
REQ_RECV
, 
SOCKET_REQ
, 
RESP_SENT
, 
CLOSE
);

80 
	`RUN
(
msg_hªdËr_2_»q
,

81 
OPEN
,

82 
REQ_RECV
, 
MSG_REQ
, 
HANDLER
, 
REQ_SENT
,

83 
REQ_RECV
, 
MSG_REQ
, 
HANDLER
, 
REQ_SENT
,

84 
CLOSE
);

87  
NULL
;

88 
	}
}

91 *
	$‹¡_S‹_h‰p
()

93 
S‹
 
¡©e
;

96 
	`RUN
(
h‰p_dœ
,

97 
OPEN
,

98 
REQ_RECV
, 
HTTP_REQ
, 
DIRECTORY
, 
RESP_SENT
, 
CLOSE
);

101 
	`RUN
(
h‰p_hªdËr
,

102 
OPEN
,

103 
REQ_RECV
, 
HTTP_REQ
, 
HANDLER
, 
REQ_SENT
,

104 
REQ_RECV
, 
HTTP_REQ
, 
HANDLER
, 
REQ_SENT
, 
CLOSE
);

108 
	`RUN
(
h‰p_´oxy
,

109 
OPEN
,

110 
REQ_RECV
, 
HTTP_REQ
, 
PROXY
, 
CONNECT
,

111 
REQ_SENT
, 
REQ_RECV
, 
HTTP_REQ
, REQ_SENT, REQ_RECV, 
REMOTE_CLOSE
,

112 
CLOSE
);

116 
	`RUN
(
h‰p_´oxy_hªdËr
,

117 
OPEN
,

118 
REQ_RECV
, 
HTTP_REQ
, 
PROXY
, 
CONNECT
,

119 
REQ_SENT
, 
REQ_RECV
,

120 
HANDLER
, 
REQ_SENT
, 
CLOSE
);

122  
NULL
;

123 
	}
}

126 *
	$‹¡_S‹_exec_”rÜ
()

128 
S‹
 
¡©e
;

131 
	`FAILS
(
çed_´oxy
,

132 
OPEN
,

133 
REQ_RECV
, 
HTTP_REQ
, 
PROXY
, 
CONNECT
, 
CLOSE
);

135  
NULL
;

136 
	}
}

138 * 
	$®l_‹¡s
() {

139 
	`mu_su™e_¡¬t
();

141 
	`mu_run_‹¡
(
‹¡_S‹_exec_”rÜ
);

142 
	`mu_run_‹¡
(
‹¡_S‹_msg
);

143 
	`mu_run_‹¡
(
‹¡_S‹_h‰p
);

145  
NULL
;

146 
	}
}

148 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/superpoll_tests.c

1 
	~"mšun™.h
"

2 
	~<as£¹.h
>

3 
	~<mem/h®loc.h
>

5 
	~<su³½Şl.h
>

6 
	~<zmq.h
>

8 
Su³rPŞl
 *
	gTEST_POLL
 = 
NULL
;

15 
	~<¡dlib.h
>

16 
	~<¡dio.h
>

17 
	~<¡ršg.h
>

18 
	~<as£¹.h
>

19 
	~<fú.h
>

20 
	~<”ºo.h
>

21 
	~<uni¡d.h
>

22 
	~<sigÇl.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/pŞl.h
>

26 
	~<sys/ioùl.h
>

27 
	~<sys/time.h
>

28 
	~<sys/mmª.h
>

29 
	~<sys/time.h
>

30 
	~<sys/»sourû.h
>

32 
	~<dbg.h
>

34 
	gdÚe
 = 0;

36 
	#FD_SLOP
 10

	)

37 
	#MAX_FDS
 64*1024

	)

39 
	#READ
 0

	)

40 
	#WRITE
 1

	)

43 
	mfds
[2];

44 } 
	gpefds
[
MAX_FDS
/2];

46 
	gÄ_pes
;

48 
	gÄ_tok’_·s£s
;

49 
	gmax_g’”©iÚ
;

50 
	gmax_th»ads
 = 1;

51 
	gth»ads_com¶‘e
 = 0;

53 
	stok’
 {

54 
	mg’”©iÚ
;

55 
	mtofd
;

56 
	mth»ad
;

59 
	gBUFSIZE
 = (
tok’
);

61 
	sfdšfo
 {

62 
	mz”o
;

64 
	mÚe
;

65 
	mfd
;

66 
	mpe_idx
;

67 
	maùive
:1;

68 
	mrw
:1;

69 *
	mbuf
;

71 } 
	gfdšfo
[
MAX_FDS
];

73 
tok’
 
	g³ndšg_tok’s
[
MAX_FDS
];

74 
	gÄ_³ndšg_tok’s
;

76 
	$»®ly_£nd_toke
(
tok’
 *
toke
)

78 
fdšfo
 *
šf
;

79 *
fds
;

80 
fd
;

81 
pe_idx
 = 
Ä_pes
 - 
toke
->
th»ad
 - 1;

83 
fds
 = 
pefds
[
pe_idx
].fds;

84 
fd
 = 
fds
[
WRITE
];

85 
šf
 = &
fdšfo
[
fd
];

87 
	`debug
("£ndšg oÀpšdex %u, fd %d", 
pe_idx
, 
fd
);

89 
»s
 = 
	`wr™e
(
fds
[
WRITE
], 
toke
, 
BUFSIZE
);

90 
	`debug
("wr™e[%ld %d %d]", 
toke
->
g’”©iÚ
,

91 
toke
->
tofd
,oke->
th»ad
);

92 ià(
»s
 !ğ
BUFSIZE
) {

93 
	`´štf
("wr™ğ%d (%s)", 
»s
, 
	`¡»¼Ü
(
”ºo
));

94 
	`ex™
(1);

96 
	}
}

98 
	$£nd_³ndšg_tokes
()

100 
i
;

101 
i
=0; i<
Ä_³ndšg_tok’s
; i++)

102 
	`»®ly_£nd_toke
(&
³ndšg_tok’s
[
i
]);

103 
Ä_³ndšg_tok’s
 = 0;

104 
	}
}

106 
	$£nd_toke
(
tok’
 *
toke
)

108 
pe_idx
;

109 *
fds
;

111 
pe_idx
 = 
Ä_pes
 - 
toke
->
th»ad
 - 1;

113 
fds
 = 
pefds
[
pe_idx
].fds;

115 
toke
->
tofd
 = 
fds
[
READ
];

116 
	`»®ly_£nd_toke
(
toke
);

117 
	}
}

119 
	$´oûss_tok’
(
fd
, 
tok’
 *
toke
, 
Ä
)

121 ià(
Ä
 !ğ
BUFSIZE
)

122 
	`årštf
(
¡d”r
, "process_token:‚r == %d (vs %d)\n",

123 
Ä
, 
BUFSIZE
);

124 
	`as£¹
(
Ä
 =ğ
BUFSIZE
);

125 
	`as£¹
(
toke
->
tofd
 =ğ
fd
);

126 
Ä_tok’_·s£s
++;

127 
toke
->
g’”©iÚ
++;

129 
	`debug
("·s£d %ld, g’: %ld,ok’_g’: %ld", 
Ä_tok’_·s£s
, 
max_g’”©iÚ
,

130 
toke
->
g’”©iÚ
);

132 ià(
toke
->
g’”©iÚ
 < 
max_g’”©iÚ
)

133 
	`£nd_toke
(
toke
);

135 
	`debug
("th»ad %d com¶‘e, %ld…as£s", 
toke
->
th»ad
, 
Ä_tok’_·s£s
);

136 
th»ads_com¶‘e
++;

137 ià(
th»ads_com¶‘e
 >ğ
max_th»ads
)

138 
dÚe
 = 1;

140 
	}
}

142 
	$»ad_ªd_´oûss_tok’
(
fd
)

144 
tok’
 *
toke
;

145 
fdšfo
 *
šf
 = &fdšfo[
fd
];

146 *
buf
 = 
šf
->buf;

147 
Ä
;

148 
Ä
 = 
	`»ad
(
fd
, 
buf
, 
BUFSIZE
);

149 
	`check
(
Ä
 !ğ-1, "FaedØ»ad from fdh© wa suµo£dly„—dy: %d", 
fd
);

151 
toke
 = (
tok’
 *)
buf
;

153 
Ä
 >ğ
BUFSIZE
) {

154 
	`´oûss_tok’
(
fd
, 
toke
, 
BUFSIZE
);

155 
toke
++;

156 
Ä
 -ğ
BUFSIZE
;

159 
	`check
(
Ä
 == 0, "Didn't writeƒverythigo…ipe.");

163 
”rÜ
:

165 
	}
}

168 
	$mak—pe
(
idx
, 
hÙ
)

170 *
fds
 = 
pefds
[
idx
].fds;

171 
fdšfo
 *
šf
;

172 
i
;

173 
rc
 = 0;

175 
	`check
(
	`pe
(
fds
è=ğ0, "FaedØmakp#%d", 
idx
);

177 
i
=0; i<2; i++) {

178 
æ
 = 
	`fú
(
fds
[
i
], 
F_GETFL
);

179 
æ
 |ğ
O_NONBLOCK
;

180 
	`fú
(
fds
[
i
], 
F_SETFL
, 
æ
);

183 
šf
 = &
fdšfo
[
fds
[
READ
]];

184 
šf
->
buf
 = 
	`ÿÎoc
(1, 
BUFSIZE
);

185 
	`as£¹
(
šf
->
buf
 !ğ
NULL
);

186 
	`as£¹
(
šf
->
aùive
 == 0);

187 
šf
->
aùive
 = 1;

188 
šf
->
rw
 = 
READ
;

189 
šf
->
fd
 = 
fds
[
READ
];

190 
šf
->
pe_idx
 = 
idx
;

192 
rc
 = 
	`Su³rPŞl_add
(
TEST_POLL
, 
NULL
, NULL, 
fds
[
READ
], 'r', 
hÙ
);

193 
	`check
(
rc
 != -1, "Failedo‡dd„ead sideo superpoll.");

195 
šf
 = &
fdšfo
[
fds
[
WRITE
]];

196 
	`as£¹
(
šf
->
aùive
 == 0);

197 
šf
->
aùive
 = 1;

198 
šf
->
rw
 = 
WRITE
;

199 
šf
->
fd
 = 
fds
[
WRITE
];

200 
šf
->
pe_idx
 = 
idx
;

204 
”rÜ
:

206 
	}
}

208 
	$mak•es
(
Ä
, 
hÙ
)

210 
i
;

211 
i
=0; i<
Ä
; i++)

212 
	`mak—pe
(
i
, 
hÙ
);

213 
Ä_pes
 = 
Ä
;

214 
	}
}

217 
	$şo£pes
(
Ä
)

219 
i
 = 0;

220 
i
 = 0; i < 
Ä
; i++) {

221 
	`ä“
(
fdšfo
[
pefds
[
i
].
fds
[
READ
]].
buf
);

222 
	`şo£
(
pefds
[
i
].
fds
[
READ
]);

224 
	`ä“
(
fdšfo
[
pefds
[
i
].
fds
[
WRITE
]].
buf
);

225 
	`şo£
(
pefds
[
i
].
fds
[
WRITE
]);

228 
	`mem£t
(
fdšfo
, 0, (fdinfo));

229 
	`mem£t
(
pefds
, 0, (pipefds));

231 
dÚe
 = 0;

232 
Ä_tok’_·s£s
 = 0;

233 
	}
}

235 
	$run_maš_loİ
(
hÙ
)

237 
i
 = 0;

238 
nfds
 = 0;

239 
rc
 = 0;

240 
PŞlResuÉ
 
»suÉ
;

242 
rc
 = 
	`PŞlResuÉ_š™
(
TEST_POLL
, &
»suÉ
);

243 
	`check
(
rc
 == 0, "Failedo initializehe…oll„esult.");

245 !
dÚe
) {

246 
	`£nd_³ndšg_tokes
();

248 
nfds
 = 
	`Su³rPŞl_pŞl
(
TEST_POLL
, &
»suÉ
, -1);

249 
	`check
(
nfds
 >= 0, "superpoll failed.");

251 
i
 = 0; i < 
nfds
; i++) {

252 ià(
»suÉ
.
h™s
[
i
].
ev
.
»v’ts
 & 
ZMQ_POLLIN
) {

254 if(
	`»ad_ªd_´oûss_tok’
(
»suÉ
.
h™s
[
i
].
ev
.
fd
) == 0) {

255 
rc
 = 
	`Su³rPŞl_add
(
TEST_POLL
, 
NULL
, NULL, 
»suÉ
.
h™s
[
i
].
ev
.
fd
, 'r', 
hÙ
);

261 
	`PŞlResuÉ_ş—n
(&
»suÉ
);

264 
”rÜ
:

265 
	`PŞlResuÉ_ş—n
(&
»suÉ
);

267 
	}
}

269 
	$£edth»ads
(
Ä
)

271 
tok’
 
toke
;

272 
i
;

274 
i
=0; i<
Ä
; i++) {

275 
toke
.
g’”©iÚ
 = 0;

276 
toke
.
th»ad
 = 
i
;

277 
toke
.
tofd
 = -1;

278 
	`£nd_toke
(&
toke
);

280 
	}
}

282 *
	$run_‹¡
(
Ä
, 
th»ads
, 
g’s
, 
hÙ
, *
ç_msg
)

284 
	`debug
("TEST IS: %s", 
ç_msg
);

286 
timev®
 
¡v
, 
‘v
;

287 
u£cs
, 
·s£s_³r_£c
;

288 
rc
 = 0;

289 
FILE
 *
³rf
 = 
NULL
;

291 
	`check
(
Ä
 >ğ
th»ads
, "You can't havehe‚r†esshanhreads.");

293 
max_th»ads
 = 
th»ads
;

294 
max_g’”©iÚ
 = 
g’s
;

296 
³rf
 = 
	`fİ’
("tests/perf.log", "a+");

297 
	`check
(
³rf
, "Failedo openests/perf.log");

298 
pid_t
 
mypid
 = 
	`g‘pid
();

301 
	`årštf
(
³rf
, "% %d %d %d %ld %d ", 
hÙ
 ? "poll" : "epoll",

302 
mypid
, 
Ä
, 
max_th»ads
, 
max_g’”©iÚ
, 
BUFSIZE
);

305 
	`mak•es
(
Ä
, 
hÙ
);

307 
	`£nd_³ndšg_tokes
();

309 
	`g‘timeofday
(&
¡v
, 
NULL
);

311 
	`£edth»ads
(
max_th»ads
);

313 
rc
 = 
	`run_maš_loİ
(
hÙ
);

314 
	`check
(
rc
 =ğ0, "Look likthmaš†oİ faed fÜ '%s'", 
ç_msg
);

316 
	`g‘timeofday
(&
‘v
, 
NULL
);

318 
‘v
.
tv_£c
 -ğ
¡v
.tv_sec;

319 
‘v
.
tv_u£c
 -ğ
¡v
.tv_usec;

321 ià(
‘v
.
tv_u£c
 < 0) {

322 
‘v
.
tv_u£c
 += 1000000;

323 
‘v
.
tv_£c
 -= 1;

326 
	`årštf
(
³rf
, "%ld %ld.%06ld ", 
Ä_tok’_·s£s
, 
‘v
.
tv_£c
, (ëtv.
tv_u£c
);

328 
u£cs
 = 
‘v
.
tv_u£c
 +ƒtv.
tv_£c
 * 1000000LL;

329 if(
u£cs
 == 0) usecs++;

330 
·s£s_³r_£c
 = 
Ä_tok’_·s£s
 * 1000000LL * 100;

331 
·s£s_³r_£c
 /ğ
u£cs
 ;

333 
	`årštf
(
³rf
, "%Ld.%02Ld\n", 
·s£s_³r_£c
 / 100,…asses_per_sec % 100);

335 
	`şo£pes
(
Ä
);

336 
	`fşo£
(
³rf
);

338  
NULL
;

340 
”rÜ
:

341 
	`şo£pes
(
Ä
);

342 if(
³rf
è
	`fşo£
(perf);

343  
ç_msg
;

344 
	}
}

346 *
	$‹¡_maxed_pes_hÙ
()

348  
	`run_‹¡
(50, 50, 50, 1, "max…ipes 1 failed");

349 
	}
}

352 *
	$‹¡_¥¬£_pes_hÙ
()

354  
	`run_‹¡
(50, 5, 50, 1, "sparse…ipes 1 failed");

355 
	}
}

357 *
	$‹¡_midËv–_pes_hÙ
()

359  
	`run_‹¡
(50, 25, 50, 1, "midlevel…ipes failed.");

360 
	}
}

362 *
	$‹¡_maxed_pes_idË
()

364  
	`run_‹¡
(50, 50, 50, 0, "max idle…ipes 1 failed");

365 
	}
}

368 *
	$‹¡_¥¬£_pes_idË
()

370  
	`run_‹¡
(50, 5, 50, 0, "sparse…ipes 1 failed");

371 
	}
}

373 *
	$‹¡_midËv–_pes_idË
()

375  
	`run_‹¡
(50, 25, 50, 0, "midlevel…ipes failed.");

376 
	}
}

378 *
	$‹¡_tÙ®ly_maxed
()

380  
	`run_‹¡
(400, 350, 10, 0, "midlevel…ipes failed.");

381 
	}
}

383 *
	$®l_‹¡s
() {

384 
	`mu_su™e_¡¬t
();

386 
	`Su³rPŞl_g‘_max_fd
();

387 
TEST_POLL
 = 
	`Su³rPŞl_ü—‹
();

389 
	`mu_run_‹¡
(
‹¡_¥¬£_pes_hÙ
);

390 
	`mu_run_‹¡
(
‹¡_maxed_pes_hÙ
);

391 
	`mu_run_‹¡
(
‹¡_midËv–_pes_hÙ
);

393 #ifdeà
__lšux__


394 
	`mu_run_‹¡
(
‹¡_¥¬£_pes_idË
);

395 
	`mu_run_‹¡
(
‹¡_maxed_pes_idË
);

396 
	`mu_run_‹¡
(
‹¡_midËv–_pes_idË
);

397 
	`mu_run_‹¡
(
‹¡_tÙ®ly_maxed
);

400 
	`Su³rPŞl_de¡roy
(
TEST_POLL
);

402  
NULL
;

403 
	}
}

405 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/tnetstrings_tests.c

1 
	~"mšun™.h
"

2 
	~<Š‘¡ršgs.h
>

3 
	~<»que¡.h
>

4 
	~<lim™s.h
>

5 
	~<as£¹.h
>

8 *
	$‹¡_Š‘¡ršg_numb”s
()

10 *
»suÉ
;

11 
size_t
 
Ën
;

13 
Šs_v®ue_t
 
max
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = 
LONG_MAX
};

14 
»suÉ
 = 
	`Šs_»nd”
(&
max
, &
Ën
);

15 
	`debug
("GÙ‡†’gth from LONG_MAX of: %d", 
Ën
);

16 
	`mu_as£¹
(
Ën
 == 23 ||†en == 14, "Wrong†ength on LONG_MAX");

17 
	`ä“
(
»suÉ
);

25 
Šs_v®ue_t
 
mšus_Úe
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = -1};

26 
»suÉ
 = 
	`Šs_»nd”
(&
mšus_Úe
, &
Ën
);

27 
	`mu_as£¹
(
Ën
 == 5, "Wrong†ength on -1");

28 
	`ä“
(
»suÉ
);

30  
NULL
;

31 
	}
}

33 *
	$‹¡_Š‘¡ršg_’code
()

35 
size_t
 
Ën
 = 0;

37 
Šs_v®ue_t
 
v®
 = {.
ty³
 = 
Šs_g_nuÎ
};

38 *
»suÉ
 = 
	`Šs_»nd”
(&
v®
, &
Ën
);

39 
	`mu_as£¹
(
Ën
 == 3, "Wrong†ength on‚ull.");

40 
	`ä“
(
»suÉ
);

42 
Šs_v®ue_t
 
num
 = {.
ty³
 = 
Šs_g_numb”
, .
v®ue
.
numb”
 = 12345};

43 
»suÉ
 = 
	`Šs_»nd”
(&
num
, &
Ën
);

44 
	`mu_as£¹
(
Ën
 == 8, "Wrong†ength on‚umber.");

45 
	`ä“
(
»suÉ
);

47 
b¡ršg
 
d©a
 = 
	`bäomc¡r
("hello");

48 
Šs_v®ue_t
 
¡r
 = {.
ty³
 = 
Šs_g_¡ršg
, .
v®ue
.
¡ršg
 = 
d©a
};

49 
»suÉ
 = 
	`Šs_»nd”
(&
¡r
, &
Ën
);

50 
	`mu_as£¹
(
Ën
 == 8, "Wrong†ength on string.");

51 
	`bde¡roy
(
d©a
);

52 
	`ä“
(
»suÉ
);

54 
Šs_v®ue_t
 
boŞ—n
 = {.
ty³
 = 
Šs_g_boŞ
, .
v®ue
.
boŞ
 = 1};

55 
»suÉ
 = 
	`Šs_»nd”
(&
boŞ—n
, &
Ën
);

56 
	`mu_as£¹
(
Ën
 == 7, "Wrong†ength onrue.");

57 
	`ä“
(
»suÉ
);

59 
boŞ—n
.
v®ue
.
boŞ
 = 0;

60 
»suÉ
 = 
	`Šs_»nd”
(&
boŞ—n
, &
Ën
);

61 
	`mu_as£¹
(
Ën
 == 8, "Wrong†ength on false.");

62 
	`ä“
(
»suÉ
);

64  
NULL
;

65 
	}
}

67 *
	$‹¡_Š‘¡ršg_decode
()

69 
b¡ršg
 
d©a
 = 
	`bäomc¡r
("0:~");

70 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

72 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo get‡rue.");

73 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_nuÎ
, "Wrongype, should be‚ull.");

74 
	`ä“
(
»suÉ
);

76 
	`bassignc¡r
(
d©a
, "4:true!");

77 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

78 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

79 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_boŞ
, "Wrongype, should be bool.");

80 
	`mu_as£¹
(
»suÉ
->
v®ue
.
boŞ
 == 1, "Wrong value, should be 1.");

81 
	`ä“
(
»suÉ
);

83 
	`bassignc¡r
(
d©a
, "5:false!");

84 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

85 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

86 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_boŞ
, "Wrongype, should be bool.");

87 
	`mu_as£¹
(
»suÉ
->
v®ue
.
boŞ
 == 0, "Wrong value, should be 0.");

88 
	`ä“
(
»suÉ
);

90 
	`bassignc¡r
(
d©a
, "5:hello,");

91 
b¡ršg
 
com·»
 = 
	`bäomc¡r
("hello");

92 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

93 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

94 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_¡ršg
, "Wrongype, should be string.");

95 
	`mu_as£¹
(
	`bi£q
(
»suÉ
->
v®ue
.
¡ršg
, 
com·»
), "Wrong value, should be 'hello'.");

96 
	`bde¡roy
(
»suÉ
->
v®ue
.
¡ršg
);

97 
	`ä“
(
»suÉ
);

98 
	`bde¡roy
(
com·»
);

100 
	`bassignc¡r
(
d©a
, "5:12345#");

101 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

102 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡rue.");

103 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_numb”
, "Wrongype, should be‚umber.");

104 
	`mu_as£¹
(
»suÉ
->
v®ue
.
numb”
 == 12345, "Wrong value, should be 12345.");

105 
	`ä“
(
»suÉ
);

107 
	`bde¡roy
(
d©a
);

109  
NULL
;

110 
	}
}

112 *
	$‹¡_com¶ex_ty³s
()

114 
b¡ršg
 
d©a
 = 
	`bäomc¡r
("16:5:hello,5:12345#}");

115 
Šs_v®ue_t
 *
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

116 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡ dict.");

117 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_diù
, "Wrongype, should be dict.");

119 
size_t
 
Ën
 = 0;

120 *
»nd”ed
 = 
	`Šs_»nd”
((*)
»suÉ
, &
Ën
);

121 
	`mu_as£¹
(
»nd”ed
 !ğ
NULL
, "Failedo„ender dict back.");

122 
	`mu_as£¹
(
	`bi£qc¡r
(
d©a
, 
»nd”ed
), "Round-trip of dict doesn't work.");

123 
	`ä“
(
»nd”ed
);

125 
b¡ršg
 
key
 = 
	`bäomc¡r
("hello");

126 
Šs_v®ue_t
 *
v®
 = 
	`hnode_g‘
(
	`hash_lookup
(
»suÉ
->
v®ue
.
diù
, 
key
));

127 
	`mu_as£¹
(
v®
 !ğ
NULL
, "Should have hello‡s key.");

128 
	`mu_as£¹
(
v®
->
ty³
 =ğ
Šs_g_numb”
, "Value should be‡‚umber.");

129 
	`mu_as£¹
(
v®
->
v®ue
.
numb”
 == 12345, "Value shouldƒqual 12345.");

131 
	`Šs_v®ue_de¡roy
(
»suÉ
);

132 
	`bde¡roy
(
key
);

134 
	`bassignc¡r
(
d©a
, "32:5:hello,5:12345#5:hello,5:56789#]");

135 
»suÉ
 = 
	`Šs_·r£
(
	`bd©a
(
d©a
), 
	`bËngth
(d©a), 
NULL
);

136 
	`mu_as£¹
(
»suÉ
 !ğ
NULL
, "Failedo…arse‡†ist.");

137 
	`mu_as£¹
(
»suÉ
->
ty³
 =ğ
Šs_g_li¡
, "Wrongype, should be†ist.");

139 
v®
 = 
	`d¬¿y_g‘
(
»suÉ
->
v®ue
.
li¡
, 
	`d¬¿y_’d
(result->value.list) - 1);

140 
	`mu_as£¹
(
v®
 !ğ
NULL
, "Should have hello‡s key.");

141 
	`mu_as£¹
(
v®
->
ty³
 =ğ
Šs_g_numb”
, "Value should be‡‚umber.");

142 
	`mu_as£¹
(
v®
->
v®ue
.
numb”
 == 56789, "Value shouldƒqual 56789.");

144 
»nd”ed
 = 
	`Šs_»nd”
((*)
»suÉ
, &
Ën
);

145 
	`debug
("RENDERED LIST: %s", 
»nd”ed
);

146 
	`mu_as£¹
(
»nd”ed
 !ğ
NULL
, "Failedo„ender†ist back.");

147 
	`mu_as£¹
(
	`bi£qc¡r
(
d©a
, 
»nd”ed
), "Rendered†ist wrong.");

148 
	`ä“
(
»nd”ed
);

150 
	`Šs_v®ue_de¡roy
(
»suÉ
);

151 
	`bde¡roy
(
d©a
);

154  
NULL
;

155 
	}
}

157 * 
	$®l_‹¡s
() {

158 
	`Reque¡_š™
();

159 
	`mu_su™e_¡¬t
();

161 
	`mu_run_‹¡
(
‹¡_Š‘¡ršg_’code
);

162 
	`mu_run_‹¡
(
‹¡_Š‘¡ršg_decode
);

163 
	`mu_run_‹¡
(
‹¡_Š‘¡ršg_numb”s
);

164 
	`mu_run_‹¡
(
‹¡_com¶ex_ty³s
);

166  
NULL
;

167 
	}
}

169 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/tst_tests.c

1 
	~"mšun™.h
"

2 
	~<adt/t¡.h
>

3 
	~<¡ršg.h
>

4 
	~<as£¹.h
>

5 
	~<b¡ršg.h
>

8 
t¡_t
 *
	gnode
 = 
NULL
;

9 *
	gv®ueA
 = "VALUEA";

10 *
	gv®ueB
 = "VALUEB";

11 *
	gv®ue2
 = "VALUE2";

12 *
	gv®ue4
 = "VALUE4";

13 *
	g»v”£
 = "VALUER";

14 
	gŒav”£_couÁ
 = 0;

16 
b¡ršg
 
	g‹¡1
;

17 
b¡ršg
 
	g‹¡2
;

18 
b¡ršg
 
	g‹¡3
;

19 
b¡ršg
 
	g‹¡4
;

21 *
	$‹¡_t¡_š£¹
()

23 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡1
), 
	`bËngth
Ñe¡1), 
v®ueA
);

24 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost.");

26 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡2
), 
	`bËngth
Ñe¡2), 
v®ue2
);

27 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost with second‚ame.");

29 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡3
), 
	`bËngth
Ñe¡3), 
»v”£
);

30 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost with„everse‚ame.");

32 
node
 = 
	`t¡_š£¹
Òode, 
	`bd©a
(
‹¡4
), 
	`bËngth
Ñe¡4), 
v®ue4
);

33 
	`mu_as£¹
(
node
 !ğ
NULL
, "Failedo insert intost with second‚ame.");

35  
NULL
;

36 
	}
}

38 *
	$‹¡_t¡_£¬ch_exaù
()

41 *
»s
 = 
	`t¡_£¬ch
(
node
, 
	`bd©a
(
‹¡1
), 
	`bËngth
(test1));

42 
	`mu_as£¹
(
»s
 =ğ
v®ueA
, "Gothe wrong value back, should get A‚ot B.");

45 
»s
 = 
	`t¡_£¬ch
(
node
, "TESTNO", 
	`¡¾’
("TESTNO"));

46 
	`mu_as£¹
(
»s
 =ğ
NULL
, "Should‚ot find‡nything.");

48  
NULL
;

49 
	}
}

51 *
	$‹¡_t¡_£¬ch_suffix
()

53 *
»s
 = 
	`t¡_£¬ch_suffix
(
node
, 
	`bd©a
(
‹¡1
), 
	`bËngth
(test1));

54 
	`debug
("»suÉ: %p,ƒx³ùed: %p", 
»s
, 
»v”£
);

55 
	`mu_as£¹
(
»s
 =ğ
»v”£
, "Gothe wrong value.");

57 
»s
 = 
	`t¡_£¬ch_suffix
(
node
, "TESTNO", 
	`¡¾’
("TESTNO"));

58 
	`mu_as£¹
(
»s
 =ğ
NULL
, "Reverse search should find‚othing.");

60 
»s
 = 
	`t¡_£¬ch_suffix
(
node
, "EST", 
	`¡¾’
("EST"));

61 
	`mu_as£¹
(
»s
 !ğ
NULL
, "Reverse search should find byhe suffix.");

63 
»s
 = 
	`t¡_£¬ch_suffix
(
node
, "ESTO", 
	`¡¾’
("ESTO"));

64 
	`mu_as£¹
(
»s
 =ğ
NULL
, "Reverse search should‚ot find invalid suffix.");

66  
NULL
;

67 
	}
}

69 *
	$‹¡_t¡_£¬ch_´efix
()

71 *
»s
 = 
	`t¡_£¬ch_´efix
(
node
, 
	`bd©a
(
‹¡1
), 
	`bËngth
(test1));

72 
	`debug
("»suÉ: %p,ƒx³ùed: %p", 
»s
, 
v®ueA
);

73 
	`mu_as£¹
(
»s
 =ğ
v®ueA
, "Got wrong valueA by…refix.");

75 
»s
 = 
	`t¡_£¬ch_´efix
(
node
, 
	`bd©a
(
‹¡1
), 1);

76 
	`debug
("»suÉ: %p,ƒx³ùed: %p", 
»s
, 
v®ueA
);

77 
	`mu_as£¹
(
»s
 =ğ
v®ue4
, "Got wrong value4 for…refix of 1.");

79 
»s
 = 
	`t¡_£¬ch_´efix
(
node
, "TE", 
	`¡¾’
("TE"));

80 
	`mu_as£¹
(
»s
 !ğ
NULL
, "Should find for short…refix.");

82 
»s
 = 
	`t¡_£¬ch_´efix
(
node
, "TE--", 
	`¡¾’
("TE--"));

83 
	`mu_as£¹
(
»s
 !ğ
NULL
, "Should find for…artial…refix.");

86  
NULL
;

87 
	}
}

89 
	$t¡_Œav”£_‹¡_cb
(*
v®ue
, *
d©a
)

91 
	`as£¹
(
v®ue
 !ğ
NULL
 && "Should‚ot get NULL value.");

92 
	`as£¹
(
d©a
 =ğ
v®ueA
 && "Expecting valueA‡she data.");

93 
Œav”£_couÁ
++;

94 
	}
}

96 *
	$‹¡_t¡_Œav”£
()

98 
Œav”£_couÁ
 = 0;

99 
	`t¡_Œav”£
(
node
, 
t¡_Œav”£_‹¡_cb
, 
v®ueA
);

100 
	`debug
("Œav”£ couÁ is: %d", 
Œav”£_couÁ
);

101 
	`mu_as£¹
(
Œav”£_couÁ
 == 4, "Didn't find 4 keys.");

103  
NULL
;

104 
	}
}

106 *
	$‹¡_t¡_cŞËù
()

108 
li¡_t
 *
found
 = 
	`t¡_cŞËù
(
node
, "TE", 2, 
NULL
);

109 
	`debug
("cŞËù found %d v®ues", ()
	`li¡_couÁ
(
found
));

111 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 3, "Didn't find 2 with…refix TE.");

112 
	`li¡_de¡roy_nodes
(
found
);

113 
	`li¡_de¡roy
(
found
);

115 
found
 = 
	`t¡_cŞËù
(
node
, "T", 1, 
NULL
);

116 
	`debug
("cŞËù found %d v®ues", ()
	`li¡_couÁ
(
found
));

117 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 4, "Didn't find 4 with…refix T.");

118 
	`li¡_de¡roy_nodes
(
found
);

119 
	`li¡_de¡roy
(
found
);

121 
found
 = 
	`t¡_cŞËù
(
node
, "TEST2", 5, 
NULL
);

122 
	`debug
("cŞËù found %d v®ues", ()
	`li¡_couÁ
(
found
));

123 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 1, "Didn't find 1 with…refix TEST2.");

124 
	`li¡_de¡roy_nodes
(
found
);

125 
	`li¡_de¡roy
(
found
);

127 
found
 = 
	`t¡_cŞËù
(
node
, "XNOT", 4, 
NULL
);

128 
	`mu_as£¹
(
	`li¡_couÁ
(
found
) == 0, "Should‚ot find‡ny with…refix XNOT.");

129 
	`li¡_de¡roy_nodes
(
found
);

130 
	`li¡_de¡roy
(
found
);

132  
NULL
;

133 
	}
}

135 *
	$‹¡_t¡_de¡roy
()

137 
	`t¡_de¡roy
(
node
);

139  
NULL
;

140 
	}
}

142 * 
	$®l_‹¡s
() {

143 
	`mu_su™e_¡¬t
();

145 
‹¡1
 = 
	`bäomc¡r
("TEST");

146 
‹¡2
 = 
	`bäomc¡r
("TEST2");

147 
‹¡3
 = 
	`bäomc¡r
("TSET");

148 
‹¡4
 = 
	`bäomc¡r
("T");

150 
	`mu_run_‹¡
(
‹¡_t¡_š£¹
);

151 
	`mu_run_‹¡
(
‹¡_t¡_£¬ch_exaù
);

152 
	`mu_run_‹¡
(
‹¡_t¡_£¬ch_suffix
);

153 
	`mu_run_‹¡
(
‹¡_t¡_£¬ch_´efix
);

154 
	`mu_run_‹¡
(
‹¡_t¡_Œav”£
);

155 
	`mu_run_‹¡
(
‹¡_t¡_cŞËù
);

156 
	`mu_run_‹¡
(
‹¡_t¡_de¡roy
);

158 
	`bde¡roy
(
‹¡1
);

159 
	`bde¡roy
(
‹¡2
);

160 
	`bde¡roy
(
‹¡3
);

161 
	`bde¡roy
(
‹¡4
);

163  
NULL
;

164 
	}
}

166 
RUN_TESTS
(
®l_‹¡s
);

	@tools/tests/unixy_tests.c

1 
	~"mšun™.h
"

2 
	~<unixy.h
>

3 
	~<uni¡d.h
>

4 
	~<sys/ty³s.h
>

6 *
	$‹¡_Unixy_g‘cwd
()

8 
b¡ršg
 
dœ
 = 
	`Unixy_g‘cwd
();

9 
	`mu_as£¹
(
dœ
 !ğ
NULL
, "getcwd failed.");

10 
	`debug
("CWD is: %s", 
	`bd©a
(
dœ
));

12 
	`bde¡roy
(
dœ
);

13  
NULL
;

14 
	}
}

16 *
	$‹¡_Unixy_chroÙ_çs
()

18 
b¡ršg
 
dœ
 = 
	`Unixy_g‘cwd
();

19 
	`mu_as£¹
(
dœ
 !ğ
NULL
, "can't getcwd in chrootest.");

21 
rc
 = 
	`Unixy_chroÙ
(
dœ
);

22 
	`mu_as£¹
(
rc
 == -1, "We shouldn't be‡bleo chroot unless„unning‡s„oot.");

24 
	`bde¡roy
(
dœ
);

26  
NULL
;

27 
	}
}

29 *
	$‹¡_Unixy_drİ_´iv_çs
()

31 
b¡ršg
 
dœ
 = 
	`Unixy_g‘cwd
();

32 
	`mu_as£¹
(
dœ
 !ğ
NULL
, "can't getcwd in chrootest.");

34 
	`Unixy_drİ_´iv
(
dœ
);

37 
	`bde¡roy
(
dœ
);

38  
NULL
;

39 
	}
}

42 *
	$‹¡_Unixy_pid_fe
()

44 
b¡ršg
 
pid_·th
 = 
	`bäomc¡r
("tests/test.pid");

45 
	`uÆšk
((cÚ¡ *)
pid_·th
->
d©a
);

47 
rc
 = 
	`Unixy_pid_fe
(
pid_·th
);

48 
	`mu_as£¹
(
rc
 == 0, "Failedo make…id file.");

50 
rc
 = 
	`Unixy_pid_fe
(
pid_·th
);

51 
	`mu_as£¹
(
rc
 == -1, "Can't„un it morehan once…er…rocess.");

53 
rc
 = 
	`Unixy_»move_d—d_pidfe
(
pid_·th
);

54 
	`mu_as£¹
(
rc
 == -1, "Should NOT be‡bleo„emovehe PID file while„unning.");

55 
	`bde¡roy
(
pid_·th
);

57  
NULL
;

58 
	}
}

61 * 
	$®l_‹¡s
() {

62 
	`mu_su™e_¡¬t
();

64 
	`mu_run_‹¡
(
‹¡_Unixy_g‘cwd
);

65 if(
	`g‘uid
() != 0) {

66 
	`mu_run_‹¡
(
‹¡_Unixy_chroÙ_çs
);

67 
	`mu_run_‹¡
(
‹¡_Unixy_drİ_´iv_çs
);

69 
	`mu_run_‹¡
(
‹¡_Unixy_pid_fe
);

71  
NULL
;

72 
	}
}

74 
RUN_TESTS
(
®l_‹¡s
);

	@
1
.
0
449
10188
examples/kegogi/lemon.c
examples/kegogi/lempar.c
examples/kegogi/src/fuzzrnd.c
examples/kegogi/src/fuzzrnd.h
examples/kegogi/src/httpclient.c
examples/kegogi/src/httpclient.h
examples/kegogi/src/kegogi.c
examples/kegogi/src/kegogi.h
examples/kegogi/src/kegogi_lexer.c
examples/kegogi/src/kegogi_parser.c
examples/kegogi/src/kegogi_parser.h
examples/kegogi/src/kegogi_parser_extra.c
examples/kegogi/src/kegogi_tokens.c
examples/kegogi/src/kegogi_tokens.h
examples/kegogi/src/param.c
examples/kegogi/src/param.h
examples/procer/procer.c
examples/procer/procer.h
examples/procer/profile.c
examples/procer/rampart.c
src/adt/darray.c
src/adt/darray.h
src/adt/dict.c
src/adt/dict.h
src/adt/hash.c
src/adt/hash.h
src/adt/list.c
src/adt/list.h
src/adt/tst.c
src/adt/tst.h
src/bsd_specific.c
src/bsd_specific.h
src/bstr/bsafe.c
src/bstr/bsafe.h
src/bstr/bstraux.c
src/bstr/bstraux.h
src/bstr/bstrlib.c
src/bstr/bstrlib.h
src/bstring.h
src/cache.c
src/cache.h
src/config/config.c
src/config/config.h
src/config/db.c
src/config/db.h
src/config/module.c
src/config/module.h
src/connection.c
src/connection.h
src/control.c
src/control.h
src/dbg.c
src/dbg.h
src/dir.c
src/dir.h
src/events.h
src/filter.c
src/filter.h
src/handler.c
src/handler.h
src/handler_parser.c
src/handler_parser.h
src/headers.c
src/headers.h
src/host.c
src/host.h
src/http11/http11_common.h
src/http11/http11_parser.c
src/http11/http11_parser.h
src/http11/httpclient_parser.c
src/http11/httpclient_parser.h
src/io.c
src/io.h
src/log.c
src/log.h
src/mem/align.h
src/mem/halloc.c
src/mem/halloc.h
src/mem/hlist.h
src/mem/macros.h
src/mime.c
src/mime.h
src/mongrel2.c
src/pattern.c
src/pattern.h
src/polarssl/aes.c
src/polarssl/aes.h
src/polarssl/arc4.c
src/polarssl/arc4.h
src/polarssl/base64.c
src/polarssl/base64.h
src/polarssl/bignum.c
src/polarssl/bignum.h
src/polarssl/bn_mul.h
src/polarssl/camellia.c
src/polarssl/camellia.h
src/polarssl/certs.c
src/polarssl/certs.h
src/polarssl/config.h
src/polarssl/debug.c
src/polarssl/debug.h
src/polarssl/des.c
src/polarssl/des.h
src/polarssl/dhm.c
src/polarssl/dhm.h
src/polarssl/havege.c
src/polarssl/havege.h
src/polarssl/md2.c
src/polarssl/md2.h
src/polarssl/md4.c
src/polarssl/md4.h
src/polarssl/md5.c
src/polarssl/md5.h
src/polarssl/net.c
src/polarssl/net.h
src/polarssl/openssl.h
src/polarssl/padlock.c
src/polarssl/padlock.h
src/polarssl/rsa.c
src/polarssl/rsa.h
src/polarssl/sha1.c
src/polarssl/sha1.h
src/polarssl/sha2.c
src/polarssl/sha2.h
src/polarssl/sha4.c
src/polarssl/sha4.h
src/polarssl/ssl.h
src/polarssl/ssl_cli.c
src/polarssl/ssl_srv.c
src/polarssl/ssl_tls.c
src/polarssl/timing.c
src/polarssl/timing.h
src/polarssl/version.c
src/polarssl/version.h
src/polarssl/x509.h
src/polarssl/x509parse.c
src/polarssl/xtea.c
src/polarssl/xtea.h
src/proxy.c
src/proxy.h
src/register.c
src/register.h
src/request.c
src/request.h
src/response.c
src/response.h
src/routing.c
src/routing.h
src/server.c
src/server.h
src/setting.c
src/setting.h
src/state.c
src/state.h
src/superpoll.c
src/superpoll.h
src/task/386-ucontext.h
src/task/amd64-ucontext.h
src/task/context.c
src/task/fd.c
src/task/net.c
src/task/power-ucontext.h
src/task/qlock.c
src/task/rendez.c
src/task/task.c
src/task/task.h
src/task/taskimpl.h
src/tnetstrings.c
src/tnetstrings.h
src/tnetstrings_impl.h
src/unixy.c
src/unixy.h
src/upload.c
src/upload.h
src/version.h
tests/bstr_tests.c
tests/cache_tests.c
tests/config_tests.c
tests/connection_tests.c
tests/darray_tests.c
tests/db_tests.c
tests/dict_tests.c
tests/dir_tests.c
tests/filter_tests.c
tests/filters/test_filter.c
tests/filters/test_filter_a.c
tests/filters/test_filter_b.c
tests/filters/test_filter_c.c
tests/handler_parser_tests.c
tests/handler_tests.c
tests/hash_tests.c
tests/host_tests.c
tests/http11_tests.c
tests/httpclient_tests.c
tests/io_tests.c
tests/list_tests.c
tests/mime_tests.c
tests/minunit.h
tests/pattern_tests.c
tests/proxy_tests.c
tests/register_tests.c
tests/request_tests.c
tests/response_tests.c
tests/routing_tests.c
tests/server_tests.c
tests/setting_tests.c
tests/state_tests.c
tests/superpoll_tests.c
tests/tnetstrings_tests.c
tests/tst_tests.c
tests/unixy_tests.c
tools/config_modules/null.c
tools/config_modules/zmq.c
tools/examples/kegogi/lemon.c
tools/examples/kegogi/lempar.c
tools/examples/kegogi/src/fuzzrnd.c
tools/examples/kegogi/src/fuzzrnd.h
tools/examples/kegogi/src/httpclient.c
tools/examples/kegogi/src/httpclient.h
tools/examples/kegogi/src/kegogi.c
tools/examples/kegogi/src/kegogi.h
tools/examples/kegogi/src/kegogi_lexer.c
tools/examples/kegogi/src/kegogi_parser.c
tools/examples/kegogi/src/kegogi_parser.h
tools/examples/kegogi/src/kegogi_parser_extra.c
tools/examples/kegogi/src/kegogi_tokens.c
tools/examples/kegogi/src/kegogi_tokens.h
tools/examples/kegogi/src/param.c
tools/examples/kegogi/src/param.h
tools/examples/procer/procer.c
tools/examples/procer/procer.h
tools/examples/procer/profile.c
tools/examples/procer/rampart.c
tools/filters/null.c
tools/lemon/lemon.c
tools/lemon/lempar.c
tools/m2sh/lempar.c
tools/m2sh/src/ast.c
tools/m2sh/src/ast.h
tools/m2sh/src/cli.c
tools/m2sh/src/cli.h
tools/m2sh/src/commands.c
tools/m2sh/src/commands.h
tools/m2sh/src/config_file.c
tools/m2sh/src/config_file.h
tools/m2sh/src/constants.c
tools/m2sh/src/constants.h
tools/m2sh/src/lexer.c
tools/m2sh/src/linenoise.c
tools/m2sh/src/linenoise.h
tools/m2sh/src/m2sh.c
tools/m2sh/src/parser.c
tools/m2sh/src/parser.h
tools/m2sh/src/token.c
tools/m2sh/src/token.h
tools/m2sh/tests/cli_tests.c
tools/m2sh/tests/minunit.h
tools/m2sh/tests/parser_tests.c
tools/src/adt/darray.c
tools/src/adt/darray.h
tools/src/adt/dict.c
tools/src/adt/dict.h
tools/src/adt/hash.c
tools/src/adt/hash.h
tools/src/adt/list.c
tools/src/adt/list.h
tools/src/adt/tst.c
tools/src/adt/tst.h
tools/src/bsd_specific.c
tools/src/bsd_specific.h
tools/src/bstr/bsafe.c
tools/src/bstr/bsafe.h
tools/src/bstr/bstraux.c
tools/src/bstr/bstraux.h
tools/src/bstr/bstrlib.c
tools/src/bstr/bstrlib.h
tools/src/bstring.h
tools/src/cache.c
tools/src/cache.h
tools/src/config/config.c
tools/src/config/config.h
tools/src/config/db.c
tools/src/config/db.h
tools/src/config/module.c
tools/src/config/module.h
tools/src/connection.c
tools/src/connection.h
tools/src/control.c
tools/src/control.h
tools/src/dbg.c
tools/src/dbg.h
tools/src/dir.c
tools/src/dir.h
tools/src/events.h
tools/src/filter.c
tools/src/filter.h
tools/src/handler.c
tools/src/handler.h
tools/src/handler_parser.c
tools/src/handler_parser.h
tools/src/headers.c
tools/src/headers.h
tools/src/host.c
tools/src/host.h
tools/src/http11/http11_common.h
tools/src/http11/http11_parser.c
tools/src/http11/http11_parser.h
tools/src/http11/httpclient_parser.c
tools/src/http11/httpclient_parser.h
tools/src/io.c
tools/src/io.h
tools/src/log.c
tools/src/log.h
tools/src/mem/align.h
tools/src/mem/halloc.c
tools/src/mem/halloc.h
tools/src/mem/hlist.h
tools/src/mem/macros.h
tools/src/mime.c
tools/src/mime.h
tools/src/mongrel2.c
tools/src/pattern.c
tools/src/pattern.h
tools/src/polarssl/aes.c
tools/src/polarssl/aes.h
tools/src/polarssl/arc4.c
tools/src/polarssl/arc4.h
tools/src/polarssl/base64.c
tools/src/polarssl/base64.h
tools/src/polarssl/bignum.c
tools/src/polarssl/bignum.h
tools/src/polarssl/bn_mul.h
tools/src/polarssl/camellia.c
tools/src/polarssl/camellia.h
tools/src/polarssl/certs.c
tools/src/polarssl/certs.h
tools/src/polarssl/config.h
tools/src/polarssl/debug.c
tools/src/polarssl/debug.h
tools/src/polarssl/des.c
tools/src/polarssl/des.h
tools/src/polarssl/dhm.c
tools/src/polarssl/dhm.h
tools/src/polarssl/havege.c
tools/src/polarssl/havege.h
tools/src/polarssl/md2.c
tools/src/polarssl/md2.h
tools/src/polarssl/md4.c
tools/src/polarssl/md4.h
tools/src/polarssl/md5.c
tools/src/polarssl/md5.h
tools/src/polarssl/net.c
tools/src/polarssl/net.h
tools/src/polarssl/openssl.h
tools/src/polarssl/padlock.c
tools/src/polarssl/padlock.h
tools/src/polarssl/rsa.c
tools/src/polarssl/rsa.h
tools/src/polarssl/sha1.c
tools/src/polarssl/sha1.h
tools/src/polarssl/sha2.c
tools/src/polarssl/sha2.h
tools/src/polarssl/sha4.c
tools/src/polarssl/sha4.h
tools/src/polarssl/ssl.h
tools/src/polarssl/ssl_cli.c
tools/src/polarssl/ssl_srv.c
tools/src/polarssl/ssl_tls.c
tools/src/polarssl/timing.c
tools/src/polarssl/timing.h
tools/src/polarssl/version.c
tools/src/polarssl/version.h
tools/src/polarssl/x509.h
tools/src/polarssl/x509parse.c
tools/src/polarssl/xtea.c
tools/src/polarssl/xtea.h
tools/src/proxy.c
tools/src/proxy.h
tools/src/register.c
tools/src/register.h
tools/src/request.c
tools/src/request.h
tools/src/response.c
tools/src/response.h
tools/src/routing.c
tools/src/routing.h
tools/src/server.c
tools/src/server.h
tools/src/setting.c
tools/src/setting.h
tools/src/state.c
tools/src/state.h
tools/src/superpoll.c
tools/src/superpoll.h
tools/src/task/386-ucontext.h
tools/src/task/amd64-ucontext.h
tools/src/task/context.c
tools/src/task/fd.c
tools/src/task/net.c
tools/src/task/power-ucontext.h
tools/src/task/qlock.c
tools/src/task/rendez.c
tools/src/task/task.c
tools/src/task/task.h
tools/src/task/taskimpl.h
tools/src/tnetstrings.c
tools/src/tnetstrings.h
tools/src/tnetstrings_impl.h
tools/src/unixy.c
tools/src/unixy.h
tools/src/upload.c
tools/src/upload.h
tools/src/version.h
tools/tests/bstr_tests.c
tools/tests/cache_tests.c
tools/tests/config_tests.c
tools/tests/connection_tests.c
tools/tests/darray_tests.c
tools/tests/db_tests.c
tools/tests/dict_tests.c
tools/tests/dir_tests.c
tools/tests/filter_tests.c
tools/tests/filters/test_filter.c
tools/tests/filters/test_filter_a.c
tools/tests/filters/test_filter_b.c
tools/tests/filters/test_filter_c.c
tools/tests/handler_parser_tests.c
tools/tests/handler_tests.c
tools/tests/hash_tests.c
tools/tests/host_tests.c
tools/tests/http11_tests.c
tools/tests/httpclient_tests.c
tools/tests/io_tests.c
tools/tests/list_tests.c
tools/tests/mime_tests.c
tools/tests/minunit.h
tools/tests/pattern_tests.c
tools/tests/proxy_tests.c
tools/tests/register_tests.c
tools/tests/request_tests.c
tools/tests/response_tests.c
tools/tests/routing_tests.c
tools/tests/server_tests.c
tools/tests/setting_tests.c
tools/tests/state_tests.c
tools/tests/superpoll_tests.c
tools/tests/tnetstrings_tests.c
tools/tests/tst_tests.c
tools/tests/unixy_tests.c
